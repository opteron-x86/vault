stages:
  - test
  - export

variables:
  RULES_DIR: sentinel_rules
  OUTPUT_PATH: './$RULES_DIR'

# Stage 1: Test the Environment
test_environment:
  stage: test
  tags:
    - azure
    - powershell
    - cte
  timeout: 15m
  script:
    - echo "Testing PowerShell and CI environment..."
    - |
      pwsh -Command "
      # Verify PowerShell version
      Write-Host 'PowerShell Version:';
      $PSVersionTable.PSVersion;

      # Verify Az module installation
      if (-not (Get-Module -ListAvailable -Name Az)) {
          Write-Error 'Az module is not installed.';
          Exit 1;
      }
      Write-Host 'Az module is installed.';

      # Debug environment variables
      $requiredEnvVars = @('RESOURCE_GROUP', 'WORKSPACE_NAME', 'AZURE_SUBSCRIPTION_ID', 'AZURE_CLIENT_ID', 'AZURE_TENANT_ID')
      foreach ($var in $requiredEnvVars) {
          if (-not (Get-Variable -Name $var -Scope Global)) {
              Write-Error \"$var is missing or empty.\";
              Exit 1;
          }
      }
      Write-Host 'All required environment variables are present.';
      "
      
# Stage 2: Export Sentinel Rules
export_rules:
  stage: export
  tags:
    - azure
  timeout: 30m
  script:
    - echo "Running PowerShell script to export Sentinel rules..."
    - |
      pwsh -Command "
      # Validate required environment variables
      $requiredEnvVars = @('AZURE_CLIENT_ID', 'AZURE_CLIENT_SECRET', 'AZURE_TENANT_ID', 'AZURE_SUBSCRIPTION_ID')
      foreach ($var in $requiredEnvVars) {
          if (-not (Get-Variable -Name $var -Scope Global)) {
              Write-Error \"$var is missing or empty.\";
              Exit 1;
          }
      }

      # Assign variables from environment
      $servicePrincipalId = '$AZURE_CLIENT_ID';
      $servicePrincipalKey = '$AZURE_CLIENT_SECRET';
      $tenantId = '$AZURE_TENANT_ID';
      $subscriptionId = '$AZURE_SUBSCRIPTION_ID';

      # Convert client secret to secure string
      try {
          $credpass = ConvertTo-SecureString $servicePrincipalKey -AsPlainText -Force;
      } catch {
          Write-Error 'Failed to convert AZURE_CLIENT_SECRET to a secure string.';
          Exit 1;
      }

      # Debug variable values
      Write-Host ('Service Principal ID: ' + $servicePrincipalId);
      Write-Host ('Tenant ID: ' + $tenantId);

      # Create PSCredential object
      try {
          $credential = New-Object System.Management.Automation.PSCredential($servicePrincipalId, $credpass);
      } catch {
          Write-Error 'Failed to create PSCredential object. Verify AZURE_CLIENT_ID and AZURE_CLIENT_SECRET.';
          Exit 1;
      }

      # Connect to Azure
      try {
          Connect-AzAccount -ServicePrincipal -Tenant $tenantId -Credential $credential -Environment 'AzureCloud';
          Set-AzContext -SubscriptionId $subscriptionId -TenantId $tenantId;
      } catch {
          Write-Error 'Failed to authenticate with Azure. Verify credentials and tenant details.';
          Exit 1;
      }

      # Export Azure Sentinel rules
      Write-Host 'Starting Sentinel rules export...';
      Get-SentinelAnalyticsRuleYAML -workspaceName '$WORKSPACE_NAME' -resourceGroupName '$RESOURCE_GROUP' -subscriptionId '$subscriptionId' -outputPath '$OUTPUT_PATH';

      # Success
      Write-Host 'Azure Sentinel rules export completed successfully.';
      "
    - echo "Export completed successfully!"
  artifacts:
    paths:
      - "$RULES_DIR"
    expire_in: 1 hour
