stages:
  - build
  - test

# Variables are referenced from GitLab CI/CD settings (defined in the UI)
variables:
  AZURE_ENVIRONMENT: AzureCloud # Default Azure environment

build_environment:
  stage: build
  tags:
    - azure
    - powershell
  script:
    - echo "Setting up the test environment..."
    - |
      pwsh -Command "
      # Verify PowerShell version
      Write-Host 'PowerShell Version:';
      $PSVersionTable.PSVersion;

      # Verify Az CLI installation
      if (-not (Get-Command az -ErrorAction SilentlyContinue)) {
          Write-Error 'Azure CLI (az) is not installed.';
          Exit 1;
      }
      Write-Host 'Azure CLI is installed.';

      # Verify GitLab environment variables
      $requiredEnvVars = @('AZURE_CLIENT_ID', 'AZURE_CLIENT_SECRET', 'AZURE_TENANT_ID', 'AZURE_SUBSCRIPTION_ID')
      foreach ($var in $requiredEnvVars) {
          $value = (Get-Item -Path "env:$var").Value
          if (-not $value) {
              Write-Error \"$var is missing or empty.\"
              Exit 1
          }
          Write-Host \"$var: $value\"
      }
      Write-Host 'Environment variables validated.';
      "

test_environment:
  stage: test
  tags:
    - azure
    - powershell
  script:
    - echo "Testing Azure CLI authentication and environment..."
    - |
      pwsh -Command "
      # Set Azure CLI environment variables
      $env:AZURE_CLIENT_ID = (Get-Item -Path 'env:AZURE_CLIENT_ID').Value;
      $env:AZURE_CLIENT_SECRET = (Get-Item -Path 'env:AZURE_CLIENT_SECRET').Value;
      $env:AZURE_TENANT_ID = (Get-Item -Path 'env:AZURE_TENANT_ID').Value;
      $env:AZURE_SUBSCRIPTION_ID = (Get-Item -Path 'env:AZURE_SUBSCRIPTION_ID').Value;

      # Login to Azure CLI
      try {
          az login --service-principal -u $env:AZURE_CLIENT_ID -p $env:AZURE_CLIENT_SECRET --tenant $env:AZURE_TENANT_ID
      } catch {
          Write-Error 'Azure CLI login failed. Verify credentials and tenant details.';
          Exit 1;
      }

      # Set Azure subscription
      try {
          az account set --subscription $env:AZURE_SUBSCRIPTION_ID
      } catch {
          Write-Error 'Failed to set Azure subscription.';
          Exit 1;
      }

      Write-Host 'Azure CLI connected and subscription set.';
      "

