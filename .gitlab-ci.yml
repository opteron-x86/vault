test_environment:
  stage: test
  tags:
    - azure
    - powershell
  script:
    - echo "Testing Azure CLI authentication..."
    - |
      pwsh -Command "
      # Assign environment variables to local variables
      $clientId = $env:AZURE_CLIENT_ID
      $clientSecret = $env:AZURE_CLIENT_SECRET
      $tenantId = $env:AZURE_TENANT_ID
      $subscriptionId = $env:AZURE_SUBSCRIPTION_ID

      # Validate that all required variables are set
      if (-not $clientId -or -not $clientSecret -or -not $tenantId -or -not $subscriptionId) {
          Write-Error 'One or more required environment variables are missing or empty: AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID.'
          Exit 1
      }

      # Log in to Azure CLI
      try {
          az login --service-principal -u $clientId -p $clientSecret --tenant $tenantId
          Write-Host 'Azure CLI login successful.'
      } catch {
          Write-Error 'Azure CLI login failed. Verify credentials.'
          Exit 1
      }

      # Set Azure subscription
      try {
          az account set --subscription $subscriptionId
          Write-Host 'Azure subscription set successfully.'
      } catch {
          Write-Error 'Failed to set Azure subscription.'
          Exit 1
      }

      Write-Host 'Azure CLI connected and environment ready.';
      "
