# Define global variables
variables:
  RULES_DIR: "cyber-threat-emulation/Detection_Rules/Azure_Analytics" # Directory for rules
  RULES_FILE: "rules.yaml" # Name of the output file

stages:
  - test
  - export
  - push

# Stage 1: Test PowerShell Environment
powershell_test_job:
  stage: test
  tags:
    - azure
    - powershell
  script:
    - echo "Testing PowerShell environment..."
    - pwsh -Command "Get-Host" # Verify PowerShell availability
    - pwsh -Command "Get-Module -ListAvailable" # List available PowerShell modules

# Stage 2: Export Azure Sentinel Rules with PowerShell
export_rules:
  stage: export
  tags:
    - azure
    - cte
  script:
  - echo "Running PowerShell script to export Sentinel rules..."
  - |
    pwsh -Command "
    # Define parameters
    $resourceGroupName = '$RESOURCE_GROUP';
    $workspaceName = '$WORKSPACE_NAME';
    $subscriptionid = '$AZURE_SUBSCRIPTION_ID';

    # Authenticate with Azure if no context is available
    if (!(Get-AzContext)) {
        # Parse credentials from environment variable
        try {
            $secrets = ConvertFrom-JSON '$env:credentials';
        } catch {
            Write-Error 'Failed to parse Azure credentials. Ensure the credentials variable is set and properly formatted.';
            Exit 1;
        }

        # Debugging: Output the credentials for validation (mask sensitive info)
        Write-Host 'Debug: Checking credentials...';
        Write-Host ('ClientId: ' + $secrets.clientId);
        Write-Host ('TenantId: ' + $secrets.tenantId);

        # Validate that all required fields are present
        if (-not $secrets.clientId -or -not $secrets.clientSecret -or -not $secrets.tenantId) {
            Write-Error 'Azure Service Principal credentials are incomplete. Ensure clientId, clientSecret, and tenantId are set.';
            Exit 1;
        }

        # Assign variables for credentials
        $servicePrincipalId = $secrets.clientId;
        $servicePrincipalKey = $secrets.clientSecret;
        $tenantId = $secrets.tenantId;

        # Convert clientSecret to a secure string
        try {
            $credpass = ConvertTo-SecureString $servicePrincipalKey -AsPlainText -Force;
        } catch {
            Write-Error 'Failed to convert clientSecret to a secure string.';
            Exit 1;
        }

        # Create the credential object
        try {
            $credential = New-Object System.Management.Automation.PSCredential($servicePrincipalId, $credpass);
        } catch {
            Write-Error 'Failed to create PSCredential object. Ensure clientId and clientSecret are valid.';
            Exit 1;
        }

        # Connect to Azure
        try {
            Connect-AzAccount -ServicePrincipal -Tenant $tenantId -Credential $credential -Environment 'AzureCloud';
            Set-AzContext -SubscriptionId $subscriptionid -TenantId $tenantId;
        } catch {
            Write-Error 'Failed to authenticate with Azure. Check credentials and subscription details.';
            Exit 1;
        }
    }

    # Export Azure Sentinel rules
    Get-SentinelAnalyticsRuleYAML -workspaceName $workspaceName -resourceGroupName $resourceGroupName -subscriptionId $subscriptionid -outputPath './$RULES_DIR';
    "