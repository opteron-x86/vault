# Define global variables
variables:
  RULES_DIR: "cyber-threat-emulation/Detection_Rules/Azure_Analytics" # Directory for rules
  RULES_FILE: "rules.yaml" # Name of the output file

stages:
  - test
  - export
  - push

# Stage 1: Test PowerShell Environment
powershell_test_job:
  stage: test
  tags:
    - azure
    - powershell
  script:
    - echo "Testing PowerShell environment..."
    - pwsh -Command "Get-Host" # Verify PowerShell availability
    - pwsh -Command "Get-Module -ListAvailable" # List available PowerShell modules
    - "C:\\Program Files\\PowerShell\\7\\pwsh.exe --version"


# Stage 2: Export Azure Sentinel Rules with PowerShell
export_rules:
  stage: export
  tags:
    - azure
    - cte
  script:
  - echo "Running PowerShell script to export Sentinel rules..."
  - |
    pwsh -Command "
    # Define parameters from environment variables
    $resourceGroupName = '$RESOURCE_GROUP';
    $workspaceName = '$WORKSPACE_NAME';
    $subscriptionid = '$AZURE_SUBSCRIPTION_ID';
    $servicePrincipalId = '$AZURE_CLIENT_ID';
    $servicePrincipalKey = '$AZURE_CLIENT_SECRET';
    $tenantId = '$AZURE_TENANT_ID';

    # Debugging: Validate environment variables
    Write-Host 'Debug: Validating environment variables...';
    Write-Host ('ClientId: ' + $servicePrincipalId);
    Write-Host ('TenantId: ' + $tenantId);
    Write-Host ('SubscriptionId: ' + $subscriptionid);

    # Validate that required variables are set
    if (-not $servicePrincipalId -or -not $servicePrincipalKey -or -not $tenantId -or -not $subscriptionid) {
        Write-Error 'One or more Azure Service Principal variables are missing. Ensure AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_TENANT_ID, and AZURE_SUBSCRIPTION_ID are set.';
        Exit 1;
    }

    # Convert clientSecret to a secure string
    try {
        $credpass = ConvertTo-SecureString $servicePrincipalKey -AsPlainText -Force;
    } catch {
        Write-Error 'Failed to convert AZURE_CLIENT_SECRET to a secure string.';
        Exit 1;
    }

    # Create the PSCredential object
    try {
        $credential = New-Object System.Management.Automation.PSCredential($servicePrincipalId, $credpass);
    } catch {
        Write-Error 'Failed to create PSCredential object. Check AZURE_CLIENT_ID and AZURE_CLIENT_SECRET.';
        Exit 1;
    }

    # Authenticate with Azure
    try {
        Connect-AzAccount -ServicePrincipal -Tenant $tenantId -Credential $credential -Environment 'AzureCloud';
        Set-AzContext -SubscriptionId $subscriptionid -TenantId $tenantId;
    } catch {
        Write-Error 'Failed to authenticate with Azure. Verify credentials and subscription details.';
        Exit 1;
    }

    # Export Azure Sentinel rules
    Get-SentinelAnalyticsRuleYAML -workspaceName $workspaceName -resourceGroupName $resourceGroupName -subscriptionId $subscriptionid -outputPath './$RULES_DIR';

    Write-Host 'Azure Sentinel rules export completed successfully.';
    "
