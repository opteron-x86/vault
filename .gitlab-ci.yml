stages:
  - build
  - deploy

build:
  stage: build
  tags:
    - azure
    - powershell
    - cte
  script:
    - |
      powershell -Command "& {
        Write-Host 'Starting build stage...';
        Write-Host 'Installing necessary modules...';
        Install-Module -Name Az -Force -Scope CurrentUser;
         # Import-Module -Name Az -ErrorAction Stop;
        Import-Module -Name Az -Verbose
        Write-Host 'Modules installed successfully.';
        Write-Host 'Compiling PowerShell scripts...';
        # Add additional build steps, such as packaging or compiling, here
        Write-Host 'Build completed successfully.';
      }"

deploy:
  stage: deploy
  variables:
    GIT_USERNAME: "danielle.m.torrence.ctr@mail.mil"  # Replace with your GitLab username
    GIT_PASSWORD: $GITLAB_TOKEN  # Use a GitLab personal access token
  before_script:
    - |
      powershell -Command "& {
        if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
            Write-Host 'Git is not installed. Exiting.';
            Exit 1;
        }
      }"
    - |
      powershell -Command "& {
        git config --global user.email \"ci@example.com\";
        git config --global user.name \"CI\";
        git remote remove origin || Write-Host 'No existing origin to remove.';
        git remote add origin https://${env:GIT_USERNAME}:${env:GIT_PASSWORD}@gitlab.com/your-namespace/your-repo.git;
      }"
  script:
    - |
      powershell -Command "& {
        Write-Host 'Deploying Azure Sentinel rules...';
        
        # Log in to Azure
        Connect-AzAccount -SubscriptionId $env:subscriptionid;

        # Define path to rule JSON files
        $rulesPath = './Detection_Rules/Azure_Analytics/*.json';

        foreach ($file in Get-ChildItem -Path $rulesPath) {
          $ruleContent = Get-Content -Path $file.FullName -Raw | ConvertFrom-Json;
          $ruleId = $file.BaseName;
          
          # Deploy the rule using Azure REST API
          $body = $ruleContent | ConvertTo-Json -Depth 10;
          $uri = \"https://management.azure.com/subscriptions/$($env:subscriptionid)/resourceGroups/$($env:resourceGroupName)/providers/Microsoft.OperationalInsights/workspaces/$($env:workspaceName)/providers/Microsoft.SecurityInsights/alertRules/$ruleId?api-version=2022-11-01-preview\";

          Invoke-RestMethod -Uri $uri -Method PUT -Headers @{
            Authorization = \"Bearer $(az account get-access-token --resource https://management.azure.com --query accessToken -o tsv)\"
          } -Body $body -ContentType 'application/json';
          
          Write-Host \"Successfully deployed rule: $ruleId\";
        }
      }"
    - |
      powershell -Command "& {
        Write-Host 'Backing up rules to GitLab...';
        git add './Detection_Rules/Azure_Analytics/';
        git commit -m \"CI Backup - $env:CI_JOB_STARTED_AT\";
        git push origin HEAD:$env:CI_COMMIT_REF_NAME;
      }"
  tags:
    - azure
    - powershell
    - cte
  when: manual
