# Define global variables
variables:
  RULES_DIR: "cyber-threat-emulation/Detection_Rules/Azure_Analytics" # Directory for rules
  RULES_FILE: "rules.yaml" # Name of the output file

stages:
  - test
  - export
  - push

# Stage 1: Test PowerShell Environment
powershell_test_job:
  stage: test
  tags:
    - azure
    - powershell
  script:
    - echo "Testing PowerShell environment..."
    - pwsh -Command "Get-Host" # Verify PowerShell availability
    - pwsh -Command "Get-Module -ListAvailable" # List available PowerShell modules

# Stage 2: Export Azure Sentinel Rules with PowerShell
export_rules:
  stage: export
  tags:
    - azure
    - cte
  script:
    - echo "Starting Azure Sentinel rules export using PowerShell..."
    - echo "Installing necessary PowerShell modules..."
    - |
      pwsh -Command "
      try {
        # Attempt to install the module
        Install-Module -Name powershell-yaml -Force -Scope CurrentUser -ErrorAction Stop;
        Import-Module -Name powershell-yaml -Force;
      } catch {
        Write-Error 'Failed to install or import the powershell-yaml module.';
        Exit 1;
      }
      "
    - echo "Running PowerShell script to export Sentinel rules..."
    - |
      pwsh -Command "
      # Define parameters
      $resourceGroupName = '$RESOURCE_GROUP';
      $workspaceName = '$WORKSPACE_NAME';
      $subscriptionid = '$AZURE_SUBSCRIPTION_ID';

      # Authenticate with Azure
      if (!(Get-AzContext)) {
        $secrets = ConvertFrom-JSON '$env:credentials';
        $servicePrincipalId = $secrets.clientId;
        $servicePrincipalKey = $secrets.clientSecret;
        $tenantId = $secrets.tenantId;
        $credpass = ConvertTo-SecureString $servicePrincipalKey -AsPlainText -Force;
        Connect-AzAccount -ServicePrincipal -Tenant $tenantId -Credential (New-Object System.Management.Automation.PSCredential($servicePrincipalId, $credpass)) -Environment 'AzureCloud';
        Set-AzContext -SubscriptionId $subscriptionid -TenantId $tenantId;
      }

      # Export Azure Sentinel rules
      Get-SentinelAnalyticsRuleYAML -workspaceName $workspaceName -resourceGroupName $resourceGroupName -subscriptionId $subscriptionid -outputPath './$RULES_DIR';
      "
    - echo "Rules successfully exported using PowerShell."
    - pwsh -Command "Get-ChildItem -Path './$RULES_DIR'"
  artifacts:
    paths:
      - "$RULES_DIR"
    expire_in: 1 hour

# Stage 3: Commit and Push to GitLab
push_to_gitlab:
  stage: push
  tags:
    - azure
    - cte
  script:
    - echo "Setting up Git configuration..."
    - pwsh -Command "
      git config --global user.email 'ci-bot@example.com';
      git config --global user.name 'GitLab CI Bot';
      "
    - echo "Cloning the repository using SSH..."
    - pwsh -Command "
      mkdir repo;
      Set-Location repo;
      git clone git@gitlab.com:$CI_PROJECT_PATH.git .;
      "
    - echo "Copying exported rules to target directory..."
    - pwsh -Command "
      mkdir -p '$RULES_DIR';
      Copy-Item -Path '../$RULES_DIR/*' -Destination '$RULES_DIR' -Recurse;
      "
    - echo "Committing and pushing changes..."
    - |
      pwsh -Command "
      git add '$RULES_DIR/*';
      git commit -m 'Update Azure Sentinel analytics rules: $(Get-Date -Format \"yyyy-MM-dd HH:mm:ss\")';
      git push origin main;
      "
    - echo "Push successful!"
