{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/d5f31187-af90-4c7b-a369-367f72530642')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/d5f31187-af90-4c7b-a369-367f72530642')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "BAH_MosaicLoader",
                "description": "Looks for attempts to create Windows Defender exclusions through registry value keys being set in various different methods (e.g., PowerShell, Registry key value modifications, and via Defender Control Panel. Catches on exclusion paths, extensions, and processes.\nPlatform:Windows.MITRE:TA0005;T1112",
                "severity": "Medium",
                "enabled": true,
                "query": "//Title: BAH_MosaicLoader\r\n//Description: Looks for attempts to create Windows Defender exclusions through registry value keys being set in various different methods (e.g., PowerShell, Registry key value modifications, and via Defender Security Panel. Catches on exclusion paths, extensions, and processes.\r\n//Author: Steven Wan\r\n//False Positives: None applicable at this time.\r\nlet signInLookup = (\r\nSigninLogs\r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\nDeviceRegistryEvents\r\n| where TimeGenerated >= ago(1d)\r\n| where ((ActionType == \"RegistryValueSet\") and (RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Paths\" \r\n  or RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Extensions\"\r\n  or RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Processes\"))\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for signin lookup by device will find last user signed into device if it was in the last 24 hours\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI // this join will add UserPrincipalName from here forward based on device name\r\n| project TimeGenerated, InitiatingProcessAccountName, UserPrincipalName, ActionType,  DeviceId, DeviceName, RegistryKey, RegistryValueName",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "DefenseEvasion"
                ],
                "techniques": [
                    "T1112"
                ],
                "subTechniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": null,
                        "groupByCustomDetails": null
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null,
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        }
    ]
}