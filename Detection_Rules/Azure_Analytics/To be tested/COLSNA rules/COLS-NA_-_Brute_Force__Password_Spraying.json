{
    "id":  "/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6b08c8b1-a093-4812-ab54-3514e64139b1",
    "name":  "6b08c8b1-a093-4812-ab54-3514e64139b1",
    "etag":  "\"8700746d-0000-2700-0000-66fdc30c0000\"",
    "type":  "Microsoft.SecurityInsights/alertRules",
    "kind":  "Scheduled",
    "properties":  {
                       "queryFrequency":  "PT1H",
                       "queryPeriod":  "PT1H",
                       "triggerOperator":  "GreaterThan",
                       "triggerThreshold":  0,
                       "severity":  "Medium",
                       "query":  "let thresholdForUniqueFailedAccounts = 20;\r\nlet upperBoundOfFailedLogonsPerAccount = 10;\r\nlet ratioSuccessFailedLogons = 0.5;\r\nlet timeframe = 1d;\r\nDeviceLogonEvents\r\n| where TimeGenerated \u003e= ago(timeframe)\r\n| where LogonType != \"Unlock\" and ActionType in (\"LogonSuccess\", \"LogonFailed\")\r\n| where not(isempty(RemoteIP) and isempty(RemoteDeviceName))\r\n| extend LocalLogon=parse_json(AdditionalFields)\r\n| where RemoteIPType != \"Loopback\"\r\n| summarize \r\n    SuccessLogonCount = countif(ActionType == \"LogonSuccess\"),\r\n    FailedLogonCount = countif(ActionType == \"LogonFailed\"),\r\n    UniqueAccountFailedLogons=dcountif(AccountName, ActionType == \"LogonFailed\"),\r\n    FirstFailed=minif(TimeGenerated, ActionType == \"LogonFailed\"),\r\n    LastFailed=maxif(TimeGenerated, ActionType == \"LogonFailed\"),\r\n    LastTimestamp=arg_max(TimeGenerated, tostring(ReportId))\r\n    by RemoteIP, RemoteDeviceName, DeviceName, MachineGroup //Remote IP is here the source of the logon attempt.\r\n| project-rename TargetDeviceName = DeviceName\r\n| project-rename TargetMachineGroup = MachineGroup\r\n| where UniqueAccountFailedLogons \u003e thresholdForUniqueFailedAccounts\r\n    and SuccessLogonCount * ratioSuccessFailedLogons \u003c FailedLogonCount\r\n    and UniqueAccountFailedLogons * upperBoundOfFailedLogonsPerAccount \u003e FailedLogonCount \r\n//Run this query (seperate) to pullback more information from DeviceLogonEvents\r\n//DeviceLogonEvents\r\n//| where TimeGenerated between ( datetime(09-06-2023, 06:21:42.2695082) .. datetime(09-06-2023, 06:33:02.7499625) )\r\n//| where DeviceName has \"DeviceName\"\r\n//| where RemoteIP has \"RemoteIp\"",
                       "suppressionDuration":  "PT5H",
                       "suppressionEnabled":  false,
                       "incidentConfiguration":  {
                                                     "createIncident":  true,
                                                     "groupingConfiguration":  {
                                                                                   "enabled":  false,
                                                                                   "reopenClosedIncident":  false,
                                                                                   "lookbackDuration":  "PT5H",
                                                                                   "matchingMethod":  "AllEntities",
                                                                                   "groupByEntities":  [

                                                                                                       ],
                                                                                   "groupByAlertDetails":  [

                                                                                                           ],
                                                                                   "groupByCustomDetails":  [

                                                                                                            ]
                                                                               }
                                                 },
                       "entityMappings":  [
                                              {
                                                  "entityType":  "Account",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "FullName",
                                                                            "columnName":  "TargetDeviceName"
                                                                        }
                                                                    ]
                                              },
                                              {
                                                  "entityType":  "IP",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "Address",
                                                                            "columnName":  "RemoteIP"
                                                                        }
                                                                    ]
                                              }
                                          ],
                       "eventGroupingSettings":  {
                                                     "aggregationKind":  "SingleAlert"
                                                 },
                       "tactics":  [
                                       "CredentialAccess",
                                       "InitialAccess"
                                   ],
                       "techniques":  [
                                          "T1110"
                                      ],
                       "displayName":  "COLS-NA - Brute Force: Password Spraying",
                       "enabled":  true,
                       "description":  "Technical description of the attack: \nThe query searches for failed logins from a single source towards multiple different accounts and provides three parameters to tune the results for your specific environment. The full details of the working are described in the blog post linked above.\n\nA password spraying attack is detected, where a single machine has performed a large number of failed login attempts, with a large number of different accounts. For each account, the attacker uses just a few attempts to prevent account lockout. This query uses the DeviceLogonEvents per machine to detect a password spraying attacks. The machine against which the password spraying is performed (can be DC, a server or even an endpoint) needs to be enrolled in Microsoft Defender for Endpoint.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0006;T1110;T1110.001,TA0007;T1087;T1087.003;T1087.004",
                       "alertRuleTemplateName":  null,
                       "lastModifiedUtc":  "2024-10-02T22:02:50.7287079Z"
                   }
}
