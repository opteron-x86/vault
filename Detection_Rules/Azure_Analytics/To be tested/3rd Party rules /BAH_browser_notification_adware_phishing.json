{
    "id":  "/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6ef693b8-d643-4886-ae39-cb8886a29f50",
    "name":  "6ef693b8-d643-4886-ae39-cb8886a29f50",
    "etag":  "\"88003806-0000-2700-0000-66fdcce70000\"",
    "type":  "Microsoft.SecurityInsights/alertRules",
    "kind":  "Scheduled",
    "properties":  {
                       "queryFrequency":  "PT1H",
                       "queryPeriod":  "PT1H",
                       "triggerOperator":  "GreaterThan",
                       "triggerThreshold":  0,
                       "severity":  "Low",
                       "query":  "//Title: BAH_Browser_Notification_Adware_Phishing\n//Author: Rob Russell, Steven Wan\n//Description: Looks for possible notification phishing where user\u0027s subscribe to browser notifications. Searches for the command line switches that contains --notification and parses the results for analysis.\n// https://source.chromium.org/chromium/chromium/src/+/main:chrome/common/chrome_switches.cc?q=kNotificationLaunchId\u0026ss=chromium\n// more details here\n// https://www.rapid7.com/blog/post/2021/10/28/sneaking-through-windows-infostealer-malware-masquerades-as-windows-application/\n// https://www.mcafee.com/blogs/other-blogs/mcafee-labs/scammers-impersonating-windows-defender-to-push-malicious-windows-apps/\n// https://www.mcafee.com/blogs/other-blogs/mcafee-labs/how-to-stop-the-popups/\n//False Positives: common domains where people subscribe to notifications such as teams, web mail, slack and facebook. Use domainAllowList to allow list items\n\nlet tld_regex = @\"(?:[a-zA-Z]*\\.)+(?P\u003ctld\u003e[a-zA-Z]+)(?:\\/.*)?\";\nlet maliciousurllist = externaldata(DateAdded:string,IoC:string,Type:string) [@\"https://malware-filter.gitlab.io/malware-filter/urlhaus-filter-online.txt\"] with (format=\"csv\", ignoreFirstRecord=True);\nlet signInLookup = (\nSigninLogs\n//| where TimeGenerated \u003e= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nDeviceProcessEvents\n| where ProcessCommandLine contains \"--notification\"\n| where not (ProcessCommandLine endswith @\"chrome://settings/security?q=enhanced|TailoredSecurityUnconsentedPromotionNotification\") // defeat for safe browsing blocks\n| extend notification_split = split(ProcessCommandLine, \"=\")\n| extend notification_cmd = split(notification_split[1], \"|\")\n| extend notification_source = notification_cmd[-2]\n| where isnotempty(notification_source)\n| extend urlinfo = extract_all(tld_regex, dynamic([\u0027tld\u0027]),tostring(notification_source))\n| where not (urlinfo has_any (\"mil\",\"us\"))\n| extend notification_id = notification_cmd[-1]\n| where (notification_source has_any(maliciousurllist)) or (notification_cmd has_any(maliciousurllist))\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n| project UserPrincipalName, DeviceName, InitiatingProcessAccountUpn, ActionType ,notification_source, notification_id",
                       "suppressionDuration":  "PT5H",
                       "suppressionEnabled":  false,
                       "incidentConfiguration":  {
                                                     "createIncident":  true,
                                                     "groupingConfiguration":  {
                                                                                   "enabled":  false,
                                                                                   "reopenClosedIncident":  false,
                                                                                   "lookbackDuration":  "PT5M",
                                                                                   "matchingMethod":  "AllEntities",
                                                                                   "groupByEntities":  [

                                                                                                       ],
                                                                                   "groupByAlertDetails":  null,
                                                                                   "groupByCustomDetails":  null
                                                                               }
                                                 },
                       "entityMappings":  [
                                              {
                                                  "entityType":  "Account",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "FullName",
                                                                            "columnName":  "UserPrincipalName"
                                                                        }
                                                                    ]
                                              },
                                              {
                                                  "entityType":  "Host",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "HostName",
                                                                            "columnName":  "DeviceName"
                                                                        }
                                                                    ]
                                              },
                                              {
                                                  "entityType":  "URL",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "Url",
                                                                            "columnName":  "notification_source"
                                                                        }
                                                                    ]
                                              }
                                          ],
                       "eventGroupingSettings":  {
                                                     "aggregationKind":  "SingleAlert"
                                                 },
                       "tactics":  [
                                       "InitialAccess"
                                   ],
                       "techniques":  [
                                          "T1189"
                                      ],
                       "displayName":  "BAH_browser_notification_adware_phishing",
                       "enabled":  true,
                       "description":  "Looks for notifications coming from uncommon domains that could be an attempt to phish a user using the Windows toast notification service. Has a chance to provide false alarms, domains detected should be reviewed.\nPLATFORM:Windows\nMITRE:TA0001;T1189",
                       "alertRuleTemplateName":  null,
                       "lastModifiedUtc":  "2024-10-02T22:44:54.7967487Z"
                   }
}
