{
    "id":  "/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8c19c82c-fcd6-46b4-b2ce-56ee6a4a6e07",
    "name":  "8c19c82c-fcd6-46b4-b2ce-56ee6a4a6e07",
    "etag":  "\"88000201-0000-2700-0000-66fdcc900000\"",
    "type":  "Microsoft.SecurityInsights/alertRules",
    "kind":  "Scheduled",
    "properties":  {
                       "queryFrequency":  "PT1H",
                       "queryPeriod":  "PT1H",
                       "triggerOperator":  "GreaterThan",
                       "triggerThreshold":  0,
                       "severity":  "Medium",
                       "query":  "//Author: Rob Russell\n//Description:\n// https://isc.sans.edu/forums/diary/Atlassian+Confluence+Exploits+Seen+By+Our+Honeypots+CVE202226134/28722/\n// https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html\n// example attack strings based on honeypot data\n//%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22whoami%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%2\n// index.action?redirect%3A%24%7B%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3Dfalse%2C%23f%3D%23%5FmemberAccess.getClass().getDeclaredField(%22allowStaticMethodAccess%22)%2C%23f.setAccessible(true)%2C%23f.set(%23%5FmemberAccess%2Ctr\n// False Positives: This could be triggered by scans looking for this vulnerability\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated \u003e= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nlet CVEStrings = dynamic([\"org.apache.commons.io.IOUtils\", \"allowStaticMethodAccess\"]);\n(union isfuzzy=true(\n    DeviceNetworkEvents\n    | where isnotempty(RemoteUrl)\n    | where RemoteUrl has_any (\"org.apache.commons.io.IOUtils\", \"allowStaticMethodAccess\")\n    | extend RemoteUrl = iif(RemoteUrl contains \u0027%\u0027, url_decode(RemoteUrl), RemoteUrl) // if url encoded, decode it\n    | extend First16Chars = substring(RemoteUrl, 0, 16)\n    | join kind=leftouter (\n    DeviceNetworkEvents\n        | extend First16Chars = substring(RemoteUrl, 0, 16)\n        | summarize make_set(RemoteUrl, 200) by First16Chars, InitiatingProcessId, DeviceName  \n    ) on $left.First16Chars == $right.First16Chars, $left.DeviceName == $right.DeviceName, $left.InitiatingProcessId == $right.InitiatingProcessId\n    | where array_length(set_RemoteUrl) \u003c 100 // filters out  web scanning activity based on the number of urls coming from the same device and initiating process id and start of URL\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for sign in lookup by device, will find last user signed into device if it was in the last 24 hours\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        RemoteUrl,\n        LocalIP,\n        RemoteIP,\n        DeviceName,\n        UserPrincipalName,\n        InitiatingProcessAccountUpn,\n        InitiatingProcessAccountDomain    \n    ),\n    (DeviceProcessEvents\n    | where InitiatingProcessFolderPath endswith @\"\\Atlassian\\Confluence\\jre\\bin\\java.exe\"\n    | where ProcessCommandLine has_any (\"cmd /c\", \"cmd /k\", \"powershell\", \"certutil\", \"curl\", \"whoami\", \"ipconfig\")\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for signin lookup by device will find last user signed into device if it was in the last 24 hours\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        InitiatingProcessFolderPath,\n        ProcessCommandLine,\n        DeviceName,\n        UserPrincipalName,\n        AccountUpn,\n        AccountDomain\n    )\n)",
                       "suppressionDuration":  "PT5H",
                       "suppressionEnabled":  false,
                       "incidentConfiguration":  {
                                                     "createIncident":  true,
                                                     "groupingConfiguration":  {
                                                                                   "enabled":  false,
                                                                                   "reopenClosedIncident":  false,
                                                                                   "lookbackDuration":  "PT5M",
                                                                                   "matchingMethod":  "AllEntities",
                                                                                   "groupByEntities":  [

                                                                                                       ],
                                                                                   "groupByAlertDetails":  null,
                                                                                   "groupByCustomDetails":  null
                                                                               }
                                                 },
                       "entityMappings":  [
                                              {
                                                  "entityType":  "Host",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "HostName",
                                                                            "columnName":  "DeviceName"
                                                                        }
                                                                    ]
                                              },
                                              {
                                                  "entityType":  "Account",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "FullName",
                                                                            "columnName":  "UserPrincipalName"
                                                                        },
                                                                        {
                                                                            "identifier":  "NTDomain",
                                                                            "columnName":  "AccountDomain"
                                                                        }
                                                                    ]
                                              },
                                              {
                                                  "entityType":  "IP",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "Address",
                                                                            "columnName":  "LocalIP"
                                                                        }
                                                                    ]
                                              }
                                          ],
                       "eventGroupingSettings":  {
                                                     "aggregationKind":  "SingleAlert"
                                                 },
                       "tactics":  [
                                       "Execution",
                                       "InitialAccess"
                                   ],
                       "techniques":  [
                                          "T1059",
                                          "T1190"
                                      ],
                       "displayName":  "BAH_Confluence_CVE-2022-26134",
                       "enabled":  true,
                       "description":  "Detects URLs and process activity related to remote code execution vulnerability in Confluence CVE-2022-26134\n\nPLATFORM:Windows\nMITRE:TA0001;T1190,TA0002;T1059;T1059.009",
                       "alertRuleTemplateName":  null,
                       "lastModifiedUtc":  "2024-10-02T22:43:27.7956732Z"
                   }
}
