{
    "id":  "/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/2a4fb5dd-b394-4a3f-8434-0be86b056b93",
    "name":  "2a4fb5dd-b394-4a3f-8434-0be86b056b93",
    "etag":  "\"8800fc09-0000-2700-0000-66fdcd370000\"",
    "type":  "Microsoft.SecurityInsights/alertRules",
    "kind":  "Scheduled",
    "properties":  {
                       "queryFrequency":  "PT5M",
                       "queryPeriod":  "PT6M",
                       "triggerOperator":  "GreaterThan",
                       "triggerThreshold":  0,
                       "severity":  "Medium",
                       "query":  "//Author: Matt Schwartz\r\n//Description: This analytic looks for new credentials (secrets and certificates) added to application registrations. This version of the analytic includes a known Azure AD Connect sync account that generates a lot of noise.\r\n//False Positives: None known\r\nlet excludeSync = \u002706c9ca02-8129-473d-8ae9-f964890b5706\u0027;\r\nlet Sparrow_BaseHunt_AuditLog=(opstable:(Category_:string,Operation:string)){\r\nAuditLogs | where InitiatedBy has excludeSync | join kind=inner opstable on $left.OperationName == $right.Operation | mv-expand TargetResources, AdditionalDetails, InitiatedBy| extend ib_app = \"\", ib_user = \"\", tr_modifiedProperties = dynamic(null), tr_type = \"\", tr_displayName = \"\", tr_id = \"\"| extend tr = parse_json(TargetResources), ad = parse_json(AdditionalDetails), ib = parse_json(InitiatedBy)| evaluate bag_unpack(tr, \u0027tr_\u0027, columnsConflict=\u0027replace_source\u0027)| evaluate bag_unpack(ad, \u0027ad_\u0027, columnsConflict=\u0027replace_source\u0027)| evaluate bag_unpack(ib, \u0027ib_\u0027, columnsConflict=\u0027replace_source\u0027)| extend app_actor = iif(isnotempty(ib_app),true,false)| extend obj_actor = iif(app_actor, parse_json(ib_app), parse_json(ib_user))| extend actor_id = iif(app_actor,coalesce(obj_actor.appId,obj_actor.servicePrincipalId),obj_actor.userPrincipalName)| extend actor_name = iif(app_actor,obj_actor.displayName,obj_actor.userPrincipalName)| extend actor_type = iif(app_actor,\"App\",\"User\")| extend tr_modifiedProperties = iif(tr_modifiedProperties==\"[]\",dynamic(null),tr_modifiedProperties)| mv-expand tr_modifiedProperties| extend newValue = tostring(tr_modifiedProperties.newValue)| extend oldValue = tostring(tr_modifiedProperties.oldValue)| extend set1 = parse_json(newValue)| extend set2 = parse_json(oldValue)| extend diff = set_difference(set1, set2)| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *| extend credential = case(keyType != \"\", keyType, \"Other/not logged\")};\r\nSparrow_BaseHunt_AuditLog(datatable(Category_: string, Operation: string) [\r\n\u0027AppRoleAssignment_Operations\u0027, \u0027Add app role assignment to service principal\u0027\r\n,\r\n\u0027AppRoleAssignment_Operations\u0027, \u0027Add app role assignment grant to user\u0027\r\n,\r\n\u0027AppRoleAssignment_Operations\u0027, \u0027Add app role assignment to group\u0027\r\n])\r\n| extend propertyName = tostring(tr_modifiedProperties.displayName)\r\n| extend bPermission = iif(propertyName == \"AppRole.Value\", true, false)\r\n| extend bApplication = iif(propertyName == \"ServicePrincipal.AppId\", true, false)\r\n| extend bApplicationName = iif(propertyName == \"ServicePrincipal.DisplayName\", true, false)\r\n| extend bUserObjectId = iif(propertyName == \"User.ObjectID\", true, false)\r\n| extend bUserUPN = iif(propertyName == \"User.UPN\", true, false)\r\n| extend diff = iff(tobool(binary_or(binary_or(binary_or(binary_or(bPermission, bApplication)\r\n, bApplicationName), bUserUPN), bUserObjectId))\r\n, set_difference(pack_array(set1), pack_array(set2)), diff)\r\n| extend PermissionsAssigned = iif(bPermission, diff, \u0027\u0027)\r\n| extend ApplicationAssigned = iif(bApplication, diff, \u0027\u0027)\r\n| extend ApplicationNameAssigned = iif(bApplicationName, diff, \u0027\u0027)\r\n| extend UserObjectId = iif(bUserObjectId, diff, \u0027\u0027)\r\n| extend UserUPN = iif(bUserUPN, diff, \u0027\u0027)\r\n| extend tr_userPrincipalName = column_ifexists(\u0027tr_userPrincipalName\u0027, \u0027NaN\u0027)\r\n| summarize FirstTime = min(TimeGenerated), LastTime = max(TimeGenerated), Duration = max(TimeGenerated) - min(TimeGenerated), Result = make_set_if(Result, isnotempty(Result))\r\n, actor_type = make_set_if(actor_type, isnotempty(actor_type)), actor_id = make_set_if(actor_id, isnotempty(actor_id)), actor_name = make_set_if(actor_name, isnotempty(actor_name))\r\n, OperationName = make_set_if(OperationName, isnotempty(OperationName)), tr_displayName = make_set_if(tr_displayName, isnotempty(tr_displayName)), tr_type = make_set_if(tr_type, isnotempty(tr_type))\r\n, tr_id = make_set_if(tr_id, isnotempty(tr_id))\r\n, UserId = make_set_if(UserObjectId, isnotempty(UserObjectId))\r\n, ApplicationAssigned = make_set_if(ApplicationAssigned, isnotempty(ApplicationAssigned)), PermissionsAssigned = make_set_if(PermissionsAssigned, isnotempty(PermissionsAssigned))\r\n, tr_userPrincipalName = make_set(tr_userPrincipalName)\r\n, ApplicationNameAssigned = make_set_if(ApplicationNameAssigned, isnotempty(ApplicationNameAssigned)), ResultReason = make_set_if(ResultReason, isnotempty(ResultReason))\r\nby CorrelationId\r\n| extend Actor = actor_name[0]\r\n| extend Actor = strcat(iif(actor_type has \"App\", \u0027Application \u0027, \u0027\u0027), Actor)\r\n| extend ActorId = actor_id[0]\r\n| extend UserPrincipalName = tr_userPrincipalName[0]\r\n| extend ApplicationAssignedId = parse_json(tostring(ApplicationAssigned[0]))[0]\r\n| extend ApplicationNameAssigned = todynamic(tostring(ApplicationNameAssigned[0]))[0]\r\n| extend sApplicationNameAssigned = strcat(\u0027\"\u0027, iif(isempty(ApplicationNameAssigned), \u0027\u0027, ApplicationNameAssigned), \u0027\"\u0027)\r\n| extend Result = Result[0]\r\n| extend UserId = todynamic(tostring(UserId[0]))[0]\r\n| mv-apply PermissionsAssigned on (summarize PermissionsAssigned=make_list_if(todynamic(tostring(PermissionsAssigned))[0], isnotempty(todynamic(tostring(PermissionsAssigned))[0])))\r\n| extend cntPermissionsAssigned = array_length(PermissionsAssigned)\r\n| extend sPermissionsAssigned = strcat(iif(cntPermissionsAssigned \u003e 0, iif(cntPermissionsAssigned \u003c 6, strcat(\u0027\"\u0027, trim_end(\"\u0027, \", strcat_array(PermissionsAssigned, \u0027, \u0027)), \u0027\"\u0027)\r\n, tostring(cntPermissionsAssigned)), \"\"), \u0027 rights\u0027)\r\n| extend TargetedResource = tr_displayName[0]\r\n| mv-apply TargetedResourceId = tr_id on (where tostring(UserId) != TargetedResourceId)\r\n| extend success_statement = iif(Result =~ \"success\", iif(sPermissionsAssigned != \" rights\", \u0027granted \u0027, \u0027granted null\u0027)\r\n, iif(sPermissionsAssigned != \" rights\", \u0027failed to grant \u0027, \u0027failed to grant null\u0027))\r\n| extend threat_commentary_strategy = iif(OperationName has \u0027Add app role assignment to service principal\u0027, 1, 0)\r\n| extend threat_commentary = iff(threat_commentary_strategy == 0\r\n, strcat(Actor, \u0027 (\u0027, ActorId, \u0027) \u0027, success_statement, sPermissionsAssigned, \u0027 to user account \u0027, UserPrincipalName, \u0027 (\u0027, UserId, \u0027) for use with the application named \"\u0027\r\n, TargetedResource, \u0027\" (\u0027, TargetedResourceId, \u0027).\u0027)\r\n, strcat(Actor, \u0027 (\u0027, ActorId, \u0027) \u0027, success_statement, sPermissionsAssigned, \u0027 to service principal account \u0027, sApplicationNameAssigned, \u0027 (\u0027, ApplicationAssignedId\r\n, \u0027) for use with the application named \"\u0027, TargetedResource, \u0027\" (\u0027, TargetedResourceId, \u0027).\u0027)\r\n)\r\n| project FirstTime, LastTime, Duration, OperationName, CorrelationId, Actor, ActorId, UserPrincipalName, UserId, ApplicationNameAssigned, ApplicationAssignedId, PermissionsAssigned\r\n, TargetedResource, TargetedResourceId, ResultReason, Result, threat_commentary",
                       "suppressionDuration":  "PT5H",
                       "suppressionEnabled":  false,
                       "incidentConfiguration":  {
                                                     "createIncident":  true,
                                                     "groupingConfiguration":  {
                                                                                   "enabled":  false,
                                                                                   "reopenClosedIncident":  false,
                                                                                   "lookbackDuration":  "PT5H",
                                                                                   "matchingMethod":  "AllEntities",
                                                                                   "groupByEntities":  [

                                                                                                       ],
                                                                                   "groupByAlertDetails":  [

                                                                                                           ],
                                                                                   "groupByCustomDetails":  [

                                                                                                            ]
                                                                               }
                                                 },
                       "entityMappings":  [
                                              {
                                                  "entityType":  "Account",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "AadUserId",
                                                                            "columnName":  "ActorId"
                                                                        }
                                                                    ]
                                              },
                                              {
                                                  "entityType":  "CloudApplication",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "AppId",
                                                                            "columnName":  "ApplicationAssignedId"
                                                                        }
                                                                    ]
                                              },
                                              {
                                                  "entityType":  "Account",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "AadUserId",
                                                                            "columnName":  "UserId"
                                                                        }
                                                                    ]
                                              }
                                          ],
                       "eventGroupingSettings":  {
                                                     "aggregationKind":  "SingleAlert"
                                                 },
                       "tactics":  [
                                       "InitialAccess",
                                       "Persistence",
                                       "PrivilegeEscalation"
                                   ],
                       "techniques":  [
                                          "T1078",
                                          "T1134"
                                      ],
                       "displayName":  "BAH_AppServicePrinciple_ElevatedPrivileges_includeSync",
                       "enabled":  true,
                       "description":  "This analytic looks for new credentials (secrets and certificates) added to application registrations. This version of the analytic excludes a known Azure AD Connect sync account that generates a lot of noise.\nPLATFORM:Windows\nMITRE:TA0001;T1078;T1078.002;T1078.003,TA0003;T1078;T1078.002;T1078.003,TA0004;T1078;T1078.002;T1078.003;T1134,TA0005;T1078;T1078.002;T1078.003",
                       "alertRuleTemplateName":  null,
                       "lastModifiedUtc":  "2024-10-02T22:46:13.9711455Z"
                   }
}
