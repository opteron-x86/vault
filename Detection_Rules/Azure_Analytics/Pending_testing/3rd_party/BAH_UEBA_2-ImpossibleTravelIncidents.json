{
    "id":  "/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b7824ab7-b695-43a7-8095-ef02ac7f3b0d",
    "name":  "b7824ab7-b695-43a7-8095-ef02ac7f3b0d",
    "etag":  "\"8700a48f-0000-2700-0000-66fdc5130000\"",
    "type":  "Microsoft.SecurityInsights/alertRules",
    "kind":  "Scheduled",
    "properties":  {
                       "queryFrequency":  "P1D",
                       "queryPeriod":  "P1D",
                       "triggerOperator":  "GreaterThan",
                       "triggerThreshold":  0,
                       "severity":  "Medium",
                       "query":  "// Author: Ginna Woo, Edward Jiang\n// Description: Identify users connecting from different IP addresses. Based on the IP address geo-location, calculate the distance between the 2 locations. Using the timestamps for the connections from the two locations, estimate if it was possible to travel between the two locations within the calculated time difference AND if the speed is humanly possible. Max speed on commerical liner is around 1000 km, however, we increased the threshold to 1500 km/h. Discard any failed login attempts. Check signin activities against whitelist of VPN IPs. \n//Edge Cases: In some scenarios there will be 2 or more locations that a user recently travel to. This analytic only does a calc on the first two locations, ignoring additional locations (if applicable). There are discussions on potentially leveraging external options to perform these calculations on multiple locations using Python/Notebooks and referencing those notebooks in the analytic. \n// False Positives: None known\nlet maxSpeed = 1500; //Filter for speed over a specific threshold (i.e. 1500 km/hour ??? a bit over the 1000 km/hour average speed of a jet liner)\nlet minHours = 1; //THRESHOLD: Please adjust sensitivity threshold. The smaller the number is (i.e, 0.5) the more sensitive the analytic will be!\nlet minInvestigationPriority = 3; //THRESHOLD: Please adjust sensitivity threshold on a scale between 0-10\n// Grabs IP allow list from CSV\nlet allowList = \n    toscalar(\n        (externaldata(BCAP:string)[@\"https://dod365csspstorage.blob.core.usgovcloudapi.net/ueba/ip.csv\"] with (format=\"csv\", ignoreFirstRecord=True)) \n        | summarize make_list(BCAP)\n    );\nSigninLogs\n| where ResultType == \"0\" //discard any failed attempts to signin\n| extend latitude_ = todouble(parse_json(tostring(LocationDetails.geoCoordinates)).latitude)\n| extend longitude_ = todouble(parse_json(tostring(LocationDetails.geoCoordinates)).longitude)\n| extend countryOrRegion = tostring(LocationDetails.countryOrRegion)\n| extend state = tostring(LocationDetails.state)\n| extend location = strcat(state,\u0027 - \u0027, countryOrRegion)\n| where location \u003c\u003e \u0027 - \u0027\n| extend browser = tostring(DeviceDetail.browser)\n| summarize Count=count(),// count the occurrence of login based on the associated data queried\n    IP=any(IPAddress), //Arbitrarily chooses an IP associated with specific coordinates\n    Last=max(TimeGenerated) by UserDisplayName, latitude_, longitude_, Locations=tostring(location), browser,AppDisplayName, UserPrincipalName, Location, state \n| extend coordinates = pack_array(latitude_,longitude_) //create array using Lat \u0026 Long\n| summarize coordinates=any(coordinates), ///Arbitrarily chooses a coordinate associated with specific lat/long\n    StateCountries=makeset(Locations),\n    Last=max(Last),//last login time \u0026 date\n    IP=tostring(any(IP)), //Arbitrarily chooses an IP associated with specific coordinates.\n    Apps=makeset(AppDisplayName),Browsers=makeset(browser), Locations=makeset(Locations) by UserDisplayName, UserPrincipalName, Location, state\n| where not(ipv4_is_in_any_range(IP,allowList)) //filters out any IP Addresses not in allowList.\n| summarize Coordinates=makeset(coordinates), \n    NumberOfStates=dcount(state), //count distinct location for # of different US States\n    NumberOfCountries=dcount(Location), //count distinct location for # of different countries\n    StateCountries=makeset(Locations), Timestamps=makeset(Last),IPs=makeset(IP),Apps=makeset(Apps),Browsers=makeset(Browsers) by UserDisplayName, UserPrincipalName\n| where NumberOfCountries \u003e 1 or NumberOfStates \u003e 1 //identifying users connecting from 2 or more locations \n//-------------Calculations:---------------------//\n//Calculate the distance between the two coordinates or locations and rounds it to the nearest km. \n| extend distance = round(geo_distance_2points(todouble(Coordinates[1]),todouble(Coordinates[0]),todouble(Coordinates[3]),todouble(Coordinates[2]))/1000,0) \n //Calculating the difference b/w two signin TimeStamps. This will tell us how long it took in hrs for a user to sign back in after reaching \"destination\"\n| extend hours = abs(todouble(datetime_diff(\u0027Minute\u0027, todatetime(Timestamps[1]),todatetime(Timestamps[0]))))/todouble(60) \n// Adjusted \"hours\" traveled to greater or equal to 1 hr - This is to see if travel is possible as coordinates does not give entirely accurate locations - so the smaller the threshold the noiser the analytic will be. This adjustment looks at any travel \u003e= 1 allows us to reduce noise.\n| where hours \u003e= minHours\n//Calculating the speed that the user is traveling in km using distance and hours calculated from above.\n| extend speedKmPerHour = round(distance/hours,0) \n//if speed is greater than the maxSpeed this indicates impossible travel  (maxSpeed = 1500 km/h - speed range greater than a commerical flight which is approx 1000km/h)\n| where speedKmPerHour \u003e maxSpeed \n| project-reorder Timestamps, UserDisplayName, UserPrincipalName, IPs, speedKmPerHour, distance, hours, StateCountries, Apps, Browsers, StateCountries\n//Reformating IPs - cleaning\n| extend IPs = replace(\u0027[\\\\[|\\\\|\\\\\\\\|\"\\\\]]\u0027,\u0027\u0027,tostring(IPs))\n| join BehaviorAnalytics on UserPrincipalName\n| where InvestigationPriority \u003e= minInvestigationPriority\n| evaluate bag_unpack(ActivityInsights, columnsConflict=\"replace_source\")\n| extend DeviceUncommonlyUsedInTenant = column_ifexists(\"DeviceUncommonlyUsedInTenant\", \"\")\n| extend FirstTimeDeviceObservedInTenant = column_ifexists(\"FirstTimeDeviceObservedInTenant\", \"\")\n| extend FirstTimeUserAccessedResource = column_ifexists(\"FirstTimeUserAccessedResource\", \"\")\n| extend FirstTimeUserConnectedFromDevice = column_ifexists(\"FirstTimeUserConnectedFromDevice\", \"\")\n| extend FirstTimeUserConnectedViaBrowser = column_ifexists(\"FirstTimeUserConnectedViaBrowser\", \"\")\n| extend FirstTimeUserUsedApp = column_ifexists(\"FirstTimeUserUsedApp\", \"\")\n| extend ResourceUncommonlyAccessedInTenant = column_ifexists(\"ResourceUncommonlyAccessedInTenant\", \"\")\n| extend SimilarActionWasNotPerformedInThePast = column_ifexists(\"SimilarActionWasNotPerformedInThePast\", \"\")\n| extend UnusualNumberOfDistinctUsersFailedSignInFromIPAddress = column_ifexists(\"UnusualNumberOfDistinctUsersFailedSignInFromIPAddress\", \"\")\n| extend UnusualNumberOfFailedSignInOfThisUser = column_ifexists(\"UnusualNumberOfFailedSignInOfThisUser\", \"\")\n| extend UncommonHighVolumeOfActions = column_ifexists(\"UncommonHighVolumeOfActions\", \"\")\n| extend AppIdUncommonlyAccessedInTenant = column_ifexists(\"AppIdUncommonlyAccessedInTenant\", \"\")\n| extend BrowserUncommonlyUsedInTenant = column_ifexists(\"BrowserUncommonlyUsedInTenant\", \"\")\n| where DeviceUncommonlyUsedInTenant == \u0027True\u0027 or FirstTimeDeviceObservedInTenant == \u0027True\u0027 // impossible travel activity can be associated with new devices\n| summarize any(Timestamps), IPs=any(IPs), speedKmPerHour=any(speedKmPerHour), distance=any(distance), hours=any(hours), Apps=any(Apps), Browsers=any(Browsers), StateCountries=any(StateCountries), NumberOfStates=any(NumberOfStates), NumberOfCountries=any(NumberOfCountries), Coordinates=any(Coordinates), DeviceUncommonlyUsedInTenant=any(DeviceUncommonlyUsedInTenant), FirstTimeDeviceObservedInTenant=any(FirstTimeDeviceObservedInTenant), ResourceUncommonlyAccessedInTenant=any(ResourceUncommonlyAccessedInTenant), UnusualNumberOfDistinctUsersFailedSignInFromIPAddress=any(UnusualNumberOfDistinctUsersFailedSignInFromIPAddress), UnusualNumberOfFailedSignInOfThisUser=any(UnusualNumberOfFailedSignInOfThisUser), AppIdUncommonlyAccessedInTenant=any(AppIdUncommonlyAccessedInTenant), UncommonHighVolumeOfActions=any(UncommonHighVolumeOfActions), BrowserUncommonlyUsedInTenant=any(BrowserUncommonlyUsedInTenant), FirstTimeUserAccessedResource=any(FirstTimeUserAccessedResource), FirstTimeUserConnectedFromDevice=any(FirstTimeUserConnectedFromDevice), FirstTimeUserConnectedViaBrowser=any(FirstTimeUserConnectedViaBrowser), FirstTimeUserUsedApp=any(FirstTimeUserUsedApp), SimilarActionWasNotPerformedInThePast=any(SimilarActionWasNotPerformedInThePast), InvestigationPriority=any(InvestigationPriority) by UserPrincipalName, UserDisplayName",
                       "suppressionDuration":  "PT5H",
                       "suppressionEnabled":  false,
                       "incidentConfiguration":  {
                                                     "createIncident":  true,
                                                     "groupingConfiguration":  {
                                                                                   "enabled":  false,
                                                                                   "reopenClosedIncident":  false,
                                                                                   "lookbackDuration":  "PT5M",
                                                                                   "matchingMethod":  "AllEntities",
                                                                                   "groupByEntities":  [

                                                                                                       ],
                                                                                   "groupByAlertDetails":  null,
                                                                                   "groupByCustomDetails":  null
                                                                               }
                                                 },
                       "entityMappings":  [
                                              {
                                                  "entityType":  "Account",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "AadUserId",
                                                                            "columnName":  "UserPrincipalName"
                                                                        }
                                                                    ]
                                              },
                                              {
                                                  "entityType":  "IP",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "Address",
                                                                            "columnName":  "IPs"
                                                                        }
                                                                    ]
                                              }
                                          ],
                       "eventGroupingSettings":  {
                                                     "aggregationKind":  "SingleAlert"
                                                 },
                       "tactics":  [
                                       "InitialAccess"
                                   ],
                       "techniques":  [
                                          "T1078"
                                      ],
                       "displayName":  "BAH_UEBA_2-ImpossibleTravelIncidents",
                       "enabled":  true,
                       "description":  "Identify users connecting from different IP addresses. Based on the IP address geo-location, calculate the distance between the 2 locations. Using the timestamps for the connections from the two locations, estimate if it was possible to travel between the two locations within the calculated time difference AND if the speed is humanly possible. Max speed on commerical liner is around 1000 km, however, we increased the threshold to 1500 km/h. Discard any failed login attempts. Check signin activities against whitelist of VPN IPs.\nPLATFORM:Azure AD,Windows,Microsoft 365,IaaS\nMITRE:TA0001;T1078;T1078.001;T1078.002;T1078.003;T1078.004",
                       "alertRuleTemplateName":  null,
                       "lastModifiedUtc":  "2024-10-02T22:11:26.3747994Z"
                   }
}
