{
    "id":  "/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c97f71e0-1ff3-4e8e-be16-e750b08c20ad",
    "name":  "c97f71e0-1ff3-4e8e-be16-e750b08c20ad",
    "etag":  "\"f7005a99-0000-2700-0000-63fde8610000\"",
    "type":  "Microsoft.SecurityInsights/alertRules",
    "kind":  "Scheduled",
    "properties":  {
                       "queryFrequency":  "P1D",
                       "queryPeriod":  "P8D",
                       "triggerOperator":  "GreaterThan",
                       "triggerThreshold":  0,
                       "severity":  "Low",
                       "query":  "// a threshold can be enabled, see commented line below for PrevSeenCount\r\nlet threshold = 2;\r\nlet uploadOp = \u0027FileUploaded\u0027;\r\n// Extensions that are interesting. Add/Remove to this list as you see fit\r\nlet execExt = dynamic([\u0027exe\u0027, \u0027inf\u0027, \u0027gzip\u0027, \u0027cmd\u0027, \u0027bat\u0027]);\r\nlet starttime = 8d;\r\nlet endtime = 1d;\r\nOfficeActivity | where TimeGenerated \u003e= ago(endtime)\r\n// Limited to File Uploads due to potential noise, comment out the Operation statement below to include any operation type\r\n// Additional, but potentially noisy operation types that include Uploads and Downloads can be included by adding the following - Operation contains \"upload\" or Operation contains \"download\"\r\n| where Operation =~ uploadOp\r\n| where SourceFileExtension has_any (execExt)\r\n| project TimeGenerated, OfficeId, OfficeWorkload, RecordType, Operation, UserType, UserKey, UserId, ClientIP, UserAgent, Site_Url, SourceRelativeUrl, SourceFileName\r\n| join kind= leftanti (\r\nOfficeActivity | where TimeGenerated between (ago(starttime) .. ago(endtime))\r\n| where Operation =~ uploadOp\r\n| where SourceFileExtension has_any (execExt)\r\n| summarize SourceRelativeUrl = make_set(SourceRelativeUrl), UserId = make_set(UserId) , PrevSeenCount = count() by SourceFileName\r\n// To exclude previous matches when only above a specific count, change threshold above and uncomment the line below\r\n//| where PrevSeenCount \u003e threshold\r\n| mvexpand SourceRelativeUrl, UserId\r\n| extend SourceRelativeUrl = tostring(SourceRelativeUrl), UserId = tostring(UserId)\r\n) on SourceFileName, SourceRelativeUrl, UserId \r\n| extend SiteUrlUserFolder = tolower(split(Site_Url, \u0027/\u0027)[-2])\r\n| extend UserIdUserFolderFormat = tolower(replace(\u0027@|\\\\.\u0027, \u0027_\u0027,UserId))\r\n// identify when UserId is not a match to the specific site url personal folder reference\r\n| extend UserIdDiffThanUserFolder = iff(Site_Url has \u0027/personal/\u0027 and SiteUrlUserFolder != UserIdUserFolderFormat, true , false ) \r\n| summarize TimeGenerated = make_list(TimeGenerated), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), \r\nUserAgents = make_list(UserAgent), OfficeIds = make_list(OfficeId), SourceRelativeUrls = make_list(SourceRelativeUrl), FileNames = make_list(SourceFileName)\r\nby OfficeWorkload, RecordType, Operation, UserType, UserKey, UserId, ClientIP, Site_Url, SiteUrlUserFolder, UserIdUserFolderFormat, UserIdDiffThanUserFolder\r\n| extend timestamp = StartTime, AccountCustomEntity = UserId, IPCustomEntity = ClientIP, URLCustomEntity = Site_Url",
                       "suppressionDuration":  "PT5H",
                       "suppressionEnabled":  false,
                       "incidentConfiguration":  {
                                                     "createIncident":  true,
                                                     "groupingConfiguration":  {
                                                                                   "enabled":  false,
                                                                                   "reopenClosedIncident":  false,
                                                                                   "lookbackDuration":  "PT5H",
                                                                                   "matchingMethod":  "AllEntities",
                                                                                   "groupByEntities":  [

                                                                                                       ],
                                                                                   "groupByAlertDetails":  [

                                                                                                           ],
                                                                                   "groupByCustomDetails":  [

                                                                                                            ]
                                                                               }
                                                 },
                       "entityMappings":  [
                                              {
                                                  "entityType":  "Account",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "FullName",
                                                                            "columnName":  "AccountCustomEntity"
                                                                        }
                                                                    ]
                                              },
                                              {
                                                  "entityType":  "IP",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "Address",
                                                                            "columnName":  "IPCustomEntity"
                                                                        }
                                                                    ]
                                              },
                                              {
                                                  "entityType":  "URL",
                                                  "fieldMappings":  [
                                                                        {
                                                                            "identifier":  "Url",
                                                                            "columnName":  "URLCustomEntity"
                                                                        }
                                                                    ]
                                              }
                                          ],
                       "eventGroupingSettings":  {
                                                     "aggregationKind":  "SingleAlert"
                                                 },
                       "tactics":  [
                                       "CommandAndControl"
                                   ],
                       "techniques":  [

                                      ],
                       "displayName":  "New executable via Office FileUploaded Operation v2",
                       "enabled":  false,
                       "description":  "Identifies when executable file types are uploaded to Office services such as SharePoint and OneDrive. List currently includes \u0027exe\u0027, \u0027inf\u0027, \u0027gzip\u0027, \u0027cmd\u0027, \u0027bat\u0027 file extensions. Additionally, identifies when a given user is uploading these files to another users workspace. This may be indication of a staging location for malware or other malicious activity.",
                       "alertRuleTemplateName":  null,
                       "lastModifiedUtc":  "2023-02-28T11:41:21.6323206Z"
                   }
}
