{
    "id":  "/subscriptions/41de2c2e-1ec0-4d1b-b768-edd976cdd8fe/resourceGroups/dod365-law-rg2/providers/Microsoft.OperationalInsights/workspaces/dod365-law/providers/Microsoft.SecurityInsights/alertRules/db8569aa-d9e9-4f5b-9705-9a1f209ef718",
    "name":  "db8569aa-d9e9-4f5b-9705-9a1f209ef718",
    "etag":  "\"8b10c426-0000-2700-0000-674f62e60000\"",
    "type":  "Microsoft.SecurityInsights/alertRules",
    "kind":  "Scheduled",
    "properties":  {
                       "queryFrequency":  "PT5H",
                       "queryPeriod":  "PT5H",
                       "triggerOperator":  "GreaterThan",
                       "triggerThreshold":  0,
                       "severity":  "High",
                       "query":  "// Filter DeviceInfo for the specified MachineGroup\r\nlet filteredDevices = DeviceInfo\r\n| where MachineGroup contains \"JSP\"\r\n| project DeviceId, MachineGroup;\r\n\r\n// Query the DeviceProcessEvents table for the specified process and join with filtered devices\r\nDeviceProcessEvents\r\n| where FileName == \"searchprotocolhost.exe\"\r\n| join kind=inner (filteredDevices) on DeviceId\r\n| summarize count(), firstTime = min(Timestamp), lastTime = max(Timestamp) by bin(Timestamp, 1h), ProcessId, FileName, DeviceName, AccountName, FolderPath, ProcessCommandLine, InitiatingProcessFileName, MachineGroup\r\n| project-rename TimeGenerated = Timestamp, DeviceName = DeviceName, User = AccountName, ProcessPath = FolderPath, Process = ProcessCommandLine, ParentProcessName = InitiatingProcessFileName\r\n| where Process matches regex @\"(?i)(searchprotocolhost\\.exe.{0,4}$)\"\r\n| project TimeGenerated, ProcessId, FileName, DeviceName, User, ProcessPath, Process, ParentProcessName, firstTime, lastTime, MachineGroup",
                       "suppressionDuration":  "PT5H",
                       "suppressionEnabled":  false,
                       "incidentConfiguration":  {
                                                     "createIncident":  true,
                                                     "groupingConfiguration":  {
                                                                                   "enabled":  false,
                                                                                   "reopenClosedIncident":  false,
                                                                                   "lookbackDuration":  "PT5H",
                                                                                   "matchingMethod":  "AllEntities",
                                                                                   "groupByEntities":  [

                                                                                                       ],
                                                                                   "groupByAlertDetails":  [

                                                                                                           ],
                                                                                   "groupByCustomDetails":  [

                                                                                                            ]
                                                                               }
                                                 },
                       "customDetails":  {

                                         },
                       "eventGroupingSettings":  {
                                                     "aggregationKind":  "SingleAlert"
                                                 },
                       "tactics":  [
                                       "PrivilegeEscalation",
                                       "DefenseEvasion"
                                   ],
                       "techniques":  [
                                          "T1055"
                                      ],
                       "displayName":  "J361 - Suspicious SearchProtocolHost no Command Line Arguments",
                       "enabled":  true,
                       "description":  "Detects instances of searchprotocolhost.exe running without command line arguments. This behavior is unusual and often associated with malicious activities, such as those performed by Cobalt Strike. The detection leverages Endpoint Detection and Response (EDR) telemetry, focusing on process execution data. This activity is significant because searchprotocolhost.exe typically runs with specific arguments, and its absence may indicate an attempt to evade detection. If confirmed malicious, this could lead to unauthorized code execution, potential credential dumping, or other malicious actions within the environment. MITRE:T1055",
                       "alertRuleTemplateName":  null,
                       "lastModifiedUtc":  "2024-12-03T19:58:28.3439222Z"
                   }
}
